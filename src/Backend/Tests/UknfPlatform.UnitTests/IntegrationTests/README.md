# Integration Tests for User Registration

## Overview

This directory contains integration tests for the User Registration API endpoint. These tests use **Testcontainers** to spin up a real PostgreSQL database and test the entire stack end-to-end.

## Test Files

### 1. `WebApplicationFactoryBase.cs`
Custom WebApplicationFactory that:
- Spins up a PostgreSQL 16 container using Testcontainers
- Configures the test application to use the containerized database
- Ensures database is created before tests run
- Handles container lifecycle (start/stop)

### 2. `AuthControllerIntegrationTests.cs`
Comprehensive integration tests covering:

**Successful Registration:**
- ✅ Valid user data creates user and returns 201 Created
- ✅ User is saved to database with correct data
- ✅ PESEL is properly encrypted
- ✅ User is inactive by default (awaiting email activation)
- ✅ Multiple users can register successfully

**Duplicate Detection:**
- ✅ Duplicate email returns 409 Conflict
- ✅ Duplicate PESEL returns 409 Conflict

**Validation Errors:**
- ✅ Invalid email format returns 400 Bad Request
- ✅ Invalid phone format returns 400 Bad Request
- ✅ Invalid PESEL (wrong length) returns 400 Bad Request
- ✅ Missing required fields returns 400 Bad Request
- ✅ Field length violations return 400 Bad Request

**Data Security:**
- ✅ PESEL is encrypted in database (not plain text)
- ✅ Only last 4 digits are stored separately

## Total Tests: 11 Integration Tests

## Running the Tests

### Prerequisites
- Docker Desktop installed and running
- .NET 8.0 SDK installed

### Run All Tests
```bash
cd src/Backend
dotnet test Tests/UknfPlatform.UnitTests/
```

### Run Only Integration Tests
```bash
cd src/Backend
dotnet test Tests/UknfPlatform.UnitTests/ --filter "FullyQualifiedName~IntegrationTests"
```

### Run Specific Test
```bash
cd src/Backend
dotnet test Tests/UknfPlatform.UnitTests/ --filter "FullyQualifiedName~POST_Register_WithValidData_Returns201AndCreatesUser"
```

## How It Works

1. **Test Initialization:** 
   - `WebApplicationFactoryBase` starts a PostgreSQL container
   - Database schema is created from EF Core DbContext

2. **Per-Test Setup:**
   - Database is cleaned before each test
   - Fresh HttpClient is created for API calls

3. **Test Execution:**
   - HTTP requests are made to the API
   - Responses are validated
   - Database is queried to verify data

4. **Cleanup:**
   - Container is stopped and removed after all tests complete

## Dependencies

```xml
<PackageReference Include="Microsoft.AspNetCore.Mvc.Testing" Version="8.0.0" />
<PackageReference Include="Testcontainers.PostgreSql" Version="3.9.0" />
```

## CI/CD Considerations

- Tests require Docker to be available
- Tests will automatically download PostgreSQL 16 image on first run
- Each test run uses a fresh database instance
- Tests can run in parallel if configured properly

## Notes

- Tests use `IClassFixture` to share the WebApplicationFactory across tests
- Database is cleaned between tests using `IAsyncLifetime`
- Testcontainers handles port allocation automatically
- Connection string is dynamically generated by Testcontainers

