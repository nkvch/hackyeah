# Story 7.11: Understand Addressee Types

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.11  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As a** UKNF Employee,  
**I want to** understand the four ways to specify recipients,  
**So that** I can effectively target communications.

---

## Acceptance Criteria

1. System provides four Addressee Types throughout the platform (announcements, mass messaging, file sharing):
   - **Selected Entities**: Addressee is any external user associated with selected entities from list
   - **Selected Contact Groups**: Addressee is each external user or contact assigned to selected Contact Group(s)
   - **Selected Types of Entities**: Addressee is any external user whose entity is associated with entity type (e.g., "Loan institution")
   - **Selected Users**: Addressee is specific external user(s) selected from list
2. UI provides intuitive selection interface for each type
3. Employee can preview recipient list before confirming
4. System calculates actual recipients based on addressee configuration
5. Recipient calculation is dynamic (reflects current user/entity/group memberships)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Define AddresseeType enum** (AC: 1)
  - [ ] Create `AddresseeType.cs` enum in `Domain/UknfPlatform.Domain.Communication/Enums/`
  - [ ] Values:
    - SelectedEntities
    - SelectedContactGroups
    - SelectedEntityTypes
    - SelectedUsers

- [ ] **Task 2: Create RecipientConfiguration value object** (AC: 1, 4, 5)
  - [ ] Already created in Story 7.2
  - [ ] Ensure it supports all four types:
    - IncludeAllUsers (bool) - optional: select all
    - SelectedEntityIds (List<long>)
    - SelectedContactGroupIds (List<Guid>)
    - SelectedEntityTypes (List<string>)
    - SelectedUserIds (List<Guid>)
  - [ ] Add validation: at least one type must be selected

- [ ] **Task 3: Create IRecipientCalculator service** (AC: 4, 5)
  - [ ] Already created in Story 7.2
  - [ ] Ensure it handles all four addressee types:
    - SelectedEntities: Get all users associated with those entities
    - SelectedContactGroups: Get all members (users + contacts) of those groups
    - SelectedEntityTypes: Get all users whose entity has one of those types
    - SelectedUsers: Use those specific users
  - [ ] Remove duplicates
  - [ ] Return unified recipient list (user IDs + contact emails)

- [ ] **Task 4: Document Addressee Types** (AC: 1)
  - [ ] Create documentation explaining each type
  - [ ] Include examples and use cases
  - [ ] Add to API documentation (Swagger annotations)

### Frontend Tasks

- [ ] **Task 5: Create AddresseeTypeSelector component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/shared/components/addressee-type-selector/addressee-type-selector.component.ts`
  - [ ] Reusable component for announcements, messages, file sharing
  - [ ] Input: initialConfiguration (RecipientConfiguration)
  - [ ] Output: configurationChange (EventEmitter<RecipientConfiguration>)
  - [ ] UI: Tabbed interface or sections for each addressee type

- [ ] **Task 6: Implement Selected Entities UI** (AC: 1, 2)
  - [ ] Section: "Select Entities"
  - [ ] Multi-select dropdown with search
  - [ ] Load entities via entitiesService.getAll()
  - [ ] Display: Entity Name (UKNF Code)
  - [ ] Allow selecting multiple entities

- [ ] **Task 7: Implement Selected Contact Groups UI** (AC: 1, 2)
  - [ ] Section: "Select Contact Groups"
  - [ ] Multi-select dropdown with search
  - [ ] Load contact groups via contactGroupsService.getAll()
  - [ ] Display: Group Name (Member Count)
  - [ ] Allow selecting multiple groups

- [ ] **Task 8: Implement Selected Entity Types UI** (AC: 1, 2)
  - [ ] Section: "Select Entity Types"
  - [ ] Multi-select dropdown or checkboxes
  - [ ] Load entity types via entitiesService.getEntityTypes()
  - [ ] Types: "Bank", "Insurance Company", "Loan Institution", "Pension Fund", etc.
  - [ ] Allow selecting multiple types

- [ ] **Task 9: Implement Selected Users UI** (AC: 1, 2)
  - [ ] Section: "Select Individual Users"
  - [ ] Multi-select dropdown with search
  - [ ] Load users via usersService.getExternalUsers()
  - [ ] Display: User Name (Email) - Entity Name
  - [ ] Allow selecting multiple users

- [ ] **Task 10: Implement recipient preview** (AC: 3, 5)
  - [ ] Add "Preview Recipients" button
  - [ ] On click, call API to calculate recipients based on current configuration
  - [ ] Display modal or expandable section with:
    - Total recipient count
    - Breakdown by type (X from entities, Y from groups, Z from types, W individual users)
    - List of recipient names (paginated, max 100 shown)
  - [ ] Update preview when configuration changes (debounced)

- [ ] **Task 11: Implement "All External Users" option** (AC: 1)
  - [ ] Add checkbox: "Send to All External Users"
  - [ ] If checked, disable other selectors
  - [ ] Show warning: "This will send to all external users in the system"

- [ ] **Task 12: Create help/documentation** (AC: 1)
  - [ ] Add help icon (?) next to each addressee type
  - [ ] On hover/click, show tooltip or popover explaining the type
  - [ ] Examples:
    - "Selected Entities: Send to all users associated with the selected entities (e.g., all users from Bank ABC)"
    - "Contact Groups: Send to all members of the selected contact groups, including non-system contacts"

- [ ] **Task 13: Validate at least one type selected** (AC: 1, 2)
  - [ ] Form validation: At least one addressee type must be selected
  - [ ] Show error message if no recipients configured
  - [ ] Disable submit button until valid

### Testing Tasks

- [ ] **Task 14: Write unit tests for RecipientCalculator** (AC: 4, 5)
  - [ ] Test: `Calculate_SelectedEntities_ReturnsUsersFromThoseEntities`
  - [ ] Test: `Calculate_SelectedContactGroups_ReturnsGroupMembers`
  - [ ] Test: `Calculate_SelectedEntityTypes_ReturnsUsersFromEntitiesOfThoseTypes`
  - [ ] Test: `Calculate_SelectedUsers_ReturnsThoseUsers`
  - [ ] Test: `Calculate_CombinedTypes_RemovesDuplicates`
  - [ ] Test: `Calculate_AllUsers_ReturnsAllExternalUsers`
  - [ ] Test: `Calculate_Dynamic_ReflectsCurrentMemberships`
  - [ ] Mock: IUserRepository, IEntityRepository, IContactGroupRepository

- [ ] **Task 15: Write integration test for addressee types**
  - [ ] Test: `CalculateRecipients_AllTypes_ReturnsCorrectRecipients`
  - [ ] Test: `PreviewRecipients_ValidConfig_ReturnsPreview`
  - [ ] Use Testcontainers
  - [ ] Seed test data with entities, users, entity types, contact groups
  - [ ] Verify recipient calculation accuracy for each type

- [ ] **Task 16: Write E2E test for addressee type selection**
  - [ ] Test workflow:
    1. Create announcement
    2. Open recipient selector
    3. Select entities, contact groups, entity types, users
    4. Preview recipients
    5. Verify preview shows correct count and names
    6. Publish announcement
    7. Verify correct recipients receive announcement
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Addressee Types - Detailed Explanation

#### 1. Selected Entities
- **Description**: Send to all users associated with selected entities
- **Use Case**: Send announcement to all employees of specific banks or insurance companies
- **Example**: Select "Bank ABC" → All users who work for Bank ABC receive message
- **Implementation**: Query Users where EntityId IN (selectedEntityIds)

#### 2. Selected Contact Groups
- **Description**: Send to all members of selected contact groups
- **Use Case**: Send to pre-defined groups like "Quarterly Report Recipients" or "Risk Management Officers"
- **Example**: Select "Quarterly Report Recipients" group → All members (system users + contacts) receive message
- **Implementation**: Query ContactGroupMembers where GroupId IN (selectedGroupIds), return both UserIds and ContactEmails
- **Note**: Includes non-system contacts (email-only recipients)

#### 3. Selected Types of Entities
- **Description**: Send to all users whose entity has a specific type
- **Use Case**: Send announcement to all banks, or all insurance companies
- **Example**: Select "Bank" type → All users from entities of type "Bank" receive message
- **Implementation**: Query Entities where EntityType IN (selectedEntityTypes), then get all Users where EntityId IN (entityIds)

#### 4. Selected Users
- **Description**: Send to specific individual users
- **Use Case**: Send to specific people regardless of entity or group
- **Example**: Select "John Doe" and "Jane Smith" → Only those two users receive message
- **Implementation**: Use provided UserIds directly

### Combining Addressee Types

Employee can combine multiple types:
- Example: "All banks" (entity type) + "Specific additional entities" (selected entities) + "Risk Officers" group (contact group)
- Result: Union of all recipients from all selected types
- Deduplication: Remove duplicate users if they match multiple types

### Dynamic Calculation

Recipients are calculated dynamically at time of action:
- If new users join an entity after announcement is published, they do NOT receive it (snapshot at publication time)
- But if employee changes contact group membership before sending, new recipients will receive message
- **Implementation**: Calculate recipients when announcement is published, store in AnnouncementRecipients table

### UI/UX Considerations

**Tabbed Interface:**
```
[Entities] [Contact Groups] [Entity Types] [Individual Users]

(Current tab content)
```

**Sectioned Interface (Recommended):**
```
□ All External Users

□ Select Entities
  [Multi-select dropdown]

□ Select Contact Groups
  [Multi-select dropdown]

□ Select Entity Types
  [Checkboxes or multi-select]

□ Select Individual Users
  [Multi-select dropdown with search]

[Preview Recipients (15 total)]
```

### Dependencies

**Prerequisites:**
- **Epic 2**: Authorization (entity and user data)
- **Story 7.12**: Contact Groups (for contact group selection)

**Integrates With:**
- **Story 7.2**: Set Announcement Recipients (uses addressee types)
- **Epic 5**: Messaging (reuse addressee types for mass messaging)
- **Epic 6**: Library (reuse addressee types for file permissions)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

