# Story 6.5: View File Details

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.5  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As an** External User or UKNF Employee,  
**I want to** view complete details about a Library file,  
**So that** I can understand what it contains and its version.

---

## Acceptance Criteria

1. User can view file details page including:
   - Filename
   - Full description
   - Category
   - Reporting Period
   - Model Update Date
   - Version status (Current/Archival)
   - File size
   - File format
   - Upload date
   - Last modified date
   - Uploaded by (UKNF Employee, optionally name)
   - Download count (optional)
2. External users see details only for files they have access to
3. UKNF Employees see all file details plus access permissions
4. User can download file from details page
5. Details page shows change history link (for UKNF Employees)
6. Details page shows related files (other versions in version chain)
7. Page is accessible via direct link (file ID in URL)
8. Page shows loading state while fetching data
9. Page shows error state if file not found or no permission
10. Page is responsive and works on mobile devices

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetFileDetailsQuery** (AC: 1, 2, 3)
  - [ ] Create `GetFileDetailsQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties:
    - FileId (Guid, required)
  - [ ] Note: User context from ICurrentUserService

- [ ] **Task 2: Create GetFileDetailsQueryValidator** (AC: 1, 7)
  - [ ] Create `GetFileDetailsQueryValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Add async validation: File must exist
  - [ ] Add async validation: User must be authenticated

- [ ] **Task 3: Create GetFileDetailsQueryHandler** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `GetFileDetailsQueryHandler.cs` implementing `IRequestHandler<GetFileDetailsQuery, FileDetailsDto>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFilePermissionRepository, ICurrentUserService, IUserRepository, ILogger
  - [ ] Handler logic:
    - Load file by ID with related data (Category, UploadedBy user)
    - Check if file is deleted â†’ return 404
    - Get current user and role
    - If user is UKNF Employee: grant access (AC: 3)
    - Else: validate user has permission (CheckUserHasAccessAsync) (AC: 2)
    - If no permission: return 403 Forbidden
    - Load file permissions if UKNF Employee (AC: 3)
    - Load version history (previous and next versions) (AC: 6)
    - Build FileDetailsDto with all information
    - Return response
  - [ ] Handle errors: file not found, no permission

- [ ] **Task 4: Create FileDetailsDto** (AC: 1, 3, 6)
  - [ ] Create `FileDetailsDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Filename (string)
    - Description (string?, nullable)
    - CategoryId (Guid)
    - CategoryName (string)
    - ReportingPeriod (string?, nullable)
    - ModelUpdateDate (DateTime)
    - VersionStatus (string) - "Current" or "Archival"
    - ArchivalDate (DateTime?, nullable)
    - FileSize (long)
    - FileExtension (string)
    - MimeType (string)
    - VirusScanStatus (string) - "Pending", "Clean", "Infected"
    - VirusScanDate (DateTime?, nullable)
    - UploadDate (DateTime)
    - LastModifiedDate (DateTime)
    - UploadedByUserId (Guid)
    - UploadedByName (string) - e.g., "Jan Kowalski (UKNF)"
    - DownloadCount (int)
    - CanDownload (bool) - based on virus scan and permission
    - Permissions (List<FilePermissionDto>?, nullable) - only for UKNF Employees
    - VersionHistory (List<FileVersionDto>?, nullable) - other versions in chain
    - IsCurrentUser UKNFEmployee (bool)

- [ ] **Task 5: Create FileVersionDto** (AC: 6)
  - [ ] Create `FileVersionDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Filename (string)
    - ModelUpdateDate (DateTime)
    - VersionStatus (string)
    - ArchivalDate (DateTime?, nullable)
    - FileSize (long)

- [ ] **Task 6: Create REST API endpoint GET /library/files/{fileId}** (AC: 1, 2, 3, 7, 9)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize]` attribute (requires authentication)
  - [ ] Create GET action `GetFileDetailsAsync(Guid fileId)`
  - [ ] Inject IMediator to send query
  - [ ] Return 200 OK with FileDetailsDto
  - [ ] Return 400 Bad Request if file ID invalid
  - [ ] Return 401 Unauthorized if not authenticated
  - [ ] Return 403 Forbidden if no permission
  - [ ] Return 404 Not Found if file not found or deleted
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 7: Update ILibraryFileRepository** (AC: 1, 6)
  - [ ] Add method: GetFileDetailsAsync(Guid fileId)
  - [ ] Include related data: Category, UploadedBy user
  - [ ] Add method: GetVersionHistoryAsync(Guid fileId)
  - [ ] Query version chain (linked by PreviousVersionId)
  - [ ] Return ordered list (current to oldest)

- [ ] **Task 8: Update GetFileDetailsQueryHandler to load uploader name** (AC: 1)
  - [ ] Query User by UploadedByUserId
  - [ ] Format name as "FirstName LastName (UKNF)"
  - [ ] Handle case where user is deleted (show "UKNF Employee (deleted)")

### Frontend Tasks

- [ ] **Task 9: Create file details component** (AC: 1, 2, 3, 4, 8, 9, 10)
  - [ ] Create `library-file-details.component.ts` in `src/app/features/library/`
  - [ ] Layout sections:
    - Header with filename and download button
    - File information card
    - Description section
    - Version information
    - Access permissions (UKNF only)
    - Version history (if exists)
    - Change history link (UKNF only)
  - [ ] Display all file details with appropriate formatting
  - [ ] Show version status badge (Current/Archival)
  - [ ] Show virus scan status badge
  - [ ] Show download count
  - [ ] Show uploaded by information
  - [ ] Implement responsive design

- [ ] **Task 10: Create file information display** (AC: 1)
  - [ ] Show file icon based on extension
  - [ ] Display formatted file size (KB, MB)
  - [ ] Display formatted dates (absolute and relative)
  - [ ] Show category with badge/chip
  - [ ] Show reporting period if present
  - [ ] Use grid or table layout for information

- [ ] **Task 11: Add download button** (AC: 4)
  - [ ] Prominent download button at top
  - [ ] Reuse file-download-button component (Story 6.4)
  - [ ] Disable if virus scan Pending/Infected
  - [ ] Show explanation if cannot download

- [ ] **Task 12: Display permissions for UKNF Employees** (AC: 3, 5)
  - [ ] Section: "Who can access this file"
  - [ ] Show list of permissions (AllUsers, SpecificEntity, etc.)
  - [ ] Show entity/user names for specific permissions
  - [ ] Show "Manage Permissions" button (links to Story 6.2)
  - [ ] Hidden for external users

- [ ] **Task 13: Display version history** (AC: 6)
  - [ ] Section: "Version History"
  - [ ] List other versions in chain
  - [ ] Show version date, status, file size
  - [ ] Link to each version's details page
  - [ ] Highlight current version
  - [ ] Show archival dates for archival versions

- [ ] **Task 14: Add change history link** (AC: 5)
  - [ ] Button: "View Change History"
  - [ ] Link to change history page (Story 6.11)
  - [ ] Only visible to UKNF Employees

- [ ] **Task 15: Update library service** (AC: 1, 2, 3)
  - [ ] Add method to `library.service.ts`:
    - getFileDetails(fileId: string): Observable<FileDetails>
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 16: Create routing for file details** (AC: 7)
  - [ ] Add route: `/library/files/:id` â†’ LibraryFileDetailsComponent
  - [ ] Implement route parameter extraction (file ID)
  - [ ] Add route guard to require authentication

- [ ] **Task 17: Add navigation to details page** (AC: 7)
  - [ ] Update library list to link filenames to details page
  - [ ] Add "View Details" button/link in file actions
  - [ ] Support opening in new tab (Ctrl/Cmd + Click)

- [ ] **Task 18: Implement loading and error states** (AC: 8, 9)
  - [ ] Show skeleton loader while fetching file details
  - [ ] Show error message if file not found (404)
  - [ ] Show error message if no permission (403)
  - [ ] Show "Go back to Library" link
  - [ ] Handle network errors

- [ ] **Task 19: Add breadcrumbs** (AC: 10)
  - [ ] Breadcrumb: Library > [Category] > [Filename]
  - [ ] Clickable breadcrumb links
  - [ ] Responsive (collapse on mobile)

- [ ] **Task 20: Add metadata section** (AC: 1)
  - [ ] Create expandable/collapsible sections
  - [ ] File information (always visible)
  - [ ] Full description (expandable if long)
  - [ ] Technical details (file size, format, upload date, etc.)
  - [ ] Access information (permissions for UKNF)

### Testing Tasks

- [ ] **Task 21: Unit tests for query handler** (AC: 1, 2, 3, 6)
  - [ ] Test loading file details with permission
  - [ ] Test UKNF Employee can view any file details
  - [ ] Test external user needs permission
  - [ ] Test external user without permission gets 403
  - [ ] Test deleted file returns 404
  - [ ] Test loading version history
  - [ ] Test loading permissions for UKNF Employee
  - [ ] Test uploader name formatting

- [ ] **Task 22: Unit tests for validator** (AC: 1, 7)
  - [ ] Test FileId validation
  - [ ] Test file must exist
  - [ ] Test user must be authenticated

- [ ] **Task 23: Integration tests for API endpoint** (AC: 1, 2, 3, 7, 9)
  - [ ] Test GET /library/files/{id} returns file details
  - [ ] Test external user sees details with permission
  - [ ] Test external user gets 403 without permission
  - [ ] Test UKNF Employee sees all details including permissions
  - [ ] Test 404 for non-existent file
  - [ ] Test 404 for deleted file
  - [ ] Test 401 if not authenticated
  - [ ] Test version history included in response

- [ ] **Task 24: Frontend unit tests** (AC: 1, 4, 8, 9, 10)
  - [ ] Test file details component rendering
  - [ ] Test loading state display
  - [ ] Test error state display (404, 403)
  - [ ] Test download button
  - [ ] Test permissions display (UKNF only)
  - [ ] Test version history display
  - [ ] Test change history link (UKNF only)
  - [ ] Test service method calls
  - [ ] Test responsive design

- [ ] **Task 25: E2E tests** (AC: 1-10)
  - [ ] Test viewing file details as external user with permission
  - [ ] Test viewing file details as UKNF Employee
  - [ ] Test external user denied access without permission
  - [ ] Test download from details page
  - [ ] Test navigate to details from library list
  - [ ] Test direct link to details page
  - [ ] Test 404 page for non-existent file
  - [ ] Test version history links
  - [ ] Test change history link (UKNF)
  - [ ] Test responsive design on mobile

### Documentation Tasks

- [ ] **Task 26: API documentation** (AC: 1, 7, 9)
  - [ ] Document GET /library/files/{id} endpoint
  - [ ] Include response example (full FileDetailsDto)
  - [ ] Document error responses (400, 401, 403, 404)
  - [ ] Document authentication requirements
  - [ ] Document permission requirements
  - [ ] Document UKNF vs. external user response differences

- [ ] **Task 27: Developer documentation** (AC: 1, 3, 6)
  - [ ] Document FileDetailsDto structure
  - [ ] Document version history logic
  - [ ] Document permission loading for UKNF Employees
  - [ ] Document uploader name formatting
  - [ ] Document performance considerations

- [ ] **Task 28: User documentation** (AC: 1, 4, 5, 6)
  - [ ] Create user guide for viewing file details
  - [ ] Explain file information fields
  - [ ] Explain version history
  - [ ] Explain change history (UKNF)
  - [ ] Include screenshots of details page

---

## Technical Notes

### File Details Structure

Organize information into logical sections:
1. **Header**: Filename, Download button, Version badge
2. **Overview**: Description, Category, Reporting Period
3. **Version Info**: Model Update Date, Version Status, Archival Date
4. **File Info**: Size, Format, Virus Scan Status
5. **History**: Upload Date, Last Modified, Uploaded By, Download Count
6. **Permissions** (UKNF only): Who can access
7. **Version History**: Other versions in chain
8. **Actions**: Download, Manage Permissions, View Change History

### Permission Display

For UKNF Employees, show:
- **AllUsers**: "Public - All external users"
- **SpecificEntity**: List entity names
- **EntityType**: List entity types
- **SpecificUser**: List user names
- **Private**: "Private - No access granted"

For external users: Don't show permissions (privacy).

### Version History

Display version chain:
- Current version (this file)
- Previous versions (ordered newest to oldest)
- Show: Version date, Status, File size, Download link
- Highlight current version
- Link to details page of each version

Example:
```
Version History:
- [Current] Model Update: Jan 15, 2025 | 2.5 MB
- [Archived] Model Update: Oct 10, 2024 | 2.3 MB
- [Archived] Model Update: Jul 5, 2024 | 2.1 MB
```

### Uploader Information

Show UKNF Employee who uploaded:
- Format: "FirstName LastName (UKNF)"
- If user deleted: "UKNF Employee (deleted)"
- For privacy, don't show employee email/phone
- Optional: Show employee department/role (future)

### Virus Scan Status

Display with badges:
- **Clean**: Green badge, allow download
- **Pending**: Yellow badge, show "Scan in progress", disable download
- **Infected**: Red badge, show "Virus detected", disable download, hide file content

### Download Count

Show download statistics:
- Total downloads
- Optional: Recent downloads (last 30 days)
- Optional: First download date
- Only for analytics, not critical info

### Responsive Design

- **Desktop**: Two-column layout (info on left, actions on right)
- **Tablet**: Single column, sections stacked
- **Mobile**: Compact view, collapsible sections

### Performance

- Load file details in single query with includes
- Cache file details for short period (5 minutes)
- Lazy load version history if performance issue
- Optimize query with proper indexes

### Security

- Always check permission before showing details
- UKNF Employees bypass permission check
- External users must have file permission
- Don't reveal file existence if no permission (403, not 404)
- Sanitize filename and description for XSS

### SEO Considerations

- Set page title to filename
- Add meta description with file description
- Use semantic HTML
- Not critical for internal app but good practice

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files must exist)
- **Story 6.2**: Set File Access Permissions (permissions control access)
- **Story 6.3**: View and Search Library (navigate from library list)
- **Epic 1**: Authentication (user must be authenticated)

### Integrates With
- **Story 6.4**: Download File from Library (download button)
- **Story 6.6**: Update File Metadata (edit button for UKNF)
- **Story 6.7**: Replace File (version history)
- **Story 6.10**: Access Archival File Versions (version history links)
- **Story 6.11**: View File Change History (change history link)
- **Story 6.12**: Monitor File Access (download count)

---

## Acceptance Checklist

- [ ] User can view complete file details
- [ ] All required information displayed (filename, description, category, dates, etc.)
- [ ] External users see details only for permitted files
- [ ] UKNF Employees see all details including permissions
- [ ] User can download file from details page
- [ ] Change history link shown for UKNF Employees
- [ ] Version history displayed if exists
- [ ] Page accessible via direct link (URL with file ID)
- [ ] Loading state displayed while fetching
- [ ] Error state displayed if file not found or no permission
- [ ] Page is responsive on all devices
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (creates files)
- **Story 6.2**: Set File Access Permissions (permissions displayed)
- **Story 6.3**: View and Search Library (navigate to details)
- **Story 6.4**: Download File from Library (download button)
- **Story 6.6**: Update File Metadata (edit metadata)
- **Story 6.7**: Replace File (version history)
- **Story 6.10**: Access Archival File Versions (version history)
- **Story 6.11**: View File Change History (change history link)
- **Story 6.12**: Monitor File Access (download count)

---

## Notes

- File details page is hub for all file-related actions
- Provide comprehensive information without overwhelming user
- UKNF Employees need additional info (permissions, change history)
- External users need simpler view focused on file content
- Version history helps users find and compare versions
- Download button should be most prominent action
- Consider adding "Share" button (copy link) for easy sharing
- Consider adding "Report Issue" button for file problems
- Test with files having long descriptions, many versions, many permissions
- Ensure page loads quickly even with complex permission rules
- Consider caching for frequently accessed files
- Monitor page load performance and optimize queries
- Add analytics to track which file details are most viewed
- Consider "Related Files" section (same category, same period)
- Test accessibility (screen readers, keyboard navigation)

