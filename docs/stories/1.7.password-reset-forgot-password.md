# Story 1.7: Password Reset (Forgot Password)

**Epic:** 1 - Authentication & User Registration  
**Story Number:** 1.7  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As an** external user who forgot their password,  
**I want to** reset my password via email,  
**So that** I can regain access to my account.

---

## Acceptance Criteria

1. "Forgot Password" link is available on login page
2. User enters their registered email address
3. System sends password reset link to email (if email exists in system)
4. System does not reveal whether email exists (security best practice)
5. Reset link is secure (time-limited, single-use token)
6. Reset link opens password creation page
7. New password must meet system password policy
8. Successful reset invalidates all existing sessions
9. User receives confirmation email after successful reset

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create RequestPasswordResetCommand and Handler** (AC: 2, 3, 4)
  - [ ] Create `RequestPasswordResetCommand.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] Command property: Email (string)
  - [ ] Create `RequestPasswordResetCommandHandler.cs`
  - [ ] Handler logic:
    - Find user by email
    - If user NOT found: Return success anyway (don't reveal user existence)
    - If user found:
      - Generate secure password reset token
      - Save token to PasswordResetToken entity
      - Set token expiration (24 hours)
      - Generate reset URL: `{FrontendUrl}/auth/reset-password?token={token}`
      - Send password reset email
      - Log password reset request
    - Always return same success response regardless of email existence
    - NEVER indicate if email exists or not
  - [ ] Inject: IUserRepository, IPasswordResetTokenRepository, IEmailService, ILogger

- [ ] **Task 2: Create PasswordResetToken entity** (AC: 5)
  - [ ] Create `PasswordResetToken.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties: Id (Guid), UserId (Guid FK), Token (string, unique), ExpiresAt (DateTime, 24 hours), IsUsed (bool), CreatedDate
  - [ ] Add domain method `Create(userId)` to generate secure token
  - [ ] Add domain method `IsValid()` to check expiration and used status
  - [ ] Token generation: cryptographically secure, at least 32 bytes

- [ ] **Task 3: Create database schema for PasswordResetTokens table** (AC: 5)
  - [ ] Create EF Core configuration `PasswordResetTokenConfiguration.cs`
  - [ ] Configure table, primary key, foreign key to Users
  - [ ] Add unique index on Token column
  - [ ] Add index on UserId and ExpiresAt for queries
  - [ ] Create EF Core migration `Add_PasswordResetTokens_Table`

- [ ] **Task 4: Create ResetPasswordCommand and Handler** (AC: 5, 6, 7, 8)
  - [ ] Create `ResetPasswordCommand.cs`
  - [ ] Command properties: Token (string), NewPassword (string), NewPasswordConfirmation (string)
  - [ ] Create `ResetPasswordCommandHandler.cs`
  - [ ] Handler logic:
    - Find token in repository
    - If token not found, throw `InvalidTokenException`
    - Check token.IsValid() (not expired, not used)
    - If expired, throw `TokenExpiredException`
    - If already used, throw `TokenAlreadyUsedException`
    - Retrieve user
    - Validate new password meets policy
    - Check new password not in password history (optional for reset)
    - Hash new password using IPasswordHasher
    - Update user.PasswordHash
    - Update user.LastPasswordChangeDate
    - Add to password history
    - Mark token as used
    - Revoke all user's refresh tokens (invalidate sessions)
    - Send password reset confirmation email
    - Log password reset event
    - Return success response
  - [ ] Inject: IPasswordResetTokenRepository, IUserRepository, IPasswordHasher, IPasswordHistoryRepository, IRefreshTokenRepository, IEmailService, ILogger

- [ ] **Task 5: Create FluentValidation validators** (AC: 7)
  - [ ] Create `RequestPasswordResetCommandValidator.cs`
    - Validate Email: NotEmpty, EmailAddress format
  - [ ] Create `ResetPasswordCommandValidator.cs`
    - Validate Token: NotEmpty
    - Validate NewPassword: NotEmpty, meets PasswordPolicy (reuse from Story 1.3)
    - Validate NewPasswordConfirmation: Equal to NewPassword

- [ ] **Task 6: Create PasswordResetTokenRepository** (AC: 5)
  - [ ] Create `IPasswordResetTokenRepository.cs` interface
  - [ ] Methods: GetByTokenAsync, AddAsync, UpdateAsync
  - [ ] Create `PasswordResetTokenRepository.cs` implementation
  - [ ] Implement with EF Core

- [ ] **Task 7: Create password reset email template** (AC: 3)
  - [ ] Create `PasswordResetEmail.cshtml` in email templates
  - [ ] Template content:
    - "Password reset requested"
    - User's first name
    - Reset link button
    - Link expiration notice (24 hours)
    - "If you didn't request this, ignore this email"
    - Security warning not to share link
    - Support contact information
  - [ ] Responsive HTML design

- [ ] **Task 8: Create password reset confirmation email template** (AC: 9)
  - [ ] Create `PasswordResetConfirmedEmail.cshtml`
  - [ ] Template content:
    - "Your password was reset"
    - Timestamp
    - "If you didn't make this change, contact support immediately"
    - Support contact information

- [ ] **Task 9: Create REST API endpoint POST /auth/forgot-password** (AC: 2, 3, 4)
  - [ ] Add action to `AuthController.cs`: `RequestPasswordResetAsync(RequestPasswordResetCommand command)`
  - [ ] `[AllowAnonymous]` attribute
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with generic success message
  - [ ] Message: "If that email is registered, we've sent password reset instructions."
  - [ ] NEVER reveal if email exists (security)
  - [ ] Add Swagger documentation

- [ ] **Task 10: Create REST API endpoint POST /auth/reset-password** (AC: 5, 6, 7, 8)
  - [ ] Add action: `ResetPasswordAsync(ResetPasswordCommand command)`
  - [ ] `[AllowAnonymous]` attribute
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with success message
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 400 Bad Request if token invalid/expired/used
  - [ ] Success message: "Password reset successfully. You can now log in."
  - [ ] Add Swagger documentation

- [ ] **Task 11: Implement rate limiting for password reset** (AC: 4)
  - [ ] Apply rate limiting to POST /auth/forgot-password
  - [ ] Limit: 3 requests per email per hour (prevent abuse)
  - [ ] Return 429 Too Many Requests if exceeded
  - [ ] Log rate limit violations

### Frontend Tasks

- [ ] **Task 12: Create forgot password page component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/auth/forgot-password/forgot-password.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/auth/forgot-password` (public)

- [ ] **Task 13: Create forgot password form** (AC: 2)
  - [ ] Create reactive form with FormBuilder
  - [ ] Form field: email (email input, required, email format)
  - [ ] Add validators: Validators.required, Validators.email
  - [ ] Submit button: "Send Reset Link"
  - [ ] Link back to login: "Back to Login"

- [ ] **Task 14: Implement forgot password submission** (AC: 3, 4)
  - [ ] On form submit:
    - Show loading spinner
    - Call authService.requestPasswordReset(email)
    - On success (200):
      - Show success message: "If that email is registered, we've sent password reset instructions. Please check your email."
      - Hide form, show only success message
      - Provide "Back to Login" button
    - On error:
      - Show generic error (don't reveal email existence)
  - [ ] Disable submit button while loading or form invalid

- [ ] **Task 15: Create reset password page component** (AC: 6, 7)
  - [ ] Create `reset-password.component.ts`
  - [ ] Route: `/auth/reset-password?token={token}`
  - [ ] Extract token from query parameters on init
  - [ ] Validate token exists, show error if missing

- [ ] **Task 16: Create reset password form** (AC: 6, 7)
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - newPassword (password input, required)
    - newPasswordConfirmation (password input, required)
  - [ ] Reuse PasswordStrengthComponent from Story 1.3
  - [ ] Display password requirements checklist
  - [ ] Add validators matching backend
  - [ ] Show/Hide password toggles

- [ ] **Task 17: Implement reset password submission** (AC: 7, 8, 9)
  - [ ] On form submit:
    - Show loading spinner
    - Call authService.resetPassword(token, newPassword, newPasswordConfirmation)
    - On success (200):
      - Show success message: "Password reset successfully!"
      - Show info: "You can now log in with your new password."
      - Wait 2 seconds
      - Redirect to login page
    - On error (400 Invalid Token):
      - Show error: "Reset link is invalid or has expired"
      - Provide "Request New Link" button
    - On error (400 Policy Violation):
      - Display validation errors on newPassword field
  - [ ] Disable submit button while loading or form invalid

- [ ] **Task 18: Add forgot password link to login page** (AC: 1)
  - [ ] In login page (Story 1.4), add "Forgot Password?" link
  - [ ] Place below password field or below submit button
  - [ ] Navigate to `/auth/forgot-password`

- [ ] **Task 19: Add password reset methods to AuthService**
  - [ ] Add method `requestPasswordReset(email): Observable<any>`
  - [ ] Call POST `/api/auth/forgot-password`
  - [ ] Add method `resetPassword(token, newPassword, newPasswordConfirmation): Observable<any>`
  - [ ] Call POST `/api/auth/reset-password`
  - [ ] Handle responses and errors

- [ ] **Task 20: Create forgot password page UI** (AC: 1, 2)
  - [ ] Use auth-layout (centered form)
  - [ ] UKNF branding/logo
  - [ ] Page title: "Forgot Password?"
  - [ ] Instructions: "Enter your email address and we'll send you a link to reset your password."
  - [ ] Email input field
  - [ ] Submit button: "Send Reset Link"
  - [ ] "Back to Login" link
  - [ ] Success state (after submission)
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 21: Create reset password page UI** (AC: 6, 7)
  - [ ] Use auth-layout
  - [ ] Page title: "Reset Your Password"
  - [ ] Instructions: "Choose a new password for your account"
  - [ ] New password field with strength indicator
  - [ ] Password requirements checklist
  - [ ] Confirm password field
  - [ ] Submit button: "Reset Password"
  - [ ] Success state (after reset)
  - [ ] Error state (invalid/expired token)
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

### Testing Tasks

- [ ] **Task 22: Write unit tests for RequestPasswordResetCommandHandler** (AC: 3, 4)
  - [ ] Test: `Handle_ExistingEmail_SendsResetEmail`
  - [ ] Test: `Handle_NonExistentEmail_ReturnsSuccessWithoutSendingEmail`
  - [ ] Test: `Handle_ExistingEmail_GeneratesSecureToken`
  - [ ] Test: `Handle_Request_LogsEvent`
  - [ ] Verify: Same response for existing and non-existing emails
  - [ ] Mock: IUserRepository, IPasswordResetTokenRepository, IEmailService, ILogger

- [ ] **Task 23: Write unit tests for ResetPasswordCommandHandler** (AC: 5, 6, 7, 8, 9)
  - [ ] Test: `Handle_ValidToken_ResetsPassword`
  - [ ] Test: `Handle_InvalidToken_ThrowsInvalidTokenException`
  - [ ] Test: `Handle_ExpiredToken_ThrowsTokenExpiredException`
  - [ ] Test: `Handle_UsedToken_ThrowsTokenAlreadyUsedException`
  - [ ] Test: `Handle_WeakPassword_ThrowsValidationException`
  - [ ] Test: `Handle_PasswordReset_RevokesAllRefreshTokens`
  - [ ] Test: `Handle_PasswordReset_SendsConfirmationEmail`
  - [ ] Test: `Handle_PasswordReset_AddsToPasswordHistory`
  - [ ] Mock: IPasswordResetTokenRepository, IUserRepository, IPasswordHasher, IPasswordHistoryRepository, IRefreshTokenRepository, IEmailService, ILogger

- [ ] **Task 24: Write integration tests for password reset flow** (AC: All)
  - [ ] Test: `POST_ForgotPassword_ExistingEmail_Returns200AndSendsEmail`
  - [ ] Test: `POST_ForgotPassword_NonExistentEmail_Returns200WithoutSendingEmail`
  - [ ] Test: `POST_ResetPassword_ValidToken_Returns200AndResetsPassword`
  - [ ] Test: `POST_ResetPassword_ExpiredToken_Returns400`
  - [ ] Test: `POST_ResetPassword_InvalidToken_Returns400`
  - [ ] Test: `POST_ResetPassword_RevokesRefreshTokens`
  - [ ] Verify password is changed in database
  - [ ] Verify PasswordHistory entry created
  - [ ] Use Testcontainers for database

- [ ] **Task 25: Write E2E test for password reset flow**
  - [ ] Test complete workflow:
    1. Navigate to login page
    2. Click "Forgot Password?"
    3. Enter email address
    4. Submit form
    5. Verify success message
    6. Extract reset token from email (test SMTP)
    7. Navigate to reset password page with token
    8. Enter new password
    9. Submit form
    10. Verify success message
    11. Redirect to login
    12. Login with new password
    13. Verify successful login
  - [ ] Use Cypress or Playwright

- [ ] **Task 26: Write security tests**
  - [ ] Test: Rate limiting works (4th request fails)
  - [ ] Test: Generic response doesn't reveal email existence
  - [ ] Test: Token expiration enforced
  - [ ] Test: Single-use token (cannot reuse)

---

## Dev Notes

### Previous Story Context

**From Story 1.2:**
- Email service and templates infrastructure
- Secure token generation pattern
- 24-hour token expiration pattern

**From Story 1.3:**
- PasswordPolicy validation
- PasswordHistory to prevent reuse
- IPasswordHasher service
- PasswordStrengthComponent (reusable)

**From Story 1.4:**
- RefreshToken entity and revocation
- Session management

**Key Integration:**
- Similar pattern to account activation (Story 1.2)
- Reuses password policy/hashing from Story 1.3
- Revokes refresh tokens like password change (Story 1.6)

### Data Models

**PasswordResetTokens Table:**
```sql
CREATE TABLE PasswordResetTokens (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    Token NVARCHAR(500) NOT NULL UNIQUE,
    ExpiresAt DATETIME2 NOT NULL,
    IsUsed BIT NOT NULL DEFAULT 0,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    INDEX IX_PasswordResetTokens_Token (Token),
    INDEX IX_PasswordResetTokens_UserId_ExpiresAt (UserId, ExpiresAt)
);
```

### REST API Specification

**Endpoint 1:** POST `/api/auth/forgot-password`
- **Security:** None (public)
- **Request:**
  ```json
  {
    "email": "user@example.com"
  }
  ```
- **Success (200 OK):**
  ```json
  {
    "message": "If that email is registered, we've sent password reset instructions."
  }
  ```
  **Note:** Same response regardless of email existence (security)

**Endpoint 2:** POST `/api/auth/reset-password`
- **Security:** None (public, validated by token)
- **Request:**
  ```json
  {
    "token": "ABC123...",
    "newPassword": "MyNewP@ssw0rd!",
    "newPasswordConfirmation": "MyNewP@ssw0rd!"
  }
  ```
- **Success (200 OK):**
  ```json
  {
    "message": "Password reset successfully. You can now log in."
  }
  ```
- **Errors:**
  - 400: Validation errors, invalid token, expired token

### Security Requirements

1. **Don't Reveal Email Existence:** Always return same success message
2. **Secure Token:** Cryptographically secure, 32+ bytes, 24-hour expiration
3. **Single-Use:** Token can only be used once
4. **Rate Limiting:** 3 requests per email per hour
5. **Session Invalidation:** Revoke all refresh tokens after reset
6. **Email Notifications:** Both request and confirmation emails
7. **Audit Logging:** Log all reset attempts

### User Experience

**Forgot Password Flow:**
1. User clicks "Forgot Password?" on login page
2. Enters email address
3. Sees success message (always, regardless of email existence)
4. Checks email
5. Clicks reset link in email
6. Opens reset password page
7. Sees password requirements
8. Enters new password with strength indicator
9. Confirms password
10. Clicks "Reset Password"
11. Sees success message
12. Redirected to login
13. Logs in with new password

**Email States:**
- If email exists: User receives reset link
- If email doesn't exist: No email sent, but UI shows same message

**Why Generic Messages:**
- Security: Prevents email enumeration
- Privacy: Doesn't reveal who has accounts
- Best practice: Industry standard

### Coding Standards

1. **Never Reveal Email Existence:**
   ```csharp
   // ✅ CORRECT - Same response always
   return new RequestPasswordResetResponse
   {
       Message = "If that email is registered, we've sent password reset instructions."
   };
   ```

2. **Rate Limiting:**
   ```csharp
   // ✅ CORRECT - Prevent abuse
   [EnableRateLimiting("password-reset")]
   [HttpPost("forgot-password")]
   ```

3. **Token Security:**
   ```csharp
   // ✅ CORRECT - Cryptographically secure
   var token = PasswordResetToken.Create(userId);
   // Uses RandomNumberGenerator, 32+ bytes
   ```

### Additional Notes

1. **Token Expiration:** 24 hours (configurable)
2. **Rate Limiting:** Prevents abuse, protects user accounts
3. **Email Confirmation:** Sends email after reset (security notification)
4. **Multi-Device:** Revokes all sessions (force re-login everywhere)
5. **Password History:** Optional for reset (can enforce or not)
6. **Support Contact:** Provide in emails if user didn't request reset

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 1 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

