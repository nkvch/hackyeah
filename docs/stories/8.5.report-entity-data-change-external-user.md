# Story 8.5: Report Entity Data Change (External User)

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.5  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As an** External User,  
**I want to** report that my entity's data is incorrect or has changed,  
**So that** UKNF can update the information.

---

## Acceptance Criteria

1. External user viewing entity details can click "Report Data Change" or "Data is Incorrect"
2. System automatically creates a case with:
   - Category: "Change of registration data"
   - Subject: Auto-populated with "Entity data change report for [Entity Name]"
   - Description: User provides details of what needs to be changed
   - Pre-filled entity context
3. User can specify which fields need updating
4. User can provide correct values
5. User can attach supporting documents (e.g., updated registration documents)
6. Case follows standard case workflow (Epic 5)
7. UKNF Employee receives case notification
8. Case creation is logged
9. User receives confirmation that report was submitted

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ReportEntityChangeCommand** (AC: 2, 3, 4, 5)
  - [ ] Create `ReportEntityChangeCommand.cs` in `Application/UknfPlatform.Application.Communication/Entities/Commands/`
  - [ ] Command properties:
    - EntityId (long, required)
    - Description (string, required) - what needs to be changed
    - FieldChanges (list of FieldChangeDto) - field name, current value, proposed value
    - Attachments (List<IFormFile>, optional)
  - [ ] Create `ReportEntityChangeCommandHandler.cs`
  - [ ] Inject ICaseService (Epic 5), ICurrentUserService, IFileStorageService
  - [ ] Handler logic:
    - Verify user has access to entity
    - Create case with category "Change of registration data"
    - Auto-populate subject
    - Add description and field changes to case
    - Upload attachments to case
    - Log case creation
    - Send notification to UKNF Employee
    - Return case ID and confirmation

- [ ] **Task 2: Create FieldChangeDto** (AC: 3, 4)
  - [ ] Create `FieldChangeDto.cs`
  - [ ] Properties:
    - FieldName (string)
    - CurrentValue (string)
    - ProposedValue (string)
    - Reason (string, optional)

- [ ] **Task 3: Create ReportEntityChangeResponse** (AC: 9)
  - [ ] Create `ReportEntityChangeResponse.cs`
  - [ ] Properties:
    - CaseId (Guid)
    - Message (string) - confirmation message
    - SubmittedDate (DateTime)

- [ ] **Task 4: Create REST API endpoint** (AC: 1, 2)
  - [ ] POST /api/entities/{id}/report-change
  - [ ] Add `[Authorize]` with external user check
  - [ ] Verify user access to entity
  - [ ] Use `[FromForm]` for multipart/form-data (attachments)
  - [ ] Return 201 Created with case ID
  - [ ] Return 403 if user doesn't have access
  - [ ] Return 404 if entity not found
  - [ ] Add Swagger documentation

- [ ] **Task 5: Integrate with Epic 5 case system** (AC: 6, 7)
  - [ ] Use CreateCaseCommand from Epic 5
  - [ ] Set category: "Change of registration data"
  - [ ] Link case to entity
  - [ ] Attach uploaded documents
  - [ ] Trigger notification workflow

### Frontend Tasks

- [ ] **Task 6: Add "Report Data Change" button** (AC: 1)
  - [ ] Add button to entity detail page (Story 8.3)
  - [ ] Prominent placement
  - [ ] Navigate to report change form

- [ ] **Task 7: Create report-entity-change component** (AC: 2, 3, 4, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/entities/report-entity-change/report-entity-change.component.ts`
  - [ ] Configure routing: `/my-entity/:id/report-change`
  - [ ] Display entity name prominently
  - [ ] Reactive form with fields:
    - Description (textarea, required)
    - Field changes (dynamic list)
    - Attachments (file upload, multiple, optional)

- [ ] **Task 8: Create field change selector** (AC: 3, 4)
  - [ ] Dynamic form array
  - [ ] Each entry: Field name (dropdown), Current value (read-only), Proposed value (input), Reason (optional)
  - [ ] Add/remove field change entries
  - [ ] Pre-populate field names from entity schema

- [ ] **Task 9: Implement file upload** (AC: 5)
  - [ ] Multiple file upload
  - [ ] Accept common document formats: PDF, DOCX, XLSX, JPG, PNG
  - [ ] Validate file size (max 100 MB per file, 500 MB total)
  - [ ] Display file list with names and sizes

- [ ] **Task 10: Handle form submission** (AC: 6, 7, 8, 9)
  - [ ] Create FormData with description, field changes, attachments
  - [ ] Call entities service
  - [ ] On success:
    - Show confirmation message with case ID
    - Navigate to case detail or entity page
  - [ ] On error: Display error message
  - [ ] Use toast notifications

### Testing Tasks

- [ ] **Task 11: Write unit tests**
  - [ ] Test: ReportEntityChangeCommandHandler creates case
  - [ ] Test: User access to entity is verified
  - [ ] Test: Case is properly populated
  - [ ] Test: Attachments are uploaded

- [ ] **Task 12: Write integration tests**
  - [ ] Test: POST /api/entities/:id/report-change creates case
  - [ ] Test: Case has correct category and subject
  - [ ] Test: User without access gets 403
  - [ ] Test: Notification is sent

---

## Dev Notes

### Dependencies

- **Epic 5**: Messaging & Cases system provides case creation workflow
- Case category "Change of registration data" must be pre-configured

### Case Structure

Auto-created case includes:
- **Category**: "Change of registration data" (fixed)
- **Subject**: "Entity data change report for [Entity Name]" (auto-generated)
- **Description**: User-provided description
- **Field Changes**: Structured data about proposed changes
- **Attachments**: Supporting documents
- **Entity Context**: Link to entity
- **Reporter**: Current external user

### User Experience

- Make process simple and clear
- Pre-fill as much information as possible
- Provide field selector to make it easy to specify what changed
- Allow free-text description for additional context
- Show confirmation immediately after submission

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

