# Story 4.13: Report Status Tracking

**Epic:** 4 - Reporting System  
**Story Number:** 4.13  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** Employee of Supervised Entity or UKNF Employee,  
**I want to** track the status changes of a report over time,  
**So that** I can understand the complete lifecycle of the report.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.13

1. System maintains complete status history for each report
2. User can view status history showing: Timestamp, Previous status, New status, Triggered by (user or system)
3. Status history includes all transitions: Working → Transmitted → Ongoing → Final Status
4. Manual status changes (e.g., Challenge by UKNF) show which employee made the change
5. Status history is read-only
6. Status history can be exported as part of report details

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ReportStatusHistory domain entity** (AC: 1, 2, 3, 4)
  - [ ] Create `ReportStatusHistory.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties (from AC 2):
    - Id (Guid)
    - ReportId (Guid, required) - FK to Reports
    - PreviousStatus (string, nullable) - null for initial status
    - NewStatus (string, required) - current status
    - ChangedAt (DateTime, required) - AC 2: Timestamp
    - TriggeredBy (string, required) - "System" or "User" - AC 2
    - TriggeredByUserId (Guid?, nullable) - if TriggeredBy = "User" - AC 4
    - TriggeredByUserName (string?, nullable) - for display - AC 4
    - Notes (string?, nullable) - additional context (e.g., "Validation completed" or "Challenged by UKNF")
  - [ ] Relationships: Many-to-One with Report

- [ ] **Task 2: Create database migration for ReportStatusHistory table** (AC: 1)
  - [ ] Create EF Core migration: `Add_ReportStatusHistory_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE ReportStatusHistory (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        ReportId UUID NOT NULL,
        PreviousStatus NVARCHAR(50) NULL,
        NewStatus NVARCHAR(50) NOT NULL,
        ChangedAt DATETIME2 NOT NULL,
        TriggeredBy NVARCHAR(20) NOT NULL CHECK (TriggeredBy IN ('System', 'User')),
        TriggeredByUserId UUID NULL,
        TriggeredByUserName NVARCHAR(500) NULL,
        Notes NVARCHAR(1000) NULL,
        
        FOREIGN KEY (ReportId) REFERENCES Reports(Id) ON DELETE CASCADE,
        FOREIGN KEY (TriggeredByUserId) REFERENCES Users(Id),
        INDEX IX_ReportStatusHistory_ReportId (ReportId),
        INDEX IX_ReportStatusHistory_ChangedAt (ChangedAt)
    );
    ```

- [ ] **Task 3: Update Report entity to track status changes** (AC: 1, 3)
  - [ ] Update Report.cs domain entity
  - [ ] Add domain event: `ReportStatusChanged`
  - [ ] Modify all status-changing methods to raise event:
    - `TransmitForValidation()` - Working → Transmitted
    - `StartValidation()` - Transmitted → Ongoing
    - `CompleteValidation()` - Ongoing → Successful/ValidationErrors/TechnicalError
    - `MarkAsTimedOut()` - Ongoing → TimeoutError
    - `Challenge()` - Successful → ContestedByUKNF
    - `Archive()` - Should NOT create status history (separate from validation status)

- [ ] **Task 4: Create ReportStatusChangedEvent** (AC: 1)
  - [ ] Create `ReportStatusChangedEvent.cs` in `Domain/UknfPlatform.Domain.Communication/Events/`
  - [ ] Event properties:
    - ReportId (Guid)
    - PreviousStatus (string?)
    - NewStatus (string)
    - TriggeredBy (string) - "System" or "User"
    - TriggeredByUserId (Guid?)
    - TriggeredByUserName (string?)
    - Notes (string?)

- [ ] **Task 5: Create ReportStatusChangedEventHandler** (AC: 1, 2)
  - [ ] Create `ReportStatusChangedEventHandler.cs` implementing `INotificationHandler<ReportStatusChangedEvent>`
  - [ ] Inject: IReportStatusHistoryRepository, ILogger
  - [ ] Handler logic:
    - Create ReportStatusHistory entry
    - Set all properties from event
    - Set ChangedAt = DateTime.UtcNow
    - Save to repository
  - [ ] Use async/await

- [ ] **Task 6: Create GetReportStatusHistoryQuery** (AC: 2, 3)
  - [ ] Create `GetReportStatusHistoryQuery.cs` in `Application/UknfPlatform.Application.Communication/Reports/Queries/`
  - [ ] Query properties:
    - ReportId (Guid, required)

- [ ] **Task 7: Create GetReportStatusHistoryQueryHandler** (AC: 2, 3, 5)
  - [ ] Create `GetReportStatusHistoryQueryHandler.cs` implementing `IRequestHandler<GetReportStatusHistoryQuery, ReportStatusHistoryResponse>`
  - [ ] Inject: IReportStatusHistoryRepository, ICurrentUserService, IReportRepository, ILogger
  - [ ] Handler logic:
    - Verify user has access to report (same authorization as viewing report)
    - Fetch report by ID
    - Fetch status history ordered by ChangedAt ascending (AC 3: chronological order)
    - Map to ReportStatusHistoryResponse
    - Mark as read-only (AC 5: informational only)
  - [ ] Return 404 if report not found
  - [ ] Return 403 if user lacks access

- [ ] **Task 8: Create ReportStatusHistoryResponse DTO** (AC: 2, 3, 4)
  - [ ] Create `ReportStatusHistoryResponse.cs` record
  - [ ] Properties:
    - ReportId (Guid)
    - ReportName (string) - context
    - HistoryItems (List<StatusHistoryItemDto>)
  - [ ] StatusHistoryItemDto properties (from AC 2):
    - Id (Guid)
    - PreviousStatus (string?) - null for initial
    - PreviousStatusDisplayName (string?)
    - NewStatus (string)
    - NewStatusDisplayName (string)
    - ChangedAt (DateTime) - AC 2: Timestamp
    - TriggeredBy (string) - "System" or "User" - AC 2
    - TriggeredByUserName (string?) - AC 4: which employee
    - Notes (string?) - additional context
    - DurationInPreviousStatus (TimeSpan?) - calculated

- [ ] **Task 9: Create REST API endpoint GET /api/reports/{id}/status-history** (AC: 2, 5)
  - [ ] Update ReportsController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetReportStatusHistoryAsync(Guid id)`
  - [ ] Send GetReportStatusHistoryQuery via MediatR
  - [ ] Return 200 OK with ReportStatusHistoryResponse
  - [ ] Return 404 if report not found
  - [ ] Return 403 if user lacks access
  - [ ] Add XML documentation comments

- [ ] **Task 10: Update GetReportDetailsQueryHandler to include status history** (AC: 6)
  - [ ] Update handler from Story 4.3
  - [ ] Include status history in ReportDetailsResponse
  - [ ] Add property: StatusHistory (List<StatusHistoryItemDto>)
  - [ ] Or: Add property: StatusHistoryUrl (string) - link to full history endpoint

- [ ] **Task 11: Implement export status history** (AC: 6)
  - [ ] Add export option in report details
  - [ ] Export as CSV or JSON
  - [ ] Include all columns: Timestamp, Previous Status, New Status, Triggered By, User Name, Notes
  - [ ] File name: "report-status-history-{reportId}-{date}.csv"

- [ ] **Task 12: Track status changes in existing handlers** (AC: 1, 3)
  - [ ] Update SubmitReportCommandHandler (Story 4.1):
    - After report created with status "Working", raise ReportStatusChangedEvent
    - PreviousStatus = null (initial), NewStatus = "Working", TriggeredBy = "User"
  - [ ] Update ReportValidatorWorker (Story 4.2):
    - When status changes Transmitted → Ongoing: Raise event, TriggeredBy = "System"
    - When Ongoing → Successful/ValidationErrors: Raise event, TriggeredBy = "System"
  - [ ] Update ChallengeReportCommandHandler (Story 4.10):
    - When Successful → ContestedByUKNF: Raise event, TriggeredBy = "User", TriggeredByUserId = current user

- [ ] **Task 13: Add notes/context to status changes** (AC: 2)
  - [ ] When status changes, include meaningful notes:
    - "Report submitted by user"
    - "Validation process started"
    - "Validation completed successfully"
    - "Validation errors detected"
    - "Challenged by UKNF: [Description]"
    - "Validation timeout after 24 hours"
  - [ ] Helps users understand why status changed

### Frontend Tasks

- [ ] **Task 14: Update reports service** (AC: 2)
  - [ ] Update `reports.service.ts`
  - [ ] Method: `getReportStatusHistory(reportId): Observable<ReportStatusHistoryResponse>`

- [ ] **Task 15: Create status history component** (AC: 2, 3, 4, 5)
  - [ ] Create `report-status-history.component.ts` in `features/reporting/report-details/components/`
  - [ ] Inject ReportsService
  - [ ] Input: reportId (Guid)
  - [ ] Load status history on init
  - [ ] Display as timeline or table

- [ ] **Task 16: Display status history as timeline** (AC: 2, 3)
  - [ ] Use PrimeNG Timeline component
  - [ ] Display in chronological order (oldest to newest)
  - [ ] Each item shows (AC 2):
    - Status transition: "Working → Transmitted"
    - Timestamp: "2025-10-04 10:00:00"
    - Triggered by: "System" or user name
    - Duration: "5 seconds" or "2 hours"
    - Notes: Additional context
  - [ ] Use icons for status types (✓ success, ✗ error, ⚠ warning)
  - [ ] Color-code by status type (green, red, yellow)

- [ ] **Task 17: Display triggered by information** (AC: 2, 4)
  - [ ] For system-triggered changes: Show "System" with system icon
  - [ ] For user-triggered changes: Show user name with user icon (AC 4)
  - [ ] Example: "Changed by Anna Nowak (UKNF Employee)"
  - [ ] Distinguish between external users and UKNF employees

- [ ] **Task 18: Calculate and display duration** (AC: 3)
  - [ ] Calculate time spent in each status
  - [ ] Display: "Working for 30 seconds"
  - [ ] Display: "Ongoing for 7 minutes"
  - [ ] Use humanized time format (seconds, minutes, hours, days)

- [ ] **Task 19: Add status history to report details page** (AC: 2, 5)
  - [ ] Update report-details component from Story 4.3
  - [ ] Add "Status History" section or tab
  - [ ] Show status history timeline
  - [ ] Collapsible section (expand/collapse)
  - [ ] Read-only display (AC 5: no editing)

- [ ] **Task 20: Implement export status history** (AC: 6)
  - [ ] Add "Export Status History" button in report details
  - [ ] Options: CSV or JSON
  - [ ] On click, download file
  - [ ] File name: "report-status-history-{reportId}-{date}.csv"
  - [ ] Use FileSaver or native download

- [ ] **Task 21: Add status history indicator** (AC: Related)
  - [ ] In reports list, show icon indicating status history available
  - [ ] Tooltip: "View status history"
  - [ ] Click opens report details with history expanded

- [ ] **Task 22: Handle empty state** (AC: 1)
  - [ ] If no status history (shouldn't happen): "No status history available"
  - [ ] At minimum, should have one entry (initial status)

### Testing Tasks

- [ ] **Task 23: Write unit tests for ReportStatusChangedEventHandler**
  - [ ] Test: `Handle_ValidEvent_CreatesHistoryEntry` (AC 1)
  - [ ] Test: `Handle_InitialStatus_NullPreviousStatus`
  - [ ] Test: `Handle_SystemTriggered_NoUserId`
  - [ ] Test: `Handle_UserTriggered_IncludesUserId` (AC 4)
  - [ ] Mock: IReportStatusHistoryRepository

- [ ] **Task 24: Write unit tests for GetReportStatusHistoryQueryHandler**
  - [ ] Test: `Handle_ValidReport_ReturnsHistory` (AC 2)
  - [ ] Test: `Handle_OrdersChronologically` (AC 3)
  - [ ] Test: `Handle_IncludesAllTransitions` (AC 3)
  - [ ] Test: `Handle_ShowsTriggeredBy` (AC 2, 4)
  - [ ] Mock: IReportStatusHistoryRepository

- [ ] **Task 25: Write integration test for status history endpoint**
  - [ ] Test: `GET_StatusHistory_ValidReport_Returns200` (AC 2)
  - [ ] Test: `GET_StatusHistory_UnauthorizedUser_Returns403`
  - [ ] Test: `GET_StatusHistory_ReportNotFound_Returns404`
  - [ ] Create test data: report with multiple status changes
  - [ ] Verify history ordered chronologically (AC 3)
  - [ ] Verify user-triggered changes show user name (AC 4)

- [ ] **Task 26: Write integration test for status tracking**
  - [ ] Test: `SubmitReport_CreatesInitialStatusHistory` (AC 1)
  - [ ] Test: `ValidationProcess_TracksAllStatusChanges` (AC 3)
  - [ ] Test workflow:
    1. Submit report (status = Working)
    2. Verify history entry created
    3. Transmit for validation (status = Transmitted)
    4. Verify history entry created
    5. Start validation (status = Ongoing)
    6. Verify history entry created
    7. Complete validation (status = Successful)
    8. Verify history entry created
    9. Verify total 4 history entries
    10. Verify chronological order

- [ ] **Task 27: Write E2E test for status history flow**
  - [ ] Test workflow:
    1. Login as external user
    2. Submit report
    3. Navigate to report details
    4. Expand "Status History" section (AC 2)
    5. Verify initial status "Working" shown
    6. Wait for validation to progress
    7. Verify status changes appear in timeline (AC 3)
    8. Verify system-triggered changes show "System" (AC 2)
    9. Login as UKNF employee
    10. Challenge the report (AC 4)
    11. Navigate back to report details
    12. Verify challenge shows employee name (AC 4)
    13. Click "Export Status History" (AC 6)
    14. Verify file downloads
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.1-4.10:**
- Multiple stories change report status
- This story tracks all those changes for audit and transparency

**Key Integration:**
- All status-changing operations raise ReportStatusChangedEvent
- Event handler creates history entries
- Users view complete lifecycle in report details

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- Domain Events: MediatR notifications

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Timeline, Card, Button)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Domain/UknfPlatform.Domain.Communication/
│   ├── Entities/
│   │   ├── Report.cs (UPDATE - add status change events)
│   │   └── ReportStatusHistory.cs (CREATE)
│   └── Events/
│       └── ReportStatusChangedEvent.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Reports/
│   ├── EventHandlers/
│   │   └── ReportStatusChangedEventHandler.cs (CREATE)
│   ├── Queries/
│   │   ├── GetReportStatusHistoryQuery.cs (CREATE)
│   │   └── GetReportStatusHistoryQueryHandler.cs (CREATE)
│   └── DTOs/
│       ├── ReportStatusHistoryResponse.cs (CREATE)
│       └── StatusHistoryItemDto.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Persistence/
    ├── Repositories/
    │   ├── IReportStatusHistoryRepository.cs (CREATE)
    │   └── ReportStatusHistoryRepository.cs (CREATE)
    └── Migrations/
        └── Add_ReportStatusHistory_Table.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
└── features/reporting/report-details/components/
    ├── report-status-history.component.ts (CREATE)
    ├── report-status-history.component.html (CREATE)
    └── report-status-history.component.scss (CREATE)
```

### Data Models

**ReportStatusHistory Entity:**
- Immutable audit trail of status changes
- One entry per status change
- Tracks who/what triggered change
- Read-only (AC 5)

**Report Entity Update:**
- Add domain events for status changes
- Raise ReportStatusChangedEvent when ValidationStatus changes

### REST API Specification

**Endpoint:** GET `/api/reports/{id}/status-history`
- **Security:** Requires authentication + authorization
- **Success Response (200 OK):**
  ```json
  {
    "reportId": "guid",
    "reportName": "G. RIP100000_Q1_2025.xlsx",
    "historyItems": [
      {
        "id": "guid1",
        "previousStatus": null,
        "previousStatusDisplayName": null,
        "newStatus": "Working",
        "newStatusDisplayName": "Processing",
        "changedAt": "2025-10-04T10:00:00Z",
        "triggeredBy": "User",
        "triggeredByUserName": "Jan Kowalski",
        "notes": "Report submitted by user",
        "durationInPreviousStatus": null
      },
      {
        "id": "guid2",
        "previousStatus": "Working",
        "previousStatusDisplayName": "Processing",
        "newStatus": "Transmitted",
        "newStatusDisplayName": "Submitted for Validation",
        "changedAt": "2025-10-04T10:00:05Z",
        "triggeredBy": "System",
        "triggeredByUserName": null,
        "notes": "Validation process started",
        "durationInPreviousStatus": "00:00:05"
      },
      {
        "id": "guid3",
        "previousStatus": "Transmitted",
        "previousStatusDisplayName": "Submitted for Validation",
        "newStatus": "Ongoing",
        "newStatusDisplayName": "Validation in Progress",
        "changedAt": "2025-10-04T10:00:10Z",
        "triggeredBy": "System",
        "triggeredByUserName": null,
        "notes": "Validation started",
        "durationInPreviousStatus": "00:00:05"
      },
      {
        "id": "guid4",
        "previousStatus": "Ongoing",
        "previousStatusDisplayName": "Validation in Progress",
        "newStatus": "Successful",
        "newStatusDisplayName": "Validation Successful",
        "changedAt": "2025-10-04T10:00:17Z",
        "triggeredBy": "System",
        "triggeredByUserName": null,
        "notes": "Validation completed successfully",
        "durationInPreviousStatus": "00:00:07"
      },
      {
        "id": "guid5",
        "previousStatus": "Successful",
        "previousStatusDisplayName": "Validation Successful",
        "newStatus": "ContestedByUKNF",
        "newStatusDisplayName": "Contested by UKNF",
        "changedAt": "2025-10-04T14:30:00Z",
        "triggeredBy": "User",
        "triggeredByUserName": "Anna Nowak (UKNF)",
        "notes": "Challenged by UKNF: Total assets figure inconsistent",
        "durationInPreviousStatus": "04:29:43"
      }
    ]
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Raise domain events for status changes (AC 1)**
   ```csharp
   // ✅ CORRECT - In Report domain entity
   public void TransmitForValidation(string validationId)
   {
       var previousStatus = this.ValidationStatus;
       this.ValidationStatus = ValidationStatus.Transmitted;
       this.UniqueValidationId = validationId;
       this.UpdatedDate = DateTime.UtcNow;
       
       // Raise domain event
       this.AddDomainEvent(new ReportStatusChangedEvent
       {
           ReportId = this.Id,
           PreviousStatus = previousStatus.ToString(),
           NewStatus = this.ValidationStatus.ToString(),
           TriggeredBy = "System",
           Notes = "Validation process started"
       });
   }
   ```

2. **Handle events to create history (AC 1)**
   ```csharp
   // ✅ CORRECT - Event handler
   public async Task Handle(ReportStatusChangedEvent notification, CancellationToken cancellationToken)
   {
       var history = new ReportStatusHistory
       {
           ReportId = notification.ReportId,
           PreviousStatus = notification.PreviousStatus,
           NewStatus = notification.NewStatus,
           ChangedAt = DateTime.UtcNow,
           TriggeredBy = notification.TriggeredBy,
           TriggeredByUserId = notification.TriggeredByUserId,
           TriggeredByUserName = notification.TriggeredByUserName,
           Notes = notification.Notes
       };
       
       await _repository.AddAsync(history);
       await _unitOfWork.SaveChangesAsync(cancellationToken);
   }
   ```

3. **Order chronologically (AC 3)**
   ```csharp
   // ✅ CORRECT
   var history = await _context.ReportStatusHistory
       .Where(h => h.ReportId == reportId)
       .OrderBy(h => h.ChangedAt) // Chronological order
       .ToListAsync();
   ```

4. **Calculate duration**
   ```csharp
   // ✅ CORRECT
   for (int i = 1; i < historyItems.Count; i++)
   {
       var previousItem = historyItems[i - 1];
       var currentItem = historyItems[i];
       currentItem.DurationInPreviousStatus = currentItem.ChangedAt - previousItem.ChangedAt;
   }
   ```

5. **Read-only display (AC 5)**
   ```csharp
   // ✅ CORRECT - No update/delete endpoints
   // Only GET endpoint for viewing
   [HttpGet("{id}/status-history")]
   public async Task<ActionResult<ReportStatusHistoryResponse>> GetStatusHistory(Guid id)
   {
       // Read-only - no POST/PUT/DELETE
   }
   ```

### UI/UX Considerations

**Timeline Display:**
```html
<p-timeline [value]="statusHistory" align="left">
  <ng-template pTemplate="content" let-item>
    <div class="status-history-item">
      <div class="flex items-center gap-2">
        <p-tag [value]="item.newStatusDisplayName" [severity]="getStatusSeverity(item.newStatus)"></p-tag>
        <span class="text-sm text-gray-600">
          {{ item.changedAt | date:'medium' }}
        </span>
      </div>
      
      <div class="mt-2">
        <p *ngIf="item.previousStatus" class="text-sm">
          <strong>Transition:</strong> {{ item.previousStatusDisplayName }} → {{ item.newStatusDisplayName }}
        </p>
        <p class="text-sm">
          <strong>Triggered by:</strong> 
          <span *ngIf="item.triggeredBy === 'System'">
            <i class="pi pi-cog"></i> System
          </span>
          <span *ngIf="item.triggeredBy === 'User'">
            <i class="pi pi-user"></i> {{ item.triggeredByUserName }}
          </span>
        </p>
        <p *ngIf="item.durationInPreviousStatus" class="text-sm text-gray-600">
          Duration: {{ item.durationInPreviousStatus | duration }}
        </p>
        <p *ngIf="item.notes" class="text-sm italic">
          {{ item.notes }}
        </p>
      </div>
    </div>
  </ng-template>
</p-timeline>
```

### Business Rules

**What Triggers Status Changes:**
- **User-triggered:** Submit report, Challenge report, Manually set status (admin)
- **System-triggered:** Validation process, Timeout detection, Automatic status updates

**Status Transitions (AC 3):**
- Working → Transmitted (system)
- Transmitted → Ongoing (system)
- Ongoing → Successful (system)
- Ongoing → ValidationErrors (system)
- Ongoing → TechnicalError (system)
- Ongoing → TimeoutError (system)
- Successful → ContestedByUKNF (user: UKNF employee)

**History Persistence:**
- Status history never deleted (audit trail)
- If report deleted, history remains (soft delete recommended)
- History is immutable (no updates)

### Security Requirements

- Same authorization as viewing report
- External users see status history for their reports
- UKNF employees see status history for all reports
- History is read-only (AC 5)
- User names in history respect privacy rules

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Status history typically small (< 10 entries per report)
- Index on ReportId for efficient queries
- Load history only when user expands section (lazy loading)
- Cache status display names (don't recalculate)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Status change creates history entry
- History ordered chronologically
- User-triggered shows user name
- System-triggered shows "System"
- Duration calculated correctly
- Read-only (no modification)

**Example:**
```csharp
[Fact]
public async Task SubmitReport_CreatesInitialStatusHistory()
{
    // Arrange - AC 1
    var command = new SubmitReportCommand { /* ... */ };
    
    // Act
    var result = await _submitHandler.Handle(command, CancellationToken.None);
    
    // Assert
    var history = await _context.ReportStatusHistory
        .Where(h => h.ReportId == result.ReportId)
        .ToListAsync();
    
    history.Should().HaveCount(1);
    history[0].PreviousStatus.Should().BeNull(); // Initial
    history[0].NewStatus.Should().Be("Working");
    history[0].TriggeredBy.Should().Be("User");
}
```

### Additional Notes

1. **Status History vs. Audit Log:** Status history is specific to status changes. Audit log (AuditLogs table) tracks all changes. Complementary systems.

2. **Archive Status:** Archiving (Story 4.9) doesn't change ValidationStatus, so no status history entry. Archive tracked in AuditLogs.

3. **Correction Reports:** Each report has its own status history. Correction report starts fresh with "Working" status.

4. **Real-time Updates:** If using SignalR, status history can update in real-time as validation progresses.

5. **Export Format:** CSV columns: Timestamp, Previous Status, New Status, Triggered By, User Name, Notes, Duration

6. **Humanized Duration:** Use libraries like Humanizer to display "7 seconds" instead of "00:00:07".

7. **Status History in Lists:** Too detailed for list view. Only in report details.

8. **Compliance Reporting:** Status history useful for understanding why reports took long to validate.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

