# Story 2.2: Complete and Submit Access Request

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.2  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** external user with a "Working" access request,  
**I want to** complete my access request by selecting entities and permissions,  
**So that** it can be reviewed and approved by authorized personnel.

---

## Acceptance Criteria

1. User can edit their "Working" access request
2. User can select supervised entities from the UKNF Directory of Entities
3. User can request permissions by checking checkboxes for: Reporting, Cases, Entity Administrator
4. User can add entity email address (for automatic notifications to that entity)
5. User can add attachments to support their request
6. All mandatory fields must be completed before submission
7. Upon submission, request status changes from "Working" to "New"
8. User sees confirmation message: "Your access request has been submitted"
9. User receives automatic email confirmation of submission
10. Request becomes visible to appropriate approvers (UKNF Employees or Entity Administrators)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create PermissionLine entity** (AC: 2, 3, 4)
  - [ ] Create `PermissionLine.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties: Id, AccessRequestId (Guid FK), EntityId (long FK), HasReportingAccess (bool), HasCasesAccess (bool), IsEntityAdministrator (bool), IsBlocked (bool), EntityEmailForNotifications (string), GrantedByUserId (Guid?), GrantedDate (DateTime?), CreatedDate, UpdatedDate
  - [ ] Add domain method `Create(accessRequestId, entityId)`
  - [ ] Add domain method `SetPermissions(hasReporting, hasCases, isAdmin)`
  - [ ] Add domain method `SetEntityEmail(email)`
  - [ ] Add domain method `Grant(grantedByUserId)`
  - [ ] Add domain method `Block()`
  - [ ] Encapsulate permission properties

- [ ] **Task 2: Create EF Core configuration for PermissionLine** (AC: 2, 3)
  - [ ] Create `PermissionLineConfiguration.cs` in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Configurations/`
  - [ ] Configure table name "PermissionLines"
  - [ ] Configure primary key
  - [ ] Configure foreign keys: AccessRequestId, EntityId, GrantedByUserId
  - [ ] Configure CASCADE delete for AccessRequestId
  - [ ] Configure indexes: IX_PermissionLines_AccessRequestId, IX_PermissionLines_EntityId
  - [ ] Configure EntityEmailForNotifications max length 500

- [ ] **Task 3: Create database migration for PermissionLines table** (AC: 2, 3)
  - [ ] Create EF Core migration `Add_PermissionLines_Table`
  - [ ] Verify schema:
    - Id UUID PRIMARY KEY
    - AccessRequestId UUID NOT NULL FK (CASCADE DELETE)
    - EntityId BIGINT NOT NULL FK to Entities
    - HasReportingAccess BIT DEFAULT 0
    - HasCasesAccess BIT DEFAULT 0
    - IsEntityAdministrator BIT DEFAULT 0
    - IsBlocked BIT DEFAULT 0
    - EntityEmailForNotifications NVARCHAR(500) NULL
    - GrantedByUserId UUID NULL FK to Users
    - GrantedDate DATETIME2 NULL
  - [ ] Add indexes

- [ ] **Task 4: Create Entity entity and configuration** (AC: 2)
  - [ ] Create `Entity.cs` in `Domain/UknfPlatform.Domain.Common/Entities/`
  - [ ] Properties: Id (long), UknfCode, EntityType, Name, LEI, NIP, KRS, Address fields, Phone, Email, UknfRegistrationNumber, EntityStatus, Category, Sector, SubSector, IsCrossBorder
  - [ ] This entity represents data from UKNF Directory (external source)
  - [ ] Create `EntityConfiguration.cs` for EF Core
  - [ ] Configure as read-only or external-managed table
  - [ ] NOTE: Entity data comes from UKNF Directory - sync mechanism in Epic 8

- [ ] **Task 5: Update AccessRequest entity with PermissionLines** (AC: 2, 3)
  - [ ] Add navigation property: `ICollection<PermissionLine> PermissionLines`
  - [ ] Add domain method `AddPermissionLine(entityId, hasReporting, hasCases, isAdmin, entityEmail)`
  - [ ] Add domain method `RemovePermissionLine(permissionLineId)`
  - [ ] Add domain method `CanBeSubmitted()` - validates at least one permission line exists
  - [ ] Update `Submit()` method to check `CanBeSubmitted()`

- [ ] **Task 6: Create UpdateAccessRequestCommand and Handler** (AC: 1, 2, 3, 4)
  - [ ] Create `UpdateAccessRequestCommand.cs` in `Application/UknfPlatform.Application.Auth/AccessRequests/Commands/`
  - [ ] Command properties: AccessRequestId, PermissionLines (list of PermissionLineDto)
  - [ ] PermissionLineDto: EntityId, HasReportingAccess, HasCasesAccess, IsEntityAdministrator, EntityEmailForNotifications
  - [ ] Create `UpdateAccessRequestCommandHandler.cs`
  - [ ] Handler logic:
    - Get access request by ID
    - Verify request belongs to authenticated user
    - Verify request status is "Working" (only drafts editable)
    - Clear existing permission lines
    - Add new permission lines from command
    - Validate at least one permission selected per entity
    - Save changes
    - Return success
  - [ ] Inject: IAccessRequestRepository, IEntityRepository

- [ ] **Task 7: Create FluentValidation validator for UpdateAccessRequestCommand** (AC: 6)
  - [ ] Create `UpdateAccessRequestCommandValidator.cs`
  - [ ] Validate AccessRequestId: NotEmpty
  - [ ] Validate PermissionLines: NotEmpty (at least one)
  - [ ] For each PermissionLine:
    - EntityId: NotEmpty, must exist in Entities table
    - At least one permission selected (HasReportingAccess OR HasCasesAccess OR IsEntityAdministrator)
    - EntityEmailForNotifications: EmailAddress format if provided

- [ ] **Task 8: Create SubmitAccessRequestCommand and Handler** (AC: 7, 8, 9, 10)
  - [ ] Create `SubmitAccessRequestCommand.cs`
  - [ ] Command property: AccessRequestId
  - [ ] Create `SubmitAccessRequestCommandHandler.cs`
  - [ ] Handler logic:
    - Get access request by ID
    - Verify request belongs to authenticated user
    - Verify request status is "Working"
    - Verify request.CanBeSubmitted() (has permission lines)
    - Call accessRequest.Submit() - changes status to "New", sets SubmittedDate
    - Save changes
    - Send email confirmation to user
    - Send notification to appropriate approvers (UKNF or Entity Admin)
    - Log submission
    - Return success response
  - [ ] Inject: IAccessRequestRepository, IEmailService, ILogger

- [ ] **Task 9: Create submission confirmation email template** (AC: 9)
  - [ ] Create `AccessRequestSubmittedEmail.cshtml` in email templates
  - [ ] Template content:
    - "Your access request has been submitted"
    - User's name
    - List of entities and permissions requested
    - "We'll notify you once your request is reviewed"
    - Expected review timeframe
    - Support contact
  - [ ] Responsive HTML design

- [ ] **Task 10: Create AccessRequestAttachment entity** (AC: 5)
  - [ ] Create `AccessRequestAttachment.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties: Id, AccessRequestId (FK), FileName, FileStorageKey, FileSize, ContentType, UploadedDate
  - [ ] Create EF Core configuration and migration
  - [ ] Files stored in MinIO/object storage

- [ ] **Task 11: Create file upload endpoints** (AC: 5)
  - [ ] Add action to `AccessRequestsController`: `UploadAttachmentAsync(Guid accessRequestId, IFormFile file)`
  - [ ] `[Authorize]` attribute
  - [ ] Validate file size (max 10MB)
  - [ ] Validate file type (allowed: PDF, DOCX, XLSX, JPG, PNG)
  - [ ] Scan with ClamAV antivirus
  - [ ] Store in MinIO with key: `access-requests/{accessRequestId}/{guid}-{filename}`
  - [ ] Save metadata to AccessRequestAttachment
  - [ ] Return attachment ID and file info
  - [ ] Add action: `DeleteAttachmentAsync(Guid attachmentId)`

- [ ] **Task 12: Create REST API endpoint PUT /api/access-requests/{id}** (AC: 1, 2, 3, 4)
  - [ ] Add action: `UpdateAccessRequestAsync(Guid id, UpdateAccessRequestCommand command)`
  - [ ] `[Authorize]` attribute
  - [ ] Set command.AccessRequestId = id from route
  - [ ] Send command via MediatR
  - [ ] Return 200 OK
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not user's request or not editable
  - [ ] Add Swagger documentation

- [ ] **Task 13: Create REST API endpoint POST /api/access-requests/{id}/submit** (AC: 7, 8, 9)
  - [ ] Add action: `SubmitAccessRequestAsync(Guid id)`
  - [ ] `[Authorize]` attribute
  - [ ] Send SubmitAccessRequestCommand via MediatR
  - [ ] Return 200 OK with success message
  - [ ] Return 400 Bad Request if cannot be submitted (no permission lines)
  - [ ] Return 403 Forbidden if not user's request or wrong status
  - [ ] Success message: "Your access request has been submitted successfully"
  - [ ] Add Swagger documentation

- [ ] **Task 14: Create GET /api/entities endpoint** (AC: 2)
  - [ ] Create `EntitiesController.cs`
  - [ ] Add action: `GetEntitiesAsync(string search, int page, int pageSize)`
  - [ ] `[Authorize]` attribute
  - [ ] Support search by: UknfCode, Name, NIP, KRS
  - [ ] Support pagination
  - [ ] Filter: EntityStatus == "Active" (only active entities selectable)
  - [ ] Return list of EntityDto with relevant fields
  - [ ] Add Swagger documentation

### Frontend Tasks

- [ ] **Task 15: Create entity selection component** (AC: 2)
  - [ ] Create `entity-selector.component.ts` (reusable component)
  - [ ] Use PrimeNG AutoComplete for entity search
  - [ ] Load entities from API with search/pagination
  - [ ] Display: UknfCode, Name, EntityType
  - [ ] Allow multi-select (user can select multiple entities)
  - [ ] Input: selected entities
  - [ ] Output: entity selected/deselected events

- [ ] **Task 16: Create permission line component** (AC: 3, 4)
  - [ ] Create `permission-line.component.ts` (reusable component)
  - [ ] Inputs: entity, permissions (hasReporting, hasCases, isAdmin), entityEmail
  - [ ] Display entity information (name, code)
  - [ ] Checkboxes for permissions:
    - ☐ Reporting Access
    - ☐ Cases Access
    - ☐ Entity Administrator
  - [ ] Input field for entity email (optional)
  - [ ] Validation: at least one permission must be selected
  - [ ] Remove button to delete permission line
  - [ ] Outputs: permission changes, remove event

- [ ] **Task 17: Create file upload component** (AC: 5)
  - [ ] Create `access-request-attachments.component.ts`
  - [ ] Use PrimeNG FileUpload component
  - [ ] Support drag-and-drop
  - [ ] Display uploaded files list with delete option
  - [ ] Show upload progress
  - [ ] Validate file size and type on client
  - [ ] Call upload API endpoint
  - [ ] Display file info: name, size, upload date

- [ ] **Task 18: Create/update access request edit page** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `edit-access-request.component.ts` or update `my-access-request.component.ts`
  - [ ] Route: `/access-requests/edit` or `/access-requests/my-request/edit`
  - [ ] Load current access request
  - [ ] Check status == "Working" (only editable in Working status)
  - [ ] Form sections:
    1. User Information (read-only, from Story 2.1)
    2. Entity Selection and Permissions
    3. Attachments
  - [ ] Entity section:
    - Entity selector (search and add entities)
    - List of selected entities with permission checkboxes
    - Each entity has permission line component
    - Remove entity button
  - [ ] Attachments section:
    - File upload component
    - List of uploaded attachments

- [ ] **Task 19: Implement form validation** (AC: 6)
  - [ ] Reactive form with FormArray for permission lines
  - [ ] Validation rules:
    - At least one entity selected
    - Each entity has at least one permission checked
    - Entity email format valid if provided
  - [ ] Display validation errors
  - [ ] Disable submit if form invalid

- [ ] **Task 20: Implement save draft functionality** (AC: 1)
  - [ ] "Save Draft" button
  - [ ] Call PUT /api/access-requests/{id}
  - [ ] Show success toast: "Draft saved"
  - [ ] Can save without submitting (status stays "Working")

- [ ] **Task 21: Implement submit functionality** (AC: 7, 8)
  - [ ] "Submit Request" button
  - [ ] Validate form before submission
  - [ ] Show confirmation dialog: "Submit your access request for approval?"
  - [ ] On confirm:
    - Call POST /api/access-requests/{id}/submit
    - Show success message: "Your access request has been submitted successfully!"
    - Redirect to request view page (read-only mode)
  - [ ] Disable submit button while processing

- [ ] **Task 22: Create access request service methods** (AC: 1, 7)
  - [ ] Update `access-request.service.ts`
  - [ ] Add method `updateAccessRequest(id, data): Observable<void>`
  - [ ] Add method `submitAccessRequest(id): Observable<void>`
  - [ ] Add method `uploadAttachment(id, file): Observable<AttachmentDto>`
  - [ ] Add method `deleteAttachment(attachmentId): Observable<void>`

- [ ] **Task 23: Create entity service** (AC: 2)
  - [ ] Create `entity.service.ts`
  - [ ] Add method `searchEntities(search, page, pageSize): Observable<EntityDto[]>`
  - [ ] Call GET `/api/entities`

- [ ] **Task 24: Create edit page UI** (AC: All)
  - [ ] Page title: "Complete Your Access Request"
  - [ ] Progress indicator or stepper (optional)
  - [ ] Card sections:
    - Your Information (read-only)
    - Entities & Permissions (editable)
    - Supporting Documents (attachments)
  - [ ] Action buttons:
    - "Save Draft" (secondary)
    - "Submit Request" (primary)
    - "Cancel" (navigate back)
  - [ ] Use PrimeNG components (Card, Button, AutoComplete, FileUpload, Checkbox)
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 25: Update navigation after submission** (AC: 8, 10)
  - [ ] After successful submission, show success page or redirect
  - [ ] Update access request view to show "New" status
  - [ ] Disable edit button (no longer editable)
  - [ ] Show submitted date and info banner: "Your request is being reviewed"

### Testing Tasks

- [ ] **Task 26: Write unit tests for PermissionLine entity** (AC: 2, 3)
  - [ ] Test: `Create_InitializesWithCorrectDefaults`
  - [ ] Test: `SetPermissions_UpdatesAccessFlags`
  - [ ] Test: `Grant_SetsGrantedByAndDate`
  - [ ] Test: `Block_SetsIsBlockedToTrue`

- [ ] **Task 27: Write unit tests for UpdateAccessRequestCommandHandler** (AC: 1, 2, 3)
  - [ ] Test: `Handle_ValidCommand_UpdatesPermissionLines`
  - [ ] Test: `Handle_WorkingStatus_AllowsUpdate`
  - [ ] Test: `Handle_NonWorkingStatus_ThrowsForbiddenException`
  - [ ] Test: `Handle_NotUserRequest_ThrowsForbiddenException`
  - [ ] Test: `Handle_ClearsExistingPermissionLines`
  - [ ] Mock: IAccessRequestRepository, IEntityRepository

- [ ] **Task 28: Write unit tests for SubmitAccessRequestCommandHandler** (AC: 7, 8, 9)
  - [ ] Test: `Handle_ValidRequest_ChangesStatusToNew`
  - [ ] Test: `Handle_ValidRequest_SetsSubmittedDate`
  - [ ] Test: `Handle_ValidRequest_SendsConfirmationEmail`
  - [ ] Test: `Handle_NoPermissionLines_ThrowsValidationException`
  - [ ] Test: `Handle_AlreadySubmitted_ThrowsInvalidOperationException`
  - [ ] Test: `Handle_LogsSubmission`
  - [ ] Mock: IAccessRequestRepository, IEmailService, ILogger

- [ ] **Task 29: Write integration tests for access request workflow** (AC: All)
  - [ ] Test: `PUT_AccessRequest_WorkingStatus_Updates200`
  - [ ] Test: `PUT_AccessRequest_NonWorkingStatus_Returns403`
  - [ ] Test: `POST_Submit_ValidRequest_Returns200AndChangesStatus`
  - [ ] Test: `POST_Submit_EmptyPermissionLines_Returns400`
  - [ ] Test: `POST_Submit_SendsEmailConfirmation`
  - [ ] Test: `UploadAttachment_ValidFile_Uploads200`
  - [ ] Test: `UploadAttachment_ExceedsSize_Returns400`
  - [ ] Test: `GET_Entities_ReturnsActiveEntitiesOnly`
  - [ ] Use Testcontainers for database and MinIO

- [ ] **Task 30: Write E2E test for complete access request submission**
  - [ ] Test workflow:
    1. Login as user with Working access request
    2. Navigate to "Complete Access Request"
    3. Search and select an entity
    4. Check permission checkboxes (Reporting, Cases)
    5. Add entity email
    6. Upload attachment (PDF file)
    7. Click "Save Draft" - verify success
    8. Click "Submit Request"
    9. Confirm submission dialog
    10. Verify success message
    11. Verify status changed to "New"
    12. Verify email sent (check test SMTP)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 2.1:**
- AccessRequest entity with status "Working"
- GetAccessRequest endpoint
- User can view their draft request

**Key Integration:**
- This story builds on Story 2.1 by adding permission lines and submission

### Data Models

**PermissionLine Entity:**
```csharp
public class PermissionLine
{
    public Guid Id { get; private set; }
    public Guid AccessRequestId { get; private set; }
    public long EntityId { get; private set; }
    public bool HasReportingAccess { get; private set; }
    public bool HasCasesAccess { get; private set; }
    public bool IsEntityAdministrator { get; private set; }
    public bool IsBlocked { get; private set; }
    public string EntityEmailForNotifications { get; private set; }
    public Guid? GrantedByUserId { get; private set; }
    public DateTime? GrantedDate { get; private set; }
    
    // Navigation
    public AccessRequest AccessRequest { get; private set; }
    public Entity Entity { get; private set; }
    
    public static PermissionLine Create(Guid accessRequestId, long entityId)
    {
        return new PermissionLine
        {
            Id = Guid.NewGuid(),
            AccessRequestId = accessRequestId,
            EntityId = entityId,
            HasReportingAccess = false,
            HasCasesAccess = false,
            IsEntityAdministrator = false,
            IsBlocked = false
        };
    }
    
    public void SetPermissions(bool hasReporting, bool hasCases, bool isAdmin)
    {
        if (!hasReporting && !hasCases && !isAdmin)
            throw new InvalidOperationException("At least one permission must be selected");
            
        HasReportingAccess = hasReporting;
        HasCasesAccess = hasCases;
        IsEntityAdministrator = isAdmin;
    }
    
    public void Grant(Guid grantedByUserId)
    {
        GrantedByUserId = grantedByUserId;
        GrantedDate = DateTime.UtcNow;
        IsBlocked = false;
    }
}
```

### REST API Specification

**Endpoint 1:** PUT `/api/access-requests/{id}`
- **Security:** Requires authentication
- **Request:**
  ```json
  {
    "permissionLines": [
      {
        "entityId": 123,
        "hasReportingAccess": true,
        "hasCasesAccess": true,
        "isEntityAdministrator": false,
        "entityEmailForNotifications": "entity@example.com"
      }
    ]
  }
  ```
- **Success (200 OK):** Empty body
- **Errors:** 400 (validation), 403 (not editable/not owner)

**Endpoint 2:** POST `/api/access-requests/{id}/submit`
- **Security:** Requires authentication
- **Request:** Empty body
- **Success (200 OK):**
  ```json
  {
    "message": "Your access request has been submitted successfully"
  }
  ```
- **Errors:** 400 (cannot submit), 403 (not owner/wrong status)

**Endpoint 3:** POST `/api/access-requests/{id}/attachments`
- **Security:** Requires authentication
- **Request:** multipart/form-data with file
- **Success (200 OK):**
  ```json
  {
    "id": "att-guid",
    "fileName": "document.pdf",
    "fileSize": 1024000,
    "uploadedDate": "2025-10-04T12:00:00Z"
  }
  ```

**Endpoint 4:** GET `/api/entities?search={query}&page={page}&pageSize={size}`
- **Security:** Requires authentication
- **Success (200 OK):**
  ```json
  {
    "items": [
      {
        "id": 123,
        "uknfCode": "ENT001",
        "name": "Example Financial Institution",
        "entityType": "Bank",
        "entityStatus": "Active"
      }
    ],
    "totalCount": 150,
    "page": 1,
    "pageSize": 20
  }
  ```

### User Experience

**Access Request Completion Flow:**
1. User navigates to "Complete Access Request" from dashboard or profile
2. Sees their pre-populated information (read-only)
3. Section: "Select Entities and Permissions"
4. Uses entity search autocomplete to find entity
5. Selects entity, it appears in list below
6. For each entity, checks desired permissions:
   - ☐ Reporting Access
   - ☐ Cases Access
   - ☐ Entity Administrator
7. (Optional) Adds entity-specific notification email
8. Section: "Supporting Documents"
9. Uploads attachments (ID card, authorization letter, etc.)
10. Clicks "Save Draft" (can continue later)
11. When ready, clicks "Submit Request"
12. Confirmation dialog: "Submit your access request?"
13. Confirms
14. Success message + email confirmation
15. Request status changes to "New"
16. User sees "Your request is being reviewed"

### Coding Standards

1. **Validation at Multiple Levels:**
   ```csharp
   // ✅ CORRECT - Domain validation
   public void SetPermissions(bool hasReporting, bool hasCases, bool isAdmin)
   {
       if (!hasReporting && !hasCases && !isAdmin)
           throw new InvalidOperationException("At least one permission required");
   }
   
   // ✅ CORRECT - FluentValidation
   RuleFor(x => x.PermissionLines).Must(HaveAtLeastOnePermission);
   ```

2. **File Upload Security:**
   ```csharp
   // ✅ CORRECT - Scan with antivirus
   await _antivirusService.ScanFileAsync(file);
   
   // ✅ CORRECT - Validate file type
   var allowedTypes = new[] { "application/pdf", "image/jpeg", ... };
   if (!allowedTypes.Contains(file.ContentType))
       throw new ValidationException("Invalid file type");
   ```

3. **Status Transition:**
   ```csharp
   // ✅ CORRECT - Use domain method
   accessRequest.Submit(); // Encapsulates status change logic
   ```

### Additional Notes

1. **UKNF Directory Integration:** Entity list comes from external system (Epic 8)
2. **Permission Types:** Reporting, Cases, Entity Administrator (3 types)
3. **Entity Email:** Optional field for entity-specific notifications
4. **Attachments:** Support common document types, max 10MB per file
5. **Draft Saving:** User can save progress without submitting
6. **One Entity Multiple Times:** Not allowed - user selects entity once with all permissions

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

