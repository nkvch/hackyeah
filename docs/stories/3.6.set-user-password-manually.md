# Story 3.6: Set User Password Manually

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.6  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** manually set a user's password,  
**So that** I can help users who are locked out or need immediate access.

---

## Acceptance Criteria

1. System Administrator can select any user and choose "Set Password"
2. Administrator enters new password meeting system policy requirements
3. Password strength indicator is displayed
4. System validates password meets all policy requirements
5. Upon setting password, system can optionally require user to change on next login
6. User receives email notification that password was changed by administrator
7. User's existing sessions are invalidated (force re-login)
8. Action is logged in audit trail with timestamp and administrator ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create SetUserPasswordCommand** (AC: 1, 2, 5)
  - [ ] Create `SetUserPasswordCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserId (Guid, required) - user whose password to set
    - NewPassword (string, required) - new password
    - RequireChangeOnLogin (bool, default true) - force password change on next login
    - Reason (string, optional) - reason for password reset (audit)

- [ ] **Task 2: Create SetUserPasswordCommandValidator** (AC: 2, 4)
  - [ ] Create `SetUserPasswordCommandValidator.cs` using FluentValidation
  - [ ] Validate UserId: NotEmpty
  - [ ] Validate NewPassword: NotEmpty, MinLength(from policy), MaxLength(128)
  - [ ] Inject IPasswordPolicyService to get current policy
  - [ ] Validate password meets policy requirements:
    - Minimum length
    - Uppercase letters (if required)
    - Lowercase letters (if required)
    - Digits (if required)
    - Special characters (if required)
  - [ ] Add custom validation messages

- [ ] **Task 3: Create IPasswordPolicyService** (AC: 4)
  - [ ] Create `IPasswordPolicyService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Methods:
    - `GetCurrentPolicyAsync(): Task<PasswordPolicyDto>`
    - `ValidatePasswordAsync(password): Task<PasswordValidationResult>`
  - [ ] Create `PasswordPolicyDto` with policy settings
  - [ ] Create `PasswordValidationResult` with IsValid, Errors list
  - [ ] Implement `PasswordPolicyService.cs` in `Infrastructure/UknfPlatform.Infrastructure.Identity/Services/`

- [ ] **Task 4: Create SetUserPasswordCommandHandler** (AC: 2, 5, 6, 7, 8)
  - [ ] Create `SetUserPasswordCommandHandler.cs` implementing `IRequestHandler<SetUserPasswordCommand, SetUserPasswordResponse>`
  - [ ] Inject dependencies: IUserRepository, IPasswordHasher, IPasswordPolicyService, IPasswordHistoryService, IEmailService, ISessionService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get user by UserId (404 if not found)
    - Validate password meets policy (already done by validator, but double-check)
    - Check password history (ensure not reusing recent passwords)
    - Hash new password using IPasswordHasher
    - Set user password via domain method `user.SetPassword(passwordHash, requireChange)`
    - Set MustChangePassword flag based on command
    - Save password to history
    - Invalidate all user sessions (force re-login)
    - Save to repository
    - Send password change notification email
    - Create audit log entry
    - Return SetUserPasswordResponse
  - [ ] Use transaction

- [ ] **Task 5: Create IPasswordHistoryService** (AC: 4)
  - [ ] Create `IPasswordHistoryService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Methods:
    - `CheckPasswordHistoryAsync(userId, newPasswordHash): Task<bool>` - returns true if password in history
    - `AddPasswordToHistoryAsync(userId, passwordHash): Task`
    - `CleanupOldPasswordsAsync(userId): Task` - keep only N recent passwords per policy
  - [ ] Create `PasswordHistoryService.cs` implementation
  - [ ] Use PasswordHistory table

- [ ] **Task 6: Update User domain entity** (AC: 2, 5)
  - [ ] Open `User.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add domain method: `SetPassword(passwordHash, requireChangeOnLogin)`
  - [ ] Method sets PasswordHash
  - [ ] Sets MustChangePassword flag
  - [ ] Sets UpdatedDate
  - [ ] Validates password hash is not empty

- [ ] **Task 7: Create or update PasswordHistory entity** (AC: 4)
  - [ ] Create `PasswordHistory.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - UserId (Guid, FK to Users)
    - PasswordHash (string)
    - CreatedDate (DateTime)
  - [ ] Relationship: Many-to-One with User
  - [ ] Index on UserId and CreatedDate

- [ ] **Task 8: Create database migration for PasswordHistory** (AC: 4)
  - [ ] Create EF Core migration if PasswordHistory table doesn't exist
  - [ ] Schema:
    ```sql
    CREATE TABLE PasswordHistory (
        Id UUID PRIMARY KEY,
        UserId UUID NOT NULL,
        PasswordHash NVARCHAR(500) NOT NULL,
        CreatedDate DATETIME2 NOT NULL,
        FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
        INDEX IX_PasswordHistory_UserId (UserId),
        INDEX IX_PasswordHistory_CreatedDate (CreatedDate)
    );
    ```
  - [ ] Update EF Core entity configuration

- [ ] **Task 9: Create SetUserPasswordResponse DTO** (AC: 6, 7, 8)
  - [ ] Create `SetUserPasswordResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - UserId (Guid)
    - Message (string)
    - RequireChangeOnLogin (bool)
    - NotificationSent (bool)
    - SessionsInvalidated (bool)
    - PerformedDate (DateTime)
    - PerformedBy (string)

- [ ] **Task 10: Create REST API endpoint POST /api/admin/users/{id}/set-password** (AC: 1, 2)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create POST action `SetUserPasswordAsync(Guid id, SetUserPasswordCommand command)`
  - [ ] Ensure id parameter matches command.UserId
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with SetUserPasswordResponse
  - [ ] Return 400 Bad Request with validation errors (password policy violations)
  - [ ] Return 404 Not Found if user doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 11: Create password changed notification email template** (AC: 6)
  - [ ] Create `PasswordChangedByAdminNotification.cshtml` in `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/`
  - [ ] Template content:
    - Subject: "Security Alert: Your password has been changed"
    - Message: Password changed by system administrator
    - If RequireChangeOnLogin: "You must change your password on next login"
    - Login URL
    - Contact support if not authorized
    - Timestamp

- [ ] **Task 12: Update IEmailService** (AC: 6)
  - [ ] Update `IEmailService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Add method: `SendPasswordChangedByAdminNotificationAsync(userId, email, userName, requireChangeOnLogin)`
  - [ ] Implement in `EmailService.cs` using template

- [ ] **Task 13: Create audit log entry** (AC: 8)
  - [ ] After password set, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = administrator who set password
    - EntityType = "User"
    - EntityPrimaryKey = target user's ID
    - Action = "SetPassword"
    - Timestamp = DateTime.UtcNow
    - AfterState = JSON with RequireChangeOnLogin flag (DO NOT log password hash)
  - [ ] Include reason if provided

- [ ] **Task 14: Create GET endpoint for password policy** (AC: 3, 4)
  - [ ] Create `PasswordPolicyController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Create GET action `GetPasswordPolicyAsync()`
  - [ ] No authorization required (public) - needed for validation
  - [ ] Return current password policy settings
  - [ ] Used by frontend for password strength indicator

### Frontend Tasks

- [ ] **Task 15: Create password policy service** (AC: 3, 4)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/password-policy.service.ts`
  - [ ] Method: `getPasswordPolicy(): Observable<PasswordPolicy>`
  - [ ] Cache policy (refresh on app load)
  - [ ] Call GET `/api/password-policy`

- [ ] **Task 16: Update users service** (AC: 1)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Add method: `setUserPassword(id, command): Observable<SetUserPasswordResponse>`
  - [ ] Call POST `/api/admin/users/{id}/set-password`

- [ ] **Task 17: Create set password dialog component** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/users/set-password-dialog/set-password-dialog.component.ts`
  - [ ] Standalone Angular component
  - [ ] Use as dialog (PrimeNG DynamicDialog or custom modal)
  - [ ] Input: userId, userName
  - [ ] Form fields:
    - newPassword (password input, required)
    - confirmPassword (password input, required, must match)
    - requireChangeOnLogin (checkbox, default checked)
    - reason (textarea, optional)

- [ ] **Task 18: Implement password strength indicator** (AC: 3)
  - [ ] Use PrimeNG Password component with strength indicator
  - [ ] Or create custom password strength component
  - [ ] Display strength meter (Weak, Fair, Good, Strong)
  - [ ] Color coding: Red (weak), Yellow (fair), Green (strong)
  - [ ] Show policy requirements:
    - Minimum length
    - Uppercase letters
    - Lowercase letters
    - Digits
    - Special characters
  - [ ] Check each requirement and show ✓ or ✗

- [ ] **Task 19: Implement real-time password validation** (AC: 4)
  - [ ] Load password policy on component init
  - [ ] Validate password as user types (debounce 300ms)
  - [ ] Show validation errors:
    - "Password must be at least X characters"
    - "Password must contain uppercase letter"
    - "Password must contain digit"
    - etc.
  - [ ] Disable submit button until all requirements met

- [ ] **Task 20: Implement password confirmation** (AC: 2)
  - [ ] Confirm password must match new password
  - [ ] Show error if passwords don't match
  - [ ] Only validate after user types in confirm field

- [ ] **Task 21: Handle dialog submission** (AC: 5, 6, 7)
  - [ ] On submit, call usersService.setUserPassword()
  - [ ] Show loading spinner during submission
  - [ ] On success (200):
    - Display success message
    - If RequireChangeOnLogin: "Password set. User must change on next login."
    - Else: "Password set successfully."
    - Show info: "User sessions invalidated. User must log in again."
    - Close dialog
  - [ ] On error (400): Display validation errors (password policy violations)
  - [ ] On error (404): Display "User not found"
  - [ ] Use NotificationService for toast messages

- [ ] **Task 22: Add "Set Password" action to user list** (AC: 1)
  - [ ] In user list page (Story 3.1), add "Set Password" action button per user
  - [ ] Or in dropdown menu: More > Set Password
  - [ ] Click opens set password dialog

- [ ] **Task 23: Add "Set Password" button to user details page** (AC: 1)
  - [ ] In edit/view user page, add "Set Password" button
  - [ ] Opens set password dialog
  - [ ] Available for all user statuses except deleted

- [ ] **Task 24: Display password policy requirements** (AC: 3, 4)
  - [ ] In dialog, show password requirements list:
    - "Minimum X characters"
    - "At least one uppercase letter"
    - "At least one lowercase letter"
    - "At least one digit"
    - "At least one special character"
  - [ ] Requirements loaded from password policy API
  - [ ] Update dynamically if policy changes

### Testing Tasks

- [ ] **Task 25: Write unit tests for SetUserPasswordCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidPassword_SetsPasswordSuccessfully`
  - [ ] Test: `Handle_UserNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_PasswordInHistory_ThrowsBusinessRuleViolation`
  - [ ] Test: `Handle_InvalidPassword_ThrowsValidationException`
  - [ ] Test: `Handle_SendsNotificationEmail`
  - [ ] Test: `Handle_InvalidatesUserSessions`
  - [ ] Test: `Handle_CreatesAuditLog`
  - [ ] Test: `Handle_AddsPasswordToHistory`
  - [ ] Test: `Handle_SetsRequireChangeFlag`
  - [ ] Mock: IUserRepository, IPasswordHasher, IPasswordPolicyService, IPasswordHistoryService, IEmailService, ISessionService, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 26: Write unit tests for SetUserPasswordCommandValidator**
  - [ ] Test: Valid password meeting all policy requirements
  - [ ] Test: Password too short
  - [ ] Test: Password missing uppercase
  - [ ] Test: Password missing digit
  - [ ] Test: Password missing special character
  - [ ] Test: Empty password

- [ ] **Task 27: Write unit tests for PasswordPolicyService** (AC: 4)
  - [ ] Test: `ValidatePassword_MeetsAllRequirements_ReturnsValid`
  - [ ] Test: `ValidatePassword_TooShort_ReturnsInvalid`
  - [ ] Test: `ValidatePassword_MissingUppercase_ReturnsInvalid`
  - [ ] Test: `ValidatePassword_MissingDigit_ReturnsInvalid`
  - [ ] Test multiple policy configurations

- [ ] **Task 28: Write unit tests for PasswordHistoryService** (AC: 4)
  - [ ] Test: `CheckPasswordHistory_ReusedPassword_ReturnsTrue`
  - [ ] Test: `CheckPasswordHistory_NewPassword_ReturnsFalse`
  - [ ] Test: `AddPasswordToHistory_StoresPassword`
  - [ ] Test: `CleanupOldPasswords_KeepsOnlyRecentN`

- [ ] **Task 29: Write integration test for set password endpoint**
  - [ ] Test: `POST_SetUserPassword_ValidPassword_Returns200AndSetsPassword`
  - [ ] Test: `POST_SetUserPassword_InvalidPassword_Returns400`
  - [ ] Test: `POST_SetUserPassword_UserNotFound_Returns404`
  - [ ] Test: `POST_SetUserPassword_AsNonAdmin_Returns403`
  - [ ] Test: `POST_SetUserPassword_SendsNotification`
  - [ ] Test: `POST_SetUserPassword_InvalidatesSessions`
  - [ ] Test: `POST_SetUserPassword_AddsToPasswordHistory`
  - [ ] Use Testcontainers for database
  - [ ] Verify password changed in database
  - [ ] Verify audit log created

- [ ] **Task 30: Write E2E test for set password flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Select user
    4. Click "Set Password"
    5. Enter new password meeting policy
    6. Check "Require change on login"
    7. Submit
    8. Verify success message
    9. Verify user must change password on next login
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 3.2 & 3.3:**
- Password hashing infrastructure (IPasswordHasher)
- Password setup token functionality
- Email notification patterns

**From Story 1.3:**
- Initial password creation flow
- Password validation patterns

**Key Integration:**
- This story allows admin to override user password (help desk scenario)
- Different from user self-service password change (Story 1.6)
- Different from password reset via email (Story 1.7)
- Integrates with password policy (Story 3.8)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Password Hashing: BCrypt.Net or Argon2

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Password component with strength meter)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   ├── UsersController.cs (UPDATE - add SetUserPasswordAsync)
│   └── PasswordPolicyController.cs (CREATE)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Commands/
│   │   ├── SetUserPasswordCommand.cs (CREATE)
│   │   ├── SetUserPasswordCommandHandler.cs (CREATE)
│   │   └── SetUserPasswordCommandValidator.cs (CREATE)
│   └── DTOs/
│       └── SetUserPasswordResponse.cs (CREATE)
├── Application/UknfPlatform.Application.Shared/Interfaces/
│   ├── IPasswordPolicyService.cs (CREATE)
│   └── IPasswordHistoryService.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/Entities/
│   ├── User.cs (UPDATE - add SetPassword method)
│   └── PasswordHistory.cs (CREATE or UPDATE)
├── Infrastructure/UknfPlatform.Infrastructure.Identity/Services/
│   ├── PasswordPolicyService.cs (CREATE)
│   └── PasswordHistoryService.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Email/Templates/
    └── PasswordChangedByAdminNotification.cshtml (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   ├── users.service.ts (UPDATE)
│   └── password-policy.service.ts (CREATE)
├── features/admin/users/set-password-dialog/
│   ├── set-password-dialog.component.ts (CREATE)
│   ├── set-password-dialog.component.html (CREATE)
│   └── set-password-dialog.component.scss (CREATE)
└── shared/components/
    └── password-strength/
        ├── password-strength.component.ts (CREATE - optional)
        └── password-strength.component.html (CREATE - optional)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**PasswordHistory Table:**
```sql
CREATE TABLE PasswordHistory (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    PasswordHash NVARCHAR(500) NOT NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    INDEX IX_PasswordHistory_UserId (UserId),
    INDEX IX_PasswordHistory_CreatedDate (CreatedDate)
);
```

**Users Table (MustChangePassword flag):**
```sql
-- Existing field used
MustChangePassword BIT NOT NULL DEFAULT 0,
```

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** POST `/api/admin/users/{id}/set-password`
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "newPassword": "NewSecureP@ssw0rd123",
    "requireChangeOnLogin": true,
    "reason": "User forgot password and requested admin reset"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "Password set successfully",
    "requireChangeOnLogin": true,
    "notificationSent": true,
    "sessionsInvalidated": true,
    "performedDate": "2025-10-04T16:00:00Z",
    "performedBy": "admin@uknf.gov.pl"
  }
  ```
- **Error Responses:**
  - 400: Bad Request (password policy violations)
  - 404: Not Found (user doesn't exist)
  - 403: Forbidden

**Endpoint:** GET `/api/password-policy`
- **Security:** None (public)
- **Success Response (200 OK):**
  ```json
  {
    "minLength": 8,
    "maxLength": 128,
    "requireUppercase": true,
    "requireLowercase": true,
    "requireDigit": true,
    "requireSpecialCharacter": true,
    "passwordHistoryDepth": 5,
    "maxPasswordAge": 90
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Hash passwords before storage**
   ```csharp
   // ✅ CORRECT
   var passwordHash = _passwordHasher.HashPassword(newPassword);
   user.SetPassword(passwordHash, requireChange);
   
   // ❌ WRONG - Never store plain text passwords
   // user.PasswordHash = newPassword;
   ```

2. **Never log passwords**
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation(
       "Password set for user {UserId} by administrator {AdminId}",
       userId, adminId);
   
   // ❌ WRONG
   // _logger.LogInformation("Password set: {Password}", password);
   ```

3. **Check password history**
   ```csharp
   // ✅ CORRECT - Prevent password reuse
   if (await _passwordHistoryService.CheckPasswordHistoryAsync(userId, passwordHash))
       throw new BusinessRuleViolationException("Cannot reuse recent password");
   ```

4. **Invalidate sessions after password change**
   ```csharp
   // ✅ CORRECT - Force re-login for security
   await _sessionService.InvalidateUserSessionsAsync(userId);
   ```

5. **Validate password meets policy**
   ```csharp
   // ✅ CORRECT
   var validationResult = await _passwordPolicyService.ValidatePasswordAsync(password);
   if (!validationResult.IsValid)
       throw new ValidationException(validationResult.Errors);
   ```

### Password Policy

**Default Policy (can be configured in Story 3.8):**
- Minimum length: 8 characters
- Maximum length: 128 characters
- Require uppercase: Yes
- Require lowercase: Yes
- Require digit: Yes
- Require special character: Yes
- Password history depth: 5 (prevent reuse of last 5 passwords)
- Max password age: 90 days (optional)

**Password Validation Algorithm:**
```csharp
public class PasswordPolicyService : IPasswordPolicyService
{
    public async Task<PasswordValidationResult> ValidatePasswordAsync(string password)
    {
        var policy = await GetCurrentPolicyAsync();
        var errors = new List<string>();
        
        if (password.Length < policy.MinLength)
            errors.Add($"Password must be at least {policy.MinLength} characters");
            
        if (policy.RequireUppercase && !password.Any(char.IsUpper))
            errors.Add("Password must contain at least one uppercase letter");
            
        if (policy.RequireLowercase && !password.Any(char.IsLower))
            errors.Add("Password must contain at least one lowercase letter");
            
        if (policy.RequireDigit && !password.Any(char.IsDigit))
            errors.Add("Password must contain at least one digit");
            
        if (policy.RequireSpecialCharacter && !password.Any(ch => !char.IsLetterOrDigit(ch)))
            errors.Add("Password must contain at least one special character");
        
        return new PasswordValidationResult
        {
            IsValid = !errors.Any(),
            Errors = errors
        };
    }
}
```

### Password History

**Purpose:** Prevent users from reusing recent passwords

**Implementation:**
```csharp
public class PasswordHistoryService : IPasswordHistoryService
{
    private readonly ApplicationDbContext _context;
    private readonly IPasswordPolicyService _policyService;
    
    public async Task<bool> CheckPasswordHistoryAsync(Guid userId, string newPasswordHash)
    {
        var policy = await _policyService.GetCurrentPolicyAsync();
        var historyDepth = policy.PasswordHistoryDepth;
        
        var recentPasswords = await _context.PasswordHistory
            .Where(ph => ph.UserId == userId)
            .OrderByDescending(ph => ph.CreatedDate)
            .Take(historyDepth)
            .Select(ph => ph.PasswordHash)
            .ToListAsync();
        
        // Check if new password matches any recent password
        foreach (var oldHash in recentPasswords)
        {
            if (_passwordHasher.VerifyPassword(newPasswordHash, oldHash))
                return true; // Password in history
        }
        
        return false; // Password not in history
    }
    
    public async Task AddPasswordToHistoryAsync(Guid userId, string passwordHash)
    {
        var history = new PasswordHistory
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            PasswordHash = passwordHash,
            CreatedDate = DateTime.UtcNow
        };
        
        _context.PasswordHistory.Add(history);
        await _context.SaveChangesAsync();
        
        // Cleanup old passwords (keep only N most recent)
        await CleanupOldPasswordsAsync(userId);
    }
    
    public async Task CleanupOldPasswordsAsync(Guid userId)
    {
        var policy = await _policyService.GetCurrentPolicyAsync();
        var historyDepth = policy.PasswordHistoryDepth;
        
        var oldPasswords = await _context.PasswordHistory
            .Where(ph => ph.UserId == userId)
            .OrderByDescending(ph => ph.CreatedDate)
            .Skip(historyDepth)
            .ToListAsync();
        
        _context.PasswordHistory.RemoveRange(oldPasswords);
        await _context.SaveChangesAsync();
    }
}
```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 3

1. **Password Hashing:** Use BCrypt (work factor 12) or Argon2
2. **Password History:** Check last N passwords (from policy)
3. **Session Invalidation:** Force re-login after password change
4. **Email Notification:** Inform user of password change (security)
5. **Audit Logging:** Log who changed password and when
6. **Policy Enforcement:** Validate against current password policy
7. **Require Change:** Optionally force user to change on next login

### Email Template

**Password Changed by Admin Notification:**
```html
Subject: Security Alert: Your password has been changed

Dear {{FirstName}} {{LastName}},

Your password for the UKNF Communication Platform has been changed by a system administrator.

Changed By: System Administrator
Date: {{ChangeDate}}

{{#if RequireChangeOnLogin}}
IMPORTANT: You must change your password when you log in next time.
{{/if}}

All your existing sessions have been terminated. You will need to log in again with your new password.

Login URL: {{LoginUrl}}

If you did not request this change or believe this is an error, please contact support immediately:
Email: support@uknf.gov.pl
Phone: +48 22 XXX XX XX

For security reasons, do not share your password with anyone.

Best regards,
UKNF IT Team
```

### Frontend Password Strength Indicator

**Using PrimeNG Password Component:**
```typescript
<p-password 
  [(ngModel)]="newPassword"
  [toggleMask]="true"
  [feedback]="true"
  placeholder="Enter new password">
  
  <ng-template pTemplate="header">
    <h6>Password Requirements</h6>
  </ng-template>
  
  <ng-template pTemplate="footer">
    <ul class="text-sm mt-2">
      <li [class.text-green-500]="hasMinLength" [class.text-red-500]="!hasMinLength">
        <i [class]="hasMinLength ? 'pi pi-check' : 'pi pi-times'"></i>
        Minimum 8 characters
      </li>
      <li [class.text-green-500]="hasUppercase" [class.text-red-500]="!hasUppercase">
        <i [class]="hasUppercase ? 'pi pi-check' : 'pi pi-times'"></i>
        At least one uppercase letter
      </li>
      <li [class.text-green-500]="hasLowercase" [class.text-red-500]="!hasLowercase">
        <i [class]="hasLowercase ? 'pi pi-check' : 'pi pi-times'"></i>
        At least one lowercase letter
      </li>
      <li [class.text-green-500]="hasDigit" [class.text-red-500]="!hasDigit">
        <i [class]="hasDigit ? 'pi pi-check' : 'pi pi-times'"></i>
        At least one digit
      </li>
      <li [class.text-green-500]="hasSpecialChar" [class.text-red-500]="!hasSpecialChar">
        <i [class]="hasSpecialChar ? 'pi pi-check' : 'pi pi-times'"></i>
        At least one special character
      </li>
    </ul>
  </ng-template>
</p-password>
```

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions

**Example:**
```csharp
[Fact]
public async Task Handle_ReusedPassword_ThrowsBusinessRuleViolation()
{
    // Arrange
    var user = UserFactory.CreateUser();
    var newPassword = "SameP@ssw0rd123";
    var passwordHash = "hashed_password";
    
    var command = new SetUserPasswordCommand
    {
        UserId = user.Id,
        NewPassword = newPassword,
        RequireChangeOnLogin = true
    };
    
    _userRepositoryMock
        .Setup(r => r.GetByIdAsync(user.Id))
        .ReturnsAsync(user);
    
    _passwordHasherMock
        .Setup(h => h.HashPassword(newPassword))
        .Returns(passwordHash);
    
    _passwordHistoryServiceMock
        .Setup(s => s.CheckPasswordHistoryAsync(user.Id, passwordHash))
        .ReturnsAsync(true); // Password in history
    
    // Act & Assert
    await _handler
        .Invoking(h => h.Handle(command, CancellationToken.None))
        .Should()
        .ThrowAsync<BusinessRuleViolationException>()
        .WithMessage("*reuse*recent password*");
}
```

### Additional Notes

1. **Admin Reset vs User Self-Service:**
   - This story: Admin sets password for user (help desk scenario)
   - Story 1.6: User changes own password (knows current password)
   - Story 1.7: User resets password via email (forgot password)

2. **RequireChangeOnLogin Flag:** By default, should be true when admin sets password. User should change it on next login for security.

3. **Password History Check:** Important to prevent users from alternating between same few passwords.

4. **Session Invalidation:** Critical for security. If password compromised and admin resets it, attacker should be immediately logged out.

5. **Email Notification:** Important security measure. User should know if someone (even admin) changed their password.

6. **Cannot Set Own Password:** Consider validation to prevent admin from using this feature on their own account (use Story 1.6 instead).

7. **Password Strength Meter:** Visual feedback helps user create strong passwords.

8. **Policy Integration:** This story uses password policy. Story 3.8 will make it configurable.

9. **Temporary Passwords:** If RequireChangeOnLogin is true, the admin-set password is effectively temporary.

10. **Validation on Frontend and Backend:** Frontend validation for UX, backend validation for security. Never trust client-side validation alone.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

