# Story 6.3: View and Search Library (External User)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.3  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As an** External User,  
**I want to** browse and search files in the Library,  
**So that** I can find and download documents I need.

---

## Acceptance Criteria

1. User can access "Library" section in navigation menu
2. User sees only files they have permission to access (based on permissions set in Story 6.2)
3. Library displays files with: Filename, Category, Description (preview), Reporting Period, Model Update Date, Version status (Current/Archival)
4. User can filter by: Category, Reporting Period, Version status
5. User can search by: Filename, Description
6. User can sort by: Filename, Upload date, Model Update Date
7. Files are grouped or marked by category for easy navigation
8. Current versions are prominently displayed; archival versions can be toggled on/off in view
9. User can click file to view details and download
10. Library supports pagination for large file counts
11. Empty state shown if no files accessible to user
12. Loading states displayed while fetching files

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetLibraryFilesQuery** (AC: 2, 3, 4, 5, 6, 8, 10)
  - [ ] Create `GetLibraryFilesQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties:
    - SearchTerm (string?, nullable) - search in filename and description
    - CategoryId (Guid?, nullable) - filter by category
    - ReportingPeriod (string?, nullable) - filter by reporting period
    - VersionStatus (enum?, nullable) - filter by Current/Archival/Both
    - SortBy (enum) - Filename, UploadDate, ModelUpdateDate
    - SortDirection (enum) - Ascending, Descending
    - PageNumber (int, default 1)
    - PageSize (int, default 20, max 100)
  - [ ] Add SortBy enum: Filename, UploadDate, ModelUpdateDate
  - [ ] Add SortDirection enum: Ascending, Descending

- [ ] **Task 2: Create GetLibraryFilesQueryValidator** (AC: 4, 5, 6, 10)
  - [ ] Create `GetLibraryFilesQueryValidator.cs` using FluentValidation
  - [ ] Validate SearchTerm: MaxLength(500) if provided
  - [ ] Validate CategoryId: MustBeValidGuid if provided
  - [ ] Validate ReportingPeriod: MaxLength(100) if provided
  - [ ] Validate VersionStatus: MustBeValidEnum if provided
  - [ ] Validate SortBy: MustBeValidEnum
  - [ ] Validate SortDirection: MustBeValidEnum
  - [ ] Validate PageNumber: GreaterThan(0)
  - [ ] Validate PageSize: Between(1, 100)

- [ ] **Task 3: Create GetLibraryFilesQueryHandler** (AC: 2-12)
  - [ ] Create `GetLibraryFilesQueryHandler.cs` implementing `IRequestHandler<GetLibraryFilesQuery, GetLibraryFilesResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFilePermissionRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Get current user ID and entity IDs
    - Build query with permission filtering:
      - Include files with AllUsers permission
      - Include files with SpecificUser permission matching user
      - Include files with SpecificEntity permission matching user's entities
      - Include files with EntityType permission matching user's entity types
    - Apply search filter (filename and description)
    - Apply category filter
    - Apply reporting period filter
    - Apply version status filter (default: Current only)
    - Exclude deleted files
    - Apply sorting
    - Apply pagination
    - Load related data (Category)
    - Return paginated results with metadata
  - [ ] Optimize query with proper joins and indexes
  - [ ] Log query execution time for monitoring

- [ ] **Task 4: Create GetLibraryFilesResponse DTO** (AC: 3, 10)
  - [ ] Create `GetLibraryFilesResponse.cs` record
  - [ ] Properties:
    - Files (List<LibraryFileDto>)
    - TotalCount (int)
    - PageNumber (int)
    - PageSize (int)
    - TotalPages (int)
    - HasPreviousPage (bool)
    - HasNextPage (bool)

- [ ] **Task 5: Create LibraryFileDto** (AC: 3)
  - [ ] Create `LibraryFileDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Filename (string)
    - Description (string?, nullable)
    - CategoryName (string)
    - CategoryId (Guid)
    - ReportingPeriod (string?, nullable)
    - ModelUpdateDate (DateTime)
    - VersionStatus (string) - "Current" or "Archival"
    - FileSize (long)
    - FileExtension (string)
    - UploadDate (DateTime)
    - DownloadCount (int)
    - CanDownload (bool) - based on virus scan status

- [ ] **Task 6: Create REST API endpoint GET /library/files** (AC: 1-12)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize]` attribute (requires authentication)
  - [ ] Create GET action `GetLibraryFilesAsync([FromQuery] GetLibraryFilesQuery query)`
  - [ ] Inject IMediator to send query
  - [ ] Return 200 OK with GetLibraryFilesResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 401 Unauthorized if not authenticated
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations
  - [ ] Add response headers: X-Total-Count, X-Page-Number, X-Page-Size

- [ ] **Task 7: Create GetCategoriesQuery** (AC: 4, 7)
  - [ ] Create `GetCategoriesQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] No parameters needed (returns all active categories)
  - [ ] Create `GetCategoriesQueryHandler.cs`
  - [ ] Handler logic:
    - Load all active categories
    - Order by SortOrder, then Name
    - Return list of CategoryDto

- [ ] **Task 8: Create CategoryDto** (AC: 7)
  - [ ] Create `CategoryDto.cs` record
  - [ ] Properties: Id (Guid), Name (string), Description (string?, nullable), FileCount (int)

- [ ] **Task 9: Create REST API endpoint GET /library/categories** (AC: 4, 7)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetCategoriesAsync()`
  - [ ] Return 200 OK with list of categories
  - [ ] Include file count for each category (visible to current user)

- [ ] **Task 10: Create GetReportingPeriodsQuery** (AC: 4)
  - [ ] Create `GetReportingPeriodsQuery.cs`
  - [ ] Create QueryHandler to return distinct reporting periods
  - [ ] Filter by files accessible to current user
  - [ ] Order by reporting period (descending)
  - [ ] Return list of strings

- [ ] **Task 11: Create REST API endpoint GET /library/reporting-periods** (AC: 4)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetReportingPeriodsAsync()`
  - [ ] Return 200 OK with list of reporting periods
  - [ ] Only include periods from accessible files

- [ ] **Task 12: Update ILibraryFileRepository** (AC: 2, 3, 4, 5, 6, 10)
  - [ ] Add method: GetLibraryFilesWithPermissionsAsync(query parameters, userId, entityIds)
  - [ ] Implement complex query with permission filtering
  - [ ] Use EF Core Include for related data
  - [ ] Implement efficient pagination
  - [ ] Optimize with proper indexes

### Frontend Tasks

- [ ] **Task 13: Create library list component** (AC: 1, 3, 7, 8, 9, 11, 12)
  - [ ] Create `library-list.component.ts` in `src/app/features/library/`
  - [ ] Display files in table or card layout:
    - Filename (clickable)
    - Category badge
    - Description (truncated with "show more")
    - Reporting Period
    - Model Update Date
    - Version status badge
    - File size (formatted)
    - Download button
  - [ ] Show loading spinner while fetching
  - [ ] Show empty state if no files ("No documents available")
  - [ ] Implement click on file to navigate to details
  - [ ] Show version badge (Current in green, Archival in gray)

- [ ] **Task 14: Create library filters component** (AC: 4, 5, 8)
  - [ ] Create `library-filters.component.ts`
  - [ ] Filter controls:
    - Category dropdown (multi-select or single)
    - Reporting Period dropdown
    - Version status toggle (Current only / Include Archival)
    - Clear all filters button
  - [ ] Emit filter changes to parent component
  - [ ] Show active filter count
  - [ ] Responsive design (collapse on mobile)

- [ ] **Task 15: Create library search component** (AC: 5)
  - [ ] Create `library-search.component.ts`
  - [ ] Search input with icon
  - [ ] Implement debounce (300ms) for search input
  - [ ] Show search icon and clear button
  - [ ] Placeholder: "Search by filename or description"
  - [ ] Emit search term to parent component

- [ ] **Task 16: Create library sort component** (AC: 6)
  - [ ] Create `library-sort.component.ts` or integrate into list
  - [ ] Sort dropdown with options:
    - Filename (A-Z / Z-A)
    - Upload Date (Newest / Oldest)
    - Model Update Date (Newest / Oldest)
  - [ ] Show current sort selection
  - [ ] Emit sort changes to parent component

- [ ] **Task 17: Create pagination component** (AC: 10)
  - [ ] Create `pagination.component.ts` as reusable component (if not exists)
  - [ ] Show page numbers with first/last/previous/next buttons
  - [ ] Show total count and current range ("Showing 1-20 of 150")
  - [ ] Allow page size selection (10, 20, 50, 100)
  - [ ] Emit page changes to parent component
  - [ ] Disable buttons appropriately (first page, last page)

- [ ] **Task 18: Create library service methods** (AC: 1, 2, 3, 4, 5, 6, 10)
  - [ ] Add methods to `library.service.ts`:
    - getLibraryFiles(query: LibraryFilesQuery): Observable<LibraryFilesResponse>
    - getCategories(): Observable<Category[]>
    - getReportingPeriods(): Observable<string[]>
  - [ ] Handle query parameters properly
  - [ ] Cache categories for performance
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 19: Create library routing** (AC: 1)
  - [ ] Add library routes to app routing module
  - [ ] Route: `/library` â†’ LibraryListComponent
  - [ ] Route: `/library/files/:id` â†’ LibraryFileDetailsComponent (Story 6.5)
  - [ ] Add "Library" menu item for all authenticated users
  - [ ] Implement route guards to require authentication

- [ ] **Task 20: Implement library state management** (AC: 4, 5, 6, 10)
  - [ ] Create library state management (NgRx/Akita or service-based)
  - [ ] Store current filters, search, sort, pagination
  - [ ] Persist state in URL query parameters
  - [ ] Restore state on page reload
  - [ ] Manage loading states

- [ ] **Task 21: Create file list item component** (AC: 3, 7, 8, 9)
  - [ ] Create `library-file-item.component.ts` for reusable file display
  - [ ] Show file icon based on extension (XLSX, PDF, DOC, ZIP)
  - [ ] Show category badge with color coding
  - [ ] Show version badge (Current/Archival)
  - [ ] Show formatted file size
  - [ ] Show formatted dates
  - [ ] Add hover effects and click handling

- [ ] **Task 22: Implement responsive design** (AC: 1, 3)
  - [ ] Desktop: Table layout with all columns
  - [ ] Tablet: Card layout with key info
  - [ ] Mobile: Compact card layout
  - [ ] Collapsible filters on mobile
  - [ ] Touch-friendly buttons and links

- [ ] **Task 23: Add file size and date formatting** (AC: 3)
  - [ ] Create pipes for:
    - File size formatting (B, KB, MB)
    - Date formatting (relative: "2 days ago", absolute: "Jan 15, 2025")
  - [ ] Use consistent formatting across app

### Testing Tasks

- [ ] **Task 24: Unit tests for query handler** (AC: 2, 3, 4, 5, 6, 8, 10)
  - [ ] Test files filtered by user permissions
  - [ ] Test search filters filename and description
  - [ ] Test category filter
  - [ ] Test reporting period filter
  - [ ] Test version status filter (Current only vs. Include Archival)
  - [ ] Test sorting (by filename, upload date, model update date)
  - [ ] Test pagination
  - [ ] Test user sees only permitted files
  - [ ] Test deleted files excluded
  - [ ] Test performance with large datasets

- [ ] **Task 25: Unit tests for permission filtering** (AC: 2)
  - [ ] Test AllUsers permission makes file visible to all
  - [ ] Test SpecificEntity permission visibility
  - [ ] Test EntityType permission visibility
  - [ ] Test SpecificUser permission visibility
  - [ ] Test user without permission doesn't see file
  - [ ] Test combining multiple permission types

- [ ] **Task 26: Unit tests for validator** (AC: 4, 5, 6, 10)
  - [ ] Test query parameter validation
  - [ ] Test pagination bounds (page number > 0, page size 1-100)
  - [ ] Test search term max length
  - [ ] Test invalid enum values

- [ ] **Task 27: Integration tests for API endpoint** (AC: 1-12)
  - [ ] Test GET /library/files returns accessible files
  - [ ] Test user sees only permitted files
  - [ ] Test search filter works correctly
  - [ ] Test category filter works correctly
  - [ ] Test version status filter works correctly
  - [ ] Test sorting works correctly
  - [ ] Test pagination works correctly
  - [ ] Test empty result when no files accessible
  - [ ] Test endpoint requires authentication (401 if not logged in)

- [ ] **Task 28: Frontend unit tests** (AC: 1, 3, 4, 5, 6, 9, 10)
  - [ ] Test library list component rendering
  - [ ] Test filters component
  - [ ] Test search component with debounce
  - [ ] Test sort component
  - [ ] Test pagination component
  - [ ] Test file item component
  - [ ] Test service method calls
  - [ ] Test state management

- [ ] **Task 29: E2E tests** (AC: 1-12)
  - [ ] Test complete library browsing flow as external user
  - [ ] Test user sees only permitted files
  - [ ] Test search finds correct files
  - [ ] Test filters reduce results correctly
  - [ ] Test toggling archival versions
  - [ ] Test sorting changes order
  - [ ] Test pagination navigation
  - [ ] Test clicking file opens details
  - [ ] Test empty state when no files accessible

### Documentation Tasks

- [ ] **Task 30: API documentation** (AC: 1, 2, 3, 4, 5, 6, 10)
  - [ ] Document GET /library/files endpoint
  - [ ] Document GET /library/categories endpoint
  - [ ] Document GET /library/reporting-periods endpoint
  - [ ] Include query parameter documentation
  - [ ] Include response examples
  - [ ] Document pagination metadata
  - [ ] Document authentication requirements

- [ ] **Task 31: Developer documentation** (AC: 2, 10)
  - [ ] Document permission filtering logic
  - [ ] Document query optimization techniques
  - [ ] Document pagination implementation
  - [ ] Document caching strategy
  - [ ] Document performance considerations

- [ ] **Task 32: User documentation** (AC: 1, 3, 4, 5, 6, 7, 8)
  - [ ] Create user guide for browsing Library
  - [ ] Document search functionality
  - [ ] Document filters and sorting
  - [ ] Document viewing archival versions
  - [ ] Include screenshots of Library interface
  - [ ] Explain permission-based visibility

---

## Technical Notes

### Permission Filtering Logic

Query must filter files where user has access via ANY of:
- File has AllUsers permission
- File has SpecificUser permission for current user
- File has SpecificEntity permission for any of user's entities
- File has EntityType permission matching any of user's entity types
- File has ContactGroup permission for any group user belongs to (future)

SQL example:
```sql
SELECT DISTINCT f.* FROM LibraryFiles f
LEFT JOIN FilePermissions p ON f.Id = p.FileId
WHERE f.IsDeleted = false
  AND f.VirusScanStatus = 'Clean'
  AND (
    p.PermissionType = 'AllUsers'
    OR (p.PermissionType = 'SpecificUser' AND p.UserId = @userId)
    OR (p.PermissionType = 'SpecificEntity' AND p.EntityId IN @entityIds)
    OR (p.PermissionType = 'EntityType' AND p.EntityType IN @entityTypes)
  )
  AND (f.VersionStatus = 'Current' OR @includeArchival = true)
```

### Version Status Filtering

Default behavior: Show only Current versions
- Users typically want latest versions
- Toggle to include Archival versions
- Clearly mark which is current vs. archival

### Search Implementation

Search across:
- Filename (full-text or LIKE)
- Description (full-text or LIKE)

Consider:
- Case-insensitive search
- Partial matching
- Full-text search for better performance (if supported)
- Highlighting search terms in results (frontend)

### Sorting Options

- **Filename**: Alphabetical (A-Z, Z-A)
- **Upload Date**: Chronological (Newest first, Oldest first)
- **Model Update Date**: Chronological (Newest first, Oldest first)

Default: Model Update Date (Newest first) - users want latest documents

### Pagination

- Default page size: 20 files
- Page size options: 10, 20, 50, 100
- Max page size: 100 (prevent performance issues)
- Include pagination metadata in response
- Use offset/limit or cursor-based pagination

### Performance Optimizations

- Index LibraryFile table on:
  - CategoryId, VersionStatus, IsDeleted, ModelUpdateDate
  - Filename, Description (for search)
- Index FilePermission table on:
  - FileId, PermissionType, EntityId, UserId
- Cache categories and reporting periods (change infrequently)
- Consider materialized view for complex permission queries
- Implement query result caching for common filters
- Lazy load file content (don't load actual file data in list)

### Security Considerations

- Never expose files user doesn't have permission for
- Validate permission filtering in backend (don't trust frontend)
- Prevent information disclosure through error messages
- Exclude deleted files from all queries
- Don't show files with VirusScanStatus = Infected or Pending
- Log access patterns for audit

### UI/UX Considerations

- Make search prominent (top of page)
- Show active filters clearly with remove buttons
- Provide "Clear all filters" option
- Show file count in category filters
- Use icons for file types (visual recognition)
- Use color-coded badges for categories
- Highlight Current vs. Archival versions
- Show empty state with helpful message
- Provide skeleton loaders for better perceived performance
- Persist filters in URL for shareable links

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files must exist)
- **Story 6.2**: Set File Access Permissions (permissions must be set)
- **Epic 1**: Authentication (user must be authenticated)
- **Epic 2**: Authorization (to identify user's entities)

### Integrates With
- **Story 6.4**: Download File from Library (download button in list)
- **Story 6.5**: View File Details (click file to view details)
- **Story 6.10**: Access Archival File Versions (toggle archival versions)

---

## Acceptance Checklist

- [ ] External user can access Library section
- [ ] User sees only files they have permission to access
- [ ] Files display all required information (filename, category, description, dates, version)
- [ ] User can filter by category, reporting period, version status
- [ ] User can search by filename and description
- [ ] User can sort by filename, upload date, model update date
- [ ] Files are organized by category
- [ ] Current versions are prominently displayed
- [ ] Archival versions can be toggled on/off
- [ ] User can click file to view details
- [ ] Pagination works correctly
- [ ] Empty state displayed when no files accessible
- [ ] Loading states displayed appropriately
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Permission filtering works correctly
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (creates files to browse)
- **Story 6.2**: Set File Access Permissions (controls file visibility)
- **Story 6.4**: Download File from Library (download from list)
- **Story 6.5**: View File Details (details page)
- **Story 6.10**: Access Archival File Versions (archival toggle)
- **Story 6.13**: Notify Users of New/Updated Files (notification integration)

---

## Notes

- Library browsing is core functionality for external users
- Permission filtering must be robust and performant
- Search and filters help users find files quickly
- Default view (Current versions only) keeps interface clean
- Archival versions available when needed for reference
- Consider adding "Recently Added" or "Featured" section
- Consider adding "My Downloads" section showing user's download history
- File list should be responsive and work well on mobile
- Consider infinite scroll as alternative to pagination (UX decision)
- URL should reflect current filters/search for sharing
- Consider breadcrumbs if adding subcategories in future
- Monitor query performance with realistic data volumes
- Test with users having access to 0, 10, 100, 1000+ files

