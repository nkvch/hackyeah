# Story 6.2: Set File Access Permissions (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.2  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** control which users can access each Library file,  
**So that** I can ensure appropriate distribution.

---

## Acceptance Criteria

1. UKNF Employee can select file and access "Manage Permissions"
2. Employee can set access level:
   - **All users**: All external users can view and download
   - **Individual entities**: Select specific entities from list
   - **Entity types/groups**: Select by entity type (e.g., "Loan institutions")
   - **Specific users**: Select individual external users
   - **Contact groups**: Select contact groups (integration with Epic 7 - future)
3. Employee can combine multiple access rules (e.g., all entities of type X + specific entities Y, Z)
4. Changes take effect immediately
5. Affected users can immediately see file in their Library view
6. Previously accessible users who lose access can no longer see or download file
7. System logs permission changes with timestamp and employee ID
8. UI clearly displays current permission settings for each file
9. Employee can remove permissions individually or clear all
10. System validates that at least one permission rule exists or file remains private

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create SetFilePermissionsCommand** (AC: 2, 3)
  - [ ] Create `SetFilePermissionsCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileId (Guid, required)
    - Permissions (List<FilePermissionDto>, required)
  - [ ] FilePermissionDto properties:
    - PermissionType (enum) - AllUsers, SpecificEntity, EntityType, SpecificUser, ContactGroup
    - EntityId (long?, nullable)
    - EntityType (string?, nullable)
    - UserId (Guid?, nullable)
    - ContactGroupId (Guid?, nullable)

- [ ] **Task 2: Create SetFilePermissionsCommandValidator** (AC: 1, 2, 3)
  - [ ] Create `SetFilePermissionsCommandValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate Permissions: NotNull (can be empty list)
  - [ ] Validate each permission:
    - PermissionType must be valid enum value
    - If PermissionType is SpecificEntity, EntityId must be provided
    - If PermissionType is EntityType, EntityType must be provided
    - If PermissionType is SpecificUser, UserId must be provided
    - If PermissionType is ContactGroup, ContactGroupId must be provided
    - AllUsers doesn't require additional fields
  - [ ] Add async validation: FileId must exist
  - [ ] Add async validation: User must have UKNF Employee role
  - [ ] Add async validation: Referenced entities/users must exist

- [ ] **Task 3: Create SetFilePermissionsCommandHandler** (AC: 1-9)
  - [ ] Create `SetFilePermissionsCommandHandler.cs` implementing `IRequestHandler<SetFilePermissionsCommand, SetFilePermissionsResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFilePermissionRepository, IFileChangeHistoryRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Validate file exists
    - Load existing permissions for file
    - Begin transaction
    - Delete all existing permissions for file
    - Create new permissions from command
    - Save new permissions
    - Log each permission change in FileChangeHistory (Action = PermissionChange)
    - Commit transaction
    - Return SetFilePermissionsResponse
  - [ ] Handle errors: file not found, database errors
  - [ ] Log permission changes with details (added/removed)

- [ ] **Task 4: Create SetFilePermissionsResponse DTO** (AC: 4, 8)
  - [ ] Create `SetFilePermissionsResponse.cs` record
  - [ ] Properties: FileId (Guid), PermissionsCount (int), Message (string), Permissions (List<FilePermissionDto>)

- [ ] **Task 5: Create REST API endpoint PUT /library/files/{fileId}/permissions** (AC: 1, 7)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create PUT action `SetFilePermissionsAsync(Guid fileId, [FromBody] SetFilePermissionsRequest request)`
  - [ ] Inject IMediator to send command
  - [ ] Return 200 OK with SetFilePermissionsResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 6: Create GetFilePermissionsQuery** (AC: 8)
  - [ ] Create `GetFilePermissionsQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties: FileId (Guid, required)
  - [ ] Create `GetFilePermissionsQueryHandler.cs`
  - [ ] Handler logic:
    - Load file permissions from repository
    - Include entity/user details for display
    - Return list of FilePermissionDto with details

- [ ] **Task 7: Create REST API endpoint GET /library/files/{fileId}/permissions** (AC: 8)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetFilePermissionsAsync(Guid fileId)`
  - [ ] Return 200 OK with list of permissions
  - [ ] Return 404 Not Found if file doesn't exist

- [ ] **Task 8: Update IFilePermissionRepository** (AC: 3, 4, 6)
  - [ ] Add methods to interface:
    - GetByFileIdAsync(Guid fileId)
    - DeleteAllByFileIdAsync(Guid fileId)
    - AddRangeAsync(List<FilePermission> permissions)
    - CheckUserHasAccessAsync(Guid fileId, Guid userId, long? entityId)
  - [ ] Implement methods in repository
  - [ ] CheckUserHasAccessAsync logic:
    - Check if file has AllUsers permission
    - Check if user has SpecificUser permission
    - Check if user's entity has SpecificEntity permission
    - Check if user's entity type has EntityType permission
    - Check if user is in ContactGroup with permission
    - Return true if any condition matches

- [ ] **Task 9: Create GetEntitiesQuery for permission selection** (AC: 2)
  - [ ] Create `GetEntitiesQuery.cs` to fetch supervised entities
  - [ ] Query properties: SearchTerm (string?, nullable), EntityType (string?, nullable), PageSize (int), PageNumber (int)
  - [ ] Create QueryHandler to return paginated entities
  - [ ] Return EntityDto with: Id, Name, Type, RegistrationNumber

- [ ] **Task 10: Create REST API endpoint GET /entities** (AC: 2)
  - [ ] Create EntitiesController or use existing
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetEntitiesAsync([FromQuery] GetEntitiesQuery query)`
  - [ ] Return paginated list of entities
  - [ ] Support filtering by entity type
  - [ ] Support search by name

- [ ] **Task 11: Create GetUsersQuery for permission selection** (AC: 2)
  - [ ] Create `GetUsersQuery.cs` to fetch external users
  - [ ] Query properties: SearchTerm (string?, nullable), EntityId (long?, nullable), PageSize (int), PageNumber (int)
  - [ ] Create QueryHandler to return paginated users
  - [ ] Return UserDto with: Id, FullName, Email, EntityNames

- [ ] **Task 12: Create REST API endpoint GET /users** (AC: 2)
  - [ ] Add method to UsersController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetUsersAsync([FromQuery] GetUsersQuery query)`
  - [ ] Return paginated list of users
  - [ ] Support filtering by entity
  - [ ] Support search by name or email

### Frontend Tasks

- [ ] **Task 13: Create file permissions component** (AC: 1, 2, 3, 8, 9)
  - [ ] Create `library-file-permissions.component.ts` in `src/app/features/library/`
  - [ ] Create form with permission management UI:
    - Radio buttons or tabs for permission type selection
    - "All Users" option (simple toggle)
    - "Specific Entities" option with multi-select dropdown
    - "Entity Types" option with entity type checkboxes
    - "Specific Users" option with multi-select dropdown
    - "Contact Groups" option (disabled/future)
  - [ ] Display current permissions as list with remove buttons
  - [ ] Show "Add Permission" button to add new rules
  - [ ] Allow combining multiple permission rules
  - [ ] Show preview of affected users/entities count
  - [ ] Implement save and cancel buttons

- [ ] **Task 14: Create permission display component** (AC: 8)
  - [ ] Create `file-permission-badge.component.ts` for displaying permissions
  - [ ] Show permission type icon and label
  - [ ] Show entity/user names for specific permissions
  - [ ] Show "Public" badge for AllUsers
  - [ ] Show "Private" badge if no permissions
  - [ ] Create compact view for list display
  - [ ] Create detailed view for file details page

- [ ] **Task 15: Create entity selector component** (AC: 2, 3)
  - [ ] Create `entity-selector.component.ts` as reusable component
  - [ ] Implement multi-select dropdown with search
  - [ ] Load entities from API with pagination
  - [ ] Show entity name, type, registration number
  - [ ] Support entity type filtering
  - [ ] Display selected entities with remove option

- [ ] **Task 16: Create user selector component** (AC: 2, 3)
  - [ ] Create `user-selector.component.ts` as reusable component
  - [ ] Implement multi-select dropdown with search
  - [ ] Load users from API with pagination
  - [ ] Show user name, email, entity
  - [ ] Support entity filtering
  - [ ] Display selected users with remove option

- [ ] **Task 17: Update library service** (AC: 1, 4, 7, 8)
  - [ ] Add methods to `library.service.ts`:
    - setFilePermissions(fileId: string, permissions: FilePermission[]): Observable<SetFilePermissionsResponse>
    - getFilePermissions(fileId: string): Observable<FilePermission[]>
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 18: Create entity and user services** (AC: 2)
  - [ ] Create `entity.service.ts` in `src/app/core/services/`
  - [ ] Implement getEntities(query: EntityQuery): Observable<EntityPage>
  - [ ] Create `user.service.ts` (or update existing)
  - [ ] Implement getUsers(query: UserQuery): Observable<UserPage>

- [ ] **Task 19: Update library file list** (AC: 1, 8)
  - [ ] Add "Manage Permissions" button/icon to each file row
  - [ ] Show permission summary badge on each file
  - [ ] Open permissions modal/page on button click
  - [ ] Update permission badge after changes

- [ ] **Task 20: Create permission change confirmation** (AC: 4, 5, 6)
  - [ ] Show confirmation dialog if removing permissions
  - [ ] Warn if changing from public to restricted
  - [ ] Display affected users count in confirmation
  - [ ] Show success notification after permission change
  - [ ] Refresh file list to show updated permissions

### Testing Tasks

- [ ] **Task 21: Unit tests for command handler** (AC: 3, 4, 6, 7)
  - [ ] Test setting permissions for file
  - [ ] Test combining multiple permission rules
  - [ ] Test replacing existing permissions
  - [ ] Test removing all permissions (file becomes private)
  - [ ] Test permission change logging
  - [ ] Test transaction rollback on error

- [ ] **Task 22: Unit tests for CheckUserHasAccessAsync** (AC: 5, 6)
  - [ ] Test AllUsers permission grants access to all
  - [ ] Test SpecificEntity permission grants access to entity users
  - [ ] Test EntityType permission grants access to type users
  - [ ] Test SpecificUser permission grants access to user
  - [ ] Test user without permission is denied access
  - [ ] Test combining multiple permission rules

- [ ] **Task 23: Unit tests for validator** (AC: 2, 3)
  - [ ] Test FileId validation
  - [ ] Test permission type validation
  - [ ] Test required fields for each permission type
  - [ ] Test invalid enum values
  - [ ] Test empty permissions list

- [ ] **Task 24: Integration tests for API endpoints** (AC: 1, 4, 7, 8)
  - [ ] Test PUT /library/files/{id}/permissions with valid data returns 200
  - [ ] Test GET /library/files/{id}/permissions returns permissions
  - [ ] Test permissions require UKNF Employee role (403 if not)
  - [ ] Test setting permissions for non-existent file returns 404
  - [ ] Test invalid permission data returns 400

- [ ] **Task 25: Integration tests for access control** (AC: 5, 6)
  - [ ] Test file visible to external user after permission granted
  - [ ] Test file hidden from external user after permission removed
  - [ ] Test file download requires permission
  - [ ] Test AllUsers makes file visible to all external users
  - [ ] Test SpecificEntity makes file visible only to entity users
  - [ ] Test combining permission rules

- [ ] **Task 26: Frontend unit tests** (AC: 1, 2, 3, 8, 9)
  - [ ] Test permissions component rendering
  - [ ] Test adding new permission rule
  - [ ] Test removing permission rule
  - [ ] Test combining multiple rules
  - [ ] Test entity selector
  - [ ] Test user selector
  - [ ] Test service method calls

- [ ] **Task 27: E2E tests** (AC: 1-9)
  - [ ] Test complete permission setting flow as UKNF Employee
  - [ ] Test file appears to external user after permission granted
  - [ ] Test file disappears from external user after permission removed
  - [ ] Test setting AllUsers permission
  - [ ] Test setting entity-specific permissions
  - [ ] Test combining permission rules

### Documentation Tasks

- [ ] **Task 28: API documentation** (AC: 1, 7, 8)
  - [ ] Document PUT /library/files/{id}/permissions endpoint
  - [ ] Document GET /library/files/{id}/permissions endpoint
  - [ ] Document GET /entities endpoint
  - [ ] Document GET /users endpoint
  - [ ] Include request/response examples
  - [ ] Document permission types and rules
  - [ ] Document authentication requirements

- [ ] **Task 29: Developer documentation** (AC: 3, 5, 6)
  - [ ] Document permission model and types
  - [ ] Document access control logic (CheckUserHasAccessAsync)
  - [ ] Document combining multiple permission rules
  - [ ] Document permission inheritance (for versioning)
  - [ ] Document performance considerations (caching, indexing)

- [ ] **Task 30: User documentation** (AC: 1, 2, 3)
  - [ ] Create user guide for setting file permissions
  - [ ] Document permission types and their effects
  - [ ] Document combining permission rules
  - [ ] Explain public vs. private files
  - [ ] Include screenshots of permission UI

---

## Technical Notes

### Permission Types

**AllUsers**
- Simplest option - all external users can access
- No additional configuration needed
- Useful for general templates and instructions

**SpecificEntity**
- Target specific supervised entities
- All users associated with selected entities can access
- Useful for entity-specific reports or instructions

**EntityType**
- Target all entities of a specific type (e.g., "Loan institutions", "Insurance companies")
- All users of entities with matching type can access
- Useful for type-specific templates

**SpecificUser**
- Target individual external users
- Most restrictive option
- Useful for confidential or personalized documents

**ContactGroup** (Future - Epic 7)
- Target predefined contact groups
- Useful for recurring distributions

### Combining Permission Rules

Permissions are additive (OR logic):
- If ANY permission rule grants access, user can access file
- Example: File with "All Loan Institutions" + "Specific Entity XYZ" allows:
  - All users from loan institutions
  - Plus all users from entity XYZ (even if not a loan institution)

### Access Control Logic

When user requests file access:
1. Check if file has AllUsers permission â†’ grant access
2. Check if user ID matches any SpecificUser permission â†’ grant access
3. Check if user's entity ID matches any SpecificEntity permission â†’ grant access
4. Check if user's entity type matches any EntityType permission â†’ grant access
5. Check if user is in any ContactGroup with permission â†’ grant access
6. Otherwise â†’ deny access

### Performance Considerations

- Index FilePermission table on FileId, PermissionType, EntityId, UserId
- Cache permission checks for frequently accessed files
- Optimize CheckUserHasAccessAsync query with proper joins
- Consider materializing user permissions for very large datasets

### Security Considerations

- Only UKNF Employees can set permissions
- Validate that referenced entities/users exist
- Log all permission changes for audit
- Prevent permission escalation attacks
- Rate limit permission change operations

### UI/UX Considerations

- Make it easy to set "All Users" for common files
- Provide entity/user search and filtering
- Show preview of who will have access
- Warn when removing permissions (users will lose access)
- Show permission summary on file list for quick overview

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files must exist to set permissions)
- **Epic 2**: Authorization (to identify entities and entity types)
- Entity and User data available in system

### Integrates With
- **Story 6.3**: View and Search Library (permissions control visibility)
- **Story 6.4**: Download File (permissions control download access)
- **Story 6.7**: Replace File (permissions can be inherited)
- **Epic 7**: Contact Groups (ContactGroup permission type - future)

---

## Acceptance Checklist

- [ ] UKNF Employee can access permission management for files
- [ ] Employee can set AllUsers permission
- [ ] Employee can set SpecificEntity permissions
- [ ] Employee can set EntityType permissions
- [ ] Employee can set SpecificUser permissions
- [ ] Employee can combine multiple permission rules
- [ ] Changes take effect immediately
- [ ] External users see files based on permissions
- [ ] External users cannot access files without permission
- [ ] System logs all permission changes
- [ ] UI clearly shows current permissions
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Access control logic works correctly
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (prerequisite)
- **Story 6.3**: View and Search Library (permissions filter visibility)
- **Story 6.4**: Download File from Library (permissions control access)
- **Story 6.6**: Update File Metadata (separate from permissions)
- **Story 6.7**: Replace File (permissions inheritance)
- **Story 6.13**: Notify Users of New/Updated Files (send to permitted users)
- **Story 6.14**: Bulk Operations (bulk permission changes)

---

## Notes

- Permission system is critical for security and compliance
- Start with simple model (AllUsers, SpecificEntity) and expand
- Consider caching permissions for performance with large user base
- UI should make common cases (AllUsers) very easy
- Complex cases (combining rules) should be powerful but clear
- Permission changes should be logged comprehensively for audit
- Consider notification when users gain/lose access to files
- Future: Contact Groups will make permission management more efficient
- Test access control thoroughly - security vulnerability if wrong
- Consider read-only view of permissions for external users (they can see why they have access)

