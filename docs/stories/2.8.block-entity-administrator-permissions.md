# Story 2.8: Block Entity Administrator Permissions

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.8  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As a** UKNF Employee,  
**I want to** block an Entity Administrator's permissions,  
**So that** they lose system access while maintaining system integrity.

---

## Acceptance Criteria

1. UKNF Employee can select "Block" action for Entity Administrator
2. System changes all permission lines for that administrator to "Blocked" status
3. Administrator immediately loses system access (cannot log in)
4. Other administrators for the same entity retain their access
5. Entity Employees previously approved by blocked administrator retain their permissions
6. If no other administrators exist, UKNF takes over approval for that entity's employee requests
7. System logs blocking action with timestamp and employee ID
8. Blocked administrator receives email notification

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create BlockEntityAdministratorCommand** (AC: 1, 2, 3, 7, 8)
  - [ ] Create `BlockEntityAdministratorCommand.cs`
  - [ ] Properties: UserId (administrator to block), Reason
  - [ ] Create handler
  - [ ] Logic:
    - Get all permission lines for user where IsEntityAdministrator = true
    - Set IsBlocked = true for all
    - Update AccessRequest status to "Blocked"
    - Log blocking action
    - Send email notification
    - Return success

- [ ] **Task 2: Update PermissionLine entity** (AC: 2)
  - [ ] Add `Block()` domain method
  - [ ] Sets IsBlocked = true

- [ ] **Task 3: Update authentication to check IsBlocked** (AC: 3)
  - [ ] During login (Story 1.4), check if user has any active permissions
  - [ ] If all permissions blocked â†’ deny login
  - [ ] Return error: "Your account has been blocked"

- [ ] **Task 4: Implement cascade rules** (AC: 4, 5, 6)
  - [ ] Blocking administrator does NOT block employee permissions
  - [ ] Employees keep their permissions (previously approved)
  - [ ] If no other admin exists for entity:
    - UKNF Employees handle future employee requests
    - Query checks for active Entity Administrators

- [ ] **Task 5: Create REST API endpoint** (AC: 1)
  - [ ] POST `/api/users/{userId}/block-administrator`
  - [ ] `[Authorize(Roles = "UknfEmployee")]`
  - [ ] Send command

- [ ] **Task 6: Create blocking notification email** (AC: 8)
  - [ ] Create `AdministratorBlockedEmail.cshtml`
  - [ ] Content: "Your Entity Administrator permissions have been blocked", Reason, Support contact

### Frontend Tasks

- [ ] **Task 7: Add block action to user management** (AC: 1)
  - [ ] In user/permission management page (Epic 3)
  - [ ] "Block Administrator" button
  - [ ] Confirmation dialog with reason input
  - [ ] Shows warning about immediate access loss

- [ ] **Task 8: Display blocked status** (AC: 2)
  - [ ] Show "Blocked" badge on user profile
  - [ ] Red warning indicator
  - [ ] Show blocking reason and date

### Testing Tasks

- [ ] **Task 9: Write tests**
  - [ ] Test: `BlockAdministrator_SetsAllPermissionsBlocked`
  - [ ] Test: `BlockAdministrator_PreventsLogin`
  - [ ] Test: `BlockAdministrator_EmployeePermissionsUnaffected`
  - [ ] Test: `BlockAdministrator_SendsNotification`
  - [ ] Test: `BlockAdministrator_LogsAction`

---

## Dev Notes

**Critical Business Rule:** Blocking an Entity Administrator does NOT affect Entity Employees they previously approved. This maintains system stability and prevents cascading access loss.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

