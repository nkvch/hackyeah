# Story 7.13: Add and Manage Contacts (Non-System Users)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.13  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** add contacts who are not system users,  
**So that** I can send email notifications to them via contact groups.

---

## Acceptance Criteria

1. Employee can create new Contact with:
   - **First Name** (text, required)
   - **Last Name** (text, required)
   - **Email Address** (email, required, validated)
   - **Phone Number** (text, optional, validated)
   - **Organization/Entity** (text or dropdown, optional)
   - **Role/Title** (text, optional)
   - **Notes** (text area, optional)
2. Email address must be unique among contacts
3. Contacts do NOT have system user accounts (cannot log in)
4. Contacts can receive email notifications when part of Contact Groups used in announcements or communications
5. Employee can edit contact information
6. Employee can delete contacts (only if not member of any active Contact Group)
7. Employee can view list of all contacts
8. Employee can search/filter contacts by name, email, organization
9. System logs all contact operations with timestamps

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Contact domain entity** (AC: 1, 2, 9)
  - [ ] Create `Contact.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - FirstName (string, required, max 100)
    - LastName (string, required, max 100)
    - Email (string, required, max 256, unique)
    - PhoneNumber (string?, nullable, max 20)
    - Organization (string?, nullable, max 500)
    - RoleTitle (string?, nullable, max 250)
    - Notes (string?, nullable, max 2000)
    - CreatedBy (Guid, required) - UKNF Employee user ID
    - CreatedDate (DateTime, required)
    - UpdatedDate (DateTime, required)
  - [ ] Add domain methods: UpdateInfo()
  - [ ] Add domain validation rules

- [ ] **Task 2: Create database migration** (AC: 1, 2)
  - [ ] Create EF Core migration: `Add_Contacts_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE Contacts (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        FirstName NVARCHAR(100) NOT NULL,
        LastName NVARCHAR(100) NOT NULL,
        Email NVARCHAR(256) NOT NULL UNIQUE,
        PhoneNumber NVARCHAR(20) NULL,
        Organization NVARCHAR(500) NULL,
        RoleTitle NVARCHAR(250) NULL,
        Notes NVARCHAR(2000) NULL,
        CreatedBy UUID NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        
        FOREIGN KEY (CreatedBy) REFERENCES Users(Id),
        INDEX IX_Contacts_Email (Email),
        INDEX IX_Contacts_Organization (Organization)
    );
    ```

- [ ] **Task 3: Create CreateContactCommand** (AC: 1, 2, 9)
  - [ ] Create `CreateContactCommand.cs` in `Application/UknfPlatform.Application.Communication/Contacts/Commands/`
  - [ ] Command properties:
    - FirstName (string, required)
    - LastName (string, required)
    - Email (string, required)
    - PhoneNumber (string?, nullable)
    - Organization (string?, nullable)
    - RoleTitle (string?, nullable)
    - Notes (string?, nullable)

- [ ] **Task 4: Create CreateContactCommandValidator** (AC: 1, 2)
  - [ ] Create `CreateContactCommandValidator.cs` using FluentValidation
  - [ ] Validate FirstName: NotEmpty, MaxLength(100)
  - [ ] Validate LastName: NotEmpty, MaxLength(100)
  - [ ] Validate Email: NotEmpty, EmailAddress format, MaxLength(256)
  - [ ] Validate PhoneNumber: if provided, Matches regex `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate Organization: if provided, MaxLength(500)
  - [ ] Validate RoleTitle: if provided, MaxLength(250)
  - [ ] Validate Notes: if provided, MaxLength(2000)
  - [ ] Async validation: Email is unique among contacts

- [ ] **Task 5: Create CreateContactCommandHandler** (AC: 1, 2, 9)
  - [ ] Create `CreateContactCommandHandler.cs`
  - [ ] Inject dependencies: IContactRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Check user has "contacts.create" permission
    - Validate Email is unique
    - Create Contact entity
    - Set CreatedBy = current user ID
    - Set CreatedDate = DateTime.UtcNow
    - Save to repository
    - Log creation
    - Return ContactDto

- [ ] **Task 6: Create UpdateContactCommand** (AC: 5, 9)
  - [ ] Create `UpdateContactCommand.cs`
  - [ ] Command properties (all optional except ContactId):
    - ContactId (Guid, required)
    - FirstName (string?, nullable)
    - LastName (string?, nullable)
    - Email (string?, nullable)
    - PhoneNumber (string?, nullable)
    - Organization (string?, nullable)
    - RoleTitle (string?, nullable)
    - Notes (string?, nullable)

- [ ] **Task 7: Create UpdateContactCommandHandler** (AC: 5, 9)
  - [ ] Handler logic:
    - Load contact
    - Check user has "contacts.edit" permission
    - Update provided fields
    - If Email changed, validate unique
    - Set UpdatedDate = DateTime.UtcNow
    - Save contact
    - Log update
    - Return ContactDto

- [ ] **Task 8: Create DeleteContactCommand** (AC: 6, 9)
  - [ ] Create `DeleteContactCommand.cs`
  - [ ] Command properties:
    - ContactId (Guid, required)

- [ ] **Task 9: Create DeleteContactCommandHandler** (AC: 6, 9)
  - [ ] Handler logic:
    - Load contact
    - Check user has "contacts.delete" permission
    - Check if contact is member of any ContactGroups
    - If member, throw exception: "Cannot delete contact that is member of contact groups"
    - Delete contact
    - Log deletion
    - Return success

- [ ] **Task 10: Create GetContactsQuery** (AC: 7, 8)
  - [ ] Create `GetContactsQuery.cs`
  - [ ] Query properties:
    - SearchText (string?, nullable) - searches name, email, organization
    - Organization (string?, nullable)
    - PageNumber (int, default 1)
    - PageSize (int, default 20)

- [ ] **Task 11: Create GetContactsQueryHandler** (AC: 7, 8)
  - [ ] Handler logic:
    - Query Contacts
    - Apply filters: SearchText (name, email, organization), Organization
    - Order by LastName, FirstName
    - Paginate results
    - Return ContactListDto

- [ ] **Task 12: Create ContactDto** (AC: 7)
  - [ ] Properties:
    - Id (Guid)
    - FirstName (string)
    - LastName (string)
    - FullName (string) - computed: FirstName + LastName
    - Email (string)
    - PhoneNumber (string?)
    - Organization (string?)
    - RoleTitle (string?)
    - Notes (string?)
    - GroupMembershipCount (int) - how many groups contact is in
    - CreatedDate (DateTime)

- [ ] **Task 13: Create REST API endpoints** (AC: All)
  - [ ] Create `ContactsController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] POST `/api/contacts` - CreateContact (AC: 1)
  - [ ] GET `/api/contacts` - GetContacts (AC: 7, 8)
  - [ ] GET `/api/contacts/{id}` - GetContactDetail
  - [ ] PUT `/api/contacts/{id}` - UpdateContact (AC: 5)
  - [ ] DELETE `/api/contacts/{id}` - DeleteContact (AC: 6)
  - [ ] All require UKNF Employee authentication and permissions

### Frontend Tasks

- [ ] **Task 14: Create contacts service** (AC: 1)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/contacts.service.ts`
  - [ ] Methods:
    - `getContacts(search?, organization?, page?, pageSize?): Observable<PaginatedList<ContactDto>>`
    - `getContactDetail(id): Observable<ContactDto>`
    - `createContact(command): Observable<ContactDto>`
    - `updateContact(id, command): Observable<ContactDto>`
    - `deleteContact(id): Observable<void>`

- [ ] **Task 15: Create contacts list component** (AC: 7, 8)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/contacts/contacts-list/contacts-list.component.ts`
  - [ ] Configure routing: `/contacts` with auth + permission guard
  - [ ] Load contacts via contactsService.getContacts()
  - [ ] Display table/cards with: Name, Email, Phone, Organization, Role/Title
  - [ ] Implement search (by name, email, organization)
  - [ ] Implement filter (by organization)
  - [ ] Implement pagination
  - [ ] Add "Add Contact" button

- [ ] **Task 16: Create contact form component** (AC: 1, 5)
  - [ ] Create `create-contact.component.ts` and `edit-contact.component.ts` (or single component)
  - [ ] Reactive form with fields:
    - First Name (input, required, max 100)
    - Last Name (input, required, max 100)
    - Email (input, required, email validation, max 256)
    - Phone Number (input, optional, international format validation)
    - Organization (input or dropdown, optional, max 500)
    - Role/Title (input, optional, max 250)
    - Notes (textarea, optional, max 2000)
  - [ ] Validate Email is unique
  - [ ] On submit, call contactsService.createContact() or updateContact()
  - [ ] On success, navigate to contacts list

- [ ] **Task 17: Implement create contact** (AC: 1)
  - [ ] Configure routing: `/contacts/create`
  - [ ] Form title: "Add Contact"
  - [ ] On submit, create contact
  - [ ] On success, show message and navigate to contacts list

- [ ] **Task 18: Implement edit contact** (AC: 5)
  - [ ] Configure routing: `/contacts/:id/edit`
  - [ ] Load contact via contactsService.getContactDetail(id)
  - [ ] Pre-populate form
  - [ ] On submit, update contact
  - [ ] On success, show message and navigate back

- [ ] **Task 19: Implement delete contact** (AC: 6)
  - [ ] Add "Delete" button on contact detail or list
  - [ ] Show confirmation dialog: "Are you sure? This action cannot be undone."
  - [ ] If contact is in groups, show error: "Cannot delete contact that is member of contact groups. Remove from groups first."
  - [ ] On confirm, call contactsService.deleteContact(id)
  - [ ] On success, navigate to list

- [ ] **Task 20: Style contacts UI** (AC: 7, 8)
  - [ ] Page title: "Contacts"
  - [ ] Search bar and filter dropdown
  - [ ] Table or card grid layout
  - [ ] "Add Contact" button (prominent)
  - [ ] Actions: Edit, Delete, Add to Group
  - [ ] Responsive design
  - [ ] Empty state: "No contacts found. Add your first contact!"

### Testing Tasks

- [ ] **Task 21: Write unit tests for contact handlers** (AC: All)
  - [ ] Test: `Create_ValidContact_CreatesContact`
  - [ ] Test: `Create_DuplicateEmail_ThrowsException`
  - [ ] Test: `Create_InvalidEmail_ThrowsValidationException`
  - [ ] Test: `Update_ValidContact_UpdatesContact`
  - [ ] Test: `Delete_ContactNotInGroups_DeletesContact`
  - [ ] Test: `Delete_ContactInGroups_ThrowsException`
  - [ ] Test: `GetContacts_SearchesAndFilters`
  - [ ] Mock: IContactRepository, ILogger

- [ ] **Task 22: Write integration tests for contacts**
  - [ ] Test: `POST_CreateContact_Returns201AndCreates`
  - [ ] Test: `POST_CreateContact_DuplicateEmail_Returns400`
  - [ ] Test: `GET_Contacts_Returns200WithList`
  - [ ] Test: `PUT_UpdateContact_Returns200AndUpdates`
  - [ ] Test: `DELETE_Contact_NotInGroups_Returns200AndDeletes`
  - [ ] Test: `DELETE_Contact_InGroups_Returns400`
  - [ ] Use Testcontainers
  - [ ] Verify CRUD operations work correctly

---

## Dev Notes

### Contact vs. User

**Contact:**
- Person without system account
- Cannot log in
- Receives email notifications only
- Stored in Contacts table

**User:**
- Person with system account
- Can log in
- Receives in-app notifications + emails
- Stored in Users table

### Email Uniqueness

Email must be unique among Contacts table (separate from Users table):
```csharp
var exists = await _contactRepository.ExistsByEmailAsync(command.Email);
if (exists)
    throw new ValidationException("Contact with this email already exists");
```

### Phone Number Validation

International format (same as User registration):
```
/^\+(?:[0-9] ?){6,14}[0-9]$/
```

Examples:
- +48123456789
- +1 234 567 8900

### Check Contact Group Membership

Before deleting, check if contact is member of any groups:
```csharp
var groupCount = await _contactGroupMemberRepository.GetGroupCountByContactAsync(contactId);
if (groupCount > 0)
    throw new BusinessException("Cannot delete contact that is member of contact groups");
```

### Email Notifications to Contacts

When announcement or message is sent to contact group containing contacts:
- System users: Receive in-app notification + email
- Contacts: Receive email only (no in-app notification)

Example email:
```
From: UKNF Platform <noreply@uknf.gov.pl>
To: contact@example.com
Subject: New Announcement: [Title]

Hello,

A new announcement has been published on the UKNF Platform:

[Announcement Title]
[Excerpt]

As a contact registered with UKNF, you are receiving this notification.

---
This is an automated message. Please do not reply.
```

### Dependencies

**Prerequisites:**
- **Story 7.12**: Create Contact Groups (contacts are added to groups)
- **Epic 1**: Authentication & Authorization

**Blocks:**
- **Story 7.14**: Assign Contacts to Groups (add contacts to groups)
- **Story 7.15**: Use Contact Groups (contacts in groups receive notifications)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

