# Story 7.7: Edit Announcement (UKNF)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.7  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** edit published announcements,  
**So that** I can correct errors or update information.

---

## Acceptance Criteria

1. Employee can select any announcement (draft or published) and choose "Edit"
2. Employee can modify: Title, Content, Category, Priority, Expiration date, Attachments, Recipients
3. Changes to published announcements take effect immediately
4. Users who already read announcement see "Updated" indicator
5. If priority changes to High and announcement was previously Medium/Low, users are re-prompted for read confirmation
6. System tracks edit history with timestamps and employee IDs
7. Edit action is logged

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create UpdateAnnouncementCommand** (AC: 1, 2)
  - [ ] Create `UpdateAnnouncementCommand.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Commands/`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)
    - Title (string, optional)
    - Content (string, optional)
    - Category (string, optional)
    - Priority (string, optional)
    - ExpirationDate (DateTime?, nullable)
    - AddAttachments (List<IFormFile>, optional)
    - RemoveAttachmentIds (List<Guid>, optional)
    - RecipientConfiguration (RecipientConfigDto, optional)

- [ ] **Task 2: Create UpdateAnnouncementCommandValidator** (AC: 2)
  - [ ] Create `UpdateAnnouncementCommandValidator.cs` using FluentValidation
  - [ ] Validate AnnouncementId: NotEmpty
  - [ ] Validate Title: if provided, MaxLength(500)
  - [ ] Validate Content: if provided, not empty, safe HTML
  - [ ] Validate Category: if provided, valid category
  - [ ] Validate Priority: if provided, "Low", "Medium", or "High"
  - [ ] Validate ExpirationDate: if provided, must be future date
  - [ ] Validate Attachments: each file max 100 MB, total max 500 MB

- [ ] **Task 3: Create UpdateAnnouncementCommandHandler** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create `UpdateAnnouncementCommandHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, IFileStorageService, IHtmlSanitizer, ICurrentUserService, IAnnouncementHistoryRepository, ILogger
  - [ ] Handler logic:
    - Load announcement
    - Check user has "announcements.edit" permission
    - Capture previous values for history
    - Update provided fields (partial update)
    - If content provided, sanitize HTML
    - If attachments added, upload files
    - If attachments removed, delete files from storage
    - If recipients updated, recalculate
    - Set LastModifiedBy = current user ID
    - Set LastModifiedDate = DateTime.UtcNow
    - Save announcement
    - Create history record with changes
    - If status = Published and priority changed to High, publish AnnouncementUpdatedEvent
    - Log edit action
    - Return success response

- [ ] **Task 4: Add UpdateContent domain method to Announcement entity** (AC: 2, 3)
  - [ ] Update `Announcement.cs`
  - [ ] Add `UpdateContent(title, content, category, priority, ...)` method
  - [ ] Set LastModifiedDate
  - [ ] Validate changes

- [ ] **Task 5: Create AnnouncementHistory entity** (AC: 6)
  - [ ] Create `AnnouncementHistory.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - AnnouncementId (Guid, required)
    - Action (string, required) - "Created", "Updated", "Published", "Removed", "Deleted"
    - ChangedBy (Guid, required)
    - ChangedDate (DateTime, required)
    - ChangeDetails (string, JSON) - field-by-field changes
  - [ ] Store previous and new values for each changed field

- [ ] **Task 6: Create database migration for AnnouncementHistory table** (AC: 6)
  - [ ] Create EF Core migration: `Add_AnnouncementHistory_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE AnnouncementHistory (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        AnnouncementId UUID NOT NULL,
        Action NVARCHAR(50) NOT NULL,
        ChangedBy UUID NOT NULL,
        ChangedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        ChangeDetails TEXT NOT NULL,
        
        FOREIGN KEY (AnnouncementId) REFERENCES Announcements(Id),
        FOREIGN KEY (ChangedBy) REFERENCES Users(Id),
        INDEX IX_AnnouncementHistory_AnnouncementId (AnnouncementId),
        INDEX IX_AnnouncementHistory_ChangedDate (ChangedDate)
    );
    ```

- [ ] **Task 7: Create AnnouncementUpdatedEvent** (AC: 4, 5)
  - [ ] Create `AnnouncementUpdatedEvent.cs` in `Domain/UknfPlatform.Domain.Communication/Events/`
  - [ ] Event properties:
    - AnnouncementId (Guid)
    - PriorityChangedToHigh (bool)
    - RecipientIds (List<Guid>)
  - [ ] Event handler:
    - If PriorityChangedToHigh, invalidate previous read confirmations (re-prompt users)
    - Send notifications to recipients about update

- [ ] **Task 8: Create UpdateAnnouncementResponse DTO** (AC: 3)
  - [ ] Create `UpdateAnnouncementResponse.cs` record
  - [ ] Properties:
    - AnnouncementId (Guid)
    - Status (string)
    - LastModifiedDate (DateTime)
    - Message (string)

- [ ] **Task 9: Create REST API endpoint PUT /api/announcements/{id}** (AC: 1, 2)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `UpdateAnnouncementAsync(Guid id, [FromForm] UpdateAnnouncementCommand command)`
  - [ ] Use `[FromForm]` for file attachments
  - [ ] Return 200 OK with UpdateAnnouncementResponse
  - [ ] Return 404 if announcement not found
  - [ ] Return 403 if user lacks permission
  - [ ] Return 400 for validation errors

### Frontend Tasks

- [ ] **Task 10: Create edit announcement component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/announcements/edit-announcement/edit-announcement.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/announcements/:id/edit` with auth + permission guard
  - [ ] Load announcement via announcementsService.getAnnouncementDetail(id)
  - [ ] Pre-populate form with announcement data
  - [ ] Same form structure as create announcement (Story 7.1)

- [ ] **Task 11: Implement edit form** (AC: 2)
  - [ ] Reactive form with FormBuilder
  - [ ] Pre-populate all fields from loaded announcement
  - [ ] Allow modification of:
    - Title
    - Content (WYSIWYG editor)
    - Category
    - Priority
    - Expiration date
    - Recipients
  - [ ] Show existing attachments with "Remove" button
  - [ ] Allow adding new attachments
  - [ ] Validate all fields

- [ ] **Task 12: Implement attachment management** (AC: 2)
  - [ ] Show list of existing attachments with "Remove" button
  - [ ] Track removed attachment IDs
  - [ ] Allow adding new attachments
  - [ ] On submit, send both new attachments and removed IDs

- [ ] **Task 13: Implement updateAnnouncement service method** (AC: 2, 3)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `updateAnnouncement(id: string, command): Observable<UpdateAnnouncementResponse>`
  - [ ] Use FormData for file upload
  - [ ] Call PUT `/api/announcements/{id}`
  - [ ] Handle errors

- [ ] **Task 14: Handle update success** (AC: 3, 4)
  - [ ] On success (200):
    - Display success message: "Announcement updated successfully"
    - Navigate back to announcement detail or list
    - Show "Updated" indicator on announcement (if published)
  - [ ] On error (400): Display validation errors
  - [ ] On error (403): Display permission error
  - [ ] On error (404): Display "Announcement not found"

- [ ] **Task 15: Add "Edit" button to announcement detail view** (AC: 1)
  - [ ] Update `announcement-detail.component.ts` from Story 7.5
  - [ ] Add "Edit" button (visible only to UKNF Employees)
  - [ ] On click, navigate to `/announcements/{id}/edit`

- [ ] **Task 16: Show "Updated" indicator** (AC: 4)
  - [ ] If announcement.lastModifiedDate > announcement.publicationDate
  - [ ] Show "Updated" badge on announcement list and detail
  - [ ] Display last modified date

### Testing Tasks

- [ ] **Task 17: Write unit tests for UpdateAnnouncementCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidUpdate_UpdatesAnnouncement`
  - [ ] Test: `Handle_PartialUpdate_OnlyUpdatesProvidedFields`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_AnnouncementNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_CreatesHistoryRecord`
  - [ ] Test: `Handle_PriorityChangedToHigh_PublishesEvent`
  - [ ] Test: `Handle_AddAttachments_UploadsFiles`
  - [ ] Test: `Handle_RemoveAttachments_DeletesFiles`
  - [ ] Test: `Handle_UpdatesLastModifiedDate`
  - [ ] Mock: IAnnouncementRepository, IFileStorageService, IHtmlSanitizer, IAnnouncementHistoryRepository, ILogger

- [ ] **Task 18: Write integration test for update announcement**
  - [ ] Test: `PUT_UpdateAnnouncement_ValidData_Returns200AndUpdates`
  - [ ] Test: `PUT_UpdateAnnouncement_PartialUpdate_UpdatesOnlyProvidedFields`
  - [ ] Test: `PUT_UpdateAnnouncement_UserLacksPermission_Returns403`
  - [ ] Test: `PUT_UpdateAnnouncement_NotFound_Returns404`
  - [ ] Test: `PUT_UpdateAnnouncement_CreatesHistoryRecord`
  - [ ] Test: `PUT_UpdateAnnouncement_AddAttachments_Uploads`
  - [ ] Test: `PUT_UpdateAnnouncement_RemoveAttachments_Deletes`
  - [ ] Use Testcontainers
  - [ ] Verify announcement updated in database
  - [ ] Verify history record created
  - [ ] Verify LastModifiedDate updated

---

## Dev Notes

### Partial Updates

Command handler should support partial updates:
- Only update fields that are provided (not null)
- Don't overwrite fields that aren't in the command

Example:
```csharp
if (!string.IsNullOrEmpty(command.Title))
    announcement.UpdateTitle(command.Title);

if (command.Content != null)
    announcement.UpdateContent(sanitizedContent);
```

### Change History

Track field-by-field changes:
```json
{
  "changes": [
    {
      "field": "Title",
      "previousValue": "Old Title",
      "newValue": "New Title"
    },
    {
      "field": "Priority",
      "previousValue": "Low",
      "newValue": "High"
    }
  ]
}
```

Store in `ChangeDetails` as JSON.

### Priority Change to High

If priority changes from Low/Medium to High:
1. Invalidate previous read confirmations (or keep them but mark as "needs re-confirmation")
2. Send notifications to recipients
3. Re-prompt users for confirmation

### Updated Indicator

Show "Updated" badge if:
- `LastModifiedDate > PublicationDate`
- Display: "Updated [date]"

### Dependencies

**Prerequisites:**
- **Story 7.1**: Create Announcement (announcement entity exists)
- **Story 7.3**: Publish Announcement (published announcements exist)
- **Epic 2**: Authorization (permission checks)

**Integrates With:**
- **Story 7.10**: View Announcement Change History (history records)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

