# Story 6.10: Access Archival File Versions

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.10  
**Created:** 2025-10-04

---

## Status

**TODO** 📋

---

## Story

**As an** External User or UKNF Employee,  
**I want to** access previous versions of files,  
**So that** I can reference historical documents if needed.

---

## Acceptance Criteria

1. Users can toggle view to include archival versions in Library
2. Archival files display: Filename, Version date, Archival date, Model Update Date
3. Users with access to current version automatically have access to archival versions
4. User can download archival versions same as current
5. File details clearly indicate version status and date
6. Archival versions are listed chronologically (newest to oldest)
7. Downloads of archival versions are logged same as current
8. Archival versions clearly marked with "Archived" badge
9. Current version prominently displayed (e.g., at top, highlighted)
10. Version history shows relationship between versions (which replaced which)
11. User can navigate between versions (Previous/Next version buttons)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Update GetLibraryFilesQuery to support archival versions** (AC: 1, 2, 6, 8)
  - [ ] Update `GetLibraryFilesQuery.cs` (Story 6.3)
  - [ ] Add query property: IncludeArchival (bool, default false)
  - [ ] Update QueryHandler:
    - If IncludeArchival = false: Filter by VersionStatus = Current (default)
    - If IncludeArchival = true: Include both Current and Archival
    - Ensure archival versions respect same permissions as current
    - Sort by ModelUpdateDate descending (newest first)
    - Group by version chain (optional display enhancement)

- [ ] **Task 2: Ensure archival versions respect permissions** (AC: 3)
  - [ ] Archival versions inherit permissions from current version
  - [ ] Or: Archival versions have own permissions (copied during replacement)
  - [ ] Permission check must work for archival files
  - [ ] Update CheckUserHasAccessAsync to handle archival versions
  - [ ] Decision: Use same FilePermissions table (FileId references archival file)

- [ ] **Task 3: Update GetFileDetailsQuery for archival versions** (AC: 2, 5, 10)
  - [ ] GetFileDetailsQuery (Story 6.5) already supports any file
  - [ ] Ensure VersionStatus (Current/Archival) and ArchivalDate included in response
  - [ ] Ensure version history (PreviousVersionId chain) included
  - [ ] Add NextVersionId logic (find file where PreviousVersionId = current file)

- [ ] **Task 4: Create GetVersionHistoryQuery** (AC: 6, 10)
  - [ ] Create `GetVersionHistoryQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties: FileId (Guid)
  - [ ] Query Handler:
    - Load version chain for file
    - Follow PreviousVersionId links backward
    - Follow NextVersionId links forward (find files where PreviousVersionId = this file)
    - Return ordered list (Current → Archival v2 → Archival v1)
    - Include: Id, Filename, ModelUpdateDate, VersionStatus, ArchivalDate, FileSize

- [ ] **Task 5: Create GetVersionHistoryResponse DTO** (AC: 6, 10)
  - [ ] Create `GetVersionHistoryResponse.cs` record
  - [ ] Properties: Versions (List<FileVersionDto>), TotalVersions (int)
  - [ ] FileVersionDto properties:
    - Id (Guid)
    - Filename (string)
    - ModelUpdateDate (DateTime)
    - VersionStatus (string)
    - ArchivalDate (DateTime?, nullable)
    - FileSize (long)
    - UploadDate (DateTime)
    - IsCurrent (bool)

- [ ] **Task 6: Create REST API endpoint GET /library/files/{fileId}/versions** (AC: 6, 10)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetVersionHistoryAsync(Guid fileId)`
  - [ ] Inject IMediator to send query
  - [ ] Return 200 OK with GetVersionHistoryResponse
  - [ ] Return 401 Unauthorized if not authenticated
  - [ ] Return 403 Forbidden if no permission to access file
  - [ ] Return 404 Not Found if file doesn't exist

- [ ] **Task 7: Update DownloadFileCommand for archival versions** (AC: 4, 7)
  - [ ] DownloadFileCommand (Story 6.4) already supports any file ID
  - [ ] Ensure permission check works for archival versions
  - [ ] Logic: If user has access to ANY version in chain, grant access to ALL versions
  - [ ] Download logging same for archival and current
  - [ ] Increment download count on archival file

- [ ] **Task 8: Update ILibraryFileRepository** (AC: 1, 3, 6, 10)
  - [ ] Methods to support:
    - GetLibraryFilesWithPermissionsAsync: Support IncludeArchival flag
    - GetVersionChainAsync(Guid fileId): Get all versions in chain
    - GetNextVersionAsync(Guid fileId): Find version that replaced this one
  - [ ] Ensure permissions checked for archival versions

### Frontend Tasks

- [ ] **Task 9: Add archival toggle to library list** (AC: 1, 8, 9)
  - [ ] Update `library-list.component.ts` (Story 6.3)
  - [ ] Add toggle/checkbox: "Include archived versions"
  - [ ] Default: off (show only current versions)
  - [ ] When toggled on: Show both current and archival
  - [ ] Archival files have "Archived" badge
  - [ ] Current version highlighted or at top

- [ ] **Task 10: Display archival files in list** (AC: 2, 6, 8)
  - [ ] Archival files show: Filename, Model Update Date, Archival Date, Version Status
  - [ ] "Archived" badge clearly visible
  - [ ] Show archival date: "Archived on [date]"
  - [ ] Optionally group by version chain (collapsible)
  - [ ] Sort chronologically within each chain

- [ ] **Task 11: Update file details for archival versions** (AC: 2, 5, 10, 11)
  - [ ] Update `library-file-details.component.ts` (Story 6.5)
  - [ ] Show "Archived" banner if VersionStatus = Archival
  - [ ] Display Archival Date prominently
  - [ ] Show "Current Version" link if viewing archival
  - [ ] Show "Previous Version" / "Next Version" navigation buttons

- [ ] **Task 12: Create version history component** (AC: 6, 10, 11)
  - [ ] Create `library-version-history.component.ts`
  - [ ] Display version history as timeline or list
  - [ ] Show each version with:
    - Version badge (Current/Archived)
    - Model Update Date
    - Archival Date (if archived)
    - File size
    - Download button
    - "View Details" link
  - [ ] Highlight current version
  - [ ] Show version relationships (arrows or lines)

- [ ] **Task 13: Add version navigation** (AC: 11)
  - [ ] Add "Previous Version" button (older version)
  - [ ] Add "Next Version" button (newer version)
  - [ ] Disable buttons if no previous/next version
  - [ ] Navigate to version details on click

- [ ] **Task 14: Update library service** (AC: 1, 4, 6)
  - [ ] Update getLibraryFiles method to support includeArchival flag
  - [ ] Add method: getVersionHistory(fileId: string): Observable<VersionHistory>
  - [ ] Download method already works for any file ID (archival or current)

- [ ] **Task 15: Handle permissions for archival versions** (AC: 3)
  - [ ] Frontend assumes permission logic handled by backend
  - [ ] If user can see current version, they can see archival versions
  - [ ] No special permission checks needed on frontend

- [ ] **Task 16: Add archival indicator throughout UI** (AC: 8, 9)
  - [ ] "Archived" badge component (reusable)
  - [ ] Color coding: Current = green, Archived = gray
  - [ ] Icons: Current = checkmark, Archived = archive icon
  - [ ] Consistent styling across library list and details

### Testing Tasks

- [ ] **Task 17: Unit tests for archival query logic** (AC: 1, 2, 3, 6)
  - [ ] Test GetLibraryFiles with IncludeArchival = false (only current)
  - [ ] Test GetLibraryFiles with IncludeArchival = true (current + archival)
  - [ ] Test archival versions respect permissions
  - [ ] Test user with access to current has access to archival
  - [ ] Test archival versions sorted chronologically
  - [ ] Test GetVersionHistory returns complete chain

- [ ] **Task 18: Unit tests for version history** (AC: 6, 10)
  - [ ] Test version chain traversal (backward and forward)
  - [ ] Test version history ordered correctly
  - [ ] Test current version identified
  - [ ] Test archival dates displayed

- [ ] **Task 19: Integration tests for API endpoints** (AC: 1, 4, 6)
  - [ ] Test GET /library/files?includeArchival=true returns archival files
  - [ ] Test GET /library/files/{id}/versions returns version history
  - [ ] Test download archival version works
  - [ ] Test archival download logged
  - [ ] Test permission required for archival access

- [ ] **Task 20: Integration tests for permissions** (AC: 3)
  - [ ] Test user with permission to current can access archival
  - [ ] Test user without permission cannot access archival
  - [ ] Test UKNF Employee can access any archival version

- [ ] **Task 21: Frontend unit tests** (AC: 1, 8, 9, 11)
  - [ ] Test archival toggle
  - [ ] Test archival files displayed correctly
  - [ ] Test version history component
  - [ ] Test version navigation buttons
  - [ ] Test archival badge display
  - [ ] Test service method calls

- [ ] **Task 22: E2E tests** (AC: 1-11)
  - [ ] Test toggling archival versions on/off
  - [ ] Test archival files visible when toggle on
  - [ ] Test user can download archival versions
  - [ ] Test version history displays correctly
  - [ ] Test navigation between versions
  - [ ] Test archival versions clearly marked
  - [ ] Test permission required for archival access

### Documentation Tasks

- [ ] **Task 23: API documentation** (AC: 1, 4, 6)
  - [ ] Update GET /library/files documentation (includeArchival parameter)
  - [ ] Document GET /library/files/{id}/versions endpoint
  - [ ] Document archival version access permissions
  - [ ] Include examples showing archival files

- [ ] **Task 24: Developer documentation** (AC: 3, 10)
  - [ ] Document archival version permission model
  - [ ] Document version chain structure (PreviousVersionId)
  - [ ] Document version history traversal logic
  - [ ] Document archival vs. current version handling

- [ ] **Task 25: User documentation** (AC: 1, 2, 4, 6, 8)
  - [ ] Create user guide for accessing archival versions
  - [ ] Explain archival toggle
  - [ ] Explain version history
  - [ ] Explain when to use archival versions
  - [ ] Include screenshots

---

## Technical Notes

### Permission Model for Archival Versions

**Option 1: Inherit from Current Version**
- Archival versions automatically accessible if current version accessible
- Simpler logic
- Consistent access across version chain

**Option 2: Independent Permissions**
- Each version has own permissions (copied during replacement)
- More flexible but more complex
- Allows restricting access to old versions

**Recommendation: Option 1** (simpler, meets requirements).

Implementation:
```csharp
// Check permission for any version in chain
var currentVersion = await GetCurrentVersionInChain(fileId);
var hasAccess = await CheckUserHasAccessAsync(currentVersion.Id, userId);
if (hasAccess) 
{
    // Grant access to all versions in chain (current and archival)
}
```

### Version Chain Structure

Example version chain:
```
File A (Current, v3)
  └─ PreviousVersionId → File A (Archival, v2)
       └─ PreviousVersionId → File A (Archival, v1)
```

Traversal:
- **Backward**: Follow PreviousVersionId (get older versions)
- **Forward**: Query WHERE PreviousVersionId = currentId (get newer versions)

### Version Status Display

- **Current**: Green badge, "Current Version"
- **Archival**: Gray badge, "Archived on [date]"
- **Model Update Date**: Document version date (may differ from archival date)

Example:
```
[Current] Q1 2025 Report Template
Model Date: Jan 15, 2025

[Archived] Q1 2025 Report Template
Model Date: Jan 10, 2025
Archived: Jan 15, 2025 (replaced by newer version)
```

### Download Count for Archival Versions

- Track downloads separately for each version
- Total downloads = sum of all versions
- Useful for understanding which versions most used

### Archival Date vs. Model Update Date

- **Archival Date**: System date when version was archived (Story 6.7)
- **Model Update Date**: Document version date (content date)
- Both important for users

### Version History UI

Timeline view:
```
🟢 [Current] Q1 2025 Template v3
   📅 Model Date: Jan 15, 2025
   💾 2.5 MB
   [Download] [View Details]
   
⚫ [Archived] Q1 2025 Template v2
   📅 Model Date: Jan 10, 2025
   🗄️ Archived: Jan 15, 2025
   💾 2.3 MB
   [Download] [View Details]
   
⚫ [Archived] Q1 2025 Template v1
   📅 Model Date: Jan 5, 2025
   🗄️ Archived: Jan 10, 2025
   💾 2.1 MB
   [Download] [View Details]
```

### Performance Considerations

- Index VersionStatus for filtering (Current vs. Archival)
- Index PreviousVersionId for version chain queries
- Cache version history (changes infrequently)
- Lazy load archival versions (don't query unless toggle on)

### Security Considerations

- Same permission check as current version
- Log archival downloads same as current
- Prevent access to archival if no access to current
- Ensure soft-deleted versions not accessible

### UI/UX Considerations

- Default: Show only current versions (less clutter)
- Toggle easily accessible (top of list or filter section)
- Archival badge clearly visible
- Version history easy to understand (timeline or list)
- Navigation between versions intuitive
- Explain to users when to use archival versions

### Use Cases for Archival Versions

- Compare current template with previous version
- Use old template for historical reports
- Reference previous requirements
- Audit what template was used at specific time
- Troubleshoot issues with old submissions

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files created)
- **Story 6.3**: View and Search Library (library list to extend)
- **Story 6.4**: Download File from Library (download archival versions)
- **Story 6.5**: View File Details (details for archival files)
- **Story 6.7**: Replace File (creates archival versions)

### Integrates With
- **Story 6.7**: Replace File (archival process)
- **Story 6.11**: View File Change History (archival tracked)

---

## Acceptance Checklist

- [ ] Users can toggle to include archival versions
- [ ] Archival files display filename, version date, archival date, model update date
- [ ] Users with access to current version can access archival versions
- [ ] Users can download archival versions
- [ ] File details clearly show version status and dates
- [ ] Archival versions listed chronologically (newest to oldest)
- [ ] Archival downloads are logged
- [ ] Archival versions clearly marked with badge
- [ ] Current version prominently displayed
- [ ] Version history shows relationships
- [ ] Users can navigate between versions
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.3**: View and Search Library (extends library list)
- **Story 6.4**: Download File from Library (download archival)
- **Story 6.5**: View File Details (archival file details)
- **Story 6.7**: Replace File (creates archival versions)
- **Story 6.11**: View File Change History (tracks archival)

---

## Notes

- Archival access is important for compliance and reference
- Most users want current versions by default (toggle off)
- Some users need access to historical versions (toggle on)
- Permission model should be simple (inherit from current)
- Version history helps users understand document evolution
- Clear distinction between archival date and model update date
- Test with long version chains (10+ versions)
- Consider version comparison tool in future (diff between versions)
- Monitor storage usage with many archival versions
- Consider archival retention policy (very old versions)
- Explain to users why archival versions exist and when to use them
- Version navigation should be intuitive (Previous/Next buttons)

