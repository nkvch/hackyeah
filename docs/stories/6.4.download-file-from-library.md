# Story 6.4: Download File from Library

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.4  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As an** External User or UKNF Employee,  
**I want to** download files from the Library,  
**So that** I can use them (e.g., complete report templates).

---

## Acceptance Criteria

1. User can click download button/link for any accessible file
2. System validates user has permission to access file
3. File downloads with original filename or metadata filename
4. Download is logged with: User ID, File ID, Timestamp, IP address (for audit)
5. UKNF Employees can download any file regardless of access permissions
6. Download doesn't modify file or metadata
7. System tracks download count per file (optional analytics)
8. System prevents download of files with virus scan status Pending or Infected
9. System provides appropriate error messages if download fails
10. Download supports large files efficiently (streaming)
11. Download includes correct MIME type and Content-Disposition headers

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create FileDownload domain entity for tracking** (AC: 4, 7)
  - [ ] Create `FileDownload.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - FileId (Guid, required)
    - UserId (Guid, required)
    - IpAddress (string, max 45) - supports IPv6
    - UserAgent (string?, nullable, max 500)
    - DownloadDate (DateTime)
  - [ ] This entity is for audit and analytics

- [ ] **Task 2: Create DownloadFileCommand** (AC: 1, 2, 3, 8, 10)
  - [ ] Create `DownloadFileCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileId (Guid, required)
  - [ ] Note: User info from ICurrentUserService, IP from HttpContext

- [ ] **Task 3: Create DownloadFileCommandValidator** (AC: 1, 2)
  - [ ] Create `DownloadFileCommandValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Add async validation: File must exist
  - [ ] Add async validation: File must not be deleted
  - [ ] Add async validation: User must be authenticated

- [ ] **Task 4: Create DownloadFileCommandHandler** (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `DownloadFileCommandHandler.cs` implementing `IRequestHandler<DownloadFileCommand, DownloadFileResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFilePermissionRepository, IFileStorageService, IFileDownloadRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate file exists and not deleted
    - Check virus scan status (must be Clean, not Pending or Infected)
    - Get current user and role
    - If user is UKNF Employee: grant download (AC: 5)
    - Else: validate user has permission (CheckUserHasAccessAsync)
    - If no permission: return 403 Forbidden
    - Retrieve file stream from storage (IFileStorageService)
    - Increment download count on LibraryFile entity (AC: 7)
    - Create FileDownload audit record (AC: 4)
    - Save changes
    - Return DownloadFileResponse with file stream, filename, MIME type
  - [ ] Handle errors: file not found, storage errors, permission denied

- [ ] **Task 5: Create DownloadFileResponse DTO** (AC: 3, 11)
  - [ ] Create `DownloadFileResponse.cs` record
  - [ ] Properties:
    - FileStream (Stream)
    - Filename (string)
    - MimeType (string)
    - FileSize (long)

- [ ] **Task 6: Create REST API endpoint GET /library/files/{fileId}/download** (AC: 1, 3, 9, 10, 11)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize]` attribute (requires authentication)
  - [ ] Create GET action `DownloadFileAsync(Guid fileId)`
  - [ ] Inject IMediator to send command
  - [ ] Return FileStreamResult with:
    - Content-Type: response.MimeType
    - Content-Disposition: attachment; filename="{filename}"
    - EnableRangeProcessing: true (supports resume and partial downloads)
  - [ ] Return 200 OK with file stream
  - [ ] Return 400 Bad Request if file ID invalid
  - [ ] Return 401 Unauthorized if not authenticated
  - [ ] Return 403 Forbidden if no permission
  - [ ] Return 404 Not Found if file not found
  - [ ] Return 422 Unprocessable Entity if virus scan Pending/Infected
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations (note: file download response)

- [ ] **Task 7: Create IFileDownloadRepository interface and implementation** (AC: 4, 7)
  - [ ] Create `IFileDownloadRepository.cs` interface in `Domain/UknfPlatform.Domain.Communication/Interfaces/`
  - [ ] Define methods: AddAsync, GetByFileIdAsync, GetByUserIdAsync, GetDownloadCountAsync
  - [ ] Create `FileDownloadRepository.cs` in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/`
  - [ ] Implement repository methods using EF Core

- [ ] **Task 8: Update IFileStorageService for streaming** (AC: 10)
  - [ ] Update `IFileStorageService.cs` interface
  - [ ] Add method: DownloadFileStreamAsync(string storageKey)
  - [ ] Returns Stream (not byte array for efficiency)
  - [ ] Update implementation in `FileStorageService.cs`
  - [ ] Use streaming from blob storage (don't load entire file in memory)
  - [ ] Handle blob not found errors

- [ ] **Task 9: Update LibraryFile entity** (AC: 7)
  - [ ] Add domain method: IncrementDownloadCount()
  - [ ] Updates DownloadCount property
  - [ ] Updates UpdatedDate

- [ ] **Task 10: Create database schema for FileDownload** (AC: 4)
  - [ ] Create EF Core entity configuration `FileDownloadConfiguration.cs`
  - [ ] Configure table name, primary key, indexes
  - [ ] Configure foreign key relationship: FileDownload -> LibraryFile
  - [ ] Create indexes:
    - FileId, DownloadDate (for analytics)
    - UserId, DownloadDate (for user history)
  - [ ] Add EF Core migration `Add_FileDownload_Table`

- [ ] **Task 11: Update ApplicationDbContext** (AC: 4)
  - [ ] Add DbSet<FileDownload> FileDownloads
  - [ ] Apply entity configuration in OnModelCreating

- [ ] **Task 12: Create IP address extraction service** (AC: 4)
  - [ ] Create `IIpAddressService.cs` interface in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Define method: GetClientIpAddress(): string
  - [ ] Create `IpAddressService.cs` implementation in API layer
  - [ ] Extract IP from HttpContext
  - [ ] Handle X-Forwarded-For header (reverse proxy/load balancer)
  - [ ] Handle X-Real-IP header
  - [ ] Return RemoteIpAddress if headers not present

### Frontend Tasks

- [ ] **Task 13: Create download button component** (AC: 1, 9)
  - [ ] Create `file-download-button.component.ts` in `src/app/features/library/`
  - [ ] Accept file ID and filename as inputs
  - [ ] Show download icon button
  - [ ] Show loading spinner during download
  - [ ] Disable button during download
  - [ ] Handle download errors with user-friendly messages
  - [ ] Show success feedback after download

- [ ] **Task 14: Update library service for download** (AC: 1, 3, 10)
  - [ ] Add method to `library.service.ts`:
    - downloadFile(fileId: string): Observable<Blob>
  - [ ] Configure HTTP client for blob response
  - [ ] Extract filename from Content-Disposition header
  - [ ] Handle HTTP errors (403, 404, 422)
  - [ ] Return Blob with filename

- [ ] **Task 15: Implement download trigger** (AC: 1, 3)
  - [ ] Create helper method to trigger browser download:
    - Create blob URL
    - Create temporary anchor element
    - Set download attribute with filename
    - Trigger click
    - Revoke blob URL after download
  - [ ] Handle different browsers compatibility

- [ ] **Task 16: Add download button to library list** (AC: 1)
  - [ ] Add download button to each file row in library list
  - [ ] Show button only if file can be downloaded (virus scan clean)
  - [ ] Position button prominently (right side or action menu)
  - [ ] Show file size next to download button

- [ ] **Task 17: Add download button to file details page** (AC: 1)
  - [ ] Add prominent download button on file details page (Story 6.5)
  - [ ] Show button if file can be downloaded
  - [ ] Show virus scan status if Pending/Infected
  - [ ] Disable and explain if cannot download

- [ ] **Task 18: Create download progress indicator** (AC: 10)
  - [ ] Show progress bar for large file downloads (optional)
  - [ ] Use HTTP progress events if supported
  - [ ] Show download size/progress
  - [ ] Allow cancellation (optional)

- [ ] **Task 19: Handle download errors** (AC: 2, 8, 9)
  - [ ] Display error messages:
    - 403: "You don't have permission to download this file"
    - 404: "File not found"
    - 422: "This file cannot be downloaded (virus scan pending/infected)"
    - 500: "Download failed. Please try again."
  - [ ] Show error notification or toast
  - [ ] Log errors for support

- [ ] **Task 20: Implement download tracking (analytics)** (AC: 7)
  - [ ] Track download events in frontend analytics (optional)
  - [ ] Send download event to analytics service
  - [ ] Track: FileId, Filename, Category, UserRole

### Testing Tasks

- [ ] **Task 21: Unit tests for command handler** (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Test successful download with permission
  - [ ] Test UKNF Employee can download any file
  - [ ] Test external user needs permission
  - [ ] Test download denied without permission (403)
  - [ ] Test virus scan Pending prevents download (422)
  - [ ] Test virus scan Infected prevents download (422)
  - [ ] Test download count incremented
  - [ ] Test FileDownload audit record created
  - [ ] Test deleted file cannot be downloaded

- [ ] **Task 22: Unit tests for permission checking** (AC: 2, 5)
  - [ ] Test external user with AllUsers permission can download
  - [ ] Test external user with SpecificEntity permission can download
  - [ ] Test external user without permission cannot download
  - [ ] Test UKNF Employee bypasses permission check

- [ ] **Task 23: Unit tests for validator** (AC: 1, 2)
  - [ ] Test FileId validation
  - [ ] Test file must exist
  - [ ] Test file must not be deleted
  - [ ] Test user must be authenticated

- [ ] **Task 24: Integration tests for API endpoint** (AC: 1, 3, 4, 9, 10, 11)
  - [ ] Test GET /library/files/{id}/download returns file
  - [ ] Test correct Content-Type header
  - [ ] Test correct Content-Disposition header with filename
  - [ ] Test download requires authentication (401 if not logged in)
  - [ ] Test download requires permission (403 if no permission)
  - [ ] Test download fails for non-existent file (404)
  - [ ] Test download fails for virus Pending/Infected (422)
  - [ ] Test download count incremented
  - [ ] Test FileDownload record created
  - [ ] Test UKNF Employee can download any file

- [ ] **Task 25: Integration tests for file streaming** (AC: 10)
  - [ ] Test large file downloads (> 100 MB)
  - [ ] Test streaming doesn't load entire file in memory
  - [ ] Test partial downloads (range requests)
  - [ ] Test download resume capability
  - [ ] Test concurrent downloads

- [ ] **Task 26: Frontend unit tests** (AC: 1, 9)
  - [ ] Test download button component
  - [ ] Test download service method
  - [ ] Test download trigger
  - [ ] Test error handling
  - [ ] Test loading states

- [ ] **Task 27: E2E tests** (AC: 1-11)
  - [ ] Test complete download flow as external user
  - [ ] Test file downloads with correct filename
  - [ ] Test download requires permission
  - [ ] Test download denied without permission
  - [ ] Test virus scan prevents download
  - [ ] Test download as UKNF Employee (can download any file)
  - [ ] Test download from library list
  - [ ] Test download from file details page

### Documentation Tasks

- [ ] **Task 28: API documentation** (AC: 1, 3, 9, 11)
  - [ ] Document GET /library/files/{id}/download endpoint
  - [ ] Document response headers (Content-Type, Content-Disposition)
  - [ ] Document error responses
  - [ ] Document authentication requirements
  - [ ] Document permission requirements
  - [ ] Note: File download (blob response, not JSON)

- [ ] **Task 29: Developer documentation** (AC: 4, 7, 10)
  - [ ] Document file streaming implementation
  - [ ] Document download tracking/audit
  - [ ] Document IP address extraction
  - [ ] Document virus scan checks
  - [ ] Document performance considerations for large files
  - [ ] Document range request support

- [ ] **Task 30: User documentation** (AC: 1, 8, 9)
  - [ ] Create user guide for downloading files
  - [ ] Explain permission requirements
  - [ ] Explain virus scan status
  - [ ] Explain download errors and solutions
  - [ ] Include screenshots

---

## Technical Notes

### File Streaming

For efficient large file downloads:
- Use `Stream` instead of byte arrays
- Stream directly from blob storage to HTTP response
- Enable `EnableRangeProcessing` for partial downloads
- Support HTTP Range headers for resume capability
- Don't load entire file into memory
- Use buffered copying for efficient transfer

Example:
```csharp
return File(fileStream, mimeType, filename, enableRangeProcessing: true);
```

### Download Audit

Track downloads for:
- **Compliance**: Required for regulatory audit
- **Analytics**: Understand file usage patterns
- **Security**: Detect unusual download patterns
- **Support**: Help users find previously downloaded files

Store: User, File, Timestamp, IP address, User Agent

### IP Address Extraction

Consider reverse proxies and load balancers:
1. Check `X-Forwarded-For` header (comma-separated list, first is client)
2. Check `X-Real-IP` header
3. Fall back to `HttpContext.Connection.RemoteIpAddress`

Handle IPv4 and IPv6 addresses.

### Virus Scan Status

Prevent downloads if:
- **Pending**: Scan not yet complete
- **Infected**: Virus detected

Allow downloads if:
- **Clean**: No virus detected

Show appropriate messages to users.

### MIME Types

Set correct Content-Type for file downloads:
- XLSX: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- PDF: `application/pdf`
- DOCX: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- ZIP: `application/zip`
- Generic: `application/octet-stream`

Store MIME type in LibraryFile entity (from upload).

### Content-Disposition

Use `attachment` to trigger download (not inline display):
```
Content-Disposition: attachment; filename="Report_Template_Q1_2025.xlsx"
```

Encode filename for special characters (RFC 5987).

### Download Count

Track download count for analytics:
- Increment on each download
- Use atomic increment to avoid race conditions
- Consider separate analytics table for detailed tracking
- Reset count when new version uploaded (optional)

### Performance Considerations

- Stream files directly from blob storage (don't buffer in app server)
- Use CDN for frequently downloaded files (future optimization)
- Implement rate limiting to prevent abuse
- Monitor bandwidth usage
- Consider compression for text-based files (optional)

### Security Considerations

- Always validate user permission before download
- UKNF Employees have elevated access (can download any file)
- External users must have explicit permission
- Check virus scan status before allowing download
- Log all download attempts for audit
- Prevent directory traversal in filenames
- Sanitize filenames to prevent XSS
- Rate limit downloads per user/IP

### Error Handling

Provide clear error messages:
- **403 Forbidden**: No permission (don't reveal file existence)
- **404 Not Found**: File doesn't exist or deleted
- **422 Unprocessable Entity**: Virus scan Pending/Infected
- **500 Internal Server Error**: Storage or system error

Log errors for troubleshooting.

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files must exist)
- **Story 6.2**: Set File Access Permissions (permissions must be set)
- **Story 6.3**: View and Search Library (users find files to download)
- **Epic 1**: Authentication (user must be authenticated)
- File storage infrastructure (blob storage)

### Integrates With
- **Story 6.5**: View File Details (download from details page)
- **Story 6.12**: Monitor File Access (download tracking feeds analytics)

---

## Acceptance Checklist

- [ ] User can click download button for accessible files
- [ ] System validates user permission before download
- [ ] File downloads with correct filename
- [ ] Download is logged with user, file, timestamp, IP address
- [ ] UKNF Employees can download any file
- [ ] Download doesn't modify file or metadata
- [ ] Download count is tracked per file
- [ ] Virus scan Pending/Infected files cannot be downloaded
- [ ] Appropriate error messages displayed
- [ ] Large files download efficiently (streaming)
- [ ] Correct MIME type and Content-Disposition headers
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (creates files to download)
- **Story 6.2**: Set File Access Permissions (controls download access)
- **Story 6.3**: View and Search Library (find files to download)
- **Story 6.5**: View File Details (download from details page)
- **Story 6.10**: Access Archival File Versions (download archival versions)
- **Story 6.12**: Monitor File Access (download tracking)

---

## Notes

- File download is core functionality - must be reliable and performant
- Streaming is critical for large report templates (100+ MB)
- Audit trail is required for compliance
- Permission check is critical security control
- Virus scan status check prevents malware distribution
- Download count provides valuable usage analytics
- Consider adding "Download History" for users (my downloads)
- Consider bulk download (zip multiple files) in future
- Support resume/partial downloads for large files over slow connections
- Test download on various browsers and devices
- Consider download expiry/temporary links for sharing (future)
- Monitor download bandwidth and costs (cloud storage egress)
- Consider implementing download quotas if needed
- Add download button to email notifications (Story 6.13)

