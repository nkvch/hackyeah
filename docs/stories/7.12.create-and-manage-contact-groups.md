# Story 7.12: Create and Manage Contact Groups

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.12  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** create and manage contact groups,  
**So that** I can organize recipients for efficient targeted communication.

---

## Acceptance Criteria

1. Employee can create new Contact Group with:
   - **Group Name** (text, required, unique)
   - **Description** (text area, optional)
   - **Group Type** (optional) - e.g., "Industry Sector", "Communication List", "Report Recipients"
2. Employee can add members to Contact Group:
   - External users (system users)
   - Contacts (non-system users, Story 7.13)
3. Employee can remove members from Contact Group
4. Employee can edit Group Name and Description
5. Employee can delete Contact Group (only if not used in active communications)
6. Employee can view list of all Contact Groups with member counts
7. Employee can search/filter Contact Groups by name or type
8. System logs all Contact Group operations with timestamps

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ContactGroup domain entity** (AC: 1, 8)
  - [ ] Create `ContactGroup.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - GroupName (string, required, max 250, unique)
    - Description (string?, nullable, max 1000)
    - GroupType (string?, nullable, max 100)
    - CreatedBy (Guid, required) - UKNF Employee user ID
    - CreatedDate (DateTime, required)
    - UpdatedDate (DateTime, required)
  - [ ] Add domain methods: AddMember(), RemoveMember(), UpdateInfo()
  - [ ] Add domain validation rules

- [ ] **Task 2: Create ContactGroupMember entity** (AC: 2, 3)
  - [ ] Create `ContactGroupMember.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - ContactGroupId (Guid, required)
    - MemberType (enum, required) - SystemUser, Contact
    - UserId (Guid?, nullable) - if MemberType = SystemUser
    - ContactId (Guid?, nullable) - if MemberType = Contact
    - AddedBy (Guid, required)
    - AddedDate (DateTime, required)
  - [ ] Unique constraint: (ContactGroupId, MemberType, UserId/ContactId)

- [ ] **Task 3: Create database migrations** (AC: 1, 2)
  - [ ] Create EF Core migration: `Add_ContactGroups_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE ContactGroups (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        GroupName NVARCHAR(250) NOT NULL UNIQUE,
        Description NVARCHAR(1000) NULL,
        GroupType NVARCHAR(100) NULL,
        CreatedBy UUID NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        
        FOREIGN KEY (CreatedBy) REFERENCES Users(Id),
        INDEX IX_ContactGroups_GroupName (GroupName),
        INDEX IX_ContactGroups_GroupType (GroupType)
    );
    
    CREATE TABLE ContactGroupMembers (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        ContactGroupId UUID NOT NULL,
        MemberType NVARCHAR(20) NOT NULL CHECK (MemberType IN ('SystemUser', 'Contact')),
        UserId UUID NULL,
        ContactId UUID NULL,
        AddedBy UUID NOT NULL,
        AddedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        
        FOREIGN KEY (ContactGroupId) REFERENCES ContactGroups(Id) ON DELETE CASCADE,
        FOREIGN KEY (UserId) REFERENCES Users(Id),
        FOREIGN KEY (ContactId) REFERENCES Contacts(Id),
        FOREIGN KEY (AddedBy) REFERENCES Users(Id),
        UNIQUE (ContactGroupId, MemberType, UserId, ContactId),
        INDEX IX_ContactGroupMembers_ContactGroupId (ContactGroupId),
        INDEX IX_ContactGroupMembers_UserId (UserId),
        INDEX IX_ContactGroupMembers_ContactId (ContactId)
    );
    ```

- [ ] **Task 4: Create CreateContactGroupCommand** (AC: 1, 8)
  - [ ] Create `CreateContactGroupCommand.cs` in `Application/UknfPlatform.Application.Communication/ContactGroups/Commands/`
  - [ ] Command properties:
    - GroupName (string, required)
    - Description (string?, nullable)
    - GroupType (string?, nullable)

- [ ] **Task 5: Create CreateContactGroupCommandHandler** (AC: 1, 8)
  - [ ] Create `CreateContactGroupCommandHandler.cs`
  - [ ] Inject dependencies: IContactGroupRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Check user has "contact_groups.create" permission
    - Validate GroupName is unique
    - Create ContactGroup entity
    - Set CreatedBy = current user ID
    - Set CreatedDate = DateTime.UtcNow
    - Save to repository
    - Log creation
    - Return ContactGroupDto

- [ ] **Task 6: Create UpdateContactGroupCommand** (AC: 4, 8)
  - [ ] Create `UpdateContactGroupCommand.cs`
  - [ ] Command properties:
    - ContactGroupId (Guid, required)
    - GroupName (string, optional)
    - Description (string?, nullable)
    - GroupType (string?, nullable)

- [ ] **Task 7: Create UpdateContactGroupCommandHandler** (AC: 4, 8)
  - [ ] Handler logic:
    - Load contact group
    - Check user has "contact_groups.edit" permission
    - Update provided fields
    - Validate GroupName is unique (if changed)
    - Set UpdatedDate = DateTime.UtcNow
    - Save contact group
    - Log update
    - Return ContactGroupDto

- [ ] **Task 8: Create DeleteContactGroupCommand** (AC: 5, 8)
  - [ ] Create `DeleteContactGroupCommand.cs`
  - [ ] Command properties:
    - ContactGroupId (Guid, required)

- [ ] **Task 9: Create DeleteContactGroupCommandHandler** (AC: 5, 8)
  - [ ] Handler logic:
    - Load contact group
    - Check user has "contact_groups.delete" permission
    - Check if group is used in active communications (announcements, messages, file permissions)
    - If used, throw exception: "Cannot delete group that is in use"
    - Delete contact group (cascade deletes members)
    - Log deletion
    - Return success

- [ ] **Task 10: Create GetContactGroupsQuery** (AC: 6, 7)
  - [ ] Create `GetContactGroupsQuery.cs`
  - [ ] Query properties:
    - SearchText (string?, nullable)
    - GroupType (string?, nullable)
    - PageNumber (int, default 1)
    - PageSize (int, default 20)

- [ ] **Task 11: Create GetContactGroupsQueryHandler** (AC: 6, 7)
  - [ ] Handler logic:
    - Query ContactGroups
    - Apply filters: SearchText (name, description), GroupType
    - Include member count (aggregate from ContactGroupMembers)
    - Order by GroupName
    - Paginate results
    - Return ContactGroupListDto

- [ ] **Task 12: Create ContactGroupDto** (AC: 6)
  - [ ] Properties:
    - Id (Guid)
    - GroupName (string)
    - Description (string?)
    - GroupType (string?)
    - MemberCount (int)
    - CreatedByName (string)
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)

- [ ] **Task 13: Create REST API endpoints** (AC: All)
  - [ ] Create `ContactGroupsController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] POST `/api/contact-groups` - CreateContactGroup (AC: 1)
  - [ ] GET `/api/contact-groups` - GetContactGroups (AC: 6, 7)
  - [ ] GET `/api/contact-groups/{id}` - GetContactGroupDetail
  - [ ] PUT `/api/contact-groups/{id}` - UpdateContactGroup (AC: 4)
  - [ ] DELETE `/api/contact-groups/{id}` - DeleteContactGroup (AC: 5)
  - [ ] All require UKNF Employee authentication and permissions

### Frontend Tasks

- [ ] **Task 14: Create contact groups service** (AC: 1)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/contact-groups.service.ts`
  - [ ] Methods:
    - `getContactGroups(search?, groupType?, page?, pageSize?): Observable<PaginatedList<ContactGroupDto>>`
    - `getContactGroupDetail(id): Observable<ContactGroupDetailDto>`
    - `createContactGroup(command): Observable<ContactGroupDto>`
    - `updateContactGroup(id, command): Observable<ContactGroupDto>`
    - `deleteContactGroup(id): Observable<void>`

- [ ] **Task 15: Create contact groups list component** (AC: 6, 7)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/contact-groups/contact-groups-list/contact-groups-list.component.ts`
  - [ ] Configure routing: `/contact-groups` with auth + permission guard
  - [ ] Load groups via contactGroupsService.getContactGroups()
  - [ ] Display table/cards with: Group Name, Description, Type, Member Count
  - [ ] Implement search (by name)
  - [ ] Implement filter (by type)
  - [ ] Implement pagination
  - [ ] Add "Create Contact Group" button

- [ ] **Task 16: Create contact group form component** (AC: 1, 4)
  - [ ] Create `create-contact-group.component.ts` and `edit-contact-group.component.ts` (or single component with mode)
  - [ ] Reactive form with fields:
    - Group Name (input, required, max 250)
    - Description (textarea, optional, max 1000)
    - Group Type (dropdown or input, optional)
  - [ ] Validate Group Name is unique
  - [ ] On submit, call contactGroupsService.createContactGroup() or updateContactGroup()
  - [ ] On success, navigate to group detail or list

- [ ] **Task 17: Implement create contact group** (AC: 1)
  - [ ] Configure routing: `/contact-groups/create`
  - [ ] Form title: "Create Contact Group"
  - [ ] On submit, create contact group
  - [ ] On success, show message and navigate to group detail

- [ ] **Task 18: Implement edit contact group** (AC: 4)
  - [ ] Configure routing: `/contact-groups/:id/edit`
  - [ ] Load group via contactGroupsService.getContactGroupDetail(id)
  - [ ] Pre-populate form
  - [ ] On submit, update contact group
  - [ ] On success, show message and navigate back

- [ ] **Task 19: Implement delete contact group** (AC: 5)
  - [ ] Add "Delete" button on group detail or list
  - [ ] Show confirmation dialog: "Are you sure? This action cannot be undone."
  - [ ] If group is in use, show error: "Cannot delete group that is currently used in communications"
  - [ ] On confirm, call contactGroupsService.deleteContactGroup(id)
  - [ ] On success, navigate to list

- [ ] **Task 20: Style contact groups UI** (AC: 6, 7)
  - [ ] Page title: "Contact Groups"
  - [ ] Search bar and filter dropdown
  - [ ] Table or card grid layout
  - [ ] "Create Contact Group" button (prominent)
  - [ ] Actions: Edit, Delete, View Members
  - [ ] Responsive design
  - [ ] Empty state: "No contact groups found. Create your first group!"

### Testing Tasks

- [ ] **Task 21: Write unit tests for contact group handlers** (AC: All)
  - [ ] Test: `Create_ValidGroup_CreatesContactGroup`
  - [ ] Test: `Create_DuplicateName_ThrowsException`
  - [ ] Test: `Update_ValidGroup_UpdatesContactGroup`
  - [ ] Test: `Delete_UnusedGroup_DeletesContactGroup`
  - [ ] Test: `Delete_GroupInUse_ThrowsException`
  - [ ] Test: `GetContactGroups_FiltersAndSearches`
  - [ ] Mock: IContactGroupRepository, ILogger

- [ ] **Task 22: Write integration tests for contact groups**
  - [ ] Test: `POST_CreateContactGroup_Returns201AndCreates`
  - [ ] Test: `GET_ContactGroups_Returns200WithList`
  - [ ] Test: `PUT_UpdateContactGroup_Returns200AndUpdates`
  - [ ] Test: `DELETE_ContactGroup_UnusedGroup_Returns200AndDeletes`
  - [ ] Test: `DELETE_ContactGroup_GroupInUse_Returns400`
  - [ ] Use Testcontainers
  - [ ] Verify CRUD operations work correctly

---

## Dev Notes

### Group Types (Examples)

Predefined types (configurable):
- "Industry Sector" - e.g., Banks, Insurance Companies
- "Communication List" - e.g., Newsletter Recipients
- "Report Recipients" - e.g., Quarterly Report Recipients
- "Risk Management" - e.g., Risk Officers
- "Custom" - User-defined type

### Unique Group Name

Validate GroupName is unique across all groups:
```csharp
var exists = await _contactGroupRepository.ExistsAsync(command.GroupName);
if (exists)
    throw new ValidationException("Group name already exists");
```

### Cascade Delete

When ContactGroup is deleted, all ContactGroupMembers are automatically deleted (ON DELETE CASCADE).

### Check Group Usage

Before deleting, check if group is used in:
- Announcements (RecipientConfiguration)
- Messages (if Epic 5 uses contact groups)
- File permissions (if Epic 6 uses contact groups)

Query:
```csharp
var isUsed = await _announcementRepository.IsContactGroupUsedAsync(groupId);
if (isUsed)
    throw new BusinessException("Cannot delete group that is in use");
```

### Dependencies

**Prerequisites:**
- **Epic 1**: Authentication
- **Epic 2**: Authorization (permission checks)

**Blocks:**
- **Story 7.13**: Add and Manage Contacts (contacts can be added to groups)
- **Story 7.14**: Assign Contacts to Groups (add/remove members)
- **Story 7.2**: Set Announcement Recipients (use contact groups)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

