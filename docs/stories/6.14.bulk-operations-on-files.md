# Story 6.14: Bulk Operations on Files (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.14  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** perform bulk operations on multiple files,  
**So that** I can manage the Library efficiently.

---

## Acceptance Criteria

1. UKNF Employee can select multiple files using checkboxes
2. Employee can perform bulk actions:
   - Change category
   - Update access permissions (add/remove recipients)
   - Archive files (mark as archival)
   - Delete files
3. System prompts confirmation for bulk actions showing affected file count
4. All bulk actions are logged with timestamp, employee ID, and affected files
5. Changes take effect immediately for all selected files
6. If any file fails validation, error is shown and operation is rolled back or partially applied with report
7. Bulk operations support "Select All" on current page
8. Bulk operations support "Select All" matching current filters (optional)
9. Employee can deselect individual files before performing action
10. Progress indicator shown for operations affecting many files

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create BulkChangeCategoryCommand** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `BulkChangeCategoryCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileIds (List<Guid>, required)
    - NewCategoryId (Guid, required)

- [ ] **Task 2: Create BulkChangeCategoryCommandValidator** (AC: 2, 6)
  - [ ] Create `BulkChangeCategoryCommandValidator.cs` using FluentValidation
  - [ ] Validate FileIds: NotEmpty, Count > 0, AllMustBeValidGuids
  - [ ] Validate NewCategoryId: NotEmpty, MustBeValidGuid
  - [ ] Add async validation: All FileIds must exist
  - [ ] Add async validation: NewCategoryId must exist
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 3: Create BulkChangeCategoryCommandHandler** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `BulkChangeCategoryCommandHandler.cs` implementing `IRequestHandler<BulkChangeCategoryCommand, BulkOperationResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFileChangeHistoryRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Begin transaction
    - Load all files by FileIds
    - For each file:
      - Validate file exists and not deleted
      - If validation fails: add to errors list
      - If validation passes: update CategoryId, create change history
    - Commit transaction if no errors (or partial commit with report if allowed)
    - Log bulk operation (AC: 4)
    - Return BulkOperationResponse with success count, error count, errors

- [ ] **Task 4: Create BulkUpdatePermissionsCommand** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `BulkUpdatePermissionsCommand.cs`
  - [ ] Command properties:
    - FileIds (List<Guid>, required)
    - PermissionsToAdd (List<FilePermissionDto>, nullable)
    - PermissionsToRemove (List<PermissionFilter>, nullable) - e.g., remove all SpecificEntity permissions
    - ReplacePermissions (bool, default false) - replace all permissions vs. add/remove

- [ ] **Task 5: Create BulkUpdatePermissionsCommandValidator** (AC: 2, 6)
  - [ ] Validate FileIds: NotEmpty, Count > 0
  - [ ] Validate at least one of: PermissionsToAdd or PermissionsToRemove
  - [ ] Validate permission DTOs
  - [ ] Add async validation: All FileIds must exist

- [ ] **Task 6: Create BulkUpdatePermissionsCommandHandler** (AC: 2, 3, 4, 5, 6)
  - [ ] Similar logic to single file permission update (Story 6.2)
  - [ ] For each file:
    - Load existing permissions
    - Add/remove/replace permissions
    - Create change history
  - [ ] Transaction and error handling
  - [ ] Return BulkOperationResponse

- [ ] **Task 7: Create BulkDeleteFilesCommand** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `BulkDeleteFilesCommand.cs`
  - [ ] Command properties:
    - FileIds (List<Guid>, required)
    - DeleteReason (string?, nullable)

- [ ] **Task 8: Create BulkDeleteFilesCommandValidator** (AC: 2, 6)
  - [ ] Validate FileIds: NotEmpty, Count > 0
  - [ ] Validate DeleteReason: MaxLength(500) if provided
  - [ ] Add async validation: All FileIds must exist

- [ ] **Task 9: Create BulkDeleteFilesCommandHandler** (AC: 2, 3, 4, 5, 6)
  - [ ] Similar logic to single file deletion (Story 6.8)
  - [ ] For each file:
    - Validate file not already deleted
    - Mark as deleted (soft delete)
    - Create change history
  - [ ] Transaction and error handling
  - [ ] Return BulkOperationResponse

- [ ] **Task 10: Create BulkArchiveFilesCommand** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `BulkArchiveFilesCommand.cs`
  - [ ] Command properties:
    - FileIds (List<Guid>, required)
  - [ ] Note: Manually archive files (not via replacement)

- [ ] **Task 11: Create BulkArchiveFilesCommandValidator** (AC: 2, 6)
  - [ ] Validate FileIds: NotEmpty, Count > 0
  - [ ] Add async validation: All FileIds must exist
  - [ ] Add async validation: All files must be Current (not already Archival)

- [ ] **Task 12: Create BulkArchiveFilesCommandHandler** (AC: 2, 3, 4, 5, 6)
  - [ ] For each file:
    - Validate VersionStatus = Current
    - Mark as Archival (VersionStatus = Archival, ArchivalDate = now)
    - Create change history
  - [ ] Transaction and error handling
  - [ ] Return BulkOperationResponse

- [ ] **Task 13: Create BulkOperationResponse DTO** (AC: 3, 5, 6)
  - [ ] Create `BulkOperationResponse.cs` record
  - [ ] Properties:
    - TotalFiles (int)
    - SuccessCount (int)
    - ErrorCount (int)
    - Errors (List<BulkOperationError>)
    - Message (string)
  - [ ] BulkOperationError properties: FileId (Guid), FileName (string), Error (string)

- [ ] **Task 14: Create REST API endpoints for bulk operations** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] POST /library/files/bulk/change-category
  - [ ] POST /library/files/bulk/update-permissions
  - [ ] POST /library/files/bulk/delete
  - [ ] POST /library/files/bulk/archive
  - [ ] All require `[Authorize(Roles = "UKNFEmployee")]`
  - [ ] Return 200 OK with BulkOperationResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 207 Multi-Status if partial success (some failed)
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 15: Implement transaction handling for bulk operations** (AC: 5, 6)
  - [ ] Option A: All or nothing (full rollback on any error)
  - [ ] Option B: Partial commit (apply successful, report errors)
  - [ ] Recommendation: Option B with detailed error report
  - [ ] Return which files succeeded and which failed

- [ ] **Task 16: Implement bulk operation logging** (AC: 4)
  - [ ] Log each bulk operation with:
    - Operation type
    - File count
    - Success/error counts
    - Employee ID
    - Timestamp
  - [ ] Create change history for each affected file

### Frontend Tasks

- [ ] **Task 17: Add file selection checkboxes** (AC: 1, 7, 9)
  - [ ] Update `library-list.component.ts` (Story 6.3)
  - [ ] Add checkbox column (first column)
  - [ ] Master checkbox in header: "Select All" on current page (AC: 7)
  - [ ] Individual checkboxes for each file
  - [ ] Track selected file IDs
  - [ ] Show selected count: "X files selected"

- [ ] **Task 18: Add bulk actions toolbar** (AC: 1, 2, 9)
  - [ ] Show toolbar when files selected
  - [ ] Position: Above or below library list
  - [ ] Actions:
    - Change Category (dropdown)
    - Update Permissions (opens dialog)
    - Archive Files (button)
    - Delete Files (button)
  - [ ] "Deselect All" button (AC: 9)
  - [ ] Show selected count

- [ ] **Task 19: Create bulk confirmation dialogs** (AC: 3)
  - [ ] Confirmation dialog for each bulk action
  - [ ] Show: Action, affected file count, file names (truncated list)
  - [ ] Example: "Archive 15 files? This cannot be undone easily."
  - [ ] Require explicit confirmation
  - [ ] Cancel and Confirm buttons

- [ ] **Task 20: Create bulk change category dialog** (AC: 2, 3)
  - [ ] Dialog with category dropdown
  - [ ] Show selected file count
  - [ ] Preview: "X files will be moved to category Y"
  - [ ] Confirm and Cancel buttons

- [ ] **Task 21: Create bulk update permissions dialog** (AC: 2, 3)
  - [ ] Similar to single file permissions (Story 6.2)
  - [ ] Options:
    - Add permissions (without removing existing)
    - Remove permissions (keep other existing)
    - Replace all permissions (set same for all files)
  - [ ] Show affected file count
  - [ ] Confirm and Cancel buttons

- [ ] **Task 22: Create bulk delete confirmation dialog** (AC: 2, 3)
  - [ ] Show warning: "Delete X files?"
  - [ ] List file names (scrollable)
  - [ ] Optional delete reason input
  - [ ] Require typing "DELETE" to confirm (if count > 10)
  - [ ] Confirm and Cancel buttons (danger style)

- [ ] **Task 23: Implement progress indicator** (AC: 10)
  - [ ] Show progress bar or spinner during bulk operation
  - [ ] Display: "Processing X of Y files..."
  - [ ] Disable UI during operation
  - [ ] Show completion message or errors

- [ ] **Task 24: Display bulk operation results** (AC: 5, 6)
  - [ ] Success notification: "X files updated successfully"
  - [ ] If errors: Show error dialog or notification
    - List files that failed with error messages
    - Show success count and error count
    - Option to retry failed files
  - [ ] Refresh library list after operation

- [ ] **Task 25: Implement "Select All" matching filters** (AC: 8, optional)
  - [ ] "Select All X files matching current filters" option
  - [ ] Warning: "This will select X files (more than currently displayed)"
  - [ ] Confirm before selecting
  - [ ] Load all matching file IDs from backend

- [ ] **Task 26: Update library service** (AC: 2)
  - [ ] Add methods to `library.service.ts`:
    - bulkChangeCategory(fileIds: string[], categoryId: string): Observable<BulkOperationResponse>
    - bulkUpdatePermissions(fileIds: string[], permissions: PermissionUpdate): Observable<BulkOperationResponse>
    - bulkDeleteFiles(fileIds: string[], reason?: string): Observable<BulkOperationResponse>
    - bulkArchiveFiles(fileIds: string[]): Observable<BulkOperationResponse>
  - [ ] Handle API errors

- [ ] **Task 27: Handle deselection** (AC: 9)
  - [ ] Click checkbox to deselect individual file
  - [ ] "Deselect All" button clears all selections
  - [ ] Update selected count dynamically

- [ ] **Task 28: Implement keyboard shortcuts** (AC: 1)
  - [ ] Ctrl+A / Cmd+A: Select all on page
  - [ ] Shift+Click: Select range
  - [ ] Escape: Deselect all

### Testing Tasks

- [ ] **Task 29: Unit tests for bulk command handlers** (AC: 2, 4, 5, 6)
  - [ ] Test bulk change category
  - [ ] Test bulk update permissions
  - [ ] Test bulk delete
  - [ ] Test bulk archive
  - [ ] Test transaction handling (all or nothing vs. partial)
  - [ ] Test error handling (some files fail validation)
  - [ ] Test logging

- [ ] **Task 30: Unit tests for validators** (AC: 2, 6)
  - [ ] Test FileIds validation
  - [ ] Test file count validation
  - [ ] Test all files must exist
  - [ ] Test user must be UKNF Employee

- [ ] **Task 31: Integration tests for API endpoints** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Test bulk operations with valid data
  - [ ] Test bulk operations require UKNF Employee role (403 if not)
  - [ ] Test bulk operations return success count and error count
  - [ ] Test partial success scenarios
  - [ ] Test change history created for all affected files
  - [ ] Test 207 Multi-Status for partial success

- [ ] **Task 32: Frontend unit tests** (AC: 1, 2, 7, 9, 10)
  - [ ] Test file selection checkboxes
  - [ ] Test "Select All" checkbox
  - [ ] Test bulk actions toolbar
  - [ ] Test confirmation dialogs
  - [ ] Test progress indicator
  - [ ] Test result display (success/errors)
  - [ ] Test service method calls

- [ ] **Task 33: E2E tests** (AC: 1-10)
  - [ ] Test complete bulk operation flow
  - [ ] Test selecting multiple files
  - [ ] Test bulk change category
  - [ ] Test bulk update permissions
  - [ ] Test bulk delete
  - [ ] Test bulk archive
  - [ ] Test confirmation dialogs
  - [ ] Test error handling
  - [ ] Test deselection

### Documentation Tasks

- [ ] **Task 34: API documentation** (AC: 2, 4)
  - [ ] Document all bulk operation endpoints
  - [ ] Include request/response examples
  - [ ] Document error responses
  - [ ] Document 207 Multi-Status response
  - [ ] Document authentication requirements

- [ ] **Task 35: Developer documentation** (AC: 5, 6)
  - [ ] Document bulk operation implementation
  - [ ] Document transaction handling strategy
  - [ ] Document error handling and partial success
  - [ ] Document logging approach

- [ ] **Task 36: User documentation** (AC: 1, 2, 3)
  - [ ] Create user guide for bulk operations
  - [ ] Explain how to select multiple files
  - [ ] Document each bulk action
  - [ ] Include screenshots

---

## Technical Notes

### Transaction Handling Strategy

**Option A: All or Nothing**
- Single transaction for all files
- If any file fails, rollback entire operation
- Pros: Data consistency, simpler logic
- Cons: One error prevents all changes

**Option B: Partial Commit with Report**
- Try to apply each file individually
- Track successes and failures
- Commit successful changes, report errors
- Pros: More files processed, failures don't block others
- Cons: Partial state, more complex logic

**Recommendation: Option B** - More practical for bulk operations.

Implementation:
```csharp
var results = new BulkOperationResult();
foreach (var fileId in command.FileIds)
{
    try
    {
        // Validate and update file
        // Create change history
        results.SuccessCount++;
    }
    catch (Exception ex)
    {
        results.Errors.Add(new BulkOperationError(fileId, fileName, ex.Message));
        results.ErrorCount++;
    }
}
// Return results with successes and errors
```

### HTTP Status Codes

- **200 OK**: All files processed successfully
- **207 Multi-Status**: Partial success (some files failed)
- **400 Bad Request**: Validation errors (all files)
- **403 Forbidden**: Not UKNF Employee
- **422 Unprocessable Entity**: Business rule violations

### Bulk Operation Logging

Log bulk operation as single event:
```
Operation: BulkChangeCategory
FileCount: 15
SuccessCount: 14
ErrorCount: 1
ChangedBy: Jan Kowalski (ID: abc123)
Timestamp: 2025-01-15 10:30:00
```

Individual file changes logged in FileChangeHistory.

### Performance Considerations

- Bulk operations on 100s of files can be slow
- Consider background job for very large operations (> 100 files)
- Show progress indicator for operations > 10 files
- Optimize database queries (batch updates)
- Use transactions efficiently

### Error Handling

Common errors:
- File not found
- File already deleted
- File already archival (for archive operation)
- Category not found
- Permission validation failed

Return detailed error per file:
```json
{
  "totalFiles": 15,
  "successCount": 14,
  "errorCount": 1,
  "errors": [
    {
      "fileId": "...",
      "fileName": "Template.xlsx",
      "error": "File already archived"
    }
  ]
}
```

### UI/UX Considerations

- Checkboxes should be obvious and easy to use
- Show selected count prominently
- Confirmation dialogs prevent accidental bulk actions
- List affected files in confirmation (at least first 10)
- Progress indicator for transparency
- Clear error messages for failures
- Allow retry for failed files (optional)
- "Select All" should be clear (all on page vs. all matching filters)

### Security Considerations

- Only UKNF Employees can perform bulk operations
- Validate all file IDs (ensure they exist and not deleted)
- Log all bulk operations comprehensively
- Confirm destructive operations (delete, archive)
- Rate limit bulk operations to prevent abuse

### Keyboard Shortcuts

Improve efficiency:
- **Ctrl+A / Cmd+A**: Select all on page
- **Shift+Click**: Select range of files
- **Escape**: Deselect all
- **Delete**: Trigger bulk delete (with confirmation)

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files to operate on)
- **All management stories**: Bulk operations use same logic as individual operations
- **Epic 1**: Authentication (UKNF Employee role identification)

### Integrates With
- **Story 6.2**: Set File Access Permissions (bulk permissions)
- **Story 6.6**: Update File Metadata (bulk metadata - category)
- **Story 6.7**: Replace File (bulk archival concept)
- **Story 6.8**: Delete File (bulk deletion)
- **Story 6.9**: Categorize Files (bulk category change)

---

## Acceptance Checklist

- [ ] UKNF Employee can select multiple files with checkboxes
- [ ] Employee can change category for selected files
- [ ] Employee can update permissions for selected files
- [ ] Employee can archive selected files
- [ ] Employee can delete selected files
- [ ] System prompts confirmation showing affected file count
- [ ] All bulk actions are logged
- [ ] Changes take effect immediately for all selected files
- [ ] Errors shown with detailed report if any file fails
- [ ] "Select All" works on current page
- [ ] "Select All" matching filters works (optional)
- [ ] Employee can deselect individual files
- [ ] Progress indicator shown for large operations
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.2**: Set File Access Permissions (bulk permissions)
- **Story 6.6**: Update File Metadata (bulk category)
- **Story 6.8**: Delete File (bulk deletion)
- **Story 6.9**: Categorize Files (bulk category change)

---

## Notes

- Bulk operations critical for efficiency (managing 100s of files)
- Partial success with detailed error report more practical than all-or-nothing
- Confirmation dialogs prevent accidental bulk actions
- Progress indicator important for transparency
- Test with various file counts (5, 50, 500)
- Consider background jobs for very large operations (> 100 files)
- Monitor performance and optimize database queries
- Log comprehensively for audit
- Keyboard shortcuts improve power user efficiency
- Consider undo functionality (restore from change history - future)
- Document best practices (don't bulk delete without backup, etc.)

