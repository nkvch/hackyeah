# Story 4.3: Display Validation Results

**Epic:** 4 - Reporting System  
**Story Number:** 4.3  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** Employee of a Supervised Entity or UKNF Employee,  
**I want to** view the validation results for a submitted report,  
**So that** I can understand if the report was accepted or needs corrections.

---

## Acceptance Criteria

1. User can view report details including current validation status
2. System displays appropriate status from the validation statuses table
3. For "Successful validation process" status, system shows success message and timestamp
4. For "Errors from validation rules" status, system displays:
   - List of validation errors with descriptions
   - Line/field references where errors occurred
   - Suggested corrections (if provided by validator)
5. For "Technical error in validation process", system displays technical error details
6. For "Error - Exceeded time", system displays timeout message
7. For "Contested by UKNF", system displays UKNF's description of irregularities
8. System attaches validation result file (if provided by external service) for download
9. Validation result file includes: UKNF markings, receipt date, validation date, entity name
10. System displays validation history if report was resubmitted

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetReportDetailsQuery** (AC: 1, 2)
  - [ ] Create `GetReportDetailsQuery.cs` in `Application/UknfPlatform.Application.Communication/Reports/Queries/`
  - [ ] Query properties:
    - ReportId (Guid, required)
  - [ ] Note: User authorization checked in handler

- [ ] **Task 2: Create GetReportDetailsQueryHandler** (AC: 1, 2, 3, 4, 5, 6, 7, 8, 10)
  - [ ] Create `GetReportDetailsQueryHandler.cs` implementing `IRequestHandler<GetReportDetailsQuery, ReportDetailsResponse>`
  - [ ] Inject dependencies: IReportRepository, IValidationResultRepository, ICurrentUserService, IEntityRepository, ILogger
  - [ ] Handler logic:
    - Fetch report by ID
    - Check authorization: User must have access to report's entity (external users) or be UKNF employee
    - Fetch related ValidationResult (if exists)
    - Fetch submitter user details
    - Fetch entity details
    - Fetch correction reports (if this report has corrections linked to it)
    - Fetch original report (if this is a correction)
    - Fetch validation history (all validation attempts)
    - Map to ReportDetailsResponse DTO
  - [ ] Return 404 if report not found
  - [ ] Return 403 if user lacks access

- [ ] **Task 3: Create ReportDetailsResponse DTO** (AC: All)
  - [ ] Create `ReportDetailsResponse.cs` record in `Application/UknfPlatform.Application.Communication/Reports/DTOs/`
  - [ ] Properties:
    - ReportId (Guid)
    - FileName (string)
    - FileSize (long) - in bytes
    - ReportType (string)
    - ReportingPeriod (string)
    - ValidationStatus (string)
    - ValidationStatusDisplayName (string) - user-friendly name
    - UniqueValidationId (string?)
    - SubmittedDate (DateTime)
    - ValidationStartedDate (DateTime?)
    - ValidationCompletedDate (DateTime?)
    - Entity (EntitySummary) - ID, Name, UknfCode
    - Submitter (UserSummary) - Name, Email, Phone
    - ValidationResult (ValidationResultDto?) - errors, warnings, metadata
    - ValidationResultFileUrl (string?) - download URL for result PDF
    - IsArchived (bool)
    - IsCorrectionOf (Guid?) - original report ID if this is a correction
    - OriginalReportSummary (ReportSummary?) - if this is a correction
    - Corrections (List<ReportSummary>) - if corrections were submitted
    - ContestedDescription (string?) - if contested by UKNF
    - ContestedByUser (UserSummary?) - UKNF employee who contested
    - ContestedDate (DateTime?) - when contested
    - ValidationHistory (List<ValidationHistoryItem>) - all validation attempts
    - CanDownloadFile (bool) - permission check
    - CanDownloadResultPdf (bool) - permission check
    - CanSubmitCorrection (bool) - if status allows corrections

- [ ] **Task 4: Create ValidationResultDto** (AC: 4)
  - [ ] Create `ValidationResultDto.cs` record
  - [ ] Properties:
    - IsValid (bool)
    - Errors (List<ValidationErrorDto>)
    - Warnings (List<ValidationWarningDto>)
    - ExtractedMetadata (Dictionary<string, object>?)
  - [ ] ValidationErrorDto:
    - Code (string?) - error code/reference
    - Description (string) - error description
    - Location (string?) - worksheet, row, column
    - FieldName (string?) - field that failed
    - SuggestedCorrection (string?) - how to fix
  - [ ] ValidationWarningDto:
    - Description (string)
    - Location (string?)

- [ ] **Task 5: Create REST API endpoint GET /api/reports/{id}** (AC: 1)
  - [ ] Update `ReportsController.cs`
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetReportDetailsAsync(Guid id)`
  - [ ] Inject IMediator
  - [ ] Send GetReportDetailsQuery
  - [ ] Return 200 OK with ReportDetailsResponse
  - [ ] Return 404 Not Found if report doesn't exist
  - [ ] Return 403 Forbidden if user lacks access
  - [ ] Add XML documentation comments
  - [ ] Add Swagger annotations

- [ ] **Task 6: Create REST API endpoint GET /api/reports/{id}/validation-result** (AC: 8)
  - [ ] Update `ReportsController.cs`
  - [ ] Create GET action `DownloadValidationResultAsync(Guid id)`
  - [ ] Handler logic:
    - Fetch report by ID
    - Check authorization (same as Task 2)
    - Check if validation result PDF exists
    - Get file from storage service
    - Return File result with content type "application/pdf"
    - Set Content-Disposition header: `attachment; filename="validation-result-{reportId}.pdf"`
  - [ ] Return 404 if result PDF not available yet
  - [ ] Return 403 if user lacks access

- [ ] **Task 7: Create REST API endpoint GET /api/reports/{id}/download** (AC: Related)
  - [ ] Update `ReportsController.cs`
  - [ ] Create GET action `DownloadReportFileAsync(Guid id)`
  - [ ] Handler logic:
    - Fetch report by ID
    - Check authorization
    - Get file from storage service using FileStorageKey
    - Return File result with content type "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    - Set Content-Disposition header: `attachment; filename="{originalFileName}"`
    - Log file download for audit
  - [ ] Return 404 if file not found
  - [ ] Return 403 if user lacks access

- [ ] **Task 8: Implement authorization check** (AC: 1)
  - [ ] External users can only view reports for their entities
  - [ ] UKNF employees can view all reports
  - [ ] Check via ICurrentUserService and IPermissionService
  - [ ] Permission: "communication.reports.view"

- [ ] **Task 9: Create status display helper** (AC: 2, 3, 4, 5, 6, 7)
  - [ ] Create `ValidationStatusHelper.cs` utility class
  - [ ] Method: `GetStatusDisplayInfo(validationStatus): StatusDisplayInfo`
  - [ ] Return object with:
    - DisplayName (string) - user-friendly name
    - Description (string) - detailed explanation
    - Icon (string) - icon name or CSS class
    - Color (string) - status color (success, error, warning, info)
  - [ ] Map statuses:
    - Working → "Processing" (info, blue)
    - Transmitted → "Submitted for Validation" (info, blue)
    - Ongoing → "Validation in Progress" (info, blue, spinner)
    - Successful → "Validation Successful" (success, green, checkmark)
    - ValidationErrors → "Validation Errors Detected" (error, red, x-mark)
    - TechnicalError → "Technical Error" (error, red, alert)
    - TimeoutError → "Validation Timeout" (warning, orange, clock)
    - ContestedByUKNF → "Contested by UKNF" (warning, orange, flag)

### Frontend Tasks

- [ ] **Task 10: Create reports service methods** (AC: 1, 8)
  - [ ] Update `reports.service.ts`
  - [ ] Method: `getReportDetails(reportId): Observable<ReportDetailsResponse>`
  - [ ] Method: `downloadReportFile(reportId): Observable<Blob>`
  - [ ] Method: `downloadValidationResult(reportId): Observable<Blob>`
  - [ ] Handle errors with catchError
  - [ ] Use HttpClient for file downloads

- [ ] **Task 11: Create report details component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/reporting/report-details/report-details.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/reports/:id` with auth guard
  - [ ] Inject ActivatedRoute to get report ID from URL
  - [ ] Inject ReportsService
  - [ ] Load report details on init
  - [ ] Display loading spinner while fetching
  - [ ] Handle errors (not found, forbidden)

- [ ] **Task 12: Display validation status** (AC: 2, 3, 5, 6, 7)
  - [ ] Show status badge with appropriate color and icon
  - [ ] Status-specific displays:
    - **Working/Transmitted/Ongoing:** Show spinner, "Validation in progress..."
    - **Successful:** Green checkmark, "Report validated successfully", timestamp
    - **ValidationErrors:** Red error icon, "Validation errors detected", error count
    - **TechnicalError:** Orange alert icon, "Technical error during validation", retry message
    - **TimeoutError:** Orange clock icon, "Validation timeout after 24 hours", support message
    - **ContestedByUKNF:** Orange flag icon, "Contested by UKNF", show contest description
  - [ ] Use PrimeNG Badge or Tag component
  - [ ] Add status icon (PrimeIcons)

- [ ] **Task 13: Display validation errors** (AC: 4)
  - [ ] Show errors section only if status is "ValidationErrors"
  - [ ] Display errors in expandable list or table
  - [ ] For each error, show:
    - Error code/reference (if available)
    - Description
    - Location (worksheet, row, column)
    - Field name
    - Suggested correction (if available)
  - [ ] Use PrimeNG DataView or Card for error list
  - [ ] Highlight critical errors vs warnings
  - [ ] Show total error count
  - [ ] Add "Download Full Report" button to get PDF with all details

- [ ] **Task 14: Display validation warnings** (AC: 4)
  - [ ] Show warnings section if warnings exist
  - [ ] Display warnings in collapsible panel (less prominent than errors)
  - [ ] Warnings don't prevent report acceptance
  - [ ] Use PrimeNG Message or InlineMessage component

- [ ] **Task 15: Display report metadata** (AC: 1, 9)
  - [ ] Show report information card:
    - Report file name
    - File size (human-readable format)
    - Report type
    - Reporting period
    - Submission date and time
    - Unique validation ID
    - Entity name and UKNF code
    - Submitter name, email, phone
  - [ ] Use PrimeNG Card or Panel
  - [ ] Format dates with DatePipe
  - [ ] Format file size (bytes → MB)

- [ ] **Task 16: Display validation timeline** (AC: 10)
  - [ ] Show validation history/timeline
  - [ ] Display key events:
    - Report submitted (SubmittedDate)
    - Validation started (ValidationStartedDate)
    - Validation completed (ValidationCompletedDate)
    - Status changes
  - [ ] Use PrimeNG Timeline component
  - [ ] Show duration between steps
  - [ ] If report resubmitted (correction), show all validation attempts

- [ ] **Task 17: Implement file download buttons** (AC: 8)
  - [ ] "Download Report File" button
    - Calls reportsService.downloadReportFile(reportId)
    - Saves XLSX file with original filename
    - Show loading spinner during download
  - [ ] "Download Validation Result" button
    - Only visible if validation result PDF exists
    - Calls reportsService.downloadValidationResult(reportId)
    - Saves PDF file as "validation-result-{reportId}.pdf"
    - Show loading spinner during download
  - [ ] Use FileSaver.js or native download
  - [ ] Handle download errors
  - [ ] Disable buttons if user lacks permission

- [ ] **Task 18: Display correction information** (AC: 10)
  - [ ] If this is a correction (IsCorrectionOf is not null):
    - Show "This is a correction of report: [Original Report Link]"
    - Link to original report details
  - [ ] If this report has corrections:
    - Show "Corrections Submitted" section
    - List all correction reports with links
    - Show correction submission dates
    - Show validation status of each correction

- [ ] **Task 19: Display contested information** (AC: 7)
  - [ ] If status is "ContestedByUKNF":
    - Show prominent warning panel
    - Message: "This report has been contested by UKNF"
    - Display contest description (why it was contested)
    - Show UKNF employee name who contested
    - Show contest date
    - Display action message: "Please submit a correction or contact UKNF for clarification"
  - [ ] Use PrimeNG Message component with severity "warn"

- [ ] **Task 20: Add "Submit Correction" button** (AC: Related)
  - [ ] Show if report has errors or is contested
  - [ ] Navigate to correction submission (Story 4.4)
  - [ ] Only visible if user has permission to submit corrections
  - [ ] Button text: "Submit Correction"

- [ ] **Task 21: Implement real-time status updates** (AC: 2)
  - [ ] Subscribe to SignalR notifications (from Story 4.2)
  - [ ] When status update received for this report:
    - Refresh report details
    - Show notification toast
    - Update status badge without full page reload
    - If status changed to final state (Successful/Errors), show completion message
  - [ ] Unsubscribe on component destroy

- [ ] **Task 22: Create page layout** (AC: All)
  - [ ] Page title: "Report Details"
  - [ ] Breadcrumb: Reports > Report Details
  - [ ] Layout sections:
    - Header with report name and status badge
    - Metadata card (entity, submitter, dates)
    - Status section (status-specific content)
    - Validation errors section (if applicable)
    - Validation warnings section (if applicable)
    - Validation timeline
    - Corrections section (if applicable)
    - Contested section (if applicable)
    - Actions (download buttons, submit correction)
  - [ ] Use PrimeNG Card, Panel, Divider components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 23: Add error handling** (AC: 1)
  - [ ] Handle 404 Not Found:
    - Display "Report not found" message
    - Provide link to reports list
  - [ ] Handle 403 Forbidden:
    - Display "You don't have permission to view this report"
    - Provide link back
  - [ ] Handle network errors:
    - Display error message
    - Provide retry button

### Testing Tasks

- [ ] **Task 24: Write unit tests for GetReportDetailsQueryHandler**
  - [ ] Test: `Handle_ValidReportId_ReturnsDetails`
  - [ ] Test: `Handle_ReportNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_ExternalUserAccessOwnEntity_ReturnsDetails`
  - [ ] Test: `Handle_ExternalUserAccessOtherEntity_ThrowsForbiddenException`
  - [ ] Test: `Handle_UknfEmployeeAccessAnyReport_ReturnsDetails`
  - [ ] Test: `Handle_IncludesValidationResult`
  - [ ] Test: `Handle_IncludesCorrections`
  - [ ] Test: `Handle_IncludesContestedInfo`
  - [ ] Mock: IReportRepository, IValidationResultRepository, ICurrentUserService

- [ ] **Task 25: Write unit tests for file download endpoints**
  - [ ] Test: `DownloadReportFile_ValidRequest_ReturnsFile`
  - [ ] Test: `DownloadReportFile_FileNotFound_Returns404`
  - [ ] Test: `DownloadReportFile_Unauthorized_Returns403`
  - [ ] Test: `DownloadValidationResult_ResultNotAvailable_Returns404`
  - [ ] Mock: IFileStorageService

- [ ] **Task 26: Write integration test for report details endpoint**
  - [ ] Test: `GET_ReportDetails_ValidReport_Returns200WithDetails`
  - [ ] Test: `GET_ReportDetails_WithValidationErrors_IncludesErrors`
  - [ ] Test: `GET_ReportDetails_WithCorrections_IncludesCorrections`
  - [ ] Test: `GET_ReportDetails_ContestedReport_IncludesContestedInfo`
  - [ ] Test: `GET_ReportDetails_Unauthorized_Returns403`
  - [ ] Use Testcontainers for database
  - [ ] Verify all nested data loaded correctly

- [ ] **Task 27: Write integration test for file downloads**
  - [ ] Test: `GET_DownloadReportFile_ValidRequest_ReturnsXlsxFile`
  - [ ] Test: `GET_DownloadValidationResult_ValidRequest_ReturnsPdfFile`
  - [ ] Verify Content-Type headers
  - [ ] Verify Content-Disposition headers
  - [ ] Verify file content matches original

- [ ] **Task 28: Write E2E test for report details flow**
  - [ ] Test workflow:
    1. Login as external user
    2. Navigate to reports list
    3. Click on a report with "Successful" status
    4. Verify report details page loads
    5. Verify status badge shows "Validation Successful"
    6. Verify all metadata displayed
    7. Click "Download Report File"
    8. Verify file downloads
    9. Click "Download Validation Result"
    10. Verify PDF downloads
  - [ ] Test validation errors display:
    1. Navigate to report with "ValidationErrors" status
    2. Verify errors section visible
    3. Verify errors list displays
    4. Verify "Submit Correction" button visible
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.1:**
- Report submission creates Report entity
- File uploaded to blob storage
- Initial status is "Working"

**From Story 4.2:**
- Validation process updates status through lifecycle
- ValidationResult entity stores detailed results
- Validation result PDF generated and stored
- Real-time updates via SignalR

**Key Integration:**
- This story is the user-facing view of validation results
- Story 4.4 (Submit Correction) is triggered from this page
- Stories 4.5/4.6 (Reports Lists) link to this page

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG (Badge, Card, Timeline, Message, DataView)
- Real-time: @microsoft/signalr 8.0.0
- Styling: Tailwind CSS
- File downloads: FileSaver.js or native download

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── ReportsController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Reports/
│   ├── Queries/
│   │   ├── GetReportDetailsQuery.cs (CREATE)
│   │   └── GetReportDetailsQueryHandler.cs (CREATE)
│   ├── DTOs/
│   │   ├── ReportDetailsResponse.cs (CREATE)
│   │   └── ValidationResultDto.cs (CREATE)
│   └── Helpers/
│       └── ValidationStatusHelper.cs (CREATE)
└── Tests/UknfPlatform.Tests.Integration/Reports/
    ├── GetReportDetailsTests.cs (CREATE)
    └── DownloadReportFileTests.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
├── features/reporting/report-details/
│   ├── report-details.component.ts (CREATE)
│   ├── report-details.component.html (CREATE)
│   ├── report-details.component.scss (CREATE)
│   └── components/
│       ├── validation-errors-list.component.ts (CREATE)
│       ├── validation-timeline.component.ts (CREATE)
│       └── report-metadata-card.component.ts (CREATE)
└── core/guards/
    └── auth.guard.ts (UPDATE - report details route)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Report Entity:**
- All fields from Story 4.1
- ValidationStatus enum (8 possible values)
- ValidationResultFileKey for result PDF
- ContestedDescription, ContestedByUserId, ContestedDate for contested reports
- IsCorrectionOfReportId for correction chain

**ValidationResult Entity:**
- From Story 4.2
- Errors and Warnings as JSON arrays
- ExtractedMetadata as JSON object
- ResultFileStorageKey for PDF

**Relationships:**
- Report → Entity (Many-to-One)
- Report → User (Many-to-One, submitter)
- Report → ValidationResult (One-to-One or One-to-Many)
- Report → Report (self-reference for corrections)

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint 1:** GET `/api/reports/{id}`
- **Security:** Requires authentication + authorization
- **Success Response (200 OK):**
  ```json
  {
    "reportId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "fileName": "G. RIP100000_Q1_2025.xlsx",
    "fileSize": 2457600,
    "reportType": "Quarterly",
    "reportingPeriod": "Q1_2025",
    "validationStatus": "Successful",
    "validationStatusDisplayName": "Validation Successful",
    "uniqueValidationId": "VAL-2025-001234",
    "submittedDate": "2025-10-04T10:00:00Z",
    "validationStartedDate": "2025-10-04T10:00:05Z",
    "validationCompletedDate": "2025-10-04T10:00:12Z",
    "entity": {
      "id": 1001,
      "name": "Example Bank S.A.",
      "uknfCode": "G. RIP100000"
    },
    "submitter": {
      "name": "Jan Kowalski",
      "email": "jan.kowalski@example.com",
      "phone": "+48123456789"
    },
    "validationResult": {
      "isValid": true,
      "errors": [],
      "warnings": [],
      "extractedMetadata": {
        "totalAssets": "1250000000",
        "reportDate": "2025-03-31"
      }
    },
    "validationResultFileUrl": "/api/reports/3fa85f64-5717-4562-b3fc-2c963f66afa6/validation-result",
    "isArchived": false,
    "isCorrectionOf": null,
    "corrections": [],
    "contestedDescription": null,
    "canDownloadFile": true,
    "canDownloadResultPdf": true,
    "canSubmitCorrection": false
  }
  ```

**Endpoint 2:** GET `/api/reports/{id}/download`
- **Security:** Requires authentication + authorization
- **Success Response (200 OK):**
  - Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
  - Content-Disposition: `attachment; filename="G. RIP100000_Q1_2025.xlsx"`
  - Body: Binary XLSX file

**Endpoint 3:** GET `/api/reports/{id}/validation-result`
- **Security:** Requires authentication + authorization
- **Success Response (200 OK):**
  - Content-Type: `application/pdf`
  - Content-Disposition: `attachment; filename="validation-result-{reportId}.pdf"`
  - Body: Binary PDF file
- **Error Response (404):** Validation result not available yet

### Validation Statuses Display

**Source:** `docs/prd/epic-4-reporting-system.md`

| Status | Display Name | Color | Icon | Description |
|--------|-------------|-------|------|-------------|
| Working | Processing | Blue | spinner | Report file is being processed |
| Transmitted | Submitted | Blue | paper-plane | Report sent to validation service |
| Ongoing | Validating | Blue | spinner | Validation in progress |
| Successful | Validated | Green | check-circle | Report passed all validation checks |
| ValidationErrors | Errors Detected | Red | times-circle | Validation errors found, correction needed |
| TechnicalError | Technical Error | Orange | exclamation-triangle | System error during validation |
| TimeoutError | Timeout | Orange | clock | Validation exceeded 24-hour limit |
| ContestedByUKNF | Contested | Orange | flag | Manually challenged by UKNF employee |

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Authorization checks for file downloads**
   ```csharp
   // ✅ CORRECT - Check before serving file
   if (!await _permissionService.CanAccessReportAsync(userId, report.EntityId))
       return Forbid();
   
   var stream = await _fileStorageService.DownloadFileAsync(report.FileStorageKey);
   return File(stream, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", report.FileName);
   ```

2. **Use streaming for large file downloads**
   ```csharp
   // ✅ CORRECT - Stream files, don't load in memory
   var stream = await _fileStorageService.DownloadFileAsync(fileKey);
   return File(stream, contentType, fileName);
   
   // ❌ WRONG - Don't load entire file
   // var bytes = await _fileStorageService.DownloadFileBytesAsync(fileKey);
   ```

3. **Sanitize user-facing error messages**
   ```csharp
   // ✅ CORRECT - Generic message for users
   response.ErrorMessage = "Technical error during validation. Please contact support.";
   
   // ❌ WRONG - Don't expose internal details
   // response.ErrorMessage = exception.ToString();
   ```

4. **Format dates consistently (ISO 8601 UTC)**
   ```csharp
   // ✅ CORRECT
   response.SubmittedDate = report.SubmittedDate; // DateTime stored in UTC
   
   // Frontend displays in user's local timezone
   ```

5. **Check permissions before showing actions**
   ```csharp
   // ✅ CORRECT
   response.CanDownloadFile = await _permissionService.HasPermissionAsync(userId, "communication.reports.view");
   response.CanSubmitCorrection = report.ValidationStatus == ValidationStatus.ValidationErrors 
       && await _permissionService.HasPermissionAsync(userId, "communication.reports.submit");
   ```

### File Download Implementation

**Backend (ASP.NET Core):**
```csharp
[HttpGet("{id}/download")]
[Authorize]
public async Task<IActionResult> DownloadReportFileAsync(Guid id)
{
    var report = await _reportRepository.GetByIdAsync(id);
    if (report == null)
        return NotFound();
    
    // Authorization check
    if (!await _authorizationService.CanAccessReportAsync(User, report))
        return Forbid();
    
    // Stream file from storage
    var stream = await _fileStorageService.DownloadFileAsync(report.FileStorageKey);
    
    // Log download for audit
    await _auditService.LogFileDownloadAsync(report.Id, _currentUserService.UserId);
    
    return File(stream, 
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
        report.FileName);
}
```

**Frontend (Angular):**
```typescript
downloadReportFile(reportId: string): void {
  this.isDownloading = true;
  this.reportsService.downloadReportFile(reportId).subscribe({
    next: (blob: Blob) => {
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = this.report.fileName;
      link.click();
      window.URL.revokeObjectURL(url);
      this.notificationService.showSuccess('File downloaded successfully');
      this.isDownloading = false;
    },
    error: (err) => {
      this.notificationService.showError('Failed to download file');
      this.isDownloading = false;
    }
  });
}
```

### PrimeNG Components

**Status Badge:**
```html
<p-tag 
  [value]="report.validationStatusDisplayName" 
  [severity]="getStatusSeverity(report.validationStatus)"
  [icon]="getStatusIcon(report.validationStatus)">
</p-tag>
```

**Validation Errors List:**
```html
<p-dataView [value]="validationResult.errors" layout="list">
  <ng-template let-error pTemplate="listItem">
    <div class="error-item">
      <i class="pi pi-times-circle text-red-500"></i>
      <div>
        <strong>{{ error.description }}</strong>
        <p *ngIf="error.location" class="text-sm text-gray-600">
          Location: {{ error.location }}
        </p>
        <p *ngIf="error.suggestedCorrection" class="text-sm text-blue-600">
          Suggested fix: {{ error.suggestedCorrection }}
        </p>
      </div>
    </div>
  </ng-template>
</p-dataView>
```

**Timeline:**
```html
<p-timeline [value]="validationHistory" align="left">
  <ng-template pTemplate="content" let-event>
    <small class="text-gray-600">{{ event.timestamp | date:'short' }}</small>
    <div>{{ event.description }}</div>
  </ng-template>
</p-timeline>
```

### Security Requirements

- Only authenticated users can view report details
- External users can only view reports for their entities
- UKNF employees can view all reports
- File downloads require same authorization as viewing
- Audit all file downloads
- Sensitive error details (stack traces) not exposed to users
- Contest descriptions visible only to relevant parties

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Load report details in single query (use Include/ThenInclude for related data)
- Stream large files for download (don't load entire file in memory)
- Cache status display info (no need to recalculate every time)
- SignalR updates only sent to affected users
- Pagination for validation history if many attempts

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions

**Example:**
```csharp
[Fact]
public async Task Handle_ReportWithValidationErrors_IncludesErrors()
{
    // Arrange
    var reportId = Guid.NewGuid();
    var report = CreateTestReport(reportId, ValidationStatus.ValidationErrors);
    var validationResult = new ValidationResult
    {
        ReportId = reportId,
        IsValid = false,
        Errors = new List<ValidationError>
        {
            new() { Description = "Missing required field", Location = "Sheet1!A5" }
        }
    };
    
    _reportRepositoryMock.Setup(r => r.GetByIdAsync(reportId)).ReturnsAsync(report);
    _validationResultRepositoryMock.Setup(r => r.GetByReportIdAsync(reportId)).ReturnsAsync(validationResult);
    
    var query = new GetReportDetailsQuery { ReportId = reportId };
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.ValidationStatus.Should().Be("ValidationErrors");
    result.ValidationResult.Should().NotBeNull();
    result.ValidationResult.Errors.Should().HaveCount(1);
    result.ValidationResult.Errors[0].Description.Should().Be("Missing required field");
}
```

### Additional Notes

1. **Real-time Updates:** Subscribe to SignalR on component init, unsubscribe on destroy to prevent memory leaks.

2. **Validation History:** If report was resubmitted multiple times (via corrections), show all validation attempts in chronological order.

3. **PDF Viewer (Optional):** Consider embedding PDF viewer (pdf.js) to preview validation result instead of forcing download.

4. **Error Categorization:** Group validation errors by severity (critical, warning) or by worksheet/section.

5. **Correction Workflow:** "Submit Correction" button should pre-populate correction form with original report metadata.

6. **Mobile Responsiveness:** Ensure validation errors display is readable on mobile devices (use accordion/collapse for long lists).

7. **Accessibility:** Ensure status colors are not the only indicator (use icons and text labels too) for color-blind users.

8. **Localization:** Status display names and error messages should support i18n for future localization.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

