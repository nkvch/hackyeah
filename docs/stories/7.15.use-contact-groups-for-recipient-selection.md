# Story 7.15: Use Contact Groups for Recipient Selection

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.15  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** use contact groups when selecting recipients for announcements, messages, and file sharing,  
**So that** I can efficiently target communications.

---

## Acceptance Criteria

1. When selecting recipients for announcements (Story 7.2), mass messages (Epic 5), or file permissions (Epic 6), employee can choose "Selected Contact Groups"
2. Employee selects one or more Contact Groups from list
3. System automatically includes all members of selected groups as recipients
4. System users in group receive in-app notifications and emails
5. Contacts (non-system users) in group receive email notifications only
6. Employee can preview calculated recipient list showing all users and contacts
7. Recipient calculation is dynamic (reflects current group membership at time of action)
8. System logs use of Contact Groups in communications

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Update RecipientConfiguration to support contact groups** (AC: 1, 2)
  - [ ] Verify `RecipientConfiguration.cs` from Story 7.2 includes:
    - SelectedContactGroupIds (List<Guid>)
  - [ ] Ensure it's part of the four addressee types

- [ ] **Task 2: Update RecipientCalculator to handle contact groups** (AC: 3, 4, 5, 7)
  - [ ] Update `RecipientCalculatorService.cs` from Story 7.2
  - [ ] Add logic to handle SelectedContactGroupIds:
    - For each ContactGroupId, get all members
    - For SystemUser members, add UserId to recipient list
    - For Contact members, add Email to recipient email list
    - Remove duplicates
  - [ ] Return unified recipient list (UserIds + ContactEmails)

- [ ] **Task 3: Implement contact group recipient calculation** (AC: 3, 7)
  - [ ] Example logic:
    ```csharp
    if (config.SelectedContactGroupIds.Any())
    {
        foreach (var groupId in config.SelectedContactGroupIds)
        {
            var members = await _contactGroupRepository.GetMembersAsync(groupId);
            foreach (var member in members)
            {
                if (member.MemberType == MemberType.SystemUser)
                {
                    recipientUserIds.Add(member.UserId.Value);
                }
                else if (member.MemberType == MemberType.Contact)
                {
                    var contact = await _contactRepository.GetByIdAsync(member.ContactId.Value);
                    recipientEmails.Add(contact.Email);
                }
            }
        }
    }
    ```

- [ ] **Task 4: Update AnnouncementPublishedEventHandler** (AC: 4, 5)
  - [ ] Update `AnnouncementPublishedEventHandler.cs` from Story 7.3
  - [ ] When processing recipients:
    - For UserIds: Create in-app notifications + send emails
    - For ContactEmails: Send emails only (no in-app notifications)
  - [ ] Use IEmailService to send emails

- [ ] **Task 5: Update recipient preview endpoint** (AC: 6)
  - [ ] Update preview endpoint from Story 7.2
  - [ ] Ensure it calculates and shows:
    - Total count
    - Breakdown: X system users, Y contacts
    - List of names and emails
  - [ ] Include contact groups in preview

- [ ] **Task 6: Log contact group usage** (AC: 8)
  - [ ] When announcement is published or message is sent with contact groups:
    - Log which contact groups were used
    - Include timestamp, user ID, announcement/message ID
    - Store in audit log or history

### Frontend Tasks

- [ ] **Task 7: Update AddresseeTypeSelector component** (AC: 1, 2)
  - [ ] Update `addressee-type-selector.component.ts` from Story 7.11
  - [ ] Ensure "Select Contact Groups" section is implemented
  - [ ] Load contact groups via contactGroupsService.getAll()
  - [ ] Display: Group Name (Member Count)
  - [ ] Allow selecting multiple groups

- [ ] **Task 8: Implement contact group selection in announcements** (AC: 1)
  - [ ] Update announcement creation/editing from Story 7.1 and 7.2
  - [ ] Use AddresseeTypeSelector component
  - [ ] Include contact groups in recipient configuration

- [ ] **Task 9: Update recipient preview** (AC: 6)
  - [ ] Update recipient preview from Story 7.2
  - [ ] Show breakdown:
    - "From Contact Groups: X members"
    - List: John Doe (System User), Jane Smith (Contact)
  - [ ] Indicate member type (user vs. contact)

- [ ] **Task 10: Display contact groups in recipient summary** (AC: 2)
  - [ ] After announcement is published, show summary:
    - "Recipients: 15 total"
    - "Contact Groups: Quarterly Recipients, Risk Officers"
    - "Entities: Bank ABC"
    - "Individual Users: 3"

### Testing Tasks

- [ ] **Task 11: Write unit tests for RecipientCalculator with contact groups** (AC: 3, 4, 5, 7)
  - [ ] Test: `Calculate_ContactGroups_ReturnsGroupMembers`
  - [ ] Test: `Calculate_ContactGroups_IncludesSystemUsers`
  - [ ] Test: `Calculate_ContactGroups_IncludesContacts`
  - [ ] Test: `Calculate_ContactGroups_RemovesDuplicates`
  - [ ] Test: `Calculate_MultipleContactGroups_CombinesMembers`
  - [ ] Test: `Calculate_ReflectsCurrentMembership`
  - [ ] Mock: IContactGroupRepository, IContactRepository

- [ ] **Task 12: Write integration tests for contact group usage**
  - [ ] Test: `PublishAnnouncement_WithContactGroups_CalculatesRecipients`
  - [ ] Test: `PublishAnnouncement_WithContactGroups_SendsNotifications`
  - [ ] Test: `PublishAnnouncement_ContactGroupMembers_SystemUsersReceiveInAppNotifications`
  - [ ] Test: `PublishAnnouncement_ContactGroupMembers_ContactsReceiveEmailOnly`
  - [ ] Test: `PreviewRecipients_WithContactGroups_ReturnsPreview`
  - [ ] Use Testcontainers
  - [ ] Seed test data with contact groups, members (users + contacts)
  - [ ] Verify recipients calculated correctly
  - [ ] Verify notifications sent correctly

- [ ] **Task 13: Write E2E test for contact group usage**
  - [ ] Test workflow:
    1. Create contact group
    2. Add system users and contacts to group
    3. Create announcement
    4. Select contact group as recipients
    5. Preview recipients
    6. Publish announcement
    7. Verify system users see in-app notification
    8. Verify contacts receive email (check email queue/service)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Recipient Types Summary

After this story, the four addressee types are fully implemented:

1. **Selected Entities** (Story 7.2)
2. **Selected Contact Groups** (this story)
3. **Selected Entity Types** (Story 7.2)
4. **Selected Users** (Story 7.2)

### System Users vs. Contacts in Groups

When contact group is used as recipient:

**System Users (MemberType = SystemUser):**
- Receive in-app notification (shows up in notification bell)
- Receive email notification (if enabled)
- Can view announcement in bulletin board

**Contacts (MemberType = Contact):**
- Receive email notification ONLY
- Cannot log in to view announcement
- Email includes full announcement content or link (but link won't work for non-users)

### Email to Contacts

Email should be self-contained:
```
From: UKNF Platform <noreply@uknf.gov.pl>
To: contact@example.com
Subject: [UKNF] New Announcement: [Title]

Hello,

A new announcement has been published by UKNF:

Title: [Announcement Title]
Category: [Category]
Priority: [Priority]
Published: [Date]

Content:
[Full announcement content or excerpt]

---
You are receiving this email because you are a registered contact with UKNF.
This is an automated message. Please do not reply.
```

### Dynamic Membership

Recipients are calculated at time of announcement publication:
- Current members at that moment are recipients
- If new members join group after publication, they do NOT receive announcement
- This is by design (snapshot at publication time)

**Implementation:**
- Store calculated recipients in `AnnouncementRecipients` table during publication
- Do NOT recalculate recipients later

### Contact Group Usage Logging

Log contact group usage in:
- Announcements (AnnouncementHistory or AuditLog)
- Messages (Epic 5, if applicable)
- File permissions (Epic 6, if applicable)

Example audit log entry:
```json
{
  "action": "AnnouncementPublished",
  "announcementId": "guid",
  "contactGroupsUsed": ["guid1", "guid2"],
  "recipientCount": 25,
  "timestamp": "2025-10-04T10:30:00Z"
}
```

### Dependencies

**Prerequisites:**
- **Story 7.14**: Assign Contacts to Groups (groups must have members)
- **Story 7.12**: Create Contact Groups (groups must exist)
- **Story 7.13**: Add Contacts (contacts must exist)
- **Story 7.2**: Set Announcement Recipients (recipient configuration exists)
- **Story 7.3**: Publish Announcement (publication mechanism exists)

**Integrates With:**
- **Epic 5**: Messaging (reuse contact groups for mass messaging)
- **Epic 6**: Library (reuse contact groups for file permissions)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

