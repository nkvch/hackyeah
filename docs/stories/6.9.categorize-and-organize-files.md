# Story 6.9: Categorize and Organize Files

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.9  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** organize Library files into categories,  
**So that** users can easily find related documents.

---

## Acceptance Criteria

1. UKNF Employee can create, edit, and delete categories
2. Category includes: Name, Description, Sort order (optional)
3. Categories are displayed as filters or navigation sections in Library
4. Employee can assign files to categories during upload or via metadata edit
5. A file can belong to one category
6. Categories are consistent across all users
7. Empty categories can exist but are hidden from external user view
8. Category changes take effect immediately
9. System logs category management actions
10. Cannot delete category that has files assigned (must move files first or force delete with warning)
11. Category list is sortable by name or sort order

---

## Tasks / Subtasks

### Backend Tasks (Category CRUD)

- [ ] **Task 1: Create CreateCategoryCommand** (AC: 1, 2)
  - [ ] Create `CreateCategoryCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - Name (string, required, max 200)
    - Description (string?, nullable, max 1000)
    - SortOrder (int, default 0)

- [ ] **Task 2: Create CreateCategoryCommandValidator** (AC: 1, 2)
  - [ ] Create `CreateCategoryCommandValidator.cs` using FluentValidation
  - [ ] Validate Name: NotEmpty, MaxLength(200)
  - [ ] Validate Description: MaxLength(1000) if provided
  - [ ] Validate SortOrder: GreaterThanOrEqualTo(0)
  - [ ] Add async validation: Name must be unique
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 3: Create CreateCategoryCommandHandler** (AC: 1, 6, 8, 9)
  - [ ] Create `CreateCategoryCommandHandler.cs` implementing `IRequestHandler<CreateCategoryCommand, CreateCategoryResponse>`
  - [ ] Inject dependencies: IFileCategoryRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Check name uniqueness
    - Create FileCategory entity
    - Save to repository
    - Log category creation (AC: 9)
    - Return CreateCategoryResponse
  - [ ] Handle errors: duplicate name

- [ ] **Task 4: Create CreateCategoryResponse DTO** (AC: 1, 8)
  - [ ] Create `CreateCategoryResponse.cs` record
  - [ ] Properties: CategoryId (Guid), Name (string), Message (string)

- [ ] **Task 5: Create REST API endpoint POST /library/categories** (AC: 1)
  - [ ] Create CategoriesController in `Api/UknfPlatform.Api/Controllers/` (or add to LibraryController)
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create POST action `CreateCategoryAsync([FromBody] CreateCategoryRequest request)`
  - [ ] Inject IMediator to send command
  - [ ] Return 201 Created with CreateCategoryResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 409 Conflict if name already exists
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 6: Create UpdateCategoryCommand** (AC: 1, 2, 8)
  - [ ] Create `UpdateCategoryCommand.cs`
  - [ ] Command properties: CategoryId (Guid), Name (string), Description (string?), SortOrder (int)

- [ ] **Task 7: Create UpdateCategoryCommandValidator** (AC: 1, 2)
  - [ ] Similar validation to Create
  - [ ] Add async validation: CategoryId must exist
  - [ ] Add async validation: Name must be unique (excluding current category)

- [ ] **Task 8: Create UpdateCategoryCommandHandler** (AC: 1, 8, 9)
  - [ ] Validate category exists
  - [ ] Update category properties
  - [ ] Save changes
  - [ ] Log category update (AC: 9)
  - [ ] Return response

- [ ] **Task 9: Create REST API endpoint PUT /library/categories/{categoryId}** (AC: 1)
  - [ ] Add method to CategoriesController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create PUT action `UpdateCategoryAsync(Guid categoryId, [FromBody] UpdateCategoryRequest request)`
  - [ ] Return 200 OK with UpdateCategoryResponse
  - [ ] Return 400 Bad Request, 403 Forbidden, 404 Not Found, 409 Conflict

- [ ] **Task 10: Create DeleteCategoryCommand** (AC: 1, 10)
  - [ ] Create `DeleteCategoryCommand.cs`
  - [ ] Command properties: CategoryId (Guid), ForceDelete (bool, default false)

- [ ] **Task 11: Create DeleteCategoryCommandValidator** (AC: 1, 10)
  - [ ] Validate CategoryId: NotEmpty, MustBeValidGuid
  - [ ] Add async validation: CategoryId must exist
  - [ ] Add async validation: If not ForceDelete, category must have no files assigned

- [ ] **Task 12: Create DeleteCategoryCommandHandler** (AC: 1, 9, 10)
  - [ ] Validate category exists
  - [ ] Check if category has files:
    - If ForceDelete = false and has files: return error
    - If ForceDelete = true: Move files to default "Uncategorized" category or delete files
  - [ ] Soft delete category (IsActive = false) or hard delete
  - [ ] Log category deletion (AC: 9)
  - [ ] Return response

- [ ] **Task 13: Create REST API endpoint DELETE /library/categories/{categoryId}** (AC: 1, 10)
  - [ ] Add method to CategoriesController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create DELETE action `DeleteCategoryAsync(Guid categoryId, [FromQuery] bool forceDelete = false)`
  - [ ] Return 200 OK with DeleteCategoryResponse
  - [ ] Return 400 Bad Request if category has files and forceDelete = false
  - [ ] Return 403 Forbidden, 404 Not Found

- [ ] **Task 14: Create GetCategoriesQuery** (AC: 3, 6, 7, 11)
  - [ ] Create `GetCategoriesQuery.cs`
  - [ ] Query properties: IncludeEmpty (bool, default false), IncludeFileCounts (bool, default false), SortBy (enum)
  - [ ] Create QueryHandler
  - [ ] Handler logic:
    - Load all active categories
    - If IncludeFileCounts: Include file count per category
    - If not IncludeEmpty (external user): Filter out categories with 0 files (AC: 7)
    - Sort by SortOrder or Name (AC: 11)
    - Return list of CategoryDto

- [ ] **Task 15: Update REST API endpoint GET /library/categories** (AC: 3, 6, 7, 11)
  - [ ] Update existing endpoint (Story 6.3)
  - [ ] Add query parameters: includeEmpty, includeFileCounts, sortBy
  - [ ] External users: includeEmpty = false (default)
  - [ ] UKNF Employees: includeEmpty = true (default)

- [ ] **Task 16: Update IFileCategoryRepository** (AC: 1, 6, 8, 10, 11)
  - [ ] Methods already defined in Story 6.1
  - [ ] Add method: GetCategoryWithFileCountAsync(Guid categoryId)
  - [ ] Add method: CheckCategoryNameUniqueAsync(string name, Guid? excludeCategoryId)
  - [ ] Update GetAllAsync to support sorting
  - [ ] Ensure soft delete support (IsActive flag)

### Frontend Tasks

- [ ] **Task 17: Create category management component** (AC: 1, 2, 11)
  - [ ] Create `library-category-management.component.ts` in `src/app/features/library/admin/`
  - [ ] List all categories with: Name, Description, File Count, Sort Order
  - [ ] Add, Edit, Delete buttons for each category
  - [ ] Sortable by name or sort order
  - [ ] Search categories
  - [ ] Only accessible to UKNF Employees

- [ ] **Task 18: Create category form component** (AC: 1, 2)
  - [ ] Create `library-category-form.component.ts`
  - [ ] Form fields: Name, Description, Sort Order
  - [ ] Used for both create and edit
  - [ ] Client-side validation
  - [ ] Save and Cancel buttons

- [ ] **Task 19: Create category delete confirmation** (AC: 1, 10)
  - [ ] Show warning if category has files
  - [ ] Show file count
  - [ ] Option: "Move files to another category" (dropdown)
  - [ ] Option: "Force delete and remove files" (with extra confirmation)
  - [ ] Require explicit confirmation

- [ ] **Task 20: Add category management to admin menu** (AC: 1)
  - [ ] Add "Manage Categories" menu item (UKNF only)
  - [ ] Route: `/library/admin/categories`
  - [ ] Accessible from Library section or Admin section

- [ ] **Task 21: Update category selector** (AC: 3, 4)
  - [ ] Update category dropdown in file upload (Story 6.1)
  - [ ] Update category dropdown in file metadata edit (Story 6.6)
  - [ ] Load categories from API
  - [ ] Show name and description
  - [ ] Required field

- [ ] **Task 22: Update category filter in library list** (AC: 3, 7)
  - [ ] Update category filter in library list (Story 6.3)
  - [ ] Show all categories with file counts
  - [ ] Hide empty categories from external users (AC: 7)
  - [ ] UKNF Employees see all categories

- [ ] **Task 23: Update library service** (AC: 1, 6, 8)
  - [ ] Add methods to `library.service.ts`:
    - createCategory(category: CreateCategory): Observable<CreateCategoryResponse>
    - updateCategory(categoryId: string, category: UpdateCategory): Observable<UpdateCategoryResponse>
    - deleteCategory(categoryId: string, forceDelete: boolean): Observable<DeleteCategoryResponse>
  - [ ] Update getCategories to support query parameters

- [ ] **Task 24: Show category changes immediately** (AC: 8)
  - [ ] Refresh category list after create/update/delete
  - [ ] Update file list if category filter active
  - [ ] Show success notifications
  - [ ] Optimistic updates where appropriate

### Testing Tasks

- [ ] **Task 25: Unit tests for category commands** (AC: 1, 6, 8, 9, 10)
  - [ ] Test create category
  - [ ] Test update category
  - [ ] Test delete category (empty)
  - [ ] Test delete category with files (blocked without force)
  - [ ] Test delete category with force flag
  - [ ] Test name uniqueness validation
  - [ ] Test logging

- [ ] **Task 26: Unit tests for GetCategoriesQuery** (AC: 3, 7, 11)
  - [ ] Test categories sorted by sort order
  - [ ] Test categories sorted by name
  - [ ] Test empty categories hidden for external users
  - [ ] Test empty categories visible for UKNF
  - [ ] Test file counts included when requested

- [ ] **Task 27: Integration tests for API endpoints** (AC: 1, 6, 8)
  - [ ] Test POST /library/categories creates category
  - [ ] Test PUT /library/categories/{id} updates category
  - [ ] Test DELETE /library/categories/{id} deletes category
  - [ ] Test category management requires UKNF Employee role
  - [ ] Test name uniqueness enforced
  - [ ] Test cannot delete category with files (without force)
  - [ ] Test categories visible to all users
  - [ ] Test changes take effect immediately

- [ ] **Task 28: Frontend unit tests** (AC: 1, 2, 3, 11)
  - [ ] Test category management component
  - [ ] Test category form component
  - [ ] Test category delete confirmation
  - [ ] Test category selector
  - [ ] Test service method calls

- [ ] **Task 29: E2E tests** (AC: 1-11)
  - [ ] Test complete category management flow as UKNF Employee
  - [ ] Test create category
  - [ ] Test edit category
  - [ ] Test delete empty category
  - [ ] Test cannot delete category with files (without force)
  - [ ] Test categories visible in filters
  - [ ] Test external users see only non-empty categories
  - [ ] Test category changes immediately visible

### Documentation Tasks

- [ ] **Task 30: API documentation** (AC: 1)
  - [ ] Document POST /library/categories endpoint
  - [ ] Document PUT /library/categories/{id} endpoint
  - [ ] Document DELETE /library/categories/{id} endpoint
  - [ ] Update GET /library/categories documentation
  - [ ] Include request/response examples
  - [ ] Document authentication requirements

- [ ] **Task 31: Developer documentation** (AC: 2, 6, 10)
  - [ ] Document category schema
  - [ ] Document sort order behavior
  - [ ] Document category deletion logic
  - [ ] Document default categories (seeded data)

- [ ] **Task 32: User documentation** (AC: 1, 2, 3, 4)
  - [ ] Create user guide for managing categories
  - [ ] Explain category purpose and benefits
  - [ ] Document category naming conventions
  - [ ] Explain sort order
  - [ ] Include screenshots

---

## Technical Notes

### Default Categories

Seed database with default categories:
- Report Templates (SortOrder: 1)
- Instructions (SortOrder: 2)
- Guidelines (SortOrder: 3)
- Forms (SortOrder: 4)
- Other (SortOrder: 99)

### Sort Order

- Lower numbers appear first
- Use increments of 10 (10, 20, 30) to allow insertion between
- Default: 0
- Allows flexible ordering without renumbering

Example:
```
10 - Report Templates
20 - Instructions
25 - Announcements (added later, fits between)
30 - Guidelines
```

### Category Name Uniqueness

- Case-insensitive uniqueness
- Trim whitespace before checking
- Prevent confusing similar names

### Empty Category Behavior

**External Users** (AC: 7):
- See only categories with files they can access
- Empty categories hidden

**UKNF Employees**:
- See all categories (including empty)
- Allows pre-creation of categories for future files

### Category Deletion

**Scenario 1: Empty Category**
- Delete directly (soft or hard delete)

**Scenario 2: Category with Files (ForceDelete = false)**
- Block deletion
- Return error: "Cannot delete category with files. Please move files first."
- Show file count

**Scenario 3: Category with Files (ForceDelete = true)**
- Option A: Move files to "Uncategorized" default category
- Option B: Prevent file deletion (safer)
- Require extra confirmation
- Log all affected files

Recommendation: Option A (move to default category).

### Soft Delete vs. Hard Delete

**Soft Delete** (IsActive = false):
- Category hidden but retained in database
- Files keep CategoryId reference (data integrity)
- Can be restored
- Preferred for categories with historical files

**Hard Delete**:
- Remove from database
- Must move files first or cascade delete
- Cannot be restored
- Use only if no files ever assigned

Recommendation: Soft delete.

### Category File Count

Performance optimization:
- Calculate on-demand or cache
- Include in GetCategoriesQuery only if requested
- Consider materialized view or cached column

Query:
```sql
SELECT c.Id, c.Name, COUNT(f.Id) as FileCount
FROM FileCategories c
LEFT JOIN LibraryFiles f ON f.CategoryId = c.Id AND f.IsDeleted = false
GROUP BY c.Id, c.Name
```

### Performance Considerations

- Categories change infrequently - cache aggressively
- Index CategoryId on LibraryFiles table
- Cache category list in frontend (invalidate on change)
- Optimize file count query

### Security Considerations

- Only UKNF Employees can manage categories
- Validate category exists before assigning to file
- Prevent deletion of system/required categories (optional)
- Log all category changes for audit

### UI/UX Considerations

- Make category selection easy and visible
- Show file count in category list
- Provide search for large category lists
- Use color coding or icons for categories (optional)
- Drag-and-drop for sort order (optional)
- Clear naming conventions for consistency

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (FileCategory entity created)
- **Epic 1**: Authentication (UKNF Employee role identification)

### Integrates With
- **Story 6.1**: Upload File to Library (category assignment)
- **Story 6.3**: View and Search Library (category filter)
- **Story 6.6**: Update File Metadata (category change)

---

## Acceptance Checklist

- [ ] UKNF Employee can create categories
- [ ] UKNF Employee can edit categories
- [ ] UKNF Employee can delete categories
- [ ] Category includes Name, Description, Sort Order
- [ ] Categories displayed in Library filters
- [ ] Files can be assigned to categories
- [ ] Files belong to one category
- [ ] Categories consistent across all users
- [ ] Empty categories hidden from external users
- [ ] Category changes take effect immediately
- [ ] System logs category management actions
- [ ] Cannot delete category with files (without force)
- [ ] Categories sortable by name or sort order
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (category assignment)
- **Story 6.3**: View and Search Library (category filter)
- **Story 6.6**: Update File Metadata (category change)
- **Story 6.14**: Bulk Operations (bulk category assignment)

---

## Notes

- Categories improve file discoverability
- Keep category list manageable (5-15 categories ideal)
- Use clear, consistent naming conventions
- Sort order allows flexible organization
- Default categories should cover common use cases
- Consider hierarchical categories in future (subcategories)
- Monitor category usage - merge underused categories
- Test with many categories and many files per category
- Category management should be simple and intuitive
- Consider category descriptions visible to users (help text)

