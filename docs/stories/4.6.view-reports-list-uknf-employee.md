# Story 4.6: View Reports List (UKNF Employee)

**Epic:** 4 - Reporting System  
**Story Number:** 4.6  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee,  
**I want to** view reports organized in registers with filtering capabilities,  
**So that** I can efficiently monitor and manage regulatory reporting.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.6

1. UKNF Employee can view reports in organized registers (e.g., "Quarterly Reports", "Annual Reports")
2. Quick filter "My Entities" shows only reports from entities assigned to the employee
3. Employee can filter by: Validation status, Reporting period, Entity, Report type, Archival status
4. List displays: Entity name, Report name, Reporting period, Submitter (name, email, phone), Validation status, Corrections indicator, Submission date
5. Employee can sort by any column
6. Employee can view both current and archival reports
7. Employee can search by entity name, report name, or submitter details
8. List supports pagination
9. Employee can export filtered report list (CSV or Excel)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetReportsListForUknfQuery** (AC: 1, 2, 3, 6, 7, 8)
  - [ ] Create `GetReportsListForUknfQuery.cs` in `Application/UknfPlatform.Application.Communication/Reports/Queries/`
  - [ ] Query properties:
    - RegisterType (string?, optional) - filter by register (AC 1)
    - MyEntitiesOnly (bool, default: false) - "My Entities" quick filter (AC 2)
    - EntityId (long?, optional) - filter by specific entity (AC 3)
    - ValidationStatus (string?, optional) - filter by status (AC 3)
    - ReportingPeriod (string?, optional) - filter by period (AC 3)
    - ReportType (string?, optional) - filter by type (AC 3)
    - IsArchived (bool?, optional) - filter archival status (AC 3, 6)
    - SearchTerm (string?, optional) - search entity, report name, or submitter (AC 7)
    - SortBy (string?, optional) - any column (AC 5)
    - SortDescending (bool, default: true)
    - PageNumber (int, default: 1)
    - PageSize (int, default: 20)

- [ ] **Task 2: Create GetReportsListForUknfQueryHandler** (AC: All)
  - [ ] Create `GetReportsListForUknfQueryHandler.cs` implementing `IRequestHandler<GetReportsListForUknfQuery, PagedResult<UknfReportListItemDto>>`
  - [ ] Inject dependencies: IReportRepository, ICurrentUserService, IEntityRepository, IUserRepository, ILogger
  - [ ] Handler logic:
    - Verify user is UKNF Employee (UserType = Internal)
    - Build query:
      * If MyEntitiesOnly = true, filter by entities assigned to current user
      * If RegisterType provided, filter by report type matching register
      * If EntityId provided, filter by specific entity
      * Filter by ValidationStatus if provided
      * Filter by ReportingPeriod if provided
      * Filter by ReportType if provided
      * Filter by IsArchived if provided (AC 6)
      * Search by entity name, report name, or submitter name/email if SearchTerm provided (AC 7)
      * Apply sorting on any column (AC 5)
      * Apply pagination
    - For each report, include: Entity details, Submitter details (name, email, phone - AC 4), Validation status, Corrections indicator
    - Map to UknfReportListItemDto
    - Return PagedResult

- [ ] **Task 3: Create UknfReportListItemDto** (AC: 4)
  - [ ] Create `UknfReportListItemDto.cs` record
  - [ ] Properties (from PRD AC 4):
    - ReportId (Guid)
    - EntityName (string) - AC 4
    - EntityUknfCode (string) - helpful context
    - ReportName (string) - File name
    - ReportingPeriod (string)
    - SubmitterName (string) - AC 4
    - SubmitterEmail (string) - AC 4
    - SubmitterPhone (string) - AC 4
    - ValidationStatus (string)
    - ValidationStatusDisplayName (string)
    - HasCorrections (bool)
    - CorrectionCount (int)
    - SubmissionDate (DateTime) - AC 4
    - IsArchived (bool) - for UI display
  - [ ] Note: More fields than Story 4.5 (external user) - includes entity and submitter contact details

- [ ] **Task 4: Implement "My Entities" logic** (AC: 2)
  - [ ] Create IUserEntityAssignmentRepository interface
  - [ ] Method: `GetAssignedEntityIdsAsync(userId): Task<List<long>>`
  - [ ] Implement query to fetch entities assigned to UKNF employee
  - [ ] Note: Assignment mechanism may come from Epic 2 or separate assignment feature
  - [ ] If MyEntitiesOnly = true in query, filter reports where EntityId IN assignedEntityIds

- [ ] **Task 5: Implement register organization** (AC: 1)
  - [ ] Create RegisterType enum or constants:
    - QuarterlyReports
    - AnnualReports
    - MonthlyReports
    - CurrentReports (ad-hoc)
    - Archival
  - [ ] Map ReportType to RegisterType (e.g., "Quarterly" → "QuarterlyReports" register)
  - [ ] If RegisterType filter provided, convert to ReportType filter
  - [ ] Example: RegisterType = "QuarterlyReports" → filter where ReportType = "Quarterly"

- [ ] **Task 6: Create REST API endpoint GET /api/admin/reports** (AC: All)
  - [ ] Update `ReportsController.cs` or create `AdminReportsController.cs`
  - [ ] Add `[Authorize]` attribute
  - [ ] Add authorization filter: `[RequiresRole("UKNF Employee")]` or check UserType = Internal
  - [ ] Create GET action `GetUknfReportsListAsync([FromQuery] GetReportsListForUknfQuery query)`
  - [ ] Inject IMediator
  - [ ] Send query via MediatR
  - [ ] Return 200 OK with PagedResult<UknfReportListItemDto>
  - [ ] Return 403 Forbidden if user is not UKNF employee
  - [ ] Add XML documentation comments
  - [ ] Add Swagger annotations

- [ ] **Task 7: Implement export for UKNF (CSV/Excel)** (AC: 9)
  - [ ] Create `ExportUknfReportsToCSVQuery.cs`
  - [ ] Create `ExportUknfReportsToCSVQueryHandler.cs`
  - [ ] Handler logic:
    - Same filters as GetReportsListForUknfQuery (no pagination)
    - Generate CSV with columns from AC 4: Entity Name, Report Name, Reporting Period, Submitter (name, email, phone), Validation Status, Corrections, Submission Date
  - [ ] Create `ExportUknfReportsToExcelQuery.cs`
  - [ ] Create `ExportUknfReportsToExcelQueryHandler.cs`
  - [ ] Handler logic: Same as CSV but generate Excel file
  - [ ] Create REST API endpoint: GET `/api/admin/reports/export?format=csv/excel`
  - [ ] Return File result with appropriate content type

- [ ] **Task 8: Implement advanced sorting** (AC: 5)
  - [ ] Support sorting by ANY column (unlike Story 4.5 which has only 3)
  - [ ] Sortable columns:
    - EntityName
    - ReportName
    - ReportingPeriod
    - SubmitterName
    - ValidationStatus
    - SubmissionDate
    - IsArchived
  - [ ] Use dynamic sorting expression builder or switch statement
  - [ ] Validate sortBy parameter against allowed columns

- [ ] **Task 9: Implement archival status filter** (AC: 3, 6)
  - [ ] IsArchived filter values:
    - null = show all reports
    - false = show only current (non-archived) reports
    - true = show only archived reports
  - [ ] Default view: show current reports only (IsArchived = false)
  - [ ] User can toggle to "Show Archived" or "Show All"

- [ ] **Task 10: Add authorization for UKNF employees only** (AC: All)
  - [ ] Check user's UserType = Internal (UKNF employee)
  - [ ] If external user tries to access, return 403 Forbidden
  - [ ] Permission: "communication.reports.view_all" or role-based check

### Frontend Tasks

- [ ] **Task 11: Update reports service** (AC: All)
  - [ ] Update `reports.service.ts`
  - [ ] Method: `getUknfReportsList(filters): Observable<PagedResult<UknfReportListItem>>`
  - [ ] Method: `exportUknfReports(format, filters): Observable<Blob>`
  - [ ] Build query parameters from filters object

- [ ] **Task 12: Create UKNF reports list component** (AC: All)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/uknf-reports-list/uknf-reports-list.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/admin/reports` with auth guard (UKNF employee only)
  - [ ] Inject ReportsService, Router
  - [ ] Load reports on init
  - [ ] Handle errors

- [ ] **Task 13: Display registers navigation** (AC: 1)
  - [ ] Show register tabs or sidebar menu
  - [ ] Registers:
    - All Reports (default)
    - Quarterly Reports
    - Annual Reports
    - Monthly Reports
    - Current Reports
    - Archival
  - [ ] On register selection, filter reports by RegisterType
  - [ ] Use PrimeNG TabView or Menu component
  - [ ] Highlight active register

- [ ] **Task 14: Implement "My Entities" quick filter** (AC: 2)
  - [ ] Add toggle switch or checkbox: "My Entities Only"
  - [ ] Default: unchecked (show all reports)
  - [ ] On toggle:
    - Set MyEntitiesOnly = true
    - Reload reports
    - Show indicator that filter is active
  - [ ] Use PrimeNG InputSwitch component
  - [ ] Position prominently (top of page)

- [ ] **Task 15: Display reports table with UKNF columns** (AC: 4)
  - [ ] Use PrimeNG Table (p-table) component
  - [ ] Columns (from PRD AC 4):
    - Entity Name
    - Report Name
    - Reporting Period
    - Submitter (name, email, phone) - consider combined or separate columns
    - Validation Status
    - Corrections
    - Submission Date
  - [ ] Note: More columns than Story 4.5
  - [ ] Responsive layout (may need horizontal scroll on mobile)

- [ ] **Task 16: Implement advanced filters** (AC: 3)
  - [ ] Create filter panel with fields (from PRD AC 3):
    - Validation Status (dropdown)
    - Reporting Period (dropdown or input)
    - Entity (dropdown or autocomplete) - NEW vs Story 4.5
    - Report Type (dropdown)
    - Archival Status (dropdown: Current, Archived, All) - NEW vs Story 4.5
  - [ ] "Apply Filters" and "Clear Filters" buttons
  - [ ] Show active filter count
  - [ ] Use PrimeNG Dropdown, AutoComplete components

- [ ] **Task 17: Implement entity filter/autocomplete** (AC: 3)
  - [ ] Entity dropdown or autocomplete field
  - [ ] Load all entities via entitiesService.getAllEntities()
  - [ ] Display: Entity Name (UKNF Code)
  - [ ] Support search/filtering in dropdown
  - [ ] Use PrimeNG AutoComplete for large entity lists

- [ ] **Task 18: Implement search with expanded scope** (AC: 7)
  - [ ] Search input field
  - [ ] Placeholder: "Search by entity name, report name, or submitter"
  - [ ] Search scope: Entity name, Report name, Submitter name/email (AC 7)
  - [ ] Note: More search fields than Story 4.5
  - [ ] Debounce input (500ms)
  - [ ] Show clear button when active

- [ ] **Task 19: Implement sorting on all columns** (AC: 5)
  - [ ] Enable sorting on ALL columns (unlike Story 4.5 which has only 3 sortable)
  - [ ] Use PrimeNG Table sortable columns
  - [ ] On column header click, reload data with sort parameters
  - [ ] Show sort indicator on active column
  - [ ] Multi-column sorting optional (nice-to-have)

- [ ] **Task 20: Implement pagination** (AC: 8)
  - [ ] Use PrimeNG Paginator component
  - [ ] Same as Story 4.5: page numbers, navigation, page size options
  - [ ] Display: "Showing X-Y of Z reports"
  - [ ] Default page size: 20
  - [ ] Preserve filters/sort when paginating

- [ ] **Task 21: Display submitter details** (AC: 4)
  - [ ] Submitter column shows: Name, Email, Phone (AC 4)
  - [ ] Consider layout:
    - Option 1: Combined cell with name (bold), email and phone below (smaller text)
    - Option 2: Separate columns for Name, Email, Phone
  - [ ] Make email and phone clickable (mailto:, tel:)
  - [ ] Use Tailwind CSS for formatting

- [ ] **Task 22: Display archival status indicator** (AC: 6)
  - [ ] If report is archived, show indicator
  - [ ] Options:
    - Tag/badge in row
    - Different row background color
    - Icon in row
  - [ ] Tooltip: "This report is archived"
  - [ ] Make visually distinct from current reports

- [ ] **Task 23: Implement export functionality** (AC: 9)
  - [ ] Add "Export" dropdown button
  - [ ] Options: "Export to CSV", "Export to Excel"
  - [ ] On click, call reportsService.exportUknfReports()
  - [ ] Download file
  - [ ] Export uses current filters (including "My Entities", register, archival status)
  - [ ] Use PrimeNG SplitButton

- [ ] **Task 24: Create page layout** (AC: All)
  - [ ] Page title: "Reports Management"
  - [ ] Breadcrumb: Admin > Reports
  - [ ] Layout sections:
    - Header with "My Entities" toggle
    - Registers navigation (tabs or sidebar)
    - Filters panel
    - Search bar
    - Reports table with expanded columns
    - Paginator
    - Export button
  - [ ] Use PrimeNG TabView, Panel, Card components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 25: Add authorization guard** (AC: All)
  - [ ] Create or update AuthGuard
  - [ ] Check user is UKNF Employee (UserType = Internal)
  - [ ] Redirect to 403 Forbidden if external user
  - [ ] Hide "Admin Reports" menu item from external users

- [ ] **Task 26: Handle empty state** (AC: 1)
  - [ ] If no reports for selected register/filters, show empty state
  - [ ] Message: "No reports found for selected filters"
  - [ ] Suggest: "Try adjusting filters or selecting a different register"

- [ ] **Task 27: Implement real-time updates** (AC: Related)
  - [ ] Subscribe to SignalR notifications
  - [ ] When report status changes, update row in table
  - [ ] Show notification toast
  - [ ] Support for reports from all entities (not just user's entities)

### Testing Tasks

- [ ] **Task 28: Write unit tests for GetReportsListForUknfQueryHandler**
  - [ ] Test: `Handle_AllReports_ReturnsPaginatedReports`
  - [ ] Test: `Handle_MyEntitiesOnly_ReturnsOnlyAssignedEntities` (AC 2)
  - [ ] Test: `Handle_FilterByRegister_ReturnsFilteredReports` (AC 1)
  - [ ] Test: `Handle_FilterByEntity_ReturnsEntityReports` (AC 3)
  - [ ] Test: `Handle_FilterByArchivalStatus_ReturnsFiltered` (AC 3, 6)
  - [ ] Test: `Handle_SearchByEntityName_ReturnsMatching` (AC 7)
  - [ ] Test: `Handle_SearchBySubmitterEmail_ReturnsMatching` (AC 7)
  - [ ] Test: `Handle_SortByAnyColumn_ReturnsSorted` (AC 5)
  - [ ] Test: `Handle_ExternalUserAttempt_ThrowsForbiddenException`
  - [ ] Mock: IReportRepository, IUserEntityAssignmentRepository, ICurrentUserService

- [ ] **Task 29: Write unit tests for export handlers**
  - [ ] Test: `ExportToCSV_IncludesEntityAndSubmitterDetails` (AC 4)
  - [ ] Test: `ExportToExcel_IncludesAllColumns`
  - [ ] Test: `Export_RespectsMyEntitiesFilter` (AC 2)
  - [ ] Verify CSV/Excel format and headers

- [ ] **Task 30: Write integration test for UKNF reports list endpoint**
  - [ ] Test: `GET_AdminReports_ReturnsPagedList`
  - [ ] Test: `GET_AdminReports_MyEntitiesOnly_ReturnsAssignedOnly` (AC 2)
  - [ ] Test: `GET_AdminReports_FilterByRegister_ReturnsFiltered` (AC 1)
  - [ ] Test: `GET_AdminReports_FilterByArchivalStatus_ReturnsFiltered` (AC 6)
  - [ ] Test: `GET_AdminReports_SearchByEntity_ReturnsMatching` (AC 7)
  - [ ] Test: `GET_AdminReports_SortByAnyColumn_ReturnsSorted` (AC 5)
  - [ ] Test: `GET_AdminReports_UknfEmployee_Returns200`
  - [ ] Test: `GET_AdminReports_ExternalUser_Returns403`
  - [ ] Use Testcontainers
  - [ ] Create test data with multiple entities, reports, assignments

- [ ] **Task 31: Write E2E test for UKNF reports list flow**
  - [ ] Test workflow:
    1. Login as UKNF employee
    2. Navigate to Admin > Reports
    3. Verify reports table displays
    4. Verify columns match AC 4 (Entity, Report, Period, Submitter details, Status, Corrections, Date)
    5. Click "Quarterly Reports" register (AC 1)
    6. Toggle "My Entities Only" (AC 2)
    7. Apply filter by entity (AC 3)
    8. Apply filter by archival status (AC 6)
    9. Search by entity name (AC 7)
    10. Sort by entity name column (AC 5)
    11. Click report row to view details
    12. Navigate to page 2 (AC 8)
    13. Export to CSV (AC 9)
    14. Verify file downloads
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.5:**
- External user reports list
- Simpler filtering and sorting
- Entity-scoped view

**Key Differences from Story 4.5:**
- **Registers:** Reports organized by type (Quarterly, Annual, etc.)
- **"My Entities":** Quick filter for assigned entities
- **More filters:** Entity, Archival status
- **More columns:** Entity name, Submitter email/phone
- **More sorting:** Any column (vs. 3 columns)
- **Broader search:** Entity name, report name, submitter details
- **Archival view:** View current and archived reports

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Same as Story 4.5
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- CSV/Excel: CsvHelper, ClosedXML

**Frontend Stack:**
- Same as Story 4.5
- PrimeNG: TabView for registers, InputSwitch for "My Entities", AutoComplete for entity selection

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AdminReportsController.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Reports/
│   ├── Queries/
│   │   ├── GetReportsListForUknfQuery.cs (CREATE)
│   │   ├── GetReportsListForUknfQueryHandler.cs (CREATE)
│   │   ├── ExportUknfReportsToCSVQuery.cs (CREATE)
│   │   ├── ExportUknfReportsToCSVQueryHandler.cs (CREATE)
│   │   ├── ExportUknfReportsToExcelQuery.cs (CREATE)
│   │   └── ExportUknfReportsToExcelQueryHandler.cs (CREATE)
│   └── DTOs/
│       └── UknfReportListItemDto.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/
    ├── IUserEntityAssignmentRepository.cs (CREATE)
    └── UserEntityAssignmentRepository.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
├── features/admin/uknf-reports-list/
│   ├── uknf-reports-list.component.ts (CREATE)
│   ├── uknf-reports-list.component.html (CREATE)
│   ├── uknf-reports-list.component.scss (CREATE)
│   └── components/
│       ├── registers-navigation.component.ts (CREATE)
│       └── uknf-reports-table.component.ts (CREATE)
└── core/guards/
    └── uknf-employee.guard.ts (CREATE)
```

### Data Models

**UknfReportListItemDto:**
Must include these fields from PRD AC 4:
- Entity name (EntityName)
- Report name (FileName)
- Reporting period
- Submitter name, email, phone (3 separate fields)
- Validation status
- Corrections indicator
- Submission date

Plus additional fields:
- IsArchived (for AC 6)
- RegisterType (for AC 1)

### REST API Specification

**Endpoint 1:** GET `/api/admin/reports`
- **Security:** Requires authentication + UKNF Employee role
- **Query Parameters:**
  - registerType (string?, optional) - AC 1
  - myEntitiesOnly (bool?, optional) - AC 2
  - entityId (long?, optional) - AC 3
  - status (string?, optional) - AC 3
  - reportType (string?, optional) - AC 3
  - reportingPeriod (string?, optional) - AC 3
  - isArchived (bool?, optional) - AC 3, 6
  - searchTerm (string?, optional) - AC 7
  - sortBy (string?, optional) - AC 5 (any column)
  - sortDescending (bool?, optional)
  - pageNumber (int?, optional)
  - pageSize (int?, optional)
- **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "reportId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "entityName": "Example Bank S.A.",
        "entityUknfCode": "G. RIP100000",
        "reportName": "G. RIP100000_Q1_2025.xlsx",
        "reportingPeriod": "Q1_2025",
        "submitterName": "Jan Kowalski",
        "submitterEmail": "jan.kowalski@example.com",
        "submitterPhone": "+48123456789",
        "validationStatus": "Successful",
        "validationStatusDisplayName": "Validation Successful",
        "hasCorrections": false,
        "correctionCount": 0,
        "submissionDate": "2025-10-04T10:00:00Z",
        "isArchived": false
      }
    ],
    "totalCount": 1500,
    "pageNumber": 1,
    "pageSize": 20,
    "totalPages": 75,
    "hasPreviousPage": false,
    "hasNextPage": true
  }
  ```

**Endpoint 2:** GET `/api/admin/reports/export`
- Same filters, returns CSV or Excel file

### Registers Organization (AC 1)

**Register Types:**
- **All Reports:** No filter, shows everything
- **Quarterly Reports:** ReportType = "Quarterly"
- **Annual Reports:** ReportType = "Annual"
- **Monthly Reports:** ReportType = "Monthly"
- **Current Reports:** ReportType = "Ad-hoc" or "Current"
- **Archival:** IsArchived = true

**Implementation:**
```csharp
var registerMapping = new Dictionary<string, string>
{
    { "QuarterlyReports", "Quarterly" },
    { "AnnualReports", "Annual" },
    { "MonthlyReports", "Monthly" },
    { "CurrentReports", "Current" }
};

if (!string.IsNullOrEmpty(query.RegisterType))
{
    if (query.RegisterType == "Archival")
        queryable = queryable.Where(r => r.IsArchived);
    else if (registerMapping.ContainsKey(query.RegisterType))
        queryable = queryable.Where(r => r.ReportType == registerMapping[query.RegisterType]);
}
```

### "My Entities" Feature (AC 2)

**Entity Assignment:**
- UKNF employees can be assigned to specific entities
- Assignment stored in UserEntityAssignment table or similar
- "My Entities" filter shows only reports from assigned entities
- If no entities assigned, "My Entities" shows nothing (or all if admin)

**Implementation:**
```csharp
if (query.MyEntitiesOnly)
{
    var assignedEntityIds = await _userEntityAssignmentRepository.GetAssignedEntityIdsAsync(currentUserId);
    queryable = queryable.Where(r => assignedEntityIds.Contains(r.EntityId));
}
```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Authorization for UKNF only**
   ```csharp
   // ✅ CORRECT - Check user is UKNF employee
   var user = await _currentUserService.GetCurrentUserAsync();
   if (user.UserType != UserType.Internal)
       throw new ForbiddenException("Access denied. UKNF employees only.");
   ```

2. **Dynamic sorting on any column (AC 5)**
   ```csharp
   // ✅ CORRECT - Support any column sorting
   query = sortBy switch
   {
       "EntityName" => sortDesc ? query.OrderByDescending(r => r.Entity.Name) : query.OrderBy(r => r.Entity.Name),
       "ReportName" => sortDesc ? query.OrderByDescending(r => r.FileName) : query.OrderBy(r => r.FileName),
       "SubmitterName" => sortDesc ? query.OrderByDescending(r => r.User.LastName).ThenBy(r => r.User.FirstName) : query.OrderBy(r => r.User.LastName).ThenBy(r => r.User.FirstName),
       // ... all other columns
       _ => query.OrderByDescending(r => r.SubmittedDate) // Default
   };
   ```

3. **Expanded search scope (AC 7)**
   ```csharp
   // ✅ CORRECT - Search entity, report, submitter
   if (!string.IsNullOrEmpty(searchTerm))
   {
       var searchLower = searchTerm.ToLower();
       query = query.Where(r => 
           r.Entity.Name.ToLower().Contains(searchLower) ||
           r.FileName.ToLower().Contains(searchLower) ||
           (r.User.FirstName + " " + r.User.LastName).ToLower().Contains(searchLower) ||
           r.User.Email.ToLower().Contains(searchLower));
   }
   ```

4. **Include entity and submitter details (AC 4)**
   ```csharp
   // ✅ CORRECT - Eager load related entities
   query = _context.Reports
       .Include(r => r.Entity)
       .Include(r => r.User)
       .AsQueryable();
   ```

### PrimeNG Components

**Registers Navigation (TabView):**
```html
<p-tabView (onChange)="onRegisterChange($event)">
  <p-tabPanel header="All Reports" [selected]="activeRegister === null">
  </p-tabPanel>
  <p-tabPanel header="Quarterly Reports">
  </p-tabPanel>
  <p-tabPanel header="Annual Reports">
  </p-tabPanel>
  <p-tabPanel header="Monthly Reports">
  </p-tabPanel>
  <p-tabPanel header="Archival">
  </p-tabPanel>
</p-tabView>
```

**"My Entities" Toggle:**
```html
<div class="flex items-center gap-2">
  <p-inputSwitch 
    [(ngModel)]="myEntitiesOnly" 
    (onChange)="onMyEntitiesToggle()">
  </p-inputSwitch>
  <label>My Entities Only</label>
</div>
```

**Entity Filter (AutoComplete):**
```html
<p-autoComplete 
  [(ngModel)]="selectedEntity"
  [suggestions]="filteredEntities"
  (completeMethod)="filterEntities($event)"
  field="name"
  placeholder="Select Entity"
  [dropdown]="true">
</p-autoComplete>
```

**Table with Submitter Details:**
```html
<td>
  <div class="flex flex-col">
    <span class="font-semibold">{{ report.submitterName }}</span>
    <a [href]="'mailto:' + report.submitterEmail" class="text-sm text-blue-600">
      {{ report.submitterEmail }}
    </a>
    <a [href]="'tel:' + report.submitterPhone" class="text-sm text-gray-600">
      {{ report.submitterPhone }}
    </a>
  </div>
</td>
```

### Security Requirements

- Only UKNF employees can access this view
- External users get 403 Forbidden
- "My Entities" filter based on actual entity assignments
- All data access logged for audit
- Export respects same filters and permissions

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- UKNF view potentially shows reports from ALL entities (thousands)
- Must use efficient pagination and filtering
- Entity autocomplete should load incrementally (not all entities at once)
- Indexes on: EntityId, ValidationStatus, IsArchived, ReportType, SubmittedDate
- "My Entities" filter reduces query scope significantly

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Register filtering works correctly
- "My Entities" shows only assigned entities
- Entity filter works
- Archival status filter works
- Search by entity name works
- Sort by any column works
- External user access denied

### Additional Notes

1. **Registers vs. Filters:** Registers are essentially a convenient UI grouping that maps to ReportType filter. Backend treats them as filters.

2. **"My Entities" Assignment:** The entity assignment mechanism may need to be implemented separately. Could be part of Epic 2 (permissions) or a simple UserEntityAssignment table.

3. **Submitter Display:** Three options for displaying name + email + phone:
   - Single cell with stacked layout (recommended for readability)
   - Three separate columns (takes more width)
   - Tooltip/popover on hover

4. **Archival Status:** Default view should show current (non-archived) reports only. User explicitly toggles to see archived.

5. **Sort by Any Column:** Unlike external user view (3 sortable columns), UKNF view allows sorting by all columns for maximum flexibility.

6. **Search Scope:** Broader than external view - includes entity name and submitter email, not just names.

7. **Export:** Export should include all the additional columns (entity, submitter contact details).

8. **Mobile Responsiveness:** Table has many columns - may need horizontal scroll on mobile or consider card view for mobile devices.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

