# Story 4.11: Reporting Calendar/Timetable

**Epic:** 4 - Reporting System  
**Story Number:** 4.11  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** Employee of a Supervised Entity,  
**I want to** view upcoming reporting deadlines,  
**So that** I can submit reports on time.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.11

1. User can access "Reporting Calendar" showing upcoming deadlines
2. Calendar displays: Report type, Reporting period, Due date, Submission status
3. Calendar highlights upcoming deadlines (e.g., within 7 days)
4. Calendar shows overdue reports (past due date, not submitted)
5. User receives reminders for upcoming deadlines (configurable, e.g., 7 days, 3 days, 1 day before)
6. Calendar shows submission status: Not submitted, Submitted, Validated successfully, Errors
7. User can filter calendar by report type or period
8. Calendar can display in month view or list view

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ReportingPeriod domain entity** (AC: 1, 2)
  - [ ] Create `ReportingPeriod.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - ReportType (string, required) - e.g., "Quarterly", "Annual"
    - PeriodName (string, required) - e.g., "Q1_2025"
    - DueDate (DateTime, required) - deadline
    - ApplicableEntityTypes (string?, optional) - JSON array of entity types, null = all entities
    - IsActive (bool, default true) - can be deactivated
    - CreatedByUserId (Guid) - UKNF employee who created
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)
  - [ ] Note: Created in Story 4.12, used in this story

- [ ] **Task 2: Create GetReportingCalendarQuery** (AC: 1, 2, 6, 7)
  - [ ] Create `GetReportingCalendarQuery.cs` in `Application/UknfPlatform.Application.Communication/Reports/Queries/`
  - [ ] Query properties:
    - EntityId (long?, optional) - defaults to user's selected entity
    - ReportType (string?, optional) - filter by type (AC 7)
    - PeriodName (string?, optional) - filter by period (AC 7)
    - IncludePastDeadlines (bool, default: false) - show historical deadlines
  - [ ] Note: Filters AC 7

- [ ] **Task 3: Create GetReportingCalendarQueryHandler** (AC: 1, 2, 3, 4, 6)
  - [ ] Create `GetReportingCalendarQueryHandler.cs` implementing `IRequestHandler<GetReportingCalendarQuery, ReportingCalendarResponse>`
  - [ ] Inject: IReportingPeriodRepository, IReportRepository, ICurrentUserService, IEntityRepository
  - [ ] Handler logic:
    - Get user's entity (if not provided)
    - Fetch applicable reporting periods for entity
    - Filter by entity type if ApplicableEntityTypes specified
    - For each period, check if report submitted
    - Determine submission status (AC 6):
      * Not submitted: No report for this period
      * Submitted: Report exists, status = Working/Transmitted/Ongoing
      * Validated successfully: Report exists, status = Successful
      * Errors: Report exists, status = ValidationErrors/TechnicalError
    - Calculate if upcoming (within 7 days) or overdue (AC 3, 4)
    - Apply filters (ReportType, PeriodName)
    - Return ReportingCalendarResponse with list of calendar items

- [ ] **Task 4: Create ReportingCalendarItemDto** (AC: 2, 3, 4, 6)
  - [ ] Create `ReportingCalendarItemDto.cs` record
  - [ ] Properties (from AC 2):
    - ReportingPeriodId (Guid)
    - ReportType (string)
    - ReportingPeriod (string) - PeriodName
    - DueDate (DateTime)
    - SubmissionStatus (string) - AC 6
    - IsUpcoming (bool) - within 7 days (AC 3)
    - IsOverdue (bool) - past due, not submitted (AC 4)
    - DaysUntilDue (int) - negative if overdue
    - ReportId (Guid?) - if report submitted
    - SubmittedDate (DateTime?) - when submitted
    - ValidationStatus (string?) - if submitted

- [ ] **Task 5: Create REST API endpoint GET /api/reports/calendar** (AC: 1, 7)
  - [ ] Update ReportsController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetReportingCalendarAsync([FromQuery] GetReportingCalendarQuery query)`
  - [ ] Send query via MediatR
  - [ ] Return 200 OK with ReportingCalendarResponse
  - [ ] Add Swagger annotations

- [ ] **Task 6: Implement reminder notification system** (AC: 5)
  - [ ] Create `ReportingReminderWorker.cs` background service in `Workers/`
  - [ ] Run daily (scheduled at specific time, e.g., 8:00 AM)
  - [ ] Logic:
    - Fetch all active reporting periods
    - For each period, check days until due
    - If 7 days before: Send 7-day reminder
    - If 3 days before: Send 3-day reminder
    - If 1 day before: Send 1-day reminder
    - Only send if report not yet submitted or not validated successfully
  - [ ] Use Hangfire or Quartz.NET for scheduling

- [ ] **Task 7: Create reminder email templates** (AC: 5)
  - [ ] 7-day reminder:
    - Subject: "Reminder: Report Due in 7 Days - [Report Type] [Period]"
    - Body: "Your [Report Type] report for [Period] is due on [Due Date]."
  - [ ] 3-day reminder:
    - Subject: "Reminder: Report Due in 3 Days - [Report Type] [Period]"
  - [ ] 1-day reminder:
    - Subject: "Urgent: Report Due Tomorrow - [Report Type] [Period]"
  - [ ] Overdue reminder (optional):
    - Subject: "Overdue Report: [Report Type] [Period]"

- [ ] **Task 8: Create ReminderSent tracking** (AC: 5)
  - [ ] Create `ReportingReminder` entity or table
  - [ ] Track which reminders sent to which entities
  - [ ] Prevent duplicate reminders
  - [ ] Properties:
    - Id (Guid)
    - ReportingPeriodId (Guid)
    - EntityId (long)
    - ReminderType (enum: SevenDay, ThreeDay, OneDay, Overdue)
    - SentDate (DateTime)
  - [ ] Index: (ReportingPeriodId, EntityId, ReminderType) - unique

- [ ] **Task 9: Make reminder configuration user-configurable** (AC: 5)
  - [ ] Create user preferences or system settings
  - [ ] Allow users to opt in/out of reminders
  - [ ] Allow users to configure which reminders (7-day, 3-day, 1-day)
  - [ ] Default: All reminders enabled
  - [ ] Future enhancement: User can set custom reminder days

### Frontend Tasks

- [ ] **Task 10: Create reporting calendar service** (AC: 1)
  - [ ] Create `reporting-calendar.service.ts` in `core/services/`
  - [ ] Methods:
    - `getCalendar(filters): Observable<ReportingCalendarResponse>`
  - [ ] Handle errors with catchError

- [ ] **Task 11: Create reporting calendar component** (AC: 1, 8)
  - [ ] Create `reporting-calendar.component.ts` in `features/reporting/`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/reports/calendar` with auth guard
  - [ ] Inject ReportingCalendarService, Router
  - [ ] Load calendar on init
  - [ ] Support two view modes: List and Month (AC 8)

- [ ] **Task 12: Implement list view** (AC: 2, 3, 4, 6, 8)
  - [ ] Display calendar items in table/list format
  - [ ] Use PrimeNG DataView or Table
  - [ ] Columns (AC 2):
    - Report Type
    - Reporting Period
    - Due Date
    - Days Until Due (or "X days overdue")
    - Submission Status (AC 6)
    - Action (Submit Report link)
  - [ ] Highlight upcoming (within 7 days) - yellow/warning color (AC 3)
  - [ ] Highlight overdue - red/danger color (AC 4)
  - [ ] Group by status: Overdue, Upcoming, Later

- [ ] **Task 13: Implement month view** (AC: 8)
  - [ ] Display calendar in month format
  - [ ] Use PrimeNG FullCalendar or custom calendar component
  - [ ] Show deadlines as events on calendar
  - [ ] Color-code by status:
    - Overdue: Red
    - Upcoming (within 7 days): Yellow
    - Not submitted (future): Blue
    - Submitted: Gray
    - Validated successfully: Green
  - [ ] Click event to view details or submit report

- [ ] **Task 14: Display submission status** (AC: 6)
  - [ ] Status badges with appropriate colors:
    - **Not submitted:** Gray badge, "Not Submitted"
    - **Submitted:** Blue badge, "Submitted - Pending Validation"
    - **Validated successfully:** Green badge, "Validated Successfully"
    - **Errors:** Red badge, "Validation Errors"
  - [ ] Use PrimeNG Tag component

- [ ] **Task 15: Highlight upcoming deadlines** (AC: 3)
  - [ ] If IsUpcoming = true (within 7 days):
    - Show warning badge or icon
    - Use yellow/orange background
    - Display "Due in X days"
  - [ ] Sort upcoming deadlines to top of list

- [ ] **Task 16: Highlight overdue reports** (AC: 4)
  - [ ] If IsOverdue = true (past due, not submitted):
    - Show danger badge or icon
    - Use red background
    - Display "X days overdue"
    - Make row prominent (bold, larger text)
  - [ ] Sort overdue to very top of list

- [ ] **Task 17: Implement filters** (AC: 7)
  - [ ] Create filter panel
  - [ ] Filter fields:
    - Report Type (dropdown)
    - Period (dropdown or input)
  - [ ] "Apply Filters" button
  - [ ] "Clear Filters" button
  - [ ] On filter change, reload calendar

- [ ] **Task 18: Add view toggle** (AC: 8)
  - [ ] Toggle button: "List View" / "Month View"
  - [ ] Switch between list and calendar views
  - [ ] Use PrimeNG ButtonGroup or ToggleButton
  - [ ] Save preference in local storage

- [ ] **Task 19: Add "Submit Report" action** (AC: Related)
  - [ ] For each calendar item with status "Not submitted":
    - Show "Submit Report" button/link
    - Navigate to `/reports/submit` with pre-filled metadata
    - Pass ReportType and ReportingPeriod to submission form

- [ ] **Task 20: Display submitted report details** (AC: 6)
  - [ ] For items with status "Submitted" or later:
    - Show link to report details
    - Display submission date
    - Show validation status

- [ ] **Task 21: Create page layout** (AC: All)
  - [ ] Page title: "Reporting Calendar"
  - [ ] Breadcrumb: Reports > Calendar
  - [ ] Layout sections:
    - Header with view toggle (List/Month)
    - Filters panel
    - Calendar/list display
    - Legend (color meanings)
  - [ ] Info message: Explain overdue (red), upcoming (yellow), submitted (green)
  - [ ] Use PrimeNG Card, Panel components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 22: Show empty state** (AC: 1)
  - [ ] If no upcoming deadlines: "No upcoming reporting deadlines"
  - [ ] If all reports submitted: "All reports submitted. Great job!"
  - [ ] Friendly message

- [ ] **Task 23: Add notification badge** (AC: 3, 4)
  - [ ] In navigation menu, show badge on "Calendar" link
  - [ ] Badge shows count of overdue + upcoming (within 7 days)
  - [ ] Example: "Calendar (3)" - 3 items need attention
  - [ ] Use PrimeNG Badge

### Testing Tasks

- [ ] **Task 24: Write unit tests for GetReportingCalendarQueryHandler**
  - [ ] Test: `Handle_NoReportsSubmitted_ReturnsNotSubmittedStatus` (AC 6)
  - [ ] Test: `Handle_ReportSubmitted_ReturnsSubmittedStatus` (AC 6)
  - [ ] Test: `Handle_ReportValidatedSuccessfully_ReturnsValidatedStatus` (AC 6)
  - [ ] Test: `Handle_DueWithin7Days_MarksAsUpcoming` (AC 3)
  - [ ] Test: `Handle_PastDueNotSubmitted_MarksAsOverdue` (AC 4)
  - [ ] Test: `Handle_FilterByReportType_ReturnsFiltered` (AC 7)
  - [ ] Mock: IReportingPeriodRepository, IReportRepository

- [ ] **Task 25: Write unit tests for ReportingReminderWorker**
  - [ ] Test: `Run_7DaysBefore_SendsReminder` (AC 5)
  - [ ] Test: `Run_3DaysBefore_SendsReminder` (AC 5)
  - [ ] Test: `Run_1DayBefore_SendsReminder` (AC 5)
  - [ ] Test: `Run_AlreadySent_DoesNotSendDuplicate` (AC 5)
  - [ ] Test: `Run_ReportSubmitted_DoesNotSendReminder`

- [ ] **Task 26: Write integration test for calendar endpoint**
  - [ ] Test: `GET_Calendar_ReturnsUpcomingDeadlines` (AC 1, 2)
  - [ ] Test: `GET_Calendar_HighlightsUpcoming` (AC 3)
  - [ ] Test: `GET_Calendar_ShowsOverdue` (AC 4)
  - [ ] Test: `GET_Calendar_ShowsSubmissionStatus` (AC 6)
  - [ ] Test: `GET_Calendar_FilterByReportType` (AC 7)
  - [ ] Create test data: reporting periods with various due dates
  - [ ] Create test reports with various statuses

- [ ] **Task 27: Write E2E test for calendar flow**
  - [ ] Test workflow:
    1. Login as external user
    2. Navigate to Reports > Calendar
    3. Verify calendar displays (AC 1)
    4. Verify columns: Report Type, Period, Due Date, Status (AC 2)
    5. Verify upcoming deadlines highlighted (AC 3)
    6. Verify overdue reports highlighted (AC 4)
    7. Switch to Month View (AC 8)
    8. Verify month calendar displays
    9. Switch back to List View
    10. Apply filter by report type (AC 7)
    11. Click "Submit Report" for not-submitted item
    12. Verify redirected to submit form with pre-filled data
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**New Entities:**
- ReportingPeriod: Created by UKNF in Story 4.12, used here

**Key Integration:**
- Story 4.12 creates reporting periods (UKNF admin)
- This story displays those periods to external users
- Story 4.1 submission should link to reporting period (optional enhancement)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- Scheduling: Hangfire 1.8 or Quartz.NET 3.8
- Email: IEmailService (MailDev for demo)

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (FullCalendar, DataView, Tag, ButtonGroup)
- Calendar: PrimeNG FullCalendar or @fullcalendar/angular
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Domain/UknfPlatform.Domain.Communication/Entities/
│   ├── ReportingPeriod.cs (CREATE)
│   └── ReportingReminder.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Reports/Queries/
│   ├── GetReportingCalendarQuery.cs (CREATE)
│   └── GetReportingCalendarQueryHandler.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Reports/DTOs/
│   ├── ReportingCalendarResponse.cs (CREATE)
│   └── ReportingCalendarItemDto.cs (CREATE)
├── Workers/UknfPlatform.Workers.Reporting/
│   └── ReportingReminderWorker.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Persistence/
    ├── Repositories/
    │   ├── IReportingPeriodRepository.cs (CREATE)
    │   └── ReportingPeriodRepository.cs (CREATE)
    └── Migrations/
        ├── Add_ReportingPeriods_Table.cs (CREATE)
        └── Add_ReportingReminders_Table.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reporting-calendar.service.ts (CREATE)
└── features/reporting/reporting-calendar/
    ├── reporting-calendar.component.ts (CREATE)
    ├── reporting-calendar.component.html (CREATE)
    ├── reporting-calendar.component.scss (CREATE)
    └── components/
        ├── calendar-list-view.component.ts (CREATE)
        └── calendar-month-view.component.ts (CREATE)
```

### Data Models

**ReportingPeriod Entity:**
- Represents a deadline for a specific report type and period
- Created by UKNF (Story 4.12)
- Applies to all or specific entity types

**ReportingReminder Entity:**
- Tracks which reminders sent to avoid duplicates
- Links ReportingPeriod to Entity
- ReminderType: SevenDay, ThreeDay, OneDay

**Database Schema:**
```sql
CREATE TABLE ReportingPeriods (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ReportType NVARCHAR(250) NOT NULL,
    PeriodName NVARCHAR(100) NOT NULL,
    DueDate DATETIME2 NOT NULL,
    ApplicableEntityTypes NVARCHAR(MAX) NULL, -- JSON array
    IsActive BIT NOT NULL DEFAULT 1,
    CreatedByUserId UUID NOT NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (CreatedByUserId) REFERENCES Users(Id),
    INDEX IX_ReportingPeriods_DueDate (DueDate),
    INDEX IX_ReportingPeriods_IsActive (IsActive),
    UNIQUE (ReportType, PeriodName)
);

CREATE TABLE ReportingReminders (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ReportingPeriodId UUID NOT NULL,
    EntityId BIGINT NOT NULL,
    ReminderType NVARCHAR(50) NOT NULL CHECK (ReminderType IN ('SevenDay', 'ThreeDay', 'OneDay', 'Overdue')),
    SentDate DATETIME2 NOT NULL,
    
    FOREIGN KEY (ReportingPeriodId) REFERENCES ReportingPeriods(Id),
    FOREIGN KEY (EntityId) REFERENCES Entities(Id),
    UNIQUE (ReportingPeriodId, EntityId, ReminderType)
);
```

### REST API Specification

**Endpoint:** GET `/api/reports/calendar`
- **Security:** Requires authentication
- **Query Parameters:**
  - entityId (long?, optional)
  - reportType (string?, optional) - AC 7
  - periodName (string?, optional) - AC 7
  - includePastDeadlines (bool?, optional)
- **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "reportingPeriodId": "guid",
        "reportType": "Quarterly",
        "reportingPeriod": "Q1_2025",
        "dueDate": "2025-04-15T23:59:59Z",
        "submissionStatus": "Not submitted",
        "isUpcoming": true,
        "isOverdue": false,
        "daysUntilDue": 5,
        "reportId": null,
        "submittedDate": null,
        "validationStatus": null
      },
      {
        "reportingPeriodId": "guid2",
        "reportType": "Annual",
        "reportingPeriod": "Annual_2024",
        "dueDate": "2025-03-31T23:59:59Z",
        "submissionStatus": "Validated successfully",
        "isUpcoming": false,
        "isOverdue": false,
        "daysUntilDue": -10,
        "reportId": "report-guid",
        "submittedDate": "2025-03-20T10:00:00Z",
        "validationStatus": "Successful"
      }
    ]
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Calculate days until due correctly**
   ```csharp
   // ✅ CORRECT
   var daysUntilDue = (period.DueDate.Date - DateTime.UtcNow.Date).Days;
   var isUpcoming = daysUntilDue >= 0 && daysUntilDue <= 7; // AC 3
   var isOverdue = daysUntilDue < 0 && !reportSubmitted; // AC 4
   ```

2. **Check if applicable to entity**
   ```csharp
   // ✅ CORRECT - Check ApplicableEntityTypes
   if (!string.IsNullOrEmpty(period.ApplicableEntityTypes))
   {
       var applicableTypes = JsonSerializer.Deserialize<string[]>(period.ApplicableEntityTypes);
       if (!applicableTypes.Contains(entity.EntityType))
           continue; // Skip this period for this entity
   }
   ```

3. **Determine submission status (AC 6)**
   ```csharp
   // ✅ CORRECT
   var submissionStatus = report switch
   {
       null => "Not submitted",
       { ValidationStatus: ValidationStatus.Working or ValidationStatus.Transmitted or ValidationStatus.Ongoing } => "Submitted",
       { ValidationStatus: ValidationStatus.Successful } => "Validated successfully",
       { ValidationStatus: ValidationStatus.ValidationErrors or ValidationStatus.TechnicalError } => "Errors",
       _ => "Submitted"
   };
   ```

4. **Scheduled reminder job (AC 5)**
   ```csharp
   // ✅ CORRECT - Use Hangfire recurring job
   RecurringJob.AddOrUpdate<ReportingReminderWorker>(
       "reporting-reminders",
       worker => worker.SendRemindersAsync(),
       Cron.Daily(8)); // Run at 8:00 AM daily
   ```

5. **Prevent duplicate reminders (AC 5)**
   ```csharp
   // ✅ CORRECT - Check if already sent
   var alreadySent = await _context.ReportingReminders.AnyAsync(r =>
       r.ReportingPeriodId == periodId &&
       r.EntityId == entityId &&
       r.ReminderType == ReminderType.SevenDay);
   
   if (!alreadySent)
   {
       await SendReminderAsync(entity, period, ReminderType.SevenDay);
       await TrackReminderSentAsync(periodId, entityId, ReminderType.SevenDay);
   }
   ```

### UI/UX Considerations

**List View:**
```html
<p-dataView [value]="calendarItems" layout="list">
  <ng-template let-item pTemplate="listItem">
    <div class="calendar-item" 
         [ngClass]="{
           'overdue': item.isOverdue,
           'upcoming': item.isUpcoming
         }">
      <div class="flex justify-between items-center">
        <div>
          <h3>{{ item.reportType }} - {{ item.reportingPeriod }}</h3>
          <p>Due: {{ item.dueDate | date }}</p>
          <p *ngIf="item.isOverdue" class="text-red-600 font-bold">
            {{ Math.abs(item.daysUntilDue) }} days overdue
          </p>
          <p *ngIf="item.isUpcoming" class="text-yellow-600">
            Due in {{ item.daysUntilDue }} days
          </p>
        </div>
        <div>
          <p-tag [value]="item.submissionStatus" [severity]="getStatusSeverity(item.submissionStatus)"></p-tag>
          <button *ngIf="item.submissionStatus === 'Not submitted'" 
                  pButton 
                  label="Submit Report" 
                  (click)="submitReport(item)">
          </button>
        </div>
      </div>
    </div>
  </ng-template>
</p-dataView>
```

**Month View with FullCalendar:**
```html
<full-calendar 
  [options]="calendarOptions"
  (dateClick)="handleDateClick($event)"
  (eventClick)="handleEventClick($event)">
</full-calendar>

<!-- Component: -->
calendarOptions: CalendarOptions = {
  initialView: 'dayGridMonth',
  events: this.calendarItems.map(item => ({
    title: `${item.reportType} - ${item.submissionStatus}`,
    date: item.dueDate,
    color: this.getEventColor(item),
    extendedProps: { item }
  }))
};
```

### Reminder Email Template (AC 5)

**7-Day Reminder:**
```
Subject: Reminder: Report Due in 7 Days - Quarterly Q1_2025

Dear [Entity Name],

This is a reminder that your Quarterly report for Q1_2025 is due on April 15, 2025 (in 7 days).

Report Type: Quarterly
Reporting Period: Q1_2025
Due Date: April 15, 2025

Submit Report: [Link to Calendar/Submit]

Please ensure timely submission to avoid penalties.

Best regards,
UKNF Platform
```

### Business Rules

**Upcoming Threshold (AC 3):** 7 days
**Reminder Schedule (AC 5):** 7 days, 3 days, 1 day before
**Submission Status Logic (AC 6):**
- Not submitted: No report exists
- Submitted: Report exists, not yet validated
- Validated successfully: Report with Successful status
- Errors: Report with error status

### Security Requirements

- Only authenticated users can access calendar
- Users see deadlines for their entities only
- Reminders sent only to users with email addresses
- No deadline data exposed to unauthorized users

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Calendar query efficient (indexed on DueDate, IsActive)
- Reminder worker processes entities in batches
- Cache reporting periods (changes infrequently)
- Month view may load all deadlines (acceptable for reasonable count)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Upcoming highlighted correctly (within 7 days)
- Overdue highlighted correctly (past due, not submitted)
- Submission status determined correctly
- Reminders sent at correct intervals
- No duplicate reminders sent
- Filters work correctly

**Example:**
```csharp
[Fact]
public async Task Handle_DueIn5Days_MarksAsUpcoming()
{
    // Arrange - AC 3
    var entity = CreateTestEntity();
    var period = CreateTestReportingPeriod(
        dueDate: DateTime.UtcNow.AddDays(5));
    
    await _context.ReportingPeriods.AddAsync(period);
    await _context.SaveChangesAsync();
    
    var query = new GetReportingCalendarQuery { EntityId = entity.Id };
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.Items.Should().HaveCount(1);
    result.Items[0].IsUpcoming.Should().BeTrue();
    result.Items[0].DaysUntilDue.Should().Be(5);
}
```

### Additional Notes

1. **Reporting Periods Management:** Story 4.12 covers UKNF creating/managing reporting periods. This story assumes periods exist.

2. **ApplicableEntityTypes:** If specified, period applies only to certain entity types (e.g., "Banks", "Insurance Companies"). If null, applies to all.

3. **Past Deadlines:** By default, calendar shows future + recent past. User can toggle to include all historical deadlines.

4. **Submission Linking:** When user submits report from calendar, automatically link to reporting period for compliance tracking (Story 4.12).

5. **Multiple Entities:** If user represents multiple entities, show calendar for selected entity or combined view.

6. **Calendar Sync:** Future enhancement: iCal export for syncing with Outlook/Google Calendar.

7. **Reminder Preferences:** Users should be able to configure reminder preferences (which reminders, email vs. in-app, etc.).

8. **Overdue Escalation:** Future: Automatic escalation if report remains overdue for X days.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

