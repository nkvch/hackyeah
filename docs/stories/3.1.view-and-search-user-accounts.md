# Story 3.1: View and Search User Accounts

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.1  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** view and search all user accounts in the system,  
**So that** I can manage users efficiently.

---

## Acceptance Criteria

1. System Administrator can view list of all users (internal and external)
2. List displays: Name, Email, User Type (Internal/External), Status (Active/Inactive/Blocked), Roles, Last Login
3. Administrator can filter by: User type, Status, Role, Entity (for external users)
4. Administrator can search by: Name, Email, PESEL (last 4 digits)
5. Administrator can sort by: Name, Email, Last Login, Registration Date
6. List supports pagination for large datasets
7. Administrator can export user list (CSV, Excel)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetUsersQuery and Handler** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `GetUsersQuery.cs` in `Application/UknfPlatform.Application.Admin/Users/Queries/`
  - [ ] Query properties: PageNumber, PageSize, SearchTerm, UserType, Status, RoleId, EntityId, SortBy, SortDirection
  - [ ] Create `GetUsersQueryHandler.cs` implementing `IRequestHandler<GetUsersQuery, PagedUsersResponse>`
  - [ ] Inject: IUserRepository, IMapper (Mapster)
  - [ ] Handler logic:
    - Build query with filters (UserType, Status, RoleId filter)
    - Apply search (FirstName, LastName, Email, PeselLast4)
    - Apply entity filter for external users
    - Apply sorting (Name, Email, LastLoginDate, CreatedDate)
    - Apply pagination (default: page 1, size 20, max 100)
    - Map to UserListDto using Mapster
    - Include role names and entity count
    - Return PagedUsersResponse

- [ ] **Task 2: Create GetUsersQueryValidator** (AC: 3, 5, 6)
  - [ ] Create `GetUsersQueryValidator.cs` using FluentValidation
  - [ ] Validate PageNumber >= 1
  - [ ] Validate PageSize between 1 and 100
  - [ ] Validate SearchTerm MaxLength 256
  - [ ] Validate UserType enum if provided
  - [ ] Validate Status enum if provided
  - [ ] Validate SortBy allowed values

- [ ] **Task 3: Create UserListDto** (AC: 2)
  - [ ] Create `UserListDto.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - Id (Guid)
    - FirstName (string)
    - LastName (string)
    - Email (string)
    - UserType (string: Internal/External)
    - Status (string: Active/Inactive/Blocked)
    - Roles (List<string>) - role names
    - LastLoginDate (DateTime?)
    - CreatedDate (DateTime)
    - EntityCount (int) - for external users
    - PeselLast4 (string) - for display

- [ ] **Task 4: Create PagedUsersResponse** (AC: 6)
  - [ ] Create `PagedUsersResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - Items (List<UserListDto>)
    - TotalCount (int)
    - Page (int)
    - PageSize (int)
    - TotalPages (int) - calculated

- [ ] **Task 5: Create REST API endpoint GET /api/admin/users** (AC: 1, 3, 4, 5, 6)
  - [ ] Create `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create GET action `GetUsersAsync(GetUsersQuery query)`
  - [ ] Inject IMediator
  - [ ] Send query via MediatR
  - [ ] Return 200 OK with PagedUsersResponse
  - [ ] Add Swagger documentation with parameter descriptions
  - [ ] Add XML comments

- [ ] **Task 6: Extend IUserRepository with search/filter methods** (AC: 3, 4, 5, 6)
  - [ ] Update `IUserRepository.cs` in `Domain/UknfPlatform.Domain.Auth/Repositories/`
  - [ ] Add method: `GetPagedUsersAsync(filters, search, sort, page, pageSize)`
  - [ ] Update `UserRepository.cs` in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/`
  - [ ] Implement using EF Core LINQ with:
    - `.Where()` for filters
    - `.Include()` for Roles and UserEntities
    - `.OrderBy()` or `.OrderByDescending()` for sorting
    - `.Skip()` and `.Take()` for pagination
    - `.AsNoTracking()` for read-only query
  - [ ] Use dynamic sorting based on SortBy parameter

- [ ] **Task 7: Create ExportUsersCommand and Handler** (AC: 7)
  - [ ] Create `ExportUsersCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties: Same filters as GetUsersQuery, ExportFormat (CSV, Excel)
  - [ ] Create `ExportUsersCommandHandler.cs`
  - [ ] Inject: IUserRepository, IExportService (to create)
  - [ ] Handler logic:
    - Get filtered users (all, no pagination)
    - Generate CSV or Excel file using ClosedXML
    - Return file stream with content type and filename
  - [ ] Log export action for audit

- [ ] **Task 8: Create IExportService** (AC: 7)
  - [ ] Create `IExportService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Method: `ExportToCsv<T>(data, fileName)`
  - [ ] Method: `ExportToExcel<T>(data, fileName, sheetName)`
  - [ ] Create `ExportService.cs` implementation in `Infrastructure/UknfPlatform.Infrastructure.Shared/Services/`
  - [ ] Use ClosedXML for Excel generation
  - [ ] Use CsvHelper or string builder for CSV

- [ ] **Task 9: Create REST API endpoint GET /api/admin/users/export** (AC: 7)
  - [ ] Add action to UsersController: `ExportUsersAsync(ExportUsersCommand command)`
  - [ ] `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Return file result with appropriate content type:
    - CSV: "text/csv"
    - Excel: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  - [ ] Set filename: "users-export-{date}.csv" or ".xlsx"

- [ ] **Task 10: Create System Administrator authorization policy** (AC: All)
  - [ ] Update `Program.cs` authorization configuration
  - [ ] Add policy: `"SystemAdministrator"` requires role "System Administrator"
  - [ ] Or check permission: `"admin.users.view"`
  - [ ] Ensure policy is enforced on all admin endpoints

### Frontend Tasks

- [ ] **Task 11: Create users service** (AC: 1)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Inject HttpClient
  - [ ] Method: `getUsers(params): Observable<PagedUsersResponse>`
  - [ ] Method: `exportUsers(params, format): Observable<Blob>`
  - [ ] Handle errors with catchError

- [ ] **Task 12: Create user list component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/users/user-list/user-list.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/admin/users` with auth guard + role guard
  - [ ] Use PrimeNG Table component (p-table)
  - [ ] Columns: Name, Email, User Type, Status, Roles, Last Login, Actions
  - [ ] Enable lazy loading for pagination

- [ ] **Task 13: Implement filtering UI** (AC: 3, 4)
  - [ ] Add filter controls above table:
    - User Type dropdown (All, Internal, External)
    - Status dropdown (All, Active, Inactive, Blocked)
    - Role multiselect dropdown
    - Entity dropdown (for external users)
  - [ ] Add search input with debounce (300ms)
  - [ ] Search placeholder: "Search by name, email, or PESEL (last 4 digits)"
  - [ ] Apply filters button
  - [ ] Clear filters button

- [ ] **Task 14: Implement sorting** (AC: 5)
  - [ ] Enable column sorting in PrimeNG table
  - [ ] Sortable columns: Name, Email, Last Login, Created Date
  - [ ] Send sort parameters to backend on column header click
  - [ ] Show sort indicators (up/down arrows)

- [ ] **Task 15: Implement pagination** (AC: 6)
  - [ ] Use PrimeNG Paginator component
  - [ ] Display: Total records, page size selector (10, 20, 50, 100)
  - [ ] Page navigation buttons
  - [ ] Update URL query params on page change
  - [ ] Fetch new page data on pagination change

- [ ] **Task 16: Display user data** (AC: 2)
  - [ ] Name column: `firstName + lastName`
  - [ ] Email column: clickable mailto link
  - [ ] User Type: Badge with color (Internal: blue, External: green)
  - [ ] Status: Badge with color (Active: green, Inactive: gray, Blocked: red)
  - [ ] Roles: Comma-separated list or chips
  - [ ] Last Login: Formatted date-time or "Never"
  - [ ] Actions column: View details icon button

- [ ] **Task 17: Implement export functionality** (AC: 7)
  - [ ] Add "Export" dropdown button above table
  - [ ] Options: "Export to CSV", "Export to Excel"
  - [ ] On click: Call usersService.exportUsers()
  - [ ] Show loading indicator during export
  - [ ] Trigger file download on response
  - [ ] Show success/error notification

- [ ] **Task 18: Create user list page layout** (AC: 1)
  - [ ] Page title: "User Management"
  - [ ] Breadcrumb: Admin > Users
  - [ ] Use main layout with navigation
  - [ ] Filters section: Collapsible panel
  - [ ] Table section: Full-width card
  - [ ] Responsive design for mobile

- [ ] **Task 19: Apply role-based access** (AC: All)
  - [ ] Create RoleGuard or use existing auth guard
  - [ ] Check user has "System Administrator" role
  - [ ] Redirect to 403 Forbidden if unauthorized
  - [ ] Hide "Admin" menu item if user not admin

### Testing Tasks

- [ ] **Task 20: Write unit tests for GetUsersQueryHandler** (AC: All)
  - [ ] Test: `Handle_NoFilters_ReturnsAllUsersPaged`
  - [ ] Test: `Handle_WithUserTypeFilter_ReturnsFilteredUsers`
  - [ ] Test: `Handle_WithSearchTerm_ReturnsMatchingUsers`
  - [ ] Test: `Handle_WithSorting_ReturnsSortedUsers`
  - [ ] Test: `Handle_WithPagination_ReturnsCorrectPage`
  - [ ] Mock: IUserRepository, IMapper
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 21: Write unit tests for GetUsersQueryValidator**
  - [ ] Test: Invalid page number (0, negative)
  - [ ] Test: Invalid page size (0, > 100)
  - [ ] Test: Valid query parameters
  - [ ] Test: Search term max length validation

- [ ] **Task 22: Write unit tests for ExportUsersCommandHandler** (AC: 7)
  - [ ] Test: `Handle_CsvFormat_GeneratesCsvFile`
  - [ ] Test: `Handle_ExcelFormat_GeneratesExcelFile`
  - [ ] Test: `Handle_WithFilters_ExportsFilteredData`
  - [ ] Mock: IUserRepository, IExportService

- [ ] **Task 23: Write integration tests for users endpoints**
  - [ ] Test: `GET_Users_AsSystemAdmin_Returns200WithPagedData`
  - [ ] Test: `GET_Users_AsNonAdmin_Returns403`
  - [ ] Test: `GET_Users_WithFilters_ReturnsFilteredData`
  - [ ] Test: `GET_UsersExport_Returns200WithFileContent`
  - [ ] Use Testcontainers for database
  - [ ] Seed test users with roles

- [ ] **Task 24: Write E2E tests for user list page**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Verify table displays users
    4. Apply filter by User Type
    5. Verify filtered results
    6. Search by email
    7. Verify search results
    8. Sort by Name
    9. Verify sorted order
    10. Export to CSV
    11. Verify file downloaded
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Epic 1 & 2:**
- User entity exists with FirstName, LastName, Email, Phone, PESEL (encrypted)
- UserType enum: Internal, External
- IsActive flag for account status
- Roles and Permissions infrastructure from Epic 2 (if implemented)

**Key Integration:**
- This story reads existing user data created in Epic 1 and 2
- Introduces admin-specific query patterns (filtering, sorting, pagination, export)
- Establishes authorization policy for System Administrators

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Logging: Serilog 3.1.1
- Mapping: Mapster 7.4.0
- Export: ClosedXML 0.102.1 (Excel), CsvHelper (CSV)
- API Documentation: Swashbuckle (Swagger) 6.5.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG
- Styling: Tailwind CSS
- TypeScript: 5.3+ (strict mode enabled)

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── UsersController.cs (CREATE THIS)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Queries/
│   │   ├── GetUsersQuery.cs (CREATE THIS)
│   │   ├── GetUsersQueryHandler.cs (CREATE THIS)
│   │   └── GetUsersQueryValidator.cs (CREATE THIS)
│   ├── Commands/
│   │   ├── ExportUsersCommand.cs (CREATE THIS)
│   │   └── ExportUsersCommandHandler.cs (CREATE THIS)
│   └── DTOs/
│       ├── UserListDto.cs (CREATE THIS)
│       └── PagedUsersResponse.cs (CREATE THIS)
├── Application/UknfPlatform.Application.Shared/Interfaces/
│   └── IExportService.cs (CREATE THIS)
├── Domain/UknfPlatform.Domain.Auth/Repositories/
│   └── IUserRepository.cs (UPDATE - add GetPagedUsersAsync)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/
│   └── UserRepository.cs (UPDATE - implement GetPagedUsersAsync)
└── Infrastructure/UknfPlatform.Infrastructure.Shared/Services/
    └── ExportService.cs (CREATE THIS)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── users.service.ts (CREATE THIS)
├── features/admin/users/user-list/
│   ├── user-list.component.ts (CREATE THIS)
│   ├── user-list.component.html (CREATE THIS)
│   └── user-list.component.scss (CREATE THIS)
└── core/guards/
    └── role.guard.ts (CREATE or UPDATE)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table Schema:**
```sql
CREATE TABLE Users (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    Phone NVARCHAR(20) NOT NULL,
    PeselEncrypted NVARCHAR(500) NOT NULL,
    PeselLast4 NVARCHAR(4) NOT NULL,
    PasswordHash NVARCHAR(500) NOT NULL,
    UserType NVARCHAR(20) NOT NULL CHECK (UserType IN ('Internal', 'External')),
    IsActive BIT NOT NULL DEFAULT 1,
    MustChangePassword BIT NOT NULL DEFAULT 0,
    LastLoginDate DATETIME2 NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    INDEX IX_Users_Email (Email),
    INDEX IX_Users_UserType (UserType),
    INDEX IX_Users_IsActive (IsActive)
);
```

**Roles Table Schema:**
```sql
CREATE TABLE Roles (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    Name NVARCHAR(100) NOT NULL UNIQUE,
    Description NVARCHAR(500) NULL,
    IsSystemRole BIT NOT NULL DEFAULT 0,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

CREATE TABLE UserRoles (
    UserId UUID NOT NULL,
    RoleId UUID NOT NULL,
    AssignedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    AssignedByUserId UUID NULL,
    
    PRIMARY KEY (UserId, RoleId),
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    FOREIGN KEY (RoleId) REFERENCES Roles(Id) ON DELETE CASCADE
);
```

**Key Points:**
- Id is UUID (Guid in C#)
- UserType: "Internal" or "External"
- IsActive: true (Active), false (Inactive/Blocked)
- PESEL: Display only last 4 digits (PeselLast4)
- Many-to-Many relationship with Roles via UserRoles junction table
- For external users, count entities via UserEntities table

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** GET `/api/admin/users`
- **Security:** Requires authentication + "System Administrator" role
- **Query Parameters:**
  - `page` (int, default: 1)
  - `pageSize` (int, default: 20, max: 100)
  - `search` (string) - searches Name, Email, PESEL last 4
  - `userType` (string) - "Internal" or "External"
  - `status` (string) - "Active", "Inactive", "Blocked"
  - `roleId` (uuid) - filter by role
  - `entityId` (long) - filter external users by entity
  - `sortBy` (string) - "Name", "Email", "LastLogin", "CreatedDate"
  - `sortDirection` (string) - "Asc" or "Desc"
- **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "firstName": "Jan",
        "lastName": "Kowalski",
        "email": "jan.kowalski@example.com",
        "userType": "External",
        "status": "Active",
        "roles": ["Entity Administrator", "Report Viewer"],
        "lastLoginDate": "2025-10-04T10:15:00Z",
        "createdDate": "2025-09-01T08:00:00Z",
        "entityCount": 2,
        "peselLast4": "8901"
      }
    ],
    "totalCount": 150,
    "page": 1,
    "pageSize": 20,
    "totalPages": 8
  }
  ```
- **Error Responses:**
  - 401: Unauthorized (not authenticated)
  - 403: Forbidden (not System Administrator)
  - 400: Bad Request (validation errors)

**Endpoint:** GET `/api/admin/users/export`
- **Security:** Requires authentication + "System Administrator" role
- **Query Parameters:** Same as GET /api/admin/users + `format` ("csv" or "excel")
- **Success Response (200 OK):**
  - Content-Type: "text/csv" or "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  - Content-Disposition: attachment; filename="users-export-2025-10-04.csv"
  - Body: File content

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES TO FOLLOW:**

1. **Never use Console.WriteLine** - Use ILogger<T> dependency injection
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation("Exporting {Count} users to {Format}", userCount, format);
   ```

2. **All API responses MUST use DTOs** - Never return domain entities directly
   ```csharp
   // ✅ CORRECT
   public async Task<PagedUsersResponse> GetUsersAsync(GetUsersQuery query)
   ```

3. **All commands/queries MUST have FluentValidation validators**
   ```csharp
   // ✅ REQUIRED
   public class GetUsersQueryValidator : AbstractValidator<GetUsersQuery>
   ```

4. **All async methods MUST end with 'Async' suffix**
   ```csharp
   // ✅ CORRECT
   public async Task<PagedUsersResponse> GetPagedUsersAsync(...)
   ```

5. **Always use .AsNoTracking() for read-only queries**
   ```csharp
   // ✅ CORRECT for queries
   return await _context.Users
       .AsNoTracking()
       .Include(u => u.Roles)
       .ToListAsync();
   ```

6. **Use record types for DTOs**
   ```csharp
   // ✅ CORRECT
   public record UserListDto(
       Guid Id,
       string FirstName,
       string LastName,
       string Email,
       string UserType,
       string Status,
       List<string> Roles,
       DateTime? LastLoginDate,
       DateTime CreatedDate,
       int EntityCount,
       string PeselLast4);
   ```

7. **Pagination required for all list endpoints** - Default page size: 20, max: 100

8. **Authorization checks use policy-based authorization**
   ```csharp
   // ✅ CORRECT
   [Authorize(Policy = "SystemAdministrator")]
   public class UsersController : ControllerBase
   ```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 3

1. **System Administrator Role:** Only users with "System Administrator" role can access admin functions
2. **Authorization Policy:** Enforce role/permission checks on all admin endpoints
3. **PESEL Protection:** Display only last 4 digits in list view
4. **Audit Logging:** Log all admin actions (view user list, export)
5. **Data Export:** Exported files should not include full PESEL or password hashes

### Audit Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#22-audit-and-login`, Epic 3

- Log user list view actions (search criteria, filters applied)
- Log export actions (format, number of records exported)
- Include timestamp, administrator ID, action performed
- Use structured logging with Serilog

### Export Implementation

**Using ClosedXML for Excel:**
```csharp
// Example Excel export
using var workbook = new XLWorkbook();
var worksheet = workbook.Worksheets.Add("Users");
worksheet.Cell(1, 1).InsertTable(users, "Users", true);
using var stream = new MemoryStream();
workbook.SaveAs(stream);
return stream.ToArray();
```

**CSV Export:**
```csharp
// Example CSV export using string builder
var csv = new StringBuilder();
csv.AppendLine("Name,Email,User Type,Status,Roles,Last Login");
foreach (var user in users)
{
    csv.AppendLine($"{user.FirstName} {user.LastName},{user.Email},{user.UserType},{user.Status},\"{string.Join(", ", user.Roles)}\",{user.LastLoginDate:yyyy-MM-dd}");
}
return Encoding.UTF8.GetBytes(csv.ToString());
```

### Angular Implementation

**PrimeNG Table with Lazy Loading:**
```typescript
// Component
loadUsers(event: LazyLoadEvent) {
  const params = {
    page: (event.first / event.rows) + 1,
    pageSize: event.rows,
    search: this.searchTerm,
    userType: this.selectedUserType,
    status: this.selectedStatus,
    roleId: this.selectedRoleId,
    sortBy: event.sortField,
    sortDirection: event.sortOrder === 1 ? 'Asc' : 'Desc'
  };
  
  this.usersService.getUsers(params)
    .pipe(takeUntilDestroyed(this.destroyRef))
    .subscribe(response => {
      this.users = response.items;
      this.totalRecords = response.totalCount;
    });
}
```

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions  
**Integration Tests:** Testcontainers 3.7.0 (real PostgreSQL database)

**Test Location:**
- Unit tests: `Tests/UknfPlatform.UnitTests/Application/Admin/GetUsersQueryHandlerTests.cs`
- Integration tests: `Tests/UknfPlatform.IntegrationTests/Controllers/UsersControllerTests.cs`

**Test Naming Convention:** `MethodName_Scenario_ExpectedBehavior`

**Example:**
```csharp
[Fact]
public async Task Handle_WithUserTypeFilter_ReturnsFilteredUsers()
{
    // Arrange
    var query = new GetUsersQuery { UserType = "External", Page = 1, PageSize = 20 };
    var users = UserFactory.CreateExternalUsers(5);
    _userRepositoryMock
        .Setup(r => r.GetPagedUsersAsync(It.IsAny<UserFilters>()))
        .ReturnsAsync((users, 5));
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.Items.Should().HaveCount(5);
    result.Items.Should().AllSatisfy(u => u.UserType.Should().Be("External"));
}
```

**Coverage Target:** 80%+ for application layer (query handlers)

### Additional Notes

1. **Status Values:** The story mentions "Blocked" status, but the Users table only has IsActive (true/false). Consider:
   - IsActive = true: "Active"
   - IsActive = false: "Inactive"
   - Or add a Status enum field to Users table: Active, Inactive, Blocked

2. **Role Display:** List view shows role names as comma-separated string or chips. Include role count if many roles.

3. **Entity Count:** For external users, count entities from UserEntities junction table.

4. **PESEL Search:** Search by last 4 digits only (PeselLast4 column) for privacy.

5. **Export Performance:** For large datasets (thousands of users), consider background job with notification when export is ready.

6. **Filter Persistence:** Consider storing filter preferences in browser localStorage or user preferences.

7. **Responsive Design:** Table should be responsive with horizontal scroll on mobile or card view.

8. **First Admin User:** Ensure at least one System Administrator exists in seed data for development.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

