# Story 6.8: Delete File from Library (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.8  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** delete files that are no longer needed,  
**So that** the Library remains current and uncluttered.

---

## Acceptance Criteria

1. UKNF Employee can select file and choose "Delete"
2. System prompts confirmation: "Are you sure you want to delete [filename]? This action cannot be undone."
3. Upon confirmation, file is deleted (soft delete recommended - mark as deleted but retain in database)
4. Deleted files are no longer visible to external users
5. Deleted files are no longer visible in standard UKNF Library view (but can be viewed in "Deleted Files" section)
6. File download links become invalid
7. System logs deletion with timestamp and employee ID
8. Deletion is captured in change history
9. Consider: Prevent deletion if file has been downloaded recently or is referenced in reports
10. Deletion includes all versions in version chain (with confirmation)
11. System retains file content in storage for audit/recovery (configurable retention period)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create DeleteFileCommand** (AC: 1, 2, 10)
  - [ ] Create `DeleteFileCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileId (Guid, required)
    - DeleteReason (string?, nullable, max 500) - optional reason
    - DeleteVersionChain (bool, default false) - delete all versions or just this one

- [ ] **Task 2: Create DeleteFileCommandValidator** (AC: 1, 9)
  - [ ] Create `DeleteFileCommandValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate DeleteReason: MaxLength(500) if provided
  - [ ] Add async validation: File must exist
  - [ ] Add async validation: File must not be already deleted
  - [ ] Add async validation: User must have UKNF Employee role
  - [ ] Add async validation (optional): Check if file recently downloaded
  - [ ] Add async validation (optional): Check if file referenced in reports

- [ ] **Task 3: Create DeleteFileCommandHandler** (AC: 1, 3, 4, 5, 6, 7, 8, 10, 11)
  - [ ] Create `DeleteFileCommandHandler.cs` implementing `IRequestHandler<DeleteFileCommand, DeleteFileResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFileChangeHistoryRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Load file by ID
    - Check file exists and not already deleted
    - If DeleteVersionChain:
      - Load all files in version chain
      - Mark all as deleted
    - Else:
      - Mark only specified file as deleted
    - Soft delete: Set IsDeleted = true, DeletedDate = now, DeletedByUserId = current user
    - Note: Do NOT delete from database or storage (AC: 3, 11)
    - Create FileChangeHistory entry:
      - Action = Delete
      - ChangeDescription = DeleteReason or "File deleted"
      - ChangedByUserId = current user
    - Save changes
    - Log deletion (AC: 7)
    - Return DeleteFileResponse
  - [ ] Handle errors: file not found, already deleted

- [ ] **Task 4: Create DeleteFileResponse DTO** (AC: 3)
  - [ ] Create `DeleteFileResponse.cs` record
  - [ ] Properties: FileId (Guid), Filename (string), Message (string), DeletedCount (int)

- [ ] **Task 5: Create REST API endpoint DELETE /library/files/{fileId}** (AC: 1, 7)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create DELETE action `DeleteFileAsync(Guid fileId, [FromBody] DeleteFileRequest? request)`
  - [ ] Request body (optional): DeleteReason, DeleteVersionChain
  - [ ] Inject IMediator to send command
  - [ ] Return 200 OK with DeleteFileResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Return 409 Conflict if file already deleted
  - [ ] Return 422 Unprocessable Entity if deletion blocked (recent downloads, references)
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 6: Implement deletion safeguards** (AC: 9)
  - [ ] Create method: CheckDeletionSafeguards(fileId)
  - [ ] Check if file downloaded in last 30 days (configurable)
  - [ ] Check if file referenced in recent reports (integration with Epic 4)
  - [ ] Return list of warnings/blockers
  - [ ] Option: Allow override with confirmation (RequireOverride flag)

- [ ] **Task 7: Update LibraryFile entity** (AC: 3)
  - [ ] Add domain method: MarkAsDeleted(deletedByUserId, deleteReason)
  - [ ] Method sets IsDeleted = true, DeletedDate = now, DeletedByUserId
  - [ ] Add domain validation: Cannot delete already deleted file

- [ ] **Task 8: Update ILibraryFileRepository** (AC: 4, 5, 6, 10)
  - [ ] Update GetLibraryFilesWithPermissionsAsync: Exclude IsDeleted = true
  - [ ] Update GetFileDetailsAsync: Check IsDeleted
  - [ ] Add method: GetDeletedFilesAsync() - for "Deleted Files" view (UKNF only)
  - [ ] Update DownloadFileAsync: Block downloads if IsDeleted
  - [ ] Add method: GetVersionChainAsync(fileId) - to delete entire chain

- [ ] **Task 9: Create GetDeletedFilesQuery (UKNF only)** (AC: 5)
  - [ ] Create `GetDeletedFilesQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties: PageNumber, PageSize, SearchTerm, DateRange
  - [ ] Create QueryHandler
  - [ ] Returns paginated list of deleted files with deletion info
  - [ ] Only accessible to UKNF Employees

- [ ] **Task 10: Create REST API endpoint GET /library/files/deleted** (AC: 5)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetDeletedFilesAsync([FromQuery] GetDeletedFilesQuery query)`
  - [ ] Returns deleted files with: Filename, DeletedDate, DeletedBy, DeleteReason
  - [ ] Supports search and pagination

- [ ] **Task 11: Implement file retention policy** (AC: 11)
  - [ ] Create background job: CleanupDeletedFilesJob
  - [ ] Configurable retention period (e.g., 90 days, 1 year)
  - [ ] After retention period: Permanently delete file from storage
  - [ ] Keep database record for audit (file metadata, deletion info)
  - [ ] Log permanent deletions
  - [ ] Run periodically (e.g., daily)

### Frontend Tasks

- [ ] **Task 12: Add delete button to file details page** (AC: 1)
  - [ ] Add "Delete" button on file details page
  - [ ] Button only visible to UKNF Employees
  - [ ] Button in danger/warning style (red)
  - [ ] Click opens confirmation dialog

- [ ] **Task 13: Add delete button to library list** (AC: 1)
  - [ ] Add "Delete" option in action menu for each file
  - [ ] Only visible to UKNF Employees
  - [ ] Opens confirmation dialog

- [ ] **Task 14: Create delete confirmation dialog** (AC: 2, 9, 10)
  - [ ] Create `file-delete-confirm-dialog.component.ts`
  - [ ] Show warning message
  - [ ] Display filename prominently
  - [ ] Show safeguard warnings if any (recent downloads, references)
  - [ ] Optional delete reason input
  - [ ] Checkbox: "Delete entire version chain" if file has versions (AC: 10)
  - [ ] Show version count if deleting chain
  - [ ] Require typed confirmation (e.g., type "DELETE") for version chains
  - [ ] Cancel and Confirm buttons
  - [ ] Confirm button in danger style

- [ ] **Task 15: Update library service** (AC: 1, 3, 7)
  - [ ] Add method to `library.service.ts`:
    - deleteFile(fileId: string, deleteReason?: string, deleteVersionChain?: boolean): Observable<DeleteFileResponse>
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 16: Show success feedback** (AC: 3, 4, 6)
  - [ ] Show success notification after deletion
  - [ ] Remove file from library list immediately
  - [ ] Redirect to library list if on details page
  - [ ] Show "File deleted" message with undo option (optional)

- [ ] **Task 17: Create deleted files view (UKNF only)** (AC: 5)
  - [ ] Create `library-deleted-files.component.ts`
  - [ ] List all deleted files
  - [ ] Show: Filename, Category, DeletedDate, DeletedBy, DeleteReason
  - [ ] Support search and pagination
  - [ ] Show "Restore" button (future functionality - not in this story)
  - [ ] Only accessible to UKNF Employees

- [ ] **Task 18: Add navigation to deleted files** (AC: 5)
  - [ ] Add "Deleted Files" menu item or tab in Library (UKNF only)
  - [ ] Badge showing count of deleted files
  - [ ] Route: `/library/deleted`

- [ ] **Task 19: Handle deletion safeguards** (AC: 9)
  - [ ] Display warnings in confirmation dialog
  - [ ] Show: "Downloaded X times in last 30 days"
  - [ ] Show: "Referenced in Y active reports"
  - [ ] Require explicit override checkbox if blocked
  - [ ] Explain consequences of deletion

### Testing Tasks

- [ ] **Task 20: Unit tests for command handler** (AC: 3, 4, 6, 7, 8, 10)
  - [ ] Test successful file deletion
  - [ ] Test soft delete (IsDeleted = true, not removed from DB)
  - [ ] Test DeletedDate and DeletedByUserId set correctly
  - [ ] Test change history created
  - [ ] Test deleting version chain
  - [ ] Test deleting single version
  - [ ] Test cannot delete already deleted file
  - [ ] Test deletion reason captured

- [ ] **Task 21: Unit tests for deletion safeguards** (AC: 9)
  - [ ] Test safeguard detects recent downloads
  - [ ] Test safeguard detects report references
  - [ ] Test deletion blocked if safeguards fail
  - [ ] Test deletion allowed with override

- [ ] **Task 22: Unit tests for validator** (AC: 1, 9)
  - [ ] Test FileId validation
  - [ ] Test file must exist
  - [ ] Test file must not be already deleted
  - [ ] Test delete reason max length

- [ ] **Task 23: Integration tests for API endpoint** (AC: 1, 3, 7)
  - [ ] Test DELETE /library/files/{id} with valid data returns 200
  - [ ] Test deletion requires UKNF Employee role (403 if not)
  - [ ] Test deleting non-existent file returns 404
  - [ ] Test deleting already deleted file returns 409
  - [ ] Test change history created after deletion
  - [ ] Test file no longer visible to external users
  - [ ] Test file download returns 404 after deletion

- [ ] **Task 24: Integration tests for deleted files view** (AC: 5)
  - [ ] Test GET /library/files/deleted returns deleted files
  - [ ] Test only UKNF Employees can access (403 if external user)
  - [ ] Test deleted files not in main library list
  - [ ] Test search and pagination work

- [ ] **Task 25: Frontend unit tests** (AC: 1, 2, 9, 10)
  - [ ] Test delete button visibility (UKNF only)
  - [ ] Test delete confirmation dialog
  - [ ] Test version chain deletion checkbox
  - [ ] Test safeguard warnings display
  - [ ] Test deleted files view
  - [ ] Test service method calls

- [ ] **Task 26: E2E tests** (AC: 1-11)
  - [ ] Test complete file deletion flow as UKNF Employee
  - [ ] Test confirmation dialog appears
  - [ ] Test file removed from library after deletion
  - [ ] Test file not accessible to external users after deletion
  - [ ] Test file appears in deleted files view
  - [ ] Test deleting version chain
  - [ ] Test deletion safeguards
  - [ ] Test cannot delete already deleted file

### Documentation Tasks

- [ ] **Task 27: API documentation** (AC: 1, 7)
  - [ ] Document DELETE /library/files/{id} endpoint
  - [ ] Document GET /library/files/deleted endpoint
  - [ ] Include request/response examples
  - [ ] Document error responses
  - [ ] Document authentication requirements
  - [ ] Explain soft delete behavior

- [ ] **Task 28: Developer documentation** (AC: 3, 9, 11)
  - [ ] Document soft delete strategy
  - [ ] Document deletion safeguards
  - [ ] Document file retention policy
  - [ ] Document version chain deletion
  - [ ] Document recovery process (future)

- [ ] **Task 29: User documentation** (AC: 1, 2, 9, 10)
  - [ ] Create user guide for deleting files
  - [ ] Explain soft delete (files retained for recovery)
  - [ ] Explain deletion safeguards
  - [ ] Explain version chain deletion
  - [ ] Include screenshots

---

## Technical Notes

### Soft Delete vs. Hard Delete

**Soft Delete** (Recommended):
- Set `IsDeleted = true`, `DeletedDate = now`, `DeletedByUserId`
- File remains in database
- File content remains in storage
- Can be recovered if needed
- Maintains referential integrity
- Preserves audit trail

**Hard Delete**:
- Remove from database
- Delete from storage
- Cannot be recovered
- May break referential integrity
- Should only be done after retention period

### Deletion Safeguards

Protect against accidental deletion:

1. **Recent Downloads**: File downloaded in last 30 days
   - Warning: "This file was downloaded X times in the last 30 days"
   - Allow override with confirmation

2. **Report References**: File referenced in active reports
   - Warning: "This file is referenced in Y active reports"
   - Block deletion or require override

3. **Version Chain**: File has multiple versions
   - Warning: "This file has X archival versions. Delete entire chain?"
   - Explicit checkbox required

### Version Chain Deletion

Two options:

**Delete Single Version**:
- Deletes only specified file
- Other versions in chain remain
- Useful for removing specific problematic version
- Version chain broken at deletion point

**Delete Entire Chain**:
- Deletes all files in version chain (current and archival)
- More thorough cleanup
- Requires explicit confirmation
- Use when file concept no longer needed

Recommendation: Default to single file, offer chain deletion as option.

### File Retention Policy

After file is soft deleted:
- **0-90 days**: Recoverable (file in storage, DB record exists)
- **After 90 days**: Permanent deletion from storage (configurable)
- **DB record**: Retained indefinitely for audit

Background job runs daily:
- Find files with DeletedDate > retention period
- Delete from blob storage
- Update DB: FileSt orageKey = null (indicates permanent deletion)
- Log permanent deletions

### Change History

Create change history entry:
- **Action**: Delete
- **FieldName**: null
- **OldValue**: null
- **NewValue**: null
- **ChangeDescription**: DeleteReason or "File deleted"
- **ChangedByUserId**: Employee who deleted
- **CreatedDate**: Deletion timestamp

### Downloaded in Last 30 Days Check

Query FileDownload records:
```sql
SELECT COUNT(*) FROM FileDownloads
WHERE FileId = @fileId
AND DownloadDate > @thirtyDaysAgo
```

If count > 0, show warning.

### Report References Check

Query Reports table (Epic 4):
- Check if file referenced in report metadata
- Check if file is template for recent reports
- If references found, show warning or block

### Preventing Accidental Deletion

- Require confirmation with filename display
- Show usage statistics (download count, last download date)
- Show warnings for active usage
- For version chains, require typing "DELETE" to confirm
- Log all deletion attempts (successful and cancelled)

### Performance Considerations

- Soft delete is instant (update query)
- Deletion safeguards queries should be fast (indexes)
- Deleted files excluded from main queries (WHERE IsDeleted = false)
- Index IsDeleted for performance
- Background cleanup job runs off-peak hours

### Security Considerations

- Only UKNF Employees can delete files
- Log all deletions comprehensively
- Audit trail preserved even after deletion
- Soft delete allows recovery from mistakes
- Permanent deletion after retention period

### UI/UX Considerations

- Delete button in danger style (red)
- Clear confirmation dialog with warnings
- Undo option immediately after deletion (optional)
- Show deleted files in separate view (UKNF only)
- Restore functionality (future)
- Explain that deletion is recoverable (within retention period)

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files must exist)
- **Epic 1**: Authentication (UKNF Employee role identification)

### Integrates With
- **Story 6.7**: Replace File (version chain deletion)
- **Story 6.11**: View File Change History (deletion logged)
- **Epic 4**: Reporting System (check report references)

---

## Acceptance Checklist

- [ ] UKNF Employee can delete files
- [ ] System prompts confirmation before deletion
- [ ] File is soft deleted (marked as deleted in database)
- [ ] Deleted files not visible to external users
- [ ] Deleted files not in standard UKNF Library view
- [ ] Deleted files viewable in "Deleted Files" section (UKNF)
- [ ] File downloads become invalid after deletion
- [ ] System logs deletion with timestamp and employee ID
- [ ] Deletion captured in change history
- [ ] Deletion safeguards prevent accidental deletion
- [ ] Version chain can be deleted entirely
- [ ] File content retained in storage for audit/recovery
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (creates files)
- **Story 6.5**: View File Details (delete button)
- **Story 6.7**: Replace File (version chain handling)
- **Story 6.11**: View File Change History (deletion logged)

---

## Notes

- Soft delete is strongly recommended for compliance and recovery
- Deletion safeguards prevent common mistakes
- Version chain deletion requires extra confirmation
- Restore functionality not in this story (future enhancement)
- File retention policy configurable per organization needs
- Monitor deleted files for recovery requests
- Consider "Archive" instead of "Delete" for some use cases
- Test with files that have many versions, downloads, references
- Consider bulk deletion (Story 6.14)
- Permanently deleted files (after retention) cannot be recovered
- Communicate retention policy to users clearly
- Consider "Trash" metaphor (like email) for deleted files
- Log deletion attempts even if cancelled (audit suspicious activity)

