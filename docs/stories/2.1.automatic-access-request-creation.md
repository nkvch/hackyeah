# Story 2.1: Automatic Access Request Creation

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.1  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** newly registered external user who activated their account,  
**I want to** have an access request automatically created,  
**So that** I can begin the process of requesting permissions.

---

## Acceptance Criteria

1. After successful account activation (Epic 1, Story 1.2), system automatically creates an access request
2. Access request status is set to "Working"
3. Access request pre-populates user data: First name, Last name, PESEL (masked, last 4 digits visible), phone, email
4. User can view their access request in "Working" status
5. Request is not visible to UKNF Employees until status changes to "New"

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create AccessRequest entity** (AC: 1, 2)
  - [ ] Create `AccessRequest.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties: Id (Guid), UserId (Guid FK), Status (enum), SubmittedDate (DateTime?), ReviewedByUserId (Guid?), ReviewedDate (DateTime?), CreatedDate, UpdatedDate
  - [ ] Add `AccessRequestStatus` enum: Working, New, Accepted, Blocked, Updated
  - [ ] Add domain method `CreateForUser(userId)` - factory method
  - [ ] Add domain method `Submit()` - changes status from Working to New
  - [ ] Add domain method `IsEditable()` - returns true if status == Working
  - [ ] Add domain property `IsVisibleToReviewers` - returns status != Working
  - [ ] Encapsulate Status with private setter

- [ ] **Task 2: Create EF Core configuration for AccessRequest** (AC: 1, 2)
  - [ ] Create `AccessRequestConfiguration.cs` in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Configurations/`
  - [ ] Configure table name "AccessRequests"
  - [ ] Configure primary key
  - [ ] Configure foreign keys to Users (UserId, ReviewedByUserId)
  - [ ] Configure Status as string with conversion from enum
  - [ ] Add check constraint for Status values
  - [ ] Configure indexes: IX_AccessRequests_UserId, IX_AccessRequests_Status
  - [ ] Configure audit fields

- [ ] **Task 3: Create database migration for AccessRequests table** (AC: 1)
  - [ ] Create EF Core migration `Add_AccessRequests_Table`
  - [ ] Verify schema matches design:
    - Id UUID PRIMARY KEY
    - UserId UUID NOT NULL FK to Users
    - Status NVARCHAR(20) with CHECK constraint
    - SubmittedDate DATETIME2 NULL
    - ReviewedByUserId UUID NULL FK to Users
    - ReviewedDate DATETIME2 NULL
    - CreatedDate DATETIME2 NOT NULL
    - UpdatedDate DATETIME2 NOT NULL
  - [ ] Add indexes

- [ ] **Task 4: Update ActivateAccountCommandHandler to create AccessRequest** (AC: 1, 2, 3)
  - [ ] Open `ActivateAccountCommandHandler.cs` from Story 1.2
  - [ ] After marking user as active, create AccessRequest:
    - Call `AccessRequest.CreateForUser(user.Id)`
    - Set Status = AccessRequestStatus.Working
    - Save to repository
  - [ ] Inject `IAccessRequestRepository`
  - [ ] Use transaction to ensure atomicity (user activation + access request creation)
  - [ ] Log access request creation

- [ ] **Task 5: Create IAccessRequestRepository interface and implementation** (AC: 4)
  - [ ] Create `IAccessRequestRepository.cs` in `Domain/UknfPlatform.Domain.Auth/Repositories/`
  - [ ] Methods:
    - `GetByIdAsync(Guid id)`
    - `GetByUserIdAsync(Guid userId)`
    - `GetActiveRequestByUserIdAsync(Guid userId)` - gets request in Working/New/Updated status
    - `GetAllByStatusAsync(AccessRequestStatus status)`
    - `AddAsync(AccessRequest request)`
    - `UpdateAsync(AccessRequest request)`
  - [ ] Create `AccessRequestRepository.cs` implementation in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/`
  - [ ] Implement with EF Core DbContext

- [ ] **Task 6: Create GetAccessRequestQuery and Handler** (AC: 3, 4)
  - [ ] Create `GetAccessRequestQuery.cs` in `Application/UknfPlatform.Application.Auth/AccessRequests/Queries/`
  - [ ] Query property: AccessRequestId (optional, defaults to current user's request)
  - [ ] Create `GetAccessRequestQueryHandler.cs`
  - [ ] Handler logic:
    - Get authenticated user ID from context
    - If AccessRequestId provided, get that request and verify it belongs to user
    - If no AccessRequestId, get active request for user
    - Map to AccessRequestDto with user data populated
    - Mask PESEL (show only last 4 digits)
    - Return DTO
  - [ ] Inject: IAccessRequestRepository, IUserRepository

- [ ] **Task 7: Create AccessRequestDto** (AC: 3, 4)
  - [ ] Create `AccessRequestDto.cs` record in `Application/UknfPlatform.Application.Auth/AccessRequests/DTOs/`
  - [ ] Properties:
    - Id (Guid)
    - UserId (Guid)
    - FirstName (string) - from User
    - LastName (string) - from User
    - PeselLast4 (string) - masked PESEL
    - Email (string) - from User
    - PhoneNumber (string) - from User
    - Status (string)
    - SubmittedDate (DateTime?)
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)

- [ ] **Task 8: Create REST API endpoint GET /api/access-requests/my-request** (AC: 4)
  - [ ] Create `AccessRequestsController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add action: `GetMyAccessRequestAsync()`
  - [ ] `[Authorize]` attribute (requires authentication)
  - [ ] Send GetAccessRequestQuery via MediatR
  - [ ] Return 200 OK with AccessRequestDto
  - [ ] Return 404 Not Found if no active request exists
  - [ ] Add Swagger documentation

- [ ] **Task 9: Ensure access requests not visible to UKNF employees until "New"** (AC: 5)
  - [ ] In future queries for UKNF employees (Story 2.3), filter by Status != Working
  - [ ] Add `IsVisibleToReviewers` property to AccessRequest entity
  - [ ] Property returns: `Status != AccessRequestStatus.Working`
  - [ ] Document this business rule in code comments

### Frontend Tasks

- [ ] **Task 10: Create access request service** (AC: 4)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/access-request.service.ts`
  - [ ] Add method `getMyAccessRequest(): Observable<AccessRequestDto>`
  - [ ] Call GET `/api/access-requests/my-request`
  - [ ] Handle 404 (no request exists)
  - [ ] Handle errors with catchError

- [ ] **Task 11: Create access request view component** (AC: 3, 4)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/access-requests/my-access-request/my-access-request.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/access-requests/my-request` (requires authentication)
  - [ ] Apply auth guard

- [ ] **Task 12: Display access request information** (AC: 3, 4)
  - [ ] On component init, call accessRequestService.getMyAccessRequest()
  - [ ] Display in card layout:
    - Status badge (Working, New, Accepted, etc.)
    - "Your Information" section:
      - First name, Last name
      - Email, Phone
      - PESEL (masked, last 4 digits)
    - Request status information
    - Created date
    - Submitted date (if submitted)
  - [ ] If no request exists (404), show message: "No access request found"

- [ ] **Task 13: Show status-specific messages** (AC: 2, 4)
  - [ ] If status == "Working":
    - Show info banner: "Your access request is in draft. Complete and submit it to request permissions."
    - Show "Continue Request" button (navigate to Story 2.2 completion form)
  - [ ] If status == "New":
    - Show info: "Your access request has been submitted and is awaiting review."
  - [ ] If status == "Accepted":
    - Show success: "Your access request has been approved! You now have access to the system."
  - [ ] If status == "Blocked":
    - Show warning: "Your access has been blocked. Please contact support."

- [ ] **Task 14: Add access request link to navigation** (AC: 4)
  - [ ] After login (Story 1.4), if user has no accepted permissions, show prominent link/button
  - [ ] Navigation item: "My Access Request" or "Request Access"
  - [ ] Badge indicator if status == "Working" (incomplete)

- [ ] **Task 15: Create access request page UI** (AC: 3, 4)
  - [ ] Use main layout with navigation
  - [ ] Page title: "My Access Request"
  - [ ] Use PrimeNG Card component for request details
  - [ ] Status badge with color coding:
    - Working: blue (p-tag-info)
    - New: yellow (p-tag-warning)
    - Accepted: green (p-tag-success)
    - Blocked: red (p-tag-danger)
  - [ ] Read-only display of user information
  - [ ] Action buttons based on status
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

### Testing Tasks

- [ ] **Task 16: Write unit tests for AccessRequest entity** (AC: 1, 2)
  - [ ] Test: `CreateForUser_SetsStatusToWorking`
  - [ ] Test: `Submit_ChangesStatusFromWorkingToNew`
  - [ ] Test: `IsEditable_ReturnsTrueForWorkingStatus`
  - [ ] Test: `IsEditable_ReturnsFalseForOtherStatuses`
  - [ ] Test: `IsVisibleToReviewers_ReturnsFalseForWorking`
  - [ ] Test: `IsVisibleToReviewers_ReturnsTrueForOtherStatuses`

- [ ] **Task 17: Write unit test for ActivateAccountCommandHandler update** (AC: 1, 2)
  - [ ] Test: `Handle_AccountActivation_CreatesAccessRequest`
  - [ ] Test: `Handle_AccountActivation_SetsAccessRequestStatusToWorking`
  - [ ] Test: `Handle_AccountActivation_UsesTransaction`
  - [ ] Verify AccessRequest created with correct UserId
  - [ ] Mock: IAccessRequestRepository

- [ ] **Task 18: Write unit tests for GetAccessRequestQueryHandler** (AC: 3, 4)
  - [ ] Test: `Handle_UserHasAccessRequest_ReturnsDto`
  - [ ] Test: `Handle_UserNoAccessRequest_ThrowsNotFoundException`
  - [ ] Test: `Handle_PopulatesUserDataCorrectly`
  - [ ] Test: `Handle_MaskesPesel_ShowsOnlyLast4Digits`
  - [ ] Mock: IAccessRequestRepository, IUserRepository

- [ ] **Task 19: Write integration tests for access request creation** (AC: All)
  - [ ] Test: `AccountActivation_CreatesAccessRequestWithWorkingStatus`
  - [ ] Test: `GET_MyAccessRequest_Authenticated_Returns200WithDto`
  - [ ] Test: `GET_MyAccessRequest_Unauthenticated_Returns401`
  - [ ] Test: `GET_MyAccessRequest_NoRequest_Returns404`
  - [ ] Test: `AccessRequest_StatusWorking_NotVisibleToReviewers`
  - [ ] Verify transaction: activation + access request creation
  - [ ] Use Testcontainers for database

- [ ] **Task 20: Write E2E test for complete activation-to-access-request flow**
  - [ ] Test workflow:
    1. Register user (Story 1.1)
    2. Activate account via email link (Story 1.2)
    3. Set initial password (Story 1.3)
    4. Login (Story 1.4)
    5. Navigate to "My Access Request"
    6. Verify access request exists with "Working" status
    7. Verify user information displayed correctly
    8. Verify PESEL masked
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 1.2 (Account Activation via Email):**
- `ActivateAccountCommandHandler` marks user as active
- This is the integration point for creating AccessRequest
- Email service and notification infrastructure available

**From Story 1.1:**
- User entity with FirstName, LastName, Email, Phone, PESEL fields
- PESEL encrypted with PeselLast4 for display

**Key Integration:**
- This story modifies Story 1.2's ActivateAccountCommandHandler
- Automatically creates AccessRequest after successful activation
- Uses transaction to ensure both operations succeed or fail together

### Architecture Context

**Tech Stack:**
- Backend: C# 12.0, .NET 8.0, ASP.NET Core, EF Core
- Frontend: Angular 20, PrimeNG, Tailwind CSS
- Database: PostgreSQL
- Authentication: JWT (from Story 1.4)

### Project Structure

Backend files:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AccessRequestsController.cs (CREATE)
├── Application/UknfPlatform.Application.Auth/AccessRequests/
│   ├── Queries/
│   │   ├── GetAccessRequestQuery.cs (CREATE)
│   │   └── GetAccessRequestQueryHandler.cs (CREATE)
│   └── DTOs/
│       └── AccessRequestDto.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/
│   ├── Entities/
│   │   └── AccessRequest.cs (CREATE)
│   ├── Enums/
│   │   └── AccessRequestStatus.cs (CREATE)
│   └── Repositories/
│       └── IAccessRequestRepository.cs (CREATE)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/
│   ├── Configurations/
│   │   └── AccessRequestConfiguration.cs (CREATE)
│   └── Repositories/
│       └── AccessRequestRepository.cs (CREATE)
```

Frontend files:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── access-request.service.ts (CREATE)
├── features/access-requests/
│   └── my-access-request/
│       ├── my-access-request.component.ts (CREATE)
│       ├── my-access-request.component.html (CREATE)
│       └── my-access-request.component.scss (CREATE)
```

Update existing file:
```
src/Backend/Application/UknfPlatform.Application.Auth/Authentication/Commands/ActivateAccountCommandHandler.cs (UPDATE)
```

### Data Models

**AccessRequests Table:**
```sql
CREATE TABLE AccessRequests (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    Status NVARCHAR(20) NOT NULL CHECK (Status IN ('Working', 'New', 'Accepted', 'Blocked', 'Updated')),
    SubmittedDate DATETIME2 NULL,
    ReviewedByUserId UUID NULL,
    ReviewedDate DATETIME2 NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (UserId) REFERENCES Users(Id),
    FOREIGN KEY (ReviewedByUserId) REFERENCES Users(Id),
    INDEX IX_AccessRequests_UserId (UserId),
    INDEX IX_AccessRequests_Status (Status)
);
```

**AccessRequest Entity (Domain):**
```csharp
public class AccessRequest
{
    public Guid Id { get; private set; }
    public Guid UserId { get; private set; }
    public AccessRequestStatus Status { get; private set; }
    public DateTime? SubmittedDate { get; private set; }
    public Guid? ReviewedByUserId { get; private set; }
    public DateTime? ReviewedDate { get; private set; }
    public DateTime CreatedDate { get; private set; }
    public DateTime UpdatedDate { get; private set; }
    
    // Navigation properties
    public User User { get; private set; }
    public User ReviewedBy { get; private set; }
    public ICollection<PermissionLine> PermissionLines { get; private set; }
    
    // Factory method
    public static AccessRequest CreateForUser(Guid userId)
    {
        return new AccessRequest
        {
            Id = Guid.NewGuid(),
            UserId = userId,
            Status = AccessRequestStatus.Working,
            CreatedDate = DateTime.UtcNow,
            UpdatedDate = DateTime.UtcNow
        };
    }
    
    // Domain methods
    public void Submit()
    {
        if (Status != AccessRequestStatus.Working)
            throw new InvalidOperationException("Only Working requests can be submitted");
            
        Status = AccessRequestStatus.New;
        SubmittedDate = DateTime.UtcNow;
        UpdatedDate = DateTime.UtcNow;
    }
    
    public bool IsEditable()
    {
        return Status == AccessRequestStatus.Working;
    }
    
    public bool IsVisibleToReviewers
    {
        get => Status != AccessRequestStatus.Working;
    }
}

public enum AccessRequestStatus
{
    Working,
    New,
    Accepted,
    Blocked,
    Updated
}
```

### REST API Specification

**Endpoint:** GET `/api/access-requests/my-request`
- **Security:** Requires authentication (JWT token)
- **Success (200 OK):**
  ```json
  {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "userId": "2fa85f64-5717-4562-b3fc-2c963f66afa7",
    "firstName": "Jan",
    "lastName": "Kowalski",
    "peselLast4": "8901",
    "email": "jan.kowalski@example.com",
    "phoneNumber": "+48123456789",
    "status": "Working",
    "submittedDate": null,
    "createdDate": "2025-10-04T10:15:00Z",
    "updatedDate": "2025-10-04T10:15:00Z"
  }
  ```
- **Errors:**
  - 401: Unauthorized (not authenticated)
  - 404: Not Found (no access request exists for user)

### Integration with Story 1.2

**Update ActivateAccountCommandHandler:**
```csharp
public async Task<ActivateAccountResponse> Handle(
    ActivateAccountCommand request, 
    CancellationToken cancellationToken)
{
    // Existing activation logic...
    
    // NEW: Create access request automatically
    var accessRequest = AccessRequest.CreateForUser(user.Id);
    await _accessRequestRepository.AddAsync(accessRequest);
    
    // Commit transaction (user activation + access request)
    await _unitOfWork.SaveChangesAsync(cancellationToken);
    
    _logger.LogInformation(
        "Access request created automatically for user {UserId} with status Working",
        user.Id);
    
    // Existing response...
}
```

### Business Rules

1. **Automatic Creation:** AccessRequest created immediately after account activation
2. **Initial Status:** Always starts as "Working" (draft state)
3. **Visibility:** Working requests NOT visible to UKNF Employees (private to user)
4. **One Active Request:** User has one active access request at a time
5. **User Data Population:** Pre-fills from User entity for convenience

### User Experience

**After Account Activation:**
1. User activates account (Story 1.2)
2. System automatically creates AccessRequest with "Working" status
3. User sets initial password (Story 1.3)
4. User logs in (Story 1.4)
5. Dashboard shows: "Complete your access request to gain system permissions"
6. User navigates to "My Access Request" page
7. Sees their information pre-populated
8. Status shows "Working" (draft)
9. Call-to-action: "Continue Request" button

**Access Request Page States:**
- **Working:** Draft mode, "Complete your request" message
- **New:** Submitted, awaiting review
- **Accepted:** Approved, permissions granted
- **Blocked:** Access denied

### Coding Standards

1. **Transaction for Atomicity:**
   ```csharp
   // ✅ CORRECT - Use transaction for multiple operations
   // Activation + AccessRequest creation must both succeed
   await _unitOfWork.SaveChangesAsync(cancellationToken);
   ```

2. **Domain Factory Method:**
   ```csharp
   // ✅ CORRECT - Use factory method for entity creation
   var accessRequest = AccessRequest.CreateForUser(userId);
   // NOT: new AccessRequest { UserId = userId, ... }
   ```

3. **Status Encapsulation:**
   ```csharp
   // ✅ CORRECT - Encapsulate state changes in domain methods
   accessRequest.Submit(); // Changes status internally
   // NOT: accessRequest.Status = AccessRequestStatus.New;
   ```

4. **PESEL Masking:**
   ```csharp
   // ✅ CORRECT - Only expose last 4 digits
   PeselLast4 = user.PeselLast4 // e.g., "8901"
   // NEVER return full PESEL in API
   ```

### Security Requirements

1. **Authentication Required:** User must be authenticated to view their request
2. **Authorization:** User can only view their own access request
3. **PESEL Protection:** Only last 4 digits visible
4. **Visibility Control:** Working requests not visible to reviewers

### Testing Strategy

**Unit Tests:**
- AccessRequest entity domain logic
- ActivateAccountCommandHandler (updated with access request creation)
- GetAccessRequestQueryHandler

**Integration Tests:**
- Account activation creates access request
- GET /my-request endpoint
- Transaction verification (both operations succeed/fail together)

**E2E Tests:**
- Complete flow from registration to viewing access request
- Verify automatic creation after activation
- Verify user data pre-population

### Additional Notes

1. **Future Stories:** Story 2.2 will implement the completion and submission form
2. **One Request Rule:** User has one active request; future requests handled in Story 2.6
3. **Reviewer Visibility:** Working status hides request from UKNF Employees (security/privacy)
4. **Pre-Population:** User data copied from User entity for convenience (editable in Story 2.2)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

