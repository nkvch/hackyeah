# Story 8.15: Rate Q&A Answers

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.15  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As an** External User or UKNF Employee,  
**I want to** rate how helpful answers are,  
**So that** I can provide feedback and help others find the best answers.

---

## Acceptance Criteria

1. User viewing published Q&A can provide rating (e.g., 1-5 stars or thumbs up/down)
2. Rating is submitted anonymously
3. User can rate each Q&A only once (tracked per user)
4. User can change their rating
5. System calculates and displays average rating for each Q&A
6. Average rating is displayed in Q&A lists and detail pages
7. UKNF Employees can view rating statistics: Number of ratings, Average rating, Rating distribution
8. High-rated Q&A can be featured or highlighted in FAQ
9. Low-rated Q&A can alert UKNF to improve answer
10. Rating submission is logged (timestamp, user ID internally)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create QuestionRating entity** (AC: 2, 3, 4, 10)
  - [ ] Create `QuestionRating.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - QuestionId (Guid)
    - UserId (Guid) - internal tracking
    - RatingValue (int) - 1 to 5 stars
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime?, nullable)
  - [ ] Unique constraint: (QuestionId, UserId)

- [ ] **Task 2: Create RateQuestionCommand** (AC: 1, 2, 3, 4)
  - [ ] Create `RateQuestionCommand.cs` in `Application/UknfPlatform.Application.Communication/QA/Commands/`
  - [ ] Command properties: QuestionId (Guid), RatingValue (int)
  - [ ] Create `RateQuestionCommandHandler.cs`
  - [ ] Inject IQuestionRatingRepository, IQuestionRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Verify question exists and is published
    - Check if user already rated this question
    - If exists, update rating (AC: 4)
    - If not, create new rating (AC: 3)
    - Update Question aggregates: RatingSum, RatingCount
    - Save to repository
    - Log rating
    - Return success

- [ ] **Task 3: Create RateQuestionCommandValidator** (AC: 1)
  - [ ] Validate QuestionId: NotEmpty
  - [ ] Validate RatingValue: Must be between 1 and 5
  - [ ] Check question is published (cannot rate unpublished Q&A)

- [ ] **Task 4: Update Question entity aggregates** (AC: 5)
  - [ ] Add methods: AddRating(), UpdateRating()
  - [ ] Maintain RatingSum and RatingCount
  - [ ] Calculate AverageRating: RatingSum / RatingCount

- [ ] **Task 5: Create GetQuestionRatingStatisticsQuery** (AC: 7)
  - [ ] Create `GetQuestionRatingStatisticsQuery.cs` (UKNF only)
  - [ ] Query parameters: QuestionId
  - [ ] Return RatingStatisticsDto with:
    - NumberOfRatings (int)
    - AverageRating (double)
    - RatingDistribution (dictionary: 1-star → count, 2-star → count, etc.)

- [ ] **Task 6: Create REST API endpoints** (AC: 1, 7)
  - [ ] POST /api/qa/faq/{id}/rate (rate Q&A)
  - [ ] GET /api/admin/qa/questions/{id}/rating-stats (UKNF statistics)
  - [ ] Add `[Authorize]` for rating endpoint (must be logged in)
  - [ ] Return 200 OK with updated average rating
  - [ ] Return 400 for invalid rating value
  - [ ] Return 404 if question not found or not published
  - [ ] Add Swagger documentation

- [ ] **Task 7: Create alerts for low-rated Q&A** (AC: 9)
  - [ ] Background job or query to find Q&A with average rating < 2.5
  - [ ] Send alert to UKNF Employees
  - [ ] Alert includes: Q&A title, average rating, link to review

### Frontend Tasks

- [ ] **Task 8: Create rating component** (AC: 1, 3, 4)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/shared/components/rating/rating.component.ts`
  - [ ] Display 5 stars (clickable)
  - [ ] Show user's current rating (if exists)
  - [ ] On click, submit rating
  - [ ] Show loading indicator during submission
  - [ ] Update display with new average rating

- [ ] **Task 9: Integrate rating into FAQ detail** (AC: 1, 6)
  - [ ] Add rating component to FAQ detail page (Story 8.13)
  - [ ] Display average rating and number of ratings
  - [ ] Example: "4.2 stars (25 ratings)"
  - [ ] Allow user to submit rating
  - [ ] Show confirmation after rating: "Thank you for your feedback!"

- [ ] **Task 10: Display ratings in FAQ list** (AC: 6)
  - [ ] Show average rating in Q&A list items
  - [ ] Star icons with rating value
  - [ ] Make highly-rated Q&A visually distinct

- [ ] **Task 11: Highlight featured Q&A** (AC: 8)
  - [ ] Add "Featured" or "Highly Rated" badge to Q&A with rating >= 4.5
  - [ ] Special styling or placement in list
  - [ ] Consider "Top Rated" section on FAQ home

- [ ] **Task 12: Create rating statistics page** (AC: 7)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/qa-management/rating-statistics/rating-statistics.component.ts`
  - [ ] Display for UKNF Employees in question detail
  - [ ] Show:
    - Average rating (large)
    - Number of ratings
    - Rating distribution chart (bar chart: 5-star, 4-star, etc.)
  - [ ] Highlight low-rated Q&A (< 2.5) in red

### Testing Tasks

- [ ] **Task 13: Write unit tests**
  - [ ] Test: RateQuestionCommandHandler creates rating
  - [ ] Test: User can rate Q&A only once
  - [ ] Test: User can update existing rating
  - [ ] Test: Question aggregates (RatingSum, RatingCount) are updated
  - [ ] Test: Average rating is calculated correctly

- [ ] **Task 14: Write integration tests**
  - [ ] Test: POST /api/qa/faq/:id/rate submits rating
  - [ ] Test: User cannot rate same Q&A twice (second rate updates)
  - [ ] Test: Average rating reflects all ratings
  - [ ] Test: Cannot rate unpublished Q&A
  - [ ] Test: GET rating statistics returns correct data

---

## Dev Notes

### Rating System

**Option 1: 5-Star System (Recommended)**
- 1 to 5 stars
- More granular feedback
- Standard in FAQ systems
- Display as star icons

**Option 2: Binary (Thumbs Up/Down)**
- Simpler
- Less granular
- Easier to implement
- Can still calculate percentage

Using 5-star system for better granularity.

### Anonymity

- Rating is anonymous (user identity not shown in public)
- User ID stored internally for:
  - Preventing duplicate ratings
  - Audit purposes
  - Potential abuse detection

### Rating Aggregates

Store aggregates in Question entity for performance:
- **RatingSum**: Sum of all rating values
- **RatingCount**: Number of ratings
- **AverageRating**: Calculated as RatingSum / RatingCount

Aggregates updated on each rating submission/update.

### User Experience

- Make rating easy and intuitive (click stars)
- Show current rating clearly
- Provide immediate feedback after rating
- Display average rating prominently
- Allow users to change their rating

### UKNF Features

- View rating statistics per Q&A
- Get alerts for low-rated Q&A (need improvement)
- Identify highly-rated Q&A (good content)
- Use ratings to prioritize Q&A review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

