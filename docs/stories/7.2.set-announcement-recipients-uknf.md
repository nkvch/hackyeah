# Story 7.2: Set Announcement Recipients (UKNF)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.2  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** define who can see each announcement,  
**So that** messages reach the appropriate audience.

---

## Acceptance Criteria

1. During announcement creation/editing, employee selects recipients using Addressee Types (see Story 7.11)
2. Employee can choose:
   - **All External Users**: Every external user can see the announcement
   - **Selected Entities**: Choose specific entities from list
   - **Entity Types**: Choose by entity type (e.g., "Loan institutions", "Insurance companies")
   - **Selected Users**: Choose specific external users
   - **Contact Groups**: Choose contact groups (Story 7.12)
3. Employee can combine multiple recipient types (e.g., all entities of type X + specific additional entities)
4. Recipients are calculated when announcement is published
5. Only designated recipients see the announcement on their bulletin board
6. Changing recipients after publication takes effect immediately
7. System logs recipient configuration with timestamp

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create RecipientConfiguration value object** (AC: 1, 2, 3)
  - [ ] Create `RecipientConfiguration.cs` in `Domain/UknfPlatform.Domain.Communication/ValueObjects/`
  - [ ] Properties:
    - IncludeAllUsers (bool)
    - SelectedEntityIds (List<long>)
    - SelectedEntityTypes (List<string>)
    - SelectedUserIds (List<Guid>)
    - SelectedContactGroupIds (List<Guid>)
  - [ ] Add validation: at least one recipient type must be selected
  - [ ] Serialize to JSON for storage

- [ ] **Task 2: Create IRecipientCalculator service** (AC: 4, 5)
  - [ ] Create `IRecipientCalculator.cs` in `Application/UknfPlatform.Application.Communication/Interfaces/`
  - [ ] Methods:
    - `CalculateRecipientsAsync(RecipientConfiguration config): Task<RecipientListDto>`
    - `GetRecipientCountAsync(RecipientConfiguration config): Task<int>`
  - [ ] Returns list of user IDs and contact emails
  - [ ] Handles all four addressee types
  - [ ] Removes duplicates

- [ ] **Task 3: Implement RecipientCalculator service** (AC: 4)
  - [ ] Create `RecipientCalculatorService.cs` implementation
  - [ ] Inject dependencies: IUserRepository, IEntityRepository, IContactGroupRepository
  - [ ] Logic:
    - If IncludeAllUsers: get all external users
    - If SelectedEntityIds: get users associated with those entities
    - If SelectedEntityTypes: get users associated with entities of those types
    - If SelectedUserIds: add those specific users
    - If SelectedContactGroupIds: get members of those groups (users + contacts)
    - Combine all results, remove duplicates
    - Return unified recipient list

- [ ] **Task 4: Create UpdateAnnouncementRecipientsCommand** (AC: 6)
  - [ ] Create `UpdateAnnouncementRecipientsCommand.cs`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)
    - RecipientConfiguration (RecipientConfigDto, required)
  - [ ] Create validator
  - [ ] Create handler:
    - Load announcement
    - Check user has permission
    - Update RecipientConfiguration
    - Save announcement
    - Recalculate recipients
    - Publish AnnouncementRecipientsUpdatedEvent
    - Log change

- [ ] **Task 5: Create REST API endpoint PUT /api/announcements/{id}/recipients** (AC: 6, 7)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `UpdateRecipientsAsync(Guid id, [FromBody] UpdateAnnouncementRecipientsRequest request)`
  - [ ] Return 200 OK with updated recipient count
  - [ ] Return 404 if announcement not found
  - [ ] Return 403 if user lacks permission

- [ ] **Task 6: Create recipient preview endpoint** (AC: 3, 4)
  - [ ] Create GET `/api/announcements/recipients/preview` endpoint
  - [ ] Accept RecipientConfiguration as query parameters or POST body
  - [ ] Return preview: list of user names, entities, and count
  - [ ] Used by frontend to show preview before saving

### Frontend Tasks

- [ ] **Task 7: Create recipient selector component** (AC: 1, 2, 3)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/shared/components/recipient-selector/recipient-selector.component.ts`
  - [ ] Reusable component for announcements, messages, file sharing
  - [ ] Input: initialConfiguration (RecipientConfiguration)
  - [ ] Output: configurationChange (EventEmitter)
  - [ ] UI sections:
    - "All External Users" checkbox
    - "Selected Entities" multi-select dropdown
    - "Entity Types" multi-select dropdown
    - "Selected Users" multi-select dropdown
    - "Contact Groups" multi-select dropdown

- [ ] **Task 8: Implement entity selection** (AC: 2)
  - [ ] Load entities via entitiesService.getAll()
  - [ ] Display as multi-select dropdown with search
  - [ ] Show: Entity Name (UKNF Code)
  - [ ] Allow selection of multiple entities

- [ ] **Task 9: Implement entity type selection** (AC: 2)
  - [ ] Load entity types via entitiesService.getEntityTypes()
  - [ ] Display as multi-select dropdown
  - [ ] Types: "Loan Institution", "Insurance Company", "Bank", etc.
  - [ ] Allow selection of multiple types

- [ ] **Task 10: Implement user selection** (AC: 2)
  - [ ] Load users via usersService.getExternalUsers()
  - [ ] Display as multi-select dropdown with search
  - [ ] Show: Full Name (Email) - Entity Name
  - [ ] Allow selection of multiple users

- [ ] **Task 11: Implement contact group selection** (AC: 2)
  - [ ] Load contact groups via contactGroupsService.getAll()
  - [ ] Display as multi-select dropdown
  - [ ] Show: Group Name (Member Count)
  - [ ] Allow selection of multiple groups

- [ ] **Task 12: Implement recipient preview** (AC: 3, 4)
  - [ ] Add "Preview Recipients" button
  - [ ] On click, call announcementsService.previewRecipients(config)
  - [ ] Display preview in modal or expandable section:
    - Total recipient count
    - List of recipient names (paginated, max 100 shown)
    - Breakdown by source (entities, types, users, groups)
  - [ ] Update preview when configuration changes

- [ ] **Task 13: Integrate recipient selector in create/edit announcement** (AC: 1, 6)
  - [ ] Add recipient-selector component to create announcement form
  - [ ] Bind to form control: recipientConfiguration
  - [ ] Validate: at least one recipient type selected
  - [ ] Show validation error if no recipients

- [ ] **Task 14: Implement update recipients for existing announcement** (AC: 6)
  - [ ] Add "Edit Recipients" button to announcement detail view
  - [ ] Show recipient selector modal
  - [ ] On save, call announcementsService.updateRecipients(id, config)
  - [ ] Show success message: "Recipients updated successfully"
  - [ ] Refresh announcement detail

### Testing Tasks

- [ ] **Task 15: Write unit tests for RecipientCalculator** (AC: 4, 5)
  - [ ] Test: `CalculateRecipients_AllUsers_ReturnsAllExternalUsers`
  - [ ] Test: `CalculateRecipients_SelectedEntities_ReturnsUsersOfThoseEntities`
  - [ ] Test: `CalculateRecipients_EntityTypes_ReturnsUsersOfEntitiesOfThoseTypes`
  - [ ] Test: `CalculateRecipients_SelectedUsers_ReturnsThoseUsers`
  - [ ] Test: `CalculateRecipients_ContactGroups_ReturnsGroupMembers`
  - [ ] Test: `CalculateRecipients_CombinedTypes_RemovesDuplicates`
  - [ ] Mock: IUserRepository, IEntityRepository, IContactGroupRepository

- [ ] **Task 16: Write integration test for recipient configuration**
  - [ ] Test: `PUT_UpdateRecipients_ValidConfig_Returns200AndUpdatesRecipients`
  - [ ] Test: `GET_PreviewRecipients_ValidConfig_ReturnsRecipientList`
  - [ ] Test: `CalculateRecipients_RealData_ReturnsCorrectRecipients`
  - [ ] Use Testcontainers with test data
  - [ ] Verify recipient calculation accuracy

---

## Dev Notes

### Addressee Types Implementation

**Source:** Epic 7, Story 7.11

Four addressee types must be supported:
1. **Selected Entities**: Users associated with selected entities
2. **Selected Contact Groups**: Members of selected contact groups
3. **Selected Types of Entities**: Users whose entity has selected type
4. **Selected Users**: Specific users

### Recipient Calculation Logic

```csharp
public async Task<RecipientListDto> CalculateRecipientsAsync(RecipientConfiguration config)
{
    var recipients = new HashSet<Guid>(); // System users
    var contactEmails = new HashSet<string>(); // Non-system contacts
    
    // 1. All users
    if (config.IncludeAllUsers)
    {
        var allUsers = await _userRepository.GetAllExternalUsersAsync();
        foreach (var user in allUsers)
            recipients.Add(user.Id);
    }
    
    // 2. Selected entities
    if (config.SelectedEntityIds.Any())
    {
        var users = await _userRepository.GetUsersByEntityIdsAsync(config.SelectedEntityIds);
        foreach (var user in users)
            recipients.Add(user.Id);
    }
    
    // 3. Entity types
    if (config.SelectedEntityTypes.Any())
    {
        var entities = await _entityRepository.GetByTypesAsync(config.SelectedEntityTypes);
        var users = await _userRepository.GetUsersByEntityIdsAsync(entities.Select(e => e.Id).ToList());
        foreach (var user in users)
            recipients.Add(user.Id);
    }
    
    // 4. Selected users
    if (config.SelectedUserIds.Any())
    {
        foreach (var userId in config.SelectedUserIds)
            recipients.Add(userId);
    }
    
    // 5. Contact groups
    if (config.SelectedContactGroupIds.Any())
    {
        foreach (var groupId in config.SelectedContactGroupIds)
        {
            var members = await _contactGroupRepository.GetMembersAsync(groupId);
            foreach (var member in members)
            {
                if (member.IsSystemUser)
                    recipients.Add(member.UserId.Value);
                else
                    contactEmails.Add(member.Email);
            }
        }
    }
    
    return new RecipientListDto
    {
        UserIds = recipients.ToList(),
        ContactEmails = contactEmails.ToList(),
        TotalCount = recipients.Count + contactEmails.Count
    };
}
```

### Dependencies

**Prerequisites:**
- **Story 7.1**: Create Announcement (announcement entity must exist)
- **Story 7.11**: Understand Addressee Types (conceptual foundation)
- **Story 7.12**: Create Contact Groups (for contact group selection)
- **Epic 2**: Authorization (entity and user data)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

