# Story 6.7: Replace File (New Version Upload)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.7  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** upload a new version of an existing file,  
**So that** users access the most current documents.

---

## Acceptance Criteria

1. UKNF Employee can select existing file and choose "Upload New Version"
2. Employee uploads new file (can be different filename)
3. Employee can update metadata (Reporting Period, Model Update Date, Description)
4. System marks previous version as "Archival" with archive date
5. New version is marked as "Current"
6. Access permissions are inherited from previous version (can be modified after upload)
7. Previous version remains accessible (Story 6.10)
8. Users see "Updated" indicator or notification for files they previously accessed
9. System logs version upload with timestamp and employee ID
10. Change history shows version transition
11. Version chain is maintained (link from new to previous version)
12. System performs virus scanning on new file
13. System validates file (size, type) same as initial upload

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ReplaceFileCommand** (AC: 2, 3)
  - [ ] Create `ReplaceFileCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileId (Guid, required) - ID of file to replace
    - NewFile (IFormFile, required) - new file content
    - Filename (string, required) - display name for new version
    - Description (string?, nullable)
    - ReportingPeriod (string?, nullable)
    - ModelUpdateDate (DateTime, required)
    - InheritPermissions (bool, default true)
  - [ ] Note: File is part of multipart/form-data request

- [ ] **Task 2: Create ReplaceFileCommandValidator** (AC: 2, 3, 13)
  - [ ] Create `ReplaceFileCommandValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate NewFile: NotNull
  - [ ] Validate NewFile Size: MaxSize 100 MB
  - [ ] Validate NewFile Extension: Must be in allowed list
  - [ ] Validate Filename: NotEmpty, MaxLength(500)
  - [ ] Validate Description: MaxLength(2000) if provided
  - [ ] Validate ReportingPeriod: MaxLength(100) if provided
  - [ ] Validate ModelUpdateDate: NotEmpty, MustBeDateInPastOrToday
  - [ ] Add async validation: FileId must exist and not be deleted
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 3: Create ReplaceFileCommandHandler** (AC: 1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12)
  - [ ] Create `ReplaceFileCommandHandler.cs` implementing `IRequestHandler<ReplaceFileCommand, ReplaceFileResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFileStorageService, IVirusScanService, IFilePermissionRepository, IFileChangeHistoryRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Load existing file (currentVersion)
    - Validate file exists, not deleted, and is Current version
    - Begin transaction
    - Upload new file to storage
    - Initiate virus scan
    - Create new LibraryFile entity (newVersion):
      - New Filename, Description, ReportingPeriod, ModelUpdateDate
      - VersionStatus = Current
      - PreviousVersionId = currentVersion.Id (AC: 11)
      - CategoryId = currentVersion.CategoryId (inherited)
      - VirusScanStatus = Pending
      - UploadedByUserId = current user
    - Update currentVersion:
      - VersionStatus = Archival (AC: 4)
      - ArchivalDate = now (AC: 4)
    - If InheritPermissions (AC: 6):
      - Copy all permissions from currentVersion to newVersion
      - Create FilePermission records for newVersion
    - Save newVersion and currentVersion
    - Create FileChangeHistory entries:
      - For currentVersion: Action = Archive
      - For newVersion: Action = VersionReplace
    - Commit transaction
    - Log version replacement (AC: 9)
    - Return ReplaceFileResponse
  - [ ] Handle errors: file not found, storage failures, transaction rollback

- [ ] **Task 4: Create ReplaceFileResponse DTO** (AC: 5, 11)
  - [ ] Create `ReplaceFileResponse.cs` record
  - [ ] Properties:
    - NewFileId (Guid)
    - Filename (string)
    - PreviousFileId (Guid)
    - Message (string)
    - VirusScanStatus (string)

- [ ] **Task 5: Create REST API endpoint POST /library/files/{fileId}/replace** (AC: 1, 9, 13)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create POST action `ReplaceFileAsync(Guid fileId, [FromForm] ReplaceFileRequest request)`
  - [ ] Note: [FromForm] for multipart/form-data
  - [ ] Inject IMediator to send command
  - [ ] Return 201 Created with ReplaceFileResponse and Location header (new file)
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Return 409 Conflict if file already Archival
  - [ ] Return 413 Payload Too Large if file exceeds size limit
  - [ ] Return 422 Unprocessable Entity if virus scan fails
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 6: Update LibraryFile entity** (AC: 4, 5, 11)
  - [ ] Add domain method: MarkAsArchival()
  - [ ] Method sets VersionStatus = Archival, ArchivalDate = now
  - [ ] Add domain validation: Can only archive Current versions

- [ ] **Task 7: Implement permission inheritance** (AC: 6)
  - [ ] Create method: CopyPermissionsToNewVersion(oldFileId, newFileId)
  - [ ] Load all permissions from old file
  - [ ] Create new FilePermission records for new file
  - [ ] Same PermissionType, EntityId, UserId, etc.
  - [ ] CreatedByUserId = current user (who replaced file)
  - [ ] Log permission inheritance in change history

- [ ] **Task 8: Update ILibraryFileRepository** (AC: 7, 11)
  - [ ] Add method: GetVersionChainAsync(Guid fileId)
  - [ ] Returns all files in version chain (current and all archival)
  - [ ] Follow PreviousVersionId links
  - [ ] Order chronologically (newest to oldest)

- [ ] **Task 9: Create user notification preparation** (AC: 8)
  - [ ] Create domain event: FileVersionReplacedEvent
  - [ ] Event properties: OldFileId, NewFileId, ChangedByUserId
  - [ ] Publish event after successful replacement
  - [ ] Event handler (future): Notify users who downloaded previous version

### Frontend Tasks

- [ ] **Task 10: Create file replace component** (AC: 1, 2, 3, 6)
  - [ ] Create `library-file-replace.component.ts` in `src/app/features/library/`
  - [ ] Form with fields:
    - File upload (new file)
    - Filename (pre-populated, editable)
    - Description (pre-populated, editable)
    - Reporting Period (pre-populated, editable)
    - Model Update Date (date picker, required)
    - Inherit Permissions (checkbox, default true)
  - [ ] Show current file information for reference
  - [ ] File drag-and-drop functionality
  - [ ] File preview after selection
  - [ ] Validate file size and type client-side

- [ ] **Task 11: Add "Upload New Version" button** (AC: 1)
  - [ ] Add button to file details page
  - [ ] Button only visible to UKNF Employees
  - [ ] Button only enabled for Current version files
  - [ ] Open replace modal or navigate to replace page

- [ ] **Task 12: Add replace button to library list** (AC: 1)
  - [ ] Add "Replace" option in action menu for each file
  - [ ] Only visible to UKNF Employees
  - [ ] Only enabled for Current version files
  - [ ] Open replace modal or navigate to replace page

- [ ] **Task 13: Update library service** (AC: 1, 2, 3)
  - [ ] Add method to `library.service.ts`:
    - replaceFile(fileId: string, formData: FormData): Observable<ReplaceFileResponse>
  - [ ] Configure HTTP client for multipart/form-data
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 14: Implement confirmation dialog** (AC: 4, 7)
  - [ ] Show confirmation before replacing file
  - [ ] Explain that previous version will be archived
  - [ ] Explain that previous version remains accessible
  - [ ] Show inherited permissions preview
  - [ ] Require explicit confirmation

- [ ] **Task 15: Show success feedback** (AC: 5, 8, 10)
  - [ ] Show success notification after replacement
  - [ ] Display new file ID and details
  - [ ] Show virus scan status
  - [ ] Redirect to new file details page
  - [ ] Show "Updated" badge on file in library list

- [ ] **Task 16: Display version indicator** (AC: 5, 8)
  - [ ] Show "Updated" badge on files recently replaced
  - [ ] Show update date on file list
  - [ ] Highlight new version in version history
  - [ ] Show "Previous Version" link on current file

- [ ] **Task 17: Handle upload progress** (AC: 2, 13)
  - [ ] Show upload progress bar for large files
  - [ ] Show upload status (uploading, scanning, processing)
  - [ ] Disable form during upload
  - [ ] Allow cancellation (optional)

### Testing Tasks

- [ ] **Task 18: Unit tests for command handler** (AC: 2, 3, 4, 5, 6, 7, 9, 10, 11, 12)
  - [ ] Test successful file replacement
  - [ ] Test new file uploaded to storage
  - [ ] Test virus scan initiated
  - [ ] Test new version created with Current status
  - [ ] Test previous version marked as Archival with date
  - [ ] Test permission inheritance
  - [ ] Test version chain linked correctly (PreviousVersionId)
  - [ ] Test metadata updated
  - [ ] Test change history created
  - [ ] Test cannot replace already archival file
  - [ ] Test cannot replace deleted file

- [ ] **Task 19: Unit tests for permission inheritance** (AC: 6)
  - [ ] Test all permissions copied to new version
  - [ ] Test AllUsers permission inherited
  - [ ] Test SpecificEntity permissions inherited
  - [ ] Test multiple permission types inherited
  - [ ] Test inheritance can be disabled

- [ ] **Task 20: Unit tests for version chain** (AC: 7, 11)
  - [ ] Test PreviousVersionId set correctly
  - [ ] Test version chain can be traversed
  - [ ] Test GetVersionChainAsync returns all versions
  - [ ] Test version chain ordered correctly

- [ ] **Task 21: Unit tests for validator** (AC: 2, 3, 13)
  - [ ] Test file size validation (100 MB limit)
  - [ ] Test file type validation
  - [ ] Test required field validation
  - [ ] Test FileId must exist
  - [ ] Test FileId must be Current version

- [ ] **Task 22: Integration tests for API endpoint** (AC: 1, 4, 5, 9, 13)
  - [ ] Test POST /library/files/{id}/replace with valid data returns 201
  - [ ] Test replacement requires UKNF Employee role (403 if not)
  - [ ] Test replacing non-existent file returns 404
  - [ ] Test replacing archival file returns 409
  - [ ] Test file size exceeds limit returns 413
  - [ ] Test virus scan initiated
  - [ ] Test previous version marked as Archival
  - [ ] Test new version marked as Current
  - [ ] Test permissions inherited
  - [ ] Test change history created

- [ ] **Task 23: Frontend unit tests** (AC: 1, 2, 3, 6)
  - [ ] Test file replace component rendering
  - [ ] Test form pre-population with current values
  - [ ] Test file selection and preview
  - [ ] Test inherit permissions checkbox
  - [ ] Test confirmation dialog
  - [ ] Test service method calls

- [ ] **Task 24: E2E tests** (AC: 1-13)
  - [ ] Test complete file replacement flow as UKNF Employee
  - [ ] Test new version visible in library
  - [ ] Test previous version marked as Archival
  - [ ] Test previous version accessible (Story 6.10)
  - [ ] Test permissions inherited
  - [ ] Test version chain displayed correctly
  - [ ] Test "Updated" indicator shown
  - [ ] Test cannot replace archival file
  - [ ] Test validation errors displayed

### Documentation Tasks

- [ ] **Task 25: API documentation** (AC: 1, 9, 13)
  - [ ] Document POST /library/files/{id}/replace endpoint
  - [ ] Include request/response examples
  - [ ] Document multipart/form-data format
  - [ ] Document error responses
  - [ ] Document authentication requirements
  - [ ] Explain versioning behavior

- [ ] **Task 26: Developer documentation** (AC: 4, 6, 7, 11)
  - [ ] Document versioning strategy and version chain
  - [ ] Document permission inheritance logic
  - [ ] Document archival process
  - [ ] Document change history tracking
  - [ ] Document virus scanning for new versions

- [ ] **Task 27: User documentation** (AC: 1, 2, 3, 4, 6, 7)
  - [ ] Create user guide for replacing files
  - [ ] Explain difference between metadata edit and file replacement
  - [ ] Explain versioning and archival
  - [ ] Explain permission inheritance
  - [ ] Explain that previous versions remain accessible
  - [ ] Include screenshots

---

## Technical Notes

### Versioning Strategy

Version Chain:
```
[Current v3] -> PreviousVersionId -> [Archival v2] -> PreviousVersionId -> [Archival v1]
```

- Only ONE Current version exists per chain
- All previous versions are Archival
- PreviousVersionId links versions chronologically
- Each version is a separate LibraryFile record

### File Replacement Process

1. **Validate**: Current version exists and is Current
2. **Upload**: New file to storage
3. **Scan**: Virus scan on new file
4. **Create**: New LibraryFile entity (VersionStatus = Current)
5. **Archive**: Update old LibraryFile (VersionStatus = Archival, ArchivalDate = now)
6. **Link**: Set newVersion.PreviousVersionId = oldVersion.Id
7. **Permissions**: Copy permissions from old to new (if inherited)
8. **Log**: Change history for both versions
9. **Notify**: Users who accessed previous version (optional)

### Permission Inheritance

By default, inherit all permissions:
- Simplifies workflow (UKNF doesn't re-configure every time)
- Ensures continuity of access
- Can be modified after replacement

If inheritance disabled:
- New version has no permissions (private)
- UKNF must explicitly set permissions

### Archival Date

- **ArchivalDate**: Set when version is archived (replaced)
- Used for audit and display
- Shows when file became archival
- Different from ModelUpdateDate (document version date)

### Change History

Create two change history entries:

**Old version**:
- Action: Archive
- ChangeDescription: "File archived due to new version upload"

**New version**:
- Action: VersionReplace
- ChangeDescription: "Replaced version {oldVersionId}"

### Virus Scanning

- New file must be scanned before use
- VirusScanStatus = Pending initially
- Prevent downloads until scan complete
- Archival version remains downloadable (already scanned)

### Download Count

Consider two options:
1. Reset download count on new version (separate tracking)
2. Accumulate download count across versions (total engagement)

Recommendation: Separate tracking (easier analytics per version).

### Model Update Date

- Represents document version date (not system version)
- Can be same or different from previous version
- Example: Q1 2025 template updated Feb 1 and Feb 15 â†’ two versions, different ModelUpdateDates

### Performance Considerations

- Upload and replace in single transaction
- Use streaming for large file uploads
- Async virus scanning (don't block request)
- Index PreviousVersionId for version chain queries
- Consider background job for notification

### Security Considerations

- Only UKNF Employees can replace files
- Validate Current version (don't allow replacing archival)
- Virus scan all new uploads
- Audit all replacements
- Prevent race conditions (two simultaneous replacements)

### UI/UX Considerations

- Clear distinction between "Edit Metadata" and "Upload New Version"
- Show current file info for reference when replacing
- Explain archival behavior in confirmation dialog
- Show version history after replacement
- Highlight "Updated" for recently replaced files
- Consider notification to users who downloaded previous version

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (initial upload functionality)
- **Story 6.2**: Set File Access Permissions (permission system)
- **Epic 1**: Authentication (UKNF Employee role identification)
- File storage and virus scanning infrastructure

### Integrates With
- **Story 6.5**: View File Details (replace button on details page)
- **Story 6.6**: Update File Metadata (separate from replacement)
- **Story 6.10**: Access Archival File Versions (archival versions accessible)
- **Story 6.11**: View File Change History (change history tracks replacements)
- **Story 6.13**: Notify Users (optional notification on replacement)

---

## Acceptance Checklist

- [ ] UKNF Employee can upload new version of existing file
- [ ] Employee can upload new file content
- [ ] Employee can update metadata during replacement
- [ ] Previous version is marked as Archival with archive date
- [ ] New version is marked as Current
- [ ] Access permissions are inherited from previous version
- [ ] Previous version remains accessible
- [ ] Users see "Updated" indicator for replaced files
- [ ] System logs version replacement
- [ ] Change history shows version transition
- [ ] Version chain is maintained (PreviousVersionId)
- [ ] System performs virus scanning on new file
- [ ] System validates new file (size, type)
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (initial upload)
- **Story 6.2**: Set File Access Permissions (permission inheritance)
- **Story 6.5**: View File Details (replace button)
- **Story 6.6**: Update File Metadata (metadata-only changes)
- **Story 6.10**: Access Archival File Versions (view archival versions)
- **Story 6.11**: View File Change History (view version changes)
- **Story 6.13**: Notify Users (notification on update)

---

## Notes

- File versioning is critical for compliance (audit trail of template changes)
- Permission inheritance simplifies workflow but must be clearly communicated
- Archival versions provide historical reference
- Clear distinction between metadata edit (6.6) and file replacement (6.7)
- Version chain enables full history tracking
- Consider retention policy for very old archival versions (future)
- Test with rapid succession of replacements (v1 â†’ v2 â†’ v3 â†’ v4)
- Monitor storage costs (multiple versions of large files)
- Consider automatic archival of versions older than X years
- Notify users of critical template updates (e.g., new regulatory requirements)
- Consider "Restore Previous Version" functionality (future)
- Version comparison tool could be valuable (diff between versions - future)
- Test version chain navigation in UI (previous/next version buttons)

