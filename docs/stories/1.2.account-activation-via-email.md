# Story 1.2: Account Activation via Email

**Epic:** 1 - Authentication & User Registration  
**Story Number:** 1.2  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** newly registered external user,  
**I want to** activate my account via an email link,  
**so that** I can set my password and access the system.

---

## Acceptance Criteria

1. System sends activation link to the email address provided during registration
2. Activation email is sent immediately after successful registration
3. Activation link is secure (time-limited, single-use token)
4. Clicking activation link opens password creation page
5. User cannot log in before activating their account
6. System displays appropriate error messages for expired or invalid activation links

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ActivationToken entity** (AC: 3)
  - [ ] Create `ActivationToken.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties: Id (Guid), UserId (Guid FK), Token (string, unique), ExpiresAt (DateTime), IsUsed (bool), CreatedDate
  - [ ] Add domain method `Create(userId)` to generate secure token
  - [ ] Add domain method `IsValid()` to check if token is not expired and not used
  - [ ] Token should be cryptographically secure (use `RandomNumberGenerator`)
  - [ ] Set expiration to 24 hours from creation

- [ ] **Task 2: Create database schema for ActivationTokens table** (AC: 3)
  - [ ] Create EF Core configuration `ActivationTokenConfiguration.cs` in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Configurations/`
  - [ ] Configure table, primary key, foreign key to Users
  - [ ] Add unique index on Token column
  - [ ] Add index on UserId and ExpiresAt for queries
  - [ ] Create EF Core migration `Add_ActivationTokens_Table`

- [ ] **Task 3: Update RegisterUserCommandHandler to generate activation token** (AC: 1, 2)
  - [ ] Modify `RegisterUserCommandHandler.cs` created in Story 1.1
  - [ ] After creating user, create ActivationToken via domain method
  - [ ] Save token to repository (IActivationTokenRepository)
  - [ ] Generate activation URL: `{FrontendUrl}/auth/activate?token={token}`
  - [ ] Pass activation URL to email service

- [ ] **Task 4: Create email templates infrastructure** (AC: 1, 2)
  - [ ] Create `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/` folder
  - [ ] Create `AccountActivationEmail.cshtml` Razor template
  - [ ] Template should include:
    - UKNF branding/logo
    - Welcome message with user's first name
    - Activation link button
    - Link expiration notice (24 hours)
    - Support contact information
    - Warning not to share link
  - [ ] Make template responsive (mobile-friendly)

- [ ] **Task 5: Implement email service with MailKit** (AC: 1, 2)
  - [ ] Create `IEmailService.cs` interface in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Method: `SendAccountActivationEmailAsync(email, firstName, activationUrl)`
  - [ ] Create `EmailService.cs` implementation in `Infrastructure/UknfPlatform.Infrastructure.Email/Services/`
  - [ ] Inject IOptions<EmailSettings> for SMTP configuration
  - [ ] Use MailKit to send email with HTML template
  - [ ] Implement retry logic (3 attempts) for transient failures
  - [ ] Log email sending attempts and results
  - [ ] Handle SMTP errors gracefully

- [ ] **Task 6: Create ActivateAccountCommand and Handler** (AC: 3, 4, 5, 6)
  - [ ] Create `ActivateAccountCommand.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] Command property: Token (string)
  - [ ] Create `ActivateAccountCommandHandler.cs`
  - [ ] Handler logic:
    - Find token in repository by token string
    - If token not found, throw `InvalidTokenException` (AC: 6)
    - Check if token.IsValid() (not expired, not used)
    - If expired, throw `TokenExpiredException` (AC: 6)
    - If already used, throw `TokenAlreadyUsedException` (AC: 6)
    - Retrieve associated User
    - If user already active, return success (idempotent)
    - Set user.IsActive = true
    - Mark token.IsUsed = true
    - Save changes to repository
    - Return ActivateAccountResponse with userId
  - [ ] Log activation success/failures

- [ ] **Task 7: Create FluentValidation validator for ActivateAccountCommand** (AC: 3)
  - [ ] Create `ActivateAccountCommandValidator.cs`
  - [ ] Validate Token: NotEmpty, MinLength(32) - tokens should be long

- [ ] **Task 8: Create REST API endpoint GET /auth/activate** (AC: 4, 6)
  - [ ] Add action to `AuthController.cs`: `ActivateAccountAsync(string token)`
  - [ ] `[AllowAnonymous]` attribute
  - [ ] Send ActivateAccountCommand via MediatR
  - [ ] Return 200 OK with success message on valid activation
  - [ ] Return 400 Bad Request with error message for invalid/expired/used tokens
  - [ ] Return specific error messages:
    - "Activation link is invalid"
    - "Activation link has expired. Please request a new one."
    - "This account has already been activated"
  - [ ] Add Swagger documentation

- [ ] **Task 9: Create ActivationToken repository** (AC: 3)
  - [ ] Create `IActivationTokenRepository.cs` interface in `Domain/UknfPlatform.Domain.Auth/`
  - [ ] Methods: GetByTokenAsync, AddAsync, UpdateAsync
  - [ ] Create `ActivationTokenRepository.cs` implementation in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/`
  - [ ] Implement with EF Core, include User navigation property when loading

- [ ] **Task 10: Update User entity to prevent login if inactive** (AC: 5)
  - [ ] Modify login logic (will be in Story 1.4, but prepare now)
  - [ ] Add validation in authentication: if user.IsActive == false, throw `AccountNotActivatedException`
  - [ ] Note: This will be fully implemented in Story 1.4 (User Login)

- [ ] **Task 11: Create resend activation email endpoint (bonus)** (AC: 6)
  - [ ] Create POST `/auth/resend-activation` endpoint
  - [ ] Request body: { email }
  - [ ] Find user by email
  - [ ] If user already active, return message "Account already activated"
  - [ ] If user not found, return generic success (don't reveal user existence)
  - [ ] Invalidate old tokens for this user (mark as used)
  - [ ] Generate new activation token
  - [ ] Send new activation email
  - [ ] Return success message

### Frontend Tasks

- [ ] **Task 12: Create account activation page component** (AC: 4, 6)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/auth/activate/activate.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/auth/activate` (no auth required)
  - [ ] Extract `token` query parameter from URL on component init
  - [ ] Auto-call activation API when component loads

- [ ] **Task 13: Implement activation logic in component** (AC: 4, 5, 6)
  - [ ] Inject ActivatedRoute to get token from query params
  - [ ] Inject AuthService
  - [ ] On ngOnInit:
    - Show loading spinner
    - Call authService.activateAccount(token)
    - On success:
      - Show success message: "Account activated successfully!"
      - Show button "Set Password" redirecting to password creation page (Story 1.3)
    - On error (400):
      - Parse error message from backend
      - Show appropriate error:
        - "Activation link is invalid"
        - "Activation link has expired"
        - "Account already activated"
      - If expired, show "Request New Activation Link" button
  - [ ] Handle network errors gracefully

- [ ] **Task 14: Add activateAccount method to AuthService** (AC: 4, 6)
  - [ ] Add method `activateAccount(token: string): Observable<ActivationResponse>`
  - [ ] Call GET `/api/auth/activate?token={token}`
  - [ ] Use catchError for error handling
  - [ ] Return Observable with result

- [ ] **Task 15: Create activation page UI** (AC: 4, 6)
  - [ ] Use auth-layout (centered content)
  - [ ] Loading state: Show spinner and "Activating your account..."
  - [ ] Success state: 
    - Success icon (checkmark)
    - Success message
    - "Set Password" button
  - [ ] Error state:
    - Error icon
    - Error message
    - "Request New Link" button (if expired)
    - "Go to Login" button
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 16: Create resend activation link component (bonus)** (AC: 6)
  - [ ] Create `/auth/resend-activation` route and component
  - [ ] Form with email field
  - [ ] On submit, call POST `/api/auth/resend-activation`
  - [ ] Show success message: "If that email is registered, we've sent a new activation link"
  - [ ] Don't reveal if email exists (security)

### Testing Tasks

- [ ] **Task 17: Write unit tests for ActivateAccountCommandHandler** (AC: 3, 5, 6)
  - [ ] Test: `Handle_ValidToken_ActivatesUserAccount`
  - [ ] Test: `Handle_InvalidToken_ThrowsInvalidTokenException`
  - [ ] Test: `Handle_ExpiredToken_ThrowsTokenExpiredException`
  - [ ] Test: `Handle_AlreadyUsedToken_ThrowsTokenAlreadyUsedException`
  - [ ] Test: `Handle_AlreadyActiveUser_ReturnsSuccessIdempotently`
  - [ ] Test: `Handle_ValidToken_MarksTokenAsUsed`
  - [ ] Mock: IActivationTokenRepository, IUserRepository, ILogger

- [ ] **Task 18: Write unit tests for email service**
  - [ ] Test: `SendAccountActivationEmail_ValidData_SendsEmail`
  - [ ] Test: `SendAccountActivationEmail_SmtpFailure_RetriesThreeTimes`
  - [ ] Test: `SendAccountActivationEmail_RendersTemplateCorrectly`
  - [ ] Mock SMTP client or use test SMTP server (MailDev)

- [ ] **Task 19: Write integration tests for activation flow** (AC: All)
  - [ ] Test: `GET_Activate_WithValidToken_Returns200AndActivatesUser`
  - [ ] Test: `GET_Activate_WithExpiredToken_Returns400`
  - [ ] Test: `GET_Activate_WithInvalidToken_Returns400`
  - [ ] Test: `GET_Activate_WithUsedToken_Returns400`
  - [ ] Test: `POST_Register_SendsActivationEmail` (extends Story 1.1 test)
  - [ ] Use Testcontainers for database
  - [ ] Verify user.IsActive changes from false to true
  - [ ] Verify token.IsUsed changes to true

- [ ] **Task 20: Write E2E test for registration and activation flow**
  - [ ] Test complete workflow:
    1. Register new user
    2. Extract activation token from email (mock/test SMTP)
    3. Activate account via activation link
    4. Verify user can proceed to password creation
  - [ ] Use Cypress or Playwright for E2E testing

---

## Dev Notes

### Previous Story Context

**From Story 1.1:**
- User entity created with `IsActive` field (defaults to false for new registrations)
- RegisterUserCommand creates inactive user accounts
- User repository implemented
- Email service interface defined (but implementation needed in this story)

**Key Integration Points:**
- Story 1.1 RegisterUserCommandHandler needs to be updated to generate and save activation token
- Email service created in this story will be used throughout the application

### Architecture Context

**Tech Stack (same as Story 1.1):**
- Backend: C# 12.0, .NET 8.0, ASP.NET Core, EF Core, PostgreSQL
- Email: MailKit 4.4.0
- Frontend: Angular 20, PrimeNG, Tailwind CSS

### Project Structure

Backend files:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AuthController.cs (UPDATE: add activate endpoint)
├── Application/UknfPlatform.Application.Auth/Authentication/
│   ├── Commands/
│   │   ├── RegisterUserCommandHandler.cs (UPDATE: add token generation)
│   │   ├── ActivateAccountCommand.cs (CREATE)
│   │   ├── ActivateAccountCommandHandler.cs (CREATE)
│   │   └── Validators/
│   │       └── ActivateAccountCommandValidator.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/
│   └── Entities/
│       ├── User.cs (EXISTS from Story 1.1)
│       └── ActivationToken.cs (CREATE)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/
│   ├── Configurations/
│   │   └── ActivationTokenConfiguration.cs (CREATE)
│   ├── Migrations/ (CREATE: Add_ActivationTokens_Table)
│   └── Repositories/
│       └── ActivationTokenRepository.cs (CREATE)
├── Infrastructure/UknfPlatform.Infrastructure.Email/
│   ├── Services/
│   │   ├── IEmailService.cs (CREATE)
│   │   └── EmailService.cs (CREATE)
│   ├── Templates/
│   │   └── AccountActivationEmail.cshtml (CREATE)
│   └── Settings/
│       └── EmailSettings.cs (CREATE)
```

Frontend files:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── auth.service.ts (UPDATE: add activateAccount method)
├── features/auth/
│   ├── activate/
│   │   ├── activate.component.ts (CREATE)
│   │   ├── activate.component.html (CREATE)
│   │   └── activate.component.scss (CREATE)
│   └── resend-activation/ (BONUS)
│       ├── resend-activation.component.ts (CREATE)
│       └── ...
```

### Data Models

**ActivationTokens Table Schema:**
```sql
CREATE TABLE ActivationTokens (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    Token NVARCHAR(500) NOT NULL UNIQUE,
    ExpiresAt DATETIME2 NOT NULL,
    IsUsed BIT NOT NULL DEFAULT 0,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    INDEX IX_ActivationTokens_Token (Token),
    INDEX IX_ActivationTokens_UserId_ExpiresAt (UserId, ExpiresAt)
);
```

**Token Generation:**
- Use `RandomNumberGenerator` for cryptographically secure random bytes
- Convert to Base64 URL-safe string
- Minimum length: 32 characters
- Example: `"7Kj9mP2xQ8vN4wR6tL1sY3zF5bH8cD0gA"`

**C# Example:**
```csharp
public static string GenerateSecureToken()
{
    var randomBytes = new byte[32];
    using (var rng = RandomNumberGenerator.Create())
    {
        rng.GetBytes(randomBytes);
    }
    return Convert.ToBase64String(randomBytes)
        .Replace("+", "-")
        .Replace("/", "_")
        .TrimEnd('=');
}
```

### Email Configuration

**EmailSettings Configuration:**
```json
// appsettings.json
{
  "EmailSettings": {
    "SmtpServer": "localhost",
    "SmtpPort": 1025,
    "UseSsl": false,
    "Username": "",
    "Password": "",
    "FromEmail": "noreply@uknf.gov.pl",
    "FromName": "UKNF Communication Platform"
  },
  "FrontendUrl": "http://localhost:4200"
}
```

**For Development:**
- Use MailDev Docker container (captures emails, no actual sending)
- SMTP: localhost:1025
- Web UI: localhost:1080 (to view captured emails)

**MailKit SMTP Example:**
```csharp
using var client = new SmtpClient();
await client.ConnectAsync(_settings.SmtpServer, _settings.SmtpPort, _settings.UseSsl);
if (!string.IsNullOrEmpty(_settings.Username))
{
    await client.AuthenticateAsync(_settings.Username, _settings.Password);
}
await client.SendAsync(message);
await client.DisconnectAsync(true);
```

### REST API Specification

**Endpoint 1:** GET `/api/auth/activate?token={token}`
- **Security:** None (public endpoint)
- **Query Parameter:** token (string, required)
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "Account activated successfully. Please set your password."
  }
  ```
- **Error Responses:**
  - 400 Bad Request: Invalid, expired, or used token
  - 404 Not Found: Token not found

**Endpoint 2:** POST `/api/auth/resend-activation` (Bonus)
- **Security:** None (public endpoint)
- **Request Body:**
  ```json
  {
    "email": "user@example.com"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "message": "If that email is registered, we've sent a new activation link."
  }
  ```

### Coding Standards (Key Points)

1. **Token Security:**
   - Use `RandomNumberGenerator` (NOT `Random` class)
   - Store tokens as-is (no hashing needed for activation tokens, but hash for password reset tokens)
   - Set expiration to 24 hours
   - Single-use tokens (mark as used after activation)

2. **Email Template Rendering:**
   - Use Razor engine for template compilation
   - Inject data: firstName, activationUrl
   - HTML email with plain text fallback

3. **Error Messages:**
   - Be specific for user experience but not security-revealing
   - "Activation link has expired" vs "Invalid token" (both prevent enumeration)

4. **Idempotency:**
   - If user already activated, return success (don't fail)
   - Prevents errors if user clicks link multiple times

5. **Logging:**
   ```csharp
   _logger.LogInformation("Activation token generated for user {UserId}", userId);
   _logger.LogInformation("Account activated successfully for user {UserId}", userId);
   _logger.LogWarning("Activation failed: token expired for user {UserId}", userId);
   ```

6. **Email Retry Logic:**
   - Implement 3 retry attempts for transient SMTP failures
   - Use exponential backoff (1s, 2s, 4s)
   - Log each attempt

### Security Requirements

1. **Token Expiration:** 24 hours (configurable)
2. **Single-Use Tokens:** Mark as used after activation
3. **HTTPS:** All activation links must use HTTPS in production
4. **No Token Reuse:** Once used, token cannot activate account again
5. **Rate Limiting:** Consider rate limiting on resend-activation endpoint (can add later)

### Audit Requirements

- Log token generation with user ID
- Log activation attempts (success/failure) with token and user ID
- Log email sending attempts and results
- Include timestamp and correlation ID for all logs

### Email Template Best Practices

1. **Responsive Design:** Mobile-friendly HTML
2. **Fallback:** Include plain text version
3. **Clear CTA:** "Activate Account" button, large and obvious
4. **Expiration Notice:** Clearly state 24-hour expiration
5. **Support Info:** Include contact email for help
6. **Security Warning:** "Don't share this link with anyone"
7. **Branding:** UKNF logo and colors

### Dependencies

**Prerequisites:**
- Story 1.1 completed (User entity, registration endpoint)
- SMTP service configured (MailDev for dev, real SMTP for production)
- Frontend URL configured in appsettings.json

**Blocks:**
- Story 1.3 (Initial Password Creation) - activated users need to set passwords
- Story 1.4 (User Login) - login checks if user is active

### Testing Strategy

**Unit Tests:**
- ActivationToken domain entity methods (IsValid, Create)
- ActivateAccountCommandHandler (all scenarios)
- Email service (template rendering, SMTP sending)

**Integration Tests:**
- Full activation flow (register → activate → verify user active)
- Token expiration handling
- Email sending verification (use MailDev test SMTP)

**E2E Test:**
- Complete user journey: register → check email → click link → verify activation

### Error Scenarios to Handle

1. **Token not found:** "Activation link is invalid"
2. **Token expired:** "Activation link has expired. Please request a new one."
3. **Token already used:** "This account has already been activated"
4. **User already active:** Return success (idempotent)
5. **Email sending failure:** Log error, retry 3 times, if still fails log critical error
6. **Invalid email format in resend:** Return generic success (don't reveal)
7. **Network errors:** Frontend should show user-friendly message

### Frontend Activation Flow States

1. **Loading:** "Activating your account..." (spinner)
2. **Success:** 
   - Green checkmark icon
   - "Account activated successfully!"
   - "Set Password" button (link to Story 1.3)
3. **Error - Invalid Token:**
   - Red X icon
   - "Activation link is invalid"
   - "Go to Login" button
4. **Error - Expired Token:**
   - Yellow warning icon
   - "Activation link has expired"
   - "Request New Link" button (opens resend form)
5. **Error - Already Activated:**
   - Blue info icon
   - "This account is already activated"
   - "Go to Login" button

### Additional Notes

1. **Token Length:** 32+ bytes (base64 encoded = ~43+ characters)
2. **URL Structure:** `https://app.uknf.gov.pl/auth/activate?token=ABC123...`
3. **Email Subject:** "Activate Your UKNF Account"
4. **Email Sender:** "UKNF Communication Platform <noreply@uknf.gov.pl>"
5. **Resend Limit:** Consider adding rate limit (e.g., max 3 resends per hour per email)
6. **Token Cleanup:** Consider background job to delete expired tokens after 48 hours (future enhancement)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 1 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

