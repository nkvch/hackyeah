# Story 6.12: Monitor File Access (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.12  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** see which users have downloaded files,  
**So that** I can understand usage patterns and ensure important files are accessed.

---

## Acceptance Criteria

1. UKNF Employee can access "Access Report" for any file
2. Report shows: User name, Entity, Download timestamp, IP address
3. Report can be filtered by: Date range, Entity, User
4. Report can be sorted by: Download date, User, Entity
5. Report shows total download count
6. Employee can export access report (CSV)
7. For important files (e.g., mandatory report templates), employee can identify entities that haven't downloaded
8. Report respects user privacy (internal analytics use only)
9. Report supports pagination for files with many downloads
10. Employee can view aggregated statistics (total downloads, unique users, downloads per entity)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetFileAccessReportQuery** (AC: 1, 2, 3, 4, 5, 9)
  - [ ] Create `GetFileAccessReportQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties:
    - FileId (Guid, required)
    - DateFrom (DateTime?, nullable)
    - DateTo (DateTime?, nullable)
    - EntityId (long?, nullable)
    - UserId (Guid?, nullable)
    - SortBy (enum, default DownloadDate)
    - SortDirection (enum, default Descending)
    - PageNumber (int, default 1)
    - PageSize (int, default 50)

- [ ] **Task 2: Create GetFileAccessReportQueryValidator** (AC: 1, 3, 4, 9)
  - [ ] Create `GetFileAccessReportQueryValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate DateFrom <= DateTo if both provided
  - [ ] Validate PageNumber: GreaterThan(0)
  - [ ] Validate PageSize: Between(1, 100)
  - [ ] Validate SortBy: MustBeValidEnum
  - [ ] Validate SortDirection: MustBeValidEnum
  - [ ] Add async validation: File must exist
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 3: Create GetFileAccessReportQueryHandler** (AC: 1, 2, 3, 4, 5, 9)
  - [ ] Create `GetFileAccessReportQueryHandler.cs` implementing `IRequestHandler<GetFileAccessReportQuery, GetFileAccessReportResponse>`
  - [ ] Inject dependencies: IFileDownloadRepository, IUserRepository, IEntityRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Load FileDownload records for FileId
    - Join with Users table (get user name, entity)
    - Join with Entities table (get entity name)
    - Apply filters: DateRange, EntityId, UserId (AC: 3)
    - Apply sorting (AC: 4)
    - Apply pagination (AC: 9)
    - Calculate total download count (AC: 5)
    - Return GetFileAccessReportResponse

- [ ] **Task 4: Create GetFileAccessReportResponse DTO** (AC: 2, 5, 9)
  - [ ] Create `GetFileAccessReportResponse.cs` record
  - [ ] Properties:
    - Downloads (List<FileDownloadDto>)
    - TotalDownloads (int)
    - PageNumber (int)
    - PageSize (int)
    - TotalPages (int)

- [ ] **Task 5: Create FileDownloadDto** (AC: 2)
  - [ ] Create `FileDownloadDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - UserId (Guid)
    - UserName (string) - "FirstName LastName"
    - EntityId (long)
    - EntityName (string)
    - DownloadDate (DateTime)
    - IpAddress (string)
    - UserAgent (string?)

- [ ] **Task 6: Create REST API endpoint GET /library/files/{fileId}/access-report** (AC: 1, 3, 4, 5, 9)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetFileAccessReportAsync(Guid fileId, [FromQuery] GetFileAccessReportQuery query)`
  - [ ] Inject IMediator to send query
  - [ ] Return 200 OK with GetFileAccessReportResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 7: Create GetFileAccessStatisticsQuery** (AC: 10)
  - [ ] Create `GetFileAccessStatisticsQuery.cs`
  - [ ] Query properties: FileId (Guid)
  - [ ] Create QueryHandler
  - [ ] Handler logic:
    - Calculate total downloads
    - Calculate unique users
    - Calculate downloads per entity (grouped)
    - Calculate downloads per day/week/month (time series)
    - Calculate first and last download dates
    - Return FileAccessStatisticsDto

- [ ] **Task 8: Create FileAccessStatisticsDto** (AC: 10)
  - [ ] Create `FileAccessStatisticsDto.cs` record
  - [ ] Properties:
    - TotalDownloads (int)
    - UniqueUsers (int)
    - UniqueEntities (int)
    - FirstDownloadDate (DateTime?)
    - LastDownloadDate (DateTime?)
    - DownloadsByEntity (List<EntityDownloadCount>)
    - DownloadsByDay (List<DateDownloadCount>)

- [ ] **Task 9: Create REST API endpoint GET /library/files/{fileId}/access-statistics** (AC: 10)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetFileAccessStatisticsAsync(Guid fileId)`
  - [ ] Return 200 OK with FileAccessStatisticsDto
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist

- [ ] **Task 10: Create GetEntitiesWithoutDownloadQuery** (AC: 7)
  - [ ] Create `GetEntitiesWithoutDownloadQuery.cs`
  - [ ] Query properties: FileId (Guid)
  - [ ] Create QueryHandler
  - [ ] Handler logic:
    - Get all entities that have permission to access file
    - Get all entities that have downloaded file
    - Return entities that have permission but NOT downloaded
    - Return list with entity name, last access date (if any), users

- [ ] **Task 11: Create REST API endpoint GET /library/files/{fileId}/non-downloaders** (AC: 7)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetEntitiesWithoutDownloadAsync(Guid fileId)`
  - [ ] Return 200 OK with list of entities
  - [ ] Useful for identifying entities that should have accessed mandatory files

- [ ] **Task 12: Create ExportFileAccessReportCommand** (AC: 6)
  - [ ] Create `ExportFileAccessReportCommand.cs`
  - [ ] Command properties: FileId (Guid), DateFrom (DateTime?), DateTo (DateTime?)
  - [ ] Create CommandHandler
  - [ ] Handler logic:
    - Load all file downloads (apply date filter, no pagination)
    - Generate CSV file
    - Columns: Download Date, User Name, Entity, IP Address
    - Return file stream
  - [ ] Use CSV library (e.g., CsvHelper)

- [ ] **Task 13: Create REST API endpoint GET /library/files/{fileId}/access-report/export** (AC: 6)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `ExportFileAccessReportAsync(Guid fileId, [FromQuery] DateTime? dateFrom, [FromQuery] DateTime? dateTo)`
  - [ ] Return FileStreamResult with CSV
  - [ ] Filename: "AccessReport_{FileName}_{Date}.csv"
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist

- [ ] **Task 14: Update IFileDownloadRepository** (AC: 2, 3, 4, 5, 7, 9, 10)
  - [ ] Methods already exist from Story 6.4
  - [ ] Add method: GetFileDownloadsWithDetailsAsync(fileId, filters, sorting, pagination)
  - [ ] Include joins with Users and Entities
  - [ ] Add method: GetFileAccessStatisticsAsync(fileId)
  - [ ] Add method: GetEntitiesWithPermissionButNoDownloadAsync(fileId)

### Frontend Tasks

- [ ] **Task 15: Create file access report component** (AC: 1, 2, 3, 4, 5, 9)
  - [ ] Create `library-file-access-report.component.ts` in `src/app/features/library/`
  - [ ] Display access report as table:
    - Columns: Download Date, User Name, Entity, IP Address
    - Sortable columns
    - Pagination controls
  - [ ] Show total download count prominently
  - [ ] Only accessible to UKNF Employees

- [ ] **Task 16: Add access report link** (AC: 1)
  - [ ] Add "View Access Report" button on file details page
  - [ ] Button only visible to UKNF Employees
  - [ ] Open access report page or modal
  - [ ] Show download count on file details page

- [ ] **Task 17: Create access report filters** (AC: 3)
  - [ ] Create `access-report-filters.component.ts`
  - [ ] Filters:
    - Date range picker (From - To)
    - Entity dropdown (all entities with access)
    - User dropdown (all users who downloaded)
  - [ ] "Clear Filters" button
  - [ ] Show active filter count

- [ ] **Task 18: Create access statistics dashboard** (AC: 10)
  - [ ] Create `file-access-statistics.component.ts`
  - [ ] Display statistics:
    - Total downloads (big number)
    - Unique users (big number)
    - Downloads by entity (bar chart)
    - Downloads over time (line chart)
    - First and last download dates
  - [ ] Use charting library (e.g., Chart.js, ngx-charts)

- [ ] **Task 19: Create non-downloader list** (AC: 7)
  - [ ] Create section: "Entities That Haven't Downloaded"
  - [ ] List entities with access but no downloads
  - [ ] Show entity name, users, permission date
  - [ ] Useful for follow-up (contacting entities)
  - [ ] Show count: "X entities haven't downloaded this file"

- [ ] **Task 20: Add export functionality** (AC: 6)
  - [ ] Add "Export to CSV" button on access report
  - [ ] Trigger download of CSV file
  - [ ] Show progress indicator during export
  - [ ] Handle export errors

- [ ] **Task 21: Update library service** (AC: 1, 6, 7, 10)
  - [ ] Add methods to `library.service.ts`:
    - getFileAccessReport(fileId: string, query: AccessReportQuery): Observable<AccessReportResponse>
    - getFileAccessStatistics(fileId: string): Observable<AccessStatistics>
    - getEntitiesWithoutDownload(fileId: string): Observable<Entity[]>
    - exportFileAccessReport(fileId: string, dateFrom?: Date, dateTo?: Date): Observable<Blob>
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 22: Implement sorting** (AC: 4)
  - [ ] Sortable table columns
  - [ ] Sort indicators (arrows)
  - [ ] Client-side or server-side sorting (server-side for large datasets)

- [ ] **Task 23: Add pagination** (AC: 9)
  - [ ] Pagination controls at bottom of report
  - [ ] Show: "Showing 1-50 of 500 downloads"
  - [ ] Page size selector (25, 50, 100)
  - [ ] Next/Previous/First/Last buttons

- [ ] **Task 24: Implement privacy indicators** (AC: 8)
  - [ ] Show disclaimer: "For internal analytics only. Respect user privacy."
  - [ ] Mask full IP addresses (show only first 3 octets: 192.168.1.xxx)
  - [ ] Option: Don't display IP addresses at all (configurable)

### Testing Tasks

- [ ] **Task 25: Unit tests for query handler** (AC: 1, 2, 3, 4, 5, 9)
  - [ ] Test loading file access report
  - [ ] Test filtering by date range
  - [ ] Test filtering by entity
  - [ ] Test filtering by user
  - [ ] Test sorting by different fields
  - [ ] Test pagination
  - [ ] Test total download count calculation

- [ ] **Task 26: Unit tests for statistics** (AC: 10)
  - [ ] Test statistics calculation (total, unique users, etc.)
  - [ ] Test downloads grouped by entity
  - [ ] Test downloads grouped by date
  - [ ] Test first and last download dates

- [ ] **Task 27: Unit tests for non-downloaders** (AC: 7)
  - [ ] Test identifying entities with permission but no download
  - [ ] Test excluding entities without permission
  - [ ] Test excluding entities that have downloaded

- [ ] **Task 28: Unit tests for export** (AC: 6)
  - [ ] Test CSV export generates valid CSV
  - [ ] Test export includes all downloads
  - [ ] Test export respects date filters

- [ ] **Task 29: Integration tests for API endpoints** (AC: 1, 6, 7, 9, 10)
  - [ ] Test GET /library/files/{id}/access-report returns report
  - [ ] Test GET /library/files/{id}/access-statistics returns statistics
  - [ ] Test GET /library/files/{id}/non-downloaders returns entities
  - [ ] Test export endpoint returns CSV file
  - [ ] Test all endpoints require UKNF Employee role (403 if not)
  - [ ] Test 404 for non-existent file
  - [ ] Test pagination and filtering work correctly

- [ ] **Task 30: Frontend unit tests** (AC: 1, 2, 3, 4, 9, 10)
  - [ ] Test access report component rendering
  - [ ] Test filters
  - [ ] Test sorting
  - [ ] Test pagination
  - [ ] Test statistics dashboard
  - [ ] Test non-downloader list
  - [ ] Test export button
  - [ ] Test service method calls

- [ ] **Task 31: E2E tests** (AC: 1-10)
  - [ ] Test viewing access report as UKNF Employee
  - [ ] Test filtering access report
  - [ ] Test sorting access report
  - [ ] Test pagination
  - [ ] Test viewing statistics
  - [ ] Test viewing non-downloader list
  - [ ] Test exporting report to CSV
  - [ ] Test external user cannot access (403)

### Documentation Tasks

- [ ] **Task 32: API documentation** (AC: 1, 6, 7, 10)
  - [ ] Document GET /library/files/{id}/access-report endpoint
  - [ ] Document GET /library/files/{id}/access-statistics endpoint
  - [ ] Document GET /library/files/{id}/non-downloaders endpoint
  - [ ] Document GET /library/files/{id}/access-report/export endpoint
  - [ ] Include query parameter documentation
  - [ ] Include response examples
  - [ ] Document authentication requirements

- [ ] **Task 33: Developer documentation** (AC: 2, 8, 10)
  - [ ] Document FileDownload schema
  - [ ] Document access tracking implementation
  - [ ] Document statistics calculation
  - [ ] Document privacy considerations

- [ ] **Task 34: User documentation** (AC: 1, 3, 6, 7, 8, 10)
  - [ ] Create user guide for viewing access reports
  - [ ] Explain how to identify non-downloaders
  - [ ] Document filtering and export
  - [ ] Explain privacy policy (internal use only)
  - [ ] Include screenshots

---

## Technical Notes

### Access Tracking

Tracking is implemented in Story 6.4 (Download File):
- Every download creates FileDownload record
- Records: FileId, UserId, DownloadDate, IP Address, User Agent
- Used for access reporting and analytics

### Privacy Considerations (AC: 8)

- Access reports are internal UKNF use only
- Not visible to external users
- IP addresses for security/audit (detect unusual patterns)
- Consider masking IP addresses in display (show 192.168.1.xxx)
- User agents for analytics (browser/device statistics)
- Don't share personally identifiable download data externally

### Statistics Calculations (AC: 10)

**Total Downloads**: COUNT(FileDownloads)

**Unique Users**: COUNT(DISTINCT UserId)

**Unique Entities**: COUNT(DISTINCT EntityId) via Users

**Downloads by Entity**:
```sql
SELECT e.Name, COUNT(d.Id) as DownloadCount
FROM FileDownloads d
JOIN Users u ON d.UserId = u.Id
JOIN Entities e ON u.EntityId = e.Id
WHERE d.FileId = @fileId
GROUP BY e.Name
ORDER BY DownloadCount DESC
```

**Downloads by Date**:
```sql
SELECT DATE(DownloadDate) as Date, COUNT(Id) as DownloadCount
FROM FileDownloads
WHERE FileId = @fileId
GROUP BY DATE(DownloadDate)
ORDER BY Date DESC
```

### Non-Downloader Identification (AC: 7)

To find entities that should download but haven't:
1. Get all entities with permission to file (via FilePermissions)
2. Get all entities that have downloaded file (via FileDownloads)
3. Subtract: Entities with permission - Entities that downloaded = Non-downloaders

Useful for mandatory files (e.g., "Q1 2025 Reporting Instructions"):
- UKNF can see which entities haven't downloaded
- Follow up with reminders or notifications

### Export Format (AC: 6)

CSV columns:
- Download Date (formatted: "2025-01-15 14:30:00")
- User Name ("Jan Kowalski")
- Entity ("ABC Bank")
- IP Address ("192.168.1.100")

Can be opened in Excel/Google Sheets for further analysis.

### Performance Considerations

- FileDownloads table can grow large (millions of records)
- Index: FileId, DownloadDate, UserId, EntityId
- Pagination essential for large reports
- Consider archiving old download records (> 2 years)
- Statistics queries should be optimized (aggregation)
- Cache statistics (calculate once per hour for frequently accessed files)

### Security Considerations

- Only UKNF Employees can view access reports
- Access reports reveal user behavior (sensitive)
- IP addresses stored for security audit
- Log who views access reports (audit the auditors)
- Don't expose API endpoints to external users

### UI/UX Considerations

- Access report useful for understanding engagement
- Statistics provide high-level overview (big numbers, charts)
- Non-downloader list actionable (follow up)
- Export enables offline analysis
- Sort and filter essential for large datasets
- Visualizations (charts) more insightful than raw numbers

---

## Dependencies

### Prerequisites
- **Story 6.4**: Download File from Library (download tracking implemented)
- **Epic 1**: Authentication (UKNF Employee role identification)
- **Epic 2**: Authorization (entity information)

### Integrates With
- **Story 6.5**: View File Details (access report link)
- **Story 6.13**: Notify Users (send reminders to non-downloaders)

---

## Acceptance Checklist

- [ ] UKNF Employee can access access report for files
- [ ] Report shows user name, entity, download timestamp, IP address
- [ ] Report can be filtered by date range, entity, user
- [ ] Report can be sorted by download date, user, entity
- [ ] Report shows total download count
- [ ] Employee can export access report to CSV
- [ ] Employee can identify entities that haven't downloaded
- [ ] Report respects user privacy (internal use only)
- [ ] Report supports pagination
- [ ] Employee can view aggregated statistics
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.4**: Download File from Library (download tracking)
- **Story 6.5**: View File Details (access report link)
- **Story 6.13**: Notify Users (follow up with non-downloaders)

---

## Notes

- Access monitoring provides valuable engagement insights
- Helps UKNF ensure critical files are accessed
- Non-downloader list enables proactive follow-up
- Export enables deeper analysis (pivot tables, charts)
- Privacy important - internal use only, not visible to external users
- Statistics more useful than raw download list (big picture)
- Test with files having many downloads (1000+)
- Consider heatmap visualization (downloads by entity and date)
- Monitor query performance - FileDownloads table can be large
- Consider alerts for unusual patterns (spike in downloads, unexpected IP)

