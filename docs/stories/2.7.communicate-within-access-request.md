# Story 2.7: Communicate Within Access Request

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.7  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As a** UKNF Employee or Entity Administrator reviewing an access request,  
**I want to** communicate with the requesting user via messages,  
**So that** I can request clarifications or additional information.

---

## Acceptance Criteria

1. Reviewer can create messages within the access request context
2. Messages support text content and file attachments
3. User receives email notification of new messages
4. User can respond with messages and attachments
5. All messages are stored with the access request
6. Message thread is visible to all parties (user and reviewers)
7. Messages include timestamp and sender information

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Use existing Message entity** (AC: 1, 2, 5, 7)
  - [ ] Message entity from section-4-data-models.md
  - [ ] Properties: Id, Subject, Body, SenderId, ContextType, ContextId, SentDate
  - [ ] Set ContextType = "AccessRequest", ContextId = AccessRequestId
  - [ ] Support MessageAttachments

- [ ] **Task 2: Create SendAccessRequestMessageCommand** (AC: 1, 2, 3)
  - [ ] Create `SendAccessRequestMessageCommand.cs`
  - [ ] Properties: AccessRequestId, Body, Attachments
  - [ ] Create handler
  - [ ] Logic:
    - Create message with ContextType = AccessRequest
    - Save attachments to storage
    - Send email notification to other party
    - Return success

- [ ] **Task 3: Create GetAccessRequestMessagesQuery** (AC: 5, 6, 7)
  - [ ] Create query to get messages for access request
  - [ ] Filter by ContextType = AccessRequest and ContextId = AccessRequestId
  - [ ] Order by SentDate
  - [ ] Include sender information and attachments

- [ ] **Task 4: Create REST API endpoints** (AC: 1, 4)
  - [ ] POST `/api/access-requests/{id}/messages`
  - [ ] GET `/api/access-requests/{id}/messages`
  - [ ] Authorization: Request owner or reviewer

### Frontend Tasks

- [ ] **Task 5: Create message thread component** (AC: 6, 7)
  - [ ] Display messages in chronological order
  - [ ] Show sender name, timestamp
  - [ ] Show attachments with download links
  - [ ] Distinguish between user and reviewer messages (different styling)

- [ ] **Task 6: Create message compose form** (AC: 1, 2, 4)
  - [ ] Text area for message body
  - [ ] File upload for attachments
  - [ ] Send button
  - [ ] Clear after successful send

- [ ] **Task 7: Integrate into access request details page** (AC: All)
  - [ ] Add "Messages" card to details page
  - [ ] Show message thread
  - [ ] Show compose form at bottom
  - [ ] Real-time update (optional: SignalR)

### Testing Tasks

- [ ] **Task 8: Write tests**
  - [ ] Test: `SendMessage_ValidRequest_SendsAndNotifies`
  - [ ] Test: `GetMessages_ReturnsThreadInOrder`
  - [ ] Test: `SendMessage_IncludesAttachments`

---

## Dev Notes

Reuses existing Message infrastructure from communication module. ContextType differentiates access request messages from case messages.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

