# Story 8.8: Periodic Entity Data Verification Prompts

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.8  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As an** External User,  
**I want to** be periodically prompted to verify my entity's data is current,  
**So that** UKNF maintains accurate information.

---

## Acceptance Criteria

1. System periodically prompts external users to verify entity data (configurable frequency, e.g., every 6 months)
2. Prompt appears during user login or prominently on dashboard
3. Prompt displays: "Please verify your entity information is current"
4. User can:
   - **Confirm**: Data is current and accurate (confirmation recorded with timestamp and user ID)
   - **Report Change**: Opens report change workflow (Story 8.5)
   - **Remind Later**: Dismiss prompt, will reappear next login
5. Confirmation is logged in entity change history
6. UKNF Employees can view which entities have/haven't verified data recently
7. System can send reminder emails if entity hasn't verified after X days past due date
8. System Administrator can configure verification frequency and reminder settings

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create EntityVerification entity** (AC: 1, 4, 5)
  - [ ] Create `EntityVerification.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - EntityId (long)
    - VerifiedBy (Guid) - user ID
    - VerificationDate (DateTime)
    - NextVerificationDue (DateTime)
    - Status (enum: Pending, Confirmed, Overdue)
    - DismissedUntil (DateTime?, nullable) - for "Remind Later"

- [ ] **Task 2: Create ConfirmEntityDataCommand** (AC: 4, 5)
  - [ ] Create `ConfirmEntityDataCommand.cs` in `Application/UknfPlatform.Application.Communication/Entities/Commands/`
  - [ ] Command properties: EntityId
  - [ ] Create `ConfirmEntityDataCommandHandler.cs`
  - [ ] Inject IEntityVerificationRepository, IEntityChangeHistoryRepository, ICurrentUserService
  - [ ] Handler logic:
    - Create EntityVerification record
    - Set VerificationDate = now
    - Calculate NextVerificationDue based on configuration
    - Add entry to EntityChangeHistory (ChangeSource: ExternalVerification)
    - Log confirmation event
    - Return confirmation message

- [ ] **Task 3: Create DismissVerificationPromptCommand** (AC: 4)
  - [ ] Create `DismissVerificationPromptCommand.cs`
  - [ ] Command properties: EntityId, DismissUntil (DateTime)
  - [ ] Handler updates DismissedUntil field
  - [ ] Prompt won't show until after DismissUntil date

- [ ] **Task 4: Create GetVerificationStatusQuery** (AC: 2, 6)
  - [ ] Create `GetVerificationStatusQuery.cs`
  - [ ] Query parameters: EntityId (optional, for specific entity)
  - [ ] Return VerificationStatusDto with:
    - NeedsVerification (bool)
    - LastVerificationDate (DateTime?)
    - NextVerificationDue (DateTime?)
    - DaysOverdue (int)
    - IsDismissed (bool)

- [ ] **Task 5: Create GetEntitiesVerificationReportQuery** (AC: 6)
  - [ ] Create `GetEntitiesVerificationReportQuery.cs` (UKNF Employees only)
  - [ ] Return list of all entities with verification status
  - [ ] Filter: All, Verified, Pending, Overdue
  - [ ] Support pagination and sorting

- [ ] **Task 6: Create verification reminder job** (AC: 7)
  - [ ] Create `EntityVerificationReminderJob.cs`
  - [ ] Use Hangfire for scheduling (daily check)
  - [ ] Find entities with verification overdue
  - [ ] Send reminder emails to Entity Administrators
  - [ ] Log reminder emails sent
  - [ ] Escalate after multiple reminders (configurable)

- [ ] **Task 7: Create REST API endpoints** (AC: 2, 4, 6, 8)
  - [ ] GET /api/my-entity/verification-status (external users)
  - [ ] POST /api/my-entity/{id}/confirm-data (confirm verification)
  - [ ] POST /api/my-entity/{id}/dismiss-prompt (dismiss reminder)
  - [ ] GET /api/admin/entity-verifications (UKNF report)
  - [ ] PUT /api/admin/settings/entity-verification (configure settings)
  - [ ] Add authorization checks
  - [ ] Add Swagger documentation

- [ ] **Task 8: Create configuration settings** (AC: 8)
  - [ ] Add VerificationSettings to appsettings.json
  - [ ] Properties:
    - VerificationFrequencyMonths (int, default 6)
    - ReminderIntervalDays (int, default 14)
    - MaxReminders (int, default 3)
    - EscalateToSupervisor (bool)
  - [ ] Create UpdateVerificationSettingsCommand

- [ ] **Task 9: Create database migration**
  - [ ] Create EntityVerifications table
  - [ ] Add indexes on EntityId, VerificationDate, NextVerificationDue

### Frontend Tasks

- [ ] **Task 10: Create verification-prompt component** (AC: 2, 3, 4)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/shared/components/verification-prompt/verification-prompt.component.ts`
  - [ ] Modal or banner component
  - [ ] Display verification prompt message
  - [ ] Buttons: "Data is Correct", "Report Changes", "Remind Me Later"
  - [ ] Style with Tailwind CSS (prominent but not intrusive)

- [ ] **Task 11: Integrate prompt into dashboard** (AC: 2)
  - [ ] Check verification status on dashboard load
  - [ ] Display prompt if verification needed and not dismissed
  - [ ] Handle user actions:
    - Confirm: Call confirm API, close prompt
    - Report Change: Navigate to Story 8.5 flow
    - Dismiss: Call dismiss API, set dismiss period (1 week default)

- [ ] **Task 12: Create entity-verifications-report component** (AC: 6)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/entity-verifications-report/entity-verifications-report.component.ts`
  - [ ] Configure routing: `/admin/entity-verifications` (UKNF only)
  - [ ] Display table of entities with verification status
  - [ ] Columns: Entity Name, Last Verified, Next Due, Status (Verified/Pending/Overdue)
  - [ ] Filters: All, Verified, Pending, Overdue
  - [ ] Export to CSV

- [ ] **Task 13: Create verification settings page** (AC: 8)
  - [ ] Create admin settings page
  - [ ] Form to configure:
    - Verification frequency
    - Reminder interval
    - Max reminders
  - [ ] Save settings via API

### Testing Tasks

- [ ] **Task 14: Write unit tests**
  - [ ] Test: ConfirmEntityDataCommandHandler records verification
  - [ ] Test: NextVerificationDue is calculated correctly
  - [ ] Test: Dismiss sets DismissedUntil date
  - [ ] Test: Verification reminder job finds overdue entities

- [ ] **Task 15: Write integration tests**
  - [ ] Test: Verification status API returns correct status
  - [ ] Test: Confirm API records verification
  - [ ] Test: Dismiss API dismisses prompt
  - [ ] Test: UKNF report shows entity verification status

---

## Dev Notes

### Verification Frequency

Default: Every 6 months
Configurable by System Administrator

### Reminder Strategy

- **First Reminder**: When verification becomes due
- **Second Reminder**: 14 days after first reminder (configurable)
- **Third Reminder**: 14 days after second reminder
- **Escalation**: After 3 reminders, notify UKNF supervisor (optional)

### User Experience

- Prompt should be clear but not annoying
- "Remind Later" dismisses for 1 week by default
- Prompt reappears on next login after dismiss period
- Make "Data is Correct" action quick and easy (one click)
- "Report Changes" should open full change report flow (Story 8.5)

### Email Notifications

Use email service from Epic 1:
- Subject: "Action Required: Verify Entity Data"
- Body: Reminder to verify entity information
- Link to entity verification page
- Include entity name and last verification date

### UKNF Monitoring

UKNF Employees can view:
- List of entities with verification status
- Overdue verifications
- Entities that have never verified
- Export report for compliance

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

