# Story 4.4: Submit Report Correction

**Epic:** 4 - Reporting System  
**Story Number:** 4.4  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** Employee of a Supervised Entity,  
**I want to** submit a correction to a previously submitted report,  
**So that** I can fix errors identified during validation.

---

## Acceptance Criteria

1. User can select an existing report and choose "Submit Correction"
2. User can upload corrected XLSX file
3. System creates a new report entry linked to original report
4. Correction report goes through same validation process
5. System displays relationship between original and correction reports
6. Both original and correction are visible in report history
7. Report details view shows if a correction has been submitted
8. Original report maintains its status (not modified by correction)
9. User can submit multiple corrections if needed (each linked to original)
10. System logs correction submission with reference to original report

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create SubmitReportCorrectionCommand** (AC: 1, 2, 3, 9)
  - [ ] Create `SubmitReportCorrectionCommand.cs` in `Application/UknfPlatform.Application.Communication/Reports/Commands/`
  - [ ] Command properties:
    - OriginalReportId (Guid, required) - report being corrected
    - File (IFormFile, required) - corrected XLSX file
    - CorrectionNotes (string?, optional) - user notes explaining changes
  - [ ] Note: EntityId, ReportType, ReportingPeriod inherited from original report

- [ ] **Task 2: Create SubmitReportCorrectionCommandValidator** (AC: 2)
  - [ ] Create `SubmitReportCorrectionCommandValidator.cs` using FluentValidation
  - [ ] Validate OriginalReportId: NotEmpty
  - [ ] Validate File: NotNull, same validations as Story 4.1 (XLSX, max 100 MB, valid file content)
  - [ ] Validate CorrectionNotes: MaxLength(2000) if provided
  - [ ] Async validation: Original report exists
  - [ ] Async validation: User has permission to submit corrections for original report's entity
  - [ ] Async validation: Original report is in correctable state (ValidationErrors, ContestedByUKNF, or TechnicalError)

- [ ] **Task 3: Create SubmitReportCorrectionCommandHandler** (AC: 3, 4, 5, 8, 9, 10)
  - [ ] Create `SubmitReportCorrectionCommandHandler.cs` implementing `IRequestHandler<SubmitReportCorrectionCommand, SubmitReportCorrectionResponse>`
  - [ ] Inject dependencies: IReportRepository, IFileStorageService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Fetch original report
    - Verify user has permission for original report's entity
    - Verify original report can be corrected (status check)
    - Upload corrected file to blob storage
    - Create new Report entity:
      * Copy EntityId, ReportType, ReportingPeriod from original
      * Set IsCorrectionOfReportId = OriginalReportId
      * Set status = "Working"
      * Set new FileName, FileStorageKey, FileSize
      * Set SubmittedDate = DateTime.UtcNow
      * Set UserId = current user (may differ from original submitter)
    - Save correction report to repository
    - Original report remains unchanged (AC 8)
    - Publish ReportValidationJob for correction (same as Story 4.1)
    - Update original report's metadata to indicate correction was submitted (optional)
    - Create audit log entry linking correction to original
    - Return SubmitReportCorrectionResponse with new report ID
  - [ ] Use transaction to ensure atomicity

- [ ] **Task 4: Create SubmitReportCorrectionResponse DTO** (AC: 3)
  - [ ] Create `SubmitReportCorrectionResponse.cs` record
  - [ ] Properties:
    - CorrectionReportId (Guid) - new report ID
    - OriginalReportId (Guid) - reference to original
    - Status (string) - "Working" initially
    - Message (string) - confirmation message
    - SubmittedDate (DateTime)
    - SubmitterName (string)

- [ ] **Task 5: Create REST API endpoint POST /api/reports/{id}/correction** (AC: 1, 2)
  - [ ] Update `ReportsController.cs`
  - [ ] Add `[Authorize]` attribute
  - [ ] Add authorization filter: `[RequiresPermission("communication.reports.submit")]`
  - [ ] Create POST action `SubmitCorrectionAsync(Guid id, [FromForm] SubmitReportCorrectionRequest request)`
  - [ ] Map request to SubmitReportCorrectionCommand (set OriginalReportId = id)
  - [ ] Send command via MediatR
  - [ ] Return 201 Created with SubmitReportCorrectionResponse and Location header pointing to new report
  - [ ] Return 400 Bad Request if file invalid or original report not correctable
  - [ ] Return 403 Forbidden if user lacks permission
  - [ ] Return 404 Not Found if original report doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations for file upload

- [ ] **Task 6: Update Report entity with correction methods** (AC: 3, 5)
  - [ ] Update Report.cs domain entity
  - [ ] Add domain factory method: `CreateCorrection(originalReport, userId, file, notes)`
  - [ ] Add query method: `GetCorrections()` - returns list of correction reports
  - [ ] Add query method: `HasCorrections()` - boolean
  - [ ] Add query method: `IsCorrectable()` - checks if status allows corrections
  - [ ] Validate correction chain (prevent correcting a correction - only original reports can be corrected)

- [ ] **Task 7: Add database query for corrections** (AC: 5, 6, 7)
  - [ ] Update IReportRepository interface
  - [ ] Add method: `GetCorrectionsByOriginalReportIdAsync(originalReportId): Task<List<Report>>`
  - [ ] Add method: `GetOriginalReportAsync(correctionReportId): Task<Report?>`
  - [ ] Add method: `HasCorrectionsAsync(reportId): Task<bool>`
  - [ ] Implement in ReportRepository using EF Core
  - [ ] Query example:
    ```csharp
    return await _context.Reports
        .Where(r => r.IsCorrectionOfReportId == originalReportId)
        .OrderBy(r => r.SubmittedDate)
        .ToListAsync();
    ```

- [ ] **Task 8: Update GetReportDetailsQueryHandler to include corrections** (AC: 5, 6, 7)
  - [ ] Update handler from Story 4.3
  - [ ] Fetch corrections using `GetCorrectionsByOriginalReportIdAsync`
  - [ ] Include correction reports in ReportDetailsResponse
  - [ ] For each correction, include: ID, FileName, SubmittedDate, ValidationStatus, SubmitterName
  - [ ] If current report is a correction, fetch and include original report summary

- [ ] **Task 9: Send notification to original submitter** (AC: 10)
  - [ ] After correction is submitted, check if current user != original submitter
  - [ ] If different users, send email notification to original submitter:
    - Subject: "Correction Submitted for Report [Report Name]"
    - Body: "A correction has been submitted for report [Original Report]. Submitted by: [Current User]. View details: [Link]"
  - [ ] Use IEmailService

- [ ] **Task 10: Create audit log entry** (AC: 10)
  - [ ] After correction submission, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = current user
    - EntityType = "Report"
    - EntityPrimaryKey = correction report ID
    - Action = "SubmitCorrection"
    - Timestamp = DateTime.UtcNow
    - AfterState = JSON snapshot of correction report
    - Metadata = JSON with OriginalReportId and CorrectionNotes
  - [ ] Log links correction to original for audit trail

- [ ] **Task 11: Validate correction chain depth (optional)** (AC: 9)
  - [ ] Optionally limit number of corrections per report (e.g., max 10)
  - [ ] In validator, check: `CountCorrectionsByOriginalReportIdAsync(originalReportId) < 10`
  - [ ] Return validation error if limit exceeded
  - [ ] Configurable limit in appsettings.json

- [ ] **Task 12: Prevent correcting a correction** (AC: 9)
  - [ ] In validator, check if OriginalReportId has IsCorrectionOfReportId != null
  - [ ] If true, return validation error: "You can only correct the original report, not a correction"
  - [ ] Enforce business rule: corrections always link to the root/original report

### Frontend Tasks

- [ ] **Task 13: Update reports service** (AC: 1, 2)
  - [ ] Update `reports.service.ts`
  - [ ] Method: `submitCorrection(originalReportId, file, notes?): Observable<SubmitReportCorrectionResponse>`
  - [ ] Use FormData for file upload
  - [ ] Call POST `/api/reports/{originalReportId}/correction`
  - [ ] Handle progress tracking for large files
  - [ ] Handle errors with catchError

- [ ] **Task 14: Add "Submit Correction" button to report details** (AC: 1)
  - [ ] Update report-details.component from Story 4.3
  - [ ] Add "Submit Correction" button
  - [ ] Show button only if:
    - User has permission to submit corrections
    - Report status is ValidationErrors, ContestedByUKNF, or TechnicalError
    - User represents the report's entity (or is admin)
  - [ ] Button navigates to `/reports/:id/correction`
  - [ ] Button style: Warning color (orange) to indicate corrective action

- [ ] **Task 15: Create submit correction component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/reporting/submit-correction/submit-correction.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/reports/:id/correction` with auth + permission guard
  - [ ] Inject ActivatedRoute to get original report ID from URL
  - [ ] Inject ReportsService
  - [ ] Load original report details on init
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - file (file upload, required)
    - correctionNotes (textarea, optional, max 2000 chars)

- [ ] **Task 16: Display original report information** (AC: 1, 3, 5)
  - [ ] Show "Submitting Correction For" section
  - [ ] Display original report details:
    - Original file name
    - Reporting period
    - Submission date
    - Current validation status
    - Validation errors (from Story 4.3)
  - [ ] Use read-only display (cards or panels)
  - [ ] Provide context to user about what they're correcting

- [ ] **Task 17: Implement file upload control** (AC: 2)
  - [ ] Use PrimeNG FileUpload or native input[type=file]
  - [ ] Accept only .xlsx files
  - [ ] Show file name, size after selection
  - [ ] Validate file type and size (same as Story 4.1)
  - [ ] Show error if invalid file selected
  - [ ] Display upload progress during submission

- [ ] **Task 18: Implement correction notes textarea** (AC: 2)
  - [ ] Optional textarea for user to explain changes
  - [ ] Placeholder: "Describe the corrections you've made (optional)"
  - [ ] Character counter: 0/2000
  - [ ] MaxLength validation

- [ ] **Task 19: Handle form submission** (AC: 3, 4)
  - [ ] On submit, create FormData object
  - [ ] Append file and correctionNotes
  - [ ] Call reportsService.submitCorrection()
  - [ ] Show loading spinner during upload
  - [ ] On success (201):
    - Display success message: "Correction submitted successfully!"
    - Message: "Your correction is being validated. Report ID: {newReportId}"
    - Navigate to correction report details page: `/reports/{newReportId}`
  - [ ] On error (400): Display validation errors
  - [ ] On error (403): Display permission error
  - [ ] On error (404): Display "Original report not found"
  - [ ] Use NotificationService for toast messages

- [ ] **Task 20: Show validation errors from original report** (AC: 2)
  - [ ] Display validation errors from original report prominently
  - [ ] Help user understand what needs to be fixed
  - [ ] Use same error display component from Story 4.3
  - [ ] Expandable/collapsible section with all errors

- [ ] **Task 21: Create page layout** (AC: 1, 2)
  - [ ] Page title: "Submit Correction"
  - [ ] Breadcrumb: Reports > [Original Report] > Submit Correction
  - [ ] Layout sections:
    - "Original Report" card (context)
    - "Validation Errors" card (what to fix)
    - "Upload Corrected File" card (upload control)
    - "Correction Notes" card (textarea)
    - Action buttons: "Submit Correction", "Cancel"
  - [ ] Info message: "The corrected file will go through the same validation process as the original."
  - [ ] Use PrimeNG Card, Message components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 22: Display corrections list in original report details** (AC: 5, 6, 7)
  - [ ] Update report-details.component from Story 4.3
  - [ ] Add "Corrections" section
  - [ ] Display list of all corrections submitted for this report
  - [ ] For each correction:
    - Correction number (e.g., "Correction #1")
    - File name
    - Submitted by (user name)
    - Submission date
    - Validation status
    - Link to correction report details
  - [ ] Use PrimeNG DataView or Timeline
  - [ ] Show if no corrections: "No corrections have been submitted yet"
  - [ ] Sort by submission date (newest first)

- [ ] **Task 23: Display "This is a correction" banner** (AC: 5, 7)
  - [ ] If current report is a correction (IsCorrectionOf != null):
    - Show banner at top: "This is a correction of report: [Original Report Link]"
    - Link to original report details
    - Show correction notes (if provided)
    - Show submitter and submission date
  - [ ] Use PrimeNG Message component with severity "info"
  - [ ] Make banner prominent but not alarming

- [ ] **Task 24: Add navigation between original and corrections** (AC: 5, 6)
  - [ ] From original report → Navigate to any correction
  - [ ] From correction → Navigate back to original
  - [ ] Breadcrumb should show correction chain
  - [ ] Example: Reports > Original Report > Correction #2

### Testing Tasks

- [ ] **Task 25: Write unit tests for SubmitReportCorrectionCommandHandler**
  - [ ] Test: `Handle_ValidCorrection_CreatesNewReport`
  - [ ] Test: `Handle_OriginalReportNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_OriginalReportNotCorrectable_ThrowsBadRequestException`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_OriginalReportUnchanged`
  - [ ] Test: `Handle_LinksToOriginalReport`
  - [ ] Test: `Handle_PublishesValidationJob`
  - [ ] Test: `Handle_CreatesAuditLog`
  - [ ] Mock: IReportRepository, IFileStorageService, IPermissionService

- [ ] **Task 26: Write unit tests for SubmitReportCorrectionCommandValidator**
  - [ ] Test: Valid correction with XLSX file
  - [ ] Test: Non-XLSX file rejected
  - [ ] Test: Original report not found rejected
  - [ ] Test: Original report status "Successful" not correctable
  - [ ] Test: Original report status "ValidationErrors" correctable
  - [ ] Test: Correcting a correction rejected
  - [ ] Test: Correction notes exceeding 2000 chars rejected

- [ ] **Task 27: Write unit tests for Report domain methods**
  - [ ] Test: `CreateCorrection_ValidData_ReturnsCorrection`
  - [ ] Test: `IsCorrectable_ValidationErrors_ReturnsTrue`
  - [ ] Test: `IsCorrectable_Successful_ReturnsFalse`
  - [ ] Test: `GetCorrections_MultipleCorrections_ReturnsAll`

- [ ] **Task 28: Write integration test for submit correction endpoint**
  - [ ] Test: `POST_SubmitCorrection_ValidFile_Returns201AndCreatesCorrection`
  - [ ] Test: `POST_SubmitCorrection_LinksToOriginal`
  - [ ] Test: `POST_SubmitCorrection_OriginalUnchanged`
  - [ ] Test: `POST_SubmitCorrection_PublishesValidationJob`
  - [ ] Test: `POST_SubmitCorrection_NonCorrectableReport_Returns400`
  - [ ] Test: `POST_SubmitCorrection_UserLacksPermission_Returns403`
  - [ ] Use Testcontainers for database
  - [ ] Verify correction report created with IsCorrectionOfReportId set
  - [ ] Verify original report unchanged
  - [ ] Verify audit log created
  - [ ] Verify validation job published

- [ ] **Task 29: Write integration test for corrections retrieval**
  - [ ] Test: `GET_ReportDetails_IncludesCorrections`
  - [ ] Setup: Create original report + 2 corrections
  - [ ] Verify: Original report details includes both corrections
  - [ ] Verify: Each correction links back to original

- [ ] **Task 30: Write E2E test for correction submission flow**
  - [ ] Test workflow:
    1. Login as external user
    2. Submit report (Q2 test file - fails validation)
    3. Wait for validation to complete with errors
    4. Navigate to report details
    5. Verify "Submit Correction" button visible
    6. Click "Submit Correction"
    7. Verify original report errors displayed
    8. Upload corrected file (Q1 test file - passes)
    9. Enter correction notes
    10. Submit correction
    11. Verify success message
    12. Verify redirected to correction report details
    13. Verify correction linked to original
    14. Navigate back to original report
    15. Verify correction appears in corrections list
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.1:**
- Report submission workflow
- File upload and validation
- Report entity creation

**From Story 4.2:**
- Validation process
- Status lifecycle
- ReportValidationJob

**From Story 4.3:**
- Report details display
- Validation errors display
- File downloads

**Key Integration:**
- This story enables users to fix validation errors
- Corrections go through same validation as originals
- Correction chain tracked via IsCorrectionOfReportId
- Original report remains unchanged (immutable)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG (FileUpload, Card, Message, DataView)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── ReportsController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Reports/
│   ├── Commands/
│   │   ├── SubmitReportCorrectionCommand.cs (CREATE)
│   │   ├── SubmitReportCorrectionCommandHandler.cs (CREATE)
│   │   └── SubmitReportCorrectionCommandValidator.cs (CREATE)
│   ├── DTOs/
│   │   └── SubmitReportCorrectionResponse.cs (CREATE)
│   └── Queries/
│       └── GetReportDetailsQueryHandler.cs (UPDATE)
├── Domain/UknfPlatform.Domain.Communication/Entities/
│   └── Report.cs (UPDATE - add correction methods)
└── Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/
    └── ReportRepository.cs (UPDATE - add correction queries)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
├── features/reporting/
│   ├── submit-correction/
│   │   ├── submit-correction.component.ts (CREATE)
│   │   ├── submit-correction.component.html (CREATE)
│   │   └── submit-correction.component.scss (CREATE)
│   └── report-details/
│       ├── report-details.component.ts (UPDATE)
│       ├── report-details.component.html (UPDATE)
│       └── components/
│           └── corrections-list.component.ts (CREATE)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Report Entity:**
- IsCorrectionOfReportId (Guid?, nullable) - links correction to original
- All other fields same as original report
- Correction reports are full Report entities, not a separate table

**Correction Chain:**
```
Original Report (ID: A)
  IsCorrectionOfReportId: NULL
  ↓
Correction #1 (ID: B)
  IsCorrectionOfReportId: A
  ↓
Correction #2 (ID: C)
  IsCorrectionOfReportId: A (always links to original, not to B)
```

**Business Rule:** Corrections always link to the original report, never to another correction. This creates a flat list of corrections rather than a nested tree.

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** POST `/api/reports/{id}/correction`
- **Security:** Requires authentication + "communication.reports.submit" permission
- **Request:** `multipart/form-data`
  - `file` (binary, required, XLSX only, max 100 MB)
  - `correctionNotes` (string, optional, max 2000 chars)
- **Success Response (201 Created):**
  ```json
  {
    "correctionReportId": "7fa85f64-5717-4562-b3fc-2c963f66afa6",
    "originalReportId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "status": "Working",
    "message": "Correction submitted successfully and queued for validation",
    "submittedDate": "2025-10-04T11:00:00Z",
    "submitterName": "Jan Kowalski"
  }
  ```
  Headers:
  ```
  Location: /api/reports/7fa85f64-5717-4562-b3fc-2c963f66afa6
  ```
- **Error Responses:**
  - 400: Bad Request (invalid file, original not correctable)
  - 403: Forbidden (no permission)
  - 404: Not Found (original report doesn't exist)

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Immutability of original report**
   ```csharp
   // ✅ CORRECT - Original report never modified
   var originalReport = await _reportRepository.GetByIdAsync(command.OriginalReportId);
   var correctionReport = Report.CreateCorrection(originalReport, command.File, userId);
   await _reportRepository.AddAsync(correctionReport);
   // Original report NOT saved/updated
   
   // ❌ WRONG - Don't modify original
   // originalReport.Status = "Corrected"; // NO!
   ```

2. **Flat correction chain**
   ```csharp
   // ✅ CORRECT - Always link to original
   if (originalReport.IsCorrectionOfReportId.HasValue)
   {
       throw new ValidationException("You can only correct the original report, not a correction");
   }
   
   correctionReport.IsCorrectionOfReportId = originalReport.Id; // Link to original
   ```

3. **Same validation as original**
   ```csharp
   // ✅ CORRECT - Correction goes through full validation
   var correctionReport = Report.CreateCorrection(...);
   await _reportRepository.AddAsync(correctionReport);
   await _messageBus.PublishAsync(new ReportValidationJob(correctionReport.Id, ...));
   // Validation will update correction's status independently
   ```

4. **Audit trail for corrections**
   ```csharp
   // ✅ CORRECT - Log with link to original
   await _auditService.LogAsync(new AuditLog
   {
       Action = "SubmitCorrection",
       EntityType = "Report",
       EntityPrimaryKey = correctionReport.Id,
       Metadata = new { OriginalReportId = originalReport.Id, CorrectionNotes = notes }
   });
   ```

5. **Permission check inheritance**
   ```csharp
   // ✅ CORRECT - Use original report's entity for permission check
   if (!await _permissionService.HasPermissionAsync(userId, "communication.reports.submit", originalReport.EntityId))
       throw new ForbiddenException();
   ```

### Business Rules

**Source:** `docs/prd/epic-4-reporting-system.md`

1. **Correctable Statuses:**
   - ValidationErrors - report has validation errors
   - ContestedByUKNF - report challenged by UKNF
   - TechnicalError - optional, allow retry if technical issue
   - NOT correctable: Successful, Working, Transmitted, Ongoing, TimeoutError

2. **Correction Metadata:**
   - Same EntityId, ReportType, ReportingPeriod as original
   - New FileName, FileStorageKey, FileSize from corrected file
   - New SubmittedDate (when correction submitted)
   - UserId may differ from original (e.g., different team member submits correction)

3. **Multiple Corrections:**
   - User can submit multiple corrections for same report
   - Each correction is validated independently
   - Latest successful correction becomes the "accepted" report
   - All corrections remain in history for audit

4. **Original Report Status:**
   - Original report status never changes when correction submitted
   - Original validation result remains available
   - Original file remains accessible

### UI/UX Considerations

**Correction Button Visibility:**
```typescript
showSubmitCorrectionButton(): boolean {
  return this.report.canSubmitCorrection && 
         (this.report.validationStatus === 'ValidationErrors' ||
          this.report.validationStatus === 'ContestedByUKNF' ||
          this.report.validationStatus === 'TechnicalError');
}
```

**Correction Context Display:**
- Prominently show validation errors from original
- Display UKNF's contest description if applicable
- Provide clear guidance on what needs to be fixed
- Show example/template if available

**Correction History Display:**
```html
<div *ngIf="report.corrections.length > 0" class="corrections-section">
  <h3>Corrections Submitted</h3>
  <p-timeline [value]="report.corrections">
    <ng-template pTemplate="content" let-correction>
      <div class="correction-item">
        <strong>Correction #{{ correction.number }}</strong>
        <p>File: {{ correction.fileName }}</p>
        <p>Submitted by: {{ correction.submitterName }}</p>
        <p>Date: {{ correction.submittedDate | date }}</p>
        <p-tag [value]="correction.validationStatus" [severity]="getStatusSeverity(correction.validationStatus)"></p-tag>
        <a [routerLink]="['/reports', correction.id]">View Details</a>
      </div>
    </ng-template>
  </p-timeline>
</div>
```

### Security Requirements

- Only users with "communication.reports.submit" permission can submit corrections
- User must have permission for original report's entity
- Cannot correct reports from other entities
- All correction submissions logged for audit
- Original report and all corrections remain accessible (no deletion)

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Loading corrections should not significantly slow report details page
- Use eager loading for correction metadata (avoid N+1 queries)
- Correction submission has same performance profile as original submission
- Limit correction list to prevent UI slowdown (paginate if > 20 corrections)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions

**Example:**
```csharp
[Fact]
public async Task Handle_ValidCorrection_CreatesNewReportLinkedToOriginal()
{
    // Arrange
    var originalReport = CreateTestReport(ValidationStatus.ValidationErrors);
    await _context.Reports.AddAsync(originalReport);
    await _context.SaveChangesAsync();
    
    var command = new SubmitReportCorrectionCommand
    {
        OriginalReportId = originalReport.Id,
        File = CreateMockXlsxFile("corrected-report.xlsx"),
        CorrectionNotes = "Fixed column B totals"
    };
    
    _fileStorageServiceMock
        .Setup(s => s.UploadFileAsync(It.IsAny<Stream>(), It.IsAny<string>(), It.IsAny<string>()))
        .ReturnsAsync("corrections/2025/correction-id.xlsx");
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    result.CorrectionReportId.Should().NotBeEmpty();
    result.OriginalReportId.Should().Be(originalReport.Id);
    
    var correctionReport = await _context.Reports.FindAsync(result.CorrectionReportId);
    correctionReport.Should().NotBeNull();
    correctionReport.IsCorrectionOfReportId.Should().Be(originalReport.Id);
    correctionReport.EntityId.Should().Be(originalReport.EntityId);
    correctionReport.ReportType.Should().Be(originalReport.ReportType);
    correctionReport.ReportingPeriod.Should().Be(originalReport.ReportingPeriod);
    correctionReport.ValidationStatus.Should().Be(ValidationStatus.Working);
    
    // Original unchanged
    var unchangedOriginal = await _context.Reports.FindAsync(originalReport.Id);
    unchangedOriginal.ValidationStatus.Should().Be(ValidationStatus.ValidationErrors);
    
    _messageBusMock.Verify(m => m.PublishAsync(
        It.Is<ReportValidationJob>(job => job.ReportId == correctionReport.Id)),
        Times.Once);
}
```

### Additional Notes

1. **Correction vs. New Report:** A correction is technically a new report with full lifecycle, but semantically it's tied to the original. This design allows corrections to be validated, corrected again, etc.

2. **Correction Numbering:** Display corrections as "Correction #1", "Correction #2" in UI based on submission order.

3. **Successful Correction:** When a correction passes validation, users typically reference the correction report, but original report remains for audit/history.

4. **Notification Strategy:** If correction submitted by different user than original submitter, notify original submitter. This prevents confusion if multiple team members working on same report.

5. **Correction Metadata:** CorrectionNotes field helps audit trail - user can explain "Fixed totals in worksheet B" or "Updated Q1 revenue figures".

6. **Version Control:** This is essentially version control for reports. Each correction is a new version. Consider adding version number in UI (Original, v2, v3...).

7. **Bulk Operations:** Future enhancement could allow submitting corrections for multiple reports at once (if same error across many reports).

8. **Correction Templates:** Consider providing "Download Original with Errors Marked" feature - annotate original file with error locations before user downloads it for correction.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

