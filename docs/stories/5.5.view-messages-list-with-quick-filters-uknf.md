# Story 5.5: View Messages List with Quick Filters (UKNF)

**Epic:** 5 - Messaging & Cases  
**Story Number:** 5.5  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee,  
**I want to** view and filter messages across all entities,  
**So that** I can efficiently manage communications.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-5-messaging-cases.md` - Story 5.5

1. UKNF Employee can view list of all messages
2. Quick filter "My Entities" shows messages related to entities assigned to employee
3. Quick filter "Requires UKNF responses" shows messages with status "Awaits UKNF's response"
4. Employee can filter by: Component (access request, case, report, standalone), Status, Entity, Date range
5. Employee can search by sender name, entity name, or message content
6. List displays: Entity, Sender, Subject/Preview, Date, Status, Component
7. Employee can sort by any column
8. Employee can export message list (CSV)
9. List supports pagination

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetAllMessagesQuery (UKNF-specific)** (AC: 1, 2, 3, 4, 5, 9)
  - [ ] Create `GetAllMessagesQuery.cs` in `Application/UknfPlatform.Application.Communication/Messages/Queries/`
  - [ ] Query properties (from AC 2, 3, 4, 5, 9):
    - UserId (Guid) - current UKNF employee (set by handler)
    - MyEntitiesOnly (bool, default: false) - AC 2: quick filter for "My Entities"
    - RequiresUknfResponse (bool, default: false) - AC 3: quick filter for "Requires UKNF responses"
    - ComponentFilter (ContextType?, optional) - AC 4: Standalone, AccessRequest, Report, Case
    - StatusFilter (MessageStatus?, optional) - AC 4
    - EntityFilter (long?, optional) - AC 4: filter by specific entity
    - DateFrom (DateTime?, optional) - AC 4
    - DateTo (DateTime?, optional) - AC 4
    - SearchTerm (string?, optional) - AC 5: search in sender name, entity name, message content
    - SortBy (string, default: "SentDate") - AC 7: any column
    - SortDirection (string, default: "DESC")
    - PageNumber (int, default: 1) - AC 9
    - PageSize (int, default: 20) - AC 9

- [ ] **Task 2: Create GetAllMessagesQueryHandler** (AC: All)
  - [ ] Create `GetAllMessagesQueryHandler.cs` implementing `IRequestHandler<GetAllMessagesQuery, GetAllMessagesResponse>`
  - [ ] Inject: IMessageRepository, ICurrentUserService, IUserEntityRepository, ILogger
  - [ ] Handler logic:
    1. Get current user ID
    2. Verify user is UKNF employee (UserType = Internal)
    3. Build query:
       - Base: All messages in system (AC 1) OR
       - If MyEntitiesOnly = true: Filter to messages for entities assigned to employee (AC 2)
       - If RequiresUknfResponse = true: Filter to status "AwaitingUknfResponse" (AC 3)
    4. Apply filters (AC 4):
       - Component (ContextType) filter
       - Status filter
       - Entity filter
       - Date range filter
    5. Apply search (AC 5):
       - Search in: Message subject, body, sender first name, sender last name, entity name
       - Case-insensitive
    6. Apply sorting (AC 7):
       - Support sorting by any column: Entity, Sender, Subject, Date, Status, Component
    7. Apply pagination (AC 9)
    8. Map to DTOs including Entity column (AC 6)
    9. Return GetAllMessagesResponse

- [ ] **Task 3: Determine "My Entities" for UKNF employee** (AC: 2)
  - [ ] Query UserEntity or PermissionLine to get entities assigned to employee
  - [ ] Alternative: Use entity assignment logic from access management
  - [ ] Filter messages where EntityId IN (assigned entity IDs)

- [ ] **Task 4: Create GetAllMessagesResponse DTO** (AC: 6, 9)
  - [ ] Create `GetAllMessagesResponse.cs` record
  - [ ] Properties:
    - Messages (List<MessageSummaryUknfDto>) - AC 6
    - TotalCount (int)
    - PageNumber (int)
    - PageSize (int)
    - TotalPages (int)

- [ ] **Task 5: Create MessageSummaryUknfDto** (AC: 6)
  - [ ] Create `MessageSummaryUknfDto.cs` record
  - [ ] Properties (from AC 6):
    - MessageId (Guid)
    - EntityId (long?) - AC 6: Entity column
    - EntityName (string?) - AC 6: Entity name
    - EntityUknfCode (string?) - for display
    - SenderName (string) - AC 6: Sender
    - SenderEmail (string)
    - Subject (string) - AC 6: Subject/Preview
    - BodyPreview (string)
    - SentDate (DateTime) - AC 6: Date
    - MessageStatus (string) - AC 6: Status
    - ContextType (string?) - AC 6: Component (Access Request, Case, Report, Standalone)
    - ContextId (Guid?)
    - ContextDisplayName (string?)
    - IsRead (bool) - read status for current user (if recipient)
    - HasAttachments (bool)
    - AttachmentCount (int)

- [ ] **Task 6: Create ExportMessagesQuery** (AC: 8)
  - [ ] Create `ExportMessagesQuery.cs`
  - [ ] Query properties: Same filters as GetAllMessagesQuery
  - [ ] No pagination (export all filtered results)

- [ ] **Task 7: Create ExportMessagesQueryHandler** (AC: 8)
  - [ ] Create `ExportMessagesQueryHandler.cs`
  - [ ] Handler logic:
    1. Apply same filters as GetAllMessagesQuery
    2. Fetch all matching messages (no pagination)
    3. Generate CSV file
    4. Columns (AC 6): Entity, Sender, Subject, Date, Status, Component
    5. Return file as byte array

- [ ] **Task 8: Create REST API endpoint GET /api/messages/all** (AC: 1, 2, 3, 4, 5, 7, 9)
  - [ ] Update `MessagesController.cs`
  - [ ] Add `[Authorize]` attribute + UKNF employee check
  - [ ] Create GET action `GetAllMessagesAsync([FromQuery] GetAllMessagesQuery query)`
  - [ ] Return 200 OK with GetAllMessagesResponse
  - [ ] Return 403 if user not UKNF employee
  - [ ] Support query parameters for all filters
  - [ ] Add Swagger annotations

- [ ] **Task 9: Create REST API endpoint GET /api/messages/export** (AC: 8)
  - [ ] Add `[Authorize]` attribute + UKNF employee check
  - [ ] Create GET action `ExportMessagesAsync([FromQuery] ExportMessagesQuery query)`
  - [ ] Return File result with CSV
  - [ ] Set Content-Disposition header: "attachment; filename=messages-export-{date}.csv"
  - [ ] Return 403 if user not UKNF employee

### Frontend Tasks

- [ ] **Task 10: Update messages service** (AC: All)
  - [ ] Update `messages.service.ts`
  - [ ] Method: `getAllMessages(query): Observable<GetAllMessagesResponse>` - AC 1, 2, 3, 4, 5, 7, 9
  - [ ] Method: `exportMessages(query): Observable<Blob>` - AC 8

- [ ] **Task 11: Create UKNF messages list component** (AC: All)
  - [ ] Create `messages-list-uknf.component.ts` in `features/messaging/`
  - [ ] Route: `/admin/messages` or `/uknf/messages`
  - [ ] Inject MessagesService, AuthService (to verify UKNF role)
  - [ ] Load all messages on init (AC 1)
  - [ ] Display in PrimeNG Table

- [ ] **Task 12: Add quick filters** (AC: 2, 3)
  - [ ] Quick filter buttons above table:
    - "All Messages" (default, clears filters)
    - "My Entities" (AC 2) - filter to entities assigned to employee
    - "Requires UKNF Response" (AC 3) - filter to status "Awaits UKNF's response"
    - "Unread" - filter to unread messages
  - [ ] Buttons styled as chips or toggle buttons
  - [ ] Show active filter visually
  - [ ] Display count badges on buttons

- [ ] **Task 13: Display message list with Entity column** (AC: 6)
  - [ ] Use PrimeNG Table component
  - [ ] Columns (from AC 6):
    - Read indicator (icon)
    - **Entity** (name and UKNF code) - NEW column
    - Sender (name)
    - Subject/Preview (clickable)
    - Date (formatted)
    - Status (badge)
    - Component (Access Request / Case / Report / Standalone)
    - Attachments icon
  - [ ] Row styling: Unread messages bold/highlighted
  - [ ] Clickable rows to view details

- [ ] **Task 14: Implement advanced filters** (AC: 4)
  - [ ] Filter panel with controls (AC 4):
    - Component dropdown: All, Standalone, Access Request, Report, Case
    - Status dropdown: All, Awaits UKNF's response, Awaiting User's Response, Closed
    - Entity dropdown or autocomplete: All entities or search
    - Date range picker: From/To dates
  - [ ] "Apply Filters" button
  - [ ] "Clear Filters" button
  - [ ] Filters collapsible/expandable
  - [ ] Use PrimeNG Dropdown, Calendar, AutoComplete

- [ ] **Task 15: Implement search** (AC: 5)
  - [ ] Search input above table
  - [ ] Placeholder: "Search by sender, entity, or message content..."
  - [ ] Search on Enter or button click
  - [ ] Searches in (AC 5):
    - Sender name
    - Entity name
    - Message subject/body
  - [ ] Clear search button
  - [ ] Show active search term

- [ ] **Task 16: Implement sorting** (AC: 7)
  - [ ] Enable column sorting on table
  - [ ] Sortable columns (AC 7 - any column):
    - Entity
    - Sender
    - Subject
    - Date (default, descending)
    - Status
    - Component
  - [ ] Click column header to sort
  - [ ] Show sort indicator (arrow)
  - [ ] Use PrimeNG Table `sortField` and `sortOrder`

- [ ] **Task 17: Implement export to CSV** (AC: 8)
  - [ ] "Export to CSV" button in header
  - [ ] Icon: Download or file icon
  - [ ] On click:
    1. Call messagesService.exportMessages() with current filters
    2. Show loading indicator
    3. Download CSV file
    4. File name: "messages-export-{date}.csv"
  - [ ] Use FileSaver or native download
  - [ ] Show success message

- [ ] **Task 18: Implement pagination** (AC: 9)
  - [ ] Use PrimeNG Paginator component
  - [ ] Show total count: "Showing 1-20 of 500 messages"
  - [ ] Page size options: 10, 20, 50, 100
  - [ ] Navigate between pages
  - [ ] Preserve filters/sorting when paginating

- [ ] **Task 19: Create page layout** (AC: All)
  - [ ] Page title: "All Messages" or "Messages (UKNF View)"
  - [ ] Breadcrumb: Admin > Messages
  - [ ] Quick filter buttons (prominent) - AC 2, 3
  - [ ] Search bar
  - [ ] Advanced filter panel (collapsible)
  - [ ] Action buttons: "Compose Message", "Export to CSV"
  - [ ] Messages table with all columns
  - [ ] Paginator
  - [ ] Use PrimeNG Card, Button, Table, Paginator
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 20: Add navigation link for UKNF employees** (AC: 1)
  - [ ] Update main navigation
  - [ ] Add "All Messages" or "Manage Messages" link
  - [ ] Only visible to UKNF employees
  - [ ] Link to `/admin/messages` or `/uknf/messages`
  - [ ] Show unread count badge

### Testing Tasks

- [ ] **Task 21: Write unit tests for GetAllMessagesQueryHandler**
  - [ ] Test: `Handle_UknfEmployee_ReturnsAllMessages` (AC 1)
  - [ ] Test: `Handle_MyEntitiesFilter_ReturnsOnlyAssignedEntities` (AC 2)
  - [ ] Test: `Handle_RequiresUknfResponseFilter_FiltersCorrectly` (AC 3)
  - [ ] Test: `Handle_ComponentFilter_FiltersCorrectly` (AC 4)
  - [ ] Test: `Handle_EntityFilter_FiltersCorrectly` (AC 4)
  - [ ] Test: `Handle_SearchTerm_SearchesInSenderEntityAndContent` (AC 5)
  - [ ] Test: `Handle_SortByEntity_SortsCorrectly` (AC 7)
  - [ ] Test: `Handle_NonUknfEmployee_ThrowsUnauthorizedException`
  - [ ] Mock: IMessageRepository, IUserEntityRepository

- [ ] **Task 22: Write unit tests for ExportMessagesQueryHandler**
  - [ ] Test: `Handle_ValidQuery_GeneratesCsv` (AC 8)
  - [ ] Test: `Handle_IncludesAllColumns` (AC 6, 8)
  - [ ] Test: `Handle_AppliesFilters` (AC 4, 8)
  - [ ] Verify CSV format correct

- [ ] **Task 23: Write integration test for get all messages endpoint**
  - [ ] Test: `GET_AllMessages_UknfEmployee_Returns200` (AC 1)
  - [ ] Test: `GET_AllMessages_ExternalUser_Returns403`
  - [ ] Test: `GET_AllMessages_MyEntitiesFilter_ReturnsFilteredResults` (AC 2)
  - [ ] Test: `GET_AllMessages_RequiresUknfResponseFilter_ReturnsFilteredResults` (AC 3)
  - [ ] Test: `GET_AllMessages_WithSearch_ReturnsMatchingMessages` (AC 5)
  - [ ] Test: `GET_AllMessages_WithPagination_ReturnsCorrectPage` (AC 9)
  - [ ] Create test data: Multiple messages from different entities, different statuses

- [ ] **Task 24: Write integration test for export messages**
  - [ ] Test: `GET_ExportMessages_UknfEmployee_ReturnsCsvFile` (AC 8)
  - [ ] Test: `GET_ExportMessages_ExternalUser_Returns403`
  - [ ] Test: `GET_ExportMessages_AppliesFilters` (AC 4, 8)
  - [ ] Verify CSV file format
  - [ ] Verify all columns present (AC 6, 8)

- [ ] **Task 25: Write E2E test for UKNF messages view**
  - [ ] Test workflow:
    1. Login as UKNF employee
    2. Navigate to "All Messages" (AC 1)
    3. Verify all messages displayed (not just assigned to employee)
    4. Verify Entity column visible (AC 6)
    5. Click "My Entities" quick filter (AC 2)
    6. Verify filtered to assigned entities only
    7. Click "Requires UKNF Response" quick filter (AC 3)
    8. Verify filtered to awaiting messages
    9. Open advanced filters (AC 4)
    10. Select Component: "Case"
    11. Apply filter
    12. Verify only case-related messages shown
    13. Select Entity from dropdown (AC 4)
    14. Verify filtered to that entity
    15. Enter search term (AC 5)
    16. Verify search results correct
    17. Sort by Entity column (AC 7)
    18. Verify sorting works
    19. Click "Export to CSV" (AC 8)
    20. Verify CSV file downloads with correct data
    21. Navigate to page 2 (AC 9)
    22. Verify pagination works
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 5.2:**
- GetMessagesQuery for current user's messages
- Filters, search, sorting, pagination implemented
- This story extends for UKNF employees to see ALL messages

**Key Differences:**
- Story 5.2: User sees only their received messages
- Story 5.5: UKNF sees ALL messages system-wide
- Additional filters: Component, Entity
- Additional quick filter: "My Entities"
- Entity column in list

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- CSV Generation: CsvHelper

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Table, Paginator, Dropdown, Calendar, AutoComplete, Chip)
- Styling: Tailwind CSS

### Project Structure

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── MessagesController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Messages/
│   ├── Queries/
│   │   ├── GetAllMessagesQuery.cs (CREATE)
│   │   ├── GetAllMessagesQueryHandler.cs (CREATE)
│   │   ├── ExportMessagesQuery.cs (CREATE)
│   │   └── ExportMessagesQueryHandler.cs (CREATE)
│   └── DTOs/
│       ├── GetAllMessagesResponse.cs (CREATE)
│       └── MessageSummaryUknfDto.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── messages.service.ts (UPDATE)
└── features/admin/messages/
    ├── messages-list-uknf/
    │   ├── messages-list-uknf.component.ts (CREATE)
    │   ├── messages-list-uknf.component.html (CREATE)
    │   └── messages-list-uknf.component.scss (CREATE)
    └── components/
        ├── message-filters-uknf.component.ts (CREATE)
        └── quick-filters.component.ts (CREATE)
```

### REST API Specification

**Endpoint 1:** GET `/api/messages/all`
- **Security:** Requires authentication + UKNF employee role
- **Query Parameters:**
  - myEntitiesOnly (bool, default: false)
  - requiresUknfResponse (bool, default: false)
  - componentFilter (string?) - "Standalone", "AccessRequest", "Report", "Case"
  - statusFilter (string?)
  - entityFilter (long?)
  - dateFrom (DateTime?)
  - dateTo (DateTime?)
  - searchTerm (string?)
  - sortBy (string, default: "SentDate")
  - sortDirection (string, default: "DESC")
  - pageNumber (int, default: 1)
  - pageSize (int, default: 20)
- **Response (200 OK):**
  ```json
  {
    "messages": [
      {
        "messageId": "guid",
        "entityId": 1001,
        "entityName": "Example Bank S.A.",
        "entityUknfCode": "G. RIP100000",
        "senderName": "Jan Kowalski",
        "senderEmail": "jan.kowalski@example.com",
        "subject": "Question about Q1 Report",
        "bodyPreview": "I have a question...",
        "sentDate": "2025-10-04T10:00:00Z",
        "messageStatus": "Awaiting User's Response",
        "contextType": "Report",
        "contextId": "guid",
        "contextDisplayName": "Report Q1_2025",
        "isRead": true,
        "hasAttachments": true,
        "attachmentCount": 2
      }
    ],
    "totalCount": 500,
    "pageNumber": 1,
    "pageSize": 20,
    "totalPages": 25
  }
  ```
- **Error:** 403 Forbidden if not UKNF employee

**Endpoint 2:** GET `/api/messages/export`
- **Security:** Requires authentication + UKNF employee role
- **Query Parameters:** Same as GET /api/messages/all (except pagination)
- **Response:** CSV file
- **Headers:**
  - Content-Type: text/csv
  - Content-Disposition: attachment; filename=messages-export-2025-10-04.csv

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Query all messages for UKNF (AC 1)**
   ```csharp
   // ✅ CORRECT
   var currentUser = await _userRepository.GetByIdAsync(currentUserId);
   if (currentUser.UserType != UserType.Internal)
       throw new UnauthorizedException("Only UKNF employees can view all messages");
   
   var query = _context.Messages
       .Include(m => m.Sender)
       .Include(m => m.Entity)
       .Include(m => m.Recipients)
       .AsQueryable(); // All messages, not filtered by recipient
   ```

2. **Filter by "My Entities" (AC 2)**
   ```csharp
   // ✅ CORRECT
   if (queryModel.MyEntitiesOnly)
   {
       var assignedEntityIds = await _userEntityRepository
           .GetEntitiesForUserAsync(currentUserId)
           .Select(e => e.Id)
           .ToListAsync();
       
       query = query.Where(m => m.EntityId.HasValue && assignedEntityIds.Contains(m.EntityId.Value));
   }
   ```

3. **Quick filter "Requires UKNF responses" (AC 3)**
   ```csharp
   // ✅ CORRECT
   if (queryModel.RequiresUknfResponse)
   {
       query = query.Where(m => m.MessageStatus == MessageStatus.AwaitingUknfResponse);
   }
   ```

4. **Filter by Component/ContextType (AC 4)**
   ```csharp
   // ✅ CORRECT
   if (queryModel.ComponentFilter.HasValue)
   {
       query = query.Where(m => m.ContextType == queryModel.ComponentFilter.Value);
   }
   ```

5. **Filter by Entity (AC 4)**
   ```csharp
   // ✅ CORRECT
   if (queryModel.EntityFilter.HasValue)
   {
       query = query.Where(m => m.EntityId == queryModel.EntityFilter.Value);
   }
   ```

6. **Search by sender, entity, or content (AC 5)**
   ```csharp
   // ✅ CORRECT
   if (!string.IsNullOrWhiteSpace(queryModel.SearchTerm))
   {
       var searchLower = queryModel.SearchTerm.ToLower();
       query = query.Where(m => 
           m.Subject.ToLower().Contains(searchLower) ||
           m.Body.ToLower().Contains(searchLower) ||
           m.Sender.FirstName.ToLower().Contains(searchLower) ||
           m.Sender.LastName.ToLower().Contains(searchLower) ||
           (m.Entity != null && m.Entity.Name.ToLower().Contains(searchLower)));
   }
   ```

7. **Sort by any column (AC 7)**
   ```csharp
   // ✅ CORRECT
   query = queryModel.SortBy switch
   {
       "Entity" => queryModel.SortDirection == "ASC"
           ? query.OrderBy(m => m.Entity.Name)
           : query.OrderByDescending(m => m.Entity.Name),
       "Sender" => queryModel.SortDirection == "ASC"
           ? query.OrderBy(m => m.Sender.LastName)
           : query.OrderByDescending(m => m.Sender.LastName),
       "Status" => queryModel.SortDirection == "ASC"
           ? query.OrderBy(m => m.MessageStatus)
           : query.OrderByDescending(m => m.MessageStatus),
       "Component" => queryModel.SortDirection == "ASC"
           ? query.OrderBy(m => m.ContextType)
           : query.OrderByDescending(m => m.ContextType),
       _ => queryModel.SortDirection == "ASC"
           ? query.OrderBy(m => m.SentDate)
           : query.OrderByDescending(m => m.SentDate)
   };
   ```

8. **Generate CSV export (AC 8)**
   ```csharp
   // ✅ CORRECT
   using var writer = new StringWriter();
   using var csv = new CsvWriter(writer, CultureInfo.InvariantCulture);
   
   csv.WriteRecords(messages.Select(m => new
   {
       Entity = m.EntityName,
       Sender = m.SenderName,
       Subject = m.Subject,
       Date = m.SentDate,
       Status = m.MessageStatus,
       Component = m.ContextType
   }));
   
   return Encoding.UTF8.GetBytes(writer.ToString());
   ```

### UI/UX Considerations

**Quick Filter Chips:**
```html
<div class="quick-filters flex gap-2 mb-4">
  <p-chip 
    label="All Messages" 
    [styleClass]="activeFilter === 'all' ? 'bg-primary text-white' : ''"
    (click)="applyQuickFilter('all')">
  </p-chip>
  
  <p-chip 
    [label]="'My Entities (' + myEntitiesCount + ')'"
    [styleClass]="activeFilter === 'myEntities' ? 'bg-primary text-white' : ''"
    (click)="applyQuickFilter('myEntities')">
  </p-chip>
  
  <p-chip 
    [label]="'Requires UKNF Response (' + requiresResponseCount + ')'"
    [styleClass]="activeFilter === 'requiresResponse' ? 'bg-warning text-white' : ''"
    (click)="applyQuickFilter('requiresResponse')">
  </p-chip>
  
  <p-chip 
    [label]="'Unread (' + unreadCount + ')'"
    [styleClass]="activeFilter === 'unread' ? 'bg-info text-white' : ''"
    (click)="applyQuickFilter('unread')">
  </p-chip>
</div>
```

**Table with Entity Column:**
```html
<p-table [value]="messages" 
         [lazy]="true" 
         (onLazyLoad)="loadMessages($event)"
         [totalRecords]="totalCount"
         [paginator]="true"
         [rows]="pageSize"
         [sortField]="sortField"
         [sortOrder]="sortOrder">
  
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 30px"></th> <!-- Read indicator -->
      <th pSortableColumn="Entity">Entity <p-sortIcon field="Entity"></p-sortIcon></th>
      <th pSortableColumn="Sender">Sender <p-sortIcon field="Sender"></p-sortIcon></th>
      <th>Subject</th>
      <th pSortableColumn="SentDate">Date <p-sortIcon field="SentDate"></p-sortIcon></th>
      <th pSortableColumn="Status">Status <p-sortIcon field="Status"></p-sortIcon></th>
      <th pSortableColumn="Component">Component <p-sortIcon field="Component"></p-sortIcon></th>
      <th style="width: 50px"></th>
    </tr>
  </ng-template>
  
  <ng-template pTemplate="body" let-message>
    <tr (click)="viewMessage(message.messageId)" class="cursor-pointer">
      <td><i *ngIf="!message.isRead" class="pi pi-circle-fill text-primary text-xs"></i></td>
      <td>
        <div>{{ message.entityName }}</div>
        <div class="text-xs text-gray-600">{{ message.entityUknfCode }}</div>
      </td>
      <td>{{ message.senderName }}</td>
      <td>
        <div>{{ message.subject }}</div>
        <div class="text-sm text-gray-600">{{ message.bodyPreview }}</div>
      </td>
      <td>{{ message.sentDate | date:'short' }}</td>
      <td><p-tag [value]="message.messageStatus"></p-tag></td>
      <td>{{ message.contextType || 'Standalone' }}</td>
      <td><i *ngIf="message.hasAttachments" class="pi pi-paperclip"></i></td>
    </tr>
  </ng-template>
</p-table>
```

### Business Rules

**UKNF Message View Scope (AC 1):**
- UKNF employees see ALL messages in system
- Not limited to messages addressed to them
- Enables oversight and management of all communications

**"My Entities" Filter (AC 2):**
- Shows messages for entities assigned to UKNF employee
- Assignment determined by UserEntity or permission system
- Helps employees focus on their responsible entities

**Component Filter (AC 4):**
- Filter by message context: Standalone, Access Request, Report, Case
- Helps organize messages by workflow type

**Entity Filter (AC 4):**
- Filter to specific entity
- Useful when managing entity-specific issues

**Search Scope (AC 5):**
- Searches in sender name, entity name, message content
- Broader than user view (includes entity name)
- Enables finding messages by entity

### Security Requirements

- Only UKNF employees can access this view (AC 1)
- Verify UserType = Internal on backend
- 403 Forbidden for external users
- Export respects filters (no data leakage)

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Query all messages may be expensive with large datasets
- Database indexes critical:
  - Messages.EntityId
  - Messages.ContextType
  - Messages.MessageStatus
  - Messages.SentDate
  - Entity.Name (for search)
- Pagination essential for large result sets
- Export limited to reasonable number of records (e.g., max 10,000)
- Consider caching "My Entities" list (per user)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- UKNF employee can view all messages
- "My Entities" filter returns only assigned entities
- "Requires UKNF responses" filter works
- Component, status, entity filters work
- Search by sender, entity, content works
- Sorting by any column works
- Export generates correct CSV
- External user cannot access endpoint

**Example:**
```csharp
[Fact]
public async Task Handle_MyEntitiesFilter_ReturnsOnlyAssignedEntities()
{
    // Arrange - AC 2
    var uknfEmployee = CreateUknfEmployee();
    var entity1 = CreateTestEntity();
    var entity2 = CreateTestEntity();
    
    // Assign employee to entity1 only
    await _context.UserEntities.AddAsync(new UserEntity
    {
        UserId = uknfEmployee.Id,
        EntityId = entity1.Id
    });
    
    var message1 = CreateTestMessage(entity: entity1);
    var message2 = CreateTestMessage(entity: entity2);
    
    await _context.Messages.AddRangeAsync(message1, message2);
    await _context.SaveChangesAsync();
    
    _currentUserService.GetCurrentUserId().Returns(uknfEmployee.Id);
    
    var query = new GetAllMessagesQuery
    {
        MyEntitiesOnly = true,
        PageNumber = 1,
        PageSize = 20
    };
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.Messages.Should().HaveCount(1);
    result.Messages[0].EntityId.Should().Be(entity1.Id);
}
```

### Additional Notes

1. **Dual Message Views:** System now has two message views:
   - User view (Story 5.2): Only their received messages
   - UKNF view (Story 5.5): All messages system-wide

2. **Entity Column:** Critical for UKNF oversight. Shows which entity message relates to.

3. **Quick Filters:** Essential for efficiency. UKNF employees manage many messages.

4. **"My Entities":** Based on entity assignment. UKNF employees typically assigned to specific entities/sectors.

5. **Export Use Case:** For reporting, analysis, or forwarding to other departments.

6. **Component Filter:** Helps segregate operational vs. case vs. report messages.

7. **Sorting Flexibility:** "Any column" sortable = full data exploration capability.

8. **Navigation:** Separate route for UKNF view (/admin/messages) vs. user view (/messages).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 5, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

