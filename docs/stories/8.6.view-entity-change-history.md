# Story 8.6: View Entity Change History

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.6  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee, System Administrator, or External User,  
**I want to** view history of entity data changes,  
**So that** I can understand how entity information evolved over time.

---

## Acceptance Criteria

1. Users can access "Change History" from entity details page
2. History shows: Timestamp, Changed by (employee name or "External verification"), Field changed, Previous value, New value
3. History includes all entity field updates
4. History shows data updates from Entity Data Updater service (Story 8.7)
5. History is chronologically ordered (newest first)
6. History is read-only
7. UKNF Employees can view full history
8. External users can view history for their entity only
9. History can be exported (CSV or PDF)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetEntityChangeHistoryQuery** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `GetEntityChangeHistoryQuery.cs` in `Application/UknfPlatform.Application.Communication/Entities/Queries/`
  - [ ] Query parameters: EntityId, StartDate, EndDate, PageNumber, PageSize
  - [ ] Create `GetEntityChangeHistoryQueryHandler.cs`
  - [ ] Inject IEntityChangeHistoryRepository
  - [ ] Implement filtering by date range
  - [ ] Order by date descending (newest first)
  - [ ] Implement pagination
  - [ ] Return PagedResult<EntityChangeHistoryDto>

- [ ] **Task 2: Create EntityChangeHistoryDto** (AC: 2)
  - [ ] Create `EntityChangeHistoryDto.cs`
  - [ ] Properties:
    - Id (long)
    - Timestamp (DateTime)
    - ChangedBy (string) - employee name or "External verification" or "Entity Data Updater Service"
    - FieldName (string)
    - PreviousValue (string)
    - NewValue (string)
    - ChangeSource (string) - "Manual", "External Verification", "Entity Data Updater"

- [ ] **Task 3: Create ExportEntityChangeHistoryQuery** (AC: 9)
  - [ ] Create `ExportEntityChangeHistoryQuery.cs`
  - [ ] Query parameters: EntityId, Format (CSV or PDF)
  - [ ] Create `ExportEntityChangeHistoryQueryHandler.cs`
  - [ ] Generate CSV or PDF report
  - [ ] Return file stream

- [ ] **Task 4: Create REST API endpoints** (AC: 1, 7, 8, 9)
  - [ ] GET /api/entities/{id}/change-history
  - [ ] GET /api/entities/{id}/change-history/export?format=csv|pdf
  - [ ] Add authorization:
    - UKNF Employees can view any entity history
    - External users can view only their entity history
  - [ ] Return 200 with paginated history
  - [ ] Return 403 if unauthorized access
  - [ ] Add Swagger documentation

### Frontend Tasks

- [ ] **Task 5: Create entity-change-history component** (AC: 1, 2, 5, 6)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/entities/entity-change-history/entity-change-history.component.ts`
  - [ ] Display as tab in entity detail page
  - [ ] Show change history table
  - [ ] Columns: Timestamp, Changed By, Field, Previous Value, New Value
  - [ ] Implement pagination
  - [ ] Chronological order (newest first)
  - [ ] Read-only display

- [ ] **Task 6: Implement date range filter** (AC: 1)
  - [ ] Date range picker
  - [ ] Filter history by date range
  - [ ] Update table on filter change

- [ ] **Task 7: Add export functionality** (AC: 9)
  - [ ] Add "Export" button
  - [ ] Format selector: CSV or PDF
  - [ ] Download exported file
  - [ ] Show loading indicator during export

- [ ] **Task 8: Style change history** (AC: 2)
  - [ ] Highlight field changes
  - [ ] Use badges for change sources (Manual, External Verification, Entity Data Updater)
  - [ ] Responsive table
  - [ ] Tailwind CSS styling

### Testing Tasks

- [ ] **Task 9: Write unit tests**
  - [ ] Test: GetEntityChangeHistoryQuery returns paginated history
  - [ ] Test: History is ordered chronologically
  - [ ] Test: Date range filtering works
  - [ ] Test: External users can only view their entity history

- [ ] **Task 10: Write integration tests**
  - [ ] Test: GET /api/entities/:id/change-history returns history
  - [ ] Test: Export endpoint generates CSV/PDF
  - [ ] Test: Authorization checks work
  - [ ] Test: Pagination works correctly

---

## Dev Notes

### Data Model

EntityChangeHistory table (from Story 8.2):
- Id (long)
- EntityId (long)
- FieldName (string)
- PreviousValue (string)
- NewValue (string)
- ChangedBy (Guid, user ID)
- ChangedDate (DateTime)
- ChangeSource (enum: Manual, ExternalVerification, EntityDataUpdater)

### Change Sources

- **Manual**: Direct edit by UKNF Employee/System Admin
- **External Verification**: Periodic verification confirmation
- **Entity Data Updater**: Automated sync from external Entity Database

### Performance

- Index on EntityId and ChangedDate
- Implement pagination for large histories
- Cache frequently accessed histories

### Export Formats

- **CSV**: Simple comma-separated format for Excel
- **PDF**: Formatted report with entity header

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

