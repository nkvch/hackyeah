# Story 7.1: Create Announcement (UKNF)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.1  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee with appropriate permissions,  
**I want to** create announcements to publish on the bulletin board,  
**So that** I can communicate important information to supervised entities.

---

## Acceptance Criteria

1. Authorized UKNF Employee can access "Create Announcement"
2. Employee provides announcement details:
   - **Title** (text, required)
   - **Content** (rich text using WYSIWYG editor, required)
   - **Category** (dropdown, required) - e.g., "General Information", "Events", "Regulatory Changes", "System Updates"
   - **Priority** (dropdown, required) - Low, Medium, High
   - **Expiration Date** (date picker, optional) - announcement auto-expires after this date
   - **File Attachments** (optional, multiple files, follow attachment rules from Epic 5)
3. Employee can use WYSIWYG editor with formatting: bold, italic, underline, lists, links, headings
4. Employee can save announcement as draft (not published, not visible to external users)
5. Employee can publish announcement immediately or schedule for future publication
6. System validates all required fields
7. Published announcements are immediately visible to designated recipients
8. System logs announcement creation with timestamp and employee ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Announcement domain entity** (AC: 2, 4, 7)
  - [ ] Create `Announcement.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - Title (string, required, max 500)
    - Content (string, required, HTML rich text)
    - Category (string, required, max 100)
    - Priority (enum, required) - Low, Medium, High
    - PublicationDate (DateTime?, nullable)
    - ExpirationDate (DateTime?, nullable)
    - Status (enum, required) - Draft, Published, Removed, Deleted
    - CreatedBy (Guid, required) - UKNF Employee user ID
    - CreatedDate (DateTime, required)
    - LastModifiedBy (Guid, nullable)
    - LastModifiedDate (DateTime, nullable)
    - AttachmentIds (List<Guid>, collection of file IDs)
    - RecipientConfiguration (JSON, addressee types and selections)
  - [ ] Add Priority enum: Low, Medium, High
  - [ ] Add Status enum: Draft, Published, Removed, Deleted
  - [ ] Add domain methods: Publish(), SaveAsDraft(), Remove(), UpdateContent()
  - [ ] Add domain validation rules

- [ ] **Task 2: Create AnnouncementCategory value object** (AC: 2)
  - [ ] Create `AnnouncementCategory.cs` value object
  - [ ] Predefined categories: "General Information", "Events", "Regulatory Changes", "System Updates"
  - [ ] Add validation for category values

- [ ] **Task 3: Create CreateAnnouncementCommand** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `CreateAnnouncementCommand.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Commands/`
  - [ ] Command properties:
    - Title (string, required)
    - Content (string, required, HTML)
    - Category (string, required)
    - Priority (string, required) - "Low", "Medium", "High"
    - ExpirationDate (DateTime?, nullable)
    - AttachmentFiles (List<IFormFile>, optional)
    - SaveAsDraft (bool, required) - true = draft, false = publish immediately
    - RecipientConfiguration (RecipientConfigDto, required)

- [ ] **Task 4: Create CreateAnnouncementCommandValidator** (AC: 2, 3, 6)
  - [ ] Create `CreateAnnouncementCommandValidator.cs` using FluentValidation
  - [ ] Validate Title: NotEmpty, MaxLength(500)
  - [ ] Validate Content: NotEmpty, must be safe HTML (sanitized)
  - [ ] Validate Category: NotEmpty, must be valid category
  - [ ] Validate Priority: NotEmpty, must be "Low", "Medium", or "High"
  - [ ] Validate ExpirationDate: must be future date if provided
  - [ ] Validate Attachments: each file max 100 MB, total max 500 MB
  - [ ] Validate RecipientConfiguration: at least one recipient type selected

- [ ] **Task 5: Create CreateAnnouncementCommandHandler** (AC: 1, 2, 4, 5, 7, 8)
  - [ ] Create `CreateAnnouncementCommandHandler.cs` implementing `IRequestHandler<CreateAnnouncementCommand, CreateAnnouncementResponse>`
  - [ ] Inject dependencies: IAnnouncementRepository, IFileStorageService, ICurrentUserService, IHtmlSanitizer, ILogger
  - [ ] Handler logic:
    - Check user has "announcements.create" permission
    - Sanitize HTML content (prevent XSS)
    - Upload attachment files to storage
    - Create Announcement domain entity via factory method
    - Set status: Draft or Published based on SaveAsDraft flag
    - Set CreatedBy = current UKNF Employee user ID
    - Set CreatedDate = DateTime.UtcNow
    - Save announcement to repository
    - Log announcement creation
    - If published, publish AnnouncementPublishedEvent
    - Return CreateAnnouncementResponse with announcement ID and status

- [ ] **Task 6: Create IHtmlSanitizer service** (AC: 3)
  - [ ] Create `IHtmlSanitizer.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Methods:
    - `SanitizeHtml(string html): string` - remove dangerous HTML elements
  - [ ] Create `HtmlSanitizerService.cs` implementation using HtmlSanitizer library
  - [ ] Allow safe tags: p, br, strong, em, u, ul, ol, li, a, h1-h6
  - [ ] Remove: script, iframe, object, embed, style (inline styles allowed but sanitized)

- [ ] **Task 7: Create CreateAnnouncementResponse DTO** (AC: 7)
  - [ ] Create `CreateAnnouncementResponse.cs` record in `Application/UknfPlatform.Application.Communication/Announcements/DTOs/`
  - [ ] Properties:
    - AnnouncementId (Guid)
    - Status (string) - "Draft" or "Published"
    - Message (string)
    - CreatedDate (DateTime)

- [ ] **Task 8: Create REST API endpoint POST /api/announcements** (AC: 1, 2, 5)
  - [ ] Create `AnnouncementsController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize]` attribute - requires authentication
  - [ ] Add permission check: "announcements.create" (UKNF Employee only)
  - [ ] Create POST action `CreateAnnouncementAsync([FromForm] CreateAnnouncementCommand command)`
  - [ ] Use `[FromForm]` to handle multipart/form-data for attachments
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 201 Created with CreateAnnouncementResponse and Location header
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if user is not UKNF Employee
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 9: Create AnnouncementPublishedEvent** (AC: 7)
  - [ ] Create `AnnouncementPublishedEvent.cs` in `Domain/UknfPlatform.Domain.Communication/Events/`
  - [ ] Event properties: AnnouncementId, CreatedBy, RecipientCount
  - [ ] Event published to message queue
  - [ ] Event handler will send notifications to recipients

- [ ] **Task 10: Create database migration for Announcements table** (AC: 2, 4, 7)
  - [ ] Create EF Core migration: `Add_Announcements_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE Announcements (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        Title NVARCHAR(500) NOT NULL,
        Content TEXT NOT NULL,
        Category NVARCHAR(100) NOT NULL,
        Priority NVARCHAR(10) NOT NULL CHECK (Priority IN ('Low', 'Medium', 'High')),
        PublicationDate DATETIME2 NULL,
        ExpirationDate DATETIME2 NULL,
        Status NVARCHAR(20) NOT NULL CHECK (Status IN ('Draft', 'Published', 'Removed', 'Deleted')),
        CreatedBy UUID NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        LastModifiedBy UUID NULL,
        LastModifiedDate DATETIME2 NULL,
        RecipientConfiguration TEXT NOT NULL,
        
        FOREIGN KEY (CreatedBy) REFERENCES Users(Id),
        INDEX IX_Announcements_Status (Status),
        INDEX IX_Announcements_PublicationDate (PublicationDate),
        INDEX IX_Announcements_ExpirationDate (ExpirationDate),
        INDEX IX_Announcements_Priority (Priority)
    );
    ```

- [ ] **Task 11: Create Announcement-Attachment join table** (AC: 2)
  - [ ] Create `AnnouncementAttachments` join table
  - [ ] Properties: AnnouncementId, AttachmentId (File ID from file storage)
  - [ ] Many-to-many relationship

### Frontend Tasks

- [ ] **Task 12: Create announcements service** (AC: 1)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/announcements.service.ts`
  - [ ] Inject HttpClient
  - [ ] Method: `createAnnouncement(command): Observable<CreateAnnouncementResponse>`
  - [ ] Use FormData for file upload
  - [ ] Call POST `/api/announcements`
  - [ ] Handle errors with catchError

- [ ] **Task 13: Create create announcement component** (AC: 1, 2, 3)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/announcements/create-announcement/create-announcement.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/announcements/create` with auth + permission guard
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - title (input, required, max 500)
    - content (WYSIWYG editor, required)
    - category (dropdown, required)
    - priority (dropdown, required)
    - expirationDate (date picker, optional)
    - attachments (file upload, optional, multiple)

- [ ] **Task 14: Integrate WYSIWYG editor** (AC: 3)
  - [ ] Install Quill or TinyMCE or CKEditor
  - [ ] Configure editor with toolbar: bold, italic, underline, lists, links, h1-h6
  - [ ] Bind editor to form control
  - [ ] Extract HTML content on form submission

- [ ] **Task 15: Implement recipient selection** (AC: 7)
  - [ ] Create recipient configuration component (reusable)
  - [ ] Implement Addressee Types selection (Story 7.11 integration)
  - [ ] Allow selection of: All Users, Selected Entities, Entity Types, Selected Users, Contact Groups
  - [ ] Show recipient preview
  - [ ] Validate at least one recipient type selected

- [ ] **Task 16: Implement file attachments** (AC: 2)
  - [ ] Use PrimeNG FileUpload component or native input[type=file] with multiple
  - [ ] Accept any file type (security validation on backend)
  - [ ] Show file list with names and sizes
  - [ ] Allow file removal before upload
  - [ ] Validate total attachment size <= 500 MB

- [ ] **Task 17: Implement save as draft** (AC: 4, 5)
  - [ ] Add "Save as Draft" button
  - [ ] Add "Publish" button
  - [ ] Set `saveAsDraft` flag based on button clicked
  - [ ] Show confirmation: "Saved as draft" or "Published successfully"

- [ ] **Task 18: Handle form submission** (AC: 6, 7, 8)
  - [ ] On submit, create FormData object
  - [ ] Append form fields and files
  - [ ] Call announcementsService.createAnnouncement()
  - [ ] Show loading spinner during submission
  - [ ] On success (201):
    - Display success message with announcement ID
    - Navigate to announcement list or detail view
  - [ ] On error (400): Display validation errors
  - [ ] On error (403): Display "You don't have permission to create announcements"
  - [ ] Use PrimeNG MessageService for notifications

- [ ] **Task 19: Create form layout** (AC: 1, 2, 3)
  - [ ] Page title: "Create Announcement"
  - [ ] Breadcrumb: Home / Announcements / Create
  - [ ] Use card layout with form sections:
    - "Announcement Details" (title, category, priority)
    - "Content" (WYSIWYG editor)
    - "Recipients" (addressee types selection)
    - "Attachments" (file upload)
    - "Settings" (expiration date)
  - [ ] Info box: Explain announcement types and best practices
  - [ ] Form buttons: "Save as Draft", "Publish", "Cancel"
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

### Testing Tasks

- [ ] **Task 20: Write unit tests for CreateAnnouncementCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidCommand_CreatesAnnouncementSuccessfully`
  - [ ] Test: `Handle_SaveAsDraft_CreatesAnnouncementAsDraft`
  - [ ] Test: `Handle_PublishImmediately_PublishesAnnouncement`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_SanitizesHtmlContent`
  - [ ] Test: `Handle_UploadsAttachments`
  - [ ] Test: `Handle_PublishesAnnouncementPublishedEvent`
  - [ ] Mock: IAnnouncementRepository, IFileStorageService, IHtmlSanitizer, ILogger

- [ ] **Task 21: Write unit tests for CreateAnnouncementCommandValidator**
  - [ ] Test: Valid announcement with all fields
  - [ ] Test: Missing title rejected
  - [ ] Test: Missing content rejected
  - [ ] Test: Invalid category rejected
  - [ ] Test: Invalid priority rejected
  - [ ] Test: Past expiration date rejected
  - [ ] Test: Attachments exceed 500 MB rejected

- [ ] **Task 22: Write integration test for create announcement endpoint**
  - [ ] Test: `POST_CreateAnnouncement_ValidData_Returns201AndCreatesAnnouncement`
  - [ ] Test: `POST_CreateAnnouncement_SaveAsDraft_Returns201WithDraftStatus`
  - [ ] Test: `POST_CreateAnnouncement_UserLacksPermission_Returns403`
  - [ ] Test: `POST_CreateAnnouncement_MissingRequiredFields_Returns400`
  - [ ] Test: `POST_CreateAnnouncement_WithAttachments_UploadsFiles`
  - [ ] Use Testcontainers for database
  - [ ] Verify announcement created in database
  - [ ] Verify HTML sanitization
  - [ ] Verify attachments uploaded

---

## Dev Notes

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- HTML Sanitizer: HtmlSanitizer 8.0.0
- Logging: Serilog 3.1.1

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG (Editor component for WYSIWYG)
- Styling: Tailwind CSS
- TypeScript: 5.3+ (strict mode enabled)

### WYSIWYG Editor Options

1. **Quill** (Recommended for MVP)
   - Lightweight, modern, easy to integrate
   - Good Angular support via ngx-quill
   - Active development
   
2. **TinyMCE**
   - Feature-rich, enterprise-grade
   - Larger bundle size
   
3. **CKEditor**
   - Very popular, stable
   - Good Angular integration

### HTML Sanitization

**Library:** HtmlSanitizer (by mganss)
```csharp
var sanitizer = new HtmlSanitizer();
sanitizer.AllowedTags.Add("h1");
sanitizer.AllowedTags.Add("h2");
sanitizer.AllowedTags.Add("h3");
sanitizer.AllowedAttributes.Add("class");
var clean = sanitizer.Sanitize(html);
```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md`, Epic 7 Technical Considerations

1. **Permission Check:** Only UKNF Employees with "announcements.create" permission
2. **HTML Sanitization:** Remove dangerous HTML to prevent XSS attacks
3. **File Validation:** Same rules as Epic 5 (file type, size, virus scanning)
4. **Audit Trail:** Log all announcement creation with user and timestamp

### Data Model

**Source:** Epic 7 Technical Considerations

**Announcements Table:**
- Announcement ID (Guid)
- Title (string, max 500)
- Content (rich text HTML)
- Category (predefined values)
- Priority (Low, Medium, High)
- Publication Date (DateTime?, nullable)
- Expiration Date (DateTime?, nullable)
- Created By (UKNF Employee user ID)
- Created Date
- Last Modified Date
- Last Modified By
- Status (Draft, Published, Removed, Deleted)
- Attachments (references to files)
- Recipients Configuration (addressee types and selections)

### Dependencies

**Prerequisites:**
- **Epic 1**: Authentication (authenticated UKNF Employees)
- **Epic 2**: Authorization (permission checks)
- **Epic 5**: File attachments (reuse attachment system)

**Integrates With:**
- **Story 7.2**: Set Announcement Recipients (recipient configuration)
- **Story 7.3**: Publish Announcement (draft to published workflow)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

