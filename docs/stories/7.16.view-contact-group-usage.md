# Story 7.16: View Contact Group Usage

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.16  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As a** UKNF Employee,  
**I want to** see where Contact Groups are being used,  
**So that** I can understand impact before modifying groups.

---

## Acceptance Criteria

1. Employee can view Contact Group details including usage:
   - Active announcements using this group
   - File permissions using this group
   - Scheduled communications using this group
2. System warns employee before deleting group if it's actively used
3. Employee can view history of when group was used in communications
4. Usage report can be exported (CSV)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetContactGroupUsageQuery** (AC: 1, 3)
  - [ ] Create `GetContactGroupUsageQuery.cs` in `Application/UknfPlatform.Application.Communication/ContactGroups/Queries/`
  - [ ] Query properties:
    - ContactGroupId (Guid, required)

- [ ] **Task 2: Create GetContactGroupUsageQueryHandler** (AC: 1, 3)
  - [ ] Create `GetContactGroupUsageQueryHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, IContactGroupRepository, ILogger
  - [ ] Handler logic:
    - Find all announcements using this contact group:
      - Query Announcements where RecipientConfiguration contains ContactGroupId
      - Filter by Status = Published (active announcements)
    - Find all file permissions using this group (if Epic 6 implemented)
    - Find all scheduled communications (if Epic 5 implemented)
    - Get usage history from AuditLog or AnnouncementHistory
    - Return ContactGroupUsageDto

- [ ] **Task 3: Create ContactGroupUsageDto** (AC: 1)
  - [ ] Properties:
    - ContactGroupId (Guid)
    - GroupName (string)
    - ActiveAnnouncementCount (int)
    - ActiveAnnouncements (List<AnnouncementSummaryDto>)
    - FilePermissionCount (int)
    - FilePermissions (List<FilePermissionSummaryDto>)
    - ScheduledCommunicationCount (int)
    - UsageHistory (List<UsageHistoryEntryDto>)
    - CanBeDeleted (bool) - false if used anywhere

- [ ] **Task 4: Create AnnouncementSummaryDto** (AC: 1)
  - [ ] Properties:
    - Id (Guid)
    - Title (string)
    - PublicationDate (DateTime)
    - Status (string)

- [ ] **Task 5: Create UsageHistoryEntryDto** (AC: 3)
  - [ ] Properties:
    - Date (DateTime)
    - Action (string) - "AnnouncementPublished", "MessageSent", "FileShared"
    - RelatedEntityId (Guid) - announcement/message/file ID
    - RelatedEntityTitle (string)
    - PerformedBy (string) - employee name

- [ ] **Task 6: Create REST API endpoint GET /api/contact-groups/{id}/usage** (AC: 1, 3)
  - [ ] Add action to `ContactGroupsController.cs`
  - [ ] `GetContactGroupUsageAsync(Guid id)`
  - [ ] Return 200 OK with ContactGroupUsageDto
  - [ ] Return 404 if group not found
  - [ ] Require UKNF Employee permission

- [ ] **Task 7: Update DeleteContactGroupCommandHandler** (AC: 2)
  - [ ] Update handler from Story 7.12
  - [ ] Before deleting:
    - Check if group is used in active announcements
    - Check if group is used in active file permissions
    - Check if group is used in scheduled communications
    - If used anywhere, throw exception with details
  - [ ] Exception message: "Cannot delete contact group. It is used in X active announcements."

- [ ] **Task 8: Create ExportContactGroupUsageQuery** (AC: 4)
  - [ ] Create `ExportContactGroupUsageQuery.cs`
  - [ ] Query properties:
    - ContactGroupId (Guid, required)

- [ ] **Task 9: Create ExportContactGroupUsageQueryHandler** (AC: 4)
  - [ ] Create `ExportContactGroupUsageQueryHandler.cs`
  - [ ] Generate CSV with:
    - Contact Group details (name, description, member count)
    - Active Usage section:
      - Active announcements (title, publication date, status)
      - File permissions (file name, permission type)
    - Usage History section:
      - Date, Action, Related Entity, Performed By
  - [ ] Return CSV file stream

- [ ] **Task 10: Create REST API endpoint GET /api/contact-groups/{id}/usage/export** (AC: 4)
  - [ ] Add action to `ContactGroupsController.cs`
  - [ ] `ExportContactGroupUsageAsync(Guid id)`
  - [ ] Return CSV file with Content-Disposition: attachment
  - [ ] Filename: `contact-group-{id}-usage-{date}.csv`
  - [ ] Require UKNF Employee permission

### Frontend Tasks

- [ ] **Task 11: Update contact group detail component** (AC: 1)
  - [ ] Update `contact-group-detail.component.ts` from Story 7.14
  - [ ] Add "Usage" tab or section
  - [ ] Load usage via contactGroupsService.getUsage(id)
  - [ ] Display usage information

- [ ] **Task 12: Display active usage** (AC: 1)
  - [ ] Show sections:
    - **Active Announcements** (count)
      - List: Title, Publication Date, Status
      - Link to announcement detail
    - **File Permissions** (count, if Epic 6 implemented)
      - List: File Name, Permission Type
      - Link to file detail
    - **Scheduled Communications** (count, if applicable)
  - [ ] If no active usage, show: "Not currently used in any active communications"

- [ ] **Task 13: Display usage history** (AC: 3)
  - [ ] Show table:
    - Date
    - Action (e.g., "Announcement Published", "Message Sent")
    - Related Entity (title/name)
    - Performed By (employee name)
  - [ ] Order by date DESC (newest first)
  - [ ] Implement pagination (show last 50 entries)
  - [ ] Add filter by action type

- [ ] **Task 14: Update delete confirmation** (AC: 2)
  - [ ] When employee clicks "Delete" on contact group
  - [ ] Check if group is used (from usage data)
  - [ ] If used, show warning dialog:
    - "Cannot delete this contact group"
    - "It is currently used in:"
    - "- X active announcements"
    - "- Y file permissions"
    - "Please remove group from these communications before deleting"
  - [ ] If not used, show normal confirmation: "Are you sure you want to delete this group?"

- [ ] **Task 15: Implement export usage** (AC: 4)
  - [ ] Add "Export Usage Report" button on usage tab
  - [ ] On click, call contactGroupsService.exportUsage(id)
  - [ ] Download CSV file
  - [ ] Filename: `contact-group-{name}-usage-{date}.csv`

- [ ] **Task 16: Implement getUsage service method** (AC: 1)
  - [ ] Add method to `contactGroupsService.ts`
  - [ ] `getUsage(id: string): Observable<ContactGroupUsageDto>`
  - [ ] Call GET `/api/contact-groups/{id}/usage`
  - [ ] Handle errors

- [ ] **Task 17: Implement exportUsage service method** (AC: 4)
  - [ ] Add method to `contactGroupsService.ts`
  - [ ] `exportUsage(id: string): void`
  - [ ] Call GET `/api/contact-groups/{id}/usage/export`
  - [ ] Download CSV file
  - [ ] Handle errors

### Testing Tasks

- [ ] **Task 18: Write unit tests for GetContactGroupUsageQueryHandler** (AC: All)
  - [ ] Test: `Handle_ValidGroup_ReturnsUsage`
  - [ ] Test: `Handle_GroupUsedInAnnouncements_IncludesAnnouncements`
  - [ ] Test: `Handle_GroupNotUsed_ReturnsEmptyUsage`
  - [ ] Test: `Handle_GroupUsedInMultiplePlaces_ReturnsAll`
  - [ ] Test: `Handle_IncludesUsageHistory`
  - [ ] Mock: IAnnouncementRepository, IContactGroupRepository

- [ ] **Task 19: Write integration tests for contact group usage**
  - [ ] Test: `GET_ContactGroupUsage_Returns200WithUsage`
  - [ ] Test: `GET_ExportContactGroupUsage_ReturnsCSV`
  - [ ] Test: `DELETE_ContactGroup_GroupUsed_Returns400WithDetails`
  - [ ] Test: `DELETE_ContactGroup_GroupNotUsed_Returns200AndDeletes`
  - [ ] Use Testcontainers
  - [ ] Seed test data with contact group used in announcements
  - [ ] Verify usage detection works
  - [ ] Verify delete prevention works

---

## Dev Notes

### Checking Group Usage

**Announcements:**
```csharp
var announcements = await _announcementRepository
    .GetByRecipientConfigurationAsync(contactGroupId);

// Query AnnouncementRecipientConfiguration JSON:
// WHERE RecipientConfiguration LIKE '%contactGroupId%'
```

**File Permissions (Epic 6):**
```csharp
var filePermissions = await _filePermissionRepository
    .GetByContactGroupIdAsync(contactGroupId);
```

**Scheduled Communications (Epic 5):**
```csharp
var scheduledMessages = await _scheduledMessageRepository
    .GetByContactGroupIdAsync(contactGroupId);
```

### Usage History

Query AuditLog or AnnouncementHistory:
```sql
SELECT *
FROM AuditLog
WHERE EntityType = 'Announcement'
  AND Action = 'Published'
  AND Details LIKE '%contactGroupId%'
ORDER BY Timestamp DESC
```

### CanBeDeleted Flag

```csharp
var canDelete = usage.ActiveAnnouncementCount == 0
             && usage.FilePermissionCount == 0
             && usage.ScheduledCommunicationCount == 0;
```

### CSV Export Format

```csv
Contact Group Usage Report
Generated: 2025-10-04 10:30:00

Group Name,Quarterly Report Recipients
Description,Recipients for quarterly reports
Member Count,15

Active Usage:
Type,Title,Publication Date,Status
Announcement,Q3 2025 Report,2025-10-01,Published
Announcement,Q2 2025 Report,2025-07-01,Published

Usage History:
Date,Action,Related Entity,Performed By
2025-10-01,Announcement Published,Q3 2025 Report,John Doe
2025-07-01,Announcement Published,Q2 2025 Report,John Doe
```

### UI Design

**Contact Group Detail - Usage Tab:**
```
┌─────────────────────────────────────┐
│ Contact Group: Quarterly Recipients │
├─ [Details] [Members] [Usage] ──────┤
│                                     │
│ Active Usage                        │
│                                     │
│ ● Active Announcements (2)          │
│   - Q3 2025 Report (Oct 1, 2025)   │
│   - Q2 2025 Report (Jul 1, 2025)   │
│                                     │
│ ● File Permissions (0)              │
│   None                              │
│                                     │
│ Usage History                       │
│ [Filter: All] [Export Usage Report] │
│                                     │
│ Oct 1, 2025 - Announcement Published│
│   Q3 2025 Report by John Doe       │
│                                     │
│ Jul 1, 2025 - Announcement Published│
│   Q2 2025 Report by John Doe       │
│                                     │
└─────────────────────────────────────┘
```

### Delete Prevention

**Error Dialog:**
```
⚠️ Cannot Delete Contact Group

This contact group is currently used in:
• 2 active announcements
• 1 file permission

Please remove the group from these communications
before deleting it.

[View Usage] [Cancel]
```

### Dependencies

**Prerequisites:**
- **Story 7.15**: Use Contact Groups (groups are used in communications)
- **Story 7.12**: Create Contact Groups (groups exist)
- **Story 7.2**: Announcements use contact groups

**Integrates With:**
- **Epic 5**: Messaging (if messages use contact groups)
- **Epic 6**: Library (if file permissions use contact groups)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

