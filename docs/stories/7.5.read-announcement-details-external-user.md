# Story 7.5: Read Announcement Details (External User)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.5  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As an** External User,  
**I want to** read full announcement content,  
**So that** I can understand the information being communicated.

---

## Acceptance Criteria

1. User clicks announcement to view full details
2. Details page displays: Full title, Full content (with formatting), Category, Priority, Publication date, Expiration date, Attachments
3. User can download any attached files
4. Rich text content renders properly (formatting, links, etc.)
5. Announcement is marked as "read" for this user
6. Read status is tracked in system for statistics
7. For High-priority announcements, user is prompted to confirm reading (Story 7.6)
8. User can navigate back to bulletin board

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetAnnouncementDetailQuery** (AC: 1, 2)
  - [ ] Create `GetAnnouncementDetailQuery.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Queries/`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)
    - UserId (Guid, optional, defaults to current user)

- [ ] **Task 2: Create GetAnnouncementDetailQueryHandler** (AC: 2, 4, 5, 6)
  - [ ] Create `GetAnnouncementDetailQueryHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, IAnnouncementReadRepository, IFileStorageService, ICurrentUserService
  - [ ] Handler logic:
    - Load announcement by ID
    - Verify user is recipient (check AnnouncementRecipients table)
    - Get attachment files metadata
    - Check if user has already read announcement
    - If not read, create read record (or defer to separate command)
    - Return AnnouncementDetailDto

- [ ] **Task 3: Create MarkAnnouncementAsReadCommand** (AC: 5, 6)
  - [ ] Create `MarkAnnouncementAsReadCommand.cs`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)
    - UserId (Guid, optional, defaults to current user)
  - [ ] Create handler:
    - Check if read record exists
    - If not exists, create AnnouncementRead entry
    - Set ReadDate = DateTime.UtcNow
    - Return success

- [ ] **Task 4: Create AnnouncementDetailDto** (AC: 2, 3)
  - [ ] Create `AnnouncementDetailDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Title (string)
    - Content (string, HTML)
    - Category (string)
    - Priority (string)
    - PublicationDate (DateTime)
    - ExpirationDate (DateTime?)
    - IsRead (bool)
    - RequiresConfirmation (bool) - true if High priority
    - IsConfirmed (bool) - if user confirmed reading
    - Attachments (List<AttachmentDto>)
    - CreatedByName (string) - UKNF Employee who created
    - CreatedDate (DateTime)

- [ ] **Task 5: Create AttachmentDto** (AC: 3)
  - [ ] Properties:
    - Id (Guid)
    - FileName (string)
    - FileSize (long)
    - ContentType (string)
    - DownloadUrl (string) - temporary signed URL

- [ ] **Task 6: Create REST API endpoint GET /api/announcements/{id}** (AC: 1, 2)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetAnnouncementDetailAsync(Guid id)`
  - [ ] Return 200 OK with AnnouncementDetailDto
  - [ ] Return 404 if announcement not found
  - [ ] Return 403 if user is not recipient

- [ ] **Task 7: Create REST API endpoint POST /api/announcements/{id}/mark-read** (AC: 5, 6)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `MarkAnnouncementAsReadAsync(Guid id)`
  - [ ] Call MarkAnnouncementAsReadCommand
  - [ ] Return 200 OK
  - [ ] Idempotent: OK if already marked as read

- [ ] **Task 8: Create file download endpoint** (AC: 3)
  - [ ] Create GET `/api/announcements/{id}/attachments/{attachmentId}/download`
  - [ ] Verify user is recipient of announcement
  - [ ] Get file from storage
  - [ ] Return file stream with proper content type and filename
  - [ ] Use Content-Disposition header for download

- [ ] **Task 9: Create IAnnouncementReadRepository** (AC: 5, 6)
  - [ ] Create interface in `Domain/UknfPlatform.Domain.Communication/Interfaces/`
  - [ ] Methods:
    - `HasUserReadAnnouncementAsync(Guid announcementId, Guid userId): Task<bool>`
    - `CreateReadAsync(AnnouncementRead read): Task`
    - `GetReadDateAsync(Guid announcementId, Guid userId): Task<DateTime?>`
  - [ ] Create implementation in Infrastructure

### Frontend Tasks

- [ ] **Task 10: Create announcement detail component** (AC: 1, 2, 4, 8)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/announcements/announcement-detail/announcement-detail.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/announcements/:id` with auth guard
  - [ ] Load announcement via announcementsService.getAnnouncementDetail(id)
  - [ ] Display full announcement details

- [ ] **Task 11: Display announcement content** (AC: 2, 4)
  - [ ] Display full title (h1 or h2)
  - [ ] Display priority badge (color-coded)
  - [ ] Display category tag
  - [ ] Display publication date (formatted)
  - [ ] Display expiration date if set
  - [ ] Render full HTML content with `[innerHTML]="announcement.content"`
  - [ ] Ensure HTML renders safely (Angular sanitizes by default)
  - [ ] Style rich text content (headings, lists, links, etc.)

- [ ] **Task 12: Display attachments** (AC: 3)
  - [ ] If announcement has attachments, show "Attachments" section
  - [ ] List attachments with: Icon, Filename, File size
  - [ ] Add "Download" button for each attachment
  - [ ] On click, call announcementsService.downloadAttachment(id, attachmentId)
  - [ ] Download file using FileSaver.js or anchor tag with download attribute

- [ ] **Task 13: Implement mark as read** (AC: 5, 6)
  - [ ] On component init (announcement loaded), call announcementsService.markAsRead(id)
  - [ ] Call in background (don't wait for response)
  - [ ] Handle errors silently (mark as read is not critical for user experience)

- [ ] **Task 14: Implement high-priority confirmation prompt** (AC: 7)
  - [ ] If announcement.requiresConfirmation = true and announcement.isConfirmed = false
  - [ ] Show confirmation dialog or banner: "Please confirm you have read this important announcement"
  - [ ] Add "I confirm I have read this announcement" button
  - [ ] On confirm, call announcementsService.confirmReading(id) (Story 7.6)
  - [ ] After confirmation, hide prompt and update announcement.isConfirmed = true

- [ ] **Task 15: Implement back navigation** (AC: 8)
  - [ ] Add "Back to Announcements" button or breadcrumb
  - [ ] On click, navigate to `/announcements`
  - [ ] Use Angular Location.back() or routerLink

- [ ] **Task 16: Style announcement detail page** (AC: 1, 2, 4)
  - [ ] Page title: Announcement title
  - [ ] Breadcrumb: Home / Announcements / [Title]
  - [ ] Metadata section: Category, Priority, Publication date
  - [ ] Content section: Full HTML content
  - [ ] Attachments section: File list with download buttons
  - [ ] Responsive design
  - [ ] Loading state: Skeleton or spinner
  - [ ] Error state: "Announcement not found" or "Access denied"

- [ ] **Task 17: Implement downloadAttachment service method** (AC: 3)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `downloadAttachment(announcementId: string, attachmentId: string): void`
  - [ ] Call GET `/api/announcements/{announcementId}/attachments/{attachmentId}/download`
  - [ ] Use responseType: 'blob'
  - [ ] Trigger file download using FileSaver.js or anchor tag

### Testing Tasks

- [ ] **Task 18: Write unit tests for GetAnnouncementDetailQueryHandler** (AC: All)
  - [ ] Test: `Handle_ValidAnnouncementId_ReturnsDetail`
  - [ ] Test: `Handle_UserIsNotRecipient_ThrowsForbiddenException`
  - [ ] Test: `Handle_AnnouncementNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_IncludesAttachments`
  - [ ] Test: `Handle_ChecksReadStatus`
  - [ ] Mock: IAnnouncementRepository, IAnnouncementReadRepository, IFileStorageService

- [ ] **Task 19: Write unit tests for MarkAnnouncementAsReadCommandHandler** (AC: 5, 6)
  - [ ] Test: `Handle_FirstRead_CreatesReadRecord`
  - [ ] Test: `Handle_AlreadyRead_Idempotent`
  - [ ] Test: `Handle_SetsReadDate`
  - [ ] Mock: IAnnouncementReadRepository

- [ ] **Task 20: Write integration test for announcement detail**
  - [ ] Test: `GET_AnnouncementDetail_ValidId_Returns200WithDetail`
  - [ ] Test: `GET_AnnouncementDetail_UserNotRecipient_Returns403`
  - [ ] Test: `GET_AnnouncementDetail_NotFound_Returns404`
  - [ ] Test: `POST_MarkAsRead_CreatesReadRecord`
  - [ ] Test: `GET_DownloadAttachment_ValidId_ReturnsFile`
  - [ ] Use Testcontainers
  - [ ] Seed test data with announcements and recipients
  - [ ] Verify read tracking works

---

## Dev Notes

### Read Tracking

**When to mark as read:**
- When user views announcement detail page
- Call mark-as-read endpoint on component init
- Idempotent: OK if already marked

**AnnouncementReads Table:**
```sql
CREATE TABLE AnnouncementReads (
    Id BIGINT IDENTITY(1,1) PRIMARY KEY,
    AnnouncementId UUID NOT NULL,
    UserId UUID NOT NULL,
    ReadDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FOREIGN KEY (AnnouncementId) REFERENCES Announcements(Id),
    FOREIGN KEY (UserId) REFERENCES Users(Id),
    UNIQUE (AnnouncementId, UserId)
);
```

### HTML Content Rendering

**Frontend:**
Use Angular's `[innerHTML]` binding to render HTML content:
```html
<div [innerHTML]="announcement.content" class="announcement-content"></div>
```

Angular sanitizes HTML by default, removing dangerous elements like `<script>`.

**CSS:**
Style rich text content:
```scss
.announcement-content {
  h1, h2, h3 { font-weight: bold; margin: 1rem 0; }
  p { margin: 0.5rem 0; }
  ul, ol { margin-left: 1.5rem; }
  a { color: blue; text-decoration: underline; }
}
```

### File Download

**Backend:**
Return file stream with Content-Disposition header:
```csharp
var file = await _fileStorageService.DownloadFileAsync(storageKey);
return File(file, contentType, fileName);
```

**Frontend:**
Use FileSaver.js or anchor tag:
```typescript
this.http.get(url, { responseType: 'blob' })
  .subscribe(blob => {
    saveAs(blob, fileName);
  });
```

### High-Priority Confirmation

High-priority announcements require explicit confirmation (Story 7.6). For this story, just detect and show prompt. Actual confirmation logic in Story 7.6.

### Dependencies

**Prerequisites:**
- **Story 7.4**: View Bulletin Board (user navigates from list)
- **Story 7.3**: Publish Announcement (published announcements exist)

**Integrates With:**
- **Story 7.6**: Confirm Reading High-Priority Announcements (confirmation prompt)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

