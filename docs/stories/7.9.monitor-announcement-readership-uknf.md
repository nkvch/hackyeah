# Story 7.9: Monitor Announcement Readership (UKNF)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.9  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** see statistics on who has read announcements,  
**So that** I can ensure important communications are being received.

---

## Acceptance Criteria

1. Employee can view announcement readership statistics:
   - **Total recipients**: Number of users/entities announcement was addressed to
   - **Read count**: Number of users who viewed announcement
   - **Unread count**: Number of users who haven't viewed
   - **Read percentage**: Visual indicator (e.g., "71/100 entities read")
   - **Confirmation count** (for High-priority): Number of users who confirmed reading
2. Employee can view list of users who read announcement (names, entities, read timestamps)
3. Employee can view list of users who haven't read announcement (names, entities)
4. Employee can send reminder to users who haven't read (create message or new notification)
5. Statistics update in real-time as users read announcements
6. Employee can export readership report (CSV)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetAnnouncementReadStatisticsQuery** (AC: 1, 5)
  - [ ] Create `GetAnnouncementReadStatisticsQuery.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Queries/`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)

- [ ] **Task 2: Create GetAnnouncementReadStatisticsQueryHandler** (AC: 1, 5)
  - [ ] Create `GetAnnouncementReadStatisticsQueryHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, IAnnouncementReadRepository, IAnnouncementReadConfirmationRepository, IRecipientCalculator
  - [ ] Handler logic:
    - Load announcement
    - Calculate recipients (all users who should see announcement)
    - Count reads from AnnouncementReads table
    - Count confirmations from AnnouncementReadConfirmations table (if High priority)
    - Calculate unread count (total recipients - read count)
    - Calculate read percentage
    - Return AnnouncementReadStatisticsDto

- [ ] **Task 3: Create AnnouncementReadStatisticsDto** (AC: 1)
  - [ ] Create `AnnouncementReadStatisticsDto.cs` record
  - [ ] Properties:
    - AnnouncementId (Guid)
    - AnnouncementTitle (string)
    - TotalRecipients (int)
    - ReadCount (int)
    - UnreadCount (int)
    - ReadPercentage (decimal)
    - ConfirmationCount (int?) - only for High priority
    - ConfirmationPercentage (decimal?) - only for High priority
    - IsHighPriority (bool)

- [ ] **Task 4: Create GetAnnouncementReadersQuery** (AC: 2)
  - [ ] Create `GetAnnouncementReadersQuery.cs`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)
    - PageNumber (int, default 1)
    - PageSize (int, default 50)

- [ ] **Task 5: Create GetAnnouncementReadersQueryHandler** (AC: 2)
  - [ ] Create `GetAnnouncementReadersQueryHandler.cs`
  - [ ] Inject dependencies: IAnnouncementReadRepository, IUserRepository
  - [ ] Handler logic:
    - Get all reads for announcement
    - Join with Users to get user names and entities
    - Include read timestamps
    - Paginate results
    - Return AnnouncementReaderListDto

- [ ] **Task 6: Create AnnouncementReaderDto** (AC: 2)
  - [ ] Properties:
    - UserId (Guid)
    - UserFullName (string)
    - UserEmail (string)
    - EntityName (string)
    - ReadDate (DateTime)
    - Confirmed (bool) - if High priority

- [ ] **Task 7: Create GetAnnouncementNonReadersQuery** (AC: 3)
  - [ ] Create `GetAnnouncementNonReadersQuery.cs`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)
    - PageNumber (int, default 1)
    - PageSize (int, default 50)

- [ ] **Task 8: Create GetAnnouncementNonReadersQueryHandler** (AC: 3)
  - [ ] Create `GetAnnouncementNonReadersQueryHandler.cs`
  - [ ] Inject dependencies: IRecipientCalculator, IAnnouncementReadRepository, IUserRepository
  - [ ] Handler logic:
    - Calculate all recipients
    - Get all reads
    - Find users who are recipients but haven't read
    - Join with Users to get names and entities
    - Paginate results
    - Return AnnouncementNonReaderListDto

- [ ] **Task 9: Create REST API endpoint GET /api/announcements/{id}/statistics** (AC: 1, 5)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetAnnouncementReadStatisticsAsync(Guid id)`
  - [ ] Return 200 OK with AnnouncementReadStatisticsDto
  - [ ] Return 404 if announcement not found
  - [ ] Require UKNF Employee permission

- [ ] **Task 10: Create REST API endpoint GET /api/announcements/{id}/readers** (AC: 2)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetAnnouncementReadersAsync(Guid id, [FromQuery] int page = 1, [FromQuery] int pageSize = 50)`
  - [ ] Return 200 OK with paginated list of readers
  - [ ] Require UKNF Employee permission

- [ ] **Task 11: Create REST API endpoint GET /api/announcements/{id}/non-readers** (AC: 3)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetAnnouncementNonReadersAsync(Guid id, [FromQuery] int page = 1, [FromQuery] int pageSize = 50)`
  - [ ] Return 200 OK with paginated list of non-readers
  - [ ] Require UKNF Employee permission

- [ ] **Task 12: Create SendReminderCommand** (AC: 4)
  - [ ] Create `SendAnnouncementReminderCommand.cs`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)
    - RecipientUserIds (List<Guid>, optional) - if empty, send to all non-readers
  - [ ] Create handler:
    - Get non-readers (or use provided list)
    - Send notification to each user
    - Send email notification
    - Log reminder sent
    - Return success response

- [ ] **Task 13: Create REST API endpoint POST /api/announcements/{id}/send-reminder** (AC: 4)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `SendAnnouncementReminderAsync(Guid id, [FromBody] SendReminderRequest request)`
  - [ ] Request body: { recipientUserIds?: Guid[] }
  - [ ] Return 200 OK
  - [ ] Require UKNF Employee permission

- [ ] **Task 14: Create ExportAnnouncementReadersQuery** (AC: 6)
  - [ ] Create `ExportAnnouncementReadersQuery.cs`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)
    - IncludeReaders (bool, default true)
    - IncludeNonReaders (bool, default true)

- [ ] **Task 15: Create ExportAnnouncementReadersQueryHandler** (AC: 6)
  - [ ] Create `ExportAnnouncementReadersQueryHandler.cs`
  - [ ] Generate CSV file with:
    - Announcement title, publication date
    - Statistics summary
    - List of readers (if included): Name, Email, Entity, Read Date, Confirmed
    - List of non-readers (if included): Name, Email, Entity
  - [ ] Return CSV file stream

- [ ] **Task 16: Create REST API endpoint GET /api/announcements/{id}/export-readers** (AC: 6)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `ExportAnnouncementReadersAsync(Guid id, [FromQuery] bool includeReaders = true, [FromQuery] bool includeNonReaders = true)`
  - [ ] Return CSV file with Content-Disposition: attachment
  - [ ] Filename: `announcement-{id}-readership-{date}.csv`
  - [ ] Require UKNF Employee permission

### Frontend Tasks

- [ ] **Task 17: Create announcement statistics component** (AC: 1, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/announcements/announcement-statistics/announcement-statistics.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/announcements/:id/statistics` with auth + permission guard
  - [ ] Load statistics via announcementsService.getStatistics(id)
  - [ ] Display statistics dashboard

- [ ] **Task 18: Display readership statistics** (AC: 1)
  - [ ] Show key metrics:
    - Total Recipients (number)
    - Read Count (number)
    - Unread Count (number)
    - Read Percentage (progress bar or pie chart)
  - [ ] If High priority, show:
    - Confirmation Count
    - Confirmation Percentage
  - [ ] Use visual indicators (progress bars, charts)
  - [ ] Style with Tailwind CSS

- [ ] **Task 19: Implement readers list** (AC: 2)
  - [ ] Add "View Readers" tab or section
  - [ ] Load via announcementsService.getReaders(id, page, pageSize)
  - [ ] Display table/list:
    - User Name
    - Entity
    - Email
    - Read Date (formatted)
    - Confirmed (checkmark icon if true)
  - [ ] Implement pagination
  - [ ] Implement search/filter

- [ ] **Task 20: Implement non-readers list** (AC: 3)
  - [ ] Add "View Non-Readers" tab or section
  - [ ] Load via announcementsService.getNonReaders(id, page, pageSize)
  - [ ] Display table/list:
    - User Name
    - Entity
    - Email
  - [ ] Highlight users who should have read (e.g., days since publication)
  - [ ] Implement pagination

- [ ] **Task 21: Implement send reminder** (AC: 4)
  - [ ] Add "Send Reminder" button on non-readers list
  - [ ] Option 1: Send to all non-readers
  - [ ] Option 2: Select specific users and send to selected
  - [ ] On click, show confirmation dialog: "Send reminder to X users?"
  - [ ] On confirm, call announcementsService.sendReminder(id, userIds?)
  - [ ] On success, show message: "Reminder sent to X users"

- [ ] **Task 22: Implement export readership** (AC: 6)
  - [ ] Add "Export to CSV" button
  - [ ] On click, call announcementsService.exportReaders(id)
  - [ ] Download CSV file
  - [ ] Filename: `announcement-{id}-readership-{date}.csv`

- [ ] **Task 23: Implement auto-refresh** (AC: 5)
  - [ ] Add auto-refresh every 30 seconds (optional toggle)
  - [ ] Reload statistics without page reload
  - [ ] Show "Last updated" timestamp
  - [ ] Use RxJS interval or polling

- [ ] **Task 24: Add "View Statistics" link from announcement detail** (AC: 1)
  - [ ] Update `announcement-detail.component.ts` from Story 7.5
  - [ ] Add "View Statistics" button (visible only to UKNF Employees)
  - [ ] On click, navigate to `/announcements/{id}/statistics`

### Testing Tasks

- [ ] **Task 25: Write unit tests for GetAnnouncementReadStatisticsQueryHandler** (AC: 1)
  - [ ] Test: `Handle_ValidAnnouncement_ReturnsStatistics`
  - [ ] Test: `Handle_CalculatesPercentagesCorrectly`
  - [ ] Test: `Handle_HighPriority_IncludesConfirmationStats`
  - [ ] Test: `Handle_LowPriority_ExcludesConfirmationStats`
  - [ ] Mock: IAnnouncementRepository, IAnnouncementReadRepository, IAnnouncementReadConfirmationRepository, IRecipientCalculator

- [ ] **Task 26: Write unit tests for GetAnnouncementReadersQueryHandler** (AC: 2)
  - [ ] Test: `Handle_ReturnsReaders`
  - [ ] Test: `Handle_Paginates`
  - [ ] Test: `Handle_IncludesReadTimestamps`

- [ ] **Task 27: Write unit tests for GetAnnouncementNonReadersQueryHandler** (AC: 3)
  - [ ] Test: `Handle_ReturnsNonReaders`
  - [ ] Test: `Handle_ExcludesReaders`
  - [ ] Test: `Handle_Paginates`

- [ ] **Task 28: Write integration test for announcement statistics**
  - [ ] Test: `GET_AnnouncementStatistics_Returns200WithStatistics`
  - [ ] Test: `GET_AnnouncementReaders_Returns200WithReaders`
  - [ ] Test: `GET_AnnouncementNonReaders_Returns200WithNonReaders`
  - [ ] Test: `POST_SendReminder_SendsNotifications`
  - [ ] Test: `GET_ExportReaders_ReturnsCSV`
  - [ ] Use Testcontainers
  - [ ] Seed test data with announcements, recipients, reads, confirmations
  - [ ] Verify statistics calculations are correct

---

## Dev Notes

### Statistics Calculation

**Total Recipients:**
- Count of all users who should see announcement (from AnnouncementRecipients table)

**Read Count:**
- Count of distinct users in AnnouncementReads table for this announcement

**Unread Count:**
- Total Recipients - Read Count

**Read Percentage:**
- (Read Count / Total Recipients) * 100

**Confirmation Count (High priority only):**
- Count of records in AnnouncementReadConfirmations table

**Confirmation Percentage:**
- (Confirmation Count / Total Recipients) * 100

### Real-Time Updates

**Option 1: Polling**
- Frontend polls statistics endpoint every 30 seconds
- Simple, no server infrastructure needed

**Option 2: SignalR/WebSockets**
- Server pushes updates when reads occur
- More complex, requires SignalR hub
- Better user experience

**Recommendation:** Use polling for MVP, consider SignalR for v2.

### Send Reminder

Reminder notification:
- Subject: "Reminder: Please read announcement"
- Body: Link to announcement
- Send in-app notification + email

### Export CSV Format

```csv
Announcement: [Title]
Publication Date: [Date]
Total Recipients: [Count]
Read: [Count] ([Percentage]%)
Unread: [Count]

Readers:
Name,Email,Entity,Read Date,Confirmed
John Doe,john@example.com,Bank ABC,2025-10-04 10:30,Yes
...

Non-Readers:
Name,Email,Entity
Jane Smith,jane@example.com,Insurance XYZ
...
```

### Dependencies

**Prerequisites:**
- **Story 7.5**: Read Announcement Details (read tracking exists)
- **Story 7.6**: Confirm Reading (confirmation tracking exists)
- **Story 7.3**: Publish Announcement (announcements published)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

