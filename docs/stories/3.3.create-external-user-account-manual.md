# Story 3.3: Create External User Account (Manual)

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.3  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** manually create accounts for external users,  
**So that** I can onboard users who cannot self-register.

---

## Acceptance Criteria

1. System Administrator can access "Create External User" form
2. Form includes mandatory fields: First name, Last name, PESEL (full, will be masked in display), Email, Phone
3. System validates all field formats (email, PESEL, phone)
4. System validates email and PESEL uniqueness
5. Administrator can set initial password OR trigger automatic password setup email
6. Administrator cannot directly assign entity permissions (must go through access request workflow from Epic 2)
7. Upon creation, user account is set to Active status
8. User receives account creation email with login instructions
9. System logs user creation with timestamp and administrator ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create CreateExternalUserCommand** (AC: 2, 5)
  - [ ] Create `CreateExternalUserCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - FirstName (string, required)
    - LastName (string, required)
    - Email (string, required)
    - Phone (string, required)
    - Pesel (string, required, 11 digits)
    - InitialPassword (string, optional) - if provided, user logs in with this
    - SendPasswordSetupEmail (bool) - if true, send email for user to set password
  - [ ] Note: No RoleIds property (AC: 6 - no entity permissions assigned here)
  - [ ] Validation: Either InitialPassword OR SendPasswordSetupEmail must be true, not both

- [ ] **Task 2: Create CreateExternalUserCommandValidator** (AC: 3, 4)
  - [ ] Create `CreateExternalUserCommandValidator.cs` using FluentValidation
  - [ ] Validate FirstName: NotEmpty, MaxLength(100)
  - [ ] Validate LastName: NotEmpty, MaxLength(100)
  - [ ] Validate Email: NotEmpty, EmailAddress format, MaxLength(256)
  - [ ] Validate Phone: NotEmpty, Matches regex `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate Pesel: NotEmpty, Exactly 11 digits, IsDigits
  - [ ] Validate password method: Either InitialPassword (if provided, min 8 chars) OR SendPasswordSetupEmail = true
  - [ ] Add custom async validation: Email must be unique
  - [ ] Add custom async validation: PESEL must be unique

- [ ] **Task 3: Create CreateExternalUserCommandHandler** (AC: 4, 5, 7, 8, 9)
  - [ ] Create `CreateExternalUserCommandHandler.cs` implementing `IRequestHandler<CreateExternalUserCommand, CreateUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IPasswordHasher, IEmailService, IPeselEncryptionService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Check if email already exists (409 Conflict)
    - Check if PESEL already exists (409 Conflict)
    - Encrypt full PESEL
    - Extract last 4 digits of PESEL for display (PeselLast4)
    - Create User entity via domain method `User.CreateExternal()`
    - Set UserType = "External"
    - Set IsActive = true
    - Set PeselEncrypted and PeselLast4
    - If InitialPassword provided:
      - Hash password and set PasswordHash
      - Set MustChangePassword = true
    - If SendPasswordSetupEmail = true:
      - Generate password setup token (24-hour expiry)
      - Set temporary placeholder password hash
      - Set MustChangePassword = true
    - Save to repository with transaction
    - Automatically create AccessRequest with "Working" status (Epic 2 integration)
    - Send account creation email with login instructions
    - Log user creation action
    - Return CreateUserResponse
  - [ ] Use transaction to ensure atomicity

- [ ] **Task 4: Update User domain entity** (AC: 2, 7)
  - [ ] Open `User.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add static factory method: `CreateExternal(firstName, lastName, email, phone, peselEncrypted, peselLast4)`
  - [ ] Factory method creates User with:
    - Id = new Guid
    - UserType = UserType.External
    - IsActive = true
    - CreatedDate = DateTime.UtcNow
    - UpdatedDate = DateTime.UtcNow
  - [ ] Ensure PESEL fields are set correctly

- [ ] **Task 5: Create IPeselEncryptionService** (AC: 2, 3)
  - [ ] Create `IPeselEncryptionService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Methods:
    - `Encrypt(pesel): string` - returns encrypted PESEL
    - `GetLast4Digits(pesel): string` - returns last 4 digits
    - `Decrypt(encryptedPesel): string` - decrypt PESEL (for authorized views only)
  - [ ] Create `PeselEncryptionService.cs` implementation in `Infrastructure/UknfPlatform.Infrastructure.Identity/Services/`
  - [ ] Use AES encryption with key from configuration
  - [ ] Key stored in appsettings or Azure Key Vault (production)

- [ ] **Task 6: Integrate with Epic 2 AccessRequest creation** (AC: 6)
  - [ ] After user creation, automatically create AccessRequest
  - [ ] Use `AccessRequest.CreateForUser(userId)` domain method
  - [ ] Set Status = "Working"
  - [ ] No permission lines yet (user will complete in Epic 2)
  - [ ] Save AccessRequest in same transaction as user creation
  - [ ] Log AccessRequest creation

- [ ] **Task 7: Create REST API endpoint POST /api/admin/users/external** (AC: 1, 2)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create POST action `CreateExternalUserAsync(CreateExternalUserCommand command)`
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 201 Created with CreateUserResponse and Location header
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 409 Conflict if email or PESEL already exists
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 8: Extend IUserRepository with PESEL check** (AC: 4)
  - [ ] Update `IUserRepository.cs` in `Domain/UknfPlatform.Domain.Auth/Repositories/`
  - [ ] Add method: `PeselExistsAsync(peselEncrypted)`
  - [ ] Note: Check encrypted PESEL, not plain text
  - [ ] Update `UserRepository.cs` implementation

- [ ] **Task 9: Create account creation email template** (AC: 8)
  - [ ] Create `AccountCreatedExternalUserEmail.cshtml` in `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/`
  - [ ] Template content:
    - UKNF branding/logo
    - Welcome message for external user
    - Explanation: Account created by UKNF administrator
    - If InitialPassword: Login URL + instructions to change password
    - If SendPasswordSetupEmail: Link to password setup page with token
    - Next steps: Complete access request to gain permissions
    - Access request status: "Working" (draft)
    - Support contact information
  - [ ] Update IEmailService to support external user welcome

- [ ] **Task 10: Update IEmailService for external user emails** (AC: 8)
  - [ ] Update `IEmailService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Add method: `SendAccountCreatedEmailAsync(userId, email, firstName, passwordSetupUrl?, accessRequestUrl)`
  - [ ] Implement in `EmailService.cs` using account creation template
  - [ ] Include link to access request page
  - [ ] Log email sending actions

- [ ] **Task 11: Create audit log entry** (AC: 9)
  - [ ] After user creation, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = administrator who created user
    - EntityType = "User"
    - EntityPrimaryKey = new user's ID
    - Action = "CreateExternal"
    - Timestamp = DateTime.UtcNow
    - AfterState = JSON snapshot of new user (exclude password hash, show PESEL as masked)
  - [ ] Log AccessRequest creation separately

### Frontend Tasks

- [ ] **Task 12: Create external user service method** (AC: 1)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Add method: `createExternalUser(command): Observable<CreateUserResponse>`
  - [ ] Call POST `/api/admin/users/external`
  - [ ] Handle errors with catchError

- [ ] **Task 13: Create external user form component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/users/create-external-user/create-external-user.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/admin/users/create/external` with auth + role guard
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - firstName (required)
    - lastName (required)
    - email (required, email validation)
    - phone (required, pattern validation)
    - pesel (required, 11 digits)
    - passwordMethod (radio: "Set Password" or "Send Setup Email")
    - initialPassword (conditionally required)
    - confirmPassword (conditionally required, must match)

- [ ] **Task 14: Implement form validation** (AC: 3, 4, 5)
  - [ ] FirstName/LastName: Validators.required, Validators.maxLength(100)
  - [ ] Email: Validators.required, Validators.email
  - [ ] Phone: Validators.required, Validators.pattern(/^\+(?:[0-9] ?){6,14}[0-9]$/)
  - [ ] Pesel: Validators.required, Validators.pattern(/^\d{11}$/), custom PESEL checksum validator
  - [ ] InitialPassword: Conditional validation (min 8 chars, complexity)
  - [ ] ConfirmPassword: Match initialPassword
  - [ ] Add async validators: Email uniqueness, PESEL uniqueness (debounce 500ms)
  - [ ] Display validation error messages below each field

- [ ] **Task 15: Implement PESEL input with masking** (AC: 2)
  - [ ] Create PESEL input directive or use PrimeNG InputMask
  - [ ] Format: 11 digits, mask as user types
  - [ ] Display masked PESEL: show first 2 digits, mask middle digits, show last 4
  - [ ] Example: 12*******8901
  - [ ] Info icon: Explain PESEL will be encrypted and only last 4 digits visible in system

- [ ] **Task 16: Implement PESEL checksum validation** (AC: 3)
  - [ ] Create custom validator: `peselChecksumValidator`
  - [ ] PESEL checksum algorithm (Polish standard):
    - Multiply each digit by weight: 1,3,7,9,1,3,7,9,1,3
    - Sum results, take modulo 10
    - Subtract from 10, take last digit
    - Compare with 11th digit of PESEL
  - [ ] Display error: "Invalid PESEL number" if checksum fails

- [ ] **Task 17: Implement password method toggle** (AC: 5)
  - [ ] Radio buttons: "Set Password" vs "Send Setup Email"
  - [ ] If "Set Password" selected:
    - Show password and confirm password fields
  - [ ] If "Send Setup Email" selected:
    - Hide password fields
    - Show info message: "User will receive an email to set their password"
  - [ ] Default: "Send Setup Email"

- [ ] **Task 18: Handle form submission** (AC: 7, 8)
  - [ ] On submit, call usersService.createExternalUser()
  - [ ] Show loading spinner during submission
  - [ ] On success (201):
    - Display success message with user email
    - Show info: "User has been created with 'Working' access request status"
    - Show next steps: "User needs to complete their access request"
    - Navigate to user details or user list page
  - [ ] On error (400): Display validation errors
  - [ ] On error (409): Display "Email or PESEL already exists" message
  - [ ] Use NotificationService for toast messages

- [ ] **Task 19: Create form layout** (AC: 1, 2)
  - [ ] Page title: "Create External User"
  - [ ] Breadcrumb: Admin > Users > Create External User
  - [ ] Use card layout with form sections:
    - "Personal Information" (name, PESEL)
    - "Contact Information" (email, phone)
    - "Password Setup" (password method selection)
  - [ ] Info box: "External users cannot be assigned roles directly. They must complete an access request workflow."
  - [ ] Form buttons: "Create User", "Cancel"
  - [ ] Use PrimeNG form components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 20: Add info about access request workflow** (AC: 6)
  - [ ] Display info message on form:
    - "After creation, an access request will be automatically created for this user with 'Working' status."
    - "The user will need to complete and submit the access request to receive entity permissions."
  - [ ] Link to access request documentation or help

### Testing Tasks

- [ ] **Task 21: Write unit tests for CreateExternalUserCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidCommand_CreatesExternalUser`
  - [ ] Test: `Handle_ExistingEmail_ThrowsConflictException`
  - [ ] Test: `Handle_ExistingPesel_ThrowsConflictException`
  - [ ] Test: `Handle_EncryptsPesel_Successfully`
  - [ ] Test: `Handle_ExtractsLast4Digits_Correctly`
  - [ ] Test: `Handle_WithInitialPassword_HashesPassword`
  - [ ] Test: `Handle_WithPasswordSetupEmail_GeneratesToken`
  - [ ] Test: `Handle_CreatesAccessRequest_Automatically`
  - [ ] Test: `Handle_SendsAccountCreationEmail`
  - [ ] Test: `Handle_LogsCreationAction`
  - [ ] Mock: IUserRepository, IPasswordHasher, IPeselEncryptionService, IEmailService, IAccessRequestRepository, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 22: Write unit tests for CreateExternalUserCommandValidator**
  - [ ] Test: Email validation (valid, invalid, empty, uniqueness)
  - [ ] Test: Phone validation (valid international, invalid format)
  - [ ] Test: PESEL validation (11 digits, non-numeric, empty, uniqueness)
  - [ ] Test: Required field validation
  - [ ] Test: Password method validation

- [ ] **Task 23: Write unit tests for PeselEncryptionService**
  - [ ] Test: `Encrypt_ValidPesel_ReturnsEncryptedString`
  - [ ] Test: `Decrypt_EncryptedPesel_ReturnsOriginalPesel`
  - [ ] Test: `GetLast4Digits_ValidPesel_ReturnsLast4`
  - [ ] Test: `Encrypt_SamePesel_ReturnsSameEncryption` (deterministic)
  - [ ] Verify encryption/decryption round-trip

- [ ] **Task 24: Write integration test for create external user endpoint**
  - [ ] Test: `POST_CreateExternalUser_WithValidData_Returns201AndCreatesUser`
  - [ ] Test: `POST_CreateExternalUser_WithExistingEmail_Returns409`
  - [ ] Test: `POST_CreateExternalUser_WithExistingPesel_Returns409`
  - [ ] Test: `POST_CreateExternalUser_WithInvalidPesel_Returns400`
  - [ ] Test: `POST_CreateExternalUser_AsNonAdmin_Returns403`
  - [ ] Test: `POST_CreateExternalUser_CreatesAccessRequest_Automatically`
  - [ ] Test: `POST_CreateExternalUser_SendsAccountEmail`
  - [ ] Use Testcontainers for database
  - [ ] Verify user exists with correct UserType = "External"
  - [ ] Verify PESEL is encrypted in database
  - [ ] Verify AccessRequest created with "Working" status
  - [ ] Verify email is sent

- [ ] **Task 25: Write E2E test for create external user flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Click "Create User" > "Create External User"
    4. Fill form with valid data including PESEL
    5. Select "Send Setup Email" option
    6. Submit form
    7. Verify success message
    8. Verify user appears in user list with "External" type
    9. Verify access request created (if visible in UI)
    10. Verify PESEL displayed as masked (last 4 digits only)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 3.2:**
- CreateInternalUserCommand pattern established
- Password setup token functionality
- IEmailService with welcome emails
- User creation audit logging

**From Story 1.1 (External User Self-Registration):**
- External user registration flow
- PESEL encryption and masking
- Email validation
- Access request creation (Story 2.1)

**Key Differences:**
- Story 1.1: User self-registers, account is inactive until email activation
- Story 3.3: Admin creates user, account is immediately active
- Both: External users need access request workflow for permissions
- Story 3.3: No email activation needed (admin-initiated)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Logging: Serilog 3.1.1
- Encryption: .NET Data Protection API or custom AES

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── UsersController.cs (UPDATE - add CreateExternalUserAsync)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Commands/
│   │   ├── CreateExternalUserCommand.cs (CREATE)
│   │   ├── CreateExternalUserCommandHandler.cs (CREATE)
│   │   └── CreateExternalUserCommandValidator.cs (CREATE)
│   └── DTOs/
│       └── CreateUserResponse.cs (REUSE from Story 3.2)
├── Application/UknfPlatform.Application.Shared/Interfaces/
│   └── IPeselEncryptionService.cs (CREATE or REUSE from Epic 1)
├── Domain/UknfPlatform.Domain.Auth/
│   ├── Entities/
│   │   └── User.cs (UPDATE - add CreateExternal method)
│   └── Repositories/
│       └── IUserRepository.cs (UPDATE - add PeselExistsAsync)
├── Infrastructure/UknfPlatform.Infrastructure.Identity/Services/
│   └── PeselEncryptionService.cs (CREATE or REUSE from Epic 1)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/
│   └── UserRepository.cs (UPDATE)
└── Infrastructure/UknfPlatform.Infrastructure.Email/Templates/
    └── AccountCreatedExternalUserEmail.cshtml (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── users.service.ts (UPDATE - add createExternalUser)
├── features/admin/users/create-external-user/
│   ├── create-external-user.component.ts (CREATE)
│   ├── create-external-user.component.html (CREATE)
│   └── create-external-user.component.scss (CREATE)
└── shared/validators/
    └── pesel.validator.ts (CREATE - PESEL checksum validator)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table (External User Fields):**
```sql
-- Relevant fields for external users
PeselEncrypted NVARCHAR(500) NOT NULL,  -- Encrypted full PESEL
PeselLast4 NVARCHAR(4) NOT NULL,        -- Last 4 digits for display
EmployeeId NVARCHAR(50) NULL,           -- Not used for external users
UserType NVARCHAR(20) NOT NULL CHECK (UserType IN ('Internal', 'External')),
```

**PESEL Encryption:**
- Algorithm: AES-256
- Key: Stored in configuration (appsettings.json for dev, Azure Key Vault for production)
- Deterministic: Same PESEL always produces same encrypted value (for uniqueness check)
- Only last 4 digits visible in UI

**AccessRequests Table:**
```sql
-- Automatically created for external users
CREATE TABLE AccessRequests (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    Status NVARCHAR(20) NOT NULL CHECK (Status IN ('Working', 'New', 'Accepted', 'Blocked', 'Updated')),
    SubmittedDate DATETIME2 NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    ...
);
```

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** POST `/api/admin/users/external`
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "firstName": "Jan",
    "lastName": "Kowalski",
    "pesel": "12345678901",
    "email": "jan.kowalski@entity.com",
    "phone": "+48123456789",
    "sendPasswordSetupEmail": true
  }
  ```
  OR with initial password:
  ```json
  {
    "firstName": "Jan",
    "lastName": "Kowalski",
    "pesel": "12345678901",
    "email": "jan.kowalski@entity.com",
    "phone": "+48123456789",
    "initialPassword": "SecureP@ssw0rd"
  }
  ```
- **Success Response (201 Created):**
  ```json
  {
    "userId": "6fa85f64-5717-4562-b3fc-2c963f66afa6",
    "email": "jan.kowalski@entity.com",
    "message": "External user created successfully. Access request created. Account email sent.",
    "welcomeEmailSent": true,
    "passwordSetupRequired": true
  }
  ```
  Headers:
  ```
  Location: /api/admin/users/6fa85f64-5717-4562-b3fc-2c963f66afa6
  ```
- **Error Responses:**
  - 400 Bad Request: Validation errors (invalid PESEL, email format, etc.)
  - 401 Unauthorized: Not authenticated
  - 403 Forbidden: Not System Administrator
  - 409 Conflict: Email or PESEL already exists

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Encrypt PESEL before storage**
   ```csharp
   // ✅ CORRECT
   var peselEncrypted = _peselEncryptionService.Encrypt(command.Pesel);
   var peselLast4 = _peselEncryptionService.GetLast4Digits(command.Pesel);
   ```

2. **Never log full PESEL**
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation("External user created {UserId} with PESEL ending {PeselLast4}", 
       userId, peselLast4);
   // ❌ WRONG
   // _logger.LogInformation("User created with PESEL {Pesel}", pesel);
   ```

3. **Check PESEL uniqueness via encrypted value**
   ```csharp
   // ✅ CORRECT
   if (await _userRepository.PeselExistsAsync(peselEncrypted))
       throw new ConflictException("PESEL already registered");
   ```

4. **Automatically create AccessRequest**
   ```csharp
   // ✅ CORRECT - After user creation
   var accessRequest = AccessRequest.CreateForUser(user.Id);
   await _accessRequestRepository.AddAsync(accessRequest);
   ```

5. **Use transaction for multi-entity creation**
   ```csharp
   // ✅ CORRECT - User + AccessRequest in one transaction
   await _unitOfWork.SaveChangesAsync(cancellationToken);
   ```

### PESEL Validation

**PESEL Structure:**
- 11 digits total
- Digits 1-2: Year (last 2 digits)
- Digits 3-4: Month (01-12 or 21-32 for year 2000+)
- Digits 5-6: Day of month
- Digits 7-10: Personal number
- Digit 11: Checksum

**Checksum Algorithm:**
```csharp
public static bool ValidatePeselChecksum(string pesel)
{
    if (pesel.Length != 11 || !pesel.All(char.IsDigit))
        return false;
    
    int[] weights = { 1, 3, 7, 9, 1, 3, 7, 9, 1, 3 };
    int sum = 0;
    
    for (int i = 0; i < 10; i++)
    {
        sum += (pesel[i] - '0') * weights[i];
    }
    
    int checksum = (10 - (sum % 10)) % 10;
    return checksum == (pesel[10] - '0');
}
```

**Frontend Validator:**
```typescript
export function peselChecksumValidator(): ValidatorFn {
  return (control: AbstractControl): ValidationErrors | null => {
    const pesel = control.value;
    
    if (!pesel || pesel.length !== 11) {
      return null; // Let required validator handle this
    }
    
    const weights = [1, 3, 7, 9, 1, 3, 7, 9, 1, 3];
    let sum = 0;
    
    for (let i = 0; i < 10; i++) {
      sum += parseInt(pesel[i]) * weights[i];
    }
    
    const checksum = (10 - (sum % 10)) % 10;
    const isValid = checksum === parseInt(pesel[10]);
    
    return isValid ? null : { peselChecksum: true };
  };
}
```

### PESEL Encryption Implementation

**Using .NET Data Protection API:**
```csharp
public class PeselEncryptionService : IPeselEncryptionService
{
    private readonly IDataProtector _protector;
    
    public PeselEncryptionService(IDataProtectionProvider provider)
    {
        _protector = provider.CreateProtector("PeselProtection");
    }
    
    public string Encrypt(string pesel)
    {
        return _protector.Protect(pesel);
    }
    
    public string Decrypt(string encryptedPesel)
    {
        return _protector.Unprotect(encryptedPesel);
    }
    
    public string GetLast4Digits(string pesel)
    {
        return pesel.Length >= 4 ? pesel.Substring(pesel.Length - 4) : pesel;
    }
}
```

**Configuration in Program.cs:**
```csharp
builder.Services.AddDataProtection()
    .PersistKeysToFileSystem(new DirectoryInfo(@"./keys"))
    .SetApplicationName("UknfPlatform");
```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 3

1. **PESEL Encryption:** Encrypt full PESEL before storing in database
2. **PESEL Display:** Only show last 4 digits in UI
3. **PESEL Uniqueness:** Check encrypted PESEL for duplicates
4. **Password Storage:** Hash passwords with bcrypt or Argon2
5. **Email Validation:** Check format and uniqueness
6. **Authorization:** Only System Administrators can create users
7. **Audit Trail:** Log all user creation actions with masked PESEL

### Email Template

**Account Creation Email:**
```html
Subject: Your UKNF Communication Platform Account

Dear {{FirstName}} {{LastName}},

An account has been created for you on the UKNF Communication Platform by a system administrator.

{{#if PasswordSetupUrl}}
To complete your account setup, please set your password by clicking the link below:
{{PasswordSetupUrl}}
This link will expire in 24 hours.
{{else}}
An initial password has been set for your account. You will be required to change it upon first login.
{{/if}}

Your Login Email: {{Email}}

IMPORTANT: Before you can access system features, you must complete your access request.

Access Request Status: Working (Draft)
Next Steps:
1. Log in to the platform: {{LoginUrl}}
2. Navigate to "My Access Request"
3. Select the entities you need access to
4. Request appropriate permissions (Reporting, Cases)
5. Submit your access request for approval

Your access request will be reviewed by UKNF employees or entity administrators.

For support, contact: support@uknf.gov.pl

Best regards,
UKNF IT Team
```

### User Creation Comparison

| Feature | Internal User (3.2) | External User (3.3) | Self-Registration (1.1) |
|---------|---------------------|---------------------|-------------------------|
| **Creator** | System Admin | System Admin | User themselves |
| **PESEL** | Not required | Required (encrypted) | Required (encrypted) |
| **Employee ID** | Optional | Not applicable | Not applicable |
| **Activation** | Immediate (Active) | Immediate (Active) | Email activation required |
| **Access Request** | Not created | Created automatically (Working) | Created after activation (Working) |
| **Role Assignment** | Immediate by admin | Via access request workflow | Via access request workflow |
| **Password** | Admin sets OR email | Admin sets OR email | User sets during activation |

### Integration with Epic 2

**AccessRequest Creation:**
- After external user is created, automatically create AccessRequest
- Status: "Working" (draft)
- No permission lines yet
- User completes request in Story 2.2
- Follows same workflow as self-registered users (Story 2.1)

**No Direct Permission Assignment:**
- Unlike internal users (Story 3.2), external users cannot receive direct role assignments
- Must go through access request workflow
- Entity Administrators or UKNF Employees approve requests
- This maintains the access control model from Epic 2

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions  
**Integration Tests:** Testcontainers 3.7.0

**Test Location:**
- Unit tests: `Tests/UknfPlatform.UnitTests/Application/Admin/CreateExternalUserCommandHandlerTests.cs`
- Integration tests: `Tests/UknfPlatform.IntegrationTests/Controllers/UsersControllerTests.cs`
- PESEL tests: `Tests/UknfPlatform.UnitTests/Infrastructure/PeselEncryptionServiceTests.cs`

**Example:**
```csharp
[Fact]
public async Task Handle_ValidCommand_CreatesExternalUserWithAccessRequest()
{
    // Arrange
    var command = new CreateExternalUserCommand
    {
        FirstName = "Jan",
        LastName = "Kowalski",
        Pesel = "12345678901",
        Email = "jan.kowalski@entity.com",
        Phone = "+48123456789",
        SendPasswordSetupEmail = true
    };
    
    _userRepositoryMock
        .Setup(r => r.EmailExistsAsync(command.Email))
        .ReturnsAsync(false);
    _userRepositoryMock
        .Setup(r => r.PeselExistsAsync(It.IsAny<string>()))
        .ReturnsAsync(false);
    
    _peselEncryptionServiceMock
        .Setup(s => s.Encrypt(command.Pesel))
        .Returns("encrypted_pesel_value");
    _peselEncryptionServiceMock
        .Setup(s => s.GetLast4Digits(command.Pesel))
        .Returns("8901");
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    result.UserId.Should().NotBeEmpty();
    
    _userRepositoryMock.Verify(r => r.AddAsync(
        It.Is<User>(u => 
            u.Email == command.Email && 
            u.UserType == UserType.External &&
            u.IsActive == true &&
            u.PeselEncrypted == "encrypted_pesel_value" &&
            u.PeselLast4 == "8901")), 
        Times.Once);
    
    _accessRequestRepositoryMock.Verify(r => r.AddAsync(
        It.Is<AccessRequest>(ar => 
            ar.UserId == result.UserId &&
            ar.Status == AccessRequestStatus.Working)),
        Times.Once);
}
```

### Additional Notes

1. **PESEL Not Required for Internal Users:** Story 3.2 creates internal users without PESEL. Story 3.3 creates external users with mandatory PESEL.

2. **Access Request Workflow:** External users created by admin follow the same access request workflow as self-registered users, ensuring consistent permission management.

3. **No Role Assignment:** Unlike internal users, external users cannot be assigned roles directly. They must request entity permissions through the access request system.

4. **PESEL Encryption Key:** Store encryption key securely:
   - Development: appsettings.json (for demo)
   - Production: Azure Key Vault, AWS Secrets Manager, or similar
   - Key rotation strategy for production

5. **PESEL Validation:** Frontend validates PESEL checksum. Backend should also validate checksum for security (never trust client).

6. **Email vs Self-Registration:** Story 1.1 allows self-registration. Story 3.3 is for cases where:
   - User doesn't have email access
   - Bulk user creation needed
   - Legacy system migration
   - Administrative override needed

7. **Duplicate Detection:** Check both email and PESEL uniqueness. Return clear error messages for each.

8. **Migration Note:** If PeselEncryptionService was created in Epic 1 (Story 1.1), reuse it. If not, create it now.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

