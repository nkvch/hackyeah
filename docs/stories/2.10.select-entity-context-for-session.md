# Story 2.10: Select Entity Context for Session

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.10  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As an** external user with permissions for multiple entities,  
**I want to** select which entity I'm representing in my current session,  
**So that** I can work in the appropriate entity context.

---

## Acceptance Criteria

1. Upon successful login, user with multiple entities sees entity selection screen
2. Entity selection shows all entities user has permissions for
3. User selects one entity to establish session context
4. Selected entity and user's role are displayed throughout the application (in header/navigation)
5. User can switch entity context without logging out (if system design allows)
6. All actions performed are associated with the selected entity
7. System logs entity selection with timestamp and user ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetUserEntitiesQuery** (AC: 2)
  - [ ] Create query to get all entities user has active permissions for
  - [ ] Return list of entities with permission types
  - [ ] Filter: IsBlocked = false, GrantedDate IS NOT NULL

- [ ] **Task 2: Create SetEntityContextCommand** (AC: 3, 7)
  - [ ] Create `SetEntityContextCommand.cs`
  - [ ] Property: EntityId
  - [ ] Store in user session or JWT claims
  - [ ] Log entity selection

- [ ] **Task 3: Update JWT to include entity context** (AC: 4, 6)
  - [ ] Add claim: "SelectedEntityId"
  - [ ] Include in token generation after entity selection
  - [ ] Middleware reads entity context from claim

- [ ] **Task 4: Create IEntityContextService** (AC: 6)
  - [ ] Service to get current entity context
  - [ ] Methods: GetCurrentEntityId(), GetCurrentEntity()
  - [ ] Used throughout application for entity-scoped operations

- [ ] **Task 5: Create REST API endpoints** (AC: 1, 3, 5)
  - [ ] GET `/api/auth/my-entities` - get user's entities
  - [ ] POST `/api/auth/select-entity` - set entity context
  - [ ] Returns new JWT token with entity claim

### Frontend Tasks

- [ ] **Task 6: Create entity selection page** (AC: 1, 2, 3)
  - [ ] Display after login if user has multiple entities
  - [ ] Show card for each entity:
    - Entity name, UKNF Code
    - Permissions (badges: Reporting, Cases, Admin)
  - [ ] "Select" button per entity
  - [ ] Skip if user has only one entity (auto-select)

- [ ] **Task 7: Store selected entity in app state** (AC: 4)
  - [ ] Store in Angular service/state
  - [ ] Include in HTTP requests where needed
  - [ ] Display in header/navigation

- [ ] **Task 8: Create entity context display in header** (AC: 4)
  - [ ] Show selected entity name in top navigation
  - [ ] Show user role for that entity
  - [ ] Example: "Bank XYZ | Entity Administrator"

- [ ] **Task 9: Implement entity switching** (AC: 5)
  - [ ] Dropdown in header to switch entity
  - [ ] Click opens entity selector
  - [ ] Confirm switch → reload with new context
  - [ ] Update JWT token

- [ ] **Task 10: Update routing guard** (AC: 1)
  - [ ] After login, check if entity selected
  - [ ] If not → redirect to entity selection
  - [ ] If yes → proceed to dashboard

### Testing Tasks

- [ ] **Task 11: Write tests**
  - [ ] Test: `GetUserEntities_MultipleEntities_ReturnsAll`
  - [ ] Test: `SetEntityContext_ValidEntity_SetsInToken`
  - [ ] Test: `EntityContext_UsedInOperations`
  - [ ] Test: `SwitchEntity_UpdatesContextSuccessfully`

---

## Dev Notes

**Entity Context Flow:**
1. User logs in (Story 1.4)
2. System checks: Does user have permissions for multiple entities?
3. Yes → Show entity selection screen
4. No (single entity) → Auto-select that entity
5. Entity ID stored in JWT claim
6. All subsequent operations use this entity context

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

