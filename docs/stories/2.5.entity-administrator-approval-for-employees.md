# Story 2.5: Entity Administrator Approval for Entity Employees

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.5  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As an** Entity Administrator,  
**I want to** review and approve access requests from employees of my entity,  
**So that** they can gain appropriate access to work with our supervised entity.

---

## Acceptance Criteria

1. Entity Administrator can view access requests for their entity only
2. Administrator sees requests from Entity Employees for their entity
3. Administrator can approve permissions for: Reporting, Cases (but not Entity Administrator permission)
4. Administrator can assign entity email address for notifications
5. Upon approval, request status changes to "Accepted"
6. Employee receives automatic email notification
7. Approved permissions are immediately active
8. If Entity has no approved Administrator, UKNF Employees handle employee requests

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Update GetAccessRequestsQuery for Entity Administrators** (AC: 1, 2)
  - [ ] Update `GetAccessRequestsQueryHandler`
  - [ ] If user is Entity Administrator:
    - Get entities where user has IsEntityAdministrator permission
    - Filter requests to only those entities
    - Exclude requests where IsEntityAdministrator is requested (can't approve admin requests)
  - [ ] Return filtered list

- [ ] **Task 2: Create ApproveEmployeePermissionCommand** (AC: 3, 4, 5, 6, 7)
  - [ ] Create `ApproveEmployeePermissionCommand.cs`
  - [ ] Properties: PermissionLineId, AccessRequestId, EntityEmail (optional)
  - [ ] Create handler
  - [ ] Handler logic:
    - Verify user is Entity Administrator for that entity
    - Verify permission line does NOT have IsEntityAdministrator = true (cannot approve admin permissions)
    - Approve permission line
    - Update EntityEmailForNotifications if provided
    - Check if all lines approved â†’ status = Accepted
    - Send email notification
    - Return success

- [ ] **Task 3: Implement authorization checks** (AC: 1, 3, 8)
  - [ ] Entity Admin can only approve for their entities
  - [ ] Entity Admin cannot approve IsEntityAdministrator permissions
  - [ ] If no Entity Admin exists, UKNF handles all approvals

- [ ] **Task 4: Create REST API endpoint for Entity Admin approval** (AC: 3, 5)
  - [ ] POST `/api/access-requests/{id}/permission-lines/{lineId}/approve-employee`
  - [ ] `[Authorize(Roles = "EntityAdministrator")]`
  - [ ] Validation: Cannot approve admin permissions

### Frontend Tasks

- [ ] **Task 5: Update access requests list for Entity Administrators** (AC: 1, 2)
  - [ ] If user role = EntityAdministrator:
    - Show only requests for their entities
    - Hide requests with Entity Administrator permissions

- [ ] **Task 6: Update details page for Entity Administrators** (AC: 3, 4)
  - [ ] Show approval buttons only for Reporting/Cases permissions
  - [ ] For Entity Administrator permission: Show "Requires UKNF approval" message
  - [ ] Add optional entity email input when approving

- [ ] **Task 7: Create approval UI** (AC: All)
  - [ ] Permission line approval button
  - [ ] Optional entity email input field
  - [ ] Disable approval for Entity Administrator permissions
  - [ ] Show appropriate messages

### Testing Tasks

- [ ] **Task 8: Write unit tests**
  - [ ] Test: `EntityAdmin_CanApprove_ReportingAndCases`
  - [ ] Test: `EntityAdmin_CannotApprove_EntityAdministrator`
  - [ ] Test: `EntityAdmin_CanOnlyApprove_TheirEntities`

- [ ] **Task 9: Write integration tests**
  - [ ] Test: `POST_ApproveEmployee_EntityAdmin_Returns200`
  - [ ] Test: `POST_ApproveAdminPermission_EntityAdmin_Returns403`

- [ ] **Task 10: Write E2E test**
  - [ ] Test complete Entity Admin approval workflow

---

## Dev Notes

**Key Business Rule:** Entity Administrators can only approve Reporting and Cases permissions for their entities. Entity Administrator permissions require UKNF Employee approval.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

