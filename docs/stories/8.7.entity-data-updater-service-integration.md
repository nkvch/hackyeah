# Story 8.7: Entity Data Updater Service Integration

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.7  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As the** system,  
**I want to** synchronize entity data with the external UKNF Entity Database,  
**So that** entity information remains accurate and up-to-date.

---

## Acceptance Criteria

1. System integrates with external UKNF Entity Database (Entity Data Updater service)
2. Integration supports:
   - **Pull updates**: System periodically fetches entity data updates from Entity Database
   - **Push updates**: System sends verified entity changes back to Entity Database
3. System can be configured for update frequency (e.g., nightly, weekly)
4. When entity data is updated from Entity Database:
   - System creates new version of entity record
   - Previous version is archived
   - Change is recorded in entity change history
   - Changed by is marked as "Entity Data Updater Service"
5. When external user reports data change (Story 8.5) and UKNF verifies:
   - UKNF Employee updates entity in system
   - System pushes verified update to Entity Database (if configured)
6. Integration logs all synchronization events
7. Integration handles errors gracefully (connection failures, data validation errors)
8. System Administrator can view sync logs and status

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create IEntityDataUpdaterService interface** (AC: 1, 2)
  - [ ] Create `IEntityDataUpdaterService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Methods:
    - `PullUpdatesAsync(): Task<EntityUpdateResult>` - fetch updates from external database
    - `PushUpdateAsync(entityId, changes): Task<bool>` - send verified changes to external database
    - `GetSyncStatusAsync(): Task<SyncStatus>` - get current sync status
    - `TriggerManualSyncAsync(): Task<EntityUpdateResult>` - trigger manual sync

- [ ] **Task 2: Create EntityDataUpdaterService implementation** (AC: 1, 2, 3)
  - [ ] Create `EntityDataUpdaterService.cs` in `Infrastructure/UknfPlatform.Infrastructure.Integration/Services/`
  - [ ] Inject HttpClient, IEntityRepository, IEntityChangeHistoryRepository, ILogger
  - [ ] Implement PullUpdatesAsync:
    - Connect to external Entity Database API
    - Fetch entity updates since last sync
    - Map external entity data to domain entity
    - Update entities in system
    - Create change history entries
    - Mark change source as "Entity Data Updater Service"
  - [ ] Implement PushUpdateAsync:
    - Send entity changes to external database
    - Handle response
    - Log push event

- [ ] **Task 3: Create EntityUpdateResult DTO** (AC: 6)
  - [ ] Create `EntityUpdateResult.cs`
  - [ ] Properties:
    - TotalEntitiesChecked (int)
    - EntitiesUpdated (int)
    - EntitiesCreated (int)
    - Errors (List<string>)
    - SyncDate (DateTime)
    - Success (bool)

- [ ] **Task 4: Create SyncStatus DTO** (AC: 8)
  - [ ] Create `SyncStatus.cs`
  - [ ] Properties:
    - LastSyncDate (DateTime?)
    - LastSyncSuccess (bool)
    - NextScheduledSync (DateTime?)
    - IsRunning (bool)
    - LastError (string?)

- [ ] **Task 5: Create entity versioning logic** (AC: 4)
  - [ ] Extend Entity domain entity with version tracking
  - [ ] Archive previous version on update
  - [ ] Store version history in EntityVersions table
  - [ ] Link versions via VersionChain

- [ ] **Task 6: Create scheduled sync job** (AC: 3)
  - [ ] Use Hangfire or Quartz.NET for scheduling
  - [ ] Create `EntityDataSyncJob.cs`
  - [ ] Configurable schedule (cron expression)
  - [ ] Execute PullUpdatesAsync on schedule
  - [ ] Log job execution

- [ ] **Task 7: Create sync event logging** (AC: 6)
  - [ ] Create EntitySyncLog entity
  - [ ] Properties:
    - Id, SyncDate, SyncType (Pull/Push), Success, EntitiesAffected, ErrorMessage, Duration
  - [ ] Log all sync operations
  - [ ] Store in database for audit

- [ ] **Task 8: Implement error handling** (AC: 7)
  - [ ] Try-catch around external API calls
  - [ ] Retry logic for transient failures
  - [ ] Log all errors
  - [ ] Continue processing other entities if one fails
  - [ ] Send alert to administrators on repeated failures

- [ ] **Task 9: Create REST API endpoints** (AC: 8)
  - [ ] GET /api/admin/entity-sync/status
  - [ ] POST /api/admin/entity-sync/trigger (manual sync)
  - [ ] GET /api/admin/entity-sync/logs (sync history)
  - [ ] Add `[Authorize]` with System Administrator role check
  - [ ] Add Swagger documentation

- [ ] **Task 10: Create database migrations** (AC: 4, 6)
  - [ ] Create EntityVersions table
  - [ ] Create EntitySyncLogs table
  - [ ] Add indexes for performance

### Frontend Tasks

- [ ] **Task 11: Create entity-sync-status component** (AC: 8)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/entity-sync-status/entity-sync-status.component.ts`
  - [ ] Configure routing: `/admin/entity-sync` (System Admin only)
  - [ ] Display current sync status
  - [ ] Show last sync date, success/failure
  - [ ] Display sync logs table
  - [ ] Add "Trigger Manual Sync" button

- [ ] **Task 12: Implement manual sync trigger** (AC: 8)
  - [ ] Button to trigger manual sync
  - [ ] Show loading indicator during sync
  - [ ] Display sync results
  - [ ] Refresh status after sync

- [ ] **Task 13: Display sync logs** (AC: 8)
  - [ ] Table with sync history
  - [ ] Columns: Date, Type, Success, Entities Affected, Duration, Errors
  - [ ] Implement pagination
  - [ ] Filter by success/failure

### Testing Tasks

- [ ] **Task 14: Write unit tests**
  - [ ] Test: PullUpdatesAsync fetches and processes updates
  - [ ] Test: Entity versioning creates new versions
  - [ ] Test: Change history records sync source
  - [ ] Test: Error handling logs failures
  - [ ] Mock external API

- [ ] **Task 15: Write integration tests**
  - [ ] Test: Scheduled sync job executes
  - [ ] Test: Manual sync trigger works
  - [ ] Test: Sync logs are created
  - [ ] Test: Entity versions are archived
  - [ ] Use mock external API

---

## Dev Notes

### External API Integration

**API Contract (to be defined with external UKNF Entity Database team):**
- Authentication: API key or OAuth
- Endpoints:
  - GET /api/entities/updates?since={timestamp} - get updates
  - POST /api/entities/{uknfCode} - push verified changes
- Data format: JSON
- Rate limiting: Consider API quotas

### Versioning Strategy

- Each sync creates new version if data changed
- Version chain links all versions of an entity
- Archived versions retained for audit
- Current version always has IsCurrentVersion = true

### Scheduling

Use Hangfire for background job scheduling:
```csharp
RecurringJob.AddOrUpdate<EntityDataSyncJob>(
    "entity-data-sync",
    job => job.ExecuteAsync(),
    Cron.Daily(2)  // Run at 2 AM daily
);
```

### Error Handling

- **Connection Failures**: Retry with exponential backoff
- **Data Validation Errors**: Log and skip entity, continue with others
- **Authentication Errors**: Alert administrators immediately
- **Rate Limiting**: Respect API limits, throttle requests

### Security

- Store API credentials securely (Azure Key Vault, AWS Secrets Manager)
- Use HTTPS for all external API calls
- Validate external data before updating entities
- Audit all sync operations

### Performance

- Fetch incremental updates only (since last sync)
- Batch entity updates
- Process updates asynchronously
- Don't block user operations during sync

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

