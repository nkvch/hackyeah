# Story 8.14: Search and Filter Q&A

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.14  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** User,  
**I want to** search and filter Q&A,  
**So that** I can quickly find relevant answers.

---

## Acceptance Criteria

1. User can search Q&A by keywords (searches title, content, answer text)
2. Search highlights matching terms in results
3. User can filter by: Category, Tags
4. User can sort results by:
   - Relevance (for search results)
   - Date added (newest/oldest)
   - Popularity (most viewed)
   - Rating (highest/lowest)
5. Filter and sort selections are preserved during browsing
6. Search results show excerpts with highlighted keywords
7. Empty search/filter results show helpful message and suggestion to ask question
8. Search supports partial matches and basic stemming (e.g., "report" matches "reporting")

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Enhance GetPublishedQuestionsQuery for search** (AC: 1, 8)
  - [ ] Update `GetPublishedQuestionsQuery.cs`
  - [ ] Add SearchKeyword parameter
  - [ ] Implement full-text search on: Title, Content, Answer
  - [ ] Use database full-text search (PostgreSQL: to_tsvector and to_tsquery)
  - [ ] Support partial matching
  - [ ] Implement basic stemming (database-level)
  - [ ] Calculate relevance score

- [ ] **Task 2: Add tag filtering** (AC: 3)
  - [ ] Add TagsFilter parameter (list of tags)
  - [ ] Filter questions that have any of the specified tags
  - [ ] Support multiple tag selection

- [ ] **Task 3: Implement sorting options** (AC: 4)
  - [ ] Add SortBy enum: Relevance, DateNewest, DateOldest, Popularity, RatingHighest, RatingLowest
  - [ ] Implement sorting logic:
    - Relevance: Order by search relevance score (only for searches)
    - DateNewest: Order by PublishedDate desc
    - DateOldest: Order by PublishedDate asc
    - Popularity: Order by ViewCount desc
    - RatingHighest: Order by (RatingSum/RatingCount) desc
    - RatingLowest: Order by (RatingSum/RatingCount) asc

- [ ] **Task 4: Add excerpt generation** (AC: 6)
  - [ ] For search results, generate excerpt around matching keyword
  - [ ] Add Excerpt property to SearchResultDto
  - [ ] Highlight matching terms with markers (e.g., `<mark>keyword</mark>`)
  - [ ] Limit excerpt length (e.g., 200 characters)

- [ ] **Task 5: Create SearchResultDto** (AC: 2, 6)
  - [ ] Create `SearchResultDto.cs`
  - [ ] Properties: Id, Title, Excerpt, Category, Tags, PublicationDate, AverageRating, HighlightedTitle
  - [ ] HighlightedTitle/Excerpt contain `<mark>` tags around matches

- [ ] **Task 6: Update REST API endpoint** (AC: 1, 3, 4)
  - [ ] Update GET /api/qa/faq
  - [ ] Query parameters: search, category, tags, sortBy, page, pageSize
  - [ ] Return search results with excerpts when search provided
  - [ ] Return regular list when no search

### Frontend Tasks

- [ ] **Task 7: Add search input** (AC: 1)
  - [ ] Add search input to FAQ list page (Story 8.13)
  - [ ] Prominent placement at top
  - [ ] Placeholder: "Search questions and answers..."
  - [ ] Debounce input (300ms)
  - [ ] Trigger search on input change

- [ ] **Task 8: Display search results** (AC: 2, 6)
  - [ ] Show search results with excerpts
  - [ ] Highlight matching keywords in title and excerpt
  - [ ] Use `<mark>` tag or custom highlighting style (yellow background)
  - [ ] Show "Search results for: [keyword]" header
  - [ ] Show result count

- [ ] **Task 9: Implement tag filter** (AC: 3)
  - [ ] Add tag filter component
  - [ ] Show popular tags as chips or checkboxes
  - [ ] Allow selecting multiple tags
  - [ ] Update results on tag selection
  - [ ] Show selected tags with remove option

- [ ] **Task 10: Implement sort dropdown** (AC: 4)
  - [ ] Dropdown with sort options:
    - "Most Relevant" (only when searching)
    - "Newest First"
    - "Oldest First"
    - "Most Popular"
    - "Highest Rated"
    - "Lowest Rated"
  - [ ] Update results on sort change
  - [ ] Default: Relevance (for search) or Newest (for browse)

- [ ] **Task 11: Preserve filter/sort state** (AC: 5)
  - [ ] Store filter/sort selections in URL query parameters
  - [ ] Restore state from URL on page load
  - [ ] Update URL when filters change
  - [ ] Allow sharing filtered/sorted view via URL

- [ ] **Task 12: Handle empty results** (AC: 7)
  - [ ] Empty state component
  - [ ] Message: "No results found for '[keyword]'"
  - [ ] Suggestions:
    - "Try different keywords"
    - "Browse all categories"
    - "Ask a new question" (button to Story 8.9)
  - [ ] Show popular Q&A as alternatives

### Testing Tasks

- [ ] **Task 13: Write unit tests**
  - [ ] Test: Search finds Q&A with matching keywords
  - [ ] Test: Partial matches work
  - [ ] Test: Tag filtering works
  - [ ] Test: Sorting works for all options
  - [ ] Test: Excerpt generation highlights keywords

- [ ] **Task 14: Write integration tests**
  - [ ] Test: GET /api/qa/faq?search=keyword returns matching Q&A
  - [ ] Test: Search with multiple filters works
  - [ ] Test: Sorting applies correctly
  - [ ] Test: Empty search returns all Q&A

---

## Dev Notes

### Full-Text Search

**PostgreSQL:**
```sql
-- Create text search index
CREATE INDEX idx_questions_search ON questions 
USING gin(to_tsvector('english', title || ' ' || content || ' ' || answer));

-- Search query
SELECT * FROM questions 
WHERE to_tsvector('english', title || ' ' || content || ' ' || answer) 
@@ to_tsquery('english', 'report & validation');
```

**Entity Framework:**
```csharp
query = query.Where(q => 
    EF.Functions.ToTsVector("english", q.Title + " " + q.Content + " " + q.Answer)
    .Matches(EF.Functions.ToTsQuery("english", searchKeyword)));
```

### Relevance Scoring

- Use database's ranking functions (PostgreSQL: ts_rank)
- Prioritize title matches over content matches
- Boost recent Q&A in relevance calculation

### Performance

- Index searchable fields for fast queries
- Cache popular searches
- Implement search result pagination
- Consider Elasticsearch for advanced search (future enhancement)

### User Experience

- Show "Searching..." loading indicator
- Debounce search input to reduce API calls
- Highlight matching keywords for easy scanning
- Provide clear feedback for empty results
- Make filters easily accessible but not intrusive

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

