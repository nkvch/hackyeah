# Story 4.9: Archive Reports

**Epic:** 4 - Reporting System  
**Story Number:** 4.9  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee,  
**I want to** mark reports as archival,  
**So that** I can separate current reports from historical ones.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.9

1. UKNF Employee can select one or multiple reports
2. Employee can use "Archive Report" action
3. Archived reports are marked with archival status
4. Archived reports remain accessible but are separated in UI
5. Default view shows only current (non-archived) reports
6. User can toggle view to include or show only archived reports
7. Archive action is logged with timestamp and employee ID
8. Archiving doesn't modify report data or validation status

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Update Report entity with archive methods** (AC: 3, 8)
  - [ ] Update Report.cs domain entity (already has IsArchived field from Story 4.1)
  - [ ] Add domain methods:
    - `Archive(userId)`: Set IsArchived = true, validate can be archived
    - `Unarchive(userId)`: Set IsArchived = false
    - `CanBeArchived(): bool` - business rules check
  - [ ] Validate: Archiving doesn't change ValidationStatus (AC 8)

- [ ] **Task 2: Create ArchiveReportCommand** (AC: 2)
  - [ ] Create `ArchiveReportCommand.cs` in `Application/UknfPlatform.Application.Communication/Reports/Commands/`
  - [ ] Command properties:
    - ReportId (Guid, required)
  - [ ] Note: Single report archiving

- [ ] **Task 3: Create ArchiveReportCommandHandler** (AC: 2, 3, 7, 8)
  - [ ] Create `ArchiveReportCommandHandler.cs` implementing `IRequestHandler<ArchiveReportCommand, ArchiveReportResponse>`
  - [ ] Inject dependencies: IReportRepository, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Verify user is UKNF employee
    - Fetch report by ID
    - Verify report can be archived
    - Call domain method: `report.Archive(userId)`
    - Verify IsArchived = true, ValidationStatus unchanged (AC 8)
    - Save changes
    - Create audit log entry (AC 7)
    - Return success response
  - [ ] Use transaction

- [ ] **Task 4: Create BulkArchiveReportsCommand** (AC: 1, 2)
  - [ ] Create `BulkArchiveReportsCommand.cs`
  - [ ] Command properties:
    - ReportIds (List<Guid>, required)
  - [ ] Handler: Same as Task 3 but for multiple reports
  - [ ] Create audit log for bulk operation with count

- [ ] **Task 5: Create UnarchiveReportCommand** (AC: 2, 4, 6)
  - [ ] Create `UnarchiveReportCommand.cs`
  - [ ] Command properties:
    - ReportId (Guid, required)
  - [ ] Handler: Similar to ArchiveReportCommandHandler but calls `report.Unarchive(userId)`
  - [ ] Allow unarchiving to restore report to current view

- [ ] **Task 6: Create BulkUnarchiveReportsCommand** (AC: 1, 2)
  - [ ] Create `BulkUnarchiveReportsCommand.cs`
  - [ ] Command properties:
    - ReportIds (List<Guid>, required)
  - [ ] Handler: Unarchive multiple reports

- [ ] **Task 7: Create REST API endpoint POST /api/admin/reports/{id}/archive** (AC: 2)
  - [ ] Update ReportsController or AdminReportsController
  - [ ] Add `[Authorize]` + UKNF employee check
  - [ ] Create POST action `ArchiveReportAsync(Guid id)`
  - [ ] Send ArchiveReportCommand via MediatR
  - [ ] Return 200 OK
  - [ ] Return 404 if report not found
  - [ ] Return 403 if not UKNF employee

- [ ] **Task 8: Create REST API endpoint POST /api/admin/reports/bulk-archive** (AC: 1, 2)
  - [ ] Create POST action `BulkArchiveReportsAsync([FromBody] BulkArchiveRequest request)`
  - [ ] Request body: `{ "reportIds": [...] }`
  - [ ] Return 200 OK with count of archived reports
  - [ ] Handle partial failures gracefully

- [ ] **Task 9: Create REST API endpoint POST /api/admin/reports/{id}/unarchive** (AC: 4, 6)
  - [ ] Create POST action `UnarchiveReportAsync(Guid id)`
  - [ ] Send UnarchiveReportCommand
  - [ ] Return 200 OK

- [ ] **Task 10: Create REST API endpoint POST /api/admin/reports/bulk-unarchive** (AC: 1)
  - [ ] Create POST action `BulkUnarchiveReportsAsync([FromBody] BulkUnarchiveRequest request)`
  - [ ] Request body: `{ "reportIds": [...] }`
  - [ ] Return 200 OK with count

- [ ] **Task 11: Update GetReportsListForUknfQuery to handle archival filter** (AC: 5, 6)
  - [ ] Update handler from Story 4.6
  - [ ] IsArchived filter parameter already exists from Story 4.6
  - [ ] Default behavior: IsArchived = false (show only current) - AC 5
  - [ ] If IsArchived = null, show all reports
  - [ ] If IsArchived = true, show only archived reports

- [ ] **Task 12: Create audit log entries** (AC: 7)
  - [ ] After archive action, create AuditLog entry
  - [ ] AuditLog properties:
    - UserId = current UKNF employee
    - EntityType = "Report"
    - EntityPrimaryKey = report ID
    - Action = "ArchiveReport"
    - Timestamp = DateTime.UtcNow
    - Metadata = JSON with ArchivedBy (user name)
  - [ ] After unarchive, log with Action = "UnarchiveReport"
  - [ ] For bulk operations, log with Action = "BulkArchiveReports" and count

- [ ] **Task 13: Verify validation status unchanged** (AC: 8)
  - [ ] In archive domain method, add assertion:
    ```csharp
    public void Archive(Guid userId)
    {
        var previousStatus = this.ValidationStatus; // Capture before
        this.IsArchived = true;
        this.UpdatedDate = DateTime.UtcNow;
        // Validate ValidationStatus unchanged
        if (this.ValidationStatus != previousStatus)
            throw new DomainException("Archiving must not modify validation status");
    }
    ```
  - [ ] Add unit tests to verify

### Frontend Tasks

- [ ] **Task 14: Update reports service** (AC: 2)
  - [ ] Update `reports.service.ts`
  - [ ] Methods:
    - `archiveReport(reportId): Observable<void>`
    - `bulkArchiveReports(reportIds): Observable<BulkArchiveResponse>`
    - `unarchiveReport(reportId): Observable<void>`
    - `bulkUnarchiveReports(reportIds): Observable<BulkUnarchiveResponse>`

- [ ] **Task 15: Add "Archive" action to reports list** (AC: 1, 2)
  - [ ] Update uknf-reports-list component from Story 4.6
  - [ ] Add "Archive" bulk action button/menu
  - [ ] User selects one or multiple reports (AC 1)
  - [ ] Click "Archive" button
  - [ ] Show confirmation dialog: "Archive X report(s)?"
  - [ ] On confirm, call reportsService.bulkArchiveReports()
  - [ ] Show success message: "X reports archived successfully"

- [ ] **Task 16: Add "Unarchive" action** (AC: 4, 6)
  - [ ] Add "Unarchive" bulk action (visible when viewing archived reports)
  - [ ] User selects archived reports
  - [ ] Click "Unarchive" button
  - [ ] Confirmation dialog
  - [ ] On confirm, call reportsService.bulkUnarchiveReports()
  - [ ] Show success message

- [ ] **Task 17: Implement archive toggle in UI** (AC: 5, 6)
  - [ ] Add "Show Archived" toggle/dropdown in filters panel
  - [ ] Options:
    - "Current Reports Only" (default) - IsArchived = false
    - "Archived Reports Only" - IsArchived = true
    - "All Reports" - IsArchived = null
  - [ ] On change, reload reports with filter
  - [ ] Use PrimeNG Dropdown or ToggleButton

- [ ] **Task 18: Display archival status indicator** (AC: 3, 4)
  - [ ] In reports table, show archival indicator for archived reports
  - [ ] Options:
    - Badge/tag: "Archived"
    - Different row background color (light gray)
    - Icon: 📦 or archive icon
  - [ ] Make visually distinct from current reports
  - [ ] Tooltip: "This report is archived"

- [ ] **Task 19: Update report details to show archival status** (AC: 3, 4)
  - [ ] Update report-details component from Story 4.3
  - [ ] Show "Archived" badge if IsArchived = true
  - [ ] If UKNF employee, show "Unarchive" button
  - [ ] Clarify: "Archived reports remain accessible but are separated from current reports"

- [ ] **Task 20: Add confirmation dialogs** (AC: 2)
  - [ ] Archive confirmation: "Are you sure you want to archive X report(s)? They will be moved to the archived view."
  - [ ] Unarchive confirmation: "Are you sure you want to unarchive X report(s)? They will be restored to current reports."
  - [ ] Use PrimeNG ConfirmDialog component

- [ ] **Task 21: Update default view to exclude archived** (AC: 5)
  - [ ] In uknf-reports-list component, set default filter
  - [ ] On component init: `filters.isArchived = false` (show only current)
  - [ ] Load reports with this default
  - [ ] Show info message: "Showing current reports only. Toggle to view archived."

- [ ] **Task 22: Handle empty states** (AC: 4, 5, 6)
  - [ ] If no current reports: "No current reports found"
  - [ ] If no archived reports: "No archived reports found"
  - [ ] Provide toggle to switch view

### Testing Tasks

- [ ] **Task 23: Write unit tests for ArchiveReportCommandHandler**
  - [ ] Test: `Handle_ValidReport_ArchivesSuccessfully` (AC 2, 3)
  - [ ] Test: `Handle_ReportNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_ExternalUserAttempt_ThrowsForbiddenException`
  - [ ] Test: `Handle_CreatesAuditLog` (AC 7)
  - [ ] Test: `Handle_ValidationStatusUnchanged` (AC 8)
  - [ ] Mock: IReportRepository, ICurrentUserService

- [ ] **Task 24: Write unit tests for Report domain methods**
  - [ ] Test: `Archive_ValidReport_SetsIsArchivedTrue` (AC 3)
  - [ ] Test: `Archive_DoesNotChangeValidationStatus` (AC 8)
  - [ ] Test: `Unarchive_ArchivedReport_SetsIsArchivedFalse`

- [ ] **Task 25: Write integration test for archive endpoint**
  - [ ] Test: `POST_ArchiveReport_ValidRequest_Returns200` (AC 2)
  - [ ] Test: `POST_BulkArchiveReports_MultipleReports_Returns200` (AC 1, 2)
  - [ ] Test: `POST_ArchiveReport_UknfEmployee_Returns200`
  - [ ] Test: `POST_ArchiveReport_ExternalUser_Returns403`
  - [ ] Verify IsArchived = true in database (AC 3)
  - [ ] Verify ValidationStatus unchanged (AC 8)
  - [ ] Verify audit log created (AC 7)

- [ ] **Task 26: Write integration test for unarchive endpoint**
  - [ ] Test: `POST_UnarchiveReport_ArchivedReport_Returns200` (AC 4, 6)
  - [ ] Test: `POST_BulkUnarchiveReports_MultipleReports_Returns200`
  - [ ] Verify IsArchived = false after unarchiving

- [ ] **Task 27: Write integration test for filtered views**
  - [ ] Test: `GET_Reports_DefaultFilter_ReturnsOnlyCurrent` (AC 5)
  - [ ] Test: `GET_Reports_ArchivedFilter_ReturnsOnlyArchived` (AC 6)
  - [ ] Test: `GET_Reports_AllFilter_ReturnsAll` (AC 6)
  - [ ] Create test data with archived and current reports
  - [ ] Verify correct reports returned for each filter

- [ ] **Task 28: Write E2E test for archive flow**
  - [ ] Test workflow:
    1. Login as UKNF employee
    2. Navigate to Reports
    3. Verify default view shows only current reports (AC 5)
    4. Select a report
    5. Click "Archive" button (AC 2)
    6. Confirm archive action
    7. Verify report disappears from current view (AC 4)
    8. Toggle to "Archived Reports Only" (AC 6)
    9. Verify archived report appears
    10. Verify "Archived" badge displayed (AC 3)
    11. Select archived report
    12. Click "Unarchive" button
    13. Confirm unarchive action
    14. Toggle back to "Current Reports Only"
    15. Verify report reappears
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.1:**
- Report entity already has IsArchived field (bool, default false)
- Field included in database schema

**From Story 4.6:**
- UKNF reports list supports IsArchived filter
- Default behavior: show current reports only
- This story adds the UI actions and backend commands

**Key Integration:**
- Story 4.6 provides the filtered view infrastructure
- This story adds archive/unarchive actions
- Report details (Story 4.3) shows archival status

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (ConfirmDialog, ToggleButton, Dropdown)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AdminReportsController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Reports/Commands/
│   ├── ArchiveReportCommand.cs (CREATE)
│   ├── ArchiveReportCommandHandler.cs (CREATE)
│   ├── BulkArchiveReportsCommand.cs (CREATE)
│   ├── BulkArchiveReportsCommandHandler.cs (CREATE)
│   ├── UnarchiveReportCommand.cs (CREATE)
│   ├── UnarchiveReportCommandHandler.cs (CREATE)
│   ├── BulkUnarchiveReportsCommand.cs (CREATE)
│   └── BulkUnarchiveReportsCommandHandler.cs (CREATE)
└── Domain/UknfPlatform.Domain.Communication/Entities/
    └── Report.cs (UPDATE - add Archive/Unarchive methods)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
└── features/admin/uknf-reports-list/
    ├── uknf-reports-list.component.ts (UPDATE)
    └── uknf-reports-list.component.html (UPDATE)
```

### Data Models

**Report Entity:**
- IsArchived field already exists from Story 4.1
- Add domain methods: Archive(), Unarchive()
- No schema changes needed

### REST API Specification

**Endpoint 1:** POST `/api/admin/reports/{id}/archive`
- **Security:** UKNF employees only
- **Request:** Empty body
- **Response (200 OK):**
  ```json
  {
    "message": "Report archived successfully"
  }
  ```

**Endpoint 2:** POST `/api/admin/reports/bulk-archive`
- **Security:** UKNF employees only
- **Request:**
  ```json
  {
    "reportIds": ["guid1", "guid2", "guid3"]
  }
  ```
- **Response (200 OK):**
  ```json
  {
    "archivedCount": 3,
    "message": "3 reports archived successfully"
  }
  ```

**Endpoint 3:** POST `/api/admin/reports/{id}/unarchive`
- **Security:** UKNF employees only
- **Response (200 OK):**
  ```json
  {
    "message": "Report unarchived successfully"
  }
  ```

**Endpoint 4:** POST `/api/admin/reports/bulk-unarchive`
- **Security:** UKNF employees only
- **Request:** Same as bulk-archive
- **Response (200 OK):**
  ```json
  {
    "unarchivedCount": 3,
    "message": "3 reports unarchived successfully"
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use domain methods (AC 3)**
   ```csharp
   // ✅ CORRECT
   report.Archive(userId);
   
   // ❌ WRONG
   // report.IsArchived = true;
   ```

2. **Validate validation status unchanged (AC 8)**
   ```csharp
   // ✅ CORRECT - Domain method enforces rule
   public void Archive(Guid userId)
   {
       var previousStatus = this.ValidationStatus;
       this.IsArchived = true;
       this.UpdatedDate = DateTime.UtcNow;
       
       // AC 8: Archiving doesn't modify validation status
       if (this.ValidationStatus != previousStatus)
           throw new DomainException("Archiving must not change validation status");
   }
   ```

3. **Audit logging (AC 7)**
   ```csharp
   // ✅ CORRECT
   await _auditService.LogAsync(new AuditLog
   {
       Action = "ArchiveReport",
       EntityType = "Report",
       EntityPrimaryKey = reportId,
       UserId = currentUserId,
       Timestamp = DateTime.UtcNow,
       Metadata = new { ArchivedBy = currentUser.Name }
   });
   ```

4. **Default filter (AC 5)**
   ```csharp
   // ✅ CORRECT - Default to current reports only
   public async Task<PagedResult<ReportListItemDto>> Handle(GetReportsListForUknfQuery request, ...)
   {
       var isArchived = request.IsArchived ?? false; // Default to false (current only)
       
       var query = _context.Reports
           .Where(r => r.IsArchived == isArchived);
       
       // ...
   }
   ```

5. **Bulk operations with transaction**
   ```csharp
   // ✅ CORRECT
   foreach (var reportId in command.ReportIds)
   {
       var report = await _reportRepository.GetByIdAsync(reportId);
       report.Archive(userId);
   }
   
   await _unitOfWork.SaveChangesAsync(); // Single transaction
   ```

### UI/UX Considerations

**Archival Status Display:**
```html
<tr [ngClass]="{'bg-gray-100': report.isArchived}">
  <td>
    <span *ngIf="report.isArchived" class="text-xs text-gray-600 ml-2">
      <i class="pi pi-archive"></i> Archived
    </span>
  </td>
  <!-- ... other columns -->
</tr>
```

**Archive Filter Dropdown:**
```html
<p-dropdown 
  [options]="archiveFilterOptions" 
  [(ngModel)]="filters.isArchived"
  (onChange)="loadReports()"
  placeholder="Show Current Reports">
</p-dropdown>

<!-- Component: -->
archiveFilterOptions = [
  { label: 'Current Reports Only', value: false },  // Default (AC 5)
  { label: 'Archived Reports Only', value: true },
  { label: 'All Reports', value: null }
];
```

**Bulk Actions:**
```html
<button 
  pButton 
  label="Archive" 
  icon="pi pi-archive"
  (click)="archiveSelected()"
  [disabled]="selectedReports.length === 0 || showingArchivedOnly">
</button>

<button 
  pButton 
  label="Unarchive" 
  icon="pi pi-replay"
  (click)="unarchiveSelected()"
  [disabled]="selectedReports.length === 0 || !showingArchivedOnly">
</button>
```

### Business Rules

1. **Archiving is Reversible:** Unlike deletion, archiving can be undone (AC 4, 6)
2. **Archival is Status-Agnostic:** Can archive reports with any validation status (AC 8)
3. **Accessibility Preserved:** Archived reports remain fully accessible, just separated (AC 4)
4. **Default View:** System defaults to showing current reports for better UX (AC 5)
5. **Bulk Operations:** Support bulk archiving for admin efficiency (AC 1)

### Security Requirements

- Only UKNF employees can archive/unarchive reports
- External users cannot archive (no access to action)
- All archive actions logged for audit (AC 7)
- Archived reports still respect same authorization rules (entity access)

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- IsArchived indexed in database (from Story 4.1 schema)
- Default filter (IsArchived = false) uses index efficiently
- Bulk operations in single transaction (minimize DB round-trips)
- Archival doesn't trigger expensive operations (just flag update)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Archive sets IsArchived = true
- Unarchive sets IsArchived = false
- Validation status unchanged (AC 8)
- Audit logging (AC 7)
- Default filter shows current only (AC 5)
- Toggle filter works correctly (AC 6)
- Bulk operations work
- External user denied access

**Example:**
```csharp
[Fact]
public async Task Handle_ArchiveReport_ValidationStatusUnchanged()
{
    // Arrange - AC 8: Archiving doesn't modify validation status
    var report = CreateTestReport(validationStatus: ValidationStatus.Successful);
    await _context.Reports.AddAsync(report);
    await _context.SaveChangesAsync();
    
    var command = new ArchiveReportCommand { ReportId = report.Id };
    
    // Act
    await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    var archivedReport = await _context.Reports.FindAsync(report.Id);
    archivedReport.IsArchived.Should().BeTrue();
    archivedReport.ValidationStatus.Should().Be(ValidationStatus.Successful); // Unchanged
}
```

### Additional Notes

1. **Archive vs. Delete:** Archiving is soft/logical separation, not deletion. Reports remain in database and accessible.

2. **Use Cases for Archiving:**
   - End of reporting period (e.g., archive all Q1 2024 reports after Q2 2024)
   - Regulatory retention periods (keep old reports but separate from current)
   - Decluttering current view while preserving history

3. **Automatic Archiving:** Future enhancement could auto-archive reports after X months. Not in current scope.

4. **Archival and Registers:** Archived reports can still belong to registers. Archival is orthogonal to register organization.

5. **Search in Archived:** When showing archived reports, search should still work. IsArchived filter doesn't exclude other filters.

6. **Export Archived:** Export function should respect archival filter - can export current only, archived only, or all.

7. **Corrections of Archived:** Can submit corrections for archived reports. Correction is current (not archived by default).

8. **Unarchive Workflow:** Typical workflow: UKNF employee reviews archived reports, finds one needing action, unarchives to bring back to current view.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

