# Story 7.6: Confirm Reading High-Priority Announcements

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.6  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As an** External User,  
**I want to** confirm I have read high-priority announcements,  
**So that** UKNF knows I am aware of critical information.

---

## Acceptance Criteria

1. When user opens High-priority announcement, system presents "Confirm Reading" button
2. User must click confirmation to acknowledge reading
3. Confirmation records: User ID, Announcement ID, Entity represented (if user represents multiple), Timestamp
4. Confirmation displays user's name and entity name in confirmation record
5. User cannot dismiss High-priority announcement without confirming (or can dismiss but it remains flagged as unread)
6. Confirmation is logged in system
7. UKNF Employees can view who confirmed reading (Story 7.9)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create AnnouncementReadConfirmation entity** (AC: 3, 4, 6)
  - [ ] Create `AnnouncementReadConfirmation.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - AnnouncementId (Guid, required)
    - UserId (Guid, required)
    - EntityId (long?, nullable) - entity user was representing when confirmed
    - ConfirmedDate (DateTime, required)
    - UserFullName (string, required) - denormalized for reporting
    - EntityName (string?, nullable) - denormalized for reporting
  - [ ] Unique constraint: (AnnouncementId, UserId)

- [ ] **Task 2: Create database migration for AnnouncementReadConfirmations table** (AC: 3, 4, 6)
  - [ ] Create EF Core migration: `Add_AnnouncementReadConfirmations_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE AnnouncementReadConfirmations (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        AnnouncementId UUID NOT NULL,
        UserId UUID NOT NULL,
        EntityId BIGINT NULL,
        ConfirmedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        UserFullName NVARCHAR(200) NOT NULL,
        EntityName NVARCHAR(500) NULL,
        
        FOREIGN KEY (AnnouncementId) REFERENCES Announcements(Id),
        FOREIGN KEY (UserId) REFERENCES Users(Id),
        FOREIGN KEY (EntityId) REFERENCES Entities(Id),
        UNIQUE (AnnouncementId, UserId),
        INDEX IX_AnnouncementReadConfirmations_AnnouncementId (AnnouncementId),
        INDEX IX_AnnouncementReadConfirmations_UserId (UserId)
    );
    ```

- [ ] **Task 3: Create ConfirmAnnouncementReadingCommand** (AC: 1, 2, 3)
  - [ ] Create `ConfirmAnnouncementReadingCommand.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Commands/`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)
    - EntityId (long?, nullable) - entity context user is in
    - UserId (Guid, optional, defaults to current user)

- [ ] **Task 4: Create ConfirmAnnouncementReadingCommandHandler** (AC: 2, 3, 4, 6)
  - [ ] Create `ConfirmAnnouncementReadingCommandHandler.cs`
  - [ ] Inject dependencies: IAnnouncementReadConfirmationRepository, IAnnouncementRepository, ICurrentUserService, IUserRepository, IEntityRepository, ILogger
  - [ ] Handler logic:
    - Load announcement
    - Verify announcement is High priority
    - Verify user is recipient
    - Get user's full name
    - If EntityId provided, get entity name
    - Check if confirmation already exists
    - If not exists, create AnnouncementReadConfirmation
    - Set ConfirmedDate = DateTime.UtcNow
    - Save confirmation
    - Also mark announcement as read (if not already)
    - Log confirmation
    - Return success response

- [ ] **Task 5: Update GetAnnouncementDetailQuery to include confirmation status** (AC: 1)
  - [ ] Update `GetAnnouncementDetailQueryHandler` from Story 7.5
  - [ ] Check if user has confirmed reading (for High-priority announcements)
  - [ ] Add IsConfirmed property to AnnouncementDetailDto
  - [ ] Add RequiresConfirmation property (true if High priority)

- [ ] **Task 6: Create REST API endpoint POST /api/announcements/{id}/confirm-reading** (AC: 2)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `ConfirmAnnouncementReadingAsync(Guid id, [FromBody] ConfirmReadingRequest request)`
  - [ ] Request body: { entityId?: number }
  - [ ] Return 200 OK with confirmation record
  - [ ] Return 404 if announcement not found
  - [ ] Return 403 if user is not recipient
  - [ ] Return 400 if announcement is not High priority
  - [ ] Idempotent: OK if already confirmed

### Frontend Tasks

- [ ] **Task 7: Update announcement detail component to show confirmation prompt** (AC: 1, 5)
  - [ ] Update `announcement-detail.component.ts` from Story 7.5
  - [ ] If announcement.priority === 'High' and !announcement.isConfirmed
  - [ ] Show prominent confirmation banner or modal:
    - Message: "This is a high-priority announcement. Please confirm that you have read and understood this information."
    - "I confirm I have read this announcement" button
  - [ ] Disable/hide "Back" button until confirmed (optional, based on AC 5)
  - [ ] Or: Allow back but keep announcement flagged as unread

- [ ] **Task 8: Implement entity context selection for confirmation** (AC: 3, 4)
  - [ ] If user represents multiple entities, show entity dropdown in confirmation prompt
  - [ ] "Please select the entity you are representing:"
  - [ ] User selects entity
  - [ ] Send entityId in confirmation request
  - [ ] If user has only one entity, auto-select and hide dropdown

- [ ] **Task 9: Implement confirmReading service method** (AC: 2)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `confirmReading(announcementId: string, entityId?: number): Observable<void>`
  - [ ] Call POST `/api/announcements/{id}/confirm-reading`
  - [ ] Handle errors

- [ ] **Task 10: Handle confirmation success** (AC: 2, 5)
  - [ ] On success (200):
    - Hide confirmation prompt
    - Update announcement.isConfirmed = true
    - Show success message: "Thank you for confirming"
    - Enable "Back" button (if it was disabled)
  - [ ] On error (400): Display error message
  - [ ] On error (403): Display "Access denied"

- [ ] **Task 11: Style confirmation prompt** (AC: 1)
  - [ ] Use prominent, attention-grabbing design:
    - Modal dialog (blocks rest of page), OR
    - Fixed banner at top (red/yellow background)
  - [ ] Clear message about importance
  - [ ] Large, clear "Confirm" button
  - [ ] If entity selection required, show dropdown prominently

- [ ] **Task 12: Show confirmation required indicator in announcement list** (AC: 5)
  - [ ] Update `announcements-list.component.ts` from Story 7.4
  - [ ] For High-priority announcements that are unconfirmed, show special indicator:
    - "CONFIRMATION REQUIRED" badge (red)
    - Keep announcement bold/highlighted until confirmed
  - [ ] Sort unconfirmed High-priority announcements to top

### Testing Tasks

- [ ] **Task 13: Write unit tests for ConfirmAnnouncementReadingCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidHighPriorityAnnouncement_CreatesConfirmation`
  - [ ] Test: `Handle_LowPriorityAnnouncement_ThrowsBadRequestException`
  - [ ] Test: `Handle_UserNotRecipient_ThrowsForbiddenException`
  - [ ] Test: `Handle_AlreadyConfirmed_Idempotent`
  - [ ] Test: `Handle_WithEntityContext_RecordsEntity`
  - [ ] Test: `Handle_LogsConfirmation`
  - [ ] Test: `Handle_AlsoMarksAsRead`
  - [ ] Mock: IAnnouncementReadConfirmationRepository, IAnnouncementRepository, IUserRepository, IEntityRepository, ILogger

- [ ] **Task 14: Write integration test for confirmation**
  - [ ] Test: `POST_ConfirmReading_HighPriorityAnnouncement_Returns200AndCreatesConfirmation`
  - [ ] Test: `POST_ConfirmReading_LowPriorityAnnouncement_Returns400`
  - [ ] Test: `POST_ConfirmReading_UserNotRecipient_Returns403`
  - [ ] Test: `POST_ConfirmReading_WithEntityContext_RecordsEntity`
  - [ ] Test: `GET_AnnouncementDetail_HighPriority_IncludesConfirmationStatus`
  - [ ] Use Testcontainers
  - [ ] Verify confirmation record created in database
  - [ ] Verify confirmation includes user and entity names

---

## Dev Notes

### High-Priority Announcement Flow

1. **User opens High-priority announcement** (Story 7.5)
2. **Announcement detail shows confirmation prompt** (this story)
3. **User clicks "I confirm I have read this announcement"**
4. **System records confirmation** with user, entity, timestamp
5. **Prompt disappears**, announcement marked as confirmed
6. **UKNF Employee can view confirmation statistics** (Story 7.9)

### Entity Context

If user represents multiple entities:
- User must select which entity they're representing when confirming
- This is important for audit and compliance
- If user has only one entity, auto-select

### Confirmation vs. Read

**Read (Story 7.5):**
- Automatic when user views announcement
- Tracked in `AnnouncementReads` table
- For all announcements (any priority)

**Confirmation (this story):**
- Manual, requires explicit user action
- Tracked in `AnnouncementReadConfirmations` table
- Only for High-priority announcements
- Records entity context

### Idempotency

Confirmation endpoint is idempotent:
- If user already confirmed, return 200 OK (don't create duplicate)
- Unique constraint: (AnnouncementId, UserId)

### UI/UX Considerations

**Option 1: Modal Dialog (Recommended)**
- Blocks entire page until confirmed
- User cannot dismiss without confirming
- Clear focus on importance

**Option 2: Banner**
- Fixed banner at top of announcement
- User can still read content
- Banner persists until confirmed

**Option 3: Soft Prompt**
- Confirmation button at bottom of announcement
- User can navigate away but announcement stays unread
- Less intrusive but may be missed

### Dependencies

**Prerequisites:**
- **Story 7.5**: Read Announcement Details (confirmation happens on detail page)
- **Story 7.3**: Publish Announcement (High-priority announcements exist)

**Integrates With:**
- **Story 7.9**: Monitor Announcement Readership (UKNF views confirmation stats)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

