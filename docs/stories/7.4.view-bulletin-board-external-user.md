# Story 7.4: View Bulletin Board (External User)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.4  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As an** External User,  
**I want to** view announcements on the bulletin board,  
**So that** I stay informed about important communications from UKNF.

---

## Acceptance Criteria

1. User can access "Bulletin Board" or "Announcements" section
2. User sees all announcements addressed to them (based on recipient configuration)
3. Announcements are displayed with: Title, Category, Priority, Publication date, Excerpt
4. New/unread announcements are marked with indicator (e.g., "NEW", bold text, badge)
5. Announcements are sorted by: Priority (High first), then Publication date (newest first)
6. User can filter by: Category, Priority, Read/Unread status
7. User can search by: Title, Content
8. Bulletin board displays on start page/homepage with recent announcements
9. Expired announcements are automatically hidden from view
10. User can access archive view to see expired announcements

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetAnnouncementsForUserQuery** (AC: 2, 3, 5, 9)
  - [ ] Create `GetAnnouncementsForUserQuery.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Queries/`
  - [ ] Query properties:
    - UserId (Guid, optional, defaults to current user)
    - CategoryFilter (string?, nullable)
    - PriorityFilter (string?, nullable)
    - ReadStatusFilter (string?, nullable) - "All", "Read", "Unread"
    - SearchText (string?, nullable)
    - PageNumber (int, default 1)
    - PageSize (int, default 20)
    - IncludeExpired (bool, default false)

- [ ] **Task 2: Create GetAnnouncementsForUserQueryHandler** (AC: 2, 3, 5, 9)
  - [ ] Create `GetAnnouncementsForUserQueryHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, IRecipientCalculator, ICurrentUserService
  - [ ] Handler logic:
    - Get current user ID
    - Get user's entity IDs and entity types
    - Query announcements where:
      - Status = Published
      - (ExpirationDate IS NULL OR ExpirationDate > now) if !IncludeExpired
      - User is in recipient list (complex query based on RecipientConfiguration)
    - Apply filters: Category, Priority, SearchText
    - Sort by: Priority DESC, PublicationDate DESC
    - Paginate results
    - For each announcement, check if user has read it
    - Return AnnouncementListDto with read status

- [ ] **Task 3: Optimize announcement query for recipients** (AC: 2)
  - [ ] Create efficient SQL query to check if user is recipient
  - [ ] Options:
    - Denormalize recipients into `AnnouncementRecipients` table during publish
    - Or: Calculate on-the-fly using JSON query on RecipientConfiguration
  - [ ] **Recommendation:** Denormalize for performance
  - [ ] Create `AnnouncementRecipients` table:
    ```sql
    CREATE TABLE AnnouncementRecipients (
        Id BIGINT IDENTITY(1,1) PRIMARY KEY,
        AnnouncementId UUID NOT NULL,
        RecipientType NVARCHAR(20) NOT NULL, -- 'User' or 'Contact'
        UserId UUID NULL,
        ContactEmail NVARCHAR(256) NULL,
        CreatedDate DATETIME2 NOT NULL,
        FOREIGN KEY (AnnouncementId) REFERENCES Announcements(Id),
        INDEX IX_AnnouncementRecipients_UserId (UserId),
        INDEX IX_AnnouncementRecipients_AnnouncementId (AnnouncementId)
    );
    ```
  - [ ] Populate this table when announcement is published (in AnnouncementPublishedEventHandler)

- [ ] **Task 4: Create AnnouncementListDto** (AC: 3, 4)
  - [ ] Create `AnnouncementListDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Title (string)
    - Excerpt (string) - first 200 chars of content
    - Category (string)
    - Priority (string)
    - PublicationDate (DateTime)
    - ExpirationDate (DateTime?)
    - IsRead (bool)
    - HasAttachments (bool)

- [ ] **Task 5: Create REST API endpoint GET /api/announcements** (AC: 1, 6, 7)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetAnnouncementsAsync([FromQuery] GetAnnouncementsForUserQuery query)`
  - [ ] Return 200 OK with paginated list of announcements
  - [ ] Support query parameters: category, priority, readStatus, searchText, pageNumber, pageSize, includeExpired

- [ ] **Task 6: Create GetRecentAnnouncementsQuery** (AC: 8)
  - [ ] Create `GetRecentAnnouncementsQuery.cs`
  - [ ] Query properties: UserId, TopCount (default 5)
  - [ ] Handler returns top N most recent unread announcements
  - [ ] Used for homepage widget

- [ ] **Task 7: Create REST API endpoint GET /api/announcements/recent** (AC: 8)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetRecentAnnouncementsAsync([FromQuery] int count = 5)`
  - [ ] Return top 5 most recent unread announcements
  - [ ] Used for homepage/start page display

### Frontend Tasks

- [ ] **Task 8: Create announcements list component** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/announcements/announcements-list/announcements-list.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/announcements` with auth guard
  - [ ] Load announcements via announcementsService.getAnnouncements()
  - [ ] Display announcements in list/card layout
  - [ ] Show: Title, Excerpt, Category, Priority, Publication date
  - [ ] Mark unread announcements with "NEW" badge or bold text
  - [ ] Highlight High-priority announcements (red border or background)

- [ ] **Task 9: Implement filtering** (AC: 6)
  - [ ] Add filter controls: Category dropdown, Priority dropdown, Read/Unread toggle
  - [ ] On filter change, reload announcements with filter parameters
  - [ ] Show active filters with chips (removable)
  - [ ] "Clear all filters" button

- [ ] **Task 10: Implement search** (AC: 7)
  - [ ] Add search input field
  - [ ] Debounce search input (300ms)
  - [ ] On search change, reload announcements with searchText parameter
  - [ ] Highlight search term in results (optional)

- [ ] **Task 11: Implement pagination** (AC: 2)
  - [ ] Use PrimeNG Paginator component
  - [ ] Show page numbers, prev/next buttons
  - [ ] Default page size: 20
  - [ ] On page change, load new page

- [ ] **Task 12: Implement sorting** (AC: 5)
  - [ ] Default sort: Priority (High first), then Publication date (newest first)
  - [ ] Backend handles sorting, frontend just displays

- [ ] **Task 13: Create announcement list item component** (AC: 3, 4)
  - [ ] Create `announcement-list-item.component.ts`
  - [ ] Input: announcement (AnnouncementListDto)
  - [ ] Display:
    - Priority badge (color-coded: High=red, Medium=yellow, Low=gray)
    - "NEW" badge if unread
    - Title (bold if unread)
    - Excerpt
    - Category tag
    - Publication date
    - Attachment icon if hasAttachments
  - [ ] Click: Navigate to announcement detail (Story 7.5)
  - [ ] Style with Tailwind CSS

- [ ] **Task 14: Implement archive view** (AC: 10)
  - [ ] Add "View Archive" button/link
  - [ ] Navigate to `/announcements/archive` or toggle `includeExpired` flag
  - [ ] Show expired announcements
  - [ ] Mark expired announcements with "EXPIRED" badge

- [ ] **Task 15: Create homepage announcements widget** (AC: 8)
  - [ ] Create `recent-announcements-widget.component.ts`
  - [ ] Display on start page/homepage
  - [ ] Load via announcementsService.getRecentAnnouncements(5)
  - [ ] Show top 5 recent unread announcements
  - [ ] Compact display: Title, Priority badge, "NEW" indicator
  - [ ] "View all announcements" link to full bulletin board

- [ ] **Task 16: Style announcements list** (AC: 1, 4, 7)
  - [ ] Page title: "Bulletin Board" or "Announcements"
  - [ ] Breadcrumb: Home / Announcements
  - [ ] Filter bar at top
  - [ ] Search bar
  - [ ] Announcement list (cards or table)
  - [ ] Responsive design
  - [ ] Empty state: "No announcements found"
  - [ ] Loading state: Skeleton or spinner

### Testing Tasks

- [ ] **Task 17: Write unit tests for GetAnnouncementsForUserQueryHandler** (AC: All)
  - [ ] Test: `Handle_ReturnsAnnouncementsForUser`
  - [ ] Test: `Handle_ExcludesExpiredAnnouncements`
  - [ ] Test: `Handle_IncludesExpiredWhenRequested`
  - [ ] Test: `Handle_FiltersbyCategory`
  - [ ] Test: `Handle_FiltersByPriority`
  - [ ] Test: `Handle_FiltersByReadStatus`
  - [ ] Test: `Handle_SearchesByTitle`
  - [ ] Test: `Handle_SortsByPriorityThenDate`
  - [ ] Test: `Handle_MarksReadAnnouncements`
  - [ ] Mock: IAnnouncementRepository, ICurrentUserService

- [ ] **Task 18: Write integration test for get announcements**
  - [ ] Test: `GET_Announcements_ReturnsUserAnnouncements`
  - [ ] Test: `GET_Announcements_ExcludesAnnouncementsForOtherUsers`
  - [ ] Test: `GET_Announcements_ExcludesExpiredByDefault`
  - [ ] Test: `GET_Announcements_Filters_ReturnsFilteredResults`
  - [ ] Test: `GET_Announcements_Search_ReturnsMatchingAnnouncements`
  - [ ] Use Testcontainers
  - [ ] Seed test data with various announcements and recipients
  - [ ] Verify filtering, search, pagination work correctly

---

## Dev Notes

### Recipient Matching Logic

User sees announcement if:
1. RecipientConfiguration.IncludeAllUsers = true, OR
2. User's entity ID is in RecipientConfiguration.SelectedEntityIds, OR
3. User's entity type is in RecipientConfiguration.SelectedEntityTypes, OR
4. User's ID is in RecipientConfiguration.SelectedUserIds, OR
5. User is member of a contact group in RecipientConfiguration.SelectedContactGroupIds

### Performance Optimization

**Denormalize recipients:**
When announcement is published, calculate all recipients and store in `AnnouncementRecipients` table. This avoids complex JSON queries on every list request.

**Query:**
```sql
SELECT a.* 
FROM Announcements a
INNER JOIN AnnouncementRecipients ar ON a.Id = ar.AnnouncementId
WHERE ar.UserId = @currentUserId
  AND a.Status = 'Published'
  AND (a.ExpirationDate IS NULL OR a.ExpirationDate > GETUTCDATE())
ORDER BY 
  CASE a.Priority 
    WHEN 'High' THEN 1
    WHEN 'Medium' THEN 2
    WHEN 'Low' THEN 3
  END,
  a.PublicationDate DESC
```

### Read Status Indicator

Join with `AnnouncementReads` table to determine if user has read announcement:
```sql
LEFT JOIN AnnouncementReads ar2 ON a.Id = ar2.AnnouncementId AND ar2.UserId = @currentUserId
```

If `ar2.Id IS NULL`, announcement is unread → show "NEW" badge.

### Homepage Widget

Display top 5 most recent **unread** announcements on user's start page.

### Dependencies

**Prerequisites:**
- **Story 7.3**: Publish Announcement (published announcements must exist)
- **Epic 1**: Authentication (authenticated users)

**Blocks:**
- **Story 7.5**: Read Announcement Details (user clicks to view detail)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

