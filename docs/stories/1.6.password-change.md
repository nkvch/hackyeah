# Story 1.6: Password Change

**Epic:** 1 - Authentication & User Registration  
**Story Number:** 1.6  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As an** authenticated external user,  
**I want to** change my password,  
**So that** I can maintain account security.

---

## Acceptance Criteria

1. Password change form requires current password verification
2. New password must meet system password policy requirements
3. New password cannot match current password
4. New password cannot match passwords in history (based on password policy configuration)
5. Password strength indicator is displayed
6. Successful password change invalidates current session and requires re-login
7. User receives email notification of password change
8. System logs password change event with timestamp

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ChangePasswordCommand and Handler** (AC: 1, 2, 3, 4, 6, 8)
  - [ ] Create `ChangePasswordCommand.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] Command properties: CurrentPassword, NewPassword, NewPasswordConfirmation
  - [ ] Create `ChangePasswordCommandHandler.cs`
  - [ ] Handler logic:
    - Get authenticated user ID from context
    - Retrieve user from repository
    - Verify current password using IPasswordHasher
    - If current password incorrect, throw `InvalidCurrentPasswordException`
    - Validate new password meets policy (use PasswordPolicy from Story 1.3)
    - Check new password != current password (hash comparison)
    - Check new password not in password history (last N passwords)
    - Hash new password using IPasswordHasher
    - Update user.PasswordHash
    - Update user.LastPasswordChangeDate = DateTime.UtcNow
    - Add old password to PasswordHistory
    - Save changes
    - Send password change notification email
    - Revoke all user's refresh tokens (force re-login)
    - Log password change event
    - Return success response
  - [ ] Inject: IUserRepository, IPasswordHasher, IPasswordHistoryRepository, IRefreshTokenRepository, IEmailService, ILogger

- [ ] **Task 2: Create FluentValidation validator for ChangePasswordCommand** (AC: 2)
  - [ ] Create `ChangePasswordCommandValidator.cs`
  - [ ] Validate CurrentPassword: NotEmpty
  - [ ] Validate NewPassword: NotEmpty, meets PasswordPolicy requirements (reuse from Story 1.3)
  - [ ] Validate NewPasswordConfirmation: Equal to NewPassword
  - [ ] Inject PasswordPolicy settings for validation

- [ ] **Task 3: Create ChangePasswordResponse DTO** (AC: 6)
  - [ ] Create `ChangePasswordResponse.cs` record
  - [ ] Properties: Success (bool), Message (string), RequiresRelogin (bool = true)

- [ ] **Task 4: Create REST API endpoint POST /auth/change-password** (AC: All)
  - [ ] Add action to `AuthController.cs`: `ChangePasswordAsync(ChangePasswordCommand command)`
  - [ ] `[Authorize]` attribute (requires authentication)
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with ChangePasswordResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 401 Unauthorized if current password incorrect
  - [ ] Return 400 Bad Request if new password matches current
  - [ ] Return 400 Bad Request if new password in history
  - [ ] Success message: "Password changed successfully. Please log in again."
  - [ ] Add Swagger documentation

- [ ] **Task 5: Create password change notification email template** (AC: 7)
  - [ ] Create `PasswordChangedEmail.cshtml` in email templates folder
  - [ ] Template content:
    - "Your password was changed"
    - User's name
    - Timestamp of change
    - IP address (optional)
    - "If you didn't make this change, contact support immediately"
    - Support contact information
  - [ ] Responsive HTML design

- [ ] **Task 6: Implement session invalidation** (AC: 6)
  - [ ] After password change, revoke all user's refresh tokens
  - [ ] Mark all RefreshTokens for user as IsRevoked = true
  - [ ] This forces user to re-login on all devices
  - [ ] Log revocation action

- [ ] **Task 7: Reuse password policy validation from Story 1.3** (AC: 2, 4)
  - [ ] Use existing PasswordPolicy value object
  - [ ] Use existing PasswordHistory entity and repository
  - [ ] Use existing IPasswordHasher service
  - [ ] Ensure consistency with password creation (Story 1.3)

### Frontend Tasks

- [ ] **Task 8: Create change password page component** (AC: 1, 2, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/profile/change-password/change-password.component.ts`
  - [ ] Standalone Angular component or child of profile
  - [ ] Configure routing: `/profile/change-password` (requires authentication)
  - [ ] Apply auth guard to route

- [ ] **Task 9: Create change password form** (AC: 1, 2, 3, 5)
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - currentPassword (password input, required)
    - newPassword (password input, required)
    - newPasswordConfirmation (password input, required)
  - [ ] Add validators:
    - currentPassword: Validators.required
    - newPassword: Validators.required, password policy validators (async)
    - newPasswordConfirmation: Validators.required, matchPassword validator
  - [ ] Show/Hide password toggles for all fields
  - [ ] Display validation errors below each field

- [ ] **Task 10: Reuse password strength component from Story 1.3** (AC: 5)
  - [ ] Use existing PasswordStrengthComponent
  - [ ] Display for newPassword field
  - [ ] Show real-time strength as user types
  - [ ] Display password policy requirements checklist

- [ ] **Task 11: Add changePassword method to AuthService** (AC: 6)
  - [ ] Add method `changePassword(currentPassword, newPassword, newPasswordConfirmation): Observable<ChangePasswordResponse>`
  - [ ] Call POST `/api/auth/change-password`
  - [ ] Handle response and errors

- [ ] **Task 12: Implement form submission logic** (AC: 6, 7)
  - [ ] On form submit:
    - Show loading spinner
    - Call authService.changePassword()
    - On success (200):
      - Show success message: "Password changed successfully!"
      - Show information: "You will be logged out. Please log in with your new password."
      - Wait 3 seconds
      - Call authService.logout() to clear tokens
      - Redirect to login page
    - On error (401 Current Password Incorrect):
      - Display error on currentPassword field: "Current password is incorrect"
    - On error (400 Policy Violation):
      - Display validation errors on newPassword field
    - On error (400 Password in History):
      - Display: "You cannot reuse a recent password"
  - [ ] Disable submit button while loading or form invalid

- [ ] **Task 13: Create change password page UI** (AC: 1, 2, 5)
  - [ ] Use main layout or profile layout
  - [ ] Page title: "Change Password"
  - [ ] Security notice: "Choose a strong password to protect your account"
  - [ ] Current password field
  - [ ] New password field with strength indicator
  - [ ] Password requirements checklist (from Story 1.3)
  - [ ] Confirm new password field
  - [ ] Submit button: "Change Password"
  - [ ] Cancel button (navigate back to profile)
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 14: Add change password link to profile page** (AC: 1)
  - [ ] In profile page (Story 1.5), add "Change Password" button or link
  - [ ] Place in security section
  - [ ] Icon: lock or shield
  - [ ] Navigate to `/profile/change-password`

### Testing Tasks

- [ ] **Task 15: Write unit tests for ChangePasswordCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidPasswordChange_UpdatesPasswordSuccessfully`
  - [ ] Test: `Handle_IncorrectCurrentPassword_ThrowsInvalidCurrentPasswordException`
  - [ ] Test: `Handle_NewPasswordSameAsCurrent_ThrowsValidationException`
  - [ ] Test: `Handle_NewPasswordInHistory_ThrowsValidationException`
  - [ ] Test: `Handle_WeakNewPassword_ThrowsValidationException`
  - [ ] Test: `Handle_PasswordChange_AddsToPasswordHistory`
  - [ ] Test: `Handle_PasswordChange_UpdatesLastPasswordChangeDate`
  - [ ] Test: `Handle_PasswordChange_RevokesAllRefreshTokens`
  - [ ] Test: `Handle_PasswordChange_SendsNotificationEmail`
  - [ ] Test: `Handle_PasswordChange_LogsEvent`
  - [ ] Mock: IUserRepository, IPasswordHasher, IPasswordHistoryRepository, IRefreshTokenRepository, IEmailService, ILogger

- [ ] **Task 16: Write integration tests for password change** (AC: All)
  - [ ] Test: `POST_ChangePassword_ValidRequest_Returns200AndChangesPassword`
  - [ ] Test: `POST_ChangePassword_IncorrectCurrentPassword_Returns401`
  - [ ] Test: `POST_ChangePassword_NewPasswordInHistory_Returns400`
  - [ ] Test: `POST_ChangePassword_RevokesRefreshTokens`
  - [ ] Test: `POST_ChangePassword_Unauthenticated_Returns401`
  - [ ] Verify password is hashed in database
  - [ ] Verify PasswordHistory entry created
  - [ ] Verify LastPasswordChangeDate updated
  - [ ] Use Testcontainers for database

- [ ] **Task 17: Write E2E test for password change**
  - [ ] Test workflow:
    1. Login as user
    2. Navigate to profile
    3. Click "Change Password"
    4. Enter current password
    5. Enter new valid password
    6. Confirm new password
    7. Submit form
    8. Verify success message
    9. Verify redirected to login
    10. Login with new password
    11. Verify successful login
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 1.3:**
- PasswordPolicy value object with validation
- PasswordHistory entity to prevent reuse
- IPasswordHasher service (Argon2/BCrypt)
- Password strength calculation
- PasswordStrengthComponent (reusable)

**From Story 1.4:**
- JWT authentication with refresh tokens
- RefreshToken entity and repository
- Session management

**From Story 1.5:**
- User profile management
- Email notification infrastructure

**Key Integration:**
- Reuses password policy from Story 1.3
- Reuses password hashing from Story 1.3
- Reuses password history from Story 1.3
- Revokes refresh tokens from Story 1.4
- Sends email notification

### REST API Specification

**Endpoint:** POST `/api/auth/change-password`
- **Security:** Requires authentication (JWT token)
- **Request:**
  ```json
  {
    "currentPassword": "MyOldP@ssw0rd!",
    "newPassword": "MyNewP@ssw0rd!",
    "newPasswordConfirmation": "MyNewP@ssw0rd!"
  }
  ```
- **Success (200 OK):**
  ```json
  {
    "success": true,
    "message": "Password changed successfully. Please log in again.",
    "requiresRelogin": true
  }
  ```
- **Errors:**
  - 401: Current password incorrect or user not authenticated
  - 400: Validation errors (policy violations, password in history, passwords match)

### Security Requirements

1. **Current Password Verification:** Must verify before allowing change
2. **Password Policy:** Same requirements as Story 1.3
3. **Password History:** Check against last N passwords (configurable)
4. **Session Invalidation:** Revoke all refresh tokens after change
5. **Email Notification:** Alert user of password change (security)
6. **Audit Logging:** Log all password change attempts

### User Experience

**Change Password Flow:**
1. User navigates to Change Password page from profile
2. Enters current password
3. Enters new password (sees strength indicator)
4. Confirms new password
5. Clicks "Change Password"
6. Success message displayed
7. "You will be logged out in 3 seconds..."
8. Auto-logout and redirect to login
9. User logs in with new password

**Why Force Re-Login:**
- Security best practice
- Invalidates all sessions on all devices
- User confirms new password works
- Prevents confusion if password change fails silently

### Coding Standards

1. **Never Log Passwords:**
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation("Password changed for user {UserId}", userId);
   ```

2. **Revoke All Refresh Tokens:**
   ```csharp
   // ✅ CORRECT - Force re-login on all devices
   await _refreshTokenRepository.RevokeAllForUserAsync(userId);
   ```

3. **Verify Current Password:**
   ```csharp
   // ✅ CORRECT - Use IPasswordHasher
   if (!_passwordHasher.VerifyPassword(command.CurrentPassword, user.PasswordHash))
   {
       throw new InvalidCurrentPasswordException("Current password is incorrect");
   }
   ```

### Additional Notes

1. **Password History:** Reuses infrastructure from Story 1.3
2. **Email Notification:** Critical security feature (user knows if account compromised)
3. **Force Re-Login:** Best practice to ensure password change was intentional
4. **Multi-Device:** Revoking all refresh tokens logs user out everywhere
5. **Password Strength:** Reuse PasswordStrengthComponent from Story 1.3

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 1 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

