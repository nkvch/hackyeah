# Story 2.3: View and Filter Access Requests (UKNF Employee)

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.3  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As a** UKNF Employee,  
**I want to** view and filter access requests,  
**So that** I can efficiently manage and approve them.

---

## Acceptance Criteria

1. UKNF Employee can view list of all access requests with status "New" or "Updated"
2. List displays: User name, Entity, Requested permissions, Submission date, Status
3. Quick filter "My Entities" shows only requests for entities assigned to the employee
4. Quick filter "Requires Action" shows requests with status "New" or "Updated"
5. Employee can search/filter by: User name, Entity, Status, Date range
6. Employee can sort by: Submission date, Status, Entity
7. Employee can click request to view details

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetAccessRequestsQuery and Handler** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `GetAccessRequestsQuery.cs` in `Application/UknfPlatform.Application.Auth/AccessRequests/Queries/`
  - [ ] Query properties: Page, PageSize, SearchTerm, Status filter, EntityId filter, DateFrom, DateTo, SortBy, SortDirection, MyEntitiesOnly
  - [ ] Create `GetAccessRequestsQueryHandler.cs`
  - [ ] Handler logic:
    - Get authenticated user (UKNF Employee)
    - Query access requests with Status IN ('New', 'Updated', 'Accepted', 'Blocked')
    - Exclude Status = 'Working' (not visible to reviewers)
    - If MyEntitiesOnly: filter by employee's assigned entities
    - Apply search term (user name, entity name)
    - Apply filters (status, entity, date range)
    - Apply sorting
    - Include related data: User, PermissionLines with Entities
    - Map to AccessRequestListDto
    - Return paginated result
  - [ ] Inject: IAccessRequestRepository, ICurrentUserService

- [ ] **Task 2: Create AccessRequestListDto** (AC: 2)
  - [ ] Create `AccessRequestListDto.cs` record
  - [ ] Properties: Id, UserName, UserEmail, Status, SubmittedDate, Entities (list of EntitySummaryDto), RequestedPermissions (summary string), ReviewedBy, ReviewedDate

- [ ] **Task 3: Create EntitySummaryDto** (AC: 2)
  - [ ] Properties: EntityId, EntityName, UknfCode, Permissions (list: "Reporting", "Cases", "Entity Administrator")

- [ ] **Task 4: Implement "My Entities" assignment logic** (AC: 3)
  - [ ] Create UserEntityAssignment entity (junction table)
  - [ ] Properties: Id, UserId (UKNF Employee), EntityId
  - [ ] UKNF Employees assigned to specific entities they manage
  - [ ] Configuration handled in Epic 3 (Administrative Module)
  - [ ] For now: support querying by assigned entities

- [ ] **Task 5: Create REST API endpoint GET /api/access-requests** (AC: All)
  - [ ] Add action to `AccessRequestsController`: `GetAccessRequestsAsync(GetAccessRequestsQuery query)`
  - [ ] `[Authorize(Roles = "UknfEmployee")]` attribute
  - [ ] Send query via MediatR
  - [ ] Return 200 OK with paginated result
  - [ ] Add Swagger documentation with filter parameters

- [ ] **Task 6: Create GET /api/access-requests/{id} endpoint** (AC: 7)
  - [ ] Add action: `GetAccessRequestDetailsAsync(Guid id)`
  - [ ] `[Authorize(Roles = "UknfEmployee, EntityAdministrator")]`
  - [ ] Return detailed AccessRequestDto with all permission lines, attachments, user info
  - [ ] Verify employee has access (either UKNF or Entity Admin for that entity)

### Frontend Tasks

- [ ] **Task 7: Create access requests list page** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/access-requests/list/access-requests-list.component.ts`
  - [ ] Route: `/access-requests` (UKNF Employee only)
  - [ ] Apply role guard (UknfEmployee)

- [ ] **Task 8: Implement data table with PrimeNG** (AC: 2, 6)
  - [ ] Use PrimeNG Table component
  - [ ] Columns: User Name, Entities, Permissions, Status, Submitted Date, Actions
  - [ ] Enable sorting on columns
  - [ ] Enable pagination (server-side)
  - [ ] Row click navigates to details

- [ ] **Task 9: Implement quick filters** (AC: 3, 4)
  - [ ] Button bar above table:
    - "All Requests" (default)
    - "My Entities" (toggle)
    - "Requires Action" (status = New or Updated)
  - [ ] Highlight active filter
  - [ ] Update query when filter clicked

- [ ] **Task 10: Implement search and advanced filters** (AC: 5)
  - [ ] Search input for user name/entity
  - [ ] Dropdown filter for Status
  - [ ] Date range picker for submission date
  - [ ] Entity autocomplete filter
  - [ ] "Apply Filters" button
  - [ ] "Clear Filters" button

- [ ] **Task 11: Display permission badges** (AC: 2)
  - [ ] For each permission line, show entity name
  - [ ] Show permission icons/badges:
    - ðŸ“Š Reporting
    - ðŸ’¬ Cases
    - ðŸ‘¤ Entity Administrator
  - [ ] Use PrimeNG Chip or Badge components

- [ ] **Task 12: Create access request service methods**
  - [ ] Update `access-request.service.ts`
  - [ ] Add method `getAccessRequests(query): Observable<PaginatedResult<AccessRequestListDto>>`
  - [ ] Add method `getAccessRequestDetails(id): Observable<AccessRequestDto>`

- [ ] **Task 13: Create list page UI** (AC: All)
  - [ ] Page title: "Access Requests"
  - [ ] Quick filters bar
  - [ ] Search and filter controls
  - [ ] Data table with columns
  - [ ] Pagination controls
  - [ ] Status badges (color-coded)
  - [ ] Action buttons per row: "View Details", "Approve"
  - [ ] Responsive design

### Testing Tasks

- [ ] **Task 14: Write unit tests for GetAccessRequestsQueryHandler** (AC: All)
  - [ ] Test: `Handle_UknfEmployee_ReturnsNewAndUpdatedRequests`
  - [ ] Test: `Handle_ExcludesWorkingStatus`
  - [ ] Test: `Handle_MyEntitiesFilter_FiltersCorrectly`
  - [ ] Test: `Handle_SearchTerm_FiltersUserAndEntity`
  - [ ] Test: `Handle_Pagination_ReturnsCorrectPage`
  - [ ] Test: `Handle_Sorting_SortsCorrectly`
  - [ ] Mock: IAccessRequestRepository

- [ ] **Task 15: Write integration tests**
  - [ ] Test: `GET_AccessRequests_UknfEmployee_Returns200`
  - [ ] Test: `GET_AccessRequests_ExternalUser_Returns403`
  - [ ] Test: `GET_AccessRequests_MyEntities_FiltersCorrectly`
  - [ ] Test: `GET_AccessRequestDetails_ValidId_Returns200`
  - [ ] Use Testcontainers

- [ ] **Task 16: Write E2E test**
  - [ ] Test workflow:
    1. Login as UKNF Employee
    2. Navigate to Access Requests
    3. Verify list displays
    4. Click "My Entities" filter
    5. Verify filtered results
    6. Search for user name
    7. Click on request
    8. Verify details page opens
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### REST API

**GET /api/access-requests?page=1&pageSize=20&myEntitiesOnly=true&status=New**
- **Security:** Requires UknfEmployee role
- **Success (200 OK):**
```json
{
  "items": [
    {
      "id": "guid",
      "userName": "Jan Kowalski",
      "userEmail": "jan@example.com",
      "status": "New",
      "submittedDate": "2025-10-04T10:00:00Z",
      "entities": [
        {
          "entityId": 123,
          "entityName": "Bank XYZ",
          "uknfCode": "BK001",
          "permissions": ["Reporting", "Cases"]
        }
      ]
    }
  ],
  "totalCount": 45,
  "page": 1,
  "pageSize": 20
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

