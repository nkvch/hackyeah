# Story 2.4: Review and Approve Access Request (UKNF Employee)

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.4  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As a** UKNF Employee,  
**I want to** review and approve access requests for Entity Administrators,  
**So that** they can gain appropriate system access.

---

## Acceptance Criteria

1. UKNF Employee can view complete access request details
2. Employee can review: User information, Requested entities, Requested permissions, Attachments
3. Employee can communicate with user via messages within the request (add message with attachments)
4. Employee can approve individual permission lines
5. Upon approval, request status changes from "New" to "Accepted"
6. User receives automatic email notification of approval
7. Approved permissions are immediately active
8. System logs approval action with timestamp and employee ID
9. Employee can view permission line history for the user

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ApprovePermissionLineCommand and Handler** (AC: 4, 5, 6, 7, 8)
  - [ ] Create `ApprovePermissionLineCommand.cs`
  - [ ] Properties: PermissionLineId, AccessRequestId
  - [ ] Create `ApprovePermissionLineCommandHandler.cs`
  - [ ] Handler logic:
    - Get permission line by ID
    - Verify employee is UKNF Employee (authorization)
    - Call permissionLine.Grant(employeeUserId)
    - Check if all permission lines approved → change request status to "Accepted"
    - Save changes
    - Send email notification to user
    - Log approval action
    - Return success
  - [ ] Inject: IPermissionLineRepository, IAccessRequestRepository, IEmailService, ICurrentUserService, ILogger

- [ ] **Task 2: Create ApproveAllPermissionLinesCommand** (AC: 4, 5, 8)
  - [ ] Create `ApproveAllPermissionLinesCommand.cs`
  - [ ] Property: AccessRequestId
  - [ ] Create handler to approve all permission lines at once
  - [ ] Convenience method for full approval

- [ ] **Task 3: Create approval notification email template** (AC: 6)
  - [ ] Create `AccessRequestApprovedEmail.cshtml`
  - [ ] Content: "Your access request has been approved", list of entities and permissions, "You can now access the system"

- [ ] **Task 4: Update AccessRequest with approval logic** (AC: 5)
  - [ ] Add method `CheckAndUpdateStatusIfAllApproved()`
  - [ ] If all permission lines have GrantedDate → Status = Accepted, ReviewedDate = Now
  - [ ] Add property `AllPermissionsApproved` (bool)

- [ ] **Task 5: Create REST API endpoint POST /api/access-requests/{id}/permission-lines/{lineId}/approve** (AC: 4, 8)
  - [ ] Add action: `ApprovePermissionLineAsync(Guid id, Guid lineId)`
  - [ ] `[Authorize(Roles = "UknfEmployee")]`
  - [ ] Send command via MediatR
  - [ ] Return 200 OK
  - [ ] Log approval with employee ID and timestamp

- [ ] **Task 6: Create POST /api/access-requests/{id}/approve-all** (AC: 4)
  - [ ] Add action: `ApproveAllPermissionLinesAsync(Guid id)`
  - [ ] `[Authorize(Roles = "UknfEmployee")]`
  - [ ] Approve all permission lines at once

- [ ] **Task 7: Create audit log for approval** (AC: 8)
  - [ ] Log entry: "Permission approved for user {UserId}, entity {EntityId}, by employee {EmployeeId}"
  - [ ] Include: Timestamp, PermissionLineId, AccessRequestId, GrantedByUserId

### Frontend Tasks

- [ ] **Task 8: Create access request details page** (AC: 1, 2)
  - [ ] Create `access-request-details.component.ts`
  - [ ] Route: `/access-requests/:id`
  - [ ] Load request details on init

- [ ] **Task 9: Display request information** (AC: 1, 2)
  - [ ] Card: User Information (name, email, phone, PESEL masked)
  - [ ] Card: Permission Lines
    - For each entity: Name, UKNF Code
    - Permissions requested (checkboxes, read-only)
    - Entity email
    - Status: Pending or Approved
  - [ ] Card: Attachments (download links)
  - [ ] Card: Messages (from Story 2.7)
  - [ ] Card: History

- [ ] **Task 10: Implement approval actions** (AC: 4)
  - [ ] For each permission line:
    - If not approved: "Approve" button
    - If approved: Green checkmark with approver name and date
  - [ ] "Approve All" button (approves all pending lines)
  - [ ] Confirmation dialog: "Approve permissions for {entity}?"

- [ ] **Task 11: Update UI after approval** (AC: 5, 7)
  - [ ] On successful approval:
    - Update permission line status to "Approved"
    - Show success toast
    - If all approved: Show banner "All permissions approved. User has been notified."
    - Reload request details

- [ ] **Task 12: Create details page UI** (AC: All)
  - [ ] Page title: "Access Request Details"
  - [ ] Status badge at top
  - [ ] Breadcrumb navigation
  - [ ] Action buttons: "Approve All", "Back to List"
  - [ ] Use PrimeNG Cards, Buttons, DataView
  - [ ] Responsive layout

### Testing Tasks

- [ ] **Task 13: Write unit tests for ApprovePermissionLineCommandHandler**
  - [ ] Test: `Handle_ValidPermissionLine_ApprovesSuccessfully`
  - [ ] Test: `Handle_AllLinesApproved_ChangesStatusToAccepted`
  - [ ] Test: `Handle_SendsEmailNotification`
  - [ ] Test: `Handle_LogsApprovalAction`
  - [ ] Mock: IPermissionLineRepository, IAccessRequestRepository, IEmailService

- [ ] **Task 14: Write integration tests**
  - [ ] Test: `POST_ApprovePermissionLine_UknfEmployee_Returns200`
  - [ ] Test: `POST_ApprovePermissionLine_ExternalUser_Returns403`
  - [ ] Test: `POST_ApproveAll_ApprovesAllLines`
  - [ ] Test: `Approval_SendsEmailToUser`
  - [ ] Use Testcontainers

- [ ] **Task 15: Write E2E test**
  - [ ] Test workflow:
    1. Login as UKNF Employee
    2. Navigate to Access Requests
    3. Click on pending request
    4. View details
    5. Click "Approve" on permission line
    6. Confirm
    7. Verify success message
    8. Verify permission shows as approved
    9. Verify email sent
  - [ ] Use Cypress

---

## Dev Notes

### REST API

**POST /api/access-requests/{id}/permission-lines/{lineId}/approve**
- **Security:** UknfEmployee role required
- **Success (200 OK):** Empty or `{ "message": "Permission approved" }`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

