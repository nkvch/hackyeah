# Story 2.9: Manage Entity Employee Permissions (Entity Administrator)

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.9  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As an** Entity Administrator,  
**I want to** manage permissions for employees of my supervised entity,  
**So that** I can control access appropriate to their roles.

---

## Acceptance Criteria

1. Administrator can view all employees with permissions for their entity
2. Administrator can modify employee permissions (Reporting, Cases access)
3. Administrator can block employee access to the system
4. Administrator cannot modify permissions beyond their entity scope
5. Changes take effect immediately
6. Modified user receives email notification
7. System logs all permission changes with timestamp
8. Administrator can view permission change history

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetEntityEmployeesQuery** (AC: 1)
  - [ ] Create query to get all users with permissions for entity
  - [ ] Filter: EntityId = administrator's entity
  - [ ] Exclude: IsEntityAdministrator users
  - [ ] Return list with permission details

- [ ] **Task 2: Create UpdateEmployeePermissionsCommand** (AC: 2, 5, 6, 7)
  - [ ] Create `UpdateEmployeePermissionsCommand.cs`
  - [ ] Properties: UserId, EntityId, HasReportingAccess, HasCasesAccess
  - [ ] Create handler
  - [ ] Logic:
    - Verify administrator owns entity
    - Update permission line
    - Log change
    - Send notification email
    - Return success

- [ ] **Task 3: Create BlockEntityEmployeeCommand** (AC: 3, 5, 6, 7)
  - [ ] Create command
  - [ ] Properties: UserId, EntityId, Reason
  - [ ] Block employee's permissions for that entity
  - [ ] Log and notify

- [ ] **Task 4: Create REST API endpoints** (AC: 1, 2, 3)
  - [ ] GET `/api/entities/{entityId}/employees`
  - [ ] PUT `/api/entities/{entityId}/employees/{userId}/permissions`
  - [ ] POST `/api/entities/{entityId}/employees/{userId}/block`
  - [ ] All: `[Authorize(Roles = "EntityAdministrator")]`

### Frontend Tasks

- [ ] **Task 5: Create entity employees management page** (AC: 1, 2, 3)
  - [ ] List of employees with permissions for entity
  - [ ] Show current permissions (checkboxes)
  - [ ] Edit buttons to modify permissions
  - [ ] Block buttons
  - [ ] Permission change history view

- [ ] **Task 6: Implement permission editing** (AC: 2, 5)
  - [ ] Inline editing or modal dialog
  - [ ] Toggle Reporting/Cases permissions
  - [ ] Save button
  - [ ] Immediate effect after save

- [ ] **Task 7: Implement blocking** (AC: 3)
  - [ ] Block button per employee
  - [ ] Confirmation dialog with reason
  - [ ] Shows warning message
  - [ ] Updates list after blocking

### Testing Tasks

- [ ] **Task 8: Write tests**
  - [ ] Test: `UpdatePermissions_EntityAdmin_Updates200`
  - [ ] Test: `UpdatePermissions_CannotModify_OtherEntities`
  - [ ] Test: `BlockEmployee_SetsBlocked_SendsNotification`
  - [ ] Test: `GetEmployees_ReturnsOnlyForMyEntity`

---

## Dev Notes

Entity Administrators have full control over employee permissions for their entities, but cannot grant Entity Administrator permissions.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

