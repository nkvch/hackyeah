# Story 5.3: Reply to Message

**Epic:** 5 - Messaging & Cases  
**Story Number:** 5.3  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee or External User,  
**I want to** reply to messages I received,  
**So that** I can continue the conversation.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-5-messaging-cases.md` - Story 5.3

1. User can reply to any message addressed to them
2. Reply form pre-populates with original message context
3. User can add text content (required)
4. User can attach files following same rules as Story 5.1
5. Reply is threaded with original message
6. Upon sending reply, original message status changes to "Closed"
7. New reply has status set based on recipient type
8. Recipient receives email notification
9. Message thread shows complete conversation history
10. System logs reply with timestamp and user ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ReplyToMessageCommand** (AC: 1, 2, 3, 4, 5)
  - [ ] Create `ReplyToMessageCommand.cs` in `Application/UknfPlatform.Application.Communication/Messages/Commands/`
  - [ ] Command properties (from AC 2, 3, 4):
    - ParentMessageId (Guid, required) - original message being replied to - AC 1, 2
    - Body (string, required) - reply content - AC 3
    - AttachmentFiles (List<IFormFile>?, optional) - file attachments - AC 4
  - [ ] Note: Subject, recipient, context inherited from parent message

- [ ] **Task 2: Create ReplyToMessageCommandValidator** (AC: 3, 4)
  - [ ] Create `ReplyToMessageCommandValidator.cs` using FluentValidation
  - [ ] Validate ParentMessageId: NotEmpty, must exist
  - [ ] Validate Body: NotEmpty, MaxLength
  - [ ] Validate AttachmentFiles (AC 4):
    - Same rules as Story 5.1
    - Each file must have allowed extension
    - Total size ≤ 100 MB
    - If ZIP, validate unpacked size
  - [ ] Reuse file validation logic from Story 5.1

- [ ] **Task 3: Create ReplyToMessageCommandHandler** (AC: All)
  - [ ] Create `ReplyToMessageCommandHandler.cs` implementing `IRequestHandler<ReplyToMessageCommand, ReplyToMessageResponse>`
  - [ ] Inject: IMessageRepository, IFileStorageService, IVirusScanningService, ISpamDetectionService, IEmailService, ICurrentUserService, IUnitOfWork, ILogger
  - [ ] Handler logic:
    1. Get current user (replying user)
    2. Fetch parent message by ParentMessageId (AC 1, 2)
    3. Verify current user is a recipient of parent message (authorization) - AC 1
    4. Validate SPAM (reuse from Story 5.1)
    5. Process attachments (AC 4):
       - Validate file formats
       - Scan for viruses
       - Upload to file storage
    6. Determine recipient (sender of parent message becomes recipient of reply)
    7. Determine reply subject: "Re: [original subject]" if not already "Re:"
    8. Determine message status based on current user type (AC 7):
       - If current user is External User: Status = "AwaitingUknfResponse"
       - If current user is UKNF Employee: Status = "AwaitingUserResponse"
    9. Create reply Message entity:
       - Subject: "Re: [original subject]"
       - Body: command.Body
       - SenderId: current user
       - MessageStatus: determined in step 8
       - ContextType: inherited from parent - AC 2
       - ContextId: inherited from parent - AC 2
       - EntityId: inherited from parent - AC 2
       - ParentMessageId: command.ParentMessageId - AC 5
       - SentDate: DateTime.UtcNow
    10. Create MessageAttachment entities
    11. Create MessageRecipient (recipient = parent message sender)
    12. Update parent message status to "Closed" (AC 6)
    13. Save all changes via transaction
    14. Send email notification to recipient (AC 8)
    15. Log reply action (AC 10)
    16. Return ReplyToMessageResponse

- [ ] **Task 4: Update parent message status to Closed** (AC: 6)
  - [ ] In ReplyToMessageCommandHandler, after creating reply:
    ```csharp
    parentMessage.MessageStatus = MessageStatus.Closed;
    await _messageRepository.UpdateAsync(parentMessage);
    ```
  - [ ] This marks the conversation as having a response

- [ ] **Task 5: Create ReplyToMessageResponse DTO** (AC: All)
  - [ ] Create `ReplyToMessageResponse.cs` record
  - [ ] Properties:
    - ReplyMessageId (Guid)
    - ParentMessageId (Guid)
    - SentDate (DateTime)
    - RecipientName (string)
    - AttachmentCount (int)
    - Message (string) - e.g., "Reply sent successfully"

- [ ] **Task 6: Create REST API endpoint POST /api/messages/{id}/reply** (AC: All)
  - [ ] Update `MessagesController.cs`
  - [ ] Add `[Authorize]` attribute
  - [ ] Create POST action `ReplyToMessageAsync(Guid id, [FromForm] ReplyToMessageRequest request)`
  - [ ] Use `[FromForm]` for multipart/form-data (file uploads) - AC 4
  - [ ] Map id to ParentMessageId
  - [ ] Map request to ReplyToMessageCommand
  - [ ] Send command via MediatR
  - [ ] Return 201 Created with ReplyToMessageResponse
  - [ ] Return 400 if validation fails (virus, spam, size limit)
  - [ ] Return 403 if user not a recipient of parent message (AC 1)
  - [ ] Return 404 if parent message not found
  - [ ] Add XML documentation and Swagger annotations

- [ ] **Task 7: Send email notification for reply** (AC: 8)
  - [ ] Email template: "New Reply from [Sender Name]"
  - [ ] Email body includes:
    - Sender name
    - Original message subject
    - Preview of reply content
    - Link to view conversation/thread in platform
    - Context (if applicable)
  - [ ] Send to parent message sender
  - [ ] Reuse IEmailService from Story 5.1

- [ ] **Task 8: Implement audit logging for reply** (AC: 10)
  - [ ] Log to AuditLog table
  - [ ] Log details:
    - Action: "MessageReplySent"
    - UserId: Current user (replying user)
    - Timestamp: SentDate
    - Details: Reply message ID, parent message ID, recipient, context

### Frontend Tasks

- [ ] **Task 9: Update messages service** (AC: All)
  - [ ] Update `messages.service.ts`
  - [ ] Method: `replyToMessage(parentMessageId, body, files): Observable<ReplyToMessageResponse>` - AC All
  - [ ] Use HttpClient with multipart/form-data for file uploads

- [ ] **Task 10: Create reply message component** (AC: 1, 2, 3, 4)
  - [ ] Create `reply-message.component.ts` in `features/messaging/`
  - [ ] Can be dialog or inline form
  - [ ] Input: parentMessage (MessageDetailsResponse)
  - [ ] Form fields (AC 2, 3, 4):
    - Original message display (read-only) - AC 2
    - Reply body (textarea, required) - AC 3
    - File attachments (file uploader) - AC 4
  - [ ] Inject MessagesService

- [ ] **Task 11: Display original message context** (AC: 2)
  - [ ] Show original message information (pre-populated/read-only):
    - "Replying to: [Original Subject]"
    - Sender: [Sender Name]
    - Date: [Original Date]
    - Original message preview or full content (optional)
    - Context: [Case #12345, Report Q1_2025, etc.]
  - [ ] Use collapsed/expandable view for original message

- [ ] **Task 12: Implement reply body field** (AC: 3)
  - [ ] Large textarea for reply content
  - [ ] Label: "Your Reply" or "Reply Message"
  - [ ] Required validation
  - [ ] Character counter (optional)
  - [ ] Support line breaks, basic formatting

- [ ] **Task 13: Implement file attachments** (AC: 4)
  - [ ] Reuse file uploader from Story 5.1
  - [ ] Same file validation rules:
    - Allowed formats: PDF, DOC/DOCX, XLS/XLSX, CSV/TXT, MP3, ZIP
    - Total size ≤ 100 MB
  - [ ] Display attached files list
  - [ ] Remove button for each file
  - [ ] Use PrimeNG FileUpload component

- [ ] **Task 14: Implement send reply action** (AC: All)
  - [ ] "Send Reply" button
  - [ ] On click:
    1. Validate form (body required) - AC 3
    2. Validate files (AC 4)
    3. Create FormData with reply body and files
    4. Call messagesService.replyToMessage(parentMessageId, body, files)
    5. Show loading indicator
    6. On success:
       - Display success message: "Reply sent successfully"
       - Close dialog/form
       - Refresh message details or navigate to updated thread (AC 9)
       - Update parent message status to "Closed" in UI (AC 6)
    7. On error:
       - Display error message (virus, spam, validation)
       - Keep form open for editing

- [ ] **Task 15: Add "Reply" button to message details page** (AC: 1)
  - [ ] Update message-details component from Story 5.2
  - [ ] Add "Reply" button prominently
  - [ ] Only show if:
    - Current user is a recipient (AC 1)
    - Message status is not already "Closed" (or allow reply anyway)
  - [ ] On click: Open reply dialog or navigate to reply form
  - [ ] Pass parent message details to reply component

- [ ] **Task 16: Update message thread display** (AC: 5, 9)
  - [ ] After sending reply, refresh message thread
  - [ ] Thread should display:
    - Original message
    - All replies in chronological order
    - Newest reply at bottom or top (consistent ordering)
  - [ ] Highlight current message in thread
  - [ ] Each message in thread shows: Sender, date, body preview, status

- [ ] **Task 17: Handle parent message status update** (AC: 6)
  - [ ] After sending reply, update parent message status to "Closed" in UI
  - [ ] If viewing message list, refresh to show updated status
  - [ ] Status badge changes from "Awaiting Response" to "Closed"
  - [ ] Visual indication that conversation has response

- [ ] **Task 18: Create reply dialog (optional approach)** (AC: All)
  - [ ] Alternative to separate page: Use PrimeNG Dialog
  - [ ] Dialog title: "Reply to: [Subject]"
  - [ ] Dialog content: Reply form with original message context
  - [ ] Buttons: "Send Reply", "Cancel"
  - [ ] On send: Close dialog and refresh parent view
  - [ ] Responsive dialog size

- [ ] **Task 19: Create page layout (if separate page)** (AC: All)
  - [ ] Page title: "Reply to: [Original Subject]"
  - [ ] Breadcrumb: Messages > [Original Subject] > Reply
  - [ ] Original message section (collapsed/expandable)
  - [ ] Reply form section:
    - Body textarea
    - File attachments
    - Send button
    - Cancel button (navigate back)
  - [ ] Use PrimeNG Card, InputTextarea, FileUpload
  - [ ] Style with Tailwind CSS

### Testing Tasks

- [ ] **Task 20: Write unit tests for ReplyToMessageCommandValidator**
  - [ ] Test: `Validate_ValidReply_Passes` (AC 3)
  - [ ] Test: `Validate_MissingBody_Fails` (AC 3)
  - [ ] Test: `Validate_ParentMessageNotFound_Fails` (AC 1)
  - [ ] Test: `Validate_InvalidFileFormat_Fails` (AC 4)
  - [ ] Test: `Validate_FileSizeExceeds100MB_Fails` (AC 4)

- [ ] **Task 21: Write unit tests for ReplyToMessageCommandHandler**
  - [ ] Test: `Handle_ValidReply_SendsSuccessfully` (AC All)
  - [ ] Test: `Handle_UserNotRecipient_ThrowsUnauthorizedException` (AC 1)
  - [ ] Test: `Handle_InheritsContextFromParent` (AC 2)
  - [ ] Test: `Handle_UpdatesParentStatusToClosed` (AC 6)
  - [ ] Test: `Handle_SetsReplyStatusBasedOnSenderType` (AC 7)
  - [ ] Test: `Handle_ThreadsReplyWithParentMessage` (AC 5)
  - [ ] Test: `Handle_SendsEmailNotification` (AC 8)
  - [ ] Test: `Handle_LogsReplyAction` (AC 10)
  - [ ] Mock: IMessageRepository, IFileStorageService, IEmailService, ICurrentUserService

- [ ] **Task 22: Write integration test for reply to message endpoint**
  - [ ] Test: `POST_ReplyToMessage_ValidRequest_Returns201` (AC All)
  - [ ] Test: `POST_ReplyToMessage_WithAttachments_StoresFiles` (AC 4)
  - [ ] Test: `POST_ReplyToMessage_UserNotRecipient_Returns403` (AC 1)
  - [ ] Test: `POST_ReplyToMessage_ParentNotFound_Returns404` (AC 1)
  - [ ] Test: `POST_ReplyToMessage_UpdatesParentStatus` (AC 6)
  - [ ] Verify reply message created with correct ParentMessageId (AC 5)
  - [ ] Verify parent message status changed to "Closed" (AC 6)
  - [ ] Verify email notification sent (AC 8)
  - [ ] Verify audit log created (AC 10)

- [ ] **Task 23: Write E2E test for reply flow**
  - [ ] Test workflow:
    1. Setup: Create original message from User A to User B
    2. Login as User B (recipient)
    3. Navigate to Messages
    4. Click on message to view details
    5. Verify message displayed (AC 1)
    6. Click "Reply" button (AC 1)
    7. Verify reply form opens with original message context (AC 2)
    8. Enter reply text (AC 3)
    9. Upload attachment (AC 4)
    10. Click "Send Reply"
    11. Verify success message displayed
    12. Verify parent message status changed to "Closed" (AC 6)
    13. Verify reply appears in message thread (AC 5, 9)
    14. Login as User A (original sender)
    15. Navigate to Messages
    16. Verify new message appears with status "Awaiting User's Response" (AC 7)
    17. Verify email notification sent (check MailDev) (AC 8)
    18. Click message to view
    19. Verify complete conversation thread shown (AC 9)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 5.1:**
- SendMessageCommand created for new messages
- File attachment handling, virus scanning, SPAM detection implemented
- Message entity with ParentMessageId for threading

**From Story 5.2:**
- GetMessageDetailsQuery returns message details
- Message thread display logic
- This story implements the reply action

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- File Storage: MinIO (S3-compatible)

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Dialog, InputTextarea, FileUpload, Button, Card)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── MessagesController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Messages/
│   ├── Commands/
│   │   ├── ReplyToMessageCommand.cs (CREATE)
│   │   ├── ReplyToMessageCommandHandler.cs (CREATE)
│   │   └── ReplyToMessageCommandValidator.cs (CREATE)
│   └── DTOs/
│       ├── ReplyToMessageRequest.cs (CREATE)
│       └── ReplyToMessageResponse.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── messages.service.ts (UPDATE)
└── features/messaging/
    ├── reply-message/
    │   ├── reply-message.component.ts (CREATE)
    │   ├── reply-message.component.html (CREATE)
    │   └── reply-message.component.scss (CREATE)
    └── message-details/
        └── message-details.component.ts (UPDATE - add Reply button)
```

### Data Models

**Message Entity (from Story 5.1):**
- Id (Guid)
- Subject (string)
- Body (string)
- SenderId (Guid)
- MessageStatus (enum: AwaitingUknfResponse, AwaitingUserResponse, Closed)
- ContextType (enum)
- ContextId (Guid?)
- EntityId (long?)
- ParentMessageId (Guid?) - for threading - AC 5
- SentDate (DateTime)

**Key for this story:**
- ParentMessageId links reply to original message
- When reply sent, parent MessageStatus → "Closed"

### REST API Specification

**Endpoint:** POST `/api/messages/{id}/reply`
- **Security:** Requires authentication + authorization (user must be recipient of parent message)
- **Content-Type:** multipart/form-data
- **Path Parameter:** id (Guid) - parent message ID
- **Request:**
  ```
  FormData:
  - body: string (required)
  - files: File[] (optional, multiple files)
  ```
- **Response (201 Created):**
  ```json
  {
    "replyMessageId": "guid",
    "parentMessageId": "guid",
    "sentDate": "2025-10-04T10:30:00Z",
    "recipientName": "Jan Kowalski",
    "attachmentCount": 1,
    "message": "Reply sent successfully"
  }
  ```
- **Error Responses:**
  - 400 Bad Request: Validation errors (missing body, virus, spam, file size)
  - 403 Forbidden: User not a recipient of parent message
  - 404 Not Found: Parent message not found

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Verify user is recipient of parent message (AC 1)**
   ```csharp
   // ✅ CORRECT
   var parentMessage = await _messageRepository.GetByIdAsync(command.ParentMessageId);
   if (parentMessage == null)
       throw new NotFoundException("Parent message not found");
   
   var isRecipient = parentMessage.Recipients.Any(r => r.RecipientUserId == currentUserId);
   if (!isRecipient)
       throw new UnauthorizedException("You are not authorized to reply to this message");
   ```

2. **Inherit context from parent message (AC 2)**
   ```csharp
   // ✅ CORRECT
   var reply = new Message
   {
       Subject = parentMessage.Subject.StartsWith("Re:") 
           ? parentMessage.Subject 
           : $"Re: {parentMessage.Subject}",
       Body = command.Body,
       SenderId = currentUserId,
       ContextType = parentMessage.ContextType, // Inherited
       ContextId = parentMessage.ContextId, // Inherited
       EntityId = parentMessage.EntityId, // Inherited
       ParentMessageId = command.ParentMessageId, // Threading
       SentDate = DateTime.UtcNow
   };
   ```

3. **Set reply status based on sender type (AC 7)**
   ```csharp
   // ✅ CORRECT
   var sender = await _userRepository.GetByIdAsync(currentUserId);
   reply.MessageStatus = sender.UserType == UserType.External 
       ? MessageStatus.AwaitingUknfResponse 
       : MessageStatus.AwaitingUserResponse;
   ```

4. **Update parent message status to Closed (AC 6)**
   ```csharp
   // ✅ CORRECT
   parentMessage.MessageStatus = MessageStatus.Closed;
   await _messageRepository.UpdateAsync(parentMessage);
   ```

5. **Determine reply recipient (sender of parent message)**
   ```csharp
   // ✅ CORRECT
   var replyRecipient = new MessageRecipient
   {
       MessageId = reply.Id,
       RecipientUserId = parentMessage.SenderId, // Parent sender becomes reply recipient
       IsRead = false
   };
   reply.Recipients.Add(replyRecipient);
   ```

6. **Thread reply with parent message (AC 5)**
   ```csharp
   // ✅ CORRECT
   reply.ParentMessageId = command.ParentMessageId;
   
   // When fetching thread, query includes:
   var thread = await _context.Messages
       .Where(m => m.Id == messageId || m.ParentMessageId == messageId || 
                   (m.ParentMessageId.HasValue && 
                    _context.Messages.Any(p => p.Id == m.ParentMessageId && 
                                              (p.Id == messageId || p.ParentMessageId == messageId))))
       .OrderBy(m => m.SentDate)
       .ToListAsync();
   ```

7. **Reuse file validation from Story 5.1 (AC 4)**
   ```csharp
   // ✅ CORRECT - Same validation as Story 5.1
   foreach (var file in command.AttachmentFiles ?? Enumerable.Empty<IFormFile>())
   {
       // Validate format by magic numbers
       var isValidFormat = await _fileFormatValidator.ValidateAsync(file);
       if (!isValidFormat)
           throw new ValidationException($"Invalid file format: {file.FileName}");
       
       // Scan for virus
       var scanResult = await _virusScanningService.ScanFileAsync(file.OpenReadStream(), file.FileName);
       if (scanResult.IsInfected)
           throw new ValidationException($"File contains virus: {file.FileName}");
       
       // Upload to storage
       var storageKey = $"messages/{reply.Id}/{Guid.NewGuid()}_{file.FileName}";
       await _fileStorageService.UploadAsync(storageKey, file.OpenReadStream(), file.ContentType);
       
       reply.Attachments.Add(new MessageAttachment
       {
           MessageId = reply.Id,
           FileName = file.FileName,
           FileStorageKey = storageKey,
           FileSize = file.Length,
           ContentType = file.ContentType
       });
   }
   ```

### Business Rules

**Reply Authorization (AC 1):**
- Only recipients of original message can reply
- Check current user exists in parent message's Recipients

**Context Inheritance (AC 2):**
- Reply inherits ContextType, ContextId, EntityId from parent
- If parent is about Case #12345, reply is also about Case #12345
- Subject prefixed with "Re:" (if not already)

**Status Management (AC 6, 7):**
- When reply sent:
  - Parent message status → "Closed"
  - Reply status set based on current user type:
    - External User reply → "AwaitingUknfResponse"
    - UKNF Employee reply → "AwaitingUserResponse"

**Threading (AC 5):**
- Reply.ParentMessageId = original message ID
- Creates conversation thread
- Thread display shows all related messages chronologically

**Recipient Determination:**
- Reply recipient = original message sender
- If original message had multiple recipients, reply goes only to sender (1:1 conversation)

### UI/UX Considerations

**Reply Dialog:**
```html
<p-dialog header="Reply to: {{ parentMessage.subject }}" [(visible)]="showReplyDialog" [modal]="true" [style]="{width: '800px'}">
  <!-- Original Message Context -->
  <p-fieldset legend="Original Message" [toggleable]="true" [collapsed]="true" styleClass="mb-4">
    <div class="text-sm">
      <p><strong>From:</strong> {{ parentMessage.senderName }}</p>
      <p><strong>Date:</strong> {{ parentMessage.sentDate | date:'medium' }}</p>
      <p><strong>Context:</strong> {{ parentMessage.contextDisplayName }}</p>
      <div class="mt-2">{{ parentMessage.body }}</div>
    </div>
  </p-fieldset>
  
  <!-- Reply Form -->
  <div class="form-group">
    <label for="replyBody">Your Reply *</label>
    <textarea id="replyBody" 
              pInputTextarea 
              [(ngModel)]="replyBody" 
              rows="8" 
              class="w-full"
              placeholder="Type your reply..."></textarea>
  </div>
  
  <!-- File Attachments -->
  <div class="form-group mt-4">
    <label>Attachments (Optional)</label>
    <p-fileUpload 
      name="files[]" 
      [multiple]="true"
      [maxFileSize]="104857600"
      accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.mp3,.zip"
      (onSelect)="onFileSelect($event)">
    </p-fileUpload>
    <small class="text-gray-600">Allowed: PDF, DOC, DOCX, XLS, XLSX, CSV, TXT, MP3, ZIP. Max 100 MB total.</small>
  </div>
  
  <!-- Actions -->
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary" (click)="showReplyDialog = false"></button>
    <button pButton label="Send Reply" icon="pi pi-send" (click)="sendReply()" [disabled]="!replyBody || isSubmitting"></button>
  </ng-template>
</p-dialog>
```

**Reply Button in Message Details:**
```html
<div class="message-actions flex gap-2 mb-4">
  <button pButton 
          label="Reply" 
          icon="pi pi-reply" 
          (click)="openReplyDialog()"
          *ngIf="canReply"></button>
  <button pButton 
          label="Mark as Unread" 
          icon="pi pi-envelope" 
          class="p-button-secondary"></button>
</div>
```

### Security Requirements

- Only recipients of parent message can reply (AC 1)
- Authorization checked on backend
- File attachments scanned for viruses (AC 4)
- SPAM detection applied to reply content

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Reply action should be fast (< 2 seconds without files)
- File uploads may take longer (progress indicator)
- Transaction ensures parent status update and reply creation are atomic
- Email notification sent async (don't block reply response)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Reply to message successfully
- Inherit context from parent message
- Update parent message status to Closed
- Set reply status based on sender type
- Thread reply with parent
- Send email notification
- Reject unauthorized reply (user not recipient)
- Validate file attachments

**Example:**
```csharp
[Fact]
public async Task Handle_ValidReply_UpdatesParentStatusToClosed()
{
    // Arrange - AC 6
    var externalUser = CreateExternalUser();
    var uknfEmployee = CreateUknfEmployee();
    var parentMessage = CreateTestMessage(sender: externalUser, recipient: uknfEmployee);
    parentMessage.MessageStatus = MessageStatus.AwaitingUknfResponse;
    
    await _context.Messages.AddAsync(parentMessage);
    await _context.SaveChangesAsync();
    
    _currentUserService.GetCurrentUserId().Returns(uknfEmployee.Id);
    
    var command = new ReplyToMessageCommand
    {
        ParentMessageId = parentMessage.Id,
        Body = "Thank you for your message. I will review it."
    };
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    var updatedParent = await _context.Messages.FindAsync(parentMessage.Id);
    updatedParent.MessageStatus.Should().Be(MessageStatus.Closed); // AC 6
    
    var reply = await _context.Messages.FindAsync(result.ReplyMessageId);
    reply.ParentMessageId.Should().Be(parentMessage.Id); // AC 5
    reply.MessageStatus.Should().Be(MessageStatus.AwaitingUserResponse); // AC 7 (UKNF sender)
}
```

### Additional Notes

1. **Subject Handling:** Reply subject is "Re: [original subject]". If original already has "Re:", don't duplicate.

2. **Multiple Replies:** If both parties keep replying, chain continues. Each reply has ParentMessageId pointing to previous message. Thread view shows all related messages.

3. **Recipient Determination:** Reply always goes to original sender, creating a 1:1 conversation. If original message had multiple recipients, they don't receive reply.

4. **Closed Status:** When message marked "Closed", it indicates conversation has response. Users can still reply to "Closed" messages (optional business rule).

5. **Email Template:** "New Reply from [Name]" with link to view conversation thread.

6. **Thread Display:** After sending reply, refresh thread view to show complete conversation history (AC 9).

7. **Context Preservation:** Reply inherits all context (ContextType, ContextId, EntityId) from parent, ensuring conversation stays within same Case/Report/Access Request context.

8. **File Validation:** Reuse all validation logic from Story 5.1 (format, size, virus, SPAM).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 5, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

