# Story 6.13: Notify Users of New/Updated Files

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.13  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** notify users when important files are added or updated,  
**So that** they are aware and can access them promptly.

---

## Acceptance Criteria

1. UKNF Employee can select file and choose "Notify Users"
2. Employee can compose notification message (optional)
3. System sends notification to all users with access to the file
4. Notification includes: File name, Description, Link to file in Library
5. Users receive email notification
6. Users see in-app notification/indicator (e.g., badge on Library menu item)
7. Notification is logged with timestamp and employee ID
8. Employee can preview recipients before sending (count, entities)
9. Employee can send notification immediately or schedule for later (optional)
10. Users can mark notifications as read
11. Notification includes download button/link

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Notification domain entity** (AC: 5, 6, 7, 10)
  - [ ] Create `Notification.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - Type (enum) - FileAdded, FileUpdated, FileShared
    - FileId (Guid?, nullable) - related file
    - Title (string, required, max 500)
    - Message (string?, nullable, max 2000)
    - SentByUserId (Guid, required) - UKNF Employee who sent
    - SentDate (DateTime)
    - ScheduledDate (DateTime?, nullable) - for scheduled notifications
    - Status (enum) - Draft, Scheduled, Sent
    - RecipientCount (int)
    - CreatedDate (DateTime)

- [ ] **Task 2: Create NotificationRecipient domain entity** (AC: 3, 6, 10)
  - [ ] Create `NotificationRecipient.cs`
  - [ ] Properties:
    - Id (Guid)
    - NotificationId (Guid, required)
    - UserId (Guid, required)
    - IsRead (bool, default false)
    - ReadDate (DateTime?, nullable)
    - EmailSent (bool, default false)
    - EmailSentDate (DateTime?, nullable)
    - InAppDelivered (bool, default true)
    - CreatedDate (DateTime)

- [ ] **Task 3: Create SendFileNotificationCommand** (AC: 1, 2, 3, 8)
  - [ ] Create `SendFileNotificationCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileId (Guid, required)
    - CustomMessage (string?, nullable, max 2000) - optional message from employee
    - SendImmediately (bool, default true)
    - ScheduledDate (DateTime?, nullable)

- [ ] **Task 4: Create SendFileNotificationCommandValidator** (AC: 1, 2, 8)
  - [ ] Create `SendFileNotificationCommandValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate CustomMessage: MaxLength(2000) if provided
  - [ ] Validate ScheduledDate: MustBeFutureDate if SendImmediately = false
  - [ ] Add async validation: File must exist and not be deleted
  - [ ] Add async validation: File must have at least one permission (recipients exist)
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 5: Create SendFileNotificationCommandHandler** (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `SendFileNotificationCommandHandler.cs` implementing `IRequestHandler<SendFileNotificationCommand, SendFileNotificationResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFilePermissionRepository, INotificationRepository, IEmailService, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Load file details
    - Determine recipients: All users with access to file (based on FilePermissions)
    - Build notification title: "New File Available: {Filename}" or "File Updated: {Filename}"
    - Build notification message: Include file description, custom message, link
    - Create Notification entity (Status = Sent or Scheduled)
    - Create NotificationRecipient entities for each recipient
    - If SendImmediately:
      - Send email notifications (AC: 5)
      - Mark EmailSent = true
      - Deliver in-app notifications (AC: 6)
    - If Scheduled:
      - Save with Status = Scheduled
      - Background job will send later
    - Log notification (AC: 7)
    - Return SendFileNotificationResponse with recipient count (AC: 8)
  - [ ] Handle errors: no recipients, email failures

- [ ] **Task 6: Create SendFileNotificationResponse DTO** (AC: 3, 8)
  - [ ] Create `SendFileNotificationResponse.cs` record
  - [ ] Properties:
    - NotificationId (Guid)
    - RecipientCount (int)
    - Message (string)

- [ ] **Task 7: Create REST API endpoint POST /library/files/{fileId}/notify** (AC: 1, 7, 8)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create POST action `SendFileNotificationAsync(Guid fileId, [FromBody] SendFileNotificationRequest request)`
  - [ ] Inject IMediator to send command
  - [ ] Return 200 OK with SendFileNotificationResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Return 422 Unprocessable Entity if no recipients
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 8: Create GetNotificationRecipientsQuery** (AC: 8)
  - [ ] Create `GetNotificationRecipientsQuery.cs`
  - [ ] Query properties: FileId (Guid)
  - [ ] Create QueryHandler
  - [ ] Handler logic:
    - Load all users with access to file (based on permissions)
    - Group by entity
    - Return list of users with entity names
    - Return total count
    - Used for preview before sending

- [ ] **Task 9: Create REST API endpoint GET /library/files/{fileId}/notification-recipients** (AC: 8)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `GetNotificationRecipientsAsync(Guid fileId)`
  - [ ] Return list of recipients and count
  - [ ] Used for preview

- [ ] **Task 10: Create GetUserNotificationsQuery** (AC: 6, 10)
  - [ ] Create `GetUserNotificationsQuery.cs`
  - [ ] Query properties: IncludeRead (bool, default false), PageNumber (int), PageSize (int)
  - [ ] Create QueryHandler
  - [ ] Handler logic:
    - Load NotificationRecipient for current user
    - Join with Notification to get details
    - Filter by IsRead (if IncludeRead = false)
    - Order by SentDate descending
    - Return paginated notifications

- [ ] **Task 11: Create UserNotificationDto** (AC: 4, 6, 11)
  - [ ] Create `UserNotificationDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Type (string)
    - Title (string)
    - Message (string?)
    - FileId (Guid?)
    - FileName (string?)
    - FileLink (string?) - URL to file in Library
    - SentDate (DateTime)
    - IsRead (bool)
    - ReadDate (DateTime?)

- [ ] **Task 12: Create REST API endpoint GET /notifications** (AC: 6, 10)
  - [ ] Create NotificationsController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetUserNotificationsAsync([FromQuery] GetUserNotificationsQuery query)`
  - [ ] Returns user's notifications
  - [ ] External users and UKNF Employees can access

- [ ] **Task 13: Create MarkNotificationAsReadCommand** (AC: 10)
  - [ ] Create `MarkNotificationAsReadCommand.cs`
  - [ ] Command properties: NotificationId (Guid)
  - [ ] Create CommandHandler
  - [ ] Handler logic:
    - Find NotificationRecipient for current user and notification
    - Set IsRead = true, ReadDate = now
    - Save changes

- [ ] **Task 14: Create REST API endpoint POST /notifications/{notificationId}/read** (AC: 10)
  - [ ] Add method to NotificationsController
  - [ ] Add `[Authorize]` attribute
  - [ ] Create POST action `MarkNotificationAsReadAsync(Guid notificationId)`
  - [ ] Returns 200 OK
  - [ ] Returns 404 if notification not found for user

- [ ] **Task 15: Implement email notification** (AC: 5)
  - [ ] Create email template for file notifications
  - [ ] Template includes:
    - Subject: "New File Available: {Filename}" or "File Updated: {Filename}"
    - Body: File name, description, custom message, download link
    - Download button/link (AC: 11)
  - [ ] Use IEmailService (already exists in application)
  - [ ] Handle email failures gracefully (log, retry)

- [ ] **Task 16: Create background job for scheduled notifications** (AC: 9)
  - [ ] Create background job: SendScheduledNotificationsJob
  - [ ] Run every 5-10 minutes
  - [ ] Query Notifications with Status = Scheduled and ScheduledDate <= now
  - [ ] Send notifications (email + in-app)
  - [ ] Update Status = Sent
  - [ ] Log sent notifications

- [ ] **Task 17: Create INotificationRepository interface and implementation** (AC: 3, 6, 7)
  - [ ] Create `INotificationRepository.cs` interface
  - [ ] Methods: AddAsync, GetByIdAsync, GetScheduledAsync, UpdateAsync
  - [ ] Create `NotificationRepository.cs` implementation
  - [ ] Create `INotificationRecipientRepository.cs` interface
  - [ ] Methods: AddRangeAsync, GetByUserIdAsync, GetByNotificationIdAsync, UpdateAsync
  - [ ] Create `NotificationRecipientRepository.cs` implementation

- [ ] **Task 18: Create database schema** (AC: 3, 6, 7, 10)
  - [ ] Create EF Core entity configurations:
    - `NotificationConfiguration.cs`
    - `NotificationRecipientConfiguration.cs`
  - [ ] Configure table names, primary keys, indexes
  - [ ] Configure foreign key relationships:
    - Notification -> LibraryFile (optional)
    - Notification -> SentByUser (User)
    - NotificationRecipient -> Notification
    - NotificationRecipient -> User
  - [ ] Configure indexes:
    - NotificationRecipient: UserId, IsRead, CreatedDate
    - Notification: Status, ScheduledDate, FileId
  - [ ] Add EF Core migration `Add_Notifications_Tables`

- [ ] **Task 19: Update ApplicationDbContext** (AC: 3, 6)
  - [ ] Add DbSet<Notification> Notifications
  - [ ] Add DbSet<NotificationRecipient> NotificationRecipients
  - [ ] Apply entity configurations in OnModelCreating

### Frontend Tasks

- [ ] **Task 20: Add "Notify Users" button** (AC: 1)
  - [ ] Add button on file details page
  - [ ] Button only visible to UKNF Employees
  - [ ] Open notification modal/dialog
  - [ ] Button labeled "Notify Users" or "Send Notification"

- [ ] **Task 21: Create file notification dialog** (AC: 1, 2, 8, 9)
  - [ ] Create `file-notification-dialog.component.ts`
  - [ ] Dialog content:
    - File name (read-only)
    - Recipient preview (count, entities)
    - Custom message textarea (optional)
    - Send immediately checkbox (default: true)
    - Scheduled date picker (if not immediate)
    - Send and Cancel buttons
  - [ ] Load recipient preview on open (AC: 8)
  - [ ] Show: "This notification will be sent to X users from Y entities"

- [ ] **Task 22: Create notification service** (AC: 1, 3, 6)
  - [ ] Create `notification.service.ts` in `src/app/core/services/`
  - [ ] Methods:
    - sendFileNotification(fileId: string, request: SendNotification): Observable<SendNotificationResponse>
    - getNotificationRecipients(fileId: string): Observable<Recipients>
    - getUserNotifications(includeRead: boolean): Observable<UserNotifications>
    - markNotificationAsRead(notificationId: string): Observable<void>
  - [ ] Handle API errors

- [ ] **Task 23: Create in-app notification center** (AC: 6, 10)
  - [ ] Create `notification-center.component.ts`
  - [ ] Display in header/navigation bar
  - [ ] Bell icon with unread count badge
  - [ ] Dropdown list of notifications
  - [ ] Show: Title, Message (truncated), Time, Read status
  - [ ] Click notification to mark as read and navigate to file
  - [ ] "Mark all as read" button
  - [ ] "View all notifications" link (to notifications page)

- [ ] **Task 24: Create notifications page** (AC: 6, 10, 11)
  - [ ] Create `notifications-list.component.ts`
  - [ ] List all user notifications
  - [ ] Show: Type icon, Title, Message, File link, Sent date, Read status
  - [ ] Filter: Unread only / All
  - [ ] Sort: Newest first
  - [ ] Pagination
  - [ ] Click notification to mark as read
  - [ ] Download button for file notifications (AC: 11)
  - [ ] Accessible to all authenticated users

- [ ] **Task 25: Add notifications routing** (AC: 6)
  - [ ] Add route: `/notifications` â†’ NotificationsListComponent
  - [ ] Add "Notifications" menu item in navigation (with badge)
  - [ ] Implement route guard (requires authentication)

- [ ] **Task 26: Implement real-time notification delivery** (AC: 6)
  - [ ] Option A: Use SignalR for real-time push (WebSocket)
  - [ ] Option B: Poll for new notifications every 30-60 seconds
  - [ ] Update notification badge in real-time
  - [ ] Show toast/snackbar for new notifications
  - [ ] Play sound notification (optional, user preference)

- [ ] **Task 27: Update library service** (AC: 1, 8)
  - [ ] Add method to `library.service.ts`:
    - sendFileNotification(fileId: string, notification: SendNotification): Observable<SendNotificationResponse>
    - getNotificationRecipients(fileId: string): Observable<Recipients>

- [ ] **Task 28: Show success feedback** (AC: 3, 8)
  - [ ] Show success notification after sending
  - [ ] Display recipient count: "Notification sent to X users"
  - [ ] Close dialog after successful send

- [ ] **Task 29: Implement notification email template (HTML)** (AC: 4, 5, 11)
  - [ ] Design HTML email template
  - [ ] Include: File name, description, custom message
  - [ ] Download button with link to file
  - [ ] UKNF branding/logo
  - [ ] Footer with unsubscribe/preferences link (optional)
  - [ ] Mobile-responsive design

### Testing Tasks

- [ ] **Task 30: Unit tests for send notification handler** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Test notification sent to all users with file access
  - [ ] Test notification includes file name, description, link
  - [ ] Test custom message included
  - [ ] Test email sent to each recipient
  - [ ] Test in-app notification created
  - [ ] Test notification logged
  - [ ] Test recipient count returned
  - [ ] Test no recipients error

- [ ] **Task 31: Unit tests for recipient calculation** (AC: 3, 8)
  - [ ] Test recipients determined by file permissions
  - [ ] Test AllUsers permission sends to all external users
  - [ ] Test SpecificEntity permission sends to entity users
  - [ ] Test combining multiple permission types

- [ ] **Task 32: Unit tests for scheduled notifications** (AC: 9)
  - [ ] Test scheduled notification saved with correct date
  - [ ] Test scheduled notification status = Scheduled
  - [ ] Test background job sends scheduled notifications
  - [ ] Test status updated to Sent after sending

- [ ] **Task 33: Unit tests for mark as read** (AC: 10)
  - [ ] Test marking notification as read
  - [ ] Test read date set correctly
  - [ ] Test notification marked as read only for current user

- [ ] **Task 34: Integration tests for API endpoints** (AC: 1, 3, 6, 7, 8, 10)
  - [ ] Test POST /library/files/{id}/notify sends notifications
  - [ ] Test GET /library/files/{id}/notification-recipients returns recipients
  - [ ] Test GET /notifications returns user notifications
  - [ ] Test POST /notifications/{id}/read marks as read
  - [ ] Test sending requires UKNF Employee role (403 if not)
  - [ ] Test viewing notifications requires authentication

- [ ] **Task 35: Integration tests for email sending** (AC: 5)
  - [ ] Test email sent to each recipient
  - [ ] Test email contains file name and link
  - [ ] Test email sending failures handled gracefully

- [ ] **Task 36: Frontend unit tests** (AC: 1, 2, 6, 8, 10)
  - [ ] Test notification dialog component
  - [ ] Test notification center component
  - [ ] Test notifications list component
  - [ ] Test marking notification as read
  - [ ] Test service method calls

- [ ] **Task 37: E2E tests** (AC: 1-11)
  - [ ] Test complete notification flow as UKNF Employee
  - [ ] Test users receive notification
  - [ ] Test notification appears in notification center
  - [ ] Test notification email sent
  - [ ] Test marking notification as read
  - [ ] Test download from notification
  - [ ] Test scheduled notification

### Documentation Tasks

- [ ] **Task 38: API documentation** (AC: 1, 6, 7)
  - [ ] Document POST /library/files/{id}/notify endpoint
  - [ ] Document GET /library/files/{id}/notification-recipients endpoint
  - [ ] Document GET /notifications endpoint
  - [ ] Document POST /notifications/{id}/read endpoint
  - [ ] Include request/response examples
  - [ ] Document authentication requirements

- [ ] **Task 39: Developer documentation** (AC: 3, 5, 9)
  - [ ] Document notification schema
  - [ ] Document email template
  - [ ] Document recipient calculation logic
  - [ ] Document scheduled notification implementation

- [ ] **Task 40: User documentation** (AC: 1, 2, 4, 6)
  - [ ] Create user guide for sending notifications
  - [ ] Create user guide for receiving notifications
  - [ ] Explain notification types
  - [ ] Include screenshots

---

## Technical Notes

### Notification Types

- **FileAdded**: New file uploaded and shared
- **FileUpdated**: Existing file replaced with new version
- **FileShared**: File permissions changed to include new recipients

### Recipient Calculation

Recipients = All users with access to file (based on FilePermissions):
- AllUsers â†’ All external users
- SpecificEntity â†’ Users of specified entities
- EntityType â†’ Users of entities of specified type
- SpecificUser â†’ Specific users

Same logic as file visibility (Story 6.3).

### Email Template

Subject: "New File Available: {Filename}"

Body:
```
Hello {UserName},

A new file is available in the UKNF Library:

File Name: {Filename}
Description: {Description}

{CustomMessage}

[Download File] (button/link)

Or view in Library: {LibraryLink}

---
UKNF Platform
```

### In-App Notification

Notification center (bell icon):
- Badge showing unread count
- Dropdown with recent notifications
- Click to mark as read and navigate

Notifications page:
- Full list of all notifications
- Filter by read/unread
- Detailed message and file info

### Scheduled Notifications (Optional - AC: 9)

Use case: Schedule notification for business hours or specific date.

Implementation:
- Save notification with Status = Scheduled
- Background job runs periodically (every 5-10 minutes)
- Sends notifications with ScheduledDate <= now
- Updates Status = Sent

### Real-Time Delivery

**Option A: SignalR (WebSocket)**
- Real-time push to connected clients
- Immediate notification delivery
- More complex to implement

**Option B: Polling**
- Client polls for new notifications every 30-60 seconds
- Simpler to implement
- Slight delay but acceptable

Recommendation: Start with polling, add SignalR if needed.

### Notification Read Status

- Per user (NotificationRecipient)
- One notification can have multiple recipients
- Each recipient has own IsRead status
- Unread count = COUNT(NotificationRecipient WHERE UserId = X AND IsRead = false)

### Performance Considerations

- Sending to many recipients (100s+) should be background job
- Email sending can be slow - queue emails
- Index NotificationRecipient on UserId and IsRead for fast unread count
- Consider batch email sending

### Security Considerations

- Only UKNF Employees can send notifications
- Only send to users with file access (respect permissions)
- Email links should not expose sensitive data
- Notification content should not contain sensitive info

### UI/UX Considerations

- Make "Notify Users" button prominent on file details
- Preview recipients before sending (count, entities)
- Show success feedback after sending
- Bell icon with badge for unread notifications
- Toast/snackbar for new notifications (non-intrusive)
- Download directly from notification for convenience

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files to notify about)
- **Story 6.2**: Set File Access Permissions (recipients based on permissions)
- **Epic 1**: Authentication (user identification)
- Email service infrastructure

### Integrates With
- **Story 6.5**: View File Details (notify button)
- **Story 6.7**: Replace File (notify on new version)
- **Story 6.12**: Monitor File Access (notify non-downloaders)

---

## Acceptance Checklist

- [ ] UKNF Employee can send file notifications
- [ ] Employee can compose custom message
- [ ] Notification sent to all users with file access
- [ ] Notification includes file name, description, link
- [ ] Users receive email notification
- [ ] Users see in-app notification with badge
- [ ] Notification logged with timestamp and employee ID
- [ ] Employee can preview recipients before sending
- [ ] Employee can schedule notification (optional)
- [ ] Users can mark notifications as read
- [ ] Notification includes download button/link
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (notify on upload)
- **Story 6.2**: Set File Access Permissions (recipients)
- **Story 6.5**: View File Details (notify button)
- **Story 6.7**: Replace File (notify on update)
- **Story 6.12**: Monitor File Access (follow up with non-downloaders)

---

## Notes

- Notifications improve engagement and ensure important files are accessed
- Email + in-app dual notification ensures users don't miss important updates
- Preview recipients prevents sending to wrong audience
- Custom message allows UKNF to provide context
- Download link in notification provides direct access
- Scheduled notifications useful for timing (e.g., send on Monday morning)
- Real-time notifications improve user experience (immediate awareness)
- Test with many recipients (100+) to ensure performance
- Consider notification preferences (users opt-out of certain notifications)
- Monitor email delivery rates and failures
- Consider digest notifications (daily summary) if high volume

