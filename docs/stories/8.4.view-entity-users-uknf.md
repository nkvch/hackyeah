# Story 8.4: View Entity Users (UKNF)

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.4  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee or System Administrator,  
**I want to** see all users assigned to a specific entity,  
**So that** I can understand who represents each entity.

---

## Acceptance Criteria

1. Employee can access "Entity Users" from entity detail page
2. System displays all users with permissions for this entity:
   - Entity Administrators (with active/blocked status)
   - Entity Employees (with active/blocked status)
3. List shows: User name, Email, Role (Administrator/Employee), Permissions (Reporting, Cases), Status (Active/Blocked)
4. Employee can filter by role and status
5. Employee can click user to view user details (links to Epic 3 user management)
6. List is sortable by name, role, status

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetEntityUsersQuery** (AC: 1, 2, 3)
  - [ ] Create `GetEntityUsersQuery.cs` in `Application/UknfPlatform.Application.Communication/Entities/Queries/`
  - [ ] Query parameters: EntityId, RoleFilter, StatusFilter
  - [ ] Create `GetEntityUsersQueryHandler.cs`
  - [ ] Inject IPermissionService (from Epic 2)
  - [ ] Get all users with permissions for entity
  - [ ] Return EntityUserDto list

- [ ] **Task 2: Create EntityUserDto** (AC: 3)
  - [ ] Create `EntityUserDto.cs` in `Application/UknfPlatform.Application.Communication/Entities/DTOs/`
  - [ ] Properties:
    - UserId (Guid)
    - Name (string)
    - Email (string)
    - Role (string) - "Administrator" or "Employee"
    - Permissions (list) - "Reporting", "Cases"
    - Status (string) - "Active" or "Blocked"

- [ ] **Task 3: Create REST API endpoint** (AC: 1)
  - [ ] GET /api/entities/{id}/users
  - [ ] Add `[Authorize]` with UKNF role check
  - [ ] Query parameters: role, status (filters)
  - [ ] Return 200 with EntityUserDto list
  - [ ] Return 403 if not UKNF Employee
  - [ ] Return 404 if entity not found
  - [ ] Add Swagger documentation

### Frontend Tasks

- [ ] **Task 4: Add "Users" tab to entity detail page** (AC: 1)
  - [ ] Update entity-detail component
  - [ ] Add "Users" tab alongside Details and Change History

- [ ] **Task 5: Create entity-users component** (AC: 2, 3, 4, 6)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/entities/entity-users/entity-users.component.ts`
  - [ ] Display users in table
  - [ ] Columns: Name, Email, Role, Permissions, Status
  - [ ] Implement filters: Role (dropdown), Status (dropdown)
  - [ ] Implement sorting
  - [ ] Style with Tailwind CSS

- [ ] **Task 6: Implement user navigation** (AC: 5)
  - [ ] Make user rows clickable
  - [ ] Navigate to `/users/:id` (Epic 3 user management)
  - [ ] Pass user ID as route parameter

### Testing Tasks

- [ ] **Task 7: Write unit tests**
  - [ ] Test: GetEntityUsersQuery returns entity users
  - [ ] Test: Filtering by role works
  - [ ] Test: Filtering by status works
  - [ ] Test: UKNF authorization check

- [ ] **Task 8: Write integration tests**
  - [ ] Test: GET /api/entities/:id/users returns users
  - [ ] Test: Filters work correctly
  - [ ] Test: Non-UKNF users get 403

---

## Dev Notes

### Dependencies

- **Epic 2**: Authorization system provides user-entity relationships and permissions
- **Epic 3**: User management provides user details page

### Data Source

User-entity relationships come from:
- Access Requests (Epic 2)
- PermissionLines table
- User entity assignments

### User Interface

Display users in organized table:
- Clear role indicators (Administrator badge, Employee badge)
- Status indicators (Active - green, Blocked - red)
- Permission chips (Reporting, Cases)
- Sortable columns
- Filter dropdowns

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

