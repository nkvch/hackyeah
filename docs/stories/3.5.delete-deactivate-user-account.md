# Story 3.5: Delete/Deactivate User Account

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.5  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** deactivate or delete user accounts,  
**So that** I can remove access for users who should no longer have it.

---

## Acceptance Criteria

1. System Administrator can select user to deactivate or delete
2. **Deactivation**: User account status changes to "Inactive", user cannot log in, data is retained
3. **Deletion**: User account is marked as deleted (soft delete recommended), user cannot log in
4. System prompts confirmation before deactivation/deletion
5. Deactivated users can be reactivated
6. Deleted users cannot be reactivated (must create new account)
7. All user actions/data remain in audit logs even after deletion
8. User receives email notification of account deactivation
9. System logs action with timestamp and administrator ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create DeactivateUserCommand** (AC: 2, 4, 8, 9)
  - [ ] Create `DeactivateUserCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserId (Guid, required) - user to deactivate
    - Reason (string, optional) - reason for deactivation
  - [ ] Note: Separate from deletion for clarity

- [ ] **Task 2: Create DeactivateUserCommandHandler** (AC: 2, 8, 9)
  - [ ] Create `DeactivateUserCommandHandler.cs` implementing `IRequestHandler<DeactivateUserCommand, DeactivateUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IEmailService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get user by UserId (404 if not found)
    - Check user is not already inactive
    - Set IsActive = false via domain method `user.Deactivate(reason)`
    - Invalidate all active user sessions (optional, depends on architecture)
    - Save to repository
    - Send deactivation notification email
    - Create audit log entry
    - Return DeactivateUserResponse
  - [ ] Use transaction

- [ ] **Task 3: Create DeleteUserCommand** (AC: 3, 4, 7, 9)
  - [ ] Create `DeleteUserCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserId (Guid, required) - user to delete
    - Reason (string, required) - reason for deletion (mandatory)
    - ConfirmationToken (string, optional) - for double confirmation in UI

- [ ] **Task 4: Create DeleteUserCommandHandler** (AC: 3, 6, 7, 9)
  - [ ] Create `DeleteUserCommandHandler.cs` implementing `IRequestHandler<DeleteUserCommand, DeleteUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IEmailService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get user by UserId (404 if not found)
    - Check user is not already deleted
    - Soft delete: Set IsDeleted = true, DeletedDate = DateTime.UtcNow, DeletedBy = current admin
    - Keep all data for audit trail (AC: 7)
    - Anonymize sensitive data (optional): Replace email with "deleted-{userId}@deleted.local"
    - Invalidate all active user sessions
    - Save to repository
    - Send deletion notification email (if not anonymized)
    - Create audit log entry
    - Return DeleteUserResponse
  - [ ] Use transaction

- [ ] **Task 5: Create ReactivateUserCommand** (AC: 5)
  - [ ] Create `ReactivateUserCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserId (Guid, required) - user to reactivate
    - Reason (string, optional) - reason for reactivation

- [ ] **Task 6: Create ReactivateUserCommandHandler** (AC: 5, 9)
  - [ ] Create `ReactivateUserCommandHandler.cs` implementing `IRequestHandler<ReactivateUserCommand, ReactivateUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IEmailService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get user by UserId (404 if not found)
    - Check user is deactivated (not deleted)
    - Check user is not deleted (AC: 6 - deleted users cannot be reactivated)
    - If deleted, return error: "Deleted users cannot be reactivated"
    - Set IsActive = true via domain method `user.Reactivate()`
    - Save to repository
    - Send reactivation notification email
    - Create audit log entry
    - Return ReactivateUserResponse
  - [ ] Use transaction

- [ ] **Task 7: Update User domain entity** (AC: 2, 3, 5, 6)
  - [ ] Open `User.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add property: `IsDeleted` (bool, default false)
  - [ ] Add property: `DeletedDate` (DateTime?, nullable)
  - [ ] Add property: `DeletedBy` (Guid?, nullable) - admin who deleted
  - [ ] Add property: `DeactivationReason` (string?, nullable)
  - [ ] Add property: `DeletionReason` (string?, nullable)
  - [ ] Add domain method: `Deactivate(reason?)` - sets IsActive = false
  - [ ] Add domain method: `Delete(reason, adminId)` - sets IsDeleted = true
  - [ ] Add domain method: `Reactivate()` - sets IsActive = true, checks not deleted
  - [ ] Add domain method: `CanReactivate()` - returns true if inactive but not deleted

- [ ] **Task 8: Update database schema** (AC: 3, 7)
  - [ ] Create EF Core migration: `Add_UserDeletion_Fields`
  - [ ] Add columns to Users table:
    - IsDeleted BIT NOT NULL DEFAULT 0
    - DeletedDate DATETIME2 NULL
    - DeletedBy UUID NULL (FK to Users)
    - DeactivationReason NVARCHAR(500) NULL
    - DeletionReason NVARCHAR(500) NULL
  - [ ] Add index: IX_Users_IsDeleted
  - [ ] Add foreign key: DeletedBy → Users(Id)
  - [ ] Update EF Core entity configuration

- [ ] **Task 9: Update global query filter for soft deletes** (AC: 3, 7)
  - [ ] Update ApplicationDbContext
  - [ ] Add global query filter: `.HasQueryFilter(u => !u.IsDeleted)`
  - [ ] Exclude soft-deleted users from normal queries
  - [ ] Admin queries can use `.IgnoreQueryFilters()` to see deleted users
  - [ ] Ensure audit logs always accessible (no filter on AuditLog entity)

- [ ] **Task 10: Create response DTOs** (AC: 2, 3, 5)
  - [ ] Create `DeactivateUserResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Create `DeleteUserResponse.cs` record
  - [ ] Create `ReactivateUserResponse.cs` record
  - [ ] Properties: UserId, Message, NotificationSent, PerformedDate, PerformedBy

- [ ] **Task 11: Create REST API endpoints** (AC: 1, 2, 3, 5)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` to all actions
  - [ ] POST action: `DeactivateUserAsync(Guid id, DeactivateUserCommand command)`
  - [ ] POST action: `DeleteUserAsync(Guid id, DeleteUserCommand command)`
  - [ ] POST action: `ReactivateUserAsync(Guid id, ReactivateUserCommand command)`
  - [ ] Ensure id parameter matches command.UserId
  - [ ] Return appropriate status codes (200, 400, 404)
  - [ ] Add XML documentation comments

- [ ] **Task 12: Create email templates** (AC: 8)
  - [ ] Create `AccountDeactivatedNotification.cshtml` in `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/`
  - [ ] Template content:
    - Subject: "Your account has been deactivated"
    - Message: Account deactivated by administrator
    - Reason (if provided)
    - Contact support for assistance
  - [ ] Create `AccountReactivatedNotification.cshtml`
  - [ ] Template content:
    - Subject: "Your account has been reactivated"
    - Message: Account reactivated, can log in again
    - Login URL

- [ ] **Task 13: Update IEmailService** (AC: 8)
  - [ ] Update `IEmailService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Add method: `SendAccountDeactivatedNotificationAsync(userId, email, userName, reason?)`
  - [ ] Add method: `SendAccountReactivatedNotificationAsync(userId, email, userName)`
  - [ ] Implement in `EmailService.cs`

- [ ] **Task 14: Invalidate user sessions on deactivation/deletion** (AC: 2, 3)
  - [ ] Create `ISessionService.cs` interface
  - [ ] Method: `InvalidateUserSessionsAsync(userId)`
  - [ ] Implementation depends on session storage (Redis, database, etc.)
  - [ ] Remove JWT tokens from whitelist (if implemented)
  - [ ] Or add to blacklist until token expiry
  - [ ] Force re-authentication on next request

- [ ] **Task 15: Create audit log entries** (AC: 7, 9)
  - [ ] After deactivation, insert AuditLog entry:
    - Action = "Deactivate"
    - Include reason
  - [ ] After deletion, insert AuditLog entry:
    - Action = "Delete" (soft delete)
    - Include reason
  - [ ] After reactivation, insert AuditLog entry:
    - Action = "Reactivate"
  - [ ] Ensure audit logs never deleted (no cascade delete)

### Frontend Tasks

- [ ] **Task 16: Create user service methods** (AC: 1, 2, 3, 5)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Add method: `deactivateUser(id, reason?): Observable<DeactivateUserResponse>`
  - [ ] Add method: `deleteUser(id, reason): Observable<DeleteUserResponse>`
  - [ ] Add method: `reactivateUser(id, reason?): Observable<ReactivateUserResponse>`
  - [ ] Call POST endpoints

- [ ] **Task 17: Add deactivate/delete actions to user list** (AC: 1)
  - [ ] In user list page (Story 3.1), add dropdown menu per user
  - [ ] Actions: "Deactivate", "Delete", "Reactivate" (if inactive)
  - [ ] Show/hide actions based on user status:
    - Active: Show "Deactivate" and "Delete"
    - Inactive: Show "Reactivate" and "Delete"
    - Deleted: No actions (cannot reactivate)
  - [ ] Different styling for dangerous actions (Delete = red)

- [ ] **Task 18: Create deactivation confirmation dialog** (AC: 4)
  - [ ] Use PrimeNG ConfirmDialog
  - [ ] Dialog content:
    - Title: "Deactivate User?"
    - Message: "Are you sure you want to deactivate {userName}?"
    - Warning: "User will not be able to log in"
    - Reason input field (optional)
    - Buttons: "Deactivate", "Cancel"
  - [ ] On confirm, call usersService.deactivateUser()

- [ ] **Task 19: Create deletion confirmation dialog** (AC: 4)
  - [ ] Use PrimeNG ConfirmDialog with custom template
  - [ ] Dialog content:
    - Title: "Delete User?"
    - Message: "Are you sure you want to DELETE {userName}?"
    - Strong warning: "This action marks the user as deleted. Deleted users cannot be reactivated."
    - Info: "Audit logs and historical data will be preserved."
    - Reason input field (required)
    - Type to confirm: "DELETE" in input field
    - Buttons: "Delete User" (red, disabled until confirmation typed), "Cancel"
  - [ ] On confirm, call usersService.deleteUser()

- [ ] **Task 20: Create reactivation confirmation dialog** (AC: 5)
  - [ ] Use PrimeNG ConfirmDialog
  - [ ] Dialog content:
    - Title: "Reactivate User?"
    - Message: "Are you sure you want to reactivate {userName}?"
    - Info: "User will be able to log in again"
    - Reason input field (optional)
    - Buttons: "Reactivate", "Cancel"
  - [ ] On confirm, call usersService.reactivateUser()

- [ ] **Task 21: Handle action responses** (AC: 8)
  - [ ] Show loading spinner during action
  - [ ] On success:
    - Deactivate: "User deactivated successfully. Notification email sent."
    - Delete: "User deleted successfully."
    - Reactivate: "User reactivated successfully. Notification email sent."
    - Refresh user list to show updated status
  - [ ] On error (404): "User not found"
  - [ ] On error (400): Display validation errors (e.g., "Cannot reactivate deleted user")
  - [ ] Use NotificationService for toast messages

- [ ] **Task 22: Display user status in list** (AC: 2, 3)
  - [ ] Update user list status column
  - [ ] Status values:
    - Active: Green badge
    - Inactive: Gray badge
    - Deleted: Red badge with strikethrough on name
  - [ ] Filter users by status (include "Show Deleted" checkbox)

- [ ] **Task 23: Update user details page** (AC: 2, 3, 5, 6)
  - [ ] In edit/view user page, show current status
  - [ ] If inactive: Show "Reactivate" button
  - [ ] If active: Show "Deactivate" and "Delete" buttons
  - [ ] If deleted: Show "DELETED" banner, no actions available
  - [ ] Display deactivation/deletion reason if exists
  - [ ] Display who deactivated/deleted and when

- [ ] **Task 24: Implement "Show Deleted Users" filter** (AC: 7)
  - [ ] Add checkbox: "Show Deleted Users" in user list filters
  - [ ] When checked, call backend with `includeDeleted=true` parameter
  - [ ] Backend uses `.IgnoreQueryFilters()` to include deleted users
  - [ ] Deleted users shown with special styling (grayed out, strikethrough)

### Testing Tasks

- [ ] **Task 25: Write unit tests for DeactivateUserCommandHandler** (AC: 2, 8, 9)
  - [ ] Test: `Handle_ValidCommand_DeactivatesUser`
  - [ ] Test: `Handle_UserNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_AlreadyInactive_ThrowsBusinessRuleViolation`
  - [ ] Test: `Handle_SendsDeactivationNotification`
  - [ ] Test: `Handle_CreatesAuditLog`
  - [ ] Test: `Handle_InvalidatesUserSessions`
  - [ ] Mock: IUserRepository, IEmailService, ISessionService, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 26: Write unit tests for DeleteUserCommandHandler** (AC: 3, 7, 9)
  - [ ] Test: `Handle_ValidCommand_SoftDeletesUser`
  - [ ] Test: `Handle_UserNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_AlreadyDeleted_ThrowsBusinessRuleViolation`
  - [ ] Test: `Handle_PreservesAuditData`
  - [ ] Test: `Handle_CreatesAuditLog`
  - [ ] Mock dependencies

- [ ] **Task 27: Write unit tests for ReactivateUserCommandHandler** (AC: 5, 6, 9)
  - [ ] Test: `Handle_InactiveUser_ReactivatesSuccessfully`
  - [ ] Test: `Handle_DeletedUser_ThrowsBusinessRuleViolation`
  - [ ] Test: `Handle_AlreadyActive_ThrowsBusinessRuleViolation`
  - [ ] Test: `Handle_SendsReactivationNotification`
  - [ ] Test: `Handle_CreatesAuditLog`
  - [ ] Mock dependencies

- [ ] **Task 28: Write integration tests for user status endpoints**
  - [ ] Test: `POST_DeactivateUser_ValidId_Returns200AndDeactivates`
  - [ ] Test: `POST_DeleteUser_ValidId_Returns200AndSoftDeletes`
  - [ ] Test: `POST_ReactivateUser_InactiveUser_Returns200AndReactivates`
  - [ ] Test: `POST_ReactivateUser_DeletedUser_Returns400`
  - [ ] Test: `GET_Users_IncludeDeleted_ReturnsDeletedUsers`
  - [ ] Test: `GET_Users_ExcludeDeleted_DoesNotReturnDeletedUsers` (default)
  - [ ] Use Testcontainers for database
  - [ ] Verify soft delete (user exists in DB with IsDeleted=true)
  - [ ] Verify audit logs created
  - [ ] Verify emails sent

- [ ] **Task 29: Write E2E test for deactivate/reactivate flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Select active user
    4. Click "Deactivate"
    5. Enter reason in dialog
    6. Confirm deactivation
    7. Verify success message
    8. Verify user status changed to "Inactive" in list
    9. Select same user
    10. Click "Reactivate"
    11. Confirm reactivation
    12. Verify user status changed to "Active"
  - [ ] Use Cypress or Playwright

- [ ] **Task 30: Write E2E test for delete flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Select user
    4. Click "Delete"
    5. Enter deletion reason
    6. Type "DELETE" to confirm
    7. Confirm deletion
    8. Verify success message
    9. Verify user no longer in list (unless "Show Deleted" checked)
    10. Check "Show Deleted Users"
    11. Verify user appears with "Deleted" status
    12. Verify "Reactivate" action not available for deleted user
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 3.4:**
- User editing with audit logging
- Email notification patterns
- Domain methods for user operations

**From Story 3.1:**
- User list view with filtering
- Status display

**Key Integration:**
- This story adds lifecycle management (deactivate, delete, reactivate)
- Soft delete preserves data for compliance/audit (AC: 7)
- Status field added to user entity
- Global query filter excludes deleted users by default

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Logging: Serilog 3.1.1

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG (ConfirmDialog)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── UsersController.cs (UPDATE - add Deactivate, Delete, Reactivate actions)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Commands/
│   │   ├── DeactivateUserCommand.cs (CREATE)
│   │   ├── DeactivateUserCommandHandler.cs (CREATE)
│   │   ├── DeleteUserCommand.cs (CREATE)
│   │   ├── DeleteUserCommandHandler.cs (CREATE)
│   │   ├── ReactivateUserCommand.cs (CREATE)
│   │   └── ReactivateUserCommandHandler.cs (CREATE)
│   └── DTOs/
│       ├── DeactivateUserResponse.cs (CREATE)
│       ├── DeleteUserResponse.cs (CREATE)
│       └── ReactivateUserResponse.cs (CREATE)
├── Application/UknfPlatform.Application.Shared/Interfaces/
│   └── ISessionService.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/
│   └── Entities/
│       └── User.cs (UPDATE - add IsDeleted, deletion fields, domain methods)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/
│   ├── Contexts/
│   │   └── ApplicationDbContext.cs (UPDATE - add query filter)
│   └── Migrations/
│       └── Add_UserDeletion_Fields.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Email/Templates/
    ├── AccountDeactivatedNotification.cshtml (CREATE)
    └── AccountReactivatedNotification.cshtml (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── users.service.ts (UPDATE - add deactivate, delete, reactivate methods)
└── features/admin/users/user-list/
    └── user-list.component.ts (UPDATE - add action handlers and dialogs)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table (Updated with Deletion Fields):**
```sql
CREATE TABLE Users (
    Id UUID PRIMARY KEY,
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    UserType NVARCHAR(20) NOT NULL,
    IsActive BIT NOT NULL DEFAULT 1,  -- FALSE = Inactive
    IsDeleted BIT NOT NULL DEFAULT 0, -- TRUE = Soft deleted (NEW)
    DeletedDate DATETIME2 NULL,       -- When deleted (NEW)
    DeletedBy UUID NULL,              -- Who deleted (FK to Users) (NEW)
    DeactivationReason NVARCHAR(500) NULL, -- Why deactivated (NEW)
    DeletionReason NVARCHAR(500) NULL,     -- Why deleted (NEW)
    CreatedDate DATETIME2 NOT NULL,
    UpdatedDate DATETIME2 NOT NULL,
    
    FOREIGN KEY (DeletedBy) REFERENCES Users(Id),
    INDEX IX_Users_IsActive (IsActive),
    INDEX IX_Users_IsDeleted (IsDeleted)
);
```

**User Status Logic:**
- **Active:** IsActive = true, IsDeleted = false
- **Inactive:** IsActive = false, IsDeleted = false
- **Deleted:** IsDeleted = true (IsActive irrelevant)

**State Transitions:**
- Active → Inactive (Deactivate)
- Inactive → Active (Reactivate)
- Active/Inactive → Deleted (Delete, one-way)
- Deleted → ✗ (Cannot reactivate)

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** POST `/api/admin/users/{id}/deactivate`
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "reason": "Employee no longer with organization"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "User deactivated successfully",
    "notificationSent": true,
    "performedDate": "2025-10-04T15:00:00Z",
    "performedBy": "admin@uknf.gov.pl"
  }
  ```

**Endpoint:** POST `/api/admin/users/{id}/delete`
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "reason": "Account cleanup - user requested deletion"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "User deleted successfully (soft delete)",
    "notificationSent": false,
    "performedDate": "2025-10-04T15:00:00Z",
    "performedBy": "admin@uknf.gov.pl"
  }
  ```

**Endpoint:** POST `/api/admin/users/{id}/reactivate`
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "reason": "Employee returned"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "User reactivated successfully",
    "notificationSent": true,
    "performedDate": "2025-10-04T15:00:00Z",
    "performedBy": "admin@uknf.gov.pl"
  }
  ```
- **Error Responses:**
  - 400: Bad Request (e.g., "Cannot reactivate deleted user")
  - 404: Not Found (user doesn't exist)
  - 403: Forbidden

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use soft delete, not hard delete**
   ```csharp
   // ✅ CORRECT - Soft delete
   user.Delete(reason, adminId);
   // Sets IsDeleted = true, preserves data
   
   // ❌ WRONG - Hard delete
   // _context.Users.Remove(user);
   ```

2. **Global query filter for soft deletes**
   ```csharp
   // ✅ CORRECT - ApplicationDbContext
   modelBuilder.Entity<User>()
       .HasQueryFilter(u => !u.IsDeleted);
   ```

3. **Use domain methods for state changes**
   ```csharp
   // ✅ CORRECT
   user.Deactivate(reason);
   user.Reactivate();
   user.Delete(reason, adminId);
   
   // ❌ WRONG
   // user.IsActive = false;
   ```

4. **Check state before operations**
   ```csharp
   // ✅ CORRECT
   if (user.IsDeleted)
       throw new BusinessRuleViolationException("Cannot reactivate deleted user");
   
   if (!user.CanReactivate())
       throw new BusinessRuleViolationException("User cannot be reactivated");
   ```

5. **Invalidate sessions on deactivation/deletion**
   ```csharp
   // ✅ CORRECT
   await _sessionService.InvalidateUserSessionsAsync(user.Id);
   // Force user to log out
   ```

6. **Preserve audit data**
   ```csharp
   // ✅ CORRECT - Audit logs never affected by soft delete
   // AuditLog entity has no query filter
   ```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 3

1. **Authorization:** Only System Administrators can deactivate/delete users
2. **Soft Delete:** Never permanently delete user data for audit/compliance
3. **Session Invalidation:** Force logout when user deactivated/deleted
4. **Audit Trail:** Log all status changes with reason
5. **Cannot Reactivate Deleted:** Deleted users cannot be reactivated (create new account instead)
6. **Confirmation Required:** Require confirmation before destructive actions

### Soft Delete Pattern

**Why Soft Delete?**
- Compliance: Audit logs reference user IDs
- Historical data: Reports, cases, messages created by user
- Forensics: Investigate user actions if needed
- GDPR: Can anonymize data if legally required

**Implementation:**
```csharp
public class User
{
    public bool IsDeleted { get; private set; }
    public DateTime? DeletedDate { get; private set; }
    public Guid? DeletedBy { get; private set; }
    public string? DeletionReason { get; private set; }
    
    public void Delete(string reason, Guid adminId)
    {
        if (IsDeleted)
            throw new InvalidOperationException("User already deleted");
            
        IsDeleted = true;
        DeletedDate = DateTime.UtcNow;
        DeletedBy = adminId;
        DeletionReason = reason;
        UpdatedDate = DateTime.UtcNow;
    }
    
    public bool CanReactivate()
    {
        return !IsActive && !IsDeleted;
    }
    
    public void Reactivate()
    {
        if (!CanReactivate())
            throw new BusinessRuleViolationException(
                "Can only reactivate inactive users that are not deleted");
                
        IsActive = true;
        UpdatedDate = DateTime.UtcNow;
    }
}
```

**EF Core Query Filter:**
```csharp
// ApplicationDbContext.OnModelCreating
modelBuilder.Entity<User>()
    .HasQueryFilter(u => !u.IsDeleted);

// Admin can query deleted users explicitly
var allUsers = await _context.Users
    .IgnoreQueryFilters()
    .ToListAsync();
```

### Session Invalidation

**Approaches:**
1. **JWT Blacklist:** Add token to blacklist until expiry
2. **Token Version:** Increment user's token version, reject old versions
3. **Redis Session:** Delete session from Redis
4. **Database Session:** Delete session records

**Example Implementation:**
```csharp
public interface ISessionService
{
    Task InvalidateUserSessionsAsync(Guid userId);
    Task<bool> IsSessionValidAsync(Guid userId, string tokenId);
}

public class SessionService : ISessionService
{
    private readonly IDistributedCache _cache;
    
    public async Task InvalidateUserSessionsAsync(Guid userId)
    {
        // Increment user's session version
        await _cache.SetStringAsync(
            $"user-session-version:{userId}",
            Guid.NewGuid().ToString(),
            new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromDays(7) });
    }
}
```

### Email Templates

**Account Deactivated Notification:**
```html
Subject: Your UKNF account has been deactivated

Dear {{FirstName}} {{LastName}},

Your account on the UKNF Communication Platform has been deactivated by a system administrator.

{{#if Reason}}
Reason: {{Reason}}
{{/if}}

You will no longer be able to log in to the platform.

If you believe this is an error or wish to request reactivation, please contact:
Email: support@uknf.gov.pl
Phone: +48 22 XXX XX XX

Best regards,
UKNF IT Team
```

**Account Reactivated Notification:**
```html
Subject: Your UKNF account has been reactivated

Dear {{FirstName}} {{LastName}},

Good news! Your account on the UKNF Communication Platform has been reactivated.

You can now log in to the platform again:
{{LoginUrl}}

Your Login Email: {{Email}}

If you have any questions, please contact support:
Email: support@uknf.gov.pl

Welcome back!

Best regards,
UKNF IT Team
```

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions

**Example:**
```csharp
[Fact]
public async Task Handle_DeletedUser_CannotBeReactivated()
{
    // Arrange
    var user = UserFactory.CreateInactiveUser();
    user.Delete("Test deletion", Guid.NewGuid());
    
    var command = new ReactivateUserCommand { UserId = user.Id };
    
    _userRepositoryMock
        .Setup(r => r.GetByIdAsync(user.Id))
        .ReturnsAsync(user);
    
    // Act & Assert
    await _handler
        .Invoking(h => h.Handle(command, CancellationToken.None))
        .Should()
        .ThrowAsync<BusinessRuleViolationException>()
        .WithMessage("*deleted*");
}
```

### Additional Notes

1. **Soft Delete is Mandatory:** Never hard delete users due to foreign key references in audit logs, reports, cases, messages, etc.

2. **Deletion Reason Required:** Deletion is permanent (cannot reactivate), so reason is mandatory for audit trail.

3. **Deactivation vs Deletion:**
   - **Deactivate:** Temporary, reversible (e.g., employee on leave)
   - **Delete:** Permanent, irreversible (e.g., account cleanup, GDPR request)

4. **Session Invalidation:** Essential for security. Deactivated/deleted users should be immediately logged out.

5. **Email Anonymization (Optional):** For GDPR compliance, consider anonymizing email on deletion: `deleted-{userId}@deleted.local`

6. **Show Deleted Users:** Admin interface should have option to view deleted users for audit purposes (use `.IgnoreQueryFilters()`).

7. **Cannot Delete Self:** Consider adding validation to prevent admin from deleting/deactivating their own account.

8. **Cascade Considerations:** Deletion doesn't cascade to related entities (reports, messages, etc.) - they remain with user ID for audit.

9. **Status Badge Colors:**
   - Active: Green
   - Inactive: Gray/Yellow
   - Deleted: Red with strikethrough

10. **Confirmation Dialog Security:** For deletion, require typing "DELETE" to confirm (prevents accidental clicks).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

