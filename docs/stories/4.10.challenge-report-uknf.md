# Story 4.10: Challenge Report (UKNF)

**Epic:** 4 - Reporting System  
**Story Number:** 4.10  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee,  
**I want to** challenge a report that passed technical validation but has substantive issues,  
**So that** the entity is notified to correct or clarify the report.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.10

1. UKNF Employee can select a report and choose "Challenge" action
2. Employee must provide "Description of irregularities" (mandatory text field)
3. Report validation status changes to "Contested by UKNF"
4. Description of irregularities is visible to the entity in report details
5. Entity receives email notification that report was challenged
6. Challenged status is prominently displayed in report lists and details
7. Challenge action is logged with timestamp, employee ID, and description
8. Entity can respond by submitting a correction or via messaging

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Update Report entity with challenge methods** (AC: 3, 4)
  - [ ] Update Report.cs domain entity (already has ContestedDescription, ContestedByUserId, ContestedDate from Story 4.1)
  - [ ] Add domain methods:
    - `Challenge(userId, description)`: Set status to ContestedByUKNF, store contest details
    - `CanBeChallenged(): bool` - business rules check
  - [ ] Add validation:
    - Description is required (AC 2)
    - Can only challenge reports with certain statuses (typically Successful)
    - Cannot challenge already contested reports without first resolving

- [ ] **Task 2: Create ChallengeReportCommand** (AC: 1, 2)
  - [ ] Create `ChallengeReportCommand.cs` in `Application/UknfPlatform.Application.Communication/Reports/Commands/`
  - [ ] Command properties:
    - ReportId (Guid, required)
    - DescriptionOfIrregularities (string, required, max 5000) - AC 2

- [ ] **Task 3: Create ChallengeReportCommandValidator** (AC: 2)
  - [ ] Create `ChallengeReportCommandValidator.cs` using FluentValidation
  - [ ] Validate ReportId: NotEmpty
  - [ ] Validate DescriptionOfIrregularities: NotEmpty, MaxLength(5000) - AC 2
  - [ ] Async validation: Report exists
  - [ ] Async validation: Report can be challenged (status check)

- [ ] **Task 4: Create ChallengeReportCommandHandler** (AC: 1, 2, 3, 4, 7)
  - [ ] Create `ChallengeReportCommandHandler.cs` implementing `IRequestHandler<ChallengeReportCommand, ChallengeReportResponse>`
  - [ ] Inject dependencies: IReportRepository, ICurrentUserService, IEmailService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Verify user is UKNF employee
    - Fetch report by ID
    - Verify report can be challenged
    - Call domain method: `report.Challenge(userId, description)`
    - Verify status changed to "ContestedByUKNF" (AC 3)
    - Verify ContestedDescription, ContestedByUserId, ContestedDate set (AC 4)
    - Save changes
    - Send email notification to submitter (AC 5)
    - Create audit log entry (AC 7)
    - Return success response
  - [ ] Use transaction

- [ ] **Task 5: Implement business rules for challenging** (AC: 1, 3)
  - [ ] Reports can be challenged if:
    - ValidationStatus = "Successful" (passed technical validation)
    - Not already contested (ContestedByUserId = null)
    - Not archived (optional business rule)
  - [ ] Add CanBeChallenged() domain method:
    ```csharp
    public bool CanBeChallenged()
    {
        return ValidationStatus == ValidationStatus.Successful && 
               ContestedByUserId == null;
    }
    ```

- [ ] **Task 6: Update Report domain method Challenge()** (AC: 2, 3, 4)
  - [ ] Domain method implementation:
    ```csharp
    public void Challenge(Guid uknfEmployeeId, string descriptionOfIrregularities)
    {
        if (!CanBeChallenged())
            throw new DomainException("Report cannot be challenged in current state");
        
        if (string.IsNullOrWhiteSpace(descriptionOfIrregularities))
            throw new DomainException("Description of irregularities is required");
        
        ValidationStatus = ValidationStatus.ContestedByUKNF; // AC 3
        ContestedDescription = descriptionOfIrregularities; // AC 4
        ContestedByUserId = uknfEmployeeId; // AC 7
        ContestedDate = DateTime.UtcNow; // AC 7
        UpdatedDate = DateTime.UtcNow;
    }
    ```

- [ ] **Task 7: Create REST API endpoint POST /api/admin/reports/{id}/challenge** (AC: 1, 2)
  - [ ] Update AdminReportsController
  - [ ] Add `[Authorize]` + UKNF employee check
  - [ ] Create POST action `ChallengeReportAsync(Guid id, [FromBody] ChallengeReportRequest request)`
  - [ ] Request body:
    ```json
    {
      "descriptionOfIrregularities": "..."
    }
    ```
  - [ ] Send ChallengeReportCommand via MediatR
  - [ ] Return 200 OK with ChallengeReportResponse
  - [ ] Return 400 if description missing or report cannot be challenged
  - [ ] Return 403 if not UKNF employee
  - [ ] Return 404 if report not found

- [ ] **Task 8: Send email notification to entity** (AC: 5)
  - [ ] After challenge, send email to report submitter
  - [ ] Email subject: "Report Challenged by UKNF - [Report Name]"
  - [ ] Email body:
    - "Your report [Report Name] submitted on [Date] has been challenged by UKNF."
    - "Reason: [Description of Irregularities]"
    - "Please review the report and submit a correction or contact UKNF for clarification."
    - "View Report Details: [Link to Report]"
  - [ ] Use IEmailService
  - [ ] CC entity administrators (optional)

- [ ] **Task 9: Create audit log entry** (AC: 7)
  - [ ] After challenge, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = UKNF employee ID (AC 7)
    - EntityType = "Report"
    - EntityPrimaryKey = report ID
    - Action = "ChallengeReport"
    - Timestamp = DateTime.UtcNow (AC 7)
    - Metadata = JSON with DescriptionOfIrregularities, ChallengedByName (AC 7)
  - [ ] Store full context for compliance

- [ ] **Task 10: Update GetReportDetailsQueryHandler** (AC: 4, 6)
  - [ ] Update handler from Story 4.3
  - [ ] Include contested information in ReportDetailsResponse:
    - ContestedDescription (AC 4)
    - ContestedByUser (UKNF employee name)
    - ContestedDate
  - [ ] External users see this info (AC 4)
  - [ ] UKNF employees see who challenged it

### Frontend Tasks

- [ ] **Task 11: Update reports service** (AC: 1, 2)
  - [ ] Update `reports.service.ts`
  - [ ] Method: `challengeReport(reportId, description): Observable<ChallengeReportResponse>`
  - [ ] Handle errors with catchError

- [ ] **Task 12: Add "Challenge" action to UKNF reports list** (AC: 1)
  - [ ] Update uknf-reports-list component from Story 4.6
  - [ ] Add "Challenge" action button/menu item
  - [ ] Show only for reports with status "Successful"
  - [ ] Single report selection required (not bulk)
  - [ ] Click "Challenge" opens dialog

- [ ] **Task 13: Create challenge report dialog** (AC: 1, 2)
  - [ ] Create `challenge-report-dialog.component.ts`
  - [ ] Dialog title: "Challenge Report"
  - [ ] Display report summary (name, entity, submitter, date)
  - [ ] Form field: "Description of Irregularities" (textarea, required, max 5000 chars) - AC 2
  - [ ] Character counter: 0/5000
  - [ ] Placeholder: "Describe the substantive issues found in this report..."
  - [ ] Buttons: "Challenge Report", "Cancel"
  - [ ] Validation: Description required
  - [ ] Use PrimeNG Dialog component

- [ ] **Task 14: Handle challenge submission** (AC: 3, 5, 6)
  - [ ] On "Challenge Report" click:
    - Validate description not empty
    - Show confirmation: "Are you sure you want to challenge this report?"
    - On confirm, call reportsService.challengeReport()
    - Show loading spinner
  - [ ] On success:
    - Close dialog
    - Show success message: "Report challenged successfully. Entity has been notified."
    - Reload reports list
    - Update report status to "Contested by UKNF" (AC 3)
  - [ ] On error:
    - Display error message (400: cannot challenge, 403: no permission)

- [ ] **Task 15: Display contested status in reports list** (AC: 6)
  - [ ] Update reports table from Story 4.6
  - [ ] For contested reports, show "Contested by UKNF" status badge
  - [ ] Badge color: Orange/warning
  - [ ] Badge icon: Flag or alert icon
  - [ ] Make prominently visible (AC 6)

- [ ] **Task 16: Display contested information in report details** (AC: 4, 6)
  - [ ] Update report-details component from Story 4.3
  - [ ] If status = "ContestedByUKNF", show prominent warning panel (AC 6)
  - [ ] Panel content (AC 4):
    - Title: "This report has been contested by UKNF"
    - "Reason: [Description of Irregularities]"
    - "Challenged by: [UKNF Employee Name]"
    - "Date: [Contest Date]"
  - [ ] Call to action (AC 8):
    - "You can respond by submitting a correction or contacting UKNF"
    - "Submit Correction" button (links to Story 4.4)
    - "Send Message" button (links to Epic 5 messaging - future)
  - [ ] Use PrimeNG Message component with severity "warn"

- [ ] **Task 17: Add contested indicator in report details header** (AC: 6)
  - [ ] Show prominent "Contested" badge in header
  - [ ] Icon: Flag or warning triangle
  - [ ] Color: Orange
  - [ ] Tooltip: "This report has been challenged by UKNF"

- [ ] **Task 18: Enable correction submission for contested reports** (AC: 8)
  - [ ] Update submit-correction component from Story 4.4
  - [ ] Allow corrections for reports with status "ContestedByUKNF"
  - [ ] Show contested description in correction form for context
  - [ ] User can address irregularities in correction

### Testing Tasks

- [ ] **Task 19: Write unit tests for ChallengeReportCommandHandler**
  - [ ] Test: `Handle_ValidChallenge_UpdatesStatusToContested` (AC 3)
  - [ ] Test: `Handle_ValidChallenge_SetsContestedDescription` (AC 4)
  - [ ] Test: `Handle_MissingDescription_ThrowsValidationException` (AC 2)
  - [ ] Test: `Handle_ReportNotSuccessful_ThrowsValidationException`
  - [ ] Test: `Handle_AlreadyContested_ThrowsValidationException`
  - [ ] Test: `Handle_SendsEmailNotification` (AC 5)
  - [ ] Test: `Handle_CreatesAuditLog` (AC 7)
  - [ ] Test: `Handle_ExternalUserAttempt_ThrowsForbiddenException`
  - [ ] Mock: IReportRepository, IEmailService, ICurrentUserService

- [ ] **Task 20: Write unit tests for Report.Challenge() domain method**
  - [ ] Test: `Challenge_ValidReport_SetsStatusToContested` (AC 3)
  - [ ] Test: `Challenge_EmptyDescription_ThrowsDomainException` (AC 2)
  - [ ] Test: `Challenge_NonSuccessfulStatus_ThrowsDomainException`
  - [ ] Test: `Challenge_SetsContestedFields` (AC 4, 7)

- [ ] **Task 21: Write integration test for challenge endpoint**
  - [ ] Test: `POST_ChallengeReport_ValidRequest_Returns200` (AC 1, 2)
  - [ ] Test: `POST_ChallengeReport_MissingDescription_Returns400` (AC 2)
  - [ ] Test: `POST_ChallengeReport_NonSuccessfulReport_Returns400`
  - [ ] Test: `POST_ChallengeReport_AlreadyContested_Returns400`
  - [ ] Test: `POST_ChallengeReport_UknfEmployee_Returns200`
  - [ ] Test: `POST_ChallengeReport_ExternalUser_Returns403`
  - [ ] Verify ValidationStatus = "ContestedByUKNF" in database (AC 3)
  - [ ] Verify ContestedDescription set (AC 4)
  - [ ] Verify ContestedByUserId and ContestedDate set (AC 7)
  - [ ] Verify email sent (AC 5)
  - [ ] Verify audit log created (AC 7)

- [ ] **Task 22: Write E2E test for challenge flow**
  - [ ] Test workflow:
    1. Login as external user
    2. Submit report (Q1 test file - passes validation)
    3. Wait for validation to complete with "Successful" status
    4. Logout
    5. Login as UKNF employee
    6. Navigate to Reports
    7. Find the successful report
    8. Click "Challenge" action (AC 1)
    9. Enter description of irregularities (AC 2)
    10. Submit challenge
    11. Verify success message
    12. Verify report status shows "Contested by UKNF" (AC 3, 6)
    13. Logout
    14. Login as external user
    15. Navigate to report details
    16. Verify contested warning panel displayed (AC 4, 6)
    17. Verify description of irregularities visible (AC 4)
    18. Verify "Submit Correction" button available (AC 8)
    19. Check email (MailDev) for challenge notification (AC 5)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.1:**
- Report entity has ContestedDescription, ContestedByUserId, ContestedDate fields
- ValidationStatus enum includes ContestedByUKNF

**From Story 4.3:**
- Report details component displays validation results
- This story adds contested information display

**From Story 4.4:**
- Correction submission for error reports
- This story enables corrections for contested reports

**Key Integration:**
- Challenging a report changes its status to "ContestedByUKNF"
- Entity sees contested status and description
- Entity can respond via correction (Story 4.4) or messaging (Epic 5)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- Email: IEmailService (MailDev for demo)

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Dialog, Message)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AdminReportsController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Reports/Commands/
│   ├── ChallengeReportCommand.cs (CREATE)
│   ├── ChallengeReportCommandHandler.cs (CREATE)
│   └── ChallengeReportCommandValidator.cs (CREATE)
└── Domain/UknfPlatform.Domain.Communication/Entities/
    └── Report.cs (UPDATE - add Challenge method)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
├── features/admin/uknf-reports-list/
│   ├── uknf-reports-list.component.ts (UPDATE)
│   └── components/
│       └── challenge-report-dialog.component.ts (CREATE)
└── features/reporting/report-details/
    └── report-details.component.ts (UPDATE)
```

### Data Models

**Report Entity (from Story 4.1):**
- ContestedDescription (string?, nullable) - AC 4
- ContestedByUserId (Guid?, nullable) - AC 7
- ContestedDate (DateTime?, nullable) - AC 7
- ValidationStatus enum includes "ContestedByUKNF" - AC 3

### REST API Specification

**Endpoint:** POST `/api/admin/reports/{id}/challenge`
- **Security:** UKNF employees only
- **Request:**
  ```json
  {
    "descriptionOfIrregularities": "The total assets figure appears inconsistent with the quarterly trend. Please verify calculations in worksheet 'Balance Sheet', cell B15."
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "reportId": "guid",
    "status": "ContestedByUKNF",
    "contestedBy": "Anna Nowak",
    "contestedDate": "2025-10-04T14:30:00Z",
    "message": "Report challenged successfully. Entity has been notified."
  }
  ```
- **Error Responses:**
  - 400: Bad Request (description missing, report cannot be challenged)
  - 403: Forbidden (not UKNF employee)
  - 404: Not Found (report doesn't exist)

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use domain method (AC 3)**
   ```csharp
   // ✅ CORRECT
   report.Challenge(userId, description);
   
   // ❌ WRONG
   // report.ValidationStatus = ValidationStatus.ContestedByUKNF;
   // report.ContestedDescription = description;
   ```

2. **Mandatory description (AC 2)**
   ```csharp
   // ✅ CORRECT - Validate in domain method
   if (string.IsNullOrWhiteSpace(descriptionOfIrregularities))
       throw new DomainException("Description of irregularities is required");
   ```

3. **Email notification (AC 5)**
   ```csharp
   // ✅ CORRECT - Send to submitter
   await _emailService.SendAsync(new Email
   {
       To = report.User.Email,
       Subject = $"Report Challenged by UKNF - {report.FileName}",
       Body = GenerateChallengeEmailBody(report, descriptionOfIrregularities)
   });
   ```

4. **Audit logging with full context (AC 7)**
   ```csharp
   // ✅ CORRECT - Include employee ID, timestamp, description
   await _auditService.LogAsync(new AuditLog
   {
       Action = "ChallengeReport",
       EntityType = "Report",
       EntityPrimaryKey = reportId,
       UserId = uknfEmployeeId, // AC 7
       Timestamp = DateTime.UtcNow, // AC 7
       Metadata = new 
       { 
           DescriptionOfIrregularities = description, // AC 7
           ChallengedBy = currentUser.Name,
           ReportFileName = report.FileName
       }
   });
   ```

5. **Prominent UI display (AC 6)**
   ```html
   <!-- ✅ CORRECT - Prominent warning -->
   <p-message 
     *ngIf="report.validationStatus === 'ContestedByUKNF'" 
     severity="warn" 
     [closable]="false">
     <ng-template pTemplate>
       <div class="flex flex-col gap-2">
         <strong>⚠️ This report has been contested by UKNF</strong>
         <p>{{ report.contestedDescription }}</p>
         <p class="text-sm">Challenged by: {{ report.contestedByName }} on {{ report.contestedDate | date }}</p>
       </div>
     </ng-template>
   </p-message>
   ```

### Business Rules

**When can a report be challenged?**
- Report has ValidationStatus = "Successful" (passed technical validation)
- Report is NOT already contested (ContestedByUserId = null)
- Only UKNF employees can challenge reports

**Why challenge instead of reject during validation?**
- Technical validation checks file format, data types, calculations
- Challenge is for substantive/business issues that pass technical checks
- Example: Numbers are technically correct but trend doesn't match expectations

**Response options for entity (AC 8):**
1. **Submit Correction:** Address the irregularities and resubmit (Story 4.4)
2. **Send Message:** Contact UKNF for clarification (Epic 5)
3. **Do Nothing:** Report remains contested (not ideal)

### Email Notification Template (AC 5)

**Subject:** Report Challenged by UKNF - [Report Name]

**Body:**
```
Dear [Entity Name],

Your report "[Report Name]" submitted on [Submission Date] has been challenged by UKNF.

Reason for Challenge:
[Description of Irregularities]

What you can do:
- Review the report carefully
- Submit a correction if needed: [Link to Submit Correction]
- Contact UKNF for clarification: [Link to Messaging]

Report Details: [Link to Report Details Page]

Best regards,
UKNF Platform
```

### UI/UX Considerations

**Challenge Dialog:**
```html
<p-dialog header="Challenge Report" [(visible)]="showChallengeDialog" [modal]="true">
  <div class="flex flex-col gap-4">
    <div class="report-summary">
      <strong>Report:</strong> {{ selectedReport.fileName }}<br>
      <strong>Entity:</strong> {{ selectedReport.entityName }}<br>
      <strong>Submitted:</strong> {{ selectedReport.submittedDate | date }}<br>
      <strong>Status:</strong> {{ selectedReport.validationStatus }}
    </div>
    
    <div>
      <label class="font-semibold">Description of Irregularities *</label>
      <textarea 
        pInputTextarea 
        [(ngModel)]="descriptionOfIrregularities" 
        rows="6" 
        [maxlength]="5000"
        placeholder="Describe the substantive issues found in this report..."
        class="w-full">
      </textarea>
      <small class="text-gray-600">{{ descriptionOfIrregularities.length }}/5000 characters</small>
    </div>
    
    <p-message severity="warn" [closable]="false">
      The entity will be notified via email and can respond by submitting a correction.
    </p-message>
  </div>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" (click)="showChallengeDialog = false" class="p-button-text"></button>
    <button pButton label="Challenge Report" icon="pi pi-flag" (click)="submitChallenge()" [disabled]="!descriptionOfIrregularities"></button>
  </ng-template>
</p-dialog>
```

**Contested Status Display:**
```html
<p-tag 
  value="Contested by UKNF" 
  severity="warning" 
  icon="pi pi-flag"
  styleClass="text-lg">
</p-tag>
```

### Security Requirements

- Only UKNF employees can challenge reports
- External users cannot challenge (no access to action)
- All challenge actions logged for audit (AC 7)
- Description of irregularities visible to entity (transparency)

### Performance Considerations

- Challenge is infrequent operation (not performance-critical)
- Email sent asynchronously (don't block response)
- Audit logging doesn't impact user experience

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Challenge sets status to ContestedByUKNF
- Description is mandatory
- Only Successful reports can be challenged
- Email notification sent
- Audit logging includes employee ID and description
- External user denied access

**Example:**
```csharp
[Fact]
public async Task Handle_ValidChallenge_UpdatesStatusAndNotifiesEntity()
{
    // Arrange - AC 3, 5
    var report = CreateTestReport(validationStatus: ValidationStatus.Successful);
    await _context.Reports.AddAsync(report);
    await _context.SaveChangesAsync();
    
    var command = new ChallengeReportCommand
    {
        ReportId = report.Id,
        DescriptionOfIrregularities = "Total assets figure inconsistent with trend"
    };
    
    _currentUserServiceMock.Setup(s => s.UserId).Returns(Guid.NewGuid());
    _currentUserServiceMock.Setup(s => s.UserType).Returns(UserType.Internal);
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    var challengedReport = await _context.Reports.FindAsync(report.Id);
    challengedReport.ValidationStatus.Should().Be(ValidationStatus.ContestedByUKNF); // AC 3
    challengedReport.ContestedDescription.Should().Be(command.DescriptionOfIrregularities); // AC 4
    challengedReport.ContestedByUserId.Should().NotBeNull(); // AC 7
    challengedReport.ContestedDate.Should().BeCloseTo(DateTime.UtcNow, TimeSpan.FromSeconds(5)); // AC 7
    
    _emailServiceMock.Verify(e => e.SendAsync(
        It.Is<Email>(email => email.To == report.User.Email)), // AC 5
        Times.Once);
}
```

### Additional Notes

1. **Challenge vs. ValidationErrors:** Challenge is manual/subjective, ValidationErrors are automatic/objective from validation service.

2. **Multiple Challenges:** Business rule: Cannot challenge already contested report. Must first resolve (entity submits correction, UKNF reviews).

3. **Resolve Challenge:** Not explicitly in AC, but implied workflow: Entity submits correction → Correction validated → If successful, original contest "resolved".

4. **Challenge History:** Consider tracking challenge history if reports can be challenged multiple times (after corrections).

5. **Messaging Integration (AC 8):** Epic 5 will provide messaging for UKNF-entity communication. Challenge description provides context for conversation.

6. **Challenge Reasons Taxonomy:** Future enhancement: Predefined challenge categories (Data Accuracy, Calculation Error, Missing Information, etc.) + free text.

7. **Bulk Challenge:** Not in AC, but could be useful if multiple reports from same entity have same issue. Not in scope for now.

8. **Challenge Escalation:** If entity disputes challenge, need escalation mechanism. Out of scope for MVP.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

