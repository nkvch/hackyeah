# Story 7.3: Publish Announcement

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.3  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As a** UKNF Employee,  
**I want to** publish draft announcements,  
**So that** they become visible to designated recipients.

---

## Acceptance Criteria

1. Employee can select draft announcement and choose "Publish"
2. System validates all required fields are completed
3. System validates recipients are selected
4. Upon publishing, announcement becomes visible to designated external users immediately
5. Announcement appears on users' bulletin board/start page
6. New announcement indicator appears for users (e.g., badge, highlight)
7. High-priority announcements are prominently displayed (e.g., at top, different color)
8. Users receive email notification if announcement is High priority (optional: configurable)
9. System logs publication with timestamp and employee ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create PublishAnnouncementCommand** (AC: 1, 2, 3)
  - [ ] Create `PublishAnnouncementCommand.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Commands/`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)

- [ ] **Task 2: Create PublishAnnouncementCommandValidator** (AC: 2, 3)
  - [ ] Create `PublishAnnouncementCommandValidator.cs` using FluentValidation
  - [ ] Validate AnnouncementId: NotEmpty
  - [ ] Async validation: Announcement exists and is in Draft status
  - [ ] Async validation: Announcement has all required fields (title, content, category, priority)
  - [ ] Async validation: Announcement has at least one recipient configured

- [ ] **Task 3: Create PublishAnnouncementCommandHandler** (AC: 1, 4, 5, 9)
  - [ ] Create `PublishAnnouncementCommandHandler.cs` implementing `IRequestHandler<PublishAnnouncementCommand, PublishAnnouncementResponse>`
  - [ ] Inject dependencies: IAnnouncementRepository, IRecipientCalculator, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Load announcement
    - Check user has "announcements.publish" permission
    - Verify announcement is in Draft status
    - Validate all required fields present
    - Validate recipients configured
    - Call announcement.Publish() domain method
    - Set PublicationDate = DateTime.UtcNow
    - Save announcement
    - Calculate recipients
    - Publish AnnouncementPublishedEvent (with recipient list)
    - Log publication
    - Return PublishAnnouncementResponse

- [ ] **Task 4: Add Publish domain method to Announcement entity** (AC: 4)
  - [ ] Update `Announcement.cs`
  - [ ] Add `Publish()` method:
    - Check status is Draft
    - Set status to Published
    - Set PublicationDate to now
    - Validate required fields
    - Validate recipients
  - [ ] Add domain validation

- [ ] **Task 5: Create AnnouncementPublishedEvent** (AC: 5, 6, 8)
  - [ ] Create or update `AnnouncementPublishedEvent.cs` in `Domain/UknfPlatform.Domain.Communication/Events/`
  - [ ] Event properties:
    - AnnouncementId (Guid)
    - Title (string)
    - Priority (string)
    - RecipientUserIds (List<Guid>)
    - RecipientEmails (List<string>) - for non-system contacts
    - PublishedBy (Guid)
    - PublishedDate (DateTime)
  - [ ] Event published to message queue

- [ ] **Task 6: Create AnnouncementPublishedEventHandler** (AC: 5, 6, 8)
  - [ ] Create `AnnouncementPublishedEventHandler.cs` in `Application/UknfPlatform.Application.Communication/Announcements/EventHandlers/`
  - [ ] Inject dependencies: INotificationService, IEmailService
  - [ ] Handler logic:
    - Create in-app notifications for all system user recipients
    - Mark notifications as unread (creates "new" indicator)
    - If announcement is High priority, send email notifications
    - Send emails to contact email addresses

- [ ] **Task 7: Create PublishAnnouncementResponse DTO** (AC: 4, 5)
  - [ ] Create `PublishAnnouncementResponse.cs` record
  - [ ] Properties:
    - AnnouncementId (Guid)
    - Status (string) - "Published"
    - PublishedDate (DateTime)
    - RecipientCount (int)
    - Message (string)

- [ ] **Task 8: Create REST API endpoint POST /api/announcements/{id}/publish** (AC: 1)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `PublishAnnouncementAsync(Guid id)`
  - [ ] Return 200 OK with PublishAnnouncementResponse
  - [ ] Return 404 if announcement not found
  - [ ] Return 400 if announcement is not in Draft status or validation fails
  - [ ] Return 403 if user lacks permission

- [ ] **Task 9: Create read tracking for announcements** (AC: 6)
  - [ ] Create `AnnouncementReads` table:
    ```sql
    CREATE TABLE AnnouncementReads (
        Id BIGINT IDENTITY(1,1) PRIMARY KEY,
        AnnouncementId UUID NOT NULL,
        UserId UUID NOT NULL,
        ReadDate DATETIME2 NOT NULL,
        FOREIGN KEY (AnnouncementId) REFERENCES Announcements(Id),
        FOREIGN KEY (UserId) REFERENCES Users(Id),
        UNIQUE (AnnouncementId, UserId)
    );
    ```
  - [ ] Track when user views announcement (Story 7.5)
  - [ ] Used to show "new" indicator for unread announcements

### Frontend Tasks

- [ ] **Task 10: Create publish announcement action** (AC: 1)
  - [ ] In announcement list or detail view, add "Publish" button
  - [ ] Show "Publish" button only for announcements in Draft status
  - [ ] Show confirmation dialog: "Are you sure you want to publish this announcement? It will be visible to X recipients."
  - [ ] On confirm, call announcementsService.publishAnnouncement(id)

- [ ] **Task 11: Implement publishAnnouncement service method** (AC: 1, 4)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `publishAnnouncement(id: string): Observable<PublishAnnouncementResponse>`
  - [ ] Call POST `/api/announcements/{id}/publish`
  - [ ] Handle errors

- [ ] **Task 12: Handle publish success** (AC: 4, 5)
  - [ ] On success (200):
    - Display success message: "Announcement published successfully! Visible to X recipients."
    - Refresh announcement detail/list
    - Update status to "Published"
  - [ ] On error (400): Display validation errors
  - [ ] On error (403): Display "You don't have permission to publish announcements"
  - [ ] On error (404): Display "Announcement not found"

- [ ] **Task 13: Show published status** (AC: 5)
  - [ ] In announcement list, show status badge: "Draft", "Published", "Removed"
  - [ ] Published announcements have "Published" badge (green)
  - [ ] Show publication date

### Testing Tasks

- [ ] **Task 14: Write unit tests for PublishAnnouncementCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidDraftAnnouncement_PublishesSuccessfully`
  - [ ] Test: `Handle_AnnouncementNotDraft_ThrowsBadRequestException`
  - [ ] Test: `Handle_MissingRequiredFields_ThrowsValidationException`
  - [ ] Test: `Handle_NoRecipients_ThrowsValidationException`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_PublishesAnnouncementPublishedEvent`
  - [ ] Test: `Handle_SetsPublicationDate`
  - [ ] Mock: IAnnouncementRepository, IRecipientCalculator, ILogger

- [ ] **Task 15: Write unit tests for AnnouncementPublishedEventHandler** (AC: 6, 8)
  - [ ] Test: `Handle_CreatesInAppNotificationsForRecipients`
  - [ ] Test: `Handle_HighPriority_SendsEmailNotifications`
  - [ ] Test: `Handle_LowPriority_DoesNotSendEmails`
  - [ ] Mock: INotificationService, IEmailService

- [ ] **Task 16: Write integration test for publish announcement**
  - [ ] Test: `POST_PublishAnnouncement_ValidDraft_Returns200AndPublishes`
  - [ ] Test: `POST_PublishAnnouncement_AlreadyPublished_Returns400`
  - [ ] Test: `POST_PublishAnnouncement_UserLacksPermission_Returns403`
  - [ ] Test: `POST_PublishAnnouncement_PublishesEventAndCreatesNotifications`
  - [ ] Use Testcontainers
  - [ ] Verify announcement status updated to Published
  - [ ] Verify PublicationDate set
  - [ ] Verify event published

---

## Dev Notes

### Publication Workflow

1. **Draft → Published**: Employee clicks "Publish"
2. **Validation**: System checks required fields and recipients
3. **Status Change**: Announcement status updated to Published
4. **Event**: AnnouncementPublishedEvent published to message queue
5. **Notifications**: Event handler creates in-app notifications for recipients
6. **Emails**: If High priority, send email notifications
7. **Visibility**: Announcement immediately visible on bulletin board for recipients

### Email Notification Logic

**High-priority announcements only:**
- Send email to all system user recipients
- Send email to all contact email addresses (non-system users)
- Email includes: Announcement title, excerpt, link to bulletin board

**Low/Medium priority:**
- No email sent
- Only in-app notification

### New Announcement Indicator

Track which users have read each announcement using `AnnouncementReads` table.

**Frontend logic:**
- Query: Get all announcements for current user where no read record exists
- Display: Show "NEW" badge or highlight for unread announcements
- Mark as read: When user views announcement detail (Story 7.5)

### Dependencies

**Prerequisites:**
- **Story 7.1**: Create Announcement (draft announcements must exist)
- **Story 7.2**: Set Announcement Recipients (recipients must be configured)
- **Epic 1**: Authentication & authorization
- **Email service**: For High-priority notifications

**Blocks:**
- **Story 7.4**: View Bulletin Board (users need published announcements to view)
- **Story 7.5**: Read Announcement Details (read tracking)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

