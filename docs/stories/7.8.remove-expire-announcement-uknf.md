# Story 7.8: Remove/Expire Announcement (UKNF)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.8  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** remove announcements from publication,  
**So that** outdated information is not visible to users.

---

## Acceptance Criteria

1. Employee can select announcement and choose:
   - **Remove from publication**: Announcement immediately hidden from external users
   - **Delete**: Announcement removed entirely (soft delete recommended)
   - **Set expiration date**: Announcement auto-expires on specified date
2. System prompts confirmation for deletion
3. Removed/expired announcements no longer appear on bulletin board
4. Removed announcements can be accessed in "Removed Announcements" admin section
5. Deleted announcements remain in database for audit but are not restorable
6. System logs removal/deletion with timestamp and employee ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create RemoveAnnouncementCommand** (AC: 1)
  - [ ] Create `RemoveAnnouncementCommand.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Commands/`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)

- [ ] **Task 2: Create RemoveAnnouncementCommandHandler** (AC: 1, 3, 6)
  - [ ] Create `RemoveAnnouncementCommandHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, ICurrentUserService, IAnnouncementHistoryRepository, ILogger
  - [ ] Handler logic:
    - Load announcement
    - Check user has "announcements.remove" permission
    - Set status = Removed
    - Save announcement
    - Create history record
    - Log removal
    - Return success response

- [ ] **Task 3: Create DeleteAnnouncementCommand** (AC: 1, 2, 5)
  - [ ] Create `DeleteAnnouncementCommand.cs`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)

- [ ] **Task 4: Create DeleteAnnouncementCommandHandler** (AC: 1, 2, 5, 6)
  - [ ] Create `DeleteAnnouncementCommandHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, ICurrentUserService, IAnnouncementHistoryRepository, ILogger
  - [ ] Handler logic:
    - Load announcement
    - Check user has "announcements.delete" permission
    - Set status = Deleted (soft delete)
    - Do NOT physically delete from database (keep for audit)
    - Save announcement
    - Create history record
    - Log deletion
    - Return success response

- [ ] **Task 5: Create SetExpirationDateCommand** (AC: 1)
  - [ ] Create `SetExpirationDateCommand.cs`
  - [ ] Command properties:
    - AnnouncementId (Guid, required)
    - ExpirationDate (DateTime, required)

- [ ] **Task 6: Create SetExpirationDateCommandHandler** (AC: 1, 3, 6)
  - [ ] Create `SetExpirationDateCommandHandler.cs`
  - [ ] Inject dependencies: IAnnouncementRepository, ICurrentUserService, IAnnouncementHistoryRepository, ILogger
  - [ ] Handler logic:
    - Load announcement
    - Check user has "announcements.edit" permission
    - Validate ExpirationDate is future date
    - Set ExpirationDate
    - Save announcement
    - Create history record
    - Log action
    - Return success response

- [ ] **Task 7: Implement automatic expiration** (AC: 3)
  - [ ] Create background job or query-time filtering
  - [ ] Option 1: Background job runs daily, sets status = Expired for announcements where ExpirationDate < now
  - [ ] Option 2: Query-time filtering (recommended):
    - Don't change status
    - Filter out expired announcements in GetAnnouncementsForUserQuery
    - WHERE (ExpirationDate IS NULL OR ExpirationDate > now)

- [ ] **Task 8: Create REST API endpoint POST /api/announcements/{id}/remove** (AC: 1)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `RemoveAnnouncementAsync(Guid id)`
  - [ ] Return 200 OK
  - [ ] Return 404 if not found
  - [ ] Return 403 if lacks permission

- [ ] **Task 9: Create REST API endpoint DELETE /api/announcements/{id}** (AC: 1, 2)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `DeleteAnnouncementAsync(Guid id)`
  - [ ] Return 200 OK or 204 No Content
  - [ ] Return 404 if not found
  - [ ] Return 403 if lacks permission

- [ ] **Task 10: Create REST API endpoint PUT /api/announcements/{id}/expiration** (AC: 1)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `SetExpirationDateAsync(Guid id, [FromBody] SetExpirationRequest request)`
  - [ ] Request body: { expirationDate: "2025-12-31T23:59:59Z" }
  - [ ] Return 200 OK
  - [ ] Return 400 if date is past
  - [ ] Return 404 if not found
  - [ ] Return 403 if lacks permission

- [ ] **Task 11: Create query for removed announcements** (AC: 4)
  - [ ] Create `GetRemovedAnnouncementsQuery.cs`
  - [ ] Query handler returns announcements where status = Removed
  - [ ] Support pagination, filtering, search
  - [ ] Only accessible to UKNF Employees

- [ ] **Task 12: Create REST API endpoint GET /api/announcements/removed** (AC: 4)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetRemovedAnnouncementsAsync([FromQuery] GetRemovedAnnouncementsQuery query)`
  - [ ] Return 200 OK with list of removed announcements
  - [ ] Require "announcements.view_removed" permission

### Frontend Tasks

- [ ] **Task 13: Add remove/delete actions to announcement detail** (AC: 1)
  - [ ] Update `announcement-detail.component.ts` from Story 7.5
  - [ ] Add "Remove from Publication" button (visible only to UKNF Employees)
  - [ ] Add "Delete" button (visible only to UKNF Employees)
  - [ ] Add "Set Expiration Date" button or date picker

- [ ] **Task 14: Implement remove announcement** (AC: 1, 3)
  - [ ] On "Remove from Publication" click:
    - Show confirmation dialog: "Are you sure you want to remove this announcement from publication? It will no longer be visible to users."
    - On confirm, call announcementsService.removeAnnouncement(id)
  - [ ] On success:
    - Display success message: "Announcement removed from publication"
    - Navigate back to announcements list
    - Announcement no longer visible to external users

- [ ] **Task 15: Implement delete announcement** (AC: 1, 2, 5)
  - [ ] On "Delete" click:
    - Show confirmation dialog: "Are you sure you want to delete this announcement? This action cannot be undone."
    - On confirm, call announcementsService.deleteAnnouncement(id)
  - [ ] On success:
    - Display success message: "Announcement deleted"
    - Navigate back to announcements list

- [ ] **Task 16: Implement set expiration date** (AC: 1, 3)
  - [ ] Show date picker to select expiration date
  - [ ] Validate date is in future
  - [ ] On submit, call announcementsService.setExpirationDate(id, date)
  - [ ] On success:
    - Display success message: "Expiration date set. Announcement will expire on [date]"
    - Update announcement detail to show expiration date

- [ ] **Task 17: Implement removeAnnouncement service method** (AC: 1)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `removeAnnouncement(id: string): Observable<void>`
  - [ ] Call POST `/api/announcements/{id}/remove`
  - [ ] Handle errors

- [ ] **Task 18: Implement deleteAnnouncement service method** (AC: 1, 2)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `deleteAnnouncement(id: string): Observable<void>`
  - [ ] Call DELETE `/api/announcements/{id}`
  - [ ] Handle errors

- [ ] **Task 19: Implement setExpirationDate service method** (AC: 1)
  - [ ] Add method to `announcementsService.ts`
  - [ ] `setExpirationDate(id: string, date: Date): Observable<void>`
  - [ ] Call PUT `/api/announcements/{id}/expiration`
  - [ ] Handle errors

- [ ] **Task 20: Create removed announcements view** (AC: 4)
  - [ ] Create `removed-announcements.component.ts`
  - [ ] Configure routing: `/announcements/removed` with auth + permission guard
  - [ ] Load via announcementsService.getRemovedAnnouncements()
  - [ ] Display list of removed announcements
  - [ ] Show removal date, removed by employee
  - [ ] Allow viewing details (read-only)
  - [ ] Optional: Allow "Restore" action to re-publish

### Testing Tasks

- [ ] **Task 21: Write unit tests for RemoveAnnouncementCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidAnnouncement_RemovesAnnouncement`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_AnnouncementNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_CreatesHistoryRecord`
  - [ ] Test: `Handle_LogsRemoval`
  - [ ] Mock: IAnnouncementRepository, IAnnouncementHistoryRepository, ILogger

- [ ] **Task 22: Write unit tests for DeleteAnnouncementCommandHandler** (AC: 2, 5, 6)
  - [ ] Test: `Handle_ValidAnnouncement_DeletesAnnouncement`
  - [ ] Test: `Handle_SoftDeletesOnly`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_CreatesHistoryRecord`
  - [ ] Test: `Handle_LogsDeletion`

- [ ] **Task 23: Write unit tests for SetExpirationDateCommandHandler** (AC: 1, 3, 6)
  - [ ] Test: `Handle_ValidDate_SetsExpirationDate`
  - [ ] Test: `Handle_PastDate_ThrowsValidationException`
  - [ ] Test: `Handle_UserLacksPermission_ThrowsForbiddenException`
  - [ ] Test: `Handle_CreatesHistoryRecord`

- [ ] **Task 24: Write integration test for announcement removal/deletion**
  - [ ] Test: `POST_RemoveAnnouncement_Returns200AndRemoves`
  - [ ] Test: `DELETE_DeleteAnnouncement_Returns200AndSoftDeletes`
  - [ ] Test: `PUT_SetExpirationDate_Returns200AndSetsDate`
  - [ ] Test: `GET_Announcements_ExcludesRemovedAndExpired`
  - [ ] Test: `GET_RemovedAnnouncements_ReturnsOnlyRemoved`
  - [ ] Use Testcontainers
  - [ ] Verify status changes in database
  - [ ] Verify history records created
  - [ ] Verify removed announcements not visible to external users

---

## Dev Notes

### Soft Delete vs. Hard Delete

**Soft Delete (Recommended):**
- Set status = Deleted
- Keep record in database for audit
- Not restorable (or restorable with special admin action)
- Advantages: Audit trail, compliance, reversible

**Hard Delete:**
- Physically remove from database
- Permanent, irreversible
- Advantages: Data minimization, GDPR compliance
- Disadvantages: Loss of audit trail

**Recommendation:** Use soft delete. If GDPR requires physical deletion, implement as separate "Purge" action with stricter permissions.

### Status Values

- **Draft**: Not published, not visible
- **Published**: Active, visible to recipients
- **Removed**: Unpublished by employee, not visible to external users
- **Expired**: Past expiration date, not visible (or status unchanged, just filtered)
- **Deleted**: Soft deleted, not visible, not restorable

### Expiration Strategies

**Option 1: Background Job**
```csharp
public class ExpireAnnouncementsJob : IJob
{
    public async Task Execute(IJobExecutionContext context)
    {
        var expiredAnnouncements = await _repository
            .GetPublishedWithExpiredDateAsync();
        
        foreach (var announcement in expiredAnnouncements)
        {
            announcement.Expire();
        }
        
        await _repository.SaveChangesAsync();
    }
}
```
Runs daily via Hangfire/Quartz.

**Option 2: Query-Time Filtering (Recommended)**
```sql
WHERE (ExpirationDate IS NULL OR ExpirationDate > GETUTCDATE())
```
Simpler, no background job needed. Announcements remain Published, just filtered out.

### Removed Announcements View

UKNF Employees can view removed announcements for audit purposes:
- See who removed it and when
- View original content (read-only)
- Optional: Restore to Published status

### Dependencies

**Prerequisites:**
- **Story 7.1**: Create Announcement (announcements exist)
- **Story 7.3**: Publish Announcement (published announcements exist)
- **Epic 2**: Authorization (permission checks)

**Integrates With:**
- **Story 7.10**: View Announcement Change History (removal logged in history)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

