# Story 7.14: Assign Contacts to Contact Groups

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.14  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee,  
**I want to** assign contacts and users to contact groups,  
**So that** I can use groups for targeted communications.

---

## Acceptance Criteria

1. Employee can select Contact Group and add members:
   - External users (from system user list)
   - Contacts (from contacts list)
2. Employee can add multiple members at once (bulk add)
3. Employee can remove members from Contact Group
4. Employee can view all members of a Contact Group
5. Members list displays: Name, Email, Type (System User / Contact), Organization
6. Employee can search members within group
7. System prevents duplicate memberships (same person added twice)
8. System logs membership changes with timestamps

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Ensure ContactGroupMember entity exists** (AC: 1, 7)
  - [ ] Verify `ContactGroupMember.cs` from Story 7.12
  - [ ] Properties:
    - Id (Guid)
    - ContactGroupId (Guid)
    - MemberType (enum) - SystemUser, Contact
    - UserId (Guid?) - if MemberType = SystemUser
    - ContactId (Guid?) - if MemberType = Contact
    - AddedBy (Guid)
    - AddedDate (DateTime)
  - [ ] Unique constraint: (ContactGroupId, MemberType, UserId/ContactId)

- [ ] **Task 2: Create AddContactGroupMembersCommand** (AC: 1, 2, 7, 8)
  - [ ] Create `AddContactGroupMembersCommand.cs` in `Application/UknfPlatform.Application.Communication/ContactGroups/Commands/`
  - [ ] Command properties:
    - ContactGroupId (Guid, required)
    - UserIds (List<Guid>, optional) - system users to add
    - ContactIds (List<Guid>, optional) - contacts to add

- [ ] **Task 3: Create AddContactGroupMembersCommandHandler** (AC: 1, 2, 7, 8)
  - [ ] Create `AddContactGroupMembersCommandHandler.cs`
  - [ ] Inject dependencies: IContactGroupMemberRepository, IContactGroupRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Load contact group
    - Check user has "contact_groups.manage_members" permission
    - For each UserId:
      - Check if already member (skip if yes)
      - Create ContactGroupMember with MemberType = SystemUser
      - Set AddedBy = current user ID
      - Set AddedDate = DateTime.UtcNow
    - For each ContactId:
      - Check if already member (skip if yes)
      - Create ContactGroupMember with MemberType = Contact
      - Set AddedBy, AddedDate
    - Save all members
    - Log membership changes
    - Return success response with added count

- [ ] **Task 4: Create RemoveContactGroupMemberCommand** (AC: 3, 8)
  - [ ] Create `RemoveContactGroupMemberCommand.cs`
  - [ ] Command properties:
    - MemberId (Guid, required) - ContactGroupMember ID
    - OR
    - ContactGroupId (Guid, required)
    - UserId OR ContactId (to identify member)

- [ ] **Task 5: Create RemoveContactGroupMemberCommandHandler** (AC: 3, 8)
  - [ ] Handler logic:
    - Load member
    - Check user has "contact_groups.manage_members" permission
    - Delete member
    - Log removal
    - Return success

- [ ] **Task 6: Create GetContactGroupMembersQuery** (AC: 4, 5, 6)
  - [ ] Create `GetContactGroupMembersQuery.cs`
  - [ ] Query properties:
    - ContactGroupId (Guid, required)
    - SearchText (string?, nullable)
    - MemberType (string?, nullable) - filter by SystemUser or Contact
    - PageNumber (int, default 1)
    - PageSize (int, default 50)

- [ ] **Task 7: Create GetContactGroupMembersQueryHandler** (AC: 4, 5, 6)
  - [ ] Handler logic:
    - Query ContactGroupMembers for ContactGroupId
    - Join with Users table (for SystemUser members)
    - Join with Contacts table (for Contact members)
    - Apply filters: SearchText (name, email), MemberType
    - Order by member name
    - Paginate results
    - Return ContactGroupMemberListDto

- [ ] **Task 8: Create ContactGroupMemberDto** (AC: 5)
  - [ ] Properties:
    - Id (Guid) - member ID
    - MemberType (string) - "System User" or "Contact"
    - Name (string) - full name
    - Email (string)
    - Organization (string?) - entity name or contact organization
    - AddedDate (DateTime)
    - AddedByName (string) - employee who added

- [ ] **Task 9: Create REST API endpoints** (AC: All)
  - [ ] Add actions to `ContactGroupsController.cs`
  - [ ] POST `/api/contact-groups/{id}/members` - AddContactGroupMembers (AC: 1, 2)
  - [ ] GET `/api/contact-groups/{id}/members` - GetContactGroupMembers (AC: 4, 5, 6)
  - [ ] DELETE `/api/contact-groups/{id}/members/{memberId}` - RemoveContactGroupMember (AC: 3)
  - [ ] All require UKNF Employee authentication and permissions

### Frontend Tasks

- [ ] **Task 10: Create contact group detail component** (AC: 4, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/contact-groups/contact-group-detail/contact-group-detail.component.ts`
  - [ ] Configure routing: `/contact-groups/:id` with auth + permission guard
  - [ ] Load group via contactGroupsService.getContactGroupDetail(id)
  - [ ] Load members via contactGroupsService.getMembers(id)
  - [ ] Display group details: Name, Description, Type, Member Count
  - [ ] Display members list/table

- [ ] **Task 11: Display members list** (AC: 4, 5, 6)
  - [ ] Display table with columns:
    - Name
    - Email
    - Type (badge: "System User" or "Contact")
    - Organization
    - Added Date
    - Actions (Remove button)
  - [ ] Implement search (by name, email)
  - [ ] Implement filter (by member type)
  - [ ] Implement pagination
  - [ ] Add "Add Members" button

- [ ] **Task 12: Create add members modal/dialog** (AC: 1, 2)
  - [ ] Create `add-members-modal.component.ts`
  - [ ] Two tabs or sections:
    - "Add System Users"
    - "Add Contacts"
  - [ ] Add System Users:
    - Multi-select dropdown with search
    - Load users via usersService.getExternalUsers()
    - Display: User Name (Email) - Entity Name
    - Allow selecting multiple users
  - [ ] Add Contacts:
    - Multi-select dropdown with search
    - Load contacts via contactsService.getContacts()
    - Display: Contact Name (Email) - Organization
    - Allow selecting multiple contacts
  - [ ] On submit, call contactGroupsService.addMembers(groupId, userIds, contactIds)
  - [ ] On success, close modal and refresh members list

- [ ] **Task 13: Implement add members** (AC: 1, 2)
  - [ ] On "Add Members" button click, open add members modal
  - [ ] User selects members (users and/or contacts)
  - [ ] On submit, add members
  - [ ] On success, show message: "Added X members to group"
  - [ ] Refresh members list

- [ ] **Task 14: Implement remove member** (AC: 3)
  - [ ] Add "Remove" button for each member in list
  - [ ] On click, show confirmation dialog: "Remove [Name] from group?"
  - [ ] On confirm, call contactGroupsService.removeMember(groupId, memberId)
  - [ ] On success, show message: "Member removed from group"
  - [ ] Refresh members list

- [ ] **Task 15: Implement duplicate prevention** (AC: 7)
  - [ ] In add members modal, filter out users/contacts who are already members
  - [ ] Show message if user tries to add existing member: "Already a member"
  - [ ] Backend also prevents duplicates (unique constraint)

- [ ] **Task 16: Implement addMembers service method** (AC: 1, 2)
  - [ ] Add method to `contactGroupsService.ts`
  - [ ] `addMembers(groupId: string, userIds: string[], contactIds: string[]): Observable<AddMembersResponse>`
  - [ ] Call POST `/api/contact-groups/{groupId}/members`
  - [ ] Handle errors

- [ ] **Task 17: Implement removeMember service method** (AC: 3)
  - [ ] Add method to `contactGroupsService.ts`
  - [ ] `removeMember(groupId: string, memberId: string): Observable<void>`
  - [ ] Call DELETE `/api/contact-groups/{groupId}/members/{memberId}`
  - [ ] Handle errors

### Testing Tasks

- [ ] **Task 18: Write unit tests for membership handlers** (AC: All)
  - [ ] Test: `AddMembers_ValidUsers_AddsMembers`
  - [ ] Test: `AddMembers_ValidContacts_AddsMembers`
  - [ ] Test: `AddMembers_BulkAdd_AddsMultipleMembers`
  - [ ] Test: `AddMembers_DuplicateMember_SkipsDuplicate`
  - [ ] Test: `RemoveMember_ValidMember_RemovesMember`
  - [ ] Test: `GetMembers_ReturnsMembers`
  - [ ] Test: `GetMembers_SearchesAndFilters`
  - [ ] Mock: IContactGroupMemberRepository, IContactGroupRepository, ILogger

- [ ] **Task 19: Write integration tests for contact group membership**
  - [ ] Test: `POST_AddMembers_ValidUsers_Returns200AndAdds`
  - [ ] Test: `POST_AddMembers_ValidContacts_Returns200AndAdds`
  - [ ] Test: `POST_AddMembers_BulkAdd_AddsAll`
  - [ ] Test: `POST_AddMembers_DuplicateMember_ReturnsSuccess` (idempotent)
  - [ ] Test: `DELETE_RemoveMember_Returns200AndRemoves`
  - [ ] Test: `GET_Members_Returns200WithMembers`
  - [ ] Use Testcontainers
  - [ ] Verify membership operations work correctly

---

## Dev Notes

### Member Types

**SystemUser:**
- User with system account
- Can log in
- Receives in-app notifications + emails

**Contact:**
- Person without system account
- Cannot log in
- Receives emails only

### Duplicate Prevention

**Unique constraint:**
```sql
UNIQUE (ContactGroupId, MemberType, UserId, ContactId)
```

**Handler logic:**
```csharp
foreach (var userId in command.UserIds)
{
    // Check if already member
    var exists = await _repository.ExistsAsync(groupId, MemberType.SystemUser, userId);
    if (exists)
        continue; // Skip, don't throw error
    
    // Add member
    var member = new ContactGroupMember
    {
        ContactGroupId = groupId,
        MemberType = MemberType.SystemUser,
        UserId = userId,
        AddedBy = currentUserId,
        AddedDate = DateTime.UtcNow
    };
    await _repository.AddAsync(member);
}
```

Idempotent: Adding existing member is OK, just skip.

### Bulk Add

Allow adding multiple members at once for efficiency:
```json
POST /api/contact-groups/{id}/members
{
  "userIds": ["guid1", "guid2", "guid3"],
  "contactIds": ["guid4", "guid5"]
}
```

Response:
```json
{
  "addedCount": 5,
  "skippedCount": 0,
  "message": "Added 5 members to group"
}
```

### Member Search

Search within group members by name or email:
```
GET /api/contact-groups/{id}/members?searchText=john&page=1&pageSize=50
```

### UI Design

**Contact Group Detail Page:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Contact Group: Quarterly Recipients ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Description: Recipients for Q reports‚îÇ
‚îÇ Type: Report Recipients             ‚îÇ
‚îÇ Created: Oct 1, 2025 by John Doe    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Members (15)       [Add Members]    ‚îÇ
‚îÇ [Search...] [Filter: All]           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ Name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ Email ‚îÄ‚îÄ‚î¨‚îÄ Type ‚îÄ‚îê‚îÇ
‚îÇ ‚îÇ John Doe    ‚îÇ j@...    ‚îÇ User ‚óè ‚îÇ‚îÇ
‚îÇ ‚îÇ Jane Smith  ‚îÇ ja@...   ‚îÇ Contact‚îÇ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dependencies

**Prerequisites:**
- **Story 7.12**: Create Contact Groups (groups must exist)
- **Story 7.13**: Add and Manage Contacts (contacts must exist)
- **Epic 2**: Authorization (users must exist)

**Blocks:**
- **Story 7.15**: Use Contact Groups (groups with members can be used for communications)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

