# Story 8.11: Answer Question (UKNF)

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.11  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As a** UKNF Employee,  
**I want to** provide answers to submitted questions,  
**So that** users can find helpful information.

---

## Acceptance Criteria

1. Employee selects question and clicks "Add Answer"
2. Employee provides answer using rich text editor (formatting, lists, links)
3. Employee can preview how Q&A will appear in published FAQ
4. Employee can save answer without publishing (status: Answered, not Published)
5. Employee can edit answer before publishing
6. Upon adding answer, question status changes from "Pending" to "Answered"
7. Answer is stored with: Answer text, Created date, Created by (employee ID)
8. Answer is not visible to external users until published

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create AddAnswerCommand** (AC: 1, 2, 4, 6, 7)
  - [ ] Create `AddAnswerCommand.cs` in `Application/UknfPlatform.Application.Communication/QA/Commands/`
  - [ ] Command properties: QuestionId (Guid), AnswerText (string)
  - [ ] Create `AddAnswerCommandHandler.cs`
  - [ ] Inject IQuestionRepository, ICurrentUserService, IHtmlSanitizer, ILogger
  - [ ] Handler logic:
    - Get question by ID
    - Verify question exists and is in Pending status
    - Sanitize HTML answer text
    - Call question.AddAnswer(answerText, employeeId)
    - Update status to Answered
    - Set AnsweredBy and AnsweredDate
    - Save to repository
    - Log answer addition
    - Return success

- [ ] **Task 2: Create UpdateAnswerCommand** (AC: 5)
  - [ ] Create `UpdateAnswerCommand.cs`
  - [ ] Command properties: QuestionId, AnswerText
  - [ ] Handler updates existing answer
  - [ ] Sanitize HTML
  - [ ] Log update

- [ ] **Task 3: Add AddAnswer domain method to Question entity** (AC: 6)
  - [ ] Method: `AddAnswer(string answerText, Guid answeredBy)`
  - [ ] Update status to Answered
  - [ ] Set AnsweredBy and AnsweredDate
  - [ ] Validate answer is not empty

- [ ] **Task 4: Create REST API endpoints** (AC: 1, 5)
  - [ ] POST /api/admin/qa/questions/{id}/answer (add answer)
  - [ ] PUT /api/admin/qa/questions/{id}/answer (edit answer)
  - [ ] Add `[Authorize]` with UKNF role check
  - [ ] Return 200 OK with updated question
  - [ ] Return 400 if validation fails
  - [ ] Return 404 if question not found
  - [ ] Add Swagger documentation

### Frontend Tasks

- [ ] **Task 5: Add "Add Answer" button** (AC: 1)
  - [ ] Add button to question detail page (Story 8.10)
  - [ ] Show only if question status is Pending or Answered (not Rejected/Published)

- [ ] **Task 6: Create answer-editor component** (AC: 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/qa-management/answer-editor/answer-editor.component.ts`
  - [ ] Can be modal or inline on question detail page
  - [ ] Integrate WYSIWYG editor (Quill, TinyMCE, or CKEditor)
  - [ ] Toolbar: bold, italic, underline, lists, links, headings
  - [ ] Reactive form with answer field

- [ ] **Task 7: Implement preview** (AC: 3)
  - [ ] Add "Preview" tab or toggle
  - [ ] Display how Q&A will look in published FAQ
  - [ ] Show question title, content, and answer with formatting
  - [ ] Use same styles as public FAQ

- [ ] **Task 8: Implement save without publish** (AC: 4)
  - [ ] "Save Answer" button
  - [ ] Saves answer, changes status to Answered
  - [ ] Does not publish to public FAQ
  - [ ] Show success message
  - [ ] Keep user on page or return to question detail

- [ ] **Task 9: Implement edit answer** (AC: 5)
  - [ ] If question has answer, show "Edit Answer" button
  - [ ] Load existing answer into editor
  - [ ] Update answer via API
  - [ ] Show success message

### Testing Tasks

- [ ] **Task 10: Write unit tests**
  - [ ] Test: AddAnswerCommandHandler adds answer and changes status
  - [ ] Test: Answer is sanitized
  - [ ] Test: AnsweredBy and AnsweredDate are set
  - [ ] Test: UpdateAnswerCommand updates existing answer

- [ ] **Task 11: Write integration tests**
  - [ ] Test: POST /api/admin/qa/questions/:id/answer adds answer
  - [ ] Test: Question status changes to Answered
  - [ ] Test: Answer is not visible to external users until published
  - [ ] Test: PUT endpoint updates answer

---

## Dev Notes

### HTML Sanitization

Use HtmlSanitizer library to prevent XSS:
- Allow: p, br, strong, em, u, ul, ol, li, a, h1-h6
- Remove: script, iframe, object, embed
- Sanitize attributes to prevent injection

### WYSIWYG Editor

Recommended: Quill (lightweight, modern)
- Install: `npm install quill ngx-quill`
- Configure with limited toolbar for security
- Extract HTML on save

### Answer Workflow

1. Employee adds answer → Status: Answered
2. Employee reviews/edits answer (optional)
3. Employee publishes (Story 8.12) → Status: Published

### User Experience

- Make editor easy to use with clear toolbar
- Provide preview to see final result
- Allow saving draft answers without publishing
- Show clear status indicators

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

