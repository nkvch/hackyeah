# Story 4.5: View Reports List (External User)

**Epic:** 4 - Reporting System  
**Story Number:** 4.5  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** Employee of a Supervised Entity,  
**I want to** view all reports submitted by my entity,  
**So that** I can monitor submission status and history.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.5

1. User can view list of all reports for their selected entity
2. List displays: Report name, Reporting period, Submission date, Submitter name, Validation status, Corrections indicator
3. List is sorted by submission date (newest first) by default
4. User can sort by: Submission date, Validation status, Reporting period
5. User can filter by: Validation status, Reporting period, Report type
6. User can search by report name or submitter name
7. User can click report to view detailed information
8. List supports pagination for large datasets
9. User can export report list (CSV or Excel)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetReportsListQuery** (AC: 1, 3, 4, 5, 6, 8)
  - [ ] Create `GetReportsListQuery.cs` in `Application/UknfPlatform.Application.Communication/Reports/Queries/`
  - [ ] Query properties:
    - EntityId (long?, optional) - if null, use user's selected entity from context
    - ValidationStatus (string?, optional) - filter by status
    - ReportingPeriod (string?, optional) - filter by period
    - ReportType (string?, optional) - filter by type
    - SearchTerm (string?, optional) - search report name or submitter name
    - SortBy (string?, optional) - column to sort by (default: "SubmittedDate")
    - SortDescending (bool, default: true) - sort direction
    - PageNumber (int, default: 1) - pagination
    - PageSize (int, default: 20) - pagination

- [ ] **Task 2: Create GetReportsListQueryHandler** (AC: 1, 3, 4, 5, 6, 7, 8)
  - [ ] Create `GetReportsListQueryHandler.cs` implementing `IRequestHandler<GetReportsListQuery, PagedResult<ReportListItemDto>>`
  - [ ] Inject dependencies: IReportRepository, ICurrentUserService, IEntityRepository, ILogger
  - [ ] Handler logic:
    - If EntityId not provided, get from user's selected entity context
    - Verify user has access to EntityId (external users = own entities only)
    - Build query:
      * Filter by EntityId
      * Filter by ValidationStatus if provided
      * Filter by ReportingPeriod if provided
      * Filter by ReportType if provided
      * Search by report name or submitter name if SearchTerm provided
      * Apply sorting (default: SubmittedDate descending)
      * Apply pagination
    - For each report, check if corrections exist (Corrections indicator - AC 2)
    - Map to ReportListItemDto
    - Return PagedResult with TotalCount, Items, PageNumber, PageSize

- [ ] **Task 3: Create ReportListItemDto** (AC: 2)
  - [ ] Create `ReportListItemDto.cs` record in `Application/UknfPlatform.Application.Communication/Reports/DTOs/`
  - [ ] Properties (from PRD AC 2):
    - ReportId (Guid)
    - ReportName (string) - File name
    - ReportingPeriod (string)
    - SubmissionDate (DateTime) - SubmittedDate
    - SubmitterName (string)
    - ValidationStatus (string)
    - ValidationStatusDisplayName (string) - user-friendly
    - HasCorrections (bool) - Corrections indicator
    - CorrectionCount (int) - number of corrections
  - [ ] Note: Fields match PRD exactly

- [ ] **Task 4: Create PagedResult generic class** (AC: 8)
  - [ ] Create `PagedResult.cs` in `Application/UknfPlatform.Application.Shared/DTOs/`
  - [ ] Generic class: `PagedResult<T>`
  - [ ] Properties:
    - Items (List<T>)
    - TotalCount (int)
    - PageNumber (int)
    - PageSize (int)
    - TotalPages (int) - calculated
    - HasPreviousPage (bool) - calculated
    - HasNextPage (bool) - calculated

- [ ] **Task 5: Implement repository query methods** (AC: 1, 4, 5, 6, 8)
  - [ ] Update IReportRepository interface
  - [ ] Add method: `GetReportsPagedAsync(entityId, filters, sorting, pagination): Task<PagedResult<Report>>`
  - [ ] Implement in ReportRepository using EF Core
  - [ ] Use IQueryable for efficient filtering and sorting
  - [ ] Example query:
    ```csharp
    var query = _context.Reports
        .Where(r => r.EntityId == entityId)
        .Include(r => r.User)
        .Include(r => r.Entity)
        .AsQueryable();
    
    // Apply filters
    if (!string.IsNullOrEmpty(validationStatus))
        query = query.Where(r => r.ValidationStatus == validationStatus);
    
    // Apply search
    if (!string.IsNullOrEmpty(searchTerm))
        query = query.Where(r => 
            r.FileName.Contains(searchTerm) || 
            r.User.FirstName.Contains(searchTerm) || 
            r.User.LastName.Contains(searchTerm));
    
    // Apply sorting
    query = sortBy switch
    {
        "SubmittedDate" => sortDescending ? query.OrderByDescending(r => r.SubmittedDate) : query.OrderBy(r => r.SubmittedDate),
        "ValidationStatus" => sortDescending ? query.OrderByDescending(r => r.ValidationStatus) : query.OrderBy(r => r.ValidationStatus),
        "ReportingPeriod" => sortDescending ? query.OrderByDescending(r => r.ReportingPeriod) : query.OrderBy(r => r.ReportingPeriod),
        _ => query.OrderByDescending(r => r.SubmittedDate) // Default
    };
    
    // Apply pagination
    var totalCount = await query.CountAsync();
    var items = await query
        .Skip((pageNumber - 1) * pageSize)
        .Take(pageSize)
        .ToListAsync();
    
    return new PagedResult<Report>(items, totalCount, pageNumber, pageSize);
    ```

- [ ] **Task 6: Create REST API endpoint GET /api/reports** (AC: 1, 3, 4, 5, 6, 8)
  - [ ] Update `ReportsController.cs`
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetReportsListAsync([FromQuery] GetReportsListQuery query)`
  - [ ] Inject IMediator
  - [ ] Send query via MediatR
  - [ ] Return 200 OK with PagedResult<ReportListItemDto>
  - [ ] Return 403 Forbidden if user lacks access to EntityId
  - [ ] Add XML documentation comments
  - [ ] Add Swagger annotations for query parameters

- [ ] **Task 7: Implement export to CSV** (AC: 9)
  - [ ] Create `ExportReportsToCSVQuery.cs`
  - [ ] Query properties: Same filters as GetReportsListQuery (no pagination)
  - [ ] Create `ExportReportsToCSVQueryHandler.cs`
  - [ ] Handler logic:
    - Fetch all reports matching filters (no pagination limit)
    - Generate CSV file using CsvHelper library
    - CSV columns: Report Name, Reporting Period, Submission Date, Submitter Name, Validation Status, Corrections
    - Return CSV as byte array
  - [ ] Create REST API endpoint: GET `/api/reports/export?format=csv`
  - [ ] Return File result with content type "text/csv"
  - [ ] Set Content-Disposition header: `attachment; filename="reports-{date}.csv"`

- [ ] **Task 8: Implement export to Excel** (AC: 9)
  - [ ] Create `ExportReportsToExcelQuery.cs`
  - [ ] Create `ExportReportsToExcelQueryHandler.cs`
  - [ ] Handler logic:
    - Fetch all reports matching filters
    - Generate Excel file using ClosedXML or EPPlus
    - Excel columns: Report Name, Reporting Period, Submission Date, Submitter Name, Validation Status, Corrections
    - Format dates, apply styling (header row bold, auto-fit columns)
    - Return Excel as byte array
  - [ ] Create REST API endpoint: GET `/api/reports/export?format=excel`
  - [ ] Return File result with content type "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  - [ ] Set Content-Disposition header: `attachment; filename="reports-{date}.xlsx"`

- [ ] **Task 9: Add authorization check** (AC: 1)
  - [ ] External users can only view reports for their entities
  - [ ] Check via ICurrentUserService and entity context
  - [ ] If user tries to access reports for entity they don't represent, return 403
  - [ ] Permission: "communication.reports.view"

### Frontend Tasks

- [ ] **Task 10: Update reports service** (AC: 1, 4, 5, 6, 8, 9)
  - [ ] Update `reports.service.ts`
  - [ ] Method: `getReportsList(filters): Observable<PagedResult<ReportListItem>>`
  - [ ] Method: `exportReports(format, filters): Observable<Blob>`
  - [ ] Build query parameters from filters object
  - [ ] Handle errors with catchError

- [ ] **Task 11: Create reports list component** (AC: 1, 2, 3, 7)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/reporting/reports-list/reports-list.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/reports` with auth guard
  - [ ] Inject ReportsService, Router, ActivatedRoute
  - [ ] Load reports on init
  - [ ] Display loading spinner while fetching
  - [ ] Handle errors (no access, network issues)

- [ ] **Task 12: Display reports table** (AC: 2, 3)
  - [ ] Use PrimeNG Table (p-table) component
  - [ ] Columns (from PRD AC 2):
    - Report Name
    - Reporting Period
    - Submission Date (formatted)
    - Submitter Name
    - Validation Status (badge with color)
    - Corrections (indicator icon if HasCorrections)
  - [ ] Default sort: Submission Date descending (newest first - AC 3)
  - [ ] Row click navigates to report details (AC 7)
  - [ ] Use responsive layout for mobile

- [ ] **Task 13: Implement sorting** (AC: 4)
  - [ ] Enable sorting on columns (from PRD AC 4):
    - Submission Date
    - Validation Status
    - Reporting Period
  - [ ] Use PrimeNG Table sortable columns
  - [ ] On column header click:
    - Toggle sort direction
    - Reload data with new sort parameters
  - [ ] Show sort indicator (arrow) on active column

- [ ] **Task 14: Implement filters** (AC: 5)
  - [ ] Create filter panel above table
  - [ ] Filter fields (from PRD AC 5):
    - Validation Status (dropdown with all statuses)
    - Reporting Period (dropdown or input)
    - Report Type (dropdown)
  - [ ] "Apply Filters" button
  - [ ] "Clear Filters" button
  - [ ] On apply, reload data with filter parameters
  - [ ] Show active filter count badge
  - [ ] Use PrimeNG Dropdown components

- [ ] **Task 15: Implement search** (AC: 6)
  - [ ] Search input field above table
  - [ ] Placeholder: "Search by report name or submitter name"
  - [ ] Debounce input (500ms delay)
  - [ ] On search term change, reload data with search parameter
  - [ ] Show clear button (X) when search active
  - [ ] Use PrimeNG InputText with icon

- [ ] **Task 16: Implement pagination** (AC: 8)
  - [ ] Use PrimeNG Paginator component
  - [ ] Show page numbers and navigation buttons
  - [ ] Display: "Showing X-Y of Z reports"
  - [ ] Page size options: 10, 20, 50, 100
  - [ ] Default page size: 20
  - [ ] On page change, reload data
  - [ ] Preserve filters/sort when paginating

- [ ] **Task 17: Display validation status badges** (AC: 2)
  - [ ] Use PrimeNG Tag or Badge component
  - [ ] Color coding:
    - Successful: Green
    - ValidationErrors: Red
    - Ongoing/Transmitted: Blue
    - TechnicalError/TimeoutError: Orange
    - ContestedByUKNF: Orange
  - [ ] Show icon with status (from Story 4.3)
  - [ ] Tooltip with full status description

- [ ] **Task 18: Display corrections indicator** (AC: 2)
  - [ ] If HasCorrections = true, show indicator
  - [ ] Icon: "i-pi pi-link" or similar
  - [ ] Tooltip: "X correction(s) submitted"
  - [ ] Make indicator clickable to show corrections list (optional)

- [ ] **Task 19: Implement export functionality** (AC: 9)
  - [ ] Add "Export" dropdown button above table
  - [ ] Options: "Export to CSV", "Export to Excel"
  - [ ] On click:
    - Show loading spinner
    - Call reportsService.exportReports(format, currentFilters)
    - Download file using FileSaver or native download
    - Show success message
  - [ ] Export uses current filters/search but ignores pagination (exports all matching)
  - [ ] Use PrimeNG SplitButton or Menu for export options

- [ ] **Task 20: Add "Submit Report" button** (AC: Related)
  - [ ] Prominent button at top of page: "Submit Report"
  - [ ] Navigates to `/reports/submit` (Story 4.1)
  - [ ] Only visible if user has "communication.reports.submit" permission
  - [ ] Use primary button style (blue)

- [ ] **Task 21: Create page layout** (AC: All)
  - [ ] Page title: "Reports"
  - [ ] Breadcrumb: Reports
  - [ ] Layout sections:
    - Header with title and "Submit Report" button
    - Filters panel (collapsible)
    - Search bar
    - Reports table
    - Paginator
    - Export button
  - [ ] Use PrimeNG Panel for filters
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 22: Implement entity selection** (AC: 1)
  - [ ] If user represents multiple entities, show entity dropdown
  - [ ] Load user's entities via entitiesService.getMyEntities()
  - [ ] Default to user's current entity context
  - [ ] On entity change, reload reports for selected entity
  - [ ] Store selection in service or state management

- [ ] **Task 23: Handle empty state** (AC: 1)
  - [ ] If no reports for entity, show empty state message
  - [ ] Message: "No reports have been submitted yet"
  - [ ] Show "Submit Report" button prominently
  - [ ] Use friendly illustration or icon

- [ ] **Task 24: Implement real-time updates** (AC: Related)
  - [ ] Subscribe to SignalR notifications (from Story 4.2)
  - [ ] When report status changes:
    - Update status in table without full reload
    - Show notification toast
    - Animate updated row
  - [ ] Unsubscribe on component destroy

### Testing Tasks

- [ ] **Task 25: Write unit tests for GetReportsListQueryHandler**
  - [ ] Test: `Handle_ValidQuery_ReturnsPaginatedReports`
  - [ ] Test: `Handle_FilterByStatus_ReturnsFilteredReports`
  - [ ] Test: `Handle_SearchByName_ReturnsMatchingReports`
  - [ ] Test: `Handle_SortByDate_ReturnsSortedReports`
  - [ ] Test: `Handle_DefaultSort_ReturnsNewestFirst` (AC 3)
  - [ ] Test: `Handle_Pagination_ReturnsCorrectPage`
  - [ ] Test: `Handle_UserAccessOtherEntity_ThrowsForbiddenException`
  - [ ] Mock: IReportRepository, ICurrentUserService

- [ ] **Task 26: Write unit tests for export handlers**
  - [ ] Test: `ExportToCSV_ValidQuery_GeneratesCSV`
  - [ ] Test: `ExportToExcel_ValidQuery_GeneratesExcel`
  - [ ] Test: `Export_IncludesAllColumns` (AC 2 fields)
  - [ ] Verify CSV format and headers
  - [ ] Verify Excel format and styling

- [ ] **Task 27: Write integration test for reports list endpoint**
  - [ ] Test: `GET_Reports_ReturnsPagedList`
  - [ ] Test: `GET_Reports_FilterByStatus_ReturnsFiltered`
  - [ ] Test: `GET_Reports_SearchByName_ReturnsMatching`
  - [ ] Test: `GET_Reports_SortByDate_ReturnsSorted`
  - [ ] Test: `GET_Reports_DefaultSortNewestFirst` (AC 3)
  - [ ] Test: `GET_Reports_Pagination_ReturnsCorrectPage`
  - [ ] Test: `GET_Reports_UserAccessOwnEntity_Returns200`
  - [ ] Test: `GET_Reports_UserAccessOtherEntity_Returns403`
  - [ ] Use Testcontainers for database
  - [ ] Create test data with multiple reports, statuses, periods

- [ ] **Task 28: Write integration test for export endpoints**
  - [ ] Test: `GET_ExportCSV_ValidRequest_ReturnsCSVFile`
  - [ ] Test: `GET_ExportExcel_ValidRequest_ReturnsExcelFile`
  - [ ] Verify Content-Type headers
  - [ ] Verify Content-Disposition headers
  - [ ] Verify file content includes all data

- [ ] **Task 29: Write E2E test for reports list flow**
  - [ ] Test workflow:
    1. Login as external user
    2. Navigate to Reports
    3. Verify reports table displays
    4. Verify columns match AC 2 (Report Name, Period, Date, Submitter, Status, Corrections)
    5. Verify default sort by newest first (AC 3)
    6. Click column header to sort (AC 4)
    7. Apply filter by status (AC 5)
    8. Search by report name (AC 6)
    9. Click report row to view details (AC 7)
    10. Navigate to page 2 (AC 8)
    11. Click "Export to CSV" (AC 9)
    12. Verify file downloads
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.1:**
- Report submission workflow
- Report entity with all fields

**From Story 4.2:**
- Validation statuses
- Status updates via SignalR

**From Story 4.3:**
- Report details page
- Status display logic

**From Story 4.4:**
- Corrections system
- HasCorrections indicator needed

**Key Integration:**
- This story provides the main reports dashboard for external users
- Links to report details (Story 4.3)
- Links to submit report (Story 4.1)
- Links to submit correction (Story 4.4)
- Story 4.6 is the UKNF employee version with additional features

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- CSV Export: CsvHelper 30.0.1
- Excel Export: ClosedXML 0.104.0 or EPPlus 7.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG (Table, Paginator, Dropdown, InputText, Tag, SplitButton)
- Real-time: @microsoft/signalr 8.0.0
- File downloads: FileSaver.js
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── ReportsController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Reports/
│   ├── Queries/
│   │   ├── GetReportsListQuery.cs (CREATE)
│   │   ├── GetReportsListQueryHandler.cs (CREATE)
│   │   ├── ExportReportsToCSVQuery.cs (CREATE)
│   │   ├── ExportReportsToCSVQueryHandler.cs (CREATE)
│   │   ├── ExportReportsToExcelQuery.cs (CREATE)
│   │   └── ExportReportsToExcelQueryHandler.cs (CREATE)
│   └── DTOs/
│       ├── ReportListItemDto.cs (CREATE)
│       └── PagedResult.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/
    └── ReportRepository.cs (UPDATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── reports.service.ts (UPDATE)
├── features/reporting/reports-list/
│   ├── reports-list.component.ts (CREATE)
│   ├── reports-list.component.html (CREATE)
│   ├── reports-list.component.scss (CREATE)
│   └── components/
│       ├── reports-table.component.ts (CREATE)
│       └── reports-filters.component.ts (CREATE)
└── shared/components/
    └── export-button.component.ts (CREATE)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`

**Report Entity:**
- All fields from Story 4.1
- IsCorrectionOfReportId for corrections indicator

**ReportListItemDto:**
Must include exactly these fields from PRD AC 2:
- Report name (FileName)
- Reporting period
- Submission date (SubmittedDate)
- Submitter name (User.FirstName + LastName)
- Validation status
- Corrections indicator (HasCorrections boolean)

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint 1:** GET `/api/reports`
- **Security:** Requires authentication
- **Query Parameters:**
  - entityId (long?, optional)
  - status (string?, optional) - ValidationStatus filter
  - reportType (string?, optional)
  - reportingPeriod (string?, optional)
  - searchTerm (string?, optional)
  - sortBy (string?, optional) - default: "SubmittedDate"
  - sortDescending (bool?, optional) - default: true
  - pageNumber (int?, optional) - default: 1
  - pageSize (int?, optional) - default: 20
- **Success Response (200 OK):**
  ```json
  {
    "items": [
      {
        "reportId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "reportName": "G. RIP100000_Q1_2025.xlsx",
        "reportingPeriod": "Q1_2025",
        "submissionDate": "2025-10-04T10:00:00Z",
        "submitterName": "Jan Kowalski",
        "validationStatus": "Successful",
        "validationStatusDisplayName": "Validation Successful",
        "hasCorrections": false,
        "correctionCount": 0
      }
    ],
    "totalCount": 150,
    "pageNumber": 1,
    "pageSize": 20,
    "totalPages": 8,
    "hasPreviousPage": false,
    "hasNextPage": true
  }
  ```

**Endpoint 2:** GET `/api/reports/export`
- **Security:** Requires authentication
- **Query Parameters:** Same filters as GET /api/reports (no pagination)
  - format (string, required) - "csv" or "excel"
- **Success Response (200 OK):**
  - Content-Type: "text/csv" or "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  - Content-Disposition: `attachment; filename="reports-2025-10-04.csv"`
  - Body: Binary file

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Efficient pagination queries**
   ```csharp
   // ✅ CORRECT - Use pagination to avoid loading all data
   var totalCount = await query.CountAsync();
   var items = await query
       .Skip((pageNumber - 1) * pageSize)
       .Take(pageSize)
       .ToListAsync();
   
   // ❌ WRONG - Don't load all and paginate in memory
   // var allItems = await query.ToListAsync();
   // var page = allItems.Skip(...).Take(...);
   ```

2. **Use projections for list DTOs**
   ```csharp
   // ✅ CORRECT - Select only needed fields
   var reports = await query
       .Select(r => new ReportListItemDto
       {
           ReportId = r.Id,
           ReportName = r.FileName,
           // ...
       })
       .ToListAsync();
   
   // ❌ WRONG - Don't load full entities
   // var reports = await query.ToListAsync();
   // return reports.Select(r => MapToDto(r));
   ```

3. **Default sorting**
   ```csharp
   // ✅ CORRECT - Default sort by newest first (AC 3)
   query = query.OrderByDescending(r => r.SubmittedDate);
   ```

4. **Search case-insensitive**
   ```csharp
   // ✅ CORRECT - Case-insensitive search
   if (!string.IsNullOrEmpty(searchTerm))
   {
       var searchLower = searchTerm.ToLower();
       query = query.Where(r => 
           r.FileName.ToLower().Contains(searchLower) || 
           (r.User.FirstName + " " + r.User.LastName).ToLower().Contains(searchLower));
   }
   ```

5. **Export with current filters**
   ```csharp
   // ✅ CORRECT - Export respects filters but ignores pagination
   var allReports = await ApplyFilters(query, filters)
       .OrderByDescending(r => r.SubmittedDate)
       .ToListAsync(); // No Skip/Take
   
   return GenerateCSV(allReports);
   ```

### PrimeNG Table Configuration

**Basic Table:**
```html
<p-table 
  [value]="reports"
  [lazy]="true"
  (onLazyLoad)="loadReports($event)"
  [paginator]="true"
  [rows]="20"
  [totalRecords]="totalCount"
  [rowsPerPageOptions]="[10, 20, 50, 100]"
  [loading]="loading"
  dataKey="reportId"
  [sortField]="'submissionDate'"
  [sortOrder]="-1"
  styleClass="p-datatable-striped">
  
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="reportName">Report Name <p-sortIcon field="reportName"></p-sortIcon></th>
      <th pSortableColumn="reportingPeriod">Reporting Period <p-sortIcon field="reportingPeriod"></p-sortIcon></th>
      <th pSortableColumn="submissionDate">Submission Date <p-sortIcon field="submissionDate"></p-sortIcon></th>
      <th>Submitter Name</th>
      <th pSortableColumn="validationStatus">Validation Status <p-sortIcon field="validationStatus"></p-sortIcon></th>
      <th>Corrections</th>
    </tr>
  </ng-template>
  
  <ng-template pTemplate="body" let-report>
    <tr (click)="viewReport(report.reportId)" class="cursor-pointer">
      <td>{{ report.reportName }}</td>
      <td>{{ report.reportingPeriod }}</td>
      <td>{{ report.submissionDate | date:'short' }}</td>
      <td>{{ report.submitterName }}</td>
      <td>
        <p-tag 
          [value]="report.validationStatusDisplayName" 
          [severity]="getStatusSeverity(report.validationStatus)">
        </p-tag>
      </td>
      <td>
        <i *ngIf="report.hasCorrections" 
           class="pi pi-link" 
           [pTooltip]="report.correctionCount + ' correction(s)'">
        </i>
      </td>
    </tr>
  </ng-template>
</p-table>
```

**Filters Panel:**
```html
<p-panel header="Filters" [toggleable]="true">
  <div class="grid grid-cols-3 gap-4">
    <div>
      <label>Validation Status</label>
      <p-dropdown 
        [options]="statusOptions" 
        [(ngModel)]="filters.status"
        placeholder="All Statuses"
        [showClear]="true">
      </p-dropdown>
    </div>
    <div>
      <label>Reporting Period</label>
      <p-dropdown 
        [options]="periodOptions" 
        [(ngModel)]="filters.period"
        placeholder="All Periods"
        [showClear]="true">
      </p-dropdown>
    </div>
    <div>
      <label>Report Type</label>
      <p-dropdown 
        [options]="typeOptions" 
        [(ngModel)]="filters.type"
        placeholder="All Types"
        [showClear]="true">
      </p-dropdown>
    </div>
  </div>
  <div class="mt-4">
    <button pButton label="Apply Filters" (click)="applyFilters()"></button>
    <button pButton label="Clear Filters" class="p-button-secondary ml-2" (click)="clearFilters()"></button>
  </div>
</p-panel>
```

### Export Implementation

**CSV Export (CsvHelper):**
```csharp
public async Task<byte[]> GenerateCSVAsync(List<ReportListItemDto> reports)
{
    using var memoryStream = new MemoryStream();
    using var writer = new StreamWriter(memoryStream, Encoding.UTF8);
    using var csv = new CsvWriter(writer, CultureInfo.InvariantCulture);
    
    // Write headers
    csv.WriteField("Report Name");
    csv.WriteField("Reporting Period");
    csv.WriteField("Submission Date");
    csv.WriteField("Submitter Name");
    csv.WriteField("Validation Status");
    csv.WriteField("Corrections");
    csv.NextRecord();
    
    // Write data
    foreach (var report in reports)
    {
        csv.WriteField(report.ReportName);
        csv.WriteField(report.ReportingPeriod);
        csv.WriteField(report.SubmissionDate.ToString("yyyy-MM-dd HH:mm"));
        csv.WriteField(report.SubmitterName);
        csv.WriteField(report.ValidationStatusDisplayName);
        csv.WriteField(report.HasCorrections ? "Yes" : "No");
        csv.NextRecord();
    }
    
    await writer.FlushAsync();
    return memoryStream.ToArray();
}
```

**Excel Export (ClosedXML):**
```csharp
public byte[] GenerateExcel(List<ReportListItemDto> reports)
{
    using var workbook = new XLWorkbook();
    var worksheet = workbook.Worksheets.Add("Reports");
    
    // Headers
    worksheet.Cell(1, 1).Value = "Report Name";
    worksheet.Cell(1, 2).Value = "Reporting Period";
    worksheet.Cell(1, 3).Value = "Submission Date";
    worksheet.Cell(1, 4).Value = "Submitter Name";
    worksheet.Cell(1, 5).Value = "Validation Status";
    worksheet.Cell(1, 6).Value = "Corrections";
    
    // Style headers
    var headerRow = worksheet.Range(1, 1, 1, 6);
    headerRow.Style.Font.Bold = true;
    headerRow.Style.Fill.BackgroundColor = XLColor.LightGray;
    
    // Data
    int row = 2;
    foreach (var report in reports)
    {
        worksheet.Cell(row, 1).Value = report.ReportName;
        worksheet.Cell(row, 2).Value = report.ReportingPeriod;
        worksheet.Cell(row, 3).Value = report.SubmissionDate;
        worksheet.Cell(row, 4).Value = report.SubmitterName;
        worksheet.Cell(row, 5).Value = report.ValidationStatusDisplayName;
        worksheet.Cell(row, 6).Value = report.HasCorrections ? "Yes" : "No";
        row++;
    }
    
    // Auto-fit columns
    worksheet.Columns().AdjustToContents();
    
    using var memoryStream = new MemoryStream();
    workbook.SaveAs(memoryStream);
    return memoryStream.ToArray();
}
```

### Security Requirements

- External users can only view reports for entities they represent
- Authorization check on every request
- Permission: "communication.reports.view"
- Entity context validated server-side (don't trust client)
- Export respects same authorization as list view

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Use pagination to avoid loading thousands of reports
- Default page size: 20 (reasonable for UX)
- Use database indexes on: EntityId, ValidationStatus, SubmittedDate, ReportingPeriod
- Use projections (Select) to fetch only needed fields
- Search should use database LIKE, not in-memory filtering
- Export limited to reasonable number of records (e.g., max 10,000)
- Cache status display info (don't recalculate on every row)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions

**Example:**
```csharp
[Fact]
public async Task Handle_DefaultSort_ReturnsNewestFirst()
{
    // Arrange - AC 3: Default sort by newest first
    var entityId = 1001L;
    var reports = new List<Report>
    {
        CreateTestReport(submittedDate: DateTime.UtcNow.AddDays(-5)),
        CreateTestReport(submittedDate: DateTime.UtcNow.AddDays(-1)), // Newest
        CreateTestReport(submittedDate: DateTime.UtcNow.AddDays(-3))
    };
    
    _reportRepositoryMock
        .Setup(r => r.GetReportsPagedAsync(entityId, null, null, null, 1, 20))
        .ReturnsAsync(new PagedResult<Report>(reports.OrderByDescending(r => r.SubmittedDate).ToList(), 3, 1, 20));
    
    var query = new GetReportsListQuery { EntityId = entityId };
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.Items.Should().HaveCount(3);
    result.Items[0].SubmissionDate.Should().BeCloseTo(DateTime.UtcNow.AddDays(-1), TimeSpan.FromSeconds(1));
    result.Items[1].SubmissionDate.Should().BeCloseTo(DateTime.UtcNow.AddDays(-3), TimeSpan.FromSeconds(1));
    result.Items[2].SubmissionDate.Should().BeCloseTo(DateTime.UtcNow.AddDays(-5), TimeSpan.FromSeconds(1));
}
```

### Additional Notes

1. **Column Display:** PRD AC 2 explicitly lists which columns to display. Don't add or remove columns without PRD change.

2. **Sortable Columns:** PRD AC 4 specifies exactly 3 sortable columns: Submission date, Validation status, Reporting period. Other columns are not sortable per requirements.

3. **Filter Fields:** PRD AC 5 specifies exactly 3 filters: Validation status, Reporting period, Report type. Additional filters not in scope.

4. **Search Scope:** PRD AC 6 specifies search by "report name or submitter name" only. Not other fields.

5. **Export Formats:** PRD AC 9 specifies CSV or Excel. Both required.

6. **Corrections Indicator:** PRD AC 2 requires "Corrections indicator" - implemented as boolean flag with count.

7. **Entity Context:** External users may represent multiple entities. System must support entity selection/filtering.

8. **Real-time Updates:** Nice-to-have feature (not in AC) but enhances UX. Status updates via SignalR from Story 4.2.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

