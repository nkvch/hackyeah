# Story 6.11: View File Change History (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.11  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** view complete change history for Library files,  
**So that** I can understand all modifications and access changes.

---

## Acceptance Criteria

1. UKNF Employee can access "Change History" for any file
2. History shows: Timestamp, Action, Changed by (employee name), Previous value, New value
3. History includes:
   - File uploads (new and version replacements)
   - Metadata changes (all fields)
   - Permission changes (who gained/lost access)
   - Category changes
   - Archiving actions
   - Deletion actions
4. History is chronologically ordered (newest first)
5. History is read-only
6. History can be exported (PDF or CSV)
7. History displays user-friendly field names and values
8. History supports pagination for files with many changes
9. History can be filtered by: Action type, Date range, Changed by user
10. External users cannot access change history (UKNF only)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetFileChangeHistoryQuery** (AC: 1, 2, 3, 4, 8, 9)
  - [ ] Create `GetFileChangeHistoryQuery.cs` in `Application/UknfPlatform.Application.Communication/Library/Queries/`
  - [ ] Query properties:
    - FileId (Guid, required)
    - ActionType (enum?, nullable) - filter by action
    - DateFrom (DateTime?, nullable)
    - DateTo (DateTime?, nullable)
    - ChangedByUserId (Guid?, nullable)
    - PageNumber (int, default 1)
    - PageSize (int, default 50)

- [ ] **Task 2: Create GetFileChangeHistoryQueryValidator** (AC: 1, 8, 9)
  - [ ] Create `GetFileChangeHistoryQueryValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate PageNumber: GreaterThan(0)
  - [ ] Validate PageSize: Between(1, 100)
  - [ ] Validate DateFrom <= DateTo if both provided
  - [ ] Add async validation: File must exist
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 3: Create GetFileChangeHistoryQueryHandler** (AC: 1, 2, 3, 4, 7, 8, 9)
  - [ ] Create `GetFileChangeHistoryQueryHandler.cs` implementing `IRequestHandler<GetFileChangeHistoryQuery, GetFileChangeHistoryResponse>`
  - [ ] Inject dependencies: IFileChangeHistoryRepository, IUserRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role (AC: 10)
    - Load file change history records for FileId
    - Apply filters: ActionType, DateRange, ChangedByUserId (AC: 9)
    - Load user details for ChangedByUserId (name)
    - Format field names and values for display (AC: 7)
    - Order by CreatedDate descending (newest first) (AC: 4)
    - Apply pagination (AC: 8)
    - Return GetFileChangeHistoryResponse

- [ ] **Task 4: Create GetFileChangeHistoryResponse DTO** (AC: 2, 4, 8)
  - [ ] Create `GetFileChangeHistoryResponse.cs` record
  - [ ] Properties:
    - Changes (List<FileChangeDto>)
    - TotalCount (int)
    - PageNumber (int)
    - PageSize (int)
    - TotalPages (int)

- [ ] **Task 5: Create FileChangeDto** (AC: 2, 3, 7)
  - [ ] Create `FileChangeDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Action (string) - user-friendly action name (AC: 7)
    - FieldName (string?) - user-friendly field name
    - OldValue (string?)
    - NewValue (string?)
    - ChangeDescription (string?)
    - ChangedByUserId (Guid)
    - ChangedByName (string) - "FirstName LastName"
    - CreatedDate (DateTime)

- [ ] **Task 6: Create REST API endpoint GET /library/files/{fileId}/history** (AC: 1, 4, 8, 9, 10)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute (AC: 10)
  - [ ] Create GET action `GetFileChangeHistoryAsync(Guid fileId, [FromQuery] GetFileChangeHistoryQuery query)`
  - [ ] Inject IMediator to send query
  - [ ] Return 200 OK with GetFileChangeHistoryResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee (AC: 10)
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 7: Implement user-friendly formatting** (AC: 7)
  - [ ] Create FormattingHelper class
  - [ ] Method: FormatActionName(ChangeAction action): string
    - Upload â†’ "File Uploaded"
    - MetadataUpdate â†’ "Metadata Updated"
    - PermissionChange â†’ "Permissions Changed"
    - Archive â†’ "Version Archived"
    - Delete â†’ "File Deleted"
    - VersionReplace â†’ "New Version Uploaded"
  - [ ] Method: FormatFieldName(string fieldName): string
    - Filename â†’ "File Name"
    - CategoryId â†’ "Category"
    - ModelUpdateDate â†’ "Model Update Date"
  - [ ] Method: FormatValue(string fieldName, string value): string
    - CategoryId â†’ Category name (not GUID)
    - Dates â†’ formatted date strings
    - Booleans â†’ "Yes" / "No"

- [ ] **Task 8: Update IFileChangeHistoryRepository** (AC: 3, 4, 8, 9)
  - [ ] Update GetByFileIdAsync method to support:
    - Filtering by ActionType, DateRange, ChangedByUserId
    - Pagination (skip, take)
    - Ordering by CreatedDate descending
    - Include count for pagination
  - [ ] Efficient query with indexes

- [ ] **Task 9: Create ExportFileChangeHistoryCommand** (AC: 6)
  - [ ] Create `ExportFileChangeHistoryCommand.cs`
  - [ ] Command properties: FileId (Guid), Format (enum: PDF, CSV)
  - [ ] Create CommandHandler
  - [ ] Handler logic:
    - Load all change history (no pagination)
    - Generate PDF or CSV file
    - Return file stream
  - [ ] Use library for PDF generation (e.g., iTextSharp, QuestPDF)
  - [ ] Use CSV library (e.g., CsvHelper)

- [ ] **Task 10: Create REST API endpoint GET /library/files/{fileId}/history/export** (AC: 6)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create GET action `ExportFileChangeHistoryAsync(Guid fileId, [FromQuery] string format = "pdf")`
  - [ ] Format: "pdf" or "csv"
  - [ ] Return FileStreamResult with appropriate Content-Type and filename
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist

### Frontend Tasks

- [ ] **Task 11: Create change history component** (AC: 1, 2, 3, 4, 7, 8, 9)
  - [ ] Create `library-file-change-history.component.ts` in `src/app/features/library/`
  - [ ] Display change history as timeline or table:
    - Timestamp
    - Action (icon + label)
    - Changed by (user name)
    - Change details (field, old value, new value)
  - [ ] Order chronologically (newest first)
  - [ ] Support pagination
  - [ ] Only accessible to UKNF Employees

- [ ] **Task 12: Add change history link** (AC: 1)
  - [ ] Add "View Change History" button on file details page (Story 6.5)
  - [ ] Button only visible to UKNF Employees
  - [ ] Open change history page or modal
  - [ ] Position near file information

- [ ] **Task 13: Create change history filters** (AC: 9)
  - [ ] Create `change-history-filters.component.ts`
  - [ ] Filters:
    - Action type dropdown (All, Upload, Metadata Update, Permissions, etc.)
    - Date range picker (From - To)
    - Changed by user dropdown (load UKNF Employees)
  - [ ] "Clear Filters" button
  - [ ] Show active filter count

- [ ] **Task 14: Implement change history display** (AC: 2, 3, 7)
  - [ ] Timeline view (preferred for visual understanding):
    - Vertical timeline with dots
    - Each change as timeline item
    - Action icon (upload, edit, permissions, delete)
    - Timestamp and user
    - Change details (expandable if long)
  - [ ] Table view (alternative):
    - Columns: Timestamp, Action, Changed By, Details
    - Sortable columns
    - Expandable rows for full details

- [ ] **Task 15: Add export functionality** (AC: 6)
  - [ ] Add "Export" button on change history page
  - [ ] Dropdown: Export as PDF or CSV
  - [ ] Trigger download of exported file
  - [ ] Show progress indicator during export
  - [ ] Handle export errors

- [ ] **Task 16: Create change detail display** (AC: 2, 3)
  - [ ] Show field name, old value, new value
  - [ ] Format: "Field Name: old value â†’ new value"
  - [ ] If no old value (create): "Field Name: set to new value"
  - [ ] If no new value (delete): "Field Name: removed"
  - [ ] Highlight changes (color coding)
  - [ ] Use diff-style display for readability

- [ ] **Task 17: Update library service** (AC: 1, 4, 6, 8, 9)
  - [ ] Add methods to `library.service.ts`:
    - getFileChangeHistory(fileId: string, query: ChangeHistoryQuery): Observable<ChangeHistoryResponse>
    - exportFileChangeHistory(fileId: string, format: string): Observable<Blob>
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 18: Add pagination** (AC: 8)
  - [ ] Pagination controls at bottom of change history
  - [ ] Show: "Showing 1-50 of 150 changes"
  - [ ] Page size selector (25, 50, 100)
  - [ ] Next/Previous/First/Last buttons

- [ ] **Task 19: Implement loading and empty states** (AC: 1, 5)
  - [ ] Show loading spinner while fetching history
  - [ ] Show empty state if no changes: "No change history available"
  - [ ] Show message if filters yield no results
  - [ ] Handle network errors

### Testing Tasks

- [ ] **Task 20: Unit tests for query handler** (AC: 1, 2, 3, 4, 7, 8, 9)
  - [ ] Test loading change history for file
  - [ ] Test change history includes all action types
  - [ ] Test change history ordered newest first
  - [ ] Test pagination
  - [ ] Test filtering by action type
  - [ ] Test filtering by date range
  - [ ] Test filtering by changed by user
  - [ ] Test user-friendly formatting
  - [ ] Test user names loaded correctly

- [ ] **Task 21: Unit tests for formatting** (AC: 7)
  - [ ] Test action name formatting
  - [ ] Test field name formatting
  - [ ] Test value formatting (dates, categories, booleans)
  - [ ] Test handling of null values

- [ ] **Task 22: Unit tests for export** (AC: 6)
  - [ ] Test PDF export generates valid PDF
  - [ ] Test CSV export generates valid CSV
  - [ ] Test export includes all changes
  - [ ] Test export formatting

- [ ] **Task 23: Integration tests for API endpoints** (AC: 1, 4, 6, 8, 9, 10)
  - [ ] Test GET /library/files/{id}/history returns change history
  - [ ] Test change history requires UKNF Employee role (403 if external user)
  - [ ] Test pagination works correctly
  - [ ] Test filtering works correctly
  - [ ] Test export endpoint returns file
  - [ ] Test export requires UKNF Employee role
  - [ ] Test 404 for non-existent file

- [ ] **Task 24: Frontend unit tests** (AC: 1, 2, 4, 8, 9)
  - [ ] Test change history component rendering
  - [ ] Test timeline/table display
  - [ ] Test filters
  - [ ] Test pagination
  - [ ] Test export button
  - [ ] Test service method calls

- [ ] **Task 25: E2E tests** (AC: 1-10)
  - [ ] Test viewing change history as UKNF Employee
  - [ ] Test external user cannot access change history (403)
  - [ ] Test change history shows all actions
  - [ ] Test filtering change history
  - [ ] Test pagination
  - [ ] Test exporting change history (PDF and CSV)
  - [ ] Test change history read-only (no edit buttons)

### Documentation Tasks

- [ ] **Task 26: API documentation** (AC: 1, 6, 9)
  - [ ] Document GET /library/files/{id}/history endpoint
  - [ ] Document GET /library/files/{id}/history/export endpoint
  - [ ] Include query parameter documentation
  - [ ] Include response examples
  - [ ] Document authentication requirements (UKNF Employee only)

- [ ] **Task 27: Developer documentation** (AC: 3, 7)
  - [ ] Document FileChangeHistory schema
  - [ ] Document action types and their meanings
  - [ ] Document formatting logic
  - [ ] Document export functionality

- [ ] **Task 28: User documentation** (AC: 1, 2, 3, 6, 9)
  - [ ] Create user guide for viewing change history
  - [ ] Explain what change history tracks
  - [ ] Document filtering and export
  - [ ] Include screenshots

---

## Technical Notes

### Change History Actions

Track these actions (from FileChangeHistory.Action enum):
- **Upload**: Initial file upload
- **MetadataUpdate**: Changes to filename, description, category, etc.
- **PermissionChange**: Changes to who can access file
- **VersionReplace**: New version uploaded
- **Archive**: Version marked as archival
- **Delete**: File deleted
- **CategoryChange**: Category changed (can be subset of MetadataUpdate)

### Change History Entry Format

Example entries:

**Upload**:
```
Action: File Uploaded
Changed By: Jan Kowalski
Date: 2025-01-10 14:30:00
Description: Initial upload
```

**Metadata Update**:
```
Action: Metadata Updated
Changed By: Jan Kowalski
Date: 2025-01-15 10:15:00
Field: File Name
Old Value: Template_Q1.xlsx
New Value: Template_Q1_2025.xlsx
```

**Permission Change**:
```
Action: Permissions Changed
Changed By: Jan Kowalski
Date: 2025-01-15 10:20:00
Description: Added access for Entity: ABC Bank
```

**Version Replace**:
```
Action: New Version Uploaded
Changed By: Jan Kowalski
Date: 2025-01-20 09:00:00
Description: Previous version archived
```

### User-Friendly Formatting

- **Action names**: Clear verbs (Uploaded, Updated, Changed, Deleted)
- **Field names**: Human-readable (File Name not Filename, Category not CategoryId)
- **Values**: Formatted for display (dates as "Jan 15, 2025", not "2025-01-15T10:20:00Z")
- **References**: Show names not IDs (Category name not GUID)

### Export Formats

**PDF**:
- Header: File name, export date
- Table with columns: Date, Action, Changed By, Details
- Formatted for printing
- Include page numbers

**CSV**:
- Columns: Date, Action, ChangedBy, FieldName, OldValue, NewValue, Description
- Machine-readable for analysis
- Import into Excel/Google Sheets

### Pagination

- Default page size: 50 changes
- Most files have < 100 changes (fits on 1-2 pages)
- For files with many changes (100+), pagination essential
- Load first page immediately, lazy load additional pages

### Filtering

Users often want to:
- See only permission changes
- See changes in specific date range
- See changes by specific employee

Filters should be AND logic (all conditions must match).

### Performance Considerations

- Index FileChangeHistory on FileId, CreatedDate, Action, ChangedByUserId
- Pagination reduces load for files with many changes
- Cache user names (employee list doesn't change often)
- Export may be slow for large history - run async or show progress

### Security Considerations

- Only UKNF Employees can view change history (AC: 10)
- External users should not see who made changes or when
- Change history is read-only (cannot edit or delete history)
- Audit the audit: Log who views change history (optional)

### UI/UX Considerations

- Timeline view is intuitive for understanding chronology
- Use icons for actions (visual recognition)
- Color coding: uploads (green), changes (blue), deletions (red)
- Expandable details for long changes
- Export for offline review or reporting
- "View History" button should be easy to find

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (change history created)
- **All previous stories**: Change history tracks actions from all stories
- **Epic 1**: Authentication (UKNF Employee role identification)

### Integrates With
- **Story 6.5**: View File Details (change history link on details page)
- **Story 6.6**: Update File Metadata (metadata changes logged)
- **Story 6.7**: Replace File (version replacement logged)
- **Story 6.8**: Delete File (deletion logged)

---

## Acceptance Checklist

- [ ] UKNF Employee can access change history for any file
- [ ] History shows timestamp, action, changed by, previous value, new value
- [ ] History includes all action types (upload, metadata, permissions, archiving, deletion)
- [ ] History is chronologically ordered (newest first)
- [ ] History is read-only
- [ ] History can be exported as PDF or CSV
- [ ] History displays user-friendly field names and values
- [ ] History supports pagination
- [ ] History can be filtered by action type, date range, changed by user
- [ ] External users cannot access change history
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (upload logged)
- **Story 6.6**: Update File Metadata (metadata changes logged)
- **Story 6.7**: Replace File (version replacement logged)
- **Story 6.8**: Delete File (deletion logged)
- **Story 6.2**: Set File Access Permissions (permission changes logged)

---

## Notes

- Change history provides accountability and audit trail
- Essential for compliance and troubleshooting
- Must be comprehensive (track all changes)
- User-friendly formatting crucial for readability
- Export enables offline review and reporting
- Only UKNF Employees need access (not external users)
- Read-only to maintain data integrity
- Timeline view more intuitive than table for chronological data
- Test with files that have extensive history (100+ changes)
- Consider retention policy for very old change history (future)
- Monitor query performance for files with many changes
- Change history is different from version history (versions vs. all changes)

