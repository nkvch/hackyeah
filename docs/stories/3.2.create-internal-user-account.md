# Story 3.2: Create Internal User Account

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.2  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** create accounts for UKNF Employees,  
**So that** internal staff can access the system.

---

## Acceptance Criteria

1. System Administrator can access "Create Internal User" form
2. Form includes fields: First name, Last name, Email, Phone number, Employee ID (optional)
3. System validates email uniqueness
4. System validates email format
5. System validates phone number format
6. Administrator can set initial password OR trigger automatic password setup email
7. Administrator can assign roles during creation
8. Upon creation, user account is set to Active status
9. User receives welcome email with login instructions
10. System logs user creation with timestamp and administrator ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create CreateInternalUserCommand** (AC: 2, 6, 7)
  - [ ] Create `CreateInternalUserCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - FirstName (string, required)
    - LastName (string, required)
    - Email (string, required)
    - Phone (string, required)
    - EmployeeId (string, optional)
    - InitialPassword (string, optional) - if provided, user logs in with this
    - SendPasswordSetupEmail (bool) - if true, send email for user to set password
    - RoleIds (List<Guid>) - roles to assign
  - [ ] Validation: Either InitialPassword OR SendPasswordSetupEmail must be true, not both

- [ ] **Task 2: Create CreateInternalUserCommandValidator** (AC: 3, 4, 5)
  - [ ] Create `CreateInternalUserCommandValidator.cs` using FluentValidation
  - [ ] Validate FirstName: NotEmpty, MaxLength(100)
  - [ ] Validate LastName: NotEmpty, MaxLength(100)
  - [ ] Validate Email: NotEmpty, EmailAddress format, MaxLength(256)
  - [ ] Validate Phone: NotEmpty, Matches regex `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate EmployeeId: MaxLength(50) if provided
  - [ ] Validate password method: Either InitialPassword (if provided, min 8 chars) OR SendPasswordSetupEmail = true
  - [ ] Validate RoleIds: NotEmpty (at least one role required)
  - [ ] Add custom async validation: Email must be unique (check IUserRepository)

- [ ] **Task 3: Create CreateInternalUserCommandHandler** (AC: 3, 6, 7, 8, 9, 10)
  - [ ] Create `CreateInternalUserCommandHandler.cs` implementing `IRequestHandler<CreateInternalUserCommand, CreateUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IPasswordHasher, IEmailService, IRoleRepository, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Check if email already exists (409 Conflict if exists)
    - Validate roles exist and are valid
    - Create User entity via domain method `User.CreateInternal()`
    - Set UserType = "Internal"
    - Set IsActive = true
    - Set EmployeeId if provided
    - If InitialPassword provided:
      - Hash password and set PasswordHash
      - Set MustChangePassword = true (force change on first login)
    - If SendPasswordSetupEmail = true:
      - Generate password setup token (24-hour expiry)
      - Set temporary placeholder password hash
      - Set MustChangePassword = true
    - Assign roles to user (UserRoles junction)
    - Save to repository with transaction
    - Send welcome email with appropriate instructions
    - Log user creation action
    - Return CreateUserResponse
  - [ ] Use transaction to ensure atomicity

- [ ] **Task 4: Update User domain entity** (AC: 2, 8)
  - [ ] Open `User.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add property: `EmployeeId` (string?, nullable)
  - [ ] Add static factory method: `CreateInternal(firstName, lastName, email, phone, employeeId?)`
  - [ ] Factory method creates User with:
    - Id = new Guid
    - UserType = UserType.Internal
    - IsActive = true
    - CreatedDate = DateTime.UtcNow
    - UpdatedDate = DateTime.UtcNow
  - [ ] Add domain method: `SetInitialPassword(passwordHash)` with validation
  - [ ] Add domain method: `AssignRole(roleId)` for role assignment

- [ ] **Task 5: Create password setup token functionality** (AC: 6)
  - [ ] Create `PasswordSetupToken` entity in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Properties: Id, UserId, Token, ExpiresAt, IsUsed, CreatedDate
  - [ ] Create repository interface and implementation
  - [ ] Token generation: secure random string (256-bit)
  - [ ] Store token hash (not plain token) for security
  - [ ] Expiry: 24 hours from creation

- [ ] **Task 6: Create CreateUserResponse DTO** (AC: 8, 9)
  - [ ] Create `CreateUserResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - UserId (Guid)
    - Email (string)
    - Message (string)
    - WelcomeEmailSent (bool)
    - PasswordSetupRequired (bool)

- [ ] **Task 7: Create REST API endpoint POST /api/admin/users/internal** (AC: 1, 2)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create POST action `CreateInternalUserAsync(CreateInternalUserCommand command)`
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 201 Created with CreateUserResponse and Location header
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 409 Conflict if email already exists
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 8: Extend IUserRepository** (AC: 3)
  - [ ] Update `IUserRepository.cs` in `Domain/UknfPlatform.Domain.Auth/Repositories/`
  - [ ] Add method: `EmailExistsAsync(email)`
  - [ ] Add method: `AddAsync(user)` if not exists
  - [ ] Update `UserRepository.cs` implementation

- [ ] **Task 9: Create welcome email template** (AC: 9)
  - [ ] Create `WelcomeInternalUserEmail.cshtml` in `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/`
  - [ ] Template content:
    - UKNF branding/logo
    - Welcome message for internal employee
    - If InitialPassword: Login URL + instructions to change password
    - If SendPasswordSetupEmail: Link to password setup page with token
    - System support contact information
  - [ ] Update IEmailService to support template rendering
  - [ ] Use MailKit to send HTML email

- [ ] **Task 10: Update IEmailService for welcome emails** (AC: 9)
  - [ ] Update `IEmailService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Add method: `SendWelcomeEmailAsync(userId, email, firstName, passwordSetupUrl?)`
  - [ ] Implement in `EmailService.cs` using welcome template
  - [ ] Include password setup link if applicable
  - [ ] Log email sending actions

- [ ] **Task 11: Create audit log entry** (AC: 10)
  - [ ] After user creation, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = administrator who created user
    - EntityType = "User"
    - EntityPrimaryKey = new user's ID
    - Action = "Create"
    - Timestamp = DateTime.UtcNow
    - AfterState = JSON snapshot of new user (exclude password hash)
  - [ ] Include assigned roles in audit log

### Frontend Tasks

- [ ] **Task 12: Create internal user service method** (AC: 1)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Add method: `createInternalUser(command): Observable<CreateUserResponse>`
  - [ ] Call POST `/api/admin/users/internal`
  - [ ] Handle errors with catchError

- [ ] **Task 13: Create internal user form component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/users/create-internal-user/create-internal-user.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/admin/users/create/internal` with auth + role guard
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - firstName (required)
    - lastName (required)
    - email (required, email validation)
    - phone (required, pattern validation)
    - employeeId (optional)
    - passwordMethod (radio: "Set Password" or "Send Setup Email")
    - initialPassword (conditionally required if passwordMethod = "Set Password")
    - confirmPassword (conditionally required, must match initialPassword)
    - roles (multi-select, at least one required)

- [ ] **Task 14: Implement form validation** (AC: 3, 4, 5, 6)
  - [ ] FirstName/LastName: Validators.required, Validators.maxLength(100)
  - [ ] Email: Validators.required, Validators.email
  - [ ] Phone: Validators.required, Validators.pattern(/^\+(?:[0-9] ?){6,14}[0-9]$/)
  - [ ] EmployeeId: Validators.maxLength(50)
  - [ ] InitialPassword: Conditional validation (min 8 chars, complexity)
  - [ ] ConfirmPassword: Match initialPassword
  - [ ] Roles: Validators.required (at least one)
  - [ ] Add async validator: Email uniqueness check (debounce 500ms)
  - [ ] Display validation error messages below each field

- [ ] **Task 15: Create roles service and selector** (AC: 7)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/roles.service.ts`
  - [ ] Method: `getRoles(): Observable<Role[]>`
  - [ ] In form component, load roles on init
  - [ ] Display roles in multi-select dropdown (PrimeNG MultiSelect)
  - [ ] Show role descriptions on hover

- [ ] **Task 16: Implement password method toggle** (AC: 6)
  - [ ] Radio buttons: "Set Password" vs "Send Setup Email"
  - [ ] If "Set Password" selected:
    - Show password and confirm password fields
    - Hide email instructions message
  - [ ] If "Send Setup Email" selected:
    - Hide password fields
    - Show info message: "User will receive an email to set their password"
  - [ ] Default: "Send Setup Email"

- [ ] **Task 17: Handle form submission** (AC: 8, 9)
  - [ ] On submit, call usersService.createInternalUser()
  - [ ] Show loading spinner during submission
  - [ ] On success (201):
    - Display success message with user email
    - Show appropriate message based on password method
    - Navigate to user list or user details page
  - [ ] On error (400): Display validation errors
  - [ ] On error (409): Display "Email already exists" message
  - [ ] Use NotificationService for toast messages

- [ ] **Task 18: Create form layout** (AC: 1, 2)
  - [ ] Page title: "Create Internal User"
  - [ ] Breadcrumb: Admin > Users > Create Internal User
  - [ ] Use card layout with form sections:
    - "Personal Information" (name, email, phone, employee ID)
    - "Password Setup" (password method selection)
    - "Roles & Permissions" (role assignment)
  - [ ] Form buttons: "Create User", "Cancel"
  - [ ] Use PrimeNG form components (InputText, Password, MultiSelect, RadioButton)
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 19: Add navigation to create user** (AC: 1)
  - [ ] In user list page (Story 3.1), add "Create User" button
  - [ ] Dropdown: "Create Internal User", "Create External User"
  - [ ] Navigate to appropriate create form

### Testing Tasks

- [ ] **Task 20: Write unit tests for CreateInternalUserCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidCommand_CreatesInternalUser`
  - [ ] Test: `Handle_ExistingEmail_ThrowsConflictException`
  - [ ] Test: `Handle_WithInitialPassword_HashesPassword`
  - [ ] Test: `Handle_WithPasswordSetupEmail_GeneratesToken`
  - [ ] Test: `Handle_AssignsRoles_Successfully`
  - [ ] Test: `Handle_SendsWelcomeEmail`
  - [ ] Test: `Handle_LogsCreationAction`
  - [ ] Mock: IUserRepository, IPasswordHasher, IEmailService, IRoleRepository, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 21: Write unit tests for CreateInternalUserCommandValidator**
  - [ ] Test: Email validation (valid, invalid, empty, uniqueness)
  - [ ] Test: Phone validation (valid international, invalid format)
  - [ ] Test: Required field validation (FirstName, LastName, Email, Phone)
  - [ ] Test: Password method validation (either password or email, not both)
  - [ ] Test: Role assignment validation (at least one role required)

- [ ] **Task 22: Write integration test for create internal user endpoint**
  - [ ] Test: `POST_CreateInternalUser_WithValidData_Returns201AndCreatesUser`
  - [ ] Test: `POST_CreateInternalUser_WithExistingEmail_Returns409`
  - [ ] Test: `POST_CreateInternalUser_WithInvalidEmail_Returns400`
  - [ ] Test: `POST_CreateInternalUser_AsNonAdmin_Returns403`
  - [ ] Test: `POST_CreateInternalUser_AssignsRoles_Successfully`
  - [ ] Test: `POST_CreateInternalUser_SendsWelcomeEmail`
  - [ ] Use Testcontainers for database
  - [ ] Verify user exists in database with correct UserType
  - [ ] Verify email is sent (mock SMTP or MailDev)

- [ ] **Task 23: Write E2E test for create internal user flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Click "Create User" > "Create Internal User"
    4. Fill form with valid data
    5. Select "Send Setup Email" option
    6. Select roles
    7. Submit form
    8. Verify success message
    9. Verify user appears in user list
    10. Verify user has "Internal" type and "Active" status
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 3.1:**
- User list view and filtering infrastructure
- System Administrator authorization policy
- Users service and UsersController established

**From Epic 1:**
- User entity with authentication fields
- Password hashing infrastructure (IPasswordHasher)
- Email service (IEmailService)
- User repository (IUserRepository)

**Key Integration:**
- This story creates new internal users (UKNF employees)
- Different from Story 1.1 (external user self-registration)
- Administrator-initiated creation vs self-registration
- Can assign roles immediately (vs access request workflow for external users)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Logging: Serilog 3.1.1
- Mapping: Mapster 7.4.0
- Email: MailKit 4.4.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG
- Styling: Tailwind CSS
- TypeScript: 5.3+ (strict mode enabled)

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── UsersController.cs (UPDATE - add CreateInternalUserAsync)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Commands/
│   │   ├── CreateInternalUserCommand.cs (CREATE)
│   │   ├── CreateInternalUserCommandHandler.cs (CREATE)
│   │   └── CreateInternalUserCommandValidator.cs (CREATE)
│   └── DTOs/
│       └── CreateUserResponse.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/
│   ├── Entities/
│   │   ├── User.cs (UPDATE - add EmployeeId, CreateInternal method)
│   │   └── PasswordSetupToken.cs (CREATE)
│   └── Repositories/
│       ├── IUserRepository.cs (UPDATE - add EmailExistsAsync)
│       └── IPasswordSetupTokenRepository.cs (CREATE)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/
│   ├── UserRepository.cs (UPDATE)
│   └── PasswordSetupTokenRepository.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Email/Templates/
    └── WelcomeInternalUserEmail.cshtml (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   ├── users.service.ts (UPDATE - add createInternalUser)
│   └── roles.service.ts (CREATE)
├── features/admin/users/create-internal-user/
│   ├── create-internal-user.component.ts (CREATE)
│   ├── create-internal-user.component.html (CREATE)
│   └── create-internal-user.component.scss (CREATE)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table Schema (Updated):**
```sql
CREATE TABLE Users (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    Phone NVARCHAR(20) NOT NULL,
    PeselEncrypted NVARCHAR(500) NULL, -- Not required for internal users
    PeselLast4 NVARCHAR(4) NULL,
    EmployeeId NVARCHAR(50) NULL, -- NEW: For internal users only
    PasswordHash NVARCHAR(500) NOT NULL,
    UserType NVARCHAR(20) NOT NULL CHECK (UserType IN ('Internal', 'External')),
    IsActive BIT NOT NULL DEFAULT 1,
    MustChangePassword BIT NOT NULL DEFAULT 0,
    LastLoginDate DATETIME2 NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    INDEX IX_Users_Email (Email),
    INDEX IX_Users_UserType (UserType),
    INDEX IX_Users_IsActive (IsActive),
    INDEX IX_Users_EmployeeId (EmployeeId)
);
```

**PasswordSetupToken Table (New):**
```sql
CREATE TABLE PasswordSetupTokens (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    TokenHash NVARCHAR(500) NOT NULL, -- Hashed token for security
    ExpiresAt DATETIME2 NOT NULL,
    IsUsed BIT NOT NULL DEFAULT 0,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    INDEX IX_PasswordSetupTokens_UserId (UserId),
    INDEX IX_PasswordSetupTokens_ExpiresAt (ExpiresAt)
);
```

**Key Differences for Internal Users:**
- PESEL: Not required (can be null)
- EmployeeId: Optional identifier for HR systems
- UserType: Always "Internal"
- IsActive: Defaults to true (no activation workflow needed)
- Roles: Assigned immediately by administrator

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** POST `/api/admin/users/internal`
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "firstName": "Anna",
    "lastName": "Nowak",
    "email": "anna.nowak@uknf.gov.pl",
    "phone": "+48987654321",
    "employeeId": "EMP-12345",
    "sendPasswordSetupEmail": true,
    "roleIds": [
      "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "4fb85f64-5717-4562-b3fc-2c963f66afa7"
    ]
  }
  ```
  OR with initial password:
  ```json
  {
    "firstName": "Anna",
    "lastName": "Nowak",
    "email": "anna.nowak@uknf.gov.pl",
    "phone": "+48987654321",
    "employeeId": "EMP-12345",
    "initialPassword": "SecureP@ssw0rd",
    "roleIds": [
      "3fa85f64-5717-4562-b3fc-2c963f66afa6"
    ]
  }
  ```
- **Success Response (201 Created):**
  ```json
  {
    "userId": "5fa85f64-5717-4562-b3fc-2c963f66afa6",
    "email": "anna.nowak@uknf.gov.pl",
    "message": "Internal user created successfully. Welcome email sent.",
    "welcomeEmailSent": true,
    "passwordSetupRequired": true
  }
  ```
  Headers:
  ```
  Location: /api/admin/users/5fa85f64-5717-4562-b3fc-2c963f66afa6
  ```
- **Error Responses:**
  - 400 Bad Request: Validation errors
  - 401 Unauthorized: Not authenticated
  - 403 Forbidden: Not System Administrator
  - 409 Conflict: Email already exists

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use domain factory method for entity creation**
   ```csharp
   // ✅ CORRECT
   var user = User.CreateInternal(firstName, lastName, email, phone, employeeId);
   // NOT: new User { ... }
   ```

2. **Hash passwords before storing**
   ```csharp
   // ✅ CORRECT
   var passwordHash = _passwordHasher.HashPassword(initialPassword);
   user.SetInitialPassword(passwordHash);
   ```

3. **Use transactions for multi-step operations**
   ```csharp
   // ✅ CORRECT - User creation + role assignment + email sending
   await _unitOfWork.SaveChangesAsync(cancellationToken);
   ```

4. **Validate email uniqueness before creation**
   ```csharp
   // ✅ CORRECT
   if (await _userRepository.EmailExistsAsync(command.Email))
       throw new ConflictException("Email already exists");
   ```

5. **Log user creation for audit**
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation(
       "Internal user created {UserId} by administrator {AdminId}",
       user.Id, currentAdminId);
   ```

6. **Return 201 Created with Location header**
   ```csharp
   // ✅ CORRECT
   return CreatedAtAction(
       nameof(GetUser),
       new { id = response.UserId },
       response);
   ```

7. **Never log passwords or sensitive data**
   ```csharp
   // ✅ CORRECT - Don't log password
   _logger.LogInformation("User {UserId} created", userId);
   // ❌ WRONG
   // _logger.LogInformation("User created with password {Password}", password);
   ```

8. **Use record types for DTOs**
   ```csharp
   // ✅ CORRECT
   public record CreateUserResponse(
       Guid UserId,
       string Email,
       string Message,
       bool WelcomeEmailSent,
       bool PasswordSetupRequired);
   ```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 3

1. **Password Storage:** Hash passwords with bcrypt or Argon2
2. **Password Setup Token:** Secure random token (256-bit), hashed before storage, 24-hour expiry
3. **Email Validation:** Check format and uniqueness
4. **Phone Validation:** International format validation
5. **Authorization:** Only System Administrators can create users
6. **Audit Trail:** Log all user creation actions

### Email Template

**Welcome Email (Password Setup):**
```html
Subject: Welcome to UKNF Communication Platform

Dear {{FirstName}} {{LastName}},

Your account has been created for the UKNF Communication Platform.

To complete your account setup, please set your password by clicking the link below:

{{PasswordSetupUrl}}

This link will expire in 24 hours.

Your Login Email: {{Email}}

For support, contact: support@uknf.gov.pl

Best regards,
UKNF IT Team
```

**Welcome Email (Initial Password):**
```html
Subject: Welcome to UKNF Communication Platform

Dear {{FirstName}} {{LastName}},

Your account has been created for the UKNF Communication Platform.

Your Login Credentials:
Email: {{Email}}

An initial password has been set for your account. You will be required to change it upon first login.

Login URL: {{LoginUrl}}

For support, contact: support@uknf.gov.pl

Best regards,
UKNF IT Team
```

### Password Setup Flow

1. Administrator creates user with "Send Setup Email" option
2. System generates secure random token (256-bit)
3. Token is hashed and stored in PasswordSetupTokens table
4. Plain token is sent in email link: `/auth/setup-password?token={token}`
5. User clicks link, frontend validates token (backend API call)
6. If valid, user enters new password
7. Backend verifies token, sets password, marks token as used
8. User can now log in with new password

### User Type Comparison

| Feature | Internal User (Story 3.2) | External User (Story 1.1) |
|---------|--------------------------|---------------------------|
| Creation | By Administrator | Self-registration |
| PESEL | Not required | Required |
| Employee ID | Optional | N/A |
| Activation | Immediate (Active) | Email activation required |
| Initial Password | Admin sets OR email setup | User sets during activation |
| Role Assignment | Immediate by admin | Via access request workflow |
| Entity Association | Not applicable | Required (via access request) |

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions  
**Integration Tests:** Testcontainers 3.7.0

**Test Location:**
- Unit tests: `Tests/UknfPlatform.UnitTests/Application/Admin/CreateInternalUserCommandHandlerTests.cs`
- Integration tests: `Tests/UknfPlatform.IntegrationTests/Controllers/UsersControllerTests.cs`

**Example:**
```csharp
[Fact]
public async Task Handle_ValidCommand_CreatesInternalUser()
{
    // Arrange
    var command = new CreateInternalUserCommand
    {
        FirstName = "Anna",
        LastName = "Nowak",
        Email = "anna.nowak@uknf.gov.pl",
        Phone = "+48987654321",
        EmployeeId = "EMP-12345",
        SendPasswordSetupEmail = true,
        RoleIds = new List<Guid> { roleId }
    };
    
    _userRepositoryMock
        .Setup(r => r.EmailExistsAsync(command.Email))
        .ReturnsAsync(false);
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    result.UserId.Should().NotBeEmpty();
    result.PasswordSetupRequired.Should().BeTrue();
    
    _userRepositoryMock.Verify(r => r.AddAsync(
        It.Is<User>(u => 
            u.Email == command.Email && 
            u.UserType == UserType.Internal &&
            u.IsActive == true)), 
        Times.Once);
    
    _emailServiceMock.Verify(e => e.SendWelcomeEmailAsync(
        It.IsAny<Guid>(), command.Email, command.FirstName, It.IsAny<string>()),
        Times.Once);
}
```

### Additional Notes

1. **EmployeeId Field:** Optional identifier that can link to HR systems. Not enforced as unique.

2. **Password Policy:** Initial password (if set by admin) must meet password policy requirements. Story 3.8 will make this configurable.

3. **Role Assignment:** Roles must exist before assignment. If role doesn't exist, return 400 Bad Request.

4. **Welcome Email:** Email must be sent asynchronously. Don't block user creation if email fails - log error and return success.

5. **Password Setup URL:** Frontend must implement `/auth/setup-password` route (not part of this story, could be Story 3.x).

6. **MustChangePassword Flag:** Set to true for both password methods:
   - Initial password: User must change on first login
   - Email setup: User must set password before first login

7. **Internal vs External:** Story 3.3 will handle external user creation (different requirements: PESEL, no roles, access request workflow).

8. **Migration:** If EmployeeId field is new, create EF Core migration to add column to Users table.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

