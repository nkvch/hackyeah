# Story 4.8: Organize Reports into Registers

**Epic:** 4 - Reporting System  
**Story Number:** 4.8  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee,  
**I want to** categorize reports into registers based on report type,  
**So that** reports are organized logically for review and analysis.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.8

1. UKNF Employee can assign reports to registers (e.g., "Quarterly Reports", "Annual Reports")
2. Register assignment can be based on metadata from report file
3. System supports both automatic categorization (based on rules) and manual assignment
4. Employee can create new registers with names and descriptions
5. Employee can move reports between registers
6. Registers can be viewed as separate filtered views
7. Each register shows report count
8. Register assignments are logged with timestamp and employee ID

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Register domain entity** (AC: 4, 7)
  - [ ] Create `Register.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - Name (string, required, max 200) - e.g., "Quarterly Reports"
    - Description (string?, optional, max 1000)
    - AutoAssignmentRule (string?, optional) - JSON or expression for auto-assignment
    - IsSystemRegister (bool, default false) - system-created vs. user-created
    - ReportCount (int, computed) - count of assigned reports
    - CreatedByUserId (Guid)
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)
  - [ ] Relationships: One-to-Many with Report (via RegisterId foreign key)

- [ ] **Task 2: Update Report entity with RegisterId** (AC: 1, 5)
  - [ ] Update Report.cs domain entity
  - [ ] Add property: RegisterId (Guid?, nullable) - assigned register
  - [ ] Add navigation property: Register
  - [ ] Add domain methods:
    - `AssignToRegister(registerId, userId)`
    - `RemoveFromRegister(userId)`
    - `CanBeReassigned(): bool`
  - [ ] Validate register assignment business rules

- [ ] **Task 3: Create database migration for Registers table** (AC: 4)
  - [ ] Create EF Core migration: `Add_Registers_Table`
  - [ ] Schema:
    ```sql
    CREATE TABLE Registers (
        Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        Name NVARCHAR(200) NOT NULL UNIQUE,
        Description NVARCHAR(1000) NULL,
        AutoAssignmentRule NVARCHAR(MAX) NULL,
        IsSystemRegister BIT NOT NULL DEFAULT 0,
        CreatedByUserId UUID NOT NULL,
        CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        
        FOREIGN KEY (CreatedByUserId) REFERENCES Users(Id),
        INDEX IX_Registers_Name (Name)
    );
    ```
  - [ ] Add RegisterId column to Reports table (nullable)
  - [ ] Add foreign key constraint to Registers table

- [ ] **Task 4: Seed default system registers** (AC: 1, 4)
  - [ ] Create migration or seed data for default registers:
    - "Quarterly Reports"
    - "Annual Reports"
    - "Monthly Reports"
    - "Current Reports" (ad-hoc)
  - [ ] Mark as IsSystemRegister = true
  - [ ] Set AutoAssignmentRule based on ReportType

- [ ] **Task 5: Create AssignReportToRegisterCommand** (AC: 1, 8)
  - [ ] Create `AssignReportToRegisterCommand.cs` in `Application/UknfPlatform.Application.Communication/Reports/Commands/`
  - [ ] Command properties:
    - ReportId (Guid, required)
    - RegisterId (Guid, required)
  - [ ] Note: Single report assignment

- [ ] **Task 6: Create AssignReportToRegisterCommandHandler** (AC: 1, 8)
  - [ ] Create `AssignReportToRegisterCommandHandler.cs`
  - [ ] Inject: IReportRepository, IRegisterRepository, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Verify user is UKNF employee
    - Fetch report by ID
    - Fetch register by ID
    - Verify register exists
    - Assign report to register via domain method: `report.AssignToRegister(registerId, userId)`
    - Save changes
    - Create audit log entry (AC 8)
    - Return success response
  - [ ] Use transaction

- [ ] **Task 7: Create BulkAssignReportsToRegisterCommand** (AC: 1, 5)
  - [ ] Create `BulkAssignReportsToRegisterCommand.cs`
  - [ ] Command properties:
    - ReportIds (List<Guid>, required)
    - RegisterId (Guid, required)
  - [ ] Handler: Same as Task 6 but for multiple reports
  - [ ] Create audit log for bulk operation

- [ ] **Task 8: Create CreateRegisterCommand** (AC: 4)
  - [ ] Create `CreateRegisterCommand.cs`
  - [ ] Command properties:
    - Name (string, required, max 200)
    - Description (string?, optional, max 1000)
    - AutoAssignmentRule (string?, optional)
  - [ ] Validator: Validate name uniqueness, length

- [ ] **Task 9: Create CreateRegisterCommandHandler** (AC: 4, 8)
  - [ ] Create `CreateRegisterCommandHandler.cs`
  - [ ] Inject: IRegisterRepository, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Verify user is UKNF employee
    - Verify name is unique
    - Create Register entity
    - Set CreatedByUserId
    - Save to repository
    - Create audit log entry
    - Return RegisterResponse with ID and name
  - [ ] Use transaction

- [ ] **Task 10: Create UpdateRegisterCommand** (AC: 4, 5)
  - [ ] Create `UpdateRegisterCommand.cs`
  - [ ] Command properties:
    - RegisterId (Guid)
    - Name (string, optional)
    - Description (string?, optional)
    - AutoAssignmentRule (string?, optional)
  - [ ] Handler: Update register properties
  - [ ] Prevent updating system registers (IsSystemRegister = true)

- [ ] **Task 11: Implement automatic categorization** (AC: 2, 3)
  - [ ] Create `IRegisterAutoAssignmentService` interface
  - [ ] Method: `EvaluateAutoAssignment(report): Guid?`
  - [ ] Create `RegisterAutoAssignmentService.cs`
  - [ ] Logic:
    - Check report metadata (ReportType, ReportingPeriod)
    - Evaluate each register's AutoAssignmentRule
    - Return matching RegisterId or null
  - [ ] Call from SubmitReportCommandHandler (Story 4.1) after report creation
  - [ ] Auto-assignment happens only if RegisterId not manually set

- [ ] **Task 12: Create auto-assignment rules engine** (AC: 2, 3)
  - [ ] Define rule syntax (simple key-value or expression)
  - [ ] Example rules:
    ```json
    {
      "ReportType": "Quarterly"
    }
    ```
  - [ ] Or more advanced:
    ```json
    {
      "ReportType": "Quarterly",
      "ReportingPeriod": "Q*_*"
    }
    ```
  - [ ] Implement rule evaluator using pattern matching
  - [ ] Store rules as JSON in AutoAssignmentRule column

- [ ] **Task 13: Create REST API endpoint POST /api/admin/registers** (AC: 4)
  - [ ] Update AdminReportsController or create RegistersController
  - [ ] Add `[Authorize]` + UKNF employee check
  - [ ] Create POST action `CreateRegisterAsync([FromBody] CreateRegisterCommand command)`
  - [ ] Return 201 Created with RegisterResponse
  - [ ] Return 400 if name already exists
  - [ ] Add Swagger annotations

- [ ] **Task 14: Create REST API endpoint PUT /api/admin/registers/{id}** (AC: 4)
  - [ ] Create PUT action `UpdateRegisterAsync(Guid id, [FromBody] UpdateRegisterCommand command)`
  - [ ] Return 200 OK
  - [ ] Return 404 if register not found
  - [ ] Return 400 if trying to update system register

- [ ] **Task 15: Create REST API endpoint POST /api/admin/reports/{id}/assign-register** (AC: 1, 5)
  - [ ] Create POST action `AssignReportToRegisterAsync(Guid id, [FromBody] AssignRegisterRequest request)`
  - [ ] Request body: `{ "registerId": "guid" }`
  - [ ] Return 200 OK
  - [ ] Return 404 if report or register not found
  - [ ] Add audit logging

- [ ] **Task 16: Create REST API endpoint POST /api/admin/reports/bulk-assign-register** (AC: 1, 5)
  - [ ] Create POST action for bulk assignment
  - [ ] Request body: `{ "reportIds": [...], "registerId": "guid" }`
  - [ ] Return 200 OK with count of assigned reports
  - [ ] Handle partial failures gracefully

- [ ] **Task 17: Create REST API endpoint GET /api/admin/registers** (AC: 6, 7)
  - [ ] Create GET action `GetRegistersListAsync()`
  - [ ] Return list of all registers
  - [ ] Include report count for each register (AC 7)
  - [ ] Response:
    ```json
    [
      {
        "id": "guid",
        "name": "Quarterly Reports",
        "description": "...",
        "reportCount": 150,
        "isSystemRegister": true
      }
    ]
    ```

- [ ] **Task 18: Update GetReportsListForUknfQuery to include register** (AC: 6)
  - [ ] Update query handler from Story 4.6
  - [ ] Include Register navigation property in query
  - [ ] Add RegisterName to UknfReportListItemDto
  - [ ] Filter by RegisterId parameter (already implemented in Story 4.6 as RegisterType)

- [ ] **Task 19: Create audit log entries** (AC: 8)
  - [ ] After register assignment, create AuditLog entry
  - [ ] AuditLog properties:
    - UserId = current UKNF employee
    - EntityType = "Report"
    - EntityPrimaryKey = report ID
    - Action = "AssignToRegister"
    - Metadata = JSON with RegisterId, RegisterName, Timestamp
  - [ ] After register creation, log with Action = "CreateRegister"
  - [ ] After bulk assignment, log with Action = "BulkAssignToRegister" and count

### Frontend Tasks

- [ ] **Task 20: Create registers service** (AC: 4, 6, 7)
  - [ ] Create `registers.service.ts` in `core/services/`
  - [ ] Methods:
    - `getRegistersList(): Observable<Register[]>`
    - `createRegister(command): Observable<RegisterResponse>`
    - `updateRegister(id, command): Observable<RegisterResponse>`
    - `assignReportToRegister(reportId, registerId): Observable<void>`
    - `bulkAssignReportsToRegister(reportIds, registerId): Observable<BulkAssignResponse>`

- [ ] **Task 21: Create register management page** (AC: 4, 7)
  - [ ] Create `register-management.component.ts` in `features/admin/`
  - [ ] Route: `/admin/registers`
  - [ ] Display list of all registers with report counts
  - [ ] Buttons: "Create New Register"
  - [ ] Each register row has: Name, Description, Report Count, Actions (Edit, View Reports)

- [ ] **Task 22: Create register form dialog** (AC: 4)
  - [ ] Create `register-form-dialog.component.ts`
  - [ ] Form fields:
    - Name (required, max 200)
    - Description (optional, max 1000)
    - Auto-assignment rule (optional, JSON editor or rule builder)
  - [ ] "Save" and "Cancel" buttons
  - [ ] Validation: Unique name
  - [ ] Use PrimeNG Dialog component

- [ ] **Task 23: Add "Assign to Register" action in reports list** (AC: 1, 5)
  - [ ] Update uknf-reports-list component from Story 4.6
  - [ ] Add "Assign to Register" bulk action
  - [ ] User selects one or multiple reports
  - [ ] Click "Assign to Register" button
  - [ ] Show register selection dialog
  - [ ] On confirm, call registerService.bulkAssignReportsToRegister()

- [ ] **Task 24: Create register selection dialog** (AC: 1, 5)
  - [ ] Create `register-selection-dialog.component.ts`
  - [ ] Display list of available registers (dropdown or list)
  - [ ] Show register name, description, current report count
  - [ ] "Assign" and "Cancel" buttons
  - [ ] Use PrimeNG Dropdown or ListBox

- [ ] **Task 25: Display register in report details** (AC: 6)
  - [ ] Update report-details component from Story 4.3
  - [ ] Show current register assignment
  - [ ] Display: "Register: [Register Name]"
  - [ ] If not assigned, show "No register assigned"
  - [ ] If UKNF employee, show "Change Register" button

- [ ] **Task 26: Add register indicator in reports table** (AC: 6)
  - [ ] Update reports table from Story 4.6
  - [ ] Add "Register" column or badge
  - [ ] Show register name as tag/badge
  - [ ] Color-code by register type (optional)

- [ ] **Task 27: Update registers navigation in Story 4.6** (AC: 6, 7)
  - [ ] Update registers navigation component from Story 4.6
  - [ ] Load registers dynamically from API (not hardcoded)
  - [ ] Show report count for each register (AC 7)
  - [ ] Example: "Quarterly Reports (150)"
  - [ ] On register selection, filter reports by RegisterId

- [ ] **Task 28: Add success notifications** (AC: 1, 4, 5)
  - [ ] After register creation: "Register created successfully"
  - [ ] After report assignment: "Report assigned to [Register Name]"
  - [ ] After bulk assignment: "X reports assigned to [Register Name]"
  - [ ] Use NotificationService for toast messages

### Testing Tasks

- [ ] **Task 29: Write unit tests for AssignReportToRegisterCommandHandler**
  - [ ] Test: `Handle_ValidAssignment_AssignsReport`
  - [ ] Test: `Handle_ReportNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_RegisterNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_ExternalUserAttempt_ThrowsForbiddenException`
  - [ ] Test: `Handle_CreatesAuditLog` (AC 8)
  - [ ] Mock: IReportRepository, IRegisterRepository, ICurrentUserService

- [ ] **Task 30: Write unit tests for CreateRegisterCommandHandler**
  - [ ] Test: `Handle_ValidName_CreatesRegister` (AC 4)
  - [ ] Test: `Handle_DuplicateName_ThrowsValidationException`
  - [ ] Test: `Handle_CreatesAuditLog` (AC 8)

- [ ] **Task 31: Write unit tests for auto-assignment service**
  - [ ] Test: `EvaluateAutoAssignment_QuarterlyReport_AssignsToQuarterlyRegister` (AC 2, 3)
  - [ ] Test: `EvaluateAutoAssignment_NoMatchingRule_ReturnsNull`
  - [ ] Test: `EvaluateAutoAssignment_MultipleRules_ReturnsFirstMatch`

- [ ] **Task 32: Write integration test for register creation**
  - [ ] Test: `POST_CreateRegister_ValidRequest_Returns201` (AC 4)
  - [ ] Test: `POST_CreateRegister_DuplicateName_Returns400`
  - [ ] Test: `POST_CreateRegister_ExternalUser_Returns403`
  - [ ] Verify register created in database
  - [ ] Verify audit log created (AC 8)

- [ ] **Task 33: Write integration test for report assignment**
  - [ ] Test: `POST_AssignReportToRegister_ValidRequest_Returns200` (AC 1)
  - [ ] Test: `POST_BulkAssignReports_MultipleReports_Returns200` (AC 1, 5)
  - [ ] Verify RegisterId updated in Reports table
  - [ ] Verify audit log created (AC 8)

- [ ] **Task 34: Write integration test for auto-assignment**
  - [ ] Test: `SubmitReport_QuarterlyType_AutoAssignsToQuarterlyRegister` (AC 2, 3)
  - [ ] Test: `SubmitReport_NoMatchingRule_NoAutoAssignment`
  - [ ] Test: `SubmitReport_ManualAssignment_OverridesAutoAssignment`

- [ ] **Task 35: Write E2E test for register management flow**
  - [ ] Test workflow:
    1. Login as UKNF employee
    2. Navigate to Admin > Registers
    3. Click "Create New Register" (AC 4)
    4. Enter name and description
    5. Save register
    6. Verify register appears in list with 0 reports (AC 7)
    7. Navigate to Reports
    8. Select register tab (AC 6)
    9. Select a report
    10. Click "Assign to Register" (AC 1)
    11. Select register from dialog (AC 5)
    12. Assign report
    13. Verify register count updates (AC 7)
    14. Verify report shows in register's filtered view (AC 6)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.6:**
- UKNF reports list with register filtering
- Registers were treated as UI convenience (mapped to ReportType)
- This story formalizes registers as actual entities

**Key Integration:**
- Story 4.6 provides the UI foundation (registers navigation)
- This story adds the backend management and assignment functionality
- Story 4.1 integration for auto-assignment on submission

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Dialog, Dropdown, ListBox)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── RegistersController.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Reports/Commands/
│   ├── AssignReportToRegisterCommand.cs (CREATE)
│   ├── AssignReportToRegisterCommandHandler.cs (CREATE)
│   ├── BulkAssignReportsToRegisterCommand.cs (CREATE)
│   └── BulkAssignReportsToRegisterCommandHandler.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Registers/Commands/
│   ├── CreateRegisterCommand.cs (CREATE)
│   ├── CreateRegisterCommandHandler.cs (CREATE)
│   ├── UpdateRegisterCommand.cs (CREATE)
│   └── UpdateRegisterCommandHandler.cs (CREATE)
├── Application/UknfPlatform.Application.Communication/Registers/Queries/
│   ├── GetRegistersListQuery.cs (CREATE)
│   └── GetRegistersListQueryHandler.cs (CREATE)
├── Application/UknfPlatform.Application.Shared/Interfaces/
│   └── IRegisterAutoAssignmentService.cs (CREATE)
├── Domain/UknfPlatform.Domain.Communication/Entities/
│   ├── Register.cs (CREATE)
│   └── Report.cs (UPDATE - add RegisterId)
├── Infrastructure/UknfPlatform.Infrastructure.Communication/Services/
│   └── RegisterAutoAssignmentService.cs (CREATE)
└── Infrastructure/UknfPlatform.Infrastructure.Persistence/
    ├── Repositories/
    │   ├── IRegisterRepository.cs (CREATE)
    │   └── RegisterRepository.cs (CREATE)
    └── Migrations/
        ├── Add_Registers_Table.cs (CREATE)
        └── Seed_Default_Registers.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── registers.service.ts (CREATE)
├── features/admin/register-management/
│   ├── register-management.component.ts (CREATE)
│   ├── register-management.component.html (CREATE)
│   └── components/
│       ├── register-form-dialog.component.ts (CREATE)
│       └── register-selection-dialog.component.ts (CREATE)
└── features/admin/uknf-reports-list/
    └── uknf-reports-list.component.ts (UPDATE - add assignment action)
```

### Data Models

**Register Entity:**
- Represents a logical grouping/category for reports
- Can be system-created (default) or user-created
- Has auto-assignment rules for automatic categorization
- Tracks report count

**Report Entity Update:**
- Add RegisterId (Guid?, nullable)
- Add Register navigation property
- Reports can belong to zero or one register

**Relationships:**
- Register (1) → Reports (Many)
- Report (Many) → Register (1, optional)

### Register Auto-Assignment Rules

**Simple Rule Format (JSON):**
```json
{
  "ReportType": "Quarterly"
}
```

**Advanced Rule Format:**
```json
{
  "ReportType": "Quarterly",
  "ReportingPeriodPattern": "Q[1-4]_20[0-9]{2}"
}
```

**Rule Evaluation:**
1. On report submission, check if RegisterId manually set
2. If not set, evaluate all registers' AutoAssignmentRules
3. First matching rule wins
4. Assign report to matching register
5. If no match, leave RegisterId = null (unassigned)

**Default System Registers:**
- **Quarterly Reports:** `{ "ReportType": "Quarterly" }`
- **Annual Reports:** `{ "ReportType": "Annual" }`
- **Monthly Reports:** `{ "ReportType": "Monthly" }`
- **Current Reports:** `{ "ReportType": "Current" }` or `{ "ReportType": "Ad-hoc" }`

### REST API Specification

**Endpoint 1:** POST `/api/admin/registers`
- **Security:** UKNF employees only
- **Request:**
  ```json
  {
    "name": "Quarterly Reports",
    "description": "Reports submitted quarterly",
    "autoAssignmentRule": "{\"ReportType\":\"Quarterly\"}"
  }
  ```
- **Response (201 Created):**
  ```json
  {
    "id": "guid",
    "name": "Quarterly Reports",
    "description": "Reports submitted quarterly",
    "reportCount": 0
  }
  ```

**Endpoint 2:** GET `/api/admin/registers`
- **Security:** UKNF employees only
- **Response (200 OK):**
  ```json
  [
    {
      "id": "guid",
      "name": "Quarterly Reports",
      "description": "...",
      "reportCount": 150,
      "isSystemRegister": true
    }
  ]
  ```

**Endpoint 3:** POST `/api/admin/reports/{id}/assign-register`
- **Security:** UKNF employees only
- **Request:**
  ```json
  {
    "registerId": "guid"
  }
  ```
- **Response (200 OK):**
  ```json
  {
    "message": "Report assigned to register successfully"
  }
  ```

**Endpoint 4:** POST `/api/admin/reports/bulk-assign-register`
- **Security:** UKNF employees only
- **Request:**
  ```json
  {
    "reportIds": ["guid1", "guid2", "guid3"],
    "registerId": "guid"
  }
  ```
- **Response (200 OK):**
  ```json
  {
    "assignedCount": 3,
    "message": "3 reports assigned successfully"
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use domain methods for assignment**
   ```csharp
   // ✅ CORRECT
   report.AssignToRegister(registerId, userId);
   
   // ❌ WRONG
   // report.RegisterId = registerId;
   ```

2. **Auto-assignment on creation**
   ```csharp
   // ✅ CORRECT - Auto-assign after report creation
   var report = Report.Create(...);
   await _reportRepository.AddAsync(report);
   
   if (report.RegisterId == null) // Only if not manually assigned
   {
       var registerId = await _registerAutoAssignmentService.EvaluateAutoAssignment(report);
       if (registerId.HasValue)
           report.AssignToRegister(registerId.Value, systemUserId);
   }
   
   await _unitOfWork.SaveChangesAsync();
   ```

3. **Prevent system register modification**
   ```csharp
   // ✅ CORRECT
   if (register.IsSystemRegister)
       throw new ValidationException("Cannot modify system registers");
   ```

4. **Audit all assignments (AC 8)**
   ```csharp
   // ✅ CORRECT
   await _auditService.LogAsync(new AuditLog
   {
       Action = "AssignToRegister",
       EntityType = "Report",
       EntityPrimaryKey = reportId,
       UserId = currentUserId,
       Timestamp = DateTime.UtcNow,
       Metadata = new { RegisterId = registerId, RegisterName = register.Name }
   });
   ```

5. **Count reports per register**
   ```csharp
   // ✅ CORRECT - Compute count in query
   var registers = await _context.Registers
       .Select(r => new RegisterDto
       {
           Id = r.Id,
           Name = r.Name,
           ReportCount = _context.Reports.Count(rep => rep.RegisterId == r.Id) // AC 7
       })
       .ToListAsync();
   ```

### Security Requirements

- Only UKNF employees can create/manage registers
- Only UKNF employees can assign reports to registers
- External users cannot access register management
- All register operations logged for audit (AC 8)

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Report count for registers computed efficiently (aggregate query)
- Auto-assignment rules evaluated on report submission (minimal overhead)
- Bulk assignment uses single transaction
- Register list cached (changes infrequently)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Register creation and uniqueness
- Report assignment (single and bulk)
- Auto-assignment rule evaluation
- System register protection
- Audit logging (AC 8)
- Register count accuracy (AC 7)

**Example:**
```csharp
[Fact]
public async Task Handle_AutoAssignment_QuarterlyReportAssignedToQuarterlyRegister()
{
    // Arrange - AC 2, 3: Automatic categorization
    var quarterlyRegister = CreateTestRegister(
        "Quarterly Reports", 
        autoRule: "{\"ReportType\":\"Quarterly\"}");
    await _context.Registers.AddAsync(quarterlyRegister);
    await _context.SaveChangesAsync();
    
    var report = CreateTestReport(reportType: "Quarterly");
    report.RegisterId = null; // Not manually assigned
    
    // Act
    var assignedRegisterId = await _autoAssignmentService.EvaluateAutoAssignment(report);
    
    // Assert
    assignedRegisterId.Should().Be(quarterlyRegister.Id);
}
```

### Additional Notes

1. **System vs. User Registers:** System registers are seeded and protected from deletion/modification. Users can create custom registers for specific needs.

2. **Register Assignment Priority:** Manual assignment always takes precedence over auto-assignment. If user manually assigns report to register during submission (future feature), auto-assignment is skipped.

3. **Unassigned Reports:** Reports can exist without register assignment (RegisterId = null). This is valid - not all reports need to be categorized.

4. **Register Deletion:** Consider soft delete or prevent deletion if register has reports. Alternatively, move reports to "Unassigned" register before deletion.

5. **Report Count Performance:** Use computed column or cache for report counts to avoid expensive COUNT queries on large datasets.

6. **Auto-Assignment Rule Engine:** Keep simple for MVP. Can be enhanced later with more complex rule expressions (e.g., date ranges, entity types).

7. **UI Integration:** Story 4.6 already has registers navigation - this story adds the management backend. Frontend updates needed in Story 4.6 to load registers dynamically and support assignment actions.

8. **Bulk Operations:** Bulk assignment important for admin efficiency - can assign dozens of reports to a register in one action.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

