# Story 8.1: View Entity File (UKNF)

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.1  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** UKNF Employee or System Administrator,  
**I want to** view complete entity information,  
**So that** I can access accurate details about supervised entities.

---

## Acceptance Criteria

1. UKNF Employee/System Administrator can access "Entity File" or "Entity Directory"
2. Employee can view list of all entities with: Entity name, UKNF code, Entity type, Status, NIP
3. Employee can search entities by: Name, UKNF code, NIP, KRS
4. Employee can filter entities by: Entity type, Status, Sector
5. Employee can click entity to view complete details
6. Detail view displays all entity fields per schema (Story 8.2)
7. Employee can view entity change history
8. Employee can view list of users assigned to entity
9. List supports pagination for large entity counts

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetEntitiesQuery (CQRS)** (AC: 2, 3, 4, 9)
  - [ ] Create `GetEntitiesQuery.cs` in `Application/UknfPlatform.Application.Communication/Entities/Queries/`
  - [ ] Query parameters:
    - SearchTerm (string?, optional) - searches Name, UKNF code, NIP, KRS
    - EntityType (string?, optional) - filter by type
    - Status (string?, optional) - filter by status
    - Sector (string?, optional) - filter by sector
    - PageNumber (int, default 1)
    - PageSize (int, default 50)
  - [ ] Create `GetEntitiesQueryHandler.cs`
  - [ ] Inject IEntityRepository
  - [ ] Implement filtering and search logic
  - [ ] Implement pagination
  - [ ] Return PagedResult<EntityListItemDto>

- [ ] **Task 2: Create GetEntityByIdQuery** (AC: 5, 6, 7, 8)
  - [ ] Create `GetEntityByIdQuery.cs`
  - [ ] Query parameters: EntityId (long)
  - [ ] Create `GetEntityByIdQueryHandler.cs`
  - [ ] Return EntityDetailDto with all fields
  - [ ] Include change history
  - [ ] Include assigned users list

- [ ] **Task 3: Create EntityListItemDto** (AC: 2)
  - [ ] Create `EntityListItemDto.cs` in `Application/UknfPlatform.Application.Communication/Entities/DTOs/`
  - [ ] Properties: Id, Name, UknfCode, EntityType, Status, Nip

- [ ] **Task 4: Create EntityDetailDto** (AC: 6)
  - [ ] Create `EntityDetailDto.cs`
  - [ ] Properties: All entity fields from schema (Story 8.2)
  - [ ] Include ChangeHistory (list)
  - [ ] Include AssignedUsers (list)

- [ ] **Task 5: Create REST API endpoint GET /api/entities** (AC: 1, 2, 3, 4, 9)
  - [ ] Create `EntitiesController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize]` attribute with UKNF Employee role check
  - [ ] Create GET action `GetEntitiesAsync([FromQuery] GetEntitiesQuery query)`
  - [ ] Return 200 OK with paged results
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Add Swagger documentation

- [ ] **Task 6: Create REST API endpoint GET /api/entities/{id}** (AC: 5, 6, 7, 8)
  - [ ] Create GET action `GetEntityByIdAsync(long id)`
  - [ ] Return 200 OK with EntityDetailDto
  - [ ] Return 404 Not Found if entity doesn't exist
  - [ ] Add Swagger documentation

### Frontend Tasks

- [ ] **Task 7: Create entities service** (AC: 1)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/entities.service.ts`
  - [ ] Method: `getEntities(query): Observable<PagedResult<EntityListItem>>`
  - [ ] Method: `getEntityById(id): Observable<EntityDetail>`

- [ ] **Task 8: Create entity list component** (AC: 1, 2, 3, 4, 9)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/entities/entity-list/entity-list.component.ts`
  - [ ] Configure routing: `/entities` with auth + UKNF role guard
  - [ ] Display entities in table with columns: Name, UKNF Code, Type, Status, NIP
  - [ ] Implement search input (debounced)
  - [ ] Implement filters: Entity Type, Status, Sector
  - [ ] Implement pagination
  - [ ] Click row to navigate to entity detail

- [ ] **Task 9: Create entity detail component** (AC: 5, 6, 7, 8)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/entities/entity-detail/entity-detail.component.ts`
  - [ ] Configure routing: `/entities/:id`
  - [ ] Display all entity fields
  - [ ] Tab navigation: Details, Change History, Users
  - [ ] Use Tailwind CSS for layout

- [ ] **Task 10: Create entity change history component** (AC: 7)
  - [ ] Display change history table
  - [ ] Columns: Timestamp, Changed By, Field, Previous Value, New Value
  - [ ] Sortable and filterable

- [ ] **Task 11: Create entity users component** (AC: 8)
  - [ ] Display assigned users table
  - [ ] Columns: Name, Email, Role, Permissions, Status
  - [ ] Filterable by role and status

### Testing Tasks

- [ ] **Task 12: Write unit tests for GetEntitiesQueryHandler**
  - [ ] Test: Returns paginated entity list
  - [ ] Test: Search filters correctly
  - [ ] Test: Filters by entity type, status, sector

- [ ] **Task 13: Write integration tests for entities endpoints**
  - [ ] Test: GET /api/entities returns paginated results
  - [ ] Test: GET /api/entities/:id returns entity details
  - [ ] Test: Search and filters work correctly
  - [ ] Test: 403 for non-UKNF users

---

## Dev Notes

### Data Model

**Entity Fields (from Story 8.2):**
- ID (bigint)
- Type of entity (nvarchar(250))
- UKNF code (nvarchar(250))
- Name of the entity (nvarchar(500))
- LEI (nvarchar(20))
- NIP (nvarchar(10))
- KRS (nvarchar(10))
- Address fields
- Contact fields
- Status and category fields
- Dates (Created, Updated)

### Security

- Only UKNF Employees and System Administrators can view entity directory
- External users can only view their own entity (Story 8.3)

### Performance

- Implement pagination (default 50 items per page)
- Index on searchable fields: Name, UKNF code, NIP, KRS
- Use efficient filtering queries

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

