# Story 5.2: Receive and View Messages

**Epic:** 5 - Messaging & Cases  
**Story Number:** 5.2  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee or External User,  
**I want to** view messages sent to me,  
**So that** I can read communications and respond.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-5-messaging-cases.md` - Story 5.2

1. User can view list of messages addressed to them
2. Message list displays: Sender, Subject/Preview, Date, Status, Context (if part of case/request/report)
3. User can filter messages by: Status, Sender, Date range, Context
4. User can sort messages by: Date, Sender, Status
5. User can mark messages as read/unread
6. User can search messages by content or sender
7. User can click message to view full details
8. Message detail shows: Full content, Sender details, Timestamp, All attachments with download links, Message thread (if part of conversation)
9. User can download attachments individually
10. Message list supports pagination

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetMessagesQuery** (AC: 1, 2, 3, 4, 6, 10)
  - [ ] Create `GetMessagesQuery.cs` in `Application/UknfPlatform.Application.Communication/Messages/Queries/`
  - [ ] Query properties (from AC 3, 4, 6, 10):
    - RecipientUserId (Guid) - current user (set by handler)
    - StatusFilter (MessageStatus?, optional) - AC 3
    - SenderFilter (Guid?, optional) - filter by sender user ID - AC 3
    - DateFrom (DateTime?, optional) - AC 3
    - DateTo (DateTime?, optional) - AC 3
    - ContextTypeFilter (ContextType?, optional) - AC 3
    - SearchTerm (string?, optional) - search in subject, body, sender name - AC 6
    - SortBy (string, default: "SentDate") - Date, Sender, Status - AC 4
    - SortDirection (string, default: "DESC") - ASC or DESC
    - PageNumber (int, default: 1) - AC 10
    - PageSize (int, default: 20) - AC 10

- [ ] **Task 2: Create GetMessagesQueryHandler** (AC: 1, 2, 3, 4, 6, 10)
  - [ ] Create `GetMessagesQueryHandler.cs` implementing `IRequestHandler<GetMessagesQuery, GetMessagesResponse>`
  - [ ] Inject: IMessageRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    1. Get current user ID
    2. Query messages where user is recipient (join MessageRecipients)
    3. Apply filters (AC 3):
       - Status filter
       - Sender filter
       - Date range filter
       - Context type filter
    4. Apply search (AC 6):
       - Search in message subject, body, sender first name, sender last name
       - Case-insensitive
    5. Apply sorting (AC 4):
       - By Date (SentDate), Sender (sender name), Status (MessageStatus)
    6. Apply pagination (AC 10)
    7. Map to DTOs (AC 2)
    8. Return GetMessagesResponse with messages and pagination metadata

- [ ] **Task 3: Create GetMessagesResponse DTO** (AC: 2, 10)
  - [ ] Create `GetMessagesResponse.cs` record
  - [ ] Properties:
    - Messages (List<MessageSummaryDto>) - AC 2
    - TotalCount (int) - total messages matching filters
    - PageNumber (int)
    - PageSize (int)
    - TotalPages (int)

- [ ] **Task 4: Create MessageSummaryDto** (AC: 2)
  - [ ] Create `MessageSummaryDto.cs` record
  - [ ] Properties (from AC 2):
    - MessageId (Guid)
    - Subject (string)
    - BodyPreview (string) - first 200 characters of body
    - SenderName (string) - sender's full name
    - SenderEmail (string)
    - SentDate (DateTime)
    - MessageStatus (string) - display name
    - ContextType (string?) - "Access Request", "Report", "Case", null if standalone
    - ContextId (Guid?)
    - ContextDisplayName (string?) - e.g., "Case #12345" or "Report Q1_2025"
    - IsRead (bool) - from MessageRecipient.IsRead
    - HasAttachments (bool)
    - AttachmentCount (int)

- [ ] **Task 5: Create GetMessageDetailsQuery** (AC: 7, 8)
  - [ ] Create `GetMessageDetailsQuery.cs`
  - [ ] Query properties:
    - MessageId (Guid, required)

- [ ] **Task 6: Create GetMessageDetailsQueryHandler** (AC: 7, 8)
  - [ ] Create `GetMessageDetailsQueryHandler.cs` implementing `IRequestHandler<GetMessageDetailsQuery, MessageDetailsResponse>`
  - [ ] Inject: IMessageRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    1. Get current user ID
    2. Fetch message by ID with all related data:
       - Sender details
       - Attachments (AC 8)
       - Parent/child messages for threading (AC 8)
    3. Verify current user is a recipient (authorization)
    4. Mark message as read when viewed (update MessageRecipient.IsRead, ReadDate)
    5. Map to MessageDetailsResponse
    6. Return 404 if not found
    7. Return 403 if user not a recipient

- [ ] **Task 7: Create MessageDetailsResponse DTO** (AC: 8)
  - [ ] Create `MessageDetailsResponse.cs` record
  - [ ] Properties (from AC 8):
    - MessageId (Guid)
    - Subject (string)
    - Body (string) - full content
    - SenderName (string)
    - SenderEmail (string)
    - SenderPhone (string?)
    - SenderUserType (string) - "UKNF Employee" or "External User"
    - SentDate (DateTime) - AC 8: Timestamp
    - MessageStatus (string)
    - ContextType (string?)
    - ContextId (Guid?)
    - ContextDisplayName (string?)
    - IsRead (bool)
    - ReadDate (DateTime?)
    - Attachments (List<MessageAttachmentDto>) - AC 8
    - MessageThread (List<MessageThreadItemDto>?) - AC 8: if part of conversation
    - HasReplies (bool)
    - CanReply (bool) - based on status and user permissions

- [ ] **Task 8: Create MessageAttachmentDto** (AC: 8, 9)
  - [ ] Create `MessageAttachmentDto.cs` record
  - [ ] Properties:
    - AttachmentId (Guid)
    - FileName (string)
    - FileSize (long) - in bytes
    - FileSizeFormatted (string) - e.g., "2.5 MB"
    - ContentType (string)
    - UploadedDate (DateTime)
    - DownloadUrl (string) - URL to download endpoint - AC 9

- [ ] **Task 9: Create MessageThreadItemDto** (AC: 8)
  - [ ] Create `MessageThreadItemDto.cs` record
  - [ ] Properties (for threading display):
    - MessageId (Guid)
    - Subject (string)
    - BodyPreview (string)
    - SenderName (string)
    - SentDate (DateTime)
    - IsCurrentMessage (bool) - highlight current message in thread

- [ ] **Task 10: Create MarkMessageAsReadCommand** (AC: 5)
  - [ ] Create `MarkMessageAsReadCommand.cs`
  - [ ] Command properties:
    - MessageId (Guid)
    - IsRead (bool) - true for read, false for unread

- [ ] **Task 11: Create MarkMessageAsReadCommandHandler** (AC: 5)
  - [ ] Create `MarkMessageAsReadCommandHandler.cs`
  - [ ] Inject: IMessageRepository, ICurrentUserService, IUnitOfWork
  - [ ] Handler logic:
    1. Get current user ID
    2. Find MessageRecipient record for this message and user
    3. Update IsRead flag
    4. If marking as read: Set ReadDate to now
    5. If marking as unread: Clear ReadDate
    6. Save changes
    7. Return success

- [ ] **Task 12: Create DownloadMessageAttachmentQuery** (AC: 9)
  - [ ] Create `DownloadMessageAttachmentQuery.cs`
  - [ ] Query properties:
    - AttachmentId (Guid)

- [ ] **Task 13: Create DownloadMessageAttachmentQueryHandler** (AC: 9)
  - [ ] Create `DownloadMessageAttachmentQueryHandler.cs`
  - [ ] Inject: IMessageRepository, IFileStorageService, ICurrentUserService, ILogger
  - [ ] Handler logic:
    1. Get attachment by ID
    2. Get message for attachment
    3. Verify current user is recipient of message (authorization)
    4. Fetch file from storage using FileStorageKey
    5. Return file stream with FileName and ContentType
    6. Return 404 if attachment not found
    7. Return 403 if user not authorized

- [ ] **Task 14: Create REST API endpoint GET /api/messages** (AC: 1, 2, 3, 4, 6, 10)
  - [ ] Update `MessagesController.cs`
  - [ ] Add `[Authorize]` attribute
  - [ ] Create GET action `GetMessagesAsync([FromQuery] GetMessagesQuery query)`
  - [ ] Return 200 OK with GetMessagesResponse
  - [ ] Support query parameters for filtering, sorting, pagination
  - [ ] Add Swagger annotations for query parameters

- [ ] **Task 15: Create REST API endpoint GET /api/messages/{id}** (AC: 7, 8)
  - [ ] Create GET action `GetMessageDetailsAsync(Guid id)`
  - [ ] Send GetMessageDetailsQuery via MediatR
  - [ ] Return 200 OK with MessageDetailsResponse
  - [ ] Return 404 if message not found
  - [ ] Return 403 if user not a recipient
  - [ ] Automatically mark message as read when viewed
  - [ ] Add XML documentation comments

- [ ] **Task 16: Create REST API endpoint PUT /api/messages/{id}/read-status** (AC: 5)
  - [ ] Create PUT action `UpdateReadStatusAsync(Guid id, [FromBody] UpdateReadStatusRequest request)`
  - [ ] Request body: `{ "isRead": true }`
  - [ ] Send MarkMessageAsReadCommand via MediatR
  - [ ] Return 200 OK
  - [ ] Return 404 if message not found
  - [ ] Return 403 if user not a recipient

- [ ] **Task 17: Create REST API endpoint GET /api/messages/attachments/{id}/download** (AC: 9)
  - [ ] Create GET action `DownloadAttachmentAsync(Guid id)`
  - [ ] Send DownloadMessageAttachmentQuery
  - [ ] Return File result with stream, ContentType, and FileName
  - [ ] Set Content-Disposition header for download
  - [ ] Return 404 if attachment not found
  - [ ] Return 403 if user not authorized

### Frontend Tasks

- [ ] **Task 18: Update messages service** (AC: All)
  - [ ] Update `messages.service.ts`
  - [ ] Methods:
    - `getMessages(query): Observable<GetMessagesResponse>` - AC 1, 2, 3, 4, 6, 10
    - `getMessageDetails(id): Observable<MessageDetailsResponse>` - AC 7, 8
    - `markAsRead(id, isRead): Observable<void>` - AC 5
    - `downloadAttachment(attachmentId): Observable<Blob>` - AC 9

- [ ] **Task 19: Create messages list component** (AC: 1, 2, 3, 4, 5, 6, 10)
  - [ ] Create `messages-list.component.ts` in `features/messaging/`
  - [ ] Route: `/messages`
  - [ ] Inject MessagesService
  - [ ] Load messages on init
  - [ ] Display messages in table or list

- [ ] **Task 20: Display message list with columns** (AC: 2)
  - [ ] Use PrimeNG Table component
  - [ ] Columns (from AC 2):
    - Read status indicator (icon: unread = bold/dot, read = normal)
    - Sender (name)
    - Subject/Preview (clickable)
    - Date (formatted)
    - Status (tag/badge)
    - Context (if applicable, e.g., "Case #12345")
    - Attachments icon (if has attachments)
  - [ ] Row styling: Unread messages in bold or highlighted

- [ ] **Task 21: Implement filters** (AC: 3)
  - [ ] Filter panel above table
  - [ ] Filter controls (AC 3):
    - Status dropdown (All, Awaits UKNF's response, Awaiting User's Response, Closed)
    - Sender dropdown or autocomplete (list of senders)
    - Date range picker (From/To dates)
    - Context dropdown (All, Standalone, Access Request, Report, Case)
  - [ ] "Apply Filters" button
  - [ ] "Clear Filters" button
  - [ ] Use PrimeNG Dropdown, Calendar components

- [ ] **Task 22: Implement sorting** (AC: 4)
  - [ ] Enable column sorting on table
  - [ ] Sortable columns (AC 4):
    - Date (default, descending)
    - Sender
    - Status
  - [ ] Click column header to sort
  - [ ] Show sort indicator (arrow up/down)
  - [ ] Use PrimeNG Table `sortField` and `sortOrder`

- [ ] **Task 23: Implement search** (AC: 6)
  - [ ] Search input above table
  - [ ] Placeholder: "Search by content or sender..."
  - [ ] Search on Enter or button click
  - [ ] Searches in message subject, body, sender name (AC 6)
  - [ ] Show search term in UI
  - [ ] Clear search button

- [ ] **Task 24: Implement mark as read/unread** (AC: 5)
  - [ ] Checkbox or icon in each row to mark as read/unread
  - [ ] Bulk action: Select multiple messages, "Mark as Read" or "Mark as Unread" button
  - [ ] On action, call messagesService.markAsRead()
  - [ ] Update row styling immediately (optimistic UI)
  - [ ] Show success message

- [ ] **Task 25: Implement pagination** (AC: 10)
  - [ ] Use PrimeNG Paginator component
  - [ ] Show total count: "Showing 1-20 of 150 messages"
  - [ ] Page size options: 10, 20, 50
  - [ ] Navigate between pages
  - [ ] Preserve filters/sorting when paginating

- [ ] **Task 26: Implement click to view details** (AC: 7)
  - [ ] Make subject/row clickable
  - [ ] On click, navigate to message details page: `/messages/{id}`
  - [ ] Or open in dialog/side panel (optional)
  - [ ] Mark message as read when opened (automatic)

- [ ] **Task 27: Create message details component** (AC: 7, 8, 9)
  - [ ] Create `message-details.component.ts` in `features/messaging/`
  - [ ] Route: `/messages/:id`
  - [ ] Inject MessagesService, ActivatedRoute
  - [ ] Load message details on init

- [ ] **Task 28: Display message details** (AC: 8)
  - [ ] Full message content display (from AC 8):
    - Subject (header)
    - Sender details: Name, email, phone, user type (UKNF/External)
    - Sent date/time (formatted)
    - Status badge
    - Context link (if applicable, e.g., "View Case #12345")
    - Full body (formatted, preserve line breaks)
    - Attachments section
    - Message thread section (if part of conversation)
  - [ ] Use PrimeNG Card, Tag, Divider components
  - [ ] Style with Tailwind CSS

- [ ] **Task 29: Display attachments with download links** (AC: 8, 9)
  - [ ] Attachments section listing all files
  - [ ] Each attachment shows:
    - File icon (based on type)
    - File name
    - File size (formatted)
    - Download button/link (AC 9)
  - [ ] On download click: Call messagesService.downloadAttachment() - AC 9
  - [ ] Download file using FileSaver or native download
  - [ ] Show download progress (optional)

- [ ] **Task 30: Display message thread** (AC: 8)
  - [ ] If message is part of conversation (has ParentMessageId or replies):
    - Show "Conversation" section
    - Display thread chronologically (oldest to newest)
    - Each message in thread shows: Sender, date, preview
    - Highlight current message
    - Click to view other messages in thread
  - [ ] Use timeline or nested list UI

- [ ] **Task 31: Add action buttons** (AC: 5, 7)
  - [ ] "Reply" button (navigate to compose reply - Story 5.3)
  - [ ] "Mark as Read/Unread" toggle button (AC 5)
  - [ ] "Back to Messages" button
  - [ ] "Download All Attachments" button (optional)

- [ ] **Task 32: Create page layout** (AC: All)
  - [ ] Messages list page:
    - Page title: "Messages"
    - Breadcrumb: Messages
    - Filter panel (collapsible)
    - Search bar
    - Action buttons: "Compose New Message", "Mark as Read/Unread"
    - Messages table with columns
    - Paginator
  - [ ] Message details page:
    - Page title: Message subject
    - Breadcrumb: Messages > [Subject]
    - Message card with all details
    - Attachments section
    - Thread section
    - Action buttons
  - [ ] Responsive design

- [ ] **Task 33: Add unread message count to navigation** (AC: 1)
  - [ ] Show unread message badge in main navigation
  - [ ] Badge displays count of unread messages
  - [ ] Update count when messages marked as read/unread
  - [ ] Use real-time updates if possible (SignalR)

### Testing Tasks

- [ ] **Task 34: Write unit tests for GetMessagesQueryHandler**
  - [ ] Test: `Handle_ValidQuery_ReturnsMessages` (AC 1, 2)
  - [ ] Test: `Handle_StatusFilter_FiltersCorrectly` (AC 3)
  - [ ] Test: `Handle_DateRangeFilter_FiltersCorrectly` (AC 3)
  - [ ] Test: `Handle_SearchTerm_SearchesInSubjectAndBody` (AC 6)
  - [ ] Test: `Handle_SortByDate_SortsCorrectly` (AC 4)
  - [ ] Test: `Handle_Pagination_ReturnsCorrectPage` (AC 10)
  - [ ] Mock: IMessageRepository

- [ ] **Task 35: Write unit tests for GetMessageDetailsQueryHandler**
  - [ ] Test: `Handle_ValidMessageId_ReturnsDetails` (AC 7, 8)
  - [ ] Test: `Handle_MessageNotFound_ReturnsNull` (AC 7)
  - [ ] Test: `Handle_UserNotRecipient_ThrowsUnauthorizedException` (AC 7)
  - [ ] Test: `Handle_MarksMessageAsRead` (AC 7)
  - [ ] Mock: IMessageRepository, ICurrentUserService

- [ ] **Task 36: Write unit tests for MarkMessageAsReadCommandHandler**
  - [ ] Test: `Handle_MarkAsRead_UpdatesIsReadAndReadDate` (AC 5)
  - [ ] Test: `Handle_MarkAsUnread_ClearsReadDate` (AC 5)
  - [ ] Mock: IMessageRepository, ICurrentUserService

- [ ] **Task 37: Write integration test for get messages endpoint**
  - [ ] Test: `GET_Messages_ValidQuery_Returns200` (AC 1, 2)
  - [ ] Test: `GET_Messages_WithFilters_ReturnsFilteredResults` (AC 3)
  - [ ] Test: `GET_Messages_WithSearch_ReturnsMatchingMessages` (AC 6)
  - [ ] Test: `GET_Messages_WithPagination_ReturnsCorrectPage` (AC 10)
  - [ ] Create test data: multiple messages with different statuses, senders
  - [ ] Verify pagination metadata correct

- [ ] **Task 38: Write integration test for message details endpoint**
  - [ ] Test: `GET_MessageDetails_ValidId_Returns200` (AC 7, 8)
  - [ ] Test: `GET_MessageDetails_MarksAsRead` (AC 7)
  - [ ] Test: `GET_MessageDetails_IncludesAttachments` (AC 8)
  - [ ] Test: `GET_MessageDetails_IncludesThread` (AC 8)
  - [ ] Test: `GET_MessageDetails_UserNotRecipient_Returns403` (AC 7)
  - [ ] Create test message with attachments and thread

- [ ] **Task 39: Write integration test for download attachment**
  - [ ] Test: `GET_DownloadAttachment_ValidId_ReturnsFile` (AC 9)
  - [ ] Test: `GET_DownloadAttachment_UserNotAuthorized_Returns403` (AC 9)
  - [ ] Test: `GET_DownloadAttachment_NotFound_Returns404` (AC 9)
  - [ ] Verify correct ContentType and FileName returned

- [ ] **Task 40: Write E2E test for viewing messages**
  - [ ] Test workflow:
    1. Login as external user
    2. Navigate to "Messages"
    3. Verify messages list displayed (AC 1, 2)
    4. Verify unread message highlighted/bolded
    5. Apply status filter (AC 3)
    6. Verify filtered results
    7. Enter search term (AC 6)
    8. Verify search results
    9. Sort by date (AC 4)
    10. Click on message to view details (AC 7)
    11. Verify full details displayed (AC 8)
    12. Verify attachments shown (AC 8)
    13. Click download attachment (AC 9)
    14. Verify file downloads
    15. Mark message as read (AC 5)
    16. Navigate back to messages list
    17. Verify message now shown as read
    18. Navigate to page 2 (AC 10)
    19. Verify pagination works
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 5.1:**
- Message entity created with Subject, Body, SenderId, MessageStatus, ContextType
- MessageAttachment entity for file attachments
- MessageRecipient junction table for multiple recipients
- This story implements the receiving/viewing side

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- File Storage: MinIO (S3-compatible)

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Table, Paginator, Calendar, Dropdown, Card, Tag)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── MessagesController.cs (UPDATE)
├── Application/UknfPlatform.Application.Communication/Messages/
│   ├── Commands/
│   │   ├── MarkMessageAsReadCommand.cs (CREATE)
│   │   └── MarkMessageAsReadCommandHandler.cs (CREATE)
│   ├── Queries/
│   │   ├── GetMessagesQuery.cs (CREATE)
│   │   ├── GetMessagesQueryHandler.cs (CREATE)
│   │   ├── GetMessageDetailsQuery.cs (CREATE)
│   │   ├── GetMessageDetailsQueryHandler.cs (CREATE)
│   │   ├── DownloadMessageAttachmentQuery.cs (CREATE)
│   │   └── DownloadMessageAttachmentQueryHandler.cs (CREATE)
│   └── DTOs/
│       ├── GetMessagesResponse.cs (CREATE)
│       ├── MessageSummaryDto.cs (CREATE)
│       ├── MessageDetailsResponse.cs (CREATE)
│       ├── MessageAttachmentDto.cs (CREATE)
│       └── MessageThreadItemDto.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── messages.service.ts (UPDATE)
└── features/messaging/
    ├── messages-list/
    │   ├── messages-list.component.ts (CREATE)
    │   ├── messages-list.component.html (CREATE)
    │   └── messages-list.component.scss (CREATE)
    ├── message-details/
    │   ├── message-details.component.ts (CREATE)
    │   ├── message-details.component.html (CREATE)
    │   └── message-details.component.scss (CREATE)
    └── components/
        ├── message-filters.component.ts (CREATE)
        └── message-thread.component.ts (CREATE)
```

### Data Models

**Message Entity (from Story 5.1):**
- Id (Guid)
- Subject (string, max 500)
- Body (string, max)
- SenderId (Guid)
- MessageStatus (enum: AwaitingUknfResponse, AwaitingUserResponse, Closed)
- ContextType (enum: Standalone, AccessRequest, Report, Case)
- ContextId (Guid?)
- EntityId (long?)
- ParentMessageId (Guid?)
- SentDate (DateTime)

**MessageRecipient Entity (from Story 5.1):**
- Id (Guid)
- MessageId (Guid)
- RecipientUserId (Guid)
- IsRead (bool) - AC 5
- ReadDate (DateTime?)

**MessageAttachment Entity (from Story 5.1):**
- Id (Guid)
- MessageId (Guid)
- FileName (string)
- FileStorageKey (string)
- FileSize (long)
- ContentType (string)

### REST API Specification

**Endpoint 1:** GET `/api/messages`
- **Security:** Requires authentication
- **Query Parameters:**
  - statusFilter (string?) - "AwaitingUknfResponse", "AwaitingUserResponse", "Closed"
  - senderFilter (Guid?)
  - dateFrom (DateTime?)
  - dateTo (DateTime?)
  - contextTypeFilter (string?) - "Standalone", "AccessRequest", "Report", "Case"
  - searchTerm (string?)
  - sortBy (string, default: "SentDate") - "SentDate", "Sender", "Status"
  - sortDirection (string, default: "DESC")
  - pageNumber (int, default: 1)
  - pageSize (int, default: 20)
- **Response (200 OK):**
  ```json
  {
    "messages": [
      {
        "messageId": "guid",
        "subject": "Question about Q1 Report",
        "bodyPreview": "I have a question regarding...",
        "senderName": "Jan Kowalski",
        "senderEmail": "jan.kowalski@example.com",
        "sentDate": "2025-10-04T10:00:00Z",
        "messageStatus": "Awaiting User's Response",
        "contextType": "Report",
        "contextId": "guid",
        "contextDisplayName": "Report Q1_2025",
        "isRead": false,
        "hasAttachments": true,
        "attachmentCount": 2
      }
    ],
    "totalCount": 150,
    "pageNumber": 1,
    "pageSize": 20,
    "totalPages": 8
  }
  ```

**Endpoint 2:** GET `/api/messages/{id}`
- **Security:** Requires authentication + authorization (user must be recipient)
- **Response (200 OK):**
  ```json
  {
    "messageId": "guid",
    "subject": "Question about Q1 Report",
    "body": "Full message content...",
    "senderName": "Jan Kowalski",
    "senderEmail": "jan.kowalski@example.com",
    "senderPhone": "+48 123 456 789",
    "senderUserType": "External User",
    "sentDate": "2025-10-04T10:00:00Z",
    "messageStatus": "Awaiting User's Response",
    "contextType": "Report",
    "contextId": "guid",
    "contextDisplayName": "Report Q1_2025",
    "isRead": true,
    "readDate": "2025-10-04T11:00:00Z",
    "attachments": [
      {
        "attachmentId": "guid",
        "fileName": "document.pdf",
        "fileSize": 2500000,
        "fileSizeFormatted": "2.5 MB",
        "contentType": "application/pdf",
        "uploadedDate": "2025-10-04T10:00:00Z",
        "downloadUrl": "/api/messages/attachments/guid/download"
      }
    ],
    "messageThread": [
      {
        "messageId": "guid",
        "subject": "Question about Q1 Report",
        "bodyPreview": "I have a question...",
        "senderName": "Jan Kowalski",
        "sentDate": "2025-10-04T10:00:00Z",
        "isCurrentMessage": true
      }
    ],
    "hasReplies": false,
    "canReply": true
  }
  ```

**Endpoint 3:** PUT `/api/messages/{id}/read-status`
- **Security:** Requires authentication + authorization
- **Request:**
  ```json
  { "isRead": true }
  ```
- **Response (200 OK)**

**Endpoint 4:** GET `/api/messages/attachments/{id}/download`
- **Security:** Requires authentication + authorization
- **Response:** File stream with appropriate ContentType and Content-Disposition headers

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Query messages for current user (AC 1)**
   ```csharp
   // ✅ CORRECT
   var query = _context.Messages
       .Include(m => m.Sender)
       .Include(m => m.Recipients)
       .Include(m => m.Attachments)
       .Where(m => m.Recipients.Any(r => r.RecipientUserId == currentUserId));
   ```

2. **Apply filters (AC 3)**
   ```csharp
   // ✅ CORRECT
   if (query.StatusFilter.HasValue)
       messagesQuery = messagesQuery.Where(m => m.MessageStatus == query.StatusFilter);
   
   if (query.DateFrom.HasValue)
       messagesQuery = messagesQuery.Where(m => m.SentDate >= query.DateFrom);
   
   if (query.DateTo.HasValue)
       messagesQuery = messagesQuery.Where(m => m.SentDate <= query.DateTo);
   ```

3. **Apply search (AC 6)**
   ```csharp
   // ✅ CORRECT
   if (!string.IsNullOrWhiteSpace(query.SearchTerm))
   {
       var searchLower = query.SearchTerm.ToLower();
       messagesQuery = messagesQuery.Where(m => 
           m.Subject.ToLower().Contains(searchLower) ||
           m.Body.ToLower().Contains(searchLower) ||
           m.Sender.FirstName.ToLower().Contains(searchLower) ||
           m.Sender.LastName.ToLower().Contains(searchLower));
   }
   ```

4. **Apply sorting (AC 4)**
   ```csharp
   // ✅ CORRECT
   messagesQuery = query.SortBy switch
   {
       "Sender" => query.SortDirection == "ASC" 
           ? messagesQuery.OrderBy(m => m.Sender.LastName)
           : messagesQuery.OrderByDescending(m => m.Sender.LastName),
       "Status" => query.SortDirection == "ASC"
           ? messagesQuery.OrderBy(m => m.MessageStatus)
           : messagesQuery.OrderByDescending(m => m.MessageStatus),
       _ => query.SortDirection == "ASC"
           ? messagesQuery.OrderBy(m => m.SentDate)
           : messagesQuery.OrderByDescending(m => m.SentDate)
   };
   ```

5. **Mark message as read when viewed (AC 7)**
   ```csharp
   // ✅ CORRECT
   var recipient = message.Recipients.FirstOrDefault(r => r.RecipientUserId == currentUserId);
   if (recipient != null && !recipient.IsRead)
   {
       recipient.IsRead = true;
       recipient.ReadDate = DateTime.UtcNow;
       await _unitOfWork.SaveChangesAsync();
   }
   ```

6. **Build message thread (AC 8)**
   ```csharp
   // ✅ CORRECT
   var thread = new List<Message>();
   
   // Get parent messages
   var currentMessage = message;
   while (currentMessage.ParentMessageId.HasValue)
   {
       var parent = await _context.Messages.FindAsync(currentMessage.ParentMessageId.Value);
       if (parent != null)
           thread.Insert(0, parent);
       currentMessage = parent;
   }
   
   // Add current message
   thread.Add(message);
   
   // Get replies (children)
   var replies = await _context.Messages
       .Where(m => m.ParentMessageId == message.Id)
       .OrderBy(m => m.SentDate)
       .ToListAsync();
   thread.AddRange(replies);
   ```

7. **Download attachment with authorization (AC 9)**
   ```csharp
   // ✅ CORRECT
   var attachment = await _context.MessageAttachments
       .Include(a => a.Message)
       .ThenInclude(m => m.Recipients)
       .FirstOrDefaultAsync(a => a.Id == attachmentId);
   
   if (attachment == null)
       throw new NotFoundException("Attachment not found");
   
   var isRecipient = attachment.Message.Recipients
       .Any(r => r.RecipientUserId == currentUserId);
   
   if (!isRecipient)
       throw new UnauthorizedException("Not authorized to download this attachment");
   
   var fileStream = await _fileStorageService.DownloadAsync(attachment.FileStorageKey);
   return (fileStream, attachment.FileName, attachment.ContentType);
   ```

### UI/UX Considerations

**Message List Table:**
```html
<p-table [value]="messages" 
         [lazy]="true" 
         (onLazyLoad)="loadMessages($event)"
         [totalRecords]="totalCount"
         [paginator]="true"
         [rows]="pageSize"
         [sortField]="sortField"
         [sortOrder]="sortOrder"
         [rowsPerPageOptions]="[10, 20, 50]">
  
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 30px"></th> <!-- Read indicator -->
      <th pSortableColumn="Sender">Sender <p-sortIcon field="Sender"></p-sortIcon></th>
      <th>Subject</th>
      <th pSortableColumn="SentDate">Date <p-sortIcon field="SentDate"></p-sortIcon></th>
      <th pSortableColumn="Status">Status <p-sortIcon field="Status"></p-sortIcon></th>
      <th>Context</th>
      <th style="width: 50px"></th> <!-- Actions -->
    </tr>
  </ng-template>
  
  <ng-template pTemplate="body" let-message>
    <tr [class.font-bold]="!message.isRead" (click)="viewMessage(message.messageId)" class="cursor-pointer">
      <td>
        <i *ngIf="!message.isRead" class="pi pi-circle-fill text-primary text-xs"></i>
      </td>
      <td>{{ message.senderName }}</td>
      <td>
        <div class="flex items-center gap-2">
          <span>{{ message.subject }}</span>
          <i *ngIf="message.hasAttachments" class="pi pi-paperclip text-gray-500"></i>
        </div>
        <div class="text-sm text-gray-600">{{ message.bodyPreview }}</div>
      </td>
      <td>{{ message.sentDate | date:'short' }}</td>
      <td><p-tag [value]="message.messageStatus" [severity]="getStatusSeverity(message.messageStatus)"></p-tag></td>
      <td>
        <a *ngIf="message.contextDisplayName" [routerLink]="getContextLink(message)">
          {{ message.contextDisplayName }}
        </a>
      </td>
      <td>
        <button pButton icon="pi pi-ellipsis-v" class="p-button-text p-button-sm" (click)="showActions($event, message); $event.stopPropagation()"></button>
      </td>
    </tr>
  </ng-template>
</p-table>
```

**Filter Panel:**
```html
<div class="filter-panel p-4 bg-gray-50 mb-4">
  <div class="grid grid-cols-4 gap-4">
    <div>
      <label>Status</label>
      <p-dropdown [options]="statusOptions" [(ngModel)]="filters.status" placeholder="All statuses" [showClear]="true"></p-dropdown>
    </div>
    <div>
      <label>Date From</label>
      <p-calendar [(ngModel)]="filters.dateFrom" [showIcon]="true"></p-calendar>
    </div>
    <div>
      <label>Date To</label>
      <p-calendar [(ngModel)]="filters.dateTo" [showIcon]="true"></p-calendar>
    </div>
    <div>
      <label>Context</label>
      <p-dropdown [options]="contextOptions" [(ngModel)]="filters.contextType" placeholder="All contexts" [showClear]="true"></p-dropdown>
    </div>
  </div>
  <div class="flex gap-2 mt-4">
    <button pButton label="Apply Filters" (click)="applyFilters()"></button>
    <button pButton label="Clear" class="p-button-secondary" (click)="clearFilters()"></button>
  </div>
</div>
```

### Business Rules

**Message Access:**
- Users can only view messages where they are recipients
- External users see messages for their entities
- UKNF employees see all messages (or filtered by "My Entities")

**Read Status:**
- Message marked as read automatically when viewed (AC 7)
- Users can manually mark as read/unread (AC 5)
- Each recipient has individual read status (MessageRecipient.IsRead)

**Message Threading:**
- ParentMessageId creates conversation threads
- Thread displays all related messages chronologically
- Current message highlighted in thread view

**Context Display:**
- If message linked to context (Access Request, Report, Case): Show link
- Context display name format:
  - Case: "Case #12345"
  - Report: "Report Q1_2025"
  - Access Request: "Access Request #67890"

### Security Requirements

- Only recipients can view message details
- Only recipients can download attachments
- Authorization checked for every message/attachment access
- File downloads require authentication token

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Message list queries must be efficient (pagination, indexes)
- Search should be fast (< 2 seconds for large datasets)
- Database indexes on:
  - MessageRecipients.RecipientUserId, IsRead
  - Messages.SentDate
  - Messages.MessageStatus
  - Messages.ContextType, ContextId
- Consider caching sender user details
- Lazy load message thread (only when expanded)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Get messages for current user
- Filter messages by status, date, context
- Search messages by content/sender
- Sort messages by date, sender, status
- Pagination works correctly
- Mark message as read/unread
- View message details with authorization
- Download attachment with authorization
- Message thread displayed correctly

**Example:**
```csharp
[Fact]
public async Task Handle_GetMessages_ReturnsCurrentUserMessages()
{
    // Arrange - AC 1, 2
    var currentUser = CreateTestUser();
    var otherUser = CreateTestUser();
    var message1 = CreateTestMessage(sender: otherUser, recipient: currentUser);
    var message2 = CreateTestMessage(sender: otherUser, recipient: otherUser); // Not for current user
    
    await _context.Messages.AddRangeAsync(message1, message2);
    await _context.SaveChangesAsync();
    
    _currentUserService.GetCurrentUserId().Returns(currentUser.Id);
    
    var query = new GetMessagesQuery { PageNumber = 1, PageSize = 20 };
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.Messages.Should().HaveCount(1);
    result.Messages[0].MessageId.Should().Be(message1.Id);
    result.TotalCount.Should().Be(1);
}
```

### Additional Notes

1. **Unread Count Badge:** Consider real-time updates using SignalR to update unread count without page refresh.

2. **Message Preview:** Body preview should be first 200 characters, stripped of HTML if any, with "..." if truncated.

3. **Context Links:** When clicking context link (e.g., "Case #12345"), navigate to case details page with message context preserved.

4. **Bulk Actions:** Support selecting multiple messages and marking as read/unread in bulk.

5. **Email Integration:** When email notification sent (Story 5.1), include link that opens message directly in platform.

6. **Mobile Responsive:** Table should collapse to cards on mobile devices.

7. **Keyboard Navigation:** Support arrow keys to navigate message list, Enter to open message.

8. **Accessibility:** Ensure screen reader support for read/unread status, proper ARIA labels.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 5, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

