# Story 8.2: Add/Edit Entity Data (UKNF)

**Epic:** 8 - Entity Management & Q&A  
**Story Number:** 8.2  
**Created:** 2025-10-04

---

## Status

**Pending** ‚è≥

---

## Story

**As a** System Administrator or UKNF Employee,  
**I want to** add or edit entity information,  
**So that** entity data in the system is current and accurate.

---

## Acceptance Criteria

1. System Administrator can add new entity with all fields
2. UKNF Employee can edit existing entity data
3. Entity data fields per PRD specification (see schema below)
4. System validates phone number format (international)
5. System validates email format
6. System validates required fields are populated
7. Changes are saved with timestamp and user ID
8. System logs all changes in entity change history
9. Changed entity data is versioned
10. UKNF code cannot be edited once set (comes from Entity Database)

---

## Entity Schema

| Field | Type | Description |
|-------|------|-------------|
| ID | bigint | System-generated unique identifier |
| Type of entity | nvarchar(250) | Role in Entity Database (e.g., loan institution) |
| UKNF code | nvarchar(250) | Code from Entity Database, non-editable |
| Name of the entity | nvarchar(500) | |
| LEI | nvarchar(20) | Legal Entity Identifier |
| NIP | nvarchar(10) | Tax ID |
| KRS | nvarchar(10) | National Court Register number |
| Street | nvarchar(250) | Address line |
| Building number | nvarchar(250) | |
| Number of the premises | nvarchar(250) | Apartment/suite number |
| Postcode | nvarchar(250) | |
| City | nvarchar(250) | |
| Telephone | nvarchar(250) | Validated international format `/^\+(?:[0-9] ?){6,14}[0-9]$/` |
| E-mail | nvarchar(500) | Validated email format |
| UKNF registration number | nvarchar(100) | |
| Entity status | nvarchar(250) | e.g., Entered, Deleted |
| Category of entity | nvarchar(500) | |
| Sector of the operator | nvarchar(500) | |
| Entity sub-sector | nvarchar(500) | |
| Cross-border entity | bit | Checkbox (yes/no) |
| Date of creation | datetime2(7) | Auto-populated on creation |
| Date of update | datetime2(7) | Auto-updated on modification |

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create Entity domain entity** (AC: 3, 9, 10)
  - [ ] Create `Entity.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Implement all fields from schema
  - [ ] Add domain methods: Create(), Update(), AddChangeHistoryEntry()
  - [ ] Make UKNF code read-only after initial set
  - [ ] Add validation rules

- [ ] **Task 2: Create EntityChangeHistory entity** (AC: 7, 8, 9)
  - [ ] Create `EntityChangeHistory.cs`
  - [ ] Properties: Id, EntityId, FieldName, PreviousValue, NewValue, ChangedBy, ChangedDate, ChangeSource
  - [ ] Track field-level changes

- [ ] **Task 3: Create CreateEntityCommand** (AC: 1, 3)
  - [ ] Create `CreateEntityCommand.cs` in `Application/UknfPlatform.Application.Communication/Entities/Commands/`
  - [ ] All entity fields as command properties
  - [ ] Create `CreateEntityCommandHandler.cs`
  - [ ] Inject IEntityRepository, ICurrentUserService
  - [ ] Create entity with version 1
  - [ ] Log creation event

- [ ] **Task 4: Create UpdateEntityCommand** (AC: 2, 3, 7, 8, 9, 10)
  - [ ] Create `UpdateEntityCommand.cs`
  - [ ] Include EntityId and all editable fields
  - [ ] Create `UpdateEntityCommandHandler.cs`
  - [ ] Prevent UKNF code modification
  - [ ] Track field changes
  - [ ] Create change history entries
  - [ ] Version entity data
  - [ ] Log update event

- [ ] **Task 5: Create validators** (AC: 4, 5, 6)
  - [ ] Create `CreateEntityCommandValidator.cs`
  - [ ] Create `UpdateEntityCommandValidator.cs`
  - [ ] Validate phone: `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate email format
  - [ ] Validate required fields
  - [ ] Validate field lengths

- [ ] **Task 6: Create REST API endpoints** (AC: 1, 2)
  - [ ] POST /api/entities (create)
  - [ ] PUT /api/entities/{id} (update)
  - [ ] Add authorization: System Admin can create, UKNF Employee can update
  - [ ] Return 201/200 with entity DTO
  - [ ] Return 400 for validation errors
  - [ ] Return 403 if not authorized
  - [ ] Add Swagger documentation

- [ ] **Task 7: Create database migration** (AC: 3)
  - [ ] Create `Add_Entities_Table` migration
  - [ ] Create `Add_EntityChangeHistory_Table` migration
  - [ ] Add indexes on UKNF code, NIP, KRS
  - [ ] Add constraints

### Frontend Tasks

- [ ] **Task 8: Create entity form component** (AC: 1, 2, 3)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/entities/entity-form/entity-form.component.ts`
  - [ ] Reusable for create and edit modes
  - [ ] Reactive form with all entity fields
  - [ ] Disable UKNF code field in edit mode

- [ ] **Task 9: Implement field validations** (AC: 4, 5, 6)
  - [ ] Phone number validation (international format)
  - [ ] Email validation
  - [ ] Required field validation
  - [ ] Max length validation
  - [ ] Show validation errors inline

- [ ] **Task 10: Create entity page** (AC: 1)
  - [ ] Configure routing: `/entities/new`
  - [ ] Page title: "Add New Entity"
  - [ ] Use entity form component
  - [ ] Handle form submission
  - [ ] Navigate to entity detail on success

- [ ] **Task 11: Add edit functionality** (AC: 2)
  - [ ] Add "Edit" button to entity detail page
  - [ ] Configure routing: `/entities/:id/edit`
  - [ ] Pre-populate form with entity data
  - [ ] Disable UKNF code field
  - [ ] Show change history after save

### Testing Tasks

- [ ] **Task 12: Write unit tests**
  - [ ] Test: CreateEntityCommandHandler creates entity
  - [ ] Test: UpdateEntityCommandHandler updates and creates history
  - [ ] Test: UKNF code cannot be changed
  - [ ] Test: Validators catch invalid phone/email
  - [ ] Test: Entity versioning works correctly

- [ ] **Task 13: Write integration tests**
  - [ ] Test: POST /api/entities creates entity
  - [ ] Test: PUT /api/entities/:id updates entity
  - [ ] Test: Change history is recorded
  - [ ] Test: Authorization checks work

---

## Dev Notes

### Versioning Strategy

- Each entity update creates a new version
- Previous version is archived
- Change history tracks field-level changes
- Version number increments on each update

### Security

- Only System Administrators can create new entities
- UKNF Employees can edit existing entities
- All changes are audited
- UKNF code is immutable after creation

### Performance

- Index on frequently searched fields
- Optimize change history queries
- Consider archiving old versions

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 8 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

