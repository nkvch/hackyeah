# Story 5.4: Message Status Management

**Epic:** 5 - Messaging & Cases  
**Story Number:** 5.4  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As the** system,  
**I want to** track message statuses based on sender type,  
**So that** users can see which messages require their response.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-5-messaging-cases.md` - Story 5.4

1. Message sent by External User to UKNF has status "Awaits UKNF's response"
2. Message sent by UKNF Employee to External User has status "Awaiting the User's Response"
3. When recipient replies, message status changes to "Closed"
4. Users can filter messages by status
5. UKNF Employees can use quick filter "Requires UKNF responses" to see all messages with status "Awaits UKNF's response"
6. Dashboard shows count of messages requiring user's response
7. Closed messages remain accessible in message history

---

## Tasks / Subtasks

### Backend Tasks

**Note:** Most status logic already implemented in Stories 5.1-5.3. This story focuses on verification, dashboard counts, and filters.

- [ ] **Task 1: Verify status setting logic (Stories 5.1, 5.3)** (AC: 1, 2)
  - [ ] Verify SendMessageCommandHandler sets status correctly (AC 1, 2):
    - External User sender → MessageStatus.AwaitingUknfResponse
    - UKNF Employee sender → MessageStatus.AwaitingUserResponse
  - [ ] Verify ReplyToMessageCommandHandler sets reply status correctly (AC 1, 2)
  - [ ] Add unit tests if not already present

- [ ] **Task 2: Verify status transition on reply (Story 5.3)** (AC: 3)
  - [ ] Verify ReplyToMessageCommandHandler updates parent message to "Closed" (AC 3)
  - [ ] Add integration test for complete flow:
    - External user sends message → status "Awaits UKNF's response"
    - UKNF employee replies → parent status "Closed", reply status "Awaiting the User's Response"
    - External user replies → parent reply status "Closed"

- [ ] **Task 3: Create GetMessageCountsQuery** (AC: 6)
  - [ ] Create `GetMessageCountsQuery.cs` in `Application/UknfPlatform.Application.Communication/Messages/Queries/`
  - [ ] Query properties:
    - UserId (Guid) - current user (set by handler)

- [ ] **Task 4: Create GetMessageCountsQueryHandler** (AC: 6)
  - [ ] Create `GetMessageCountsQueryHandler.cs`
  - [ ] Inject: IMessageRepository, ICurrentUserService
  - [ ] Handler logic:
    1. Get current user ID
    2. Query messages where user is recipient
    3. Count messages by status:
       - Total messages
       - Unread messages (MessageRecipient.IsRead = false)
       - Messages requiring user's response (based on user type):
         * If UKNF Employee: Count messages with status "AwaitingUknfResponse"
         * If External User: Count messages with status "AwaitingUserResponse"
       - Closed messages
    4. Return MessageCountsResponse

- [ ] **Task 5: Create MessageCountsResponse DTO** (AC: 6)
  - [ ] Create `MessageCountsResponse.cs` record
  - [ ] Properties:
    - TotalMessages (int)
    - UnreadMessages (int)
    - RequiresMyResponse (int) - messages requiring current user's response
    - ClosedMessages (int)
    - AwaitingUknfResponse (int) - for UKNF employees
    - AwaitingUserResponse (int) - for external users

- [ ] **Task 6: Create REST API endpoint GET /api/messages/counts** (AC: 6)
  - [ ] Update MessagesController
  - [ ] Create GET action `GetMessageCountsAsync()`
  - [ ] Send GetMessageCountsQuery via MediatR
  - [ ] Return 200 OK with MessageCountsResponse
  - [ ] Add XML documentation

- [ ] **Task 7: Verify status filter implementation (Story 5.2)** (AC: 4)
  - [ ] Verify GetMessagesQueryHandler supports status filtering (already implemented)
  - [ ] Ensure all status values can be filtered:
    - AwaitingUknfResponse
    - AwaitingUserResponse
    - Closed
  - [ ] Add integration test for status filtering

- [ ] **Task 8: Verify closed messages remain accessible** (AC: 7)
  - [ ] Verify GetMessagesQuery returns closed messages (no filter excludes them)
  - [ ] Verify GetMessageDetailsQuery can fetch closed messages
  - [ ] Verify closed messages appear in message list with "Closed" status
  - [ ] Add test: Verify closed message can be viewed and thread accessed

### Frontend Tasks

- [ ] **Task 9: Verify status display in message list** (AC: 1, 2, 7)
  - [ ] Verify message list displays status badge correctly:
    - "Awaits UKNF's response" (orange/warning)
    - "Awaiting the User's Response" (blue/info)
    - "Closed" (gray/neutral)
  - [ ] Verify status colors/badges are distinct and clear

- [ ] **Task 10: Verify status filter UI (Story 5.2)** (AC: 4)
  - [ ] Verify status filter dropdown includes all status options:
    - All Statuses
    - Awaits UKNF's response
    - Awaiting the User's Response
    - Closed
  - [ ] Verify filter applies correctly to message list
  - [ ] Test filtering by each status value

- [ ] **Task 11: Add "Requires UKNF responses" quick filter** (AC: 5)
  - [ ] Add quick filter button/chip for UKNF employees
  - [ ] Button label: "Requires UKNF Response" or "Needs My Response"
  - [ ] On click: Filter messages to show only "Awaits UKNF's response" status
  - [ ] Show count badge: "Requires Response (15)"
  - [ ] Prominent placement in message list header

- [ ] **Task 12: Add "Requires My Response" quick filter (External Users)** (AC: 6)
  - [ ] Similar to Task 11, but for external users
  - [ ] Filter to show only "Awaiting the User's Response" status
  - [ ] Label: "Needs My Response"

- [ ] **Task 13: Create dashboard message counts widget** (AC: 6)
  - [ ] Create `message-counts-widget.component.ts` in `shared/widgets/`
  - [ ] Inject MessagesService
  - [ ] Fetch message counts on init
  - [ ] Display cards/stats:
    - Total Messages
    - Unread Messages (with badge)
    - Requires My Response (prominent, with action button)
    - Closed Messages
  - [ ] Use PrimeNG Card, Badge components

- [ ] **Task 14: Add message counts to main dashboard** (AC: 6)
  - [ ] Add message-counts-widget to user dashboard (home page)
  - [ ] For UKNF employees: Show "Requires UKNF Response" count prominently
  - [ ] For external users: Show "Requires My Response" count
  - [ ] Click on count: Navigate to filtered message list

- [ ] **Task 15: Add unread message badge to navigation** (AC: 6)
  - [ ] Update main navigation menu
  - [ ] Show badge on "Messages" menu item
  - [ ] Badge displays count of unread messages
  - [ ] Badge color: Red or primary color
  - [ ] Update count in real-time (or on page load)

- [ ] **Task 16: Verify closed messages remain visible** (AC: 7)
  - [ ] Test: Filter by "Closed" status
  - [ ] Verify closed messages appear in list
  - [ ] Verify closed messages can be clicked and viewed
  - [ ] Verify thread history accessible for closed messages
  - [ ] No special restrictions on closed messages (read-only but accessible)

- [ ] **Task 17: Add status transition indicators** (AC: 3)
  - [ ] In message thread view, show when status changed to "Closed"
  - [ ] Display: "This message was closed on [date] after receiving a reply"
  - [ ] Visual indicator: Checkmark or lock icon for closed messages

### Testing Tasks

- [ ] **Task 18: Write unit tests for message status logic**
  - [ ] Test: `SendMessage_ExternalUserSender_SetsAwaitingUknfStatus` (AC 1)
  - [ ] Test: `SendMessage_UknfEmployeeSender_SetsAwaitingUserStatus` (AC 2)
  - [ ] Test: `ReplyToMessage_UpdatesParentToClosed` (AC 3)
  - [ ] Verify status enum values match expectations

- [ ] **Task 19: Write unit tests for GetMessageCountsQueryHandler**
  - [ ] Test: `Handle_UknfEmployee_CountsAwaitingUknfMessages` (AC 6)
  - [ ] Test: `Handle_ExternalUser_CountsAwaitingUserMessages` (AC 6)
  - [ ] Test: `Handle_CountsUnreadMessages` (AC 6)
  - [ ] Test: `Handle_CountsClosedMessages` (AC 6, 7)
  - [ ] Create test data: Messages with different statuses

- [ ] **Task 20: Write integration test for status workflow**
  - [ ] Test: Complete message exchange workflow (AC 1, 2, 3):
    1. External user sends message
    2. Verify status "Awaits UKNF's response" (AC 1)
    3. UKNF employee replies
    4. Verify original status "Closed" (AC 3)
    5. Verify reply status "Awaiting the User's Response" (AC 2)
    6. External user replies to reply
    7. Verify previous reply status "Closed" (AC 3)
    8. Verify conversation thread intact
  - [ ] Verify all messages remain accessible (AC 7)

- [ ] **Task 21: Write integration test for message counts**
  - [ ] Test: `GET_MessageCounts_ReturnsCorrectCounts` (AC 6)
  - [ ] Create test scenario:
    - 10 total messages for user
    - 5 unread
    - 3 requiring user's response
    - 4 closed
  - [ ] Verify counts match expectations

- [ ] **Task 22: Write integration test for status filtering**
  - [ ] Test: `GET_Messages_FilterByStatus_ReturnsMatchingMessages` (AC 4)
  - [ ] Test filtering by each status:
    - AwaitingUknfResponse
    - AwaitingUserResponse
    - Closed
  - [ ] Verify only matching messages returned

- [ ] **Task 23: Write E2E test for status management**
  - [ ] Test workflow:
    1. Login as external user
    2. Send message to UKNF
    3. Verify message list shows status "Awaits UKNF's response" (AC 1)
    4. Navigate to dashboard
    5. Verify message counts displayed (AC 6)
    6. Login as UKNF employee
    7. Navigate to Messages
    8. Verify "Requires UKNF responses" quick filter available (AC 5)
    9. Click quick filter
    10. Verify filtered to show awaiting messages
    11. Open message and reply
    12. Verify original message status changed to "Closed" (AC 3)
    13. Login as external user
    14. Verify reply received with status "Awaiting the User's Response" (AC 2)
    15. Filter by "Closed" status (AC 4)
    16. Verify original message appears (AC 7)
    17. Click message to view
    18. Verify full thread accessible (AC 7)
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 5.1:**
- SendMessageCommand sets message status based on sender type
- Status logic: External User → AwaitingUknfResponse, UKNF → AwaitingUserResponse

**From Story 5.3:**
- ReplyToMessageCommand updates parent message status to "Closed"
- Reply status set based on replying user's type

**This story consolidates and verifies:**
- Status setting and transitions work correctly
- Dashboard counts for message management
- Quick filters for efficient workflow
- Closed messages remain accessible

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (Card, Badge, Button, Chip)
- Styling: Tailwind CSS

### Project Structure

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── MessagesController.cs (UPDATE - add counts endpoint)
├── Application/UknfPlatform.Application.Communication/Messages/
│   ├── Queries/
│   │   ├── GetMessageCountsQuery.cs (CREATE)
│   │   └── GetMessageCountsQueryHandler.cs (CREATE)
│   └── DTOs/
│       └── MessageCountsResponse.cs (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── messages.service.ts (UPDATE - add getCounts method)
├── shared/widgets/
│   └── message-counts-widget/
│       ├── message-counts-widget.component.ts (CREATE)
│       ├── message-counts-widget.component.html (CREATE)
│       └── message-counts-widget.component.scss (CREATE)
└── features/messaging/messages-list/
    └── messages-list.component.ts (UPDATE - add quick filters)
```

### Data Models

**MessageStatus Enum (defined in Stories 5.1-5.3):**
```csharp
public enum MessageStatus
{
    AwaitingUknfResponse,      // AC 1
    AwaitingUserResponse,       // AC 2
    Closed                      // AC 3
}
```

**Status Display Names:**
- AwaitingUknfResponse → "Awaits UKNF's response"
- AwaitingUserResponse → "Awaiting the User's Response"
- Closed → "Closed"

### REST API Specification

**Endpoint:** GET `/api/messages/counts`
- **Security:** Requires authentication
- **Response (200 OK):**
  ```json
  {
    "totalMessages": 45,
    "unreadMessages": 12,
    "requiresMyResponse": 8,
    "closedMessages": 25,
    "awaitingUknfResponse": 8,
    "awaitingUserResponse": 12
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Set message status based on sender type (AC 1, 2)**
   ```csharp
   // ✅ CORRECT - Already implemented in Story 5.1, 5.3
   var sender = await _userRepository.GetByIdAsync(currentUserId);
   var messageStatus = sender.UserType == UserType.External 
       ? MessageStatus.AwaitingUknfResponse 
       : MessageStatus.AwaitingUserResponse;
   
   message.MessageStatus = messageStatus;
   ```

2. **Update parent message to Closed on reply (AC 3)**
   ```csharp
   // ✅ CORRECT - Already implemented in Story 5.3
   parentMessage.MessageStatus = MessageStatus.Closed;
   await _messageRepository.UpdateAsync(parentMessage);
   ```

3. **Count messages requiring user's response (AC 6)**
   ```csharp
   // ✅ CORRECT
   var currentUser = await _userRepository.GetByIdAsync(currentUserId);
   
   var requiresMyResponse = currentUser.UserType == UserType.Internal
       ? await _context.Messages
           .Where(m => m.Recipients.Any(r => r.RecipientUserId == currentUserId) &&
                      m.MessageStatus == MessageStatus.AwaitingUknfResponse)
           .CountAsync()
       : await _context.Messages
           .Where(m => m.Recipients.Any(r => r.RecipientUserId == currentUserId) &&
                      m.MessageStatus == MessageStatus.AwaitingUserResponse)
           .CountAsync();
   ```

4. **Ensure closed messages remain accessible (AC 7)**
   ```csharp
   // ✅ CORRECT - No soft delete or hiding of closed messages
   var messages = await _context.Messages
       .Include(m => m.Recipients)
       .Where(m => m.Recipients.Any(r => r.RecipientUserId == currentUserId))
       // No filter excluding Closed status - all messages accessible
       .ToListAsync();
   ```

### Message Status Workflow

**Status Transitions:**
```
External User sends message:
  → Status: "Awaits UKNF's response" (AC 1)
  
UKNF Employee replies:
  → Original message status: "Closed" (AC 3)
  → Reply status: "Awaiting the User's Response" (AC 2)
  
External User replies to reply:
  → Previous reply status: "Closed" (AC 3)
  → New reply status: "Awaits UKNF's response" (AC 1)
  
Conversation continues...
```

**Key Points:**
- Each message has its own status
- When replied to, message becomes "Closed"
- Reply is a new message with its own status
- Status determines who needs to respond next

### UI/UX Considerations

**Quick Filter Buttons:**
```html
<!-- For UKNF Employees -->
<div class="quick-filters mb-4 flex gap-2">
  <button pButton 
          label="All Messages" 
          [class.p-button-primary]="!activeFilter"
          (click)="clearFilter()"></button>
  
  <button pButton 
          [label]="'Requires UKNF Response (' + counts.awaitingUknfResponse + ')'"
          [class.p-button-warning]="activeFilter === 'requiresResponse'"
          (click)="filterRequiresResponse()"></button>
  
  <button pButton 
          [label]="'Unread (' + counts.unreadMessages + ')'"
          [class.p-button-info]="activeFilter === 'unread'"
          (click)="filterUnread()"></button>
  
  <button pButton 
          [label]="'Closed (' + counts.closedMessages + ')'"
          [class.p-button-secondary]="activeFilter === 'closed'"
          (click)="filterClosed()"></button>
</div>
```

**Dashboard Widget:**
```html
<div class="grid grid-cols-4 gap-4">
  <p-card>
    <h3>Total Messages</h3>
    <div class="text-4xl font-bold">{{ counts.totalMessages }}</div>
  </p-card>
  
  <p-card styleClass="border-l-4 border-orange-500">
    <h3>Requires My Response</h3>
    <div class="text-4xl font-bold text-orange-600">{{ counts.requiresMyResponse }}</div>
    <button pButton label="View" class="mt-2 p-button-sm" (click)="navigateToMessages()"></button>
  </p-card>
  
  <p-card styleClass="border-l-4 border-blue-500">
    <h3>Unread</h3>
    <div class="text-4xl font-bold text-blue-600">{{ counts.unreadMessages }}</div>
  </p-card>
  
  <p-card styleClass="border-l-4 border-gray-500">
    <h3>Closed</h3>
    <div class="text-4xl font-bold text-gray-600">{{ counts.closedMessages }}</div>
  </p-card>
</div>
```

**Navigation Badge:**
```html
<a routerLink="/messages" class="nav-link">
  <i class="pi pi-envelope"></i>
  Messages
  <p-badge *ngIf="unreadCount > 0" [value]="unreadCount" severity="danger"></p-badge>
</a>
```

### Business Rules

**Status Assignment (AC 1, 2):**
- Sender type determines status
- External User → Message awaits UKNF's response
- UKNF Employee → Message awaits User's response
- This indicates who needs to act next

**Status Transition (AC 3):**
- When message receives reply, status → "Closed"
- Closed = conversation has response, not necessarily finished
- Users can still reply to closed messages (creates new thread)

**Filtering (AC 4, 5):**
- Users can filter by any status
- UKNF employees have quick filter for "Awaits UKNF's response"
- This helps prioritize work queue

**Dashboard Counts (AC 6):**
- Helps users understand message workload
- "Requires My Response" = action items
- Displayed prominently on dashboard

**Accessibility (AC 7):**
- Closed messages not hidden or deleted
- Full history preserved
- Users can filter to view closed messages
- Thread history remains intact

### Security Requirements

- Message counts only for current user's messages
- No exposure of other users' message counts
- Status changes logged for audit

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Message counts query should be efficient (indexed)
- Consider caching counts (refresh every minute)
- Dashboard widget: Load counts async (don't block page load)
- Database indexes on:
  - Messages.MessageStatus
  - MessageRecipients.RecipientUserId, IsRead

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Status set correctly based on sender type
- Parent message status updates to Closed on reply
- Message counts calculated correctly
- Status filtering works
- Closed messages remain accessible

**Example:**
```csharp
[Fact]
public async Task SendMessage_ExternalUserSender_SetsAwaitingUknfStatus()
{
    // Arrange - AC 1
    var externalUser = CreateExternalUser();
    var uknfEmployee = CreateUknfEmployee();
    
    _currentUserService.GetCurrentUserId().Returns(externalUser.Id);
    
    var command = new SendMessageCommand
    {
        Subject = "Question",
        Body = "Test question",
        RecipientType = RecipientType.User,
        RecipientUserIds = new List<Guid> { uknfEmployee.Id },
        ContextType = ContextType.Standalone
    };
    
    // Act
    var result = await _sendHandler.Handle(command, CancellationToken.None);
    
    // Assert
    var message = await _context.Messages.FindAsync(result.MessageId);
    message.MessageStatus.Should().Be(MessageStatus.AwaitingUknfResponse);
}
```

### Additional Notes

1. **Story Nature:** This is primarily a verification/consolidation story. Most logic already implemented in Stories 5.1-5.3. Focus is on:
   - Ensuring status logic is correct
   - Adding dashboard counts
   - Adding quick filters
   - Testing status behavior

2. **Status Philosophy:** Message statuses indicate workflow state, not finality. "Closed" means "has response," not "conversation ended."

3. **Quick Filters:** Essential for UKNF employees to manage high message volumes. "Requires UKNF responses" = work queue.

4. **Dashboard Integration:** Message counts widget should integrate into existing dashboard layout (home page).

5. **Real-time Updates:** Consider SignalR for real-time count updates when new messages arrive (future enhancement).

6. **Notification Integration:** Unread count in navigation badge helps users stay aware of new messages.

7. **Historical Access:** Closed messages fully accessible for audit trail and reference.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 5, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

