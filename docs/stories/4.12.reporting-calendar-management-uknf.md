# Story 4.12: Reporting Calendar Management (UKNF)

**Epic:** 4 - Reporting System  
**Story Number:** 4.12  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** UKNF Employee,  
**I want to** configure reporting calendar deadlines and monitor compliance,  
**So that** I can track which entities have submitted required reports.

---

## Acceptance Criteria

**Source:** `docs/prd/epic-4-reporting-system.md` - Story 4.12

1. UKNF Employee can create reporting periods with: Report type, Reporting period name, Due date, Applicable entities (all or specific types)
2. Employee can view compliance dashboard showing submission progress
3. Dashboard displays: Total entities required to submit, Submitted count, Not submitted count, Percentage complete
4. Employee can view list of entities that haven't submitted for a specific period
5. Employee can send reminder messages to non-submitting entities (integration with Epic 5)
6. Employee can generate and send message to all non-submitters at once
7. Employee can export compliance report (CSV or Excel)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create CreateReportingPeriodCommand** (AC: 1)
  - [ ] Create `CreateReportingPeriodCommand.cs` in `Application/UknfPlatform.Application.Communication/ReportingPeriods/Commands/`
  - [ ] Command properties (from AC 1):
    - ReportType (string, required) - e.g., "Quarterly"
    - PeriodName (string, required) - e.g., "Q1_2025"
    - DueDate (DateTime, required)
    - ApplicableToAllEntities (bool, default: true)
    - ApplicableEntityTypes (List<string>?, optional) - specific entity types if not all

- [ ] **Task 2: Create CreateReportingPeriodCommandValidator** (AC: 1)
  - [ ] Create `CreateReportingPeriodCommandValidator.cs` using FluentValidation
  - [ ] Validate ReportType: NotEmpty, MaxLength(250)
  - [ ] Validate PeriodName: NotEmpty, MaxLength(100), Pattern validation (e.g., "Q1_2025")
  - [ ] Validate DueDate: Must be future date
  - [ ] Validate ApplicableEntityTypes: If ApplicableToAllEntities = false, list must not be empty
  - [ ] Async validation: Check uniqueness (ReportType + PeriodName combination)

- [ ] **Task 3: Create CreateReportingPeriodCommandHandler** (AC: 1)
  - [ ] Create `CreateReportingPeriodCommandHandler.cs` implementing `IRequestHandler<CreateReportingPeriodCommand, CreateReportingPeriodResponse>`
  - [ ] Inject: IReportingPeriodRepository, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Verify user is UKNF employee
    - Verify uniqueness (ReportType + PeriodName)
    - Create ReportingPeriod entity
    - Set ApplicableEntityTypes as JSON if specified
    - Set CreatedByUserId
    - Save to repository
    - Return CreateReportingPeriodResponse with period ID
  - [ ] Use transaction

- [ ] **Task 4: Create GetComplianceDashboardQuery** (AC: 2, 3, 4)
  - [ ] Create `GetComplianceDashboardQuery.cs` in `Application/UknfPlatform.Application.Communication/ReportingPeriods/Queries/`
  - [ ] Query properties:
    - ReportingPeriodId (Guid?, optional) - specific period or all active periods

- [ ] **Task 5: Create GetComplianceDashboardQueryHandler** (AC: 2, 3, 4)
  - [ ] Create `GetComplianceDashboardQueryHandler.cs` implementing `IRequestHandler<GetComplianceDashboardQuery, ComplianceDashboardResponse>`
  - [ ] Inject: IReportingPeriodRepository, IReportRepository, IEntityRepository, ILogger
  - [ ] Handler logic:
    - Fetch reporting period(s)
    - For each period:
      * Determine applicable entities (all or filtered by entity types)
      * Count total entities required to submit (AC 3)
      * Query reports submitted for this period (match ReportType and ReportingPeriod)
      * Count submitted entities (AC 3)
      * Calculate not submitted count (AC 3)
      * Calculate percentage complete (AC 3)
      * Get list of non-submitting entities (AC 4)
    - Return ComplianceDashboardResponse

- [ ] **Task 6: Create ComplianceDashboardResponse DTO** (AC: 2, 3, 4)
  - [ ] Create `ComplianceDashboardResponse.cs` record
  - [ ] Properties:
    - Periods (List<CompliancePeriodDto>)
  - [ ] CompliancePeriodDto properties (from AC 3):
    - ReportingPeriodId (Guid)
    - ReportType (string)
    - PeriodName (string)
    - DueDate (DateTime)
    - TotalEntitiesRequired (int) - AC 3
    - SubmittedCount (int) - AC 3
    - NotSubmittedCount (int) - AC 3
    - PercentageComplete (decimal) - AC 3
    - NonSubmittingEntities (List<EntitySummaryDto>) - AC 4

- [ ] **Task 7: Create SendReminderCommand** (AC: 5)
  - [ ] Create `SendReminderCommand.cs`
  - [ ] Command properties:
    - ReportingPeriodId (Guid)
    - EntityIds (List<long>) - specific entities to remind
    - MessageSubject (string, optional) - custom subject
    - MessageBody (string, optional) - custom body
  - [ ] Note: Integration with Epic 5 messaging

- [ ] **Task 8: Create SendBulkReminderCommand** (AC: 6)
  - [ ] Create `SendBulkReminderCommand.cs`
  - [ ] Command properties:
    - ReportingPeriodId (Guid)
    - SendToAllNonSubmitters (bool, default: true)
    - MessageSubject (string, optional)
    - MessageBody (string, optional)
  - [ ] Handler: Send reminder to all entities that haven't submitted

- [ ] **Task 9: Implement reminder email sending** (AC: 5, 6)
  - [ ] Create `SendReminderCommandHandler.cs`
  - [ ] Handler logic:
    - Fetch reporting period
    - Fetch entities (specific or all non-submitters)
    - For each entity:
      * Get entity contacts/representatives
      * Send email reminder
      * Log reminder sent
    - Return count of reminders sent
  - [ ] Default reminder template:
    - Subject: "Reminder: [ReportType] Report Due [DueDate]"
    - Body: Template with period details, due date, submission link

- [ ] **Task 10: Create ExportComplianceReportQuery** (AC: 7)
  - [ ] Create `ExportComplianceReportQuery.cs`
  - [ ] Query properties:
    - ReportingPeriodId (Guid)
    - Format (string) - "csv" or "excel"

- [ ] **Task 11: Create ExportComplianceReportQueryHandler** (AC: 7)
  - [ ] Create `ExportComplianceReportQueryHandler.cs`
  - [ ] Handler logic:
    - Fetch compliance data for period
    - Generate CSV or Excel file
    - Columns: Entity Name, Entity Type, UKNF Code, Submission Status, Submitted Date, Validation Status
    - Return file as byte array

- [ ] **Task 12: Create REST API endpoint POST /api/admin/reporting-periods** (AC: 1)
  - [ ] Create `ReportingPeriodsController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize]` + UKNF employee check
  - [ ] Create POST action `CreateReportingPeriodAsync([FromBody] CreateReportingPeriodCommand command)`
  - [ ] Return 201 Created with CreateReportingPeriodResponse
  - [ ] Return 400 if validation fails or duplicate
  - [ ] Add Swagger annotations

- [ ] **Task 13: Create REST API endpoint GET /api/admin/reporting-periods/compliance** (AC: 2, 3, 4)
  - [ ] Create GET action `GetComplianceDashboardAsync([FromQuery] GetComplianceDashboardQuery query)`
  - [ ] Return 200 OK with ComplianceDashboardResponse
  - [ ] Support filtering by specific period

- [ ] **Task 14: Create REST API endpoint POST /api/admin/reporting-periods/{id}/send-reminder** (AC: 5)
  - [ ] Create POST action `SendReminderAsync(Guid id, [FromBody] SendReminderRequest request)`
  - [ ] Request body:
    ```json
    {
      "entityIds": [1001, 1002],
      "messageSubject": "...",
      "messageBody": "..."
    }
    ```
  - [ ] Return 200 OK with count of reminders sent

- [ ] **Task 15: Create REST API endpoint POST /api/admin/reporting-periods/{id}/send-bulk-reminder** (AC: 6)
  - [ ] Create POST action `SendBulkReminderAsync(Guid id, [FromBody] SendBulkReminderRequest request)`
  - [ ] Request body:
    ```json
    {
      "sendToAllNonSubmitters": true,
      "messageSubject": "...",
      "messageBody": "..."
    }
    ```
  - [ ] Return 200 OK with count

- [ ] **Task 16: Create REST API endpoint GET /api/admin/reporting-periods/{id}/export** (AC: 7)
  - [ ] Create GET action `ExportComplianceReportAsync(Guid id, [FromQuery] string format)`
  - [ ] Return File result with CSV or Excel
  - [ ] Set Content-Disposition header

- [ ] **Task 17: Link reports to reporting periods** (AC: 1, 2, 3)
  - [ ] Update Report entity to include ReportingPeriodId (Guid?, nullable)
  - [ ] When report submitted, match to reporting period by ReportType and ReportingPeriod
  - [ ] Create database migration to add ReportingPeriodId to Reports table
  - [ ] Add foreign key constraint (optional, nullable)

### Frontend Tasks

- [ ] **Task 18: Create reporting periods service** (AC: 1, 5, 6, 7)
  - [ ] Create `reporting-periods.service.ts` in `core/services/`
  - [ ] Methods:
    - `createReportingPeriod(command): Observable<CreateReportingPeriodResponse>`
    - `getComplianceDashboard(periodId?): Observable<ComplianceDashboardResponse>`
    - `sendReminder(periodId, entityIds, message): Observable<SendReminderResponse>`
    - `sendBulkReminder(periodId, message): Observable<SendBulkReminderResponse>`
    - `exportComplianceReport(periodId, format): Observable<Blob>`

- [ ] **Task 19: Create reporting periods management page** (AC: 1)
  - [ ] Create `reporting-periods-management.component.ts` in `features/admin/`
  - [ ] Route: `/admin/reporting-periods`
  - [ ] Display list of reporting periods
  - [ ] Button: "Create New Period"
  - [ ] Each period row has: Report Type, Period Name, Due Date, Actions (View Compliance, Edit, Delete)

- [ ] **Task 20: Create reporting period form dialog** (AC: 1)
  - [ ] Create `create-reporting-period-dialog.component.ts`
  - [ ] Form fields (from AC 1):
    - Report Type (dropdown, required) - Quarterly, Annual, Monthly, etc.
    - Period Name (input, required) - e.g., "Q1_2025"
    - Due Date (date picker, required)
    - Applicable Entities (radio + checkboxes):
      * "All Entities" (default)
      * "Specific Entity Types" â†’ show entity type checkboxes
  - [ ] Buttons: "Create Period", "Cancel"
  - [ ] Validation: All required fields, future due date
  - [ ] Use PrimeNG Dialog, Calendar, Checkbox components

- [ ] **Task 21: Create compliance dashboard component** (AC: 2, 3, 4)
  - [ ] Create `compliance-dashboard.component.ts` in `features/admin/`
  - [ ] Route: `/admin/compliance-dashboard` or `/admin/reporting-periods/compliance`
  - [ ] Display overview cards (AC 3):
    - Total Entities Required
    - Submitted Count (green)
    - Not Submitted Count (red)
    - Percentage Complete (progress bar)
  - [ ] Use PrimeNG Card, ProgressBar components

- [ ] **Task 22: Display compliance details by period** (AC: 2, 3)
  - [ ] Show compliance data for each reporting period
  - [ ] Use accordion or tabs for multiple periods
  - [ ] Each period shows: Period name, Due date, Stats (AC 3)
  - [ ] Click period to expand details

- [ ] **Task 23: Display non-submitting entities list** (AC: 4)
  - [ ] Show table/list of entities that haven't submitted
  - [ ] Columns: Entity Name, Entity Type, UKNF Code, Contact Email
  - [ ] Actions per entity: "Send Reminder"
  - [ ] Bulk actions: "Select All", "Send Bulk Reminder"
  - [ ] Use PrimeNG Table with selection

- [ ] **Task 24: Implement send reminder action** (AC: 5)
  - [ ] "Send Reminder" button for individual entity
  - [ ] Opens reminder dialog
  - [ ] Dialog shows:
    - Entity name
    - Period details
    - Optional custom message fields (subject, body)
    - Preview of default message
  - [ ] On send, call reportingPeriodsService.sendReminder()
  - [ ] Show success message: "Reminder sent to [Entity Name]"

- [ ] **Task 25: Implement bulk reminder action** (AC: 6)
  - [ ] "Send Bulk Reminder" button
  - [ ] Opens bulk reminder dialog
  - [ ] Dialog shows:
    - Count of entities to be notified
    - List of entity names
    - Optional custom message fields
    - Preview of default message
  - [ ] Confirmation: "Send reminder to X entities?"
  - [ ] On confirm, call reportingPeriodsService.sendBulkReminder()
  - [ ] Show success message: "Reminder sent to X entities"

- [ ] **Task 26: Implement export compliance report** (AC: 7)
  - [ ] "Export" dropdown button on compliance dashboard
  - [ ] Options: "Export to CSV", "Export to Excel"
  - [ ] On click, call reportingPeriodsService.exportComplianceReport()
  - [ ] Download file: "compliance-report-[period]-[date].csv/xlsx"
  - [ ] Show success message
  - [ ] Use FileSaver or native download

- [ ] **Task 27: Create page layout** (AC: All)
  - [ ] Page title: "Reporting Calendar Management"
  - [ ] Breadcrumb: Admin > Reporting Calendar
  - [ ] Tabs:
    - "Reporting Periods" (list and create)
    - "Compliance Dashboard" (AC 2, 3, 4)
  - [ ] Use PrimeNG TabView, Card, Button components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 28: Add compliance widget to UKNF dashboard** (AC: 2, 3)
  - [ ] Add small compliance widget to UKNF employee home dashboard
  - [ ] Show high-level stats: X periods active, Y% compliance
  - [ ] Link to full compliance dashboard
  - [ ] Highlight overdue periods

### Testing Tasks

- [ ] **Task 29: Write unit tests for CreateReportingPeriodCommandHandler**
  - [ ] Test: `Handle_ValidPeriod_CreatesSuccessfully` (AC 1)
  - [ ] Test: `Handle_DuplicatePeriod_ThrowsValidationException`
  - [ ] Test: `Handle_PastDueDate_ThrowsValidationException`
  - [ ] Test: `Handle_AllEntities_SetsApplicableEntityTypesNull`
  - [ ] Test: `Handle_SpecificEntityTypes_StoresAsJson` (AC 1)
  - [ ] Mock: IReportingPeriodRepository, ICurrentUserService

- [ ] **Task 30: Write unit tests for GetComplianceDashboardQueryHandler**
  - [ ] Test: `Handle_CalculatesTotalEntitiesCorrectly` (AC 3)
  - [ ] Test: `Handle_CalculatesSubmittedCountCorrectly` (AC 3)
  - [ ] Test: `Handle_CalculatesPercentageCorrectly` (AC 3)
  - [ ] Test: `Handle_ReturnsNonSubmittingEntities` (AC 4)
  - [ ] Test: `Handle_FiltersBy EntityTypes` (AC 1)
  - [ ] Create test data: reporting periods, entities, reports

- [ ] **Task 31: Write unit tests for SendReminderCommandHandler**
  - [ ] Test: `Handle_ValidRequest_SendsReminders` (AC 5)
  - [ ] Test: `Handle_BulkReminder_SendsToAllNonSubmitters` (AC 6)
  - [ ] Test: `Handle_CustomMessage_UsesCustomTemplate`
  - [ ] Mock: IEmailService, IReportingPeriodRepository

- [ ] **Task 32: Write integration test for create reporting period**
  - [ ] Test: `POST_CreateReportingPeriod_ValidRequest_Returns201` (AC 1)
  - [ ] Test: `POST_CreateReportingPeriod_AllEntities_CreatesSuccessfully`
  - [ ] Test: `POST_CreateReportingPeriod_SpecificEntityTypes_CreatesSuccessfully`
  - [ ] Test: `POST_CreateReportingPeriod_Duplicate_Returns400`
  - [ ] Verify period created in database

- [ ] **Task 33: Write integration test for compliance dashboard**
  - [ ] Test: `GET_ComplianceDashboard_ReturnsCorrectStats` (AC 2, 3)
  - [ ] Test: `GET_ComplianceDashboard_ReturnsNonSubmittingEntities` (AC 4)
  - [ ] Create test scenario:
    - 1 reporting period
    - 10 entities (5 submitted, 5 not submitted)
    - Verify: TotalEntitiesRequired = 10, SubmittedCount = 5, NotSubmittedCount = 5, PercentageComplete = 50%

- [ ] **Task 34: Write E2E test for compliance flow**
  - [ ] Test workflow:
    1. Login as UKNF employee
    2. Navigate to Admin > Reporting Calendar
    3. Click "Create New Period" (AC 1)
    4. Fill form: Report Type, Period Name, Due Date, All Entities
    5. Save period
    6. Verify period created
    7. Navigate to Compliance Dashboard (AC 2)
    8. Verify dashboard displays stats (AC 3)
    9. Verify non-submitting entities list (AC 4)
    10. Select an entity, click "Send Reminder" (AC 5)
    11. Send reminder
    12. Click "Send Bulk Reminder" (AC 6)
    13. Confirm and send
    14. Click "Export to CSV" (AC 7)
    15. Verify file downloads
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 4.11:**
- ReportingPeriod entity defined
- External users view calendar based on reporting periods
- This story implements UKNF management of those periods

**Key Integration:**
- This story creates reporting periods
- Story 4.11 displays them to external users
- Epic 5 messaging integration for reminders (future)

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- ORM: Entity Framework Core 8.0
- CQRS: MediatR 12.4.0
- CSV/Excel: CsvHelper, ClosedXML
- Email: IEmailService

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG (TabView, Card, ProgressBar, Calendar, Checkbox, Table)
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
â”œâ”€â”€ Api/UknfPlatform.Api/Controllers/
â”‚   â””â”€â”€ ReportingPeriodsController.cs (CREATE)
â”œâ”€â”€ Application/UknfPlatform.Application.Communication/ReportingPeriods/
â”‚   â”œâ”€â”€ Commands/
â”‚   â”‚   â”œâ”€â”€ CreateReportingPeriodCommand.cs (CREATE)
â”‚   â”‚   â”œâ”€â”€ CreateReportingPeriodCommandHandler.cs (CREATE)
â”‚   â”‚   â”œâ”€â”€ SendReminderCommand.cs (CREATE)
â”‚   â”‚   â”œâ”€â”€ SendReminderCommandHandler.cs (CREATE)
â”‚   â”‚   â”œâ”€â”€ SendBulkReminderCommand.cs (CREATE)
â”‚   â”‚   â””â”€â”€ SendBulkReminderCommandHandler.cs (CREATE)
â”‚   â”œâ”€â”€ Queries/
â”‚   â”‚   â”œâ”€â”€ GetComplianceDashboardQuery.cs (CREATE)
â”‚   â”‚   â”œâ”€â”€ GetComplianceDashboardQueryHandler.cs (CREATE)
â”‚   â”‚   â”œâ”€â”€ ExportComplianceReportQuery.cs (CREATE)
â”‚   â”‚   â””â”€â”€ ExportComplianceReportQueryHandler.cs (CREATE)
â”‚   â””â”€â”€ DTOs/
â”‚       â”œâ”€â”€ CreateReportingPeriodResponse.cs (CREATE)
â”‚       â”œâ”€â”€ ComplianceDashboardResponse.cs (CREATE)
â”‚       â””â”€â”€ CompliancePeriodDto.cs (CREATE)
â””â”€â”€ Domain/UknfPlatform.Domain.Communication/Entities/
    â””â”€â”€ Report.cs (UPDATE - add ReportingPeriodId FK)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
â”œâ”€â”€ core/services/
â”‚   â””â”€â”€ reporting-periods.service.ts (CREATE)
â””â”€â”€ features/admin/
    â”œâ”€â”€ reporting-periods-management/
    â”‚   â”œâ”€â”€ reporting-periods-management.component.ts (CREATE)
    â”‚   â””â”€â”€ components/
    â”‚       â”œâ”€â”€ create-reporting-period-dialog.component.ts (CREATE)
    â”‚       â””â”€â”€ compliance-dashboard.component.ts (CREATE)
    â””â”€â”€ dashboard/
        â””â”€â”€ compliance-widget.component.ts (CREATE)
```

### Data Models

**ReportingPeriod Entity (from Story 4.11):**
- Properties defined in Story 4.11
- ApplicableEntityTypes as JSON array

**Report Entity Update:**
- Add ReportingPeriodId (Guid?, nullable)
- Foreign key to ReportingPeriods table
- Used for compliance tracking

### REST API Specification

**Endpoint 1:** POST `/api/admin/reporting-periods`
- **Security:** UKNF employees only
- **Request:**
  ```json
  {
    "reportType": "Quarterly",
    "periodName": "Q1_2025",
    "dueDate": "2025-04-15T23:59:59Z",
    "applicableToAllEntities": true,
    "applicableEntityTypes": null
  }
  ```
- **Response (201 Created):**
  ```json
  {
    "reportingPeriodId": "guid",
    "reportType": "Quarterly",
    "periodName": "Q1_2025",
    "dueDate": "2025-04-15T23:59:59Z"
  }
  ```

**Endpoint 2:** GET `/api/admin/reporting-periods/compliance?periodId=guid`
- **Security:** UKNF employees only
- **Response (200 OK):**
  ```json
  {
    "periods": [
      {
        "reportingPeriodId": "guid",
        "reportType": "Quarterly",
        "periodName": "Q1_2025",
        "dueDate": "2025-04-15T23:59:59Z",
        "totalEntitiesRequired": 150,
        "submittedCount": 120,
        "notSubmittedCount": 30,
        "percentageComplete": 80.0,
        "nonSubmittingEntities": [
          {
            "entityId": 1001,
            "entityName": "Example Bank",
            "entityType": "Bank",
            "uknfCode": "G. RIP100000",
            "contactEmail": "reports@example.com"
          }
        ]
      }
    ]
  }
  ```

**Endpoint 3:** POST `/api/admin/reporting-periods/{id}/send-bulk-reminder`
- **Security:** UKNF employees only
- **Response (200 OK):**
  ```json
  {
    "remindersSent": 30,
    "message": "Reminder sent to 30 entities"
  }
  ```

**Endpoint 4:** GET `/api/admin/reporting-periods/{id}/export?format=csv`
- **Security:** UKNF employees only
- Returns CSV or Excel file

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Determine applicable entities (AC 1)**
   ```csharp
   // âœ… CORRECT
   IQueryable<Entity> query = _context.Entities.Where(e => e.IsActive);
   
   if (!string.IsNullOrEmpty(period.ApplicableEntityTypes))
   {
       var types = JsonSerializer.Deserialize<string[]>(period.ApplicableEntityTypes);
       query = query.Where(e => types.Contains(e.EntityType));
   }
   
   var applicableEntities = await query.ToListAsync();
   ```

2. **Calculate compliance percentage (AC 3)**
   ```csharp
   // âœ… CORRECT
   var totalRequired = applicableEntities.Count;
   var submittedCount = applicableEntities.Count(e => 
       _context.Reports.Any(r => 
           r.EntityId == e.Id && 
           r.ReportingPeriodId == period.Id));
   
   var percentageComplete = totalRequired > 0 
       ? (decimal)submittedCount / totalRequired * 100 
       : 0;
   ```

3. **Link reports to periods**
   ```csharp
   // âœ… CORRECT - On report submission, match to period
   var matchingPeriod = await _context.ReportingPeriods
       .Where(p => p.ReportType == report.ReportType && 
                   p.PeriodName == report.ReportingPeriod &&
                   p.IsActive)
       .FirstOrDefaultAsync();
   
   if (matchingPeriod != null)
       report.ReportingPeriodId = matchingPeriod.Id;
   ```

4. **Send bulk reminders (AC 6)**
   ```csharp
   // âœ… CORRECT
   var nonSubmitters = await GetNonSubmittingEntitiesAsync(periodId);
   
   foreach (var entity in nonSubmitters)
   {
       await _emailService.SendAsync(new Email
       {
           To = entity.ContactEmail,
           Subject = $"Reminder: {period.ReportType} Report Due {period.DueDate:yyyy-MM-dd}",
           Body = GenerateReminderBody(period, entity)
       });
   }
   ```

5. **Export compliance data (AC 7)**
   ```csharp
   // âœ… CORRECT - Use CSV or Excel library
   using var writer = new StringWriter();
   using var csv = new CsvWriter(writer, CultureInfo.InvariantCulture);
   
   csv.WriteRecords(complianceData);
   return Encoding.UTF8.GetBytes(writer.ToString());
   ```

### UI/UX Considerations

**Compliance Dashboard Cards:**
```html
<div class="grid grid-cols-4 gap-4">
  <p-card>
    <h3>Total Entities</h3>
    <div class="text-4xl font-bold">{{ complianceData.totalEntitiesRequired }}</div>
  </p-card>
  
  <p-card styleClass="border-l-4 border-green-500">
    <h3>Submitted</h3>
    <div class="text-4xl font-bold text-green-600">{{ complianceData.submittedCount }}</div>
  </p-card>
  
  <p-card styleClass="border-l-4 border-red-500">
    <h3>Not Submitted</h3>
    <div class="text-4xl font-bold text-red-600">{{ complianceData.notSubmittedCount }}</div>
  </p-card>
  
  <p-card>
    <h3>Completion</h3>
    <div class="text-4xl font-bold">{{ complianceData.percentageComplete | number:'1.1-1' }}%</div>
    <p-progressBar [value]="complianceData.percentageComplete"></p-progressBar>
  </p-card>
</div>
```

**Non-Submitting Entities Table:**
```html
<p-table [value]="nonSubmittingEntities" [(selection)]="selectedEntities" dataKey="entityId">
  <ng-template pTemplate="header">
    <tr>
      <th><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
      <th>Entity Name</th>
      <th>Entity Type</th>
      <th>UKNF Code</th>
      <th>Contact Email</th>
      <th>Actions</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-entity>
    <tr>
      <td><p-tableCheckbox [value]="entity"></p-tableCheckbox></td>
      <td>{{ entity.entityName }}</td>
      <td>{{ entity.entityType }}</td>
      <td>{{ entity.uknfCode }}</td>
      <td>{{ entity.contactEmail }}</td>
      <td>
        <button pButton icon="pi pi-send" label="Send Reminder" (click)="sendReminder(entity)"></button>
      </td>
    </tr>
  </ng-template>
</p-table>

<button pButton 
        label="Send Bulk Reminder to Selected" 
        icon="pi pi-send" 
        [disabled]="selectedEntities.length === 0"
        (click)="sendBulkReminder()">
</button>
```

### Business Rules

**Applicable Entities (AC 1):**
- If ApplicableToAllEntities = true: All active entities must submit
- If ApplicableEntityTypes specified: Only entities of those types must submit
- Examples: "Banks", "Insurance Companies", "Investment Funds"

**Compliance Calculation (AC 3):**
- Total = Count of applicable entities
- Submitted = Count with report linked to this period
- Not Submitted = Total - Submitted
- Percentage = (Submitted / Total) Ã— 100

**Report-Period Linking:**
- On report submission, system matches ReportType and PeriodName to find period
- If match found, set Report.ReportingPeriodId
- Used for compliance tracking

### Security Requirements

- Only UKNF employees can create reporting periods
- Only UKNF employees can view compliance dashboard
- Only UKNF employees can send reminders
- External users cannot access these features

### Performance Considerations

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#3-performance-and-scalability`

- Compliance calculations may be expensive with many entities
- Consider caching compliance stats (refresh every hour)
- Bulk reminder sending should be async (background job)
- Export limited to reasonable number of records

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Key test scenarios:**
- Create reporting period with all entities
- Create reporting period with specific entity types
- Calculate compliance stats correctly
- Return non-submitting entities list
- Send individual reminder
- Send bulk reminder
- Export compliance report

**Example:**
```csharp
[Fact]
public async Task Handle_CalculatesComplianceCorrectly()
{
    // Arrange - AC 3
    var period = CreateTestReportingPeriod();
    var entities = CreateTestEntities(count: 10); // 10 total entities
    var reports = CreateTestReportsForEntities(entities.Take(7), period.Id); // 7 submitted
    
    await _context.ReportingPeriods.AddAsync(period);
    await _context.Entities.AddRangeAsync(entities);
    await _context.Reports.AddRangeAsync(reports);
    await _context.SaveChangesAsync();
    
    var query = new GetComplianceDashboardQuery { ReportingPeriodId = period.Id };
    
    // Act
    var result = await _handler.Handle(query, CancellationToken.None);
    
    // Assert
    result.Periods[0].TotalEntitiesRequired.Should().Be(10);
    result.Periods[0].SubmittedCount.Should().Be(7);
    result.Periods[0].NotSubmittedCount.Should().Be(3);
    result.Periods[0].PercentageComplete.Should().Be(70.0m);
    result.Periods[0].NonSubmittingEntities.Should().HaveCount(3);
}
```

### Additional Notes

1. **Epic 5 Integration (AC 5):** Reminder feature can integrate with Epic 5 messaging for more sophisticated communication. For MVP, email is sufficient.

2. **Automatic Period Creation:** Future enhancement: Auto-create recurring periods (e.g., quarterly periods for entire year).

3. **Deadline Extensions:** Future: UKNF can extend deadlines for specific entities or all entities.

4. **Historical Compliance:** Track compliance over time to identify patterns (which entities consistently late).

5. **Compliance Reports:** Export shows snapshot at time of export. Historical exports useful for audit.

6. **Entity Types:** Common entity types: Banks, Insurance Companies, Investment Funds, Loan Institutions, etc.

7. **Reminder Frequency:** Limit reminder frequency to prevent spam (e.g., max 1 reminder per entity per day).

8. **Dashboard Refresh:** Compliance stats updated real-time when reports submitted (or cached with periodic refresh).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 4, strictly following PRD AC | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

