# Story 1.5: Basic User Profile Management

**Epic:** 1 - Authentication & User Registration  
**Story Number:** 1.5  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** authenticated external user,  
**I want to** view and update my basic profile information,  
**So that** my contact details remain current in the system.

---

## Acceptance Criteria

1. User can view their profile information (First name, Last name, PESEL (masked), phone, email)
2. User can update phone number and email address
3. Email changes require confirmation via new email address
4. PESEL cannot be modified (immutable after registration)
5. System validates phone and email format on update
6. Changes are logged with timestamp and user ID (audit trail)
7. User receives confirmation after successful profile update

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create GetUserProfileQuery and Handler** (AC: 1)
  - [ ] Create `GetUserProfileQuery.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Queries/`
  - [ ] Query property: UserId (from authenticated user)
  - [ ] Create `GetUserProfileQueryHandler.cs`
  - [ ] Handler logic:
    - Get authenticated user ID from context
    - Retrieve user from repository
    - Map to UserProfileDto (exclude sensitive data)
    - Return profile information
  - [ ] Use Mapster for entity to DTO mapping

- [ ] **Task 2: Create UpdateUserProfileCommand and Handler** (AC: 2, 3, 5, 6, 7)
  - [ ] Create `UpdateUserProfileCommand.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] Command properties: FirstName, LastName, PhoneNumber, Email (new email)
  - [ ] Create `UpdateUserProfileCommandHandler.cs`
  - [ ] Handler logic:
    - Get authenticated user
    - Check if email changed
    - If email changed:
      - Validate new email not already used
      - Generate email confirmation token
      - Send confirmation email to new address
      - Set user.PendingEmail field
      - Don't update email immediately (wait for confirmation)
    - Update FirstName, LastName if changed
    - Update PhoneNumber if changed and valid
    - PESEL cannot be updated (validation prevents this)
    - Save changes
    - Log profile update with changed fields
    - Return success response
  - [ ] Inject: IUserRepository, IEmailService, ILogger

- [ ] **Task 3: Create FluentValidation validator for UpdateUserProfileCommand** (AC: 5)
  - [ ] Create `UpdateUserProfileCommandValidator.cs`
  - [ ] Validate FirstName: NotEmpty, MaxLength(100)
  - [ ] Validate LastName: NotEmpty, MaxLength(100)
  - [ ] Validate PhoneNumber: Matches regex `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate Email: EmailAddress format, MaxLength(256)
  - [ ] PESEL field should not be included in command (immutable)

- [ ] **Task 4: Create email confirmation for email change** (AC: 3)
  - [ ] Add PendingEmail field to User entity (nullable)
  - [ ] Create EmailChangeToken entity similar to ActivationToken
  - [ ] Properties: Id, UserId, NewEmail, Token, ExpiresAt (24 hours), IsUsed, CreatedDate
  - [ ] Create EF Core configuration and migration
  - [ ] Generate secure token when email change requested
  - [ ] Send confirmation email to NEW email address with confirmation link
  - [ ] Email template: "Confirm your new email address"

- [ ] **Task 5: Create ConfirmEmailChangeCommand and Handler** (AC: 3)
  - [ ] Create `ConfirmEmailChangeCommand.cs`
  - [ ] Command property: Token (string)
  - [ ] Create `ConfirmEmailChangeCommandHandler.cs`
  - [ ] Handler logic:
    - Validate token exists and not expired/used
    - Get user and new email from token
    - Verify new email still not in use
    - Update user.Email = user.PendingEmail
    - Clear user.PendingEmail
    - Mark token as used
    - Log email change
    - Return success
  - [ ] Inject: IEmailChangeTokenRepository, IUserRepository

- [ ] **Task 6: Create UserProfileDto** (AC: 1)
  - [ ] Create `UserProfileDto.cs` record
  - [ ] Properties: UserId, FirstName, LastName, Email, PendingEmail (if email change in progress), PhoneNumber, PeselLast4 (masked), UserType, CreatedDate, LastLoginDate
  - [ ] Do NOT include: PasswordHash, full PESEL

- [ ] **Task 7: Create UpdateUserProfileResponse DTO** (AC: 7)
  - [ ] Create `UpdateUserProfileResponse.cs` record
  - [ ] Properties: Success (bool), Message (string), EmailChangeRequiresConfirmation (bool), UpdatedProfile (UserProfileDto)

- [ ] **Task 8: Create REST API endpoint GET /auth/profile** (AC: 1)
  - [ ] Add action to `AuthController.cs`: `GetProfileAsync()`
  - [ ] `[Authorize]` attribute (requires authentication)
  - [ ] Send GetUserProfileQuery via MediatR
  - [ ] Return 200 OK with UserProfileDto
  - [ ] Add Swagger documentation

- [ ] **Task 9: Create REST API endpoint PUT /auth/profile** (AC: 2, 5, 7)
  - [ ] Add action to `AuthController.cs`: `UpdateProfileAsync(UpdateUserProfileCommand command)`
  - [ ] `[Authorize]` attribute
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with UpdateUserProfileResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 409 Conflict if new email already exists
  - [ ] Success message includes note if email confirmation required
  - [ ] Add Swagger documentation

- [ ] **Task 10: Create REST API endpoint GET /auth/confirm-email-change** (AC: 3)
  - [ ] Add action: `ConfirmEmailChangeAsync(string token)`
  - [ ] `[AllowAnonymous]` attribute (user clicks link in email)
  - [ ] Send ConfirmEmailChangeCommand via MediatR
  - [ ] Return 200 OK with success message
  - [ ] Return 400 Bad Request if token invalid/expired
  - [ ] Return 409 Conflict if new email now taken by someone else
  - [ ] Add Swagger documentation

- [ ] **Task 11: Update User entity** (AC: 3, 4)
  - [ ] Add PendingEmail field (nullable string)
  - [ ] Ensure PESEL fields (PeselEncrypted, PeselLast4) are not modifiable after creation
  - [ ] Add domain method UpdateProfile(firstName, lastName, phone) for encapsulation
  - [ ] Add domain method RequestEmailChange(newEmail) to set PendingEmail
  - [ ] Add domain method ConfirmEmailChange() to apply pending email
  - [ ] Create/update EF Core migration

- [ ] **Task 12: Create audit logging for profile changes** (AC: 6)
  - [ ] Log in UpdateUserProfileCommandHandler
  - [ ] Include: UserId, Timestamp, ChangedFields (JSON), OldValues (JSON), NewValues (JSON)
  - [ ] Use existing AuditLog infrastructure or create ProfileChangeLog entity
  - [ ] Log email confirmation separately

### Frontend Tasks

- [ ] **Task 13: Create user profile page component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/profile/profile.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/profile` (requires authentication)
  - [ ] Apply auth guard to route

- [ ] **Task 14: Fetch and display user profile** (AC: 1)
  - [ ] On component init, call authService.getProfile() or create profileService
  - [ ] Display profile information in card layout:
    - First name, Last name
    - Email (with "Pending: newEmail" if email change in progress)
    - Phone number
    - PESEL (masked, last 4 digits)
    - User type
    - Account created date
    - Last login date
  - [ ] Read-only fields for PESEL and account info
  - [ ] Editable fields for First name, Last name, Phone, Email

- [ ] **Task 15: Create profile edit form** (AC: 2, 5)
  - [ ] Create reactive form with FormBuilder
  - [ ] Form fields:
    - firstName (text input, required, maxLength 100)
    - lastName (text input, required, maxLength 100)
    - phoneNumber (text input, required, phone pattern)
    - email (email input, required, email format)
  - [ ] PESEL field: display-only (disabled input or just text)
  - [ ] Add validators matching backend requirements
  - [ ] "Edit" button to enable editing mode
  - [ ] "Save" and "Cancel" buttons in edit mode

- [ ] **Task 16: Add profile methods to AuthService or create ProfileService** (AC: 1, 2)
  - [ ] Add method `getProfile(): Observable<UserProfileDto>`
  - [ ] Call GET `/api/auth/profile`
  - [ ] Add method `updateProfile(profile): Observable<UpdateProfileResponse>`
  - [ ] Call PUT `/api/auth/profile`
  - [ ] Handle errors with catchError

- [ ] **Task 17: Implement form submission logic** (AC: 2, 3, 7)
  - [ ] On form submit:
    - Show loading spinner
    - Call authService/profileService.updateProfile()
    - On success (200):
      - If email change: Show message "Confirmation email sent to new address. Please check your email."
      - If no email change: Show success toast "Profile updated successfully"
      - Update displayed profile with new data
      - Exit edit mode
    - On error (400):
      - Display validation errors
    - On error (409):
      - Display "Email already in use by another account"
  - [ ] Disable submit button while loading or form invalid

- [ ] **Task 18: Create email change confirmation page** (AC: 3)
  - [ ] Create `email-change-confirm.component.ts`
  - [ ] Route: `/auth/confirm-email-change?token={token}`
  - [ ] Extract token from query parameters on init
  - [ ] Auto-call confirmation API
  - [ ] Show loading, success, or error states
  - [ ] Success: "Email changed successfully! You can now log in with your new email."
  - [ ] Error: "Confirmation link invalid or expired"
  - [ ] Provide button to go to profile or login

- [ ] **Task 19: Create profile page UI** (AC: 1, 2)
  - [ ] Use main layout (with navigation)
  - [ ] Page title: "My Profile"
  - [ ] Profile card with PrimeNG Card component
  - [ ] Two modes: View mode and Edit mode
  - [ ] View mode:
    - Display all profile fields as text
    - "Edit Profile" button
  - [ ] Edit mode:
    - Form inputs for editable fields
    - Read-only display for PESEL
    - "Save Changes" and "Cancel" buttons
  - [ ] Email change notice if pending
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 20: Update navigation to include profile link** (AC: 1)
  - [ ] Add "Profile" or "My Account" link in main navigation or user menu
  - [ ] Show user's name in header with dropdown to profile
  - [ ] Icon: user avatar or initials

### Testing Tasks

- [ ] **Task 21: Write unit tests for GetUserProfileQueryHandler** (AC: 1)
  - [ ] Test: `Handle_AuthenticatedUser_ReturnsProfile`
  - [ ] Test: `Handle_UserNotFound_ThrowsNotFoundException`
  - [ ] Verify PESEL is masked in response
  - [ ] Mock: IUserRepository

- [ ] **Task 22: Write unit tests for UpdateUserProfileCommandHandler** (AC: 2, 3, 5, 6)
  - [ ] Test: `Handle_UpdateBasicFields_UpdatesSuccessfully`
  - [ ] Test: `Handle_EmailChange_GeneratesConfirmationToken`
  - [ ] Test: `Handle_EmailChange_SendsConfirmationEmail`
  - [ ] Test: `Handle_EmailChange_SetsPendingEmail`
  - [ ] Test: `Handle_DuplicateEmail_ThrowsConflictException`
  - [ ] Test: `Handle_InvalidPhoneNumber_ThrowsValidationException`
  - [ ] Test: `Handle_ProfileUpdate_LogsChanges`
  - [ ] Mock: IUserRepository, IEmailService, IEmailChangeTokenRepository, ILogger

- [ ] **Task 23: Write unit tests for ConfirmEmailChangeCommandHandler** (AC: 3)
  - [ ] Test: `Handle_ValidToken_ChangesEmail`
  - [ ] Test: `Handle_ExpiredToken_ThrowsException`
  - [ ] Test: `Handle_UsedToken_ThrowsException`
  - [ ] Test: `Handle_EmailNowTaken_ThrowsConflictException`
  - [ ] Mock: IEmailChangeTokenRepository, IUserRepository

- [ ] **Task 24: Write integration tests for profile management** (AC: All)
  - [ ] Test: `GET_Profile_AuthenticatedUser_Returns200WithProfile`
  - [ ] Test: `GET_Profile_Unauthenticated_Returns401`
  - [ ] Test: `PUT_Profile_UpdateName_Returns200`
  - [ ] Test: `PUT_Profile_ChangeEmail_SendsConfirmationEmail`
  - [ ] Test: `GET_ConfirmEmailChange_ValidToken_ChangesEmail`
  - [ ] Test: `PUT_Profile_CannotUpdatePESEL` (ensure PESEL field not accepted)
  - [ ] Use Testcontainers for database
  - [ ] Verify audit logs created

- [ ] **Task 25: Write E2E test for profile update**
  - [ ] Test workflow:
    1. Login as user
    2. Navigate to profile page
    3. Click Edit button
    4. Change name and phone
    5. Save changes
    6. Verify success message
    7. Verify changes reflected in profile
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 1.1:**
- User entity created with FirstName, LastName, Email, Phone, PESEL fields
- PESEL is encrypted (PeselEncrypted) with last 4 digits stored separately (PeselLast4)

**From Story 1.4:**
- User authentication complete
- JWT tokens contain user claims
- Authenticated user context available

**Key Integration:**
- Profile management requires authentication (Story 1.4)
- Email change uses similar pattern to account activation (Story 1.2)
- Audit logging infrastructure established

### Architecture Context

**Tech Stack (same as previous stories):**
- Backend: C# 12.0, .NET 8.0, ASP.NET Core, EF Core
- Frontend: Angular 20, PrimeNG, Tailwind CSS
- Authentication: JWT (from Story 1.4)

### Project Structure

Backend files:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AuthController.cs (UPDATE: add profile endpoints)
├── Application/UknfPlatform.Application.Auth/Authentication/
│   ├── Queries/
│   │   ├── GetUserProfileQuery.cs (CREATE)
│   │   └── GetUserProfileQueryHandler.cs (CREATE)
│   ├── Commands/
│   │   ├── UpdateUserProfileCommand.cs (CREATE)
│   │   ├── UpdateUserProfileCommandHandler.cs (CREATE)
│   │   ├── ConfirmEmailChangeCommand.cs (CREATE)
│   │   └── ConfirmEmailChangeCommandHandler.cs (CREATE)
│   └── DTOs/
│       ├── UserProfileDto.cs (CREATE)
│       └── UpdateUserProfileResponse.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/
│   └── Entities/
│       ├── User.cs (UPDATE: add PendingEmail, domain methods)
│       └── EmailChangeToken.cs (CREATE)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/
│   ├── Configurations/
│   │   └── EmailChangeTokenConfiguration.cs (CREATE)
│   └── Repositories/
│       └── EmailChangeTokenRepository.cs (CREATE)
```

Frontend files:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   ├── auth.service.ts (UPDATE: add getProfile, updateProfile)
│   └── profile.service.ts (CREATE - optional separate service)
├── features/profile/
│   ├── profile.component.ts (CREATE)
│   ├── profile.component.html (CREATE)
│   └── profile.component.scss (CREATE)
├── features/auth/email-change-confirm/
│   ├── email-change-confirm.component.ts (CREATE)
│   └── ...
```

### Data Models

**Update Users Table:**
```sql
ALTER TABLE Users
ADD PendingEmail NVARCHAR(256) NULL;
```

**EmailChangeTokens Table:**
```sql
CREATE TABLE EmailChangeTokens (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    UserId UUID NOT NULL,
    NewEmail NVARCHAR(256) NOT NULL,
    Token NVARCHAR(500) NOT NULL UNIQUE,
    ExpiresAt DATETIME2 NOT NULL,
    IsUsed BIT NOT NULL DEFAULT 0,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    INDEX IX_EmailChangeTokens_Token (Token),
    INDEX IX_EmailChangeTokens_UserId (UserId)
);
```

### REST API Specification

**Endpoint 1:** GET `/api/auth/profile`
- **Security:** Requires authentication
- **Success (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "firstName": "Jan",
    "lastName": "Kowalski",
    "email": "jan.kowalski@example.com",
    "pendingEmail": "jan.new@example.com",
    "phoneNumber": "+48123456789",
    "peselLast4": "8901",
    "userType": "External",
    "createdDate": "2025-01-15T10:30:00Z",
    "lastLoginDate": "2025-10-04T08:15:00Z"
  }
  ```

**Endpoint 2:** PUT `/api/auth/profile`
- **Security:** Requires authentication
- **Request:**
  ```json
  {
    "firstName": "Jan",
    "lastName": "Kowalski",
    "phoneNumber": "+48123456789",
    "email": "jan.new@example.com"
  }
  ```
- **Success (200 OK):**
  ```json
  {
    "success": true,
    "message": "Profile updated successfully. Please check your email to confirm your new email address.",
    "emailChangeRequiresConfirmation": true,
    "updatedProfile": { /* UserProfileDto */ }
  }
  ```
- **Errors:**
  - 400: Validation errors
  - 409: Email already exists

**Endpoint 3:** GET `/api/auth/confirm-email-change?token={token}`
- **Security:** None (public, validated by token)
- **Success (200 OK):**
  ```json
  {
    "message": "Email changed successfully!"
  }
  ```

### Email Change Flow

1. User updates email in profile form
2. Backend:
   - Validates new email not in use
   - Sets user.PendingEmail = new email
   - Generates EmailChangeToken
   - Sends confirmation email to NEW email address
   - Returns success with "confirmation required" flag
3. User clicks link in NEW email
4. Backend:
   - Validates token
   - Updates user.Email = user.PendingEmail
   - Clears user.PendingEmail
   - Marks token as used
5. User can now login with new email

### Coding Standards (Key Points)

1. **PESEL Immutability:**
   ```csharp
   // ✅ CORRECT - PESEL cannot be updated
   // Do NOT include PESEL in UpdateUserProfileCommand
   // User entity should not allow PESEL modification
   ```

2. **Email Change Security:**
   ```csharp
   // ✅ CORRECT - Send confirmation to NEW email
   await _emailService.SendEmailChangeConfirmationAsync(
       command.Email, // NEW email
       user.FirstName,
       confirmationUrl);
   ```

3. **Audit Logging:**
   ```csharp
   // ✅ CORRECT - Log what changed
   _logger.LogInformation(
       "Profile updated for user {UserId}. Changed fields: {ChangedFields}",
       userId,
       string.Join(", ", changedFields));
   ```

4. **Display PESEL Masked:**
   ```csharp
   // ✅ CORRECT - Only last 4 digits
   PeselLast4 = user.PeselLast4 // e.g., "8901"
   // NEVER return full PESEL in API
   ```

### Security Requirements

1. **Authentication Required:** All profile endpoints require valid JWT
2. **Authorization:** User can only view/edit their own profile
3. **PESEL Protection:** PESEL immutable, only last 4 digits visible
4. **Email Confirmation:** Email changes require confirmation to prevent hijacking
5. **Validation:** Phone and email format validated
6. **Audit Trail:** All changes logged

### Audit Requirements

**Log for Profile Updates:**
- UserId
- Timestamp
- Changed fields (field names only, not full PESEL)
- Old values (except passwords)
- New values (except passwords)
- IP address (optional)

### User Experience

**Profile Page States:**
1. **View Mode:** Display all info, "Edit Profile" button
2. **Edit Mode:** Form with editable fields, "Save" and "Cancel" buttons
3. **Email Change Pending:** Warning banner "Email change confirmation sent to newEmail@example.com"
4. **Success:** Toast notification "Profile updated successfully"
5. **Error:** Inline error messages on form fields

**Email Change Confirmation:**
- User clicks link in email
- Loading state while confirming
- Success: "Email changed! You can now log in with yournewemail@example.com"
- Error: "Link expired or invalid"

### Dependencies

**Prerequisites:**
- Story 1.1: User entity
- Story 1.4: Authentication (JWT tokens)
- Email service from Story 1.2

**Blocks:**
- Nothing (standalone feature)

### Testing Strategy

**Unit Tests:**
- GetUserProfileQueryHandler
- UpdateUserProfileCommandHandler (including email change)
- ConfirmEmailChangeCommandHandler

**Integration Tests:**
- GET /profile (authenticated)
- PUT /profile (update fields)
- Email change confirmation flow
- PESEL immutability

**E2E Tests:**
- Update profile workflow
- Email change workflow (requires email testing)

### Additional Notes

1. **Email Change Security:** Always send confirmation to NEW email to prevent account takeover
2. **Pending Email Display:** Show user if email change is pending
3. **PESEL Display:** Always masked, show last 4 digits only
4. **Profile Picture:** Not in scope for this story (future enhancement)
5. **Two-Factor Auth:** Not in scope (future enhancement)
6. **Account Deletion:** Not in scope (would be separate story)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 1 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

