# Story 6.1: Upload File to Library (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.1  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** upload files to the Library,  
**So that** external users can access them.

---

## Acceptance Criteria

1. UKNF Employee can access "Add File to Library" functionality
2. Employee can upload file (any format commonly needed: XLSX, PDF, DOC/DOCX, ZIP, etc.)
3. System validates file size (maximum 100 MB)
4. Employee must provide metadata:
   - Filename (text, required, can differ from uploaded file name)
   - Description (text area, optional)
   - Category (dropdown, required) - e.g., "Report Templates", "Instructions", "Guidelines", "Forms"
   - Reporting Period (text or dropdown, optional) - e.g., "Q1 2025", "Annual 2024"
   - Model Update Date (date picker, required) - date of template/document version
5. Employee can add the actual file (Annex/Attachment, required)
6. System stores file securely
7. Upon successful upload, file appears in Library with "Current" version status
8. File is initially not shared (no access for external users until permissions are set)
9. System logs file upload with timestamp and employee ID
10. System performs virus scanning on uploaded file
11. System rejects files that fail virus scan with clear error message

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create LibraryFile domain entity** (AC: 4, 7, 8)
  - [ ] Create `LibraryFile.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - Filename (string, required, max 500) - display name
    - OriginalFilename (string, required, max 500) - uploaded file name
    - Description (string?, nullable, max 2000)
    - CategoryId (Guid, required) - foreign key to Category
    - ReportingPeriod (string?, nullable, max 100)
    - ModelUpdateDate (DateTime, required) - version date
    - VersionStatus (enum, required) - Current/Archival
    - ArchivalDate (DateTime?, nullable)
    - FileStorageKey (string, required) - blob storage key
    - FileSize (long, required) - bytes
    - FileExtension (string, required, max 50)
    - MimeType (string, required, max 200)
    - VirusScanStatus (enum, required) - Pending, Clean, Infected
    - VirusScanDate (DateTime?, nullable)
    - UploadedByUserId (Guid, required)
    - DownloadCount (int, default 0)
    - IsDeleted (bool, default false)
    - DeletedDate (DateTime?, nullable)
    - DeletedByUserId (Guid?, nullable)
    - PreviousVersionId (Guid?, nullable) - link to previous version in chain
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)
  - [ ] Add VersionStatus enum: Current, Archival
  - [ ] Add VirusScanStatus enum: Pending, Clean, Infected
  - [ ] Add domain methods: MarkAsArchival, IncrementDownloadCount, MarkAsDeleted
  - [ ] Add domain validation rules

- [ ] **Task 2: Create FileCategory domain entity** (AC: 4)
  - [ ] Create `FileCategory.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - Name (string, required, max 200)
    - Description (string?, nullable, max 1000)
    - SortOrder (int, default 0)
    - IsActive (bool, default true)
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)
  - [ ] Add domain validation rules

- [ ] **Task 3: Create FilePermission domain entity** (AC: 8)
  - [ ] Create `FilePermission.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - FileId (Guid, required) - foreign key to LibraryFile
    - PermissionType (enum, required) - AllUsers, SpecificEntity, EntityType, SpecificUser, ContactGroup
    - EntityId (long?, nullable) - for SpecificEntity
    - EntityType (string?, nullable, max 100) - for EntityType
    - UserId (Guid?, nullable) - for SpecificUser
    - ContactGroupId (Guid?, nullable) - for ContactGroup (future)
    - CreatedByUserId (Guid, required)
    - CreatedDate (DateTime)
  - [ ] Add PermissionType enum: AllUsers, SpecificEntity, EntityType, SpecificUser, ContactGroup
  - [ ] Add domain validation rules

- [ ] **Task 4: Create FileChangeHistory domain entity** (AC: 9)
  - [ ] Create `FileChangeHistory.cs` in `Domain/UknfPlatform.Domain.Communication/Entities/`
  - [ ] Properties:
    - Id (Guid)
    - FileId (Guid, required)
    - Action (enum, required) - Upload, MetadataUpdate, PermissionChange, VersionReplace, Archive, Delete
    - FieldName (string?, nullable, max 100)
    - OldValue (string?, nullable, max 2000)
    - NewValue (string?, nullable, max 2000)
    - ChangeDescription (string?, nullable, max 1000)
    - ChangedByUserId (Guid, required)
    - CreatedDate (DateTime)
  - [ ] Add ChangeAction enum

- [ ] **Task 5: Create UploadFileCommand** (AC: 2, 3, 4, 5)
  - [ ] Create `UploadFileCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - Filename (string, required)
    - Description (string?, nullable)
    - CategoryId (Guid, required)
    - ReportingPeriod (string?, nullable)
    - ModelUpdateDate (DateTime, required)
    - File (IFormFile, required)
  - [ ] Note: File is part of multipart/form-data request

- [ ] **Task 6: Create UploadFileCommandValidator** (AC: 2, 3, 4, 5)
  - [ ] Create `UploadFileCommandValidator.cs` using FluentValidation
  - [ ] Validate Filename: NotEmpty, MaxLength(500)
  - [ ] Validate Description: MaxLength(2000) if provided
  - [ ] Validate CategoryId: NotEmpty, MustBeValidGuid
  - [ ] Validate ReportingPeriod: MaxLength(100) if provided
  - [ ] Validate ModelUpdateDate: NotEmpty, MustBeDateInPastOrToday
  - [ ] Validate File: NotNull
  - [ ] Validate File Size: MaxSize 100 MB (104,857,600 bytes)
  - [ ] Validate File Extension: Must be in allowed list (XLSX, PDF, DOC, DOCX, ZIP, etc.)
  - [ ] Add async validation: CategoryId must exist
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 7: Create UploadFileCommandHandler** (AC: 1, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `UploadFileCommandHandler.cs` implementing `IRequestHandler<UploadFileCommand, UploadFileResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFileStorageService, IVirusScanService, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Generate unique storage key for file
    - Upload file to blob storage (IFileStorageService)
    - Initiate virus scan (IVirusScanService) - can be async/background job
    - Extract file metadata (size, extension, MIME type)
    - Create LibraryFile entity with VersionStatus = Current, VirusScanStatus = Pending
    - Save to repository
    - Create FileChangeHistory entry (Action = Upload)
    - Log file upload
    - Return UploadFileResponse with FileId
  - [ ] Handle errors: storage failures, scan failures
  - [ ] Transaction: rollback if any step fails

- [ ] **Task 8: Create UploadFileResponse DTO** (AC: 7)
  - [ ] Create `UploadFileResponse.cs` record
  - [ ] Properties: FileId (Guid), Filename (string), Message (string), VirusScanStatus (string)

- [ ] **Task 9: Create REST API endpoint POST /library/files** (AC: 1, 11)
  - [ ] Add LibraryController in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create POST action `UploadFileAsync([FromForm] UploadFileCommand command)`
  - [ ] Note: [FromForm] for multipart/form-data
  - [ ] Inject IMediator to send command
  - [ ] Return 201 Created with UploadFileResponse and Location header
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 413 Payload Too Large if file exceeds size limit
  - [ ] Return 422 Unprocessable Entity if virus scan fails
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations for file upload

- [ ] **Task 10: Create ILibraryFileRepository interface and implementation** (AC: 6, 7)
  - [ ] Create `ILibraryFileRepository.cs` interface in `Domain/UknfPlatform.Domain.Communication/Interfaces/`
  - [ ] Define methods: AddAsync, GetByIdAsync, UpdateAsync, GetAllAsync, GetByCategoryAsync, DeleteAsync
  - [ ] Create `LibraryFileRepository.cs` in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/`
  - [ ] Implement repository methods using EF Core
  - [ ] Include Category navigation property in queries

- [ ] **Task 11: Create IFileCategoryRepository interface and implementation** (AC: 4)
  - [ ] Create `IFileCategoryRepository.cs` interface
  - [ ] Define methods: GetAllAsync, GetByIdAsync, AddAsync, UpdateAsync, DeleteAsync
  - [ ] Create `FileCategoryRepository.cs` implementation
  - [ ] Implement methods using EF Core

- [ ] **Task 12: Create IFileChangeHistoryRepository interface and implementation** (AC: 9)
  - [ ] Create `IFileChangeHistoryRepository.cs` interface
  - [ ] Define methods: AddAsync, GetByFileIdAsync
  - [ ] Create `FileChangeHistoryRepository.cs` implementation

- [ ] **Task 13: Create IVirusScanService interface and implementation** (AC: 10, 11)
  - [ ] Create `IVirusScanService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Define method: ScanFileAsync(Stream fileStream, string filename)
  - [ ] Create `VirusScanService.cs` in `Infrastructure/UknfPlatform.Infrastructure.FileStorage/`
  - [ ] Implement virus scanning (integrate with ClamAV, Windows Defender API, or cloud service)
  - [ ] Return ScanResult with IsClean, ThreatName, ScanDate
  - [ ] Handle scan failures gracefully
  - [ ] Consider async/background processing for large files

- [ ] **Task 14: Create database schema** (AC: 6, 7, 8, 9)
  - [ ] Create EF Core entity configurations:
    - `LibraryFileConfiguration.cs`
    - `FileCategoryConfiguration.cs`
    - `FilePermissionConfiguration.cs`
    - `FileChangeHistoryConfiguration.cs`
  - [ ] Configure table names, primary keys, indexes
  - [ ] Configure foreign key relationships:
    - LibraryFile -> FileCategory
    - LibraryFile -> PreviousVersion (self-reference)
    - FilePermission -> LibraryFile
    - FileChangeHistory -> LibraryFile
  - [ ] Configure indexes:
    - LibraryFile: CategoryId, VersionStatus, IsDeleted, ModelUpdateDate
    - FilePermission: FileId, PermissionType, EntityId, UserId
    - FileChangeHistory: FileId, CreatedDate
  - [ ] Add EF Core migration `Add_Library_Tables`
  - [ ] Seed default categories (Report Templates, Instructions, Guidelines, Forms)

- [ ] **Task 15: Update ApplicationDbContext** (AC: 6)
  - [ ] Add DbSet<LibraryFile> LibraryFiles
  - [ ] Add DbSet<FileCategory> FileCategories
  - [ ] Add DbSet<FilePermission> FilePermissions
  - [ ] Add DbSet<FileChangeHistory> FileChangeHistories
  - [ ] Apply entity configurations in OnModelCreating

### Frontend Tasks

- [ ] **Task 16: Create file upload component** (AC: 1, 2, 4, 5)
  - [ ] Create `library-file-upload.component.ts` in `src/app/features/library/`
  - [ ] Create form with fields:
    - Filename (text input)
    - Description (textarea)
    - Category (dropdown - load from API)
    - Reporting Period (text input, optional)
    - Model Update Date (date picker)
    - File upload (file input with drag-and-drop)
  - [ ] Implement file drag-and-drop functionality
  - [ ] Show file preview (name, size, type) after selection
  - [ ] Validate file size client-side (100 MB limit)
  - [ ] Validate file type client-side (allowed extensions)
  - [ ] Show upload progress indicator
  - [ ] Handle multipart/form-data submission

- [ ] **Task 17: Create library service** (AC: 1, 5, 6)
  - [ ] Create `library.service.ts` in `src/app/core/services/`
  - [ ] Implement methods:
    - uploadFile(formData: FormData): Observable<UploadFileResponse>
    - getCategories(): Observable<FileCategory[]>
  - [ ] Configure HTTP client for multipart/form-data
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 18: Create library routing and navigation** (AC: 1)
  - [ ] Add library routes to app routing module
  - [ ] Add "Library" menu item for UKNF Employees
  - [ ] Add "Upload File" button in Library view
  - [ ] Implement route guards to restrict access to UKNF Employees

- [ ] **Task 19: Create file upload success feedback** (AC: 7, 8)
  - [ ] Show success notification after upload
  - [ ] Display uploaded file details (FileId, Filename)
  - [ ] Show virus scan status (Pending/Clean/Infected)
  - [ ] Provide option to set permissions immediately
  - [ ] Redirect to file details or library list

- [ ] **Task 20: Create error handling** (AC: 3, 11)
  - [ ] Display file size error if exceeds 100 MB
  - [ ] Display virus scan failure error
  - [ ] Display validation errors from backend
  - [ ] Handle network errors gracefully
  - [ ] Show user-friendly error messages

### Testing Tasks

- [ ] **Task 21: Unit tests for domain entities** (AC: 7, 8)
  - [ ] Test LibraryFile creation and validation
  - [ ] Test FileCategory validation
  - [ ] Test FilePermission validation
  - [ ] Test domain methods (MarkAsArchival, IncrementDownloadCount, etc.)

- [ ] **Task 22: Unit tests for command handler** (AC: 6, 7, 9, 10)
  - [ ] Test successful file upload
  - [ ] Test file storage integration
  - [ ] Test virus scan integration
  - [ ] Test entity creation with correct metadata
  - [ ] Test change history logging
  - [ ] Test error handling (storage failure, scan failure)

- [ ] **Task 23: Unit tests for validator** (AC: 2, 3, 4)
  - [ ] Test filename validation
  - [ ] Test file size validation (100 MB limit)
  - [ ] Test file extension validation
  - [ ] Test required field validation
  - [ ] Test ModelUpdateDate validation (must be past or today)

- [ ] **Task 24: Integration tests for API endpoint** (AC: 1, 11)
  - [ ] Test POST /library/files with valid data returns 201
  - [ ] Test file upload requires UKNF Employee role (403 if not)
  - [ ] Test file size exceeds limit returns 413
  - [ ] Test invalid file type returns 400
  - [ ] Test virus infected file returns 422
  - [ ] Test multipart/form-data handling

- [ ] **Task 25: Frontend unit tests** (AC: 2, 3, 4, 5)
  - [ ] Test file upload component rendering
  - [ ] Test form validation
  - [ ] Test file selection and preview
  - [ ] Test drag-and-drop functionality
  - [ ] Test service method calls

- [ ] **Task 26: E2E tests** (AC: 1-11)
  - [ ] Test complete file upload flow as UKNF Employee
  - [ ] Test file appears in library after upload
  - [ ] Test file is not accessible to external users initially
  - [ ] Test upload with various file types (XLSX, PDF, DOCX, ZIP)
  - [ ] Test error scenarios (size limit, invalid type, virus scan failure)

### Documentation Tasks

- [ ] **Task 27: API documentation** (AC: 1, 9)
  - [ ] Document POST /library/files endpoint in OpenAPI/Swagger
  - [ ] Include request/response examples
  - [ ] Document multipart/form-data format
  - [ ] Document error responses
  - [ ] Document authentication requirements

- [ ] **Task 28: Developer documentation** (AC: 6, 10)
  - [ ] Document file storage strategy (blob storage location, naming convention)
  - [ ] Document virus scanning integration
  - [ ] Document allowed file types and size limits
  - [ ] Document file metadata schema
  - [ ] Document versioning strategy (for future story 6.7)

- [ ] **Task 29: User documentation** (AC: 1, 4, 5)
  - [ ] Create user guide for uploading files
  - [ ] Document file metadata requirements
  - [ ] Document file size and type limitations
  - [ ] Document virus scanning process
  - [ ] Include screenshots of upload interface

---

## Technical Notes

### File Storage Strategy
- Store files in blob storage (Azure Blob Storage, AWS S3, or MinIO for local dev)
- Generate unique storage keys (e.g., `{year}/{month}/{guid}.{extension}`)
- Store original filename separately for download
- Implement file retention policy for deleted files

### Virus Scanning
- Integrate with ClamAV (open-source) or cloud-based scanning service
- Scan files asynchronously to avoid blocking uploads
- Mark files as Pending until scan completes
- Prevent downloads of files with Pending or Infected status
- Consider background job to process scan queue

### Allowed File Types
Initial supported types:
- Spreadsheets: XLSX, XLS
- Documents: PDF, DOC, DOCX
- Archives: ZIP, RAR
- Text: TXT, CSV

Can be extended in configuration.

### Security Considerations
- Only UKNF Employees can upload files
- Validate file signatures (magic bytes) not just extensions
- Sanitize filenames to prevent path traversal
- Implement rate limiting on uploads
- Log all upload attempts for audit

### Performance Considerations
- Stream large files directly to blob storage (don't load in memory)
- Implement chunked uploads for files > 10 MB
- Use CDN for file downloads (future optimization)
- Index database tables for efficient queries

---

## Dependencies

### Prerequisites
- Epic 1: Authentication (UKNF Employee role identification)
- Epic 2: Authorization (to identify entities for future permission assignment)
- File storage infrastructure (Azure Blob Storage / AWS S3 / MinIO)
- Virus scanning service (ClamAV or equivalent)

### Integrates With
- Story 6.2: Set File Access Permissions (to share uploaded files)
- Story 6.3: View and Search Library (uploaded files appear in library)
- Story 6.4: Download File (to download uploaded files)

---

## Acceptance Checklist

- [ ] UKNF Employee can access upload functionality
- [ ] Employee can upload files with all required metadata
- [ ] System validates file size (100 MB limit)
- [ ] System validates file type (allowed extensions)
- [ ] System performs virus scanning
- [ ] Files are stored securely in blob storage
- [ ] Files appear in Library with "Current" status
- [ ] Files are initially not shared (no permissions set)
- [ ] System logs all uploads with timestamp and user ID
- [ ] Frontend provides intuitive upload interface
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.2**: Set File Access Permissions (next step after upload)
- **Story 6.6**: Update File Metadata (modify uploaded file info)
- **Story 6.7**: Replace File (upload new version)
- **Story 6.8**: Delete File from Library (remove uploaded files)

---

## Notes

- File upload is the foundation for the entire Library system
- Files are initially uploaded without permissions - UKNF Employee must explicitly share them (Story 6.2)
- Virus scanning can be implemented asynchronously for better UX
- Consider implementing upload progress tracking for large files
- File versioning (Story 6.7) builds on this upload functionality
- Change history tracking starts with upload action
- Consider max filename length (500 chars) for display purposes
- Model Update Date represents the version date of the document content, not upload date

