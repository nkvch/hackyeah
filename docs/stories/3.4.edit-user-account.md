# Story 3.4: Edit User Account

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.4  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** edit user account information,  
**So that** I can keep user data current and accurate.

---

## Acceptance Criteria

1. System Administrator can select any user account to edit
2. Administrator can modify: First name, Last name, Email, Phone number
3. Administrator cannot modify: PESEL (immutable), User ID
4. Email changes require uniqueness validation
5. System tracks all changes in audit log
6. Changes take effect immediately
7. If email is changed, user receives notification to both old and new addresses
8. System displays last modified timestamp and administrator

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create UpdateUserCommand** (AC: 2, 4)
  - [ ] Create `UpdateUserCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserId (Guid, required) - user to update
    - FirstName (string, required)
    - LastName (string, required)
    - Email (string, required)
    - Phone (string, required)
    - EmployeeId (string, optional) - for internal users only
  - [ ] Note: No PESEL property (AC: 3 - immutable)

- [ ] **Task 2: Create UpdateUserCommandValidator** (AC: 2, 4)
  - [ ] Create `UpdateUserCommandValidator.cs` using FluentValidation
  - [ ] Validate UserId: NotEmpty
  - [ ] Validate FirstName: NotEmpty, MaxLength(100)
  - [ ] Validate LastName: NotEmpty, MaxLength(100)
  - [ ] Validate Email: NotEmpty, EmailAddress format, MaxLength(256)
  - [ ] Validate Phone: NotEmpty, Matches regex `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate EmployeeId: MaxLength(50) if provided
  - [ ] Add custom async validation: If email changed, check uniqueness (exclude current user)

- [ ] **Task 3: Create UpdateUserCommandHandler** (AC: 2, 4, 5, 6, 7)
  - [ ] Create `UpdateUserCommandHandler.cs` implementing `IRequestHandler<UpdateUserCommand, UpdateUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IEmailService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get user by UserId (404 if not found)
    - Store original email for notification (if changed)
    - Check if email changed and if so, validate uniqueness
    - Update user entity via domain method `user.UpdateProfile()`
    - Set FirstName, LastName, Email, Phone
    - Set EmployeeId if internal user
    - Set UpdatedDate = DateTime.UtcNow
    - Save to repository
    - If email changed, send notification to both old and new email
    - Create audit log entry with before/after values
    - Return UpdateUserResponse
  - [ ] Use transaction to ensure atomicity

- [ ] **Task 4: Update User domain entity** (AC: 2, 3)
  - [ ] Open `User.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add domain method: `UpdateProfile(firstName, lastName, email, phone, employeeId?)`
  - [ ] Method updates properties with validation
  - [ ] Prevents modification of immutable fields (PESEL)
  - [ ] Sets UpdatedDate automatically
  - [ ] Add domain event: `UserProfileUpdatedEvent` (optional)

- [ ] **Task 5: Create UpdateUserResponse DTO** (AC: 6, 8)
  - [ ] Create `UpdateUserResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - UserId (Guid)
    - Message (string)
    - EmailChanged (bool)
    - NotificationSent (bool)
    - UpdatedDate (DateTime)
    - UpdatedBy (string) - administrator name

- [ ] **Task 6: Create REST API endpoint PUT /api/admin/users/{id}** (AC: 1, 2)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create PUT action `UpdateUserAsync(Guid id, UpdateUserCommand command)`
  - [ ] Ensure id parameter matches command.UserId
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with UpdateUserResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 404 Not Found if user doesn't exist
  - [ ] Return 409 Conflict if email already exists
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 7: Create email change notification template** (AC: 7)
  - [ ] Create `EmailChangedNotification.cshtml` in `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/`
  - [ ] Template content for OLD email:
    - Subject: "Your email address has been changed"
    - Message: Email changed by administrator
    - New email address shown
    - Contact support if not authorized
  - [ ] Template content for NEW email:
    - Subject: "Your email address has been updated"
    - Message: Welcome to new email
    - Login instructions with new email
    - Contact support if issues

- [ ] **Task 8: Update IEmailService for email change notifications** (AC: 7)
  - [ ] Update `IEmailService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Add method: `SendEmailChangedNotificationAsync(userId, oldEmail, newEmail, userName)`
  - [ ] Implement in `EmailService.cs`:
    - Send notification to old email
    - Send notification to new email
    - Log email sending actions
  - [ ] Handle email sending failures gracefully (log error, don't fail update)

- [ ] **Task 9: Create audit log entry** (AC: 5, 8)
  - [ ] After user update, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = administrator who modified user
    - EntityType = "User"
    - EntityPrimaryKey = updated user's ID
    - Action = "Update"
    - Timestamp = DateTime.UtcNow
    - BeforeState = JSON snapshot of original user data
    - AfterState = JSON snapshot of updated user data
  - [ ] Include changed fields only for clarity
  - [ ] Exclude sensitive data (password hash) from logs

- [ ] **Task 10: Create GetUserDetailsQuery** (AC: 1, 8)
  - [ ] Create `GetUserDetailsQuery.cs` in `Application/UknfPlatform.Application.Admin/Users/Queries/`
  - [ ] Query property: UserId (Guid)
  - [ ] Create `GetUserDetailsQueryHandler.cs`
  - [ ] Handler logic:
    - Get user by UserId with includes (Roles, Entities)
    - Map to UserDetailsDto
    - Include audit info: CreatedDate, UpdatedDate, LastModifiedBy
    - Return user details
  - [ ] Inject: IUserRepository, IMapper

- [ ] **Task 11: Create UserDetailsDto** (AC: 1, 2, 3, 8)
  - [ ] Create `UserDetailsDto.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - Id (Guid)
    - FirstName, LastName, Email, Phone
    - UserType (string)
    - EmployeeId (string?) - for internal users
    - PeselLast4 (string?) - for external users, read-only display
    - IsActive (bool)
    - Roles (List<RoleDto>)
    - Entities (List<EntitySummaryDto>) - for external users
    - CreatedDate (DateTime)
    - UpdatedDate (DateTime)
    - LastModifiedBy (string?) - administrator who last modified
    - LastLoginDate (DateTime?)

- [ ] **Task 12: Create REST API endpoint GET /api/admin/users/{id}** (AC: 1)
  - [ ] Update `UsersController.cs`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create GET action `GetUserAsync(Guid id)`
  - [ ] Inject IMediator
  - [ ] Send GetUserDetailsQuery via MediatR
  - [ ] Return 200 OK with UserDetailsDto
  - [ ] Return 404 Not Found if user doesn't exist
  - [ ] Add XML documentation comments

### Frontend Tasks

- [ ] **Task 13: Create user service methods** (AC: 1, 2)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Add method: `getUserDetails(id): Observable<UserDetailsDto>`
  - [ ] Add method: `updateUser(id, command): Observable<UpdateUserResponse>`
  - [ ] Call GET `/api/admin/users/{id}` and PUT `/api/admin/users/{id}`
  - [ ] Handle errors with catchError

- [ ] **Task 14: Create edit user component** (AC: 1, 2)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/users/edit-user/edit-user.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/admin/users/:id/edit` with auth + role guard
  - [ ] Route parameter: user ID
  - [ ] Load user details on init
  - [ ] Create reactive form with FormBuilder pre-filled with current values

- [ ] **Task 15: Implement edit form** (AC: 2, 3)
  - [ ] Form fields (editable):
    - firstName
    - lastName
    - email
    - phone
    - employeeId (if internal user)
  - [ ] Form fields (read-only/disabled):
    - userId (display only)
    - pesel (display last 4 digits only if external user)
    - userType (display only)
    - createdDate (display only)
    - updatedDate (display only)
  - [ ] Show info message: "PESEL and User Type cannot be changed"

- [ ] **Task 16: Implement form validation** (AC: 2, 4)
  - [ ] FirstName/LastName: Validators.required, Validators.maxLength(100)
  - [ ] Email: Validators.required, Validators.email
  - [ ] Phone: Validators.required, Validators.pattern(/^\+(?:[0-9] ?){6,14}[0-9]$/)
  - [ ] EmployeeId: Validators.maxLength(50)
  - [ ] Add async validator: Email uniqueness check if changed (debounce 500ms)
  - [ ] Display validation error messages below each field
  - [ ] Disable submit button if form invalid or unchanged

- [ ] **Task 17: Track form changes** (AC: 5, 6)
  - [ ] Use form.valueChanges to detect modifications
  - [ ] Show "unsaved changes" indicator if form is dirty
  - [ ] Warn user if navigating away with unsaved changes (CanDeactivate guard)
  - [ ] Enable/disable save button based on form state
  - [ ] Show which fields changed (highlight or indicator)

- [ ] **Task 18: Handle form submission** (AC: 6, 7)
  - [ ] On submit, call usersService.updateUser()
  - [ ] Show loading spinner during submission
  - [ ] On success (200):
    - Display success message
    - If email changed, show specific message: "User updated. Email change notifications sent."
    - Reload user details or navigate to user list
    - Mark form as pristine
  - [ ] On error (400): Display validation errors
  - [ ] On error (404): Display "User not found" and redirect
  - [ ] On error (409): Display "Email already exists"
  - [ ] Use NotificationService for toast messages

- [ ] **Task 19: Display audit information** (AC: 8)
  - [ ] Show read-only audit section:
    - Created Date: formatted date-time
    - Last Updated: formatted date-time
    - Last Modified By: administrator name
    - Last Login: formatted date-time or "Never"
  - [ ] Display in collapsible "Audit Information" panel
  - [ ] Show user roles (read-only, link to Story 3.11 for editing roles)
  - [ ] Show user entities (read-only for external users)

- [ ] **Task 20: Create form layout** (AC: 1, 2)
  - [ ] Page title: "Edit User: {FirstName} {LastName}"
  - [ ] Breadcrumb: Admin > Users > User Details > Edit
  - [ ] Use card layout with form sections:
    - "User Information" (editable fields)
    - "System Information" (read-only: ID, type, PESEL)
    - "Audit Information" (dates, modified by)
  - [ ] Form buttons: "Save Changes", "Cancel"
  - [ ] Use PrimeNG form components
  - [ ] Style with Tailwind CSS
  - [ ] Responsive design

- [ ] **Task 21: Add edit action to user list** (AC: 1)
  - [ ] In user list page (Story 3.1), add "Edit" action button per user
  - [ ] Navigate to edit page: `/admin/users/{id}/edit`
  - [ ] Alternatively, click row to view details, then "Edit" button

### Testing Tasks

- [ ] **Task 22: Write unit tests for UpdateUserCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidCommand_UpdatesUser`
  - [ ] Test: `Handle_UserNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_EmailChanged_ValidatesUniqueness`
  - [ ] Test: `Handle_EmailAlreadyExists_ThrowsConflictException`
  - [ ] Test: `Handle_EmailChanged_SendsNotifications`
  - [ ] Test: `Handle_UpdatesAuditLog`
  - [ ] Test: `Handle_CannotModifyPesel`
  - [ ] Test: `Handle_SetsUpdatedDate`
  - [ ] Mock: IUserRepository, IEmailService, ICurrentUserService, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 23: Write unit tests for UpdateUserCommandValidator**
  - [ ] Test: Email validation (valid, invalid, empty, uniqueness if changed)
  - [ ] Test: Phone validation (valid international, invalid format)
  - [ ] Test: Required field validation
  - [ ] Test: Email unchanged - no uniqueness check

- [ ] **Task 24: Write integration test for update user endpoint**
  - [ ] Test: `PUT_UpdateUser_WithValidData_Returns200AndUpdatesUser`
  - [ ] Test: `PUT_UpdateUser_UserNotFound_Returns404`
  - [ ] Test: `PUT_UpdateUser_WithExistingEmail_Returns409`
  - [ ] Test: `PUT_UpdateUser_AsNonAdmin_Returns403`
  - [ ] Test: `PUT_UpdateUser_EmailChanged_SendsNotifications`
  - [ ] Test: `PUT_UpdateUser_CreatesAuditLog`
  - [ ] Use Testcontainers for database
  - [ ] Verify user updated in database
  - [ ] Verify audit log entry created
  - [ ] Verify emails sent (mock SMTP)

- [ ] **Task 25: Write integration test for get user details endpoint**
  - [ ] Test: `GET_UserDetails_ValidId_Returns200WithDetails`
  - [ ] Test: `GET_UserDetails_InvalidId_Returns404`
  - [ ] Test: `GET_UserDetails_AsNonAdmin_Returns403`
  - [ ] Verify includes roles and entities

- [ ] **Task 26: Write E2E test for edit user flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Select user from list
    4. Click "Edit"
    5. Verify form pre-filled with current values
    6. Modify email and phone
    7. Submit form
    8. Verify success message
    9. Verify changes reflected in user list
    10. Verify audit log updated
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 3.1:**
- User list view with user details
- User filtering and searching

**From Story 3.2 & 3.3:**
- User creation (internal and external)
- Password setup workflows
- Email notification infrastructure
- Audit logging patterns

**Key Integration:**
- This story allows editing existing users created in Stories 3.2, 3.3, or Epic 1
- Cannot modify immutable fields (PESEL, User ID)
- Email changes trigger notifications (security best practice)
- All changes audited

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Logging: Serilog 3.1.1
- Mapping: Mapster 7.4.0
- Email: MailKit 4.4.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG
- Styling: Tailwind CSS
- TypeScript: 5.3+ (strict mode enabled)

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── UsersController.cs (UPDATE - add UpdateUserAsync, GetUserAsync)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Commands/
│   │   ├── UpdateUserCommand.cs (CREATE)
│   │   ├── UpdateUserCommandHandler.cs (CREATE)
│   │   └── UpdateUserCommandValidator.cs (CREATE)
│   ├── Queries/
│   │   ├── GetUserDetailsQuery.cs (CREATE)
│   │   └── GetUserDetailsQueryHandler.cs (CREATE)
│   └── DTOs/
│       ├── UpdateUserResponse.cs (CREATE)
│       └── UserDetailsDto.cs (CREATE)
├── Domain/UknfPlatform.Domain.Auth/
│   ├── Entities/
│   │   └── User.cs (UPDATE - add UpdateProfile method)
│   └── Events/
│       └── UserProfileUpdatedEvent.cs (CREATE - optional)
└── Infrastructure/UknfPlatform.Infrastructure.Email/Templates/
    └── EmailChangedNotification.cshtml (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── users.service.ts (UPDATE - add getUserDetails, updateUser)
├── features/admin/users/edit-user/
│   ├── edit-user.component.ts (CREATE)
│   ├── edit-user.component.html (CREATE)
│   └── edit-user.component.scss (CREATE)
└── core/guards/
    └── unsaved-changes.guard.ts (CREATE - optional)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table (Update Operation):**
```sql
-- Editable fields
FirstName NVARCHAR(100) NOT NULL,
LastName NVARCHAR(100) NOT NULL,
Email NVARCHAR(256) NOT NULL UNIQUE,
Phone NVARCHAR(20) NOT NULL,
EmployeeId NVARCHAR(50) NULL, -- For internal users only

-- Immutable fields
Id UUID PRIMARY KEY,  -- Cannot change
PeselEncrypted NVARCHAR(500), -- Cannot change
PeselLast4 NVARCHAR(4), -- Cannot change
UserType NVARCHAR(20), -- Cannot change

-- Auto-updated fields
UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
```

**Key Points:**
- PESEL is immutable (cannot be changed after account creation)
- UserType is immutable (cannot convert Internal to External or vice versa)
- Email changes require uniqueness check (exclude current user from check)
- UpdatedDate automatically set on modification
- Track who modified (via audit log)

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** GET `/api/admin/users/{id}`
- **Security:** Requires authentication + "System Administrator" role
- **Path Parameters:**
  - `id` (uuid) - User ID
- **Success Response (200 OK):**
  ```json
  {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "firstName": "Jan",
    "lastName": "Kowalski",
    "email": "jan.kowalski@example.com",
    "phone": "+48123456789",
    "userType": "External",
    "employeeId": null,
    "peselLast4": "8901",
    "isActive": true,
    "roles": [
      { "id": "role-guid", "name": "Report Viewer" }
    ],
    "entities": [
      { "id": 1001, "name": "Example Bank S.A." }
    ],
    "createdDate": "2025-09-01T08:00:00Z",
    "updatedDate": "2025-10-04T14:30:00Z",
    "lastModifiedBy": "admin@uknf.gov.pl",
    "lastLoginDate": "2025-10-04T10:15:00Z"
  }
  ```
- **Error Responses:**
  - 401: Unauthorized
  - 403: Forbidden (not System Administrator)
  - 404: Not Found (user doesn't exist)

**Endpoint:** PUT `/api/admin/users/{id}`
- **Security:** Requires authentication + "System Administrator" role
- **Path Parameters:**
  - `id` (uuid) - User ID
- **Request Body:**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "firstName": "Jan",
    "lastName": "Kowalski",
    "email": "new.email@example.com",
    "phone": "+48987654321",
    "employeeId": "EMP-12345"
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "User updated successfully",
    "emailChanged": true,
    "notificationSent": true,
    "updatedDate": "2025-10-04T14:30:00Z",
    "updatedBy": "admin@uknf.gov.pl"
  }
  ```
- **Error Responses:**
  - 400: Bad Request (validation errors)
  - 401: Unauthorized
  - 403: Forbidden
  - 404: Not Found (user doesn't exist)
  - 409: Conflict (email already exists)

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use domain method for updates**
   ```csharp
   // ✅ CORRECT
   user.UpdateProfile(firstName, lastName, email, phone, employeeId);
   // NOT: user.Email = newEmail;
   ```

2. **Track changes for audit**
   ```csharp
   // ✅ CORRECT - Store before and after state
   var beforeState = JsonSerializer.Serialize(user);
   user.UpdateProfile(...);
   var afterState = JsonSerializer.Serialize(user);
   // Log to audit
   ```

3. **Email change notifications**
   ```csharp
   // ✅ CORRECT - Notify both emails
   if (emailChanged)
   {
       await _emailService.SendEmailChangedNotificationAsync(
           user.Id, oldEmail, newEmail, user.FullName);
   }
   ```

4. **Check email uniqueness if changed**
   ```csharp
   // ✅ CORRECT - Only check if email changed
   if (command.Email != user.Email)
   {
       if (await _userRepository.EmailExistsAsync(command.Email))
           throw new ConflictException("Email already exists");
   }
   ```

5. **Never allow PESEL modification**
   ```csharp
   // ✅ CORRECT - Domain method prevents PESEL changes
   public void UpdateProfile(string firstName, string lastName, string email, string phone)
   {
       // No PESEL parameter - cannot be changed
       FirstName = firstName;
       LastName = lastName;
       Email = email;
       Phone = phone;
       UpdatedDate = DateTime.UtcNow;
   }
   ```

6. **Log updates for audit**
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation(
       "User {UserId} updated by administrator {AdminId}. Email changed: {EmailChanged}",
       userId, currentAdminId, emailChanged);
   ```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 3

1. **Authorization:** Only System Administrators can edit users
2. **Email Validation:** Check format and uniqueness if changed
3. **Immutable Fields:** PESEL, UserType, User ID cannot be modified
4. **Email Notifications:** Notify both old and new email addresses for security
5. **Audit Trail:** Log all modifications with before/after values
6. **Sensitive Data:** Don't log password hashes or full PESEL

### Audit Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#22-audit-and-login`, Epic 3

- Log all user modifications
- Include before and after states (JSON snapshots)
- Record which administrator made the change
- Include timestamp
- Track specific fields changed
- Exclude sensitive data from logs (password hash, full PESEL)

### Email Templates

**Email Changed Notification (Old Email):**
```html
Subject: Security Alert: Your email address has been changed

Dear {{FirstName}} {{LastName}},

This is to inform you that the email address associated with your UKNF Communication Platform account has been changed by a system administrator.

Previous Email: {{OldEmail}}
New Email: {{NewEmail}}
Changed By: System Administrator
Date: {{ChangeDate}}

If you did not request this change or believe this is an error, please contact support immediately:
Email: support@uknf.gov.pl
Phone: +48 22 XXX XX XX

For security reasons, you will need to use your new email address for future logins.

Best regards,
UKNF IT Team
```

**Email Changed Notification (New Email):**
```html
Subject: Your email address has been updated

Dear {{FirstName}} {{LastName}},

Your email address for the UKNF Communication Platform has been updated by a system administrator.

New Email: {{NewEmail}}
Changed By: System Administrator
Date: {{ChangeDate}}

You can now use this email address to log in to the platform:
{{LoginUrl}}

If you have any questions, please contact support:
Email: support@uknf.gov.pl
Phone: +48 22 XXX XX XX

Best regards,
UKNF IT Team
```

### Immutable Fields

**Fields that CANNOT be modified:**
- **User ID (Id):** Primary key, never changes
- **PESEL (PeselEncrypted, PeselLast4):** National ID, immutable for legal/compliance reasons
- **User Type (UserType):** Cannot convert Internal ↔ External (different workflows, requirements)
- **Created Date (CreatedDate):** Historical record

**Fields that CAN be modified:**
- First Name, Last Name (personal info updates)
- Email (with notifications and uniqueness check)
- Phone (contact info updates)
- Employee ID (for internal users, optional)
- Roles (Story 3.11)
- Active Status (Story 3.5)

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions  
**Integration Tests:** Testcontainers 3.7.0

**Test Location:**
- Unit tests: `Tests/UknfPlatform.UnitTests/Application/Admin/UpdateUserCommandHandlerTests.cs`
- Integration tests: `Tests/UknfPlatform.IntegrationTests/Controllers/UsersControllerTests.cs`

**Example:**
```csharp
[Fact]
public async Task Handle_EmailChanged_SendsNotificationsToBothEmails()
{
    // Arrange
    var user = UserFactory.CreateExternalUser("old@example.com");
    var command = new UpdateUserCommand
    {
        UserId = user.Id,
        FirstName = user.FirstName,
        LastName = user.LastName,
        Email = "new@example.com",
        Phone = user.Phone
    };
    
    _userRepositoryMock
        .Setup(r => r.GetByIdAsync(user.Id))
        .ReturnsAsync(user);
    _userRepositoryMock
        .Setup(r => r.EmailExistsAsync(command.Email))
        .ReturnsAsync(false);
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    result.EmailChanged.Should().BeTrue();
    result.NotificationSent.Should().BeTrue();
    
    _emailServiceMock.Verify(e => e.SendEmailChangedNotificationAsync(
        user.Id, "old@example.com", "new@example.com", It.IsAny<string>()),
        Times.Once);
    
    _userRepositoryMock.Verify(r => r.UpdateAsync(user), Times.Once);
}
```

### Additional Notes

1. **Email Change Security:** Sending notifications to both old and new email addresses is a security best practice. If account was compromised, legitimate owner will be alerted.

2. **Uniqueness Check:** When checking if email exists, exclude current user from check:
   ```csharp
   await _userRepository.EmailExistsAsync(newEmail, excludeUserId: currentUserId)
   ```

3. **Unsaved Changes Guard:** Consider implementing CanDeactivate guard in Angular to warn users if they try to navigate away with unsaved changes.

4. **Optimistic Concurrency:** For high-traffic systems, consider adding RowVersion for optimistic concurrency control (prevent overwriting concurrent changes).

5. **Role Editing:** This story does NOT handle role assignment changes. That's covered in Story 3.11: Assign Roles to Users.

6. **Status Changes:** This story does NOT handle Active/Inactive/Blocked status changes. That's covered in Story 3.5: Delete/Deactivate User Account.

7. **Password Changes:** This story does NOT handle password changes. That's covered in Story 3.6: Set User Password Manually.

8. **Form Pre-filling:** Frontend form must be pre-filled with current values. Use patchValue or setValue after loading user details.

9. **Validation Messages:** Show clear messages:
   - "PESEL cannot be changed"
   - "User Type cannot be changed"
   - "Email already in use by another account"

10. **Audit Log Format:** Store before/after as JSON:
    ```json
    {
      "before": { "email": "old@example.com", "phone": "+48111111111" },
      "after": { "email": "new@example.com", "phone": "+48222222222" }
    }
    ```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

