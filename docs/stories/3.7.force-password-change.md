# Story 3.7: Force Password Change

**Epic:** 3 - Administrative Module - User & Role Management  
**Story Number:** 3.7  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As a** System Administrator,  
**I want to** force one or multiple users to change their passwords on next login,  
**So that** I can ensure security compliance across the organization without setting passwords myself.

---

## Acceptance Criteria

1. System Administrator can select one or multiple users
2. Administrator triggers "Force Password Change" action
3. Selected users are flagged in system as requiring password change
4. Upon next login, flagged users are redirected to password change page (before accessing any other feature)
5. Users cannot dismiss or skip the password change requirement
6. Users must provide current password and new password (following normal password change flow)
7. New password must meet all policy requirements
8. After successful password change, the requirement flag is automatically cleared
9. Users can then proceed to use the platform normally
10. Users receive email notification of forced password change requirement
11. Action is logged with timestamp, affected users, and administrator ID
12. Administrator can optionally include a reason/message for the users

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create ForcePasswordChangeCommand** (AC: 1, 9)
  - [ ] Create `ForcePasswordChangeCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserId (Guid, required) - user who must change password
    - Reason (string, optional) - reason for requirement (shown to user)
    - NotifyUser (bool, default true) - send email notification

- [ ] **Task 2: Create ForcePasswordChangeCommandValidator** (AC: 1)
  - [ ] Create `ForcePasswordChangeCommandValidator.cs` using FluentValidation
  - [ ] Validate UserId: NotEmpty
  - [ ] Validate Reason: MaxLength(500) if provided

- [ ] **Task 3: Create ForcePasswordChangeCommandHandler** (AC: 1, 2, 8)
  - [ ] Create `ForcePasswordChangeCommandHandler.cs` implementing `IRequestHandler<ForcePasswordChangeCommand, ForcePasswordChangeResponse>`
  - [ ] Inject dependencies: IUserRepository, IEmailService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get user by UserId (404 if not found)
    - Verify user is active (cannot force password change on inactive/deleted users)
    - Set MustChangePassword flag via domain method `user.RequirePasswordChange(reason)`
    - Save to repository
    - If NotifyUser is true, send email notification with reason
    - Create audit log entry
    - Return ForcePasswordChangeResponse
  - [ ] Use transaction

- [ ] **Task 4: Update User domain entity** (AC: 1, 6)
  - [ ] Open `User.cs` in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add domain method: `RequirePasswordChange(reason)`
  - [ ] Method sets MustChangePassword = true
  - [ ] Sets UpdatedDate
  - [ ] Optionally store reason in new field or return for handler to store
  - [ ] Add domain method: `CompletePasswordChange()`
  - [ ] Method sets MustChangePassword = false
  - [ ] Sets UpdatedDate

- [ ] **Task 5: Create ForcePasswordChangeResponse DTO** (AC: 1, 2, 8)
  - [ ] Create `ForcePasswordChangeResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - UserId (Guid)
    - Message (string)
    - NotificationSent (bool)
    - Reason (string)
    - PerformedDate (DateTime)
    - PerformedBy (string)

- [ ] **Task 6: Create REST API endpoint POST /api/admin/users/{id}/force-password-change** (AC: 1)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create POST action `ForcePasswordChangeAsync(Guid id, ForcePasswordChangeCommand command)`
  - [ ] Ensure id parameter matches command.UserId
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with ForcePasswordChangeResponse
  - [ ] Return 400 Bad Request if user is inactive
  - [ ] Return 404 Not Found if user doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 7: Create forced password change notification email template** (AC: 2, 9)
  - [ ] Create `PasswordChangeRequiredNotification.cshtml` in `Infrastructure/UknfPlatform.Infrastructure.Email/Templates/`
  - [ ] Template content:
    - Subject: "Action Required: Password Change Required"
    - Message: System administrator requires you to change password on next login
    - Reason (if provided): "{{Reason}}"
    - Login URL
    - Instructions: "When you log in, you will be prompted to change your password."
    - Support contact info

- [ ] **Task 8: Update IEmailService** (AC: 2)
  - [ ] Update `IEmailService.cs` in `Application/UknfPlatform.Application.Shared/Interfaces/`
  - [ ] Add method: `SendPasswordChangeRequiredNotificationAsync(userId, email, userName, reason)`
  - [ ] Implement in `EmailService.cs` using template

- [ ] **Task 9: Create audit log entry** (AC: 8)
  - [ ] After setting flag, insert AuditLog entry
  - [ ] AuditLog properties:
    - UserId = administrator who forced password change
    - EntityType = "User"
    - EntityPrimaryKey = target user's ID
    - Action = "ForcePasswordChange"
    - Timestamp = DateTime.UtcNow
    - AfterState = JSON with MustChangePassword=true, Reason
  - [ ] Include reason if provided

- [ ] **Task 10: Update LoginCommandHandler to check MustChangePassword flag** (AC: 3, 4)
  - [ ] Open `LoginCommandHandler.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] After successful authentication, check if user.MustChangePassword is true
  - [ ] If true, include flag in LoginResponse
  - [ ] Frontend will use this to redirect to password change screen

- [ ] **Task 11: Update LoginResponse DTO** (AC: 3)
  - [ ] Open `LoginResponse.cs` in `Application/UknfPlatform.Application.Auth/Authentication/DTOs/`
  - [ ] Add property: `MustChangePassword` (bool)
  - [ ] This signals frontend to redirect to password change

- [ ] **Task 12: Update ChangePasswordCommandHandler to clear flag** (AC: 6)
  - [ ] Open `ChangePasswordCommandHandler.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/` (from Story 1.6)
  - [ ] After successful password change, call `user.CompletePasswordChange()`
  - [ ] This clears MustChangePassword flag
  - [ ] User can now use platform normally

- [ ] **Task 13: Create GET endpoint to check current user's MustChangePassword status** (AC: 4)
  - [ ] In `UsersController.cs` or `AuthController.cs`
  - [ ] Create GET action `GetCurrentUserPasswordStatusAsync()`
  - [ ] Returns object with MustChangePassword flag
  - [ ] Used by frontend on app initialization to check if password change required
  - [ ] Requires authentication

- [ ] **Task 14: Create BulkForcePasswordChangeCommand** (AC: 1, 2, 12)
  - [ ] Create `BulkForcePasswordChangeCommand.cs` in `Application/UknfPlatform.Application.Admin/Users/Commands/`
  - [ ] Command properties:
    - UserIds (List<Guid>, required) - users who must change passwords
    - Reason (string, optional) - reason for requirement (shown to users)
    - NotifyUsers (bool, default true) - send email notifications

- [ ] **Task 15: Create BulkForcePasswordChangeCommandValidator** (AC: 1)
  - [ ] Create `BulkForcePasswordChangeCommandValidator.cs` using FluentValidation
  - [ ] Validate UserIds: NotEmpty, Must contain at least 1 user, Maximum 100 users (prevent abuse)
  - [ ] Validate Reason: MaxLength(500) if provided

- [ ] **Task 16: Create BulkForcePasswordChangeCommandHandler** (AC: 1, 2, 3, 10, 11, 12)
  - [ ] Create `BulkForcePasswordChangeCommandHandler.cs` implementing `IRequestHandler<BulkForcePasswordChangeCommand, BulkForcePasswordChangeResponse>`
  - [ ] Inject dependencies: IUserRepository, IEmailService, ICurrentUserService, ILogger, IUnitOfWork
  - [ ] Handler logic:
    - Get all users by UserIds
    - Filter out inactive/deleted users (log warnings for skipped users)
    - For each active user:
      - Set MustChangePassword flag via domain method `user.RequirePasswordChange(reason)`
      - Add to success list
    - Save all changes to repository
    - If NotifyUsers is true, send email notification to each user (parallel/batch)
    - Create audit log entry with all affected user IDs
    - Return BulkForcePasswordChangeResponse with success/failure counts
  - [ ] Use transaction
  - [ ] Handle partial failures gracefully (some users succeed, some fail)

- [ ] **Task 17: Create BulkForcePasswordChangeResponse DTO** (AC: 1, 3, 10, 11)
  - [ ] Create `BulkForcePasswordChangeResponse.cs` record in `Application/UknfPlatform.Application.Admin/Users/DTOs/`
  - [ ] Properties:
    - TotalRequested (int) - total users requested
    - SuccessCount (int) - users successfully flagged
    - FailureCount (int) - users that failed/were skipped
    - SuccessfulUserIds (List<Guid>) - users successfully flagged
    - FailedUsers (List<BulkOperationFailure>) - users that failed with reasons
    - NotificationsSent (int) - emails sent
    - Reason (string) - reason provided
    - PerformedDate (DateTime)
    - PerformedBy (string)
  - [ ] Create `BulkOperationFailure` record: UserId, UserName, FailureReason

- [ ] **Task 18: Create REST API endpoint POST /api/admin/users/bulk/force-password-change** (AC: 1, 2)
  - [ ] Update `UsersController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[Authorize(Policy = "SystemAdministrator")]` attribute
  - [ ] Create POST action `BulkForcePasswordChangeAsync(BulkForcePasswordChangeCommand command)`
  - [ ] Inject IMediator
  - [ ] Send command via MediatR
  - [ ] Return 200 OK with BulkForcePasswordChangeResponse
  - [ ] Return 400 Bad Request with validation errors (empty list, too many users)
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

### Frontend Tasks

- [ ] **Task 19: Update auth service** (AC: 4)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/auth.service.ts`
  - [ ] Store MustChangePassword flag from LoginResponse
  - [ ] Add method: `mustChangePassword(): boolean`
  - [ ] Returns current user's MustChangePassword status

- [ ] **Task 20: Update users service** (AC: 1, 2)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/core/services/users.service.ts`
  - [ ] Add method: `forcePasswordChange(id, command): Observable<ForcePasswordChangeResponse>` (single user)
  - [ ] Add method: `bulkForcePasswordChange(command): Observable<BulkForcePasswordChangeResponse>` (multiple users)
  - [ ] Single: Call POST `/api/admin/users/{id}/force-password-change`
  - [ ] Bulk: Call POST `/api/admin/users/bulk/force-password-change`

- [ ] **Task 21: Enable multi-select in user list** (AC: 1)
  - [ ] Update user list component (Story 3.1)
  - [ ] Enable PrimeNG Table checkbox selection mode
  - [ ] Add `[(selection)]="selectedUsers"` binding
  - [ ] Display selection count: "X users selected"
  - [ ] Add "Clear Selection" button

- [ ] **Task 22: Add bulk "Force Password Change" action to user list** (AC: 1, 2)
  - [ ] In user list page toolbar, add "Force Password Change" button
  - [ ] Enable only when 1+ users selected (max 100)
  - [ ] Show user count in button: "Force Password Change (X users)"
  - [ ] Click opens force password change dialog with selected user IDs
  - [ ] Filter out inactive/deleted users from selection

- [ ] **Task 23: Create force password change dialog component** (AC: 1, 2, 12)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/admin/users/force-password-change-dialog/force-password-change-dialog.component.ts`
  - [ ] Standalone Angular component
  - [ ] Use as dialog (PrimeNG DynamicDialog or custom modal)
  - [ ] Inputs: 
    - userIds (single or multiple)
    - userNames (for display)
    - isBulk (boolean)
  - [ ] Form fields:
    - reason (textarea, optional, maxlength 500)
    - notifyUsers (checkbox, default checked)
  - [ ] If bulk: Display "Force password change for X users"
  - [ ] If single: Display "Force password change for [User Name]"
  - [ ] Show confirmation: List affected usernames (max 10, then "and X more...")

- [ ] **Task 24: Handle dialog submission** (AC: 1, 2, 3, 10, 11)
  - [ ] On submit, check if single or bulk operation
  - [ ] Single: call usersService.forcePasswordChange(id, command)
  - [ ] Bulk: call usersService.bulkForcePasswordChange(command)
  - [ ] Show loading spinner during submission
  - [ ] On success (200):
    - Single: "User will be required to change password on next login"
    - Bulk: "X users will be required to change password on next login"
    - If partial failure: "Y of X users flagged successfully. Z failed."
    - Show notification count if sent
    - Close dialog
    - Refresh user list
    - Clear selection
  - [ ] On error (400): Display validation errors
  - [ ] On error (404): Display "User not found" (single only)
  - [ ] Use NotificationService for toast messages

- [ ] **Task 25: Add single-user "Force Password Change" action** (AC: 1)
  - [ ] In user list page, add "Force Password Change" action per user row
  - [ ] In dropdown menu: More > Force Password Change
  - [ ] Click opens force password change dialog (single mode)
  - [ ] Disable for inactive/deleted users

- [ ] **Task 26: Add "Force Password Change" button to user details page** (AC: 1)
  - [ ] In edit/view user page, add "Force Password Change" button
  - [ ] Opens force password change dialog (single mode)
  - [ ] Available only for active users

- [ ] **Task 27: Create password change guard** (AC: 4, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/guards/password-change-required.guard.ts`
  - [ ] Implements CanActivate
  - [ ] After login, check if AuthService.mustChangePassword() returns true
  - [ ] If true, redirect to password change page
  - [ ] If false, allow navigation

- [ ] **Task 28: Apply password change guard to protected routes** (AC: 4, 5)
  - [ ] Update `src/Frontend/uknf-platform-ui/src/app/app.routes.ts`
  - [ ] Add PasswordChangeRequiredGuard to all protected routes EXCEPT password change route
  - [ ] This ensures user cannot access any feature until password is changed
  - [ ] Example:
    ```typescript
    {
      path: 'dashboard',
      canActivate: [AuthGuard, PasswordChangeRequiredGuard],
      component: DashboardComponent
    }
    ```

- [ ] **Task 29: Create forced password change screen** (AC: 4, 5, 6, 7)
  - [ ] Create or update `src/Frontend/uknf-platform-ui/src/app/features/auth/change-password/change-password.component.ts`
  - [ ] If user.MustChangePassword is true, show special message:
    - "Your password change is required by system administrator"
    - Display reason if provided
    - "You must change your password to continue"
  - [ ] Form fields:
    - currentPassword (password input, required)
    - newPassword (password input, required, with strength indicator)
    - confirmPassword (password input, required, must match)
  - [ ] Hide "Cancel" button if MustChangePassword is true (user cannot dismiss)
  - [ ] Show "Logout" link as only alternative to changing password

- [ ] **Task 30: Handle password change completion** (AC: 8, 9)
  - [ ] On successful password change, backend returns success
  - [ ] Frontend clears MustChangePassword flag in AuthService
  - [ ] Display success message: "Password changed successfully. You can now use the platform."
  - [ ] Redirect to dashboard or intended route
  - [ ] User can now navigate freely

- [ ] **Task 31: Check MustChangePassword on app initialization** (AC: 4)
  - [ ] In `src/Frontend/uknf-platform-ui/src/app/app.component.ts` or main guard
  - [ ] On app load, if user is authenticated, check MustChangePassword status
  - [ ] Call GET `/api/users/me/password-status` (or get from user profile)
  - [ ] If true, redirect to password change page
  - [ ] This handles case where admin forces password change while user is logged in

- [ ] **Task 32: Display indicator for users requiring password change** (AC: 1, 3)
  - [ ] In user list (Story 3.1), add visual indicator (icon/badge) for users with MustChangePassword=true
  - [ ] Example: Yellow warning icon with tooltip "Password change required"
  - [ ] Helps admin identify users with pending requirement

### Testing Tasks

- [ ] **Task 33: Write unit tests for ForcePasswordChangeCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidUser_SetsMustChangePasswordFlag`
  - [ ] Test: `Handle_UserNotFound_ThrowsNotFoundException`
  - [ ] Test: `Handle_InactiveUser_ThrowsBadRequestException`
  - [ ] Test: `Handle_SendsNotificationEmail`
  - [ ] Test: `Handle_CreatesAuditLog`
  - [ ] Test: `Handle_WithReason_IncludesReasonInNotification`
  - [ ] Test: `Handle_NotifyUserFalse_DoesNotSendEmail`
  - [ ] Mock: IUserRepository, IEmailService, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 34: Write unit tests for BulkForcePasswordChangeCommandHandler** (AC: 1, 2, 3, 10, 11)
  - [ ] Test: `Handle_MultipleValidUsers_SetsAllFlags`
  - [ ] Test: `Handle_PartialFailure_SomeActiveAndSomeInactive_ReturnsCorrectCounts`
  - [ ] Test: `Handle_EmptyUserList_ThrowsValidationException`
  - [ ] Test: `Handle_TooManyUsers_ThrowsValidationException` (>100)
  - [ ] Test: `Handle_SendsNotificationToAllUsers`
  - [ ] Test: `Handle_CreatesAuditLogWithAllUserIds`
  - [ ] Test: `Handle_TransactionRollsBackOnFailure`
  - [ ] Mock: IUserRepository, IEmailService, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 35: Write unit tests for User domain methods**
  - [ ] Test: `RequirePasswordChange_SetsFlagToTrue`
  - [ ] Test: `CompletePasswordChange_SetsFlagToFalse`
  - [ ] Test: Both methods update UpdatedDate

- [ ] **Task 36: Write unit tests for LoginCommandHandler update** (AC: 4)
  - [ ] Test: `Handle_UserMustChangePassword_IncludesFlagInResponse`
  - [ ] Test: `Handle_UserDoesNotMustChangePassword_FlagIsFalse`

- [ ] **Task 37: Write unit tests for ChangePasswordCommandHandler update** (AC: 8)
  - [ ] Test: `Handle_SuccessfulPasswordChange_ClearsMustChangePasswordFlag`
  - [ ] Test: `Handle_UserDidNotRequireChange_FlagRemainsFalse`

- [ ] **Task 38: Write integration test for force password change endpoint (single)**
  - [ ] Test: `POST_ForcePasswordChange_ActiveUser_Returns200AndSetsFlag`
  - [ ] Test: `POST_ForcePasswordChange_InactiveUser_Returns400`
  - [ ] Test: `POST_ForcePasswordChange_UserNotFound_Returns404`
  - [ ] Test: `POST_ForcePasswordChange_AsNonAdmin_Returns403`
  - [ ] Test: `POST_ForcePasswordChange_SendsNotification`
  - [ ] Use Testcontainers for database
  - [ ] Verify MustChangePassword flag set in database
  - [ ] Verify audit log created

- [ ] **Task 39: Write integration test for bulk force password change endpoint** (AC: 1, 2, 3, 11)
  - [ ] Test: `POST_BulkForcePasswordChange_MultipleUsers_Returns200AndSetsAllFlags`
  - [ ] Test: `POST_BulkForcePasswordChange_PartialFailure_ReturnsCorrectCounts`
  - [ ] Test: `POST_BulkForcePasswordChange_EmptyList_Returns400`
  - [ ] Test: `POST_BulkForcePasswordChange_TooManyUsers_Returns400`
  - [ ] Test: `POST_BulkForcePasswordChange_AsNonAdmin_Returns403`
  - [ ] Test: `POST_BulkForcePasswordChange_SendsNotificationsToAll`
  - [ ] Use Testcontainers for database
  - [ ] Verify all users' MustChangePassword flags set in database
  - [ ] Verify audit log created with all user IDs

- [ ] **Task 40: Write integration test for login with forced password change** (AC: 4)
  - [ ] Test: `POST_Login_UserMustChangePassword_ReturnsFlagTrue`
  - [ ] Setup: Create user with MustChangePassword=true
  - [ ] Login with valid credentials
  - [ ] Verify response includes MustChangePassword=true

- [ ] **Task 41: Write integration test for password change clearing flag** (AC: 8)
  - [ ] Test: `POST_ChangePassword_ClearsMustChangePasswordFlag`
  - [ ] Setup: Create user with MustChangePassword=true
  - [ ] Login
  - [ ] Change password
  - [ ] Verify MustChangePassword=false in database
  - [ ] Verify can now access other endpoints

- [ ] **Task 42: Write E2E test for single forced password change flow**
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Select user
    4. Click "Force Password Change"
    5. Enter reason
    6. Submit
    7. Verify success message
    8. Logout
    9. Login as that user
    10. Verify redirected to password change page
    11. Verify cannot access other pages
    12. Change password
    13. Verify redirected to dashboard
    14. Verify can now access other pages
  - [ ] Use Cypress or Playwright

- [ ] **Task 43: Write E2E test for bulk forced password change flow** (AC: 1, 2, 3)
  - [ ] Test workflow:
    1. Login as System Administrator
    2. Navigate to Admin > Users
    3. Select multiple users (5 users)
    4. Click bulk "Force Password Change" button
    5. Enter reason
    6. Submit
    7. Verify success message: "5 users will be required to change password"
    8. Logout
    9. Login as first affected user
    10. Verify redirected to password change page
    11. Change password
    12. Verify can access platform
  - [ ] Use Cypress or Playwright

---

## Dev Notes

### Previous Story Context

**From Story 3.6:**
- Password setting infrastructure
- Password policy validation
- Session invalidation patterns

**From Story 1.6:**
- User self-service password change flow
- Password change validation

**Key Integration:**
- This story REQUIRES Story 1.6 (Change Password) to be implemented
- User will use normal password change flow, but cannot skip it
- Different from Story 3.6: Admin doesn't set password, just requires user to change it

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0

**Frontend Stack:**
- Framework: Angular 20.x
- UI Library: PrimeNG
- Routing: Angular Router with Guards
- Styling: Tailwind CSS

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── UsersController.cs (UPDATE - add ForcePasswordChangeAsync, BulkForcePasswordChangeAsync)
├── Application/UknfPlatform.Application.Admin/Users/
│   ├── Commands/
│   │   ├── ForcePasswordChangeCommand.cs (CREATE - single user)
│   │   ├── ForcePasswordChangeCommandHandler.cs (CREATE)
│   │   ├── ForcePasswordChangeCommandValidator.cs (CREATE)
│   │   ├── BulkForcePasswordChangeCommand.cs (CREATE - multiple users)
│   │   ├── BulkForcePasswordChangeCommandHandler.cs (CREATE)
│   │   └── BulkForcePasswordChangeCommandValidator.cs (CREATE)
│   └── DTOs/
│       ├── ForcePasswordChangeResponse.cs (CREATE)
│       ├── BulkForcePasswordChangeResponse.cs (CREATE)
│       └── BulkOperationFailure.cs (CREATE)
├── Application/UknfPlatform.Application.Auth/Authentication/
│   ├── Commands/
│   │   ├── LoginCommandHandler.cs (UPDATE - add MustChangePassword check)
│   │   └── ChangePasswordCommandHandler.cs (UPDATE - clear flag)
│   └── DTOs/
│       └── LoginResponse.cs (UPDATE - add MustChangePassword property)
├── Domain/UknfPlatform.Domain.Auth/Entities/
│   └── User.cs (UPDATE - add RequirePasswordChange, CompletePasswordChange methods)
└── Infrastructure/UknfPlatform.Infrastructure.Email/Templates/
    └── PasswordChangeRequiredNotification.cshtml (CREATE)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/
│   ├── guards/
│   │   └── password-change-required.guard.ts (CREATE)
│   └── services/
│       ├── auth.service.ts (UPDATE)
│       └── users.service.ts (UPDATE)
├── features/admin/users/force-password-change-dialog/
│   ├── force-password-change-dialog.component.ts (CREATE)
│   ├── force-password-change-dialog.component.html (CREATE)
│   └── force-password-change-dialog.component.scss (CREATE)
└── features/auth/change-password/
    ├── change-password.component.ts (UPDATE - handle forced change)
    └── change-password.component.html (UPDATE - show reason, hide cancel)
```

### Data Models

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table (existing field):**
```sql
-- This field already exists in schema
MustChangePassword BIT NOT NULL DEFAULT 0,
```

**User Domain Entity:**
```csharp
public class User : BaseEntity
{
    // ... existing properties
    public bool MustChangePassword { get; private set; }
    
    // New domain methods
    public void RequirePasswordChange(string? reason = null)
    {
        MustChangePassword = true;
        UpdatedDate = DateTime.UtcNow;
        // Optionally raise domain event
    }
    
    public void CompletePasswordChange()
    {
        MustChangePassword = false;
        UpdatedDate = DateTime.UtcNow;
        // Optionally raise domain event
    }
}
```

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint 1:** POST `/api/admin/users/{id}/force-password-change` (Single User)
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "reason": "Security policy requires all users to update passwords quarterly",
    "notifyUser": true
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "User will be required to change password on next login",
    "notificationSent": true,
    "reason": "Security policy requires all users to update passwords quarterly",
    "performedDate": "2025-10-04T16:30:00Z",
    "performedBy": "admin@uknf.gov.pl"
  }
  ```
- **Error Responses:**
  - 400: Bad Request (user is inactive/deleted)
  - 404: Not Found (user doesn't exist)
  - 403: Forbidden

**Endpoint 2:** POST `/api/admin/users/bulk/force-password-change` (Multiple Users)
- **Security:** Requires authentication + "System Administrator" role
- **Request Body:**
  ```json
  {
    "userIds": [
      "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "7da85f64-5717-4562-b3fc-2c963f66afa7",
      "9ba85f64-5717-4562-b3fc-2c963f66afa8"
    ],
    "reason": "Quarterly security policy compliance",
    "notifyUsers": true
  }
  ```
- **Success Response (200 OK):**
  ```json
  {
    "totalRequested": 3,
    "successCount": 2,
    "failureCount": 1,
    "successfulUserIds": [
      "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "7da85f64-5717-4562-b3fc-2c963f66afa7"
    ],
    "failedUsers": [
      {
        "userId": "9ba85f64-5717-4562-b3fc-2c963f66afa8",
        "userName": "Jan Kowalski",
        "failureReason": "User is inactive"
      }
    ],
    "notificationsSent": 2,
    "reason": "Quarterly security policy compliance",
    "performedDate": "2025-10-04T16:30:00Z",
    "performedBy": "admin@uknf.gov.pl"
  }
  ```
- **Error Responses:**
  - 400: Bad Request (empty list, too many users >100, validation errors)
  - 403: Forbidden

**Updated Endpoint:** POST `/api/auth/login`
- **Response includes MustChangePassword flag:**
  ```json
  {
    "accessToken": "eyJhbGc...",
    "refreshToken": "dGhpc2lz...",
    "expiresIn": 3600,
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "email": "user@example.com",
    "firstName": "Jan",
    "lastName": "Kowalski",
    "mustChangePassword": true
  }
  ```

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES:**

1. **Use domain methods for business logic**
   ```csharp
   // ✅ CORRECT
   user.RequirePasswordChange(reason);
   
   // ❌ WRONG - Don't set flag directly
   // user.MustChangePassword = true;
   ```

2. **Guard all routes except password change when flag is true**
   ```typescript
   // ✅ CORRECT
   {
     path: 'dashboard',
     canActivate: [AuthGuard, PasswordChangeRequiredGuard],
     component: DashboardComponent
   }
   ```

3. **Clear flag after successful password change**
   ```csharp
   // ✅ CORRECT
   user.ChangePassword(newPasswordHash);
   user.CompletePasswordChange(); // Clear flag
   ```

4. **Do not allow dismissing password change requirement**
   ```typescript
   // ✅ CORRECT - Hide cancel button if must change password
   <button *ngIf="!mustChangePassword" (click)="cancel()">Cancel</button>
   
   // ❌ WRONG - Don't let user skip
   // <button (click)="skip()">Skip</button>
   ```

### Email Template

**Password Change Required Notification:**
```html
Subject: Action Required: Password Change Required

Dear {{FirstName}} {{LastName}},

A system administrator has required you to change your password on your next login to the UKNF Communication Platform.

{{#if Reason}}
Reason: {{Reason}}
{{/if}}

What you need to do:
1. Log in to the platform: {{LoginUrl}}
2. You will be automatically prompted to change your password
3. Choose a new password that meets our security requirements
4. After changing your password, you can continue using the platform normally

You will not be able to access any features until you change your password.

Changed By: System Administrator
Date: {{RequirementDate}}

If you have any questions or need assistance, please contact support:
Email: support@uknf.gov.pl
Phone: +48 22 XXX XX XX

Best regards,
UKNF IT Team
```

### Frontend Guard Implementation

**PasswordChangeRequiredGuard:**
```typescript
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { AuthService } from '../services/auth.service';

export const passwordChangeRequiredGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);
  
  // Check if user must change password
  if (authService.mustChangePassword()) {
    // Redirect to password change page
    router.navigate(['/auth/change-password'], {
      queryParams: { returnUrl: state.url, forced: true }
    });
    return false;
  }
  
  return true;
};
```

### Forced Password Change Screen

**Special UI for Forced Change:**
```typescript
export class ChangePasswordComponent implements OnInit {
  isForced = false;
  reason?: string;
  
  ngOnInit() {
    // Check if this is a forced password change
    this.isForced = this.authService.mustChangePassword();
    
    // Get reason from route params or API
    this.route.queryParams.subscribe(params => {
      if (params['forced']) {
        this.loadForcedChangeReason();
      }
    });
  }
  
  canCancel(): boolean {
    // Cannot cancel if forced
    return !this.isForced;
  }
  
  onSubmit() {
    // Normal password change flow
    this.authService.changePassword(this.form.value).subscribe({
      next: () => {
        // Flag automatically cleared by backend
        this.notificationService.success('Password changed successfully');
        
        // Redirect to intended route or dashboard
        const returnUrl = this.route.snapshot.queryParams['returnUrl'] || '/dashboard';
        this.router.navigate([returnUrl]);
      },
      error: (err) => {
        this.notificationService.error('Failed to change password');
      }
    });
  }
  
  logout() {
    // Only option if user doesn't want to change password
    this.authService.logout();
    this.router.navigate(['/auth/login']);
  }
}
```

**Template:**
```html
<div class="password-change-container">
  <div *ngIf="isForced" class="alert alert-warning">
    <i class="pi pi-exclamation-triangle"></i>
    <h3>Password Change Required</h3>
    <p>A system administrator has required you to change your password.</p>
    <p *ngIf="reason" class="reason"><strong>Reason:</strong> {{ reason }}</p>
    <p>You must change your password to continue using the platform.</p>
  </div>
  
  <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()">
    <div class="field">
      <label for="currentPassword">Current Password</label>
      <input type="password" pInputText formControlName="currentPassword" />
    </div>
    
    <div class="field">
      <label for="newPassword">New Password</label>
      <p-password formControlName="newPassword" [feedback]="true"></p-password>
    </div>
    
    <div class="field">
      <label for="confirmPassword">Confirm New Password</label>
      <input type="password" pInputText formControlName="confirmPassword" />
    </div>
    
    <div class="actions">
      <button type="submit" pButton label="Change Password" [disabled]="!passwordForm.valid"></button>
      <button *ngIf="canCancel()" type="button" pButton label="Cancel" class="p-button-secondary" (click)="cancel()"></button>
      <a *ngIf="isForced" (click)="logout()" class="logout-link">Logout instead</a>
    </div>
  </form>
</div>
```

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions

**Example:**
```csharp
[Fact]
public async Task Handle_ActiveUser_SetsMustChangePasswordFlag()
{
    // Arrange
    var user = UserFactory.CreateActiveUser();
    var command = new ForcePasswordChangeCommand
    {
        UserId = user.Id,
        Reason = "Security audit requirement",
        NotifyUser = true
    };
    
    _userRepositoryMock
        .Setup(r => r.GetByIdAsync(user.Id))
        .ReturnsAsync(user);
    
    _emailServiceMock
        .Setup(s => s.SendPasswordChangeRequiredNotificationAsync(
            user.Id, user.Email, user.FullName, command.Reason))
        .Returns(Task.CompletedTask);
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    user.MustChangePassword.Should().BeTrue();
    result.NotificationSent.Should().BeTrue();
    result.Reason.Should().Be(command.Reason);
    
    _userRepositoryMock.Verify(r => r.UpdateAsync(user), Times.Once);
    _emailServiceMock.Verify(
        s => s.SendPasswordChangeRequiredNotificationAsync(
            user.Id, user.Email, user.FullName, command.Reason),
        Times.Once);
}
```

### Additional Notes

1. **Difference from Story 3.6:**
   - Story 3.6: Admin sets new password for user
   - Story 3.7: Admin requires user to change password themselves

2. **User Cannot Skip:** Critical security requirement. User must change password before accessing any feature.

3. **Logout as Alternative:** User can logout if they don't want to change password, but cannot access platform without changing it.

4. **Reason Field:** Optional but recommended. Helps user understand why change is required. Examples:
   - "Security policy requires password change every 90 days"
   - "Suspicious activity detected on your account"
   - "System-wide password reset after security incident"

5. **Integration with Story 1.6:** This story extends the normal password change flow (Story 1.6) with forced requirement logic.

6. **Check on Every Request:** Backend should verify MustChangePassword flag on sensitive operations (or use middleware/filter to block all requests).

7. **Visual Indicators:** In admin UI, show which users have pending password change requirement (helps admin track compliance).

8. **Bulk Operation (IMPLEMENTED):** This story includes bulk force password change for multiple users per PRD requirements. System handles both single user and bulk operations.

9. **Bulk Limitations:** Maximum 100 users per bulk operation to prevent abuse and performance issues. Frontend should enforce this limit.

10. **Partial Failures:** Bulk operation handles partial failures gracefully - some users may succeed while others fail (e.g., inactive users). Response includes detailed success/failure counts.

11. **Expiration:** Consider adding expiration date for requirement (e.g., "must change within 7 days"). Not in this story, but good enhancement.

12. **Clear Flag Only on Success:** MustChangePassword flag should only be cleared after successful password change, not on attempt failure.

13. **Multi-Select UX:** User list should use PrimeNG Table checkbox selection for intuitive bulk operations. Show count of selected users.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 3 | Scrum Master (AI) |
| 2025-10-04 | 1.1 | Updated to include bulk operations (one or multiple users) per PRD requirements | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

