# Story 1.1: External User Registration Form

**Epic:** 1 - Authentication & User Registration  
**Story Number:** 1.1  
**Created:** 2025-10-04

---

## Status

**Draft**

---

## Story

**As an** external user (representative of a supervised entity),  
**I want to** register for a system account via an online form,  
**so that** I can gain access to communicate with UKNF through the platform.

---

## Acceptance Criteria

1. Online registration form is publicly accessible (no authentication required)
2. Form includes mandatory fields: First name, Last name, PESEL (masked, last 4 digits visible), phone number, email
3. Form validates all required fields before submission
4. PESEL field is properly masked showing only last 4 digits
5. Email format is validated
6. Phone number format is validated (international format: `/^\+(?:[0-9] ?){6,14}[0-9]$/`)
7. Successful registration creates an inactive user account in the system
8. User receives confirmation message after successful registration submission

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create User domain entity** (AC: 2, 3, 7)
  - [ ] Create `User.cs` entity in `Domain/UknfPlatform.Domain.Auth/Entities/`
  - [ ] Add properties: Id, FirstName, LastName, Email, Phone, PeselEncrypted, PeselLast4, PasswordHash, UserType (External), IsActive (false), CreatedDate, UpdatedDate
  - [ ] Implement private setters for encapsulation
  - [ ] Add domain method `Create()` to instantiate new user
  - [ ] Add validation logic in domain entity

- [ ] **Task 2: Create database schema for Users table** (AC: 7)
  - [ ] Create EF Core entity configuration in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Configurations/UserConfiguration.cs`
  - [ ] Configure table name, primary key (Guid), indexes (Email, UserType, IsActive)
  - [ ] Configure PESEL encryption mapping (PeselEncrypted, PeselLast4)
  - [ ] Add EF Core migration `Add_Users_Table`
  - [ ] Ensure CreatedDate/UpdatedDate auto-populate

- [ ] **Task 3: Create RegisterUserCommand and Handler (CQRS)** (AC: 2, 3, 7)
  - [ ] Create `RegisterUserCommand.cs` in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] Add command properties: FirstName, LastName, Email, Phone, Pesel
  - [ ] Create `RegisterUserCommandHandler.cs` implementing `IRequestHandler<RegisterUserCommand, RegisterUserResponse>`
  - [ ] Inject dependencies: IUserRepository, IPasswordHasher, IEmailService, ILogger
  - [ ] Implement handler logic:
    - Check if email already exists (return 409 Conflict)
    - Check if PESEL already exists (return 409 Conflict)
    - Encrypt full PESEL, store last 4 digits separately
    - Create User entity via domain method
    - Save to repository
    - Generate account activation token (24-hour expiry)
    - Send activation email (story 1.2 dependency)
    - Return success response
  - [ ] Log all actions with correlation ID

- [ ] **Task 4: Create FluentValidation validator for RegisterUserCommand** (AC: 3, 5, 6)
  - [ ] Create `RegisterUserCommandValidator.cs` in same directory as command
  - [ ] Validate FirstName: NotEmpty, MaxLength(100)
  - [ ] Validate LastName: NotEmpty, MaxLength(100)
  - [ ] Validate Email: NotEmpty, EmailAddress format, MaxLength(256)
  - [ ] Validate Phone: NotEmpty, Matches regex `/^\+(?:[0-9] ?){6,14}[0-9]$/`
  - [ ] Validate Pesel: NotEmpty, Exactly 11 digits
  - [ ] Add custom validation messages

- [ ] **Task 5: Create RegisterUserResponse DTO** (AC: 8)
  - [ ] Create `RegisterUserResponse.cs` record in `Application/UknfPlatform.Application.Auth/Authentication/Commands/`
  - [ ] Properties: UserId (Guid), Message (string)
  - [ ] Use C# record type for immutability

- [ ] **Task 6: Create REST API endpoint POST /auth/register** (AC: 1, 8)
  - [ ] Create `AuthController.cs` in `Api/UknfPlatform.Api/Controllers/`
  - [ ] Add `[AllowAnonymous]` attribute (no authentication required)
  - [ ] Create POST action `RegisterAsync(RegisterUserCommand command)`
  - [ ] Inject IMediator to send command
  - [ ] Return 201 Created with RegisterUserResponse on success
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 409 Conflict if email/PESEL already exists
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 7: Create User repository** (AC: 7)
  - [ ] Create `IUserRepository.cs` interface in `Domain/UknfPlatform.Domain.Auth/`
  - [ ] Define methods: GetByEmailAsync, GetByPeselAsync, AddAsync, ExistsAsync
  - [ ] Create `UserRepository.cs` implementation in `Infrastructure/UknfPlatform.Infrastructure.Persistence/Repositories/`
  - [ ] Inject ApplicationDbContext
  - [ ] Implement repository methods using EF Core
  - [ ] Use async/await pattern with proper naming (Async suffix)

### Frontend Tasks

- [ ] **Task 8: Create registration page component** (AC: 1, 2, 4)
  - [ ] Create Angular standalone component `src/Frontend/uknf-platform-ui/src/app/features/auth/register/register.component.ts`
  - [ ] Create component template with registration form
  - [ ] Use PrimeNG form components (InputText, Button)
  - [ ] Style with Tailwind CSS utility classes
  - [ ] Form fields: firstName, lastName, pesel, email, phone
  - [ ] Configure routing: `/auth/register` (no auth required)

- [ ] **Task 9: Implement form validation (client-side)** (AC: 3, 4, 5, 6)
  - [ ] Create reactive form with FormBuilder
  - [ ] Add validators for all fields:
    - firstName/lastName: Validators.required, Validators.maxLength(100)
    - email: Validators.required, Validators.email
    - phone: Validators.required, Validators.pattern(/^\+(?:[0-9] ?){6,14}[0-9]$/)
    - pesel: Validators.required, Validators.pattern(/^\d{11}$/)
  - [ ] Implement PESEL masking directive (show only last 4 digits as user types)
  - [ ] Display validation error messages below each field
  - [ ] Disable submit button until form is valid

- [ ] **Task 10: Create AuthService with register method** (AC: 7, 8)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/core/services/auth.service.ts`
  - [ ] Inject HttpClient
  - [ ] Implement `register(registerData)` method calling POST /api/auth/register
  - [ ] Return Observable<RegisterResponse>
  - [ ] Use catchError for error handling
  - [ ] Add proper error notifications

- [ ] **Task 11: Handle registration submission and response** (AC: 8)
  - [ ] On form submit, call authService.register()
  - [ ] Show loading spinner during submission
  - [ ] On success (201):
    - Display success message: "Registration successful. Please check your email to activate your account."
    - Navigate to login page after 3 seconds
  - [ ] On error (400): Display validation errors from backend
  - [ ] On error (409): Display "Email or PESEL already registered" message
  - [ ] Use NotificationService (create if doesn't exist) for toast messages

- [ ] **Task 12: Create registration page layout** (AC: 1, 2)
  - [ ] Use auth-layout component (centered form, no navigation)
  - [ ] Add UKNF branding/logo
  - [ ] Add "Already have an account? Login" link
  - [ ] Ensure responsive design (mobile-friendly)
  - [ ] Add accessibility attributes (ARIA labels)

### Testing Tasks

- [ ] **Task 13: Write unit tests for RegisterUserCommandHandler** (AC: All)
  - [ ] Test: `Handle_ValidCommand_CreatesInactiveUser`
  - [ ] Test: `Handle_ExistingEmail_ThrowsConflictException`
  - [ ] Test: `Handle_ExistingPesel_ThrowsConflictException`
  - [ ] Test: `Handle_ValidCommand_EncryptsPeselAndStoresLast4Digits`
  - [ ] Test: `Handle_ValidCommand_SendsActivationEmail`
  - [ ] Test: `Handle_ValidCommand_LogsRegistrationEvent`
  - [ ] Mock: IUserRepository, IPasswordHasher, IEmailService, ILogger
  - [ ] Use AAA pattern, FluentAssertions

- [ ] **Task 14: Write unit tests for RegisterUserCommandValidator**
  - [ ] Test: Email validation (valid, invalid, empty)
  - [ ] Test: Phone validation (valid international, invalid format)
  - [ ] Test: PESEL validation (valid 11 digits, invalid length, non-numeric)
  - [ ] Test: Required field validation (FirstName, LastName)

- [ ] **Task 15: Write integration test for registration endpoint**
  - [ ] Test: `POST_Register_WithValidData_Returns201AndCreatesUser`
  - [ ] Test: `POST_Register_WithExistingEmail_Returns409`
  - [ ] Test: `POST_Register_WithInvalidEmail_Returns400`
  - [ ] Test: `POST_Register_WithInvalidPhone_Returns400`
  - [ ] Use Testcontainers for real PostgreSQL database
  - [ ] Verify user exists in database after successful registration
  - [ ] Verify email is sent (mock SMTP or use MailDev)

---

## Dev Notes

### Architecture Context

**Source:** `docs/architecture/section-3-tech-stack.md`

**Backend Stack:**
- Language: C# 12.0
- Runtime: .NET 8.0 LTS
- Framework: ASP.NET Core Web API 8.0
- ORM: Entity Framework Core 8.0
- Database: PostgreSQL 16.3 (can swap to SQL Server easily)
- Validation: FluentValidation 11.9.0
- CQRS: MediatR 12.4.0
- Logging: Serilog 3.1.1
- Mapping: Mapster 7.4.0
- Email: MailKit 4.4.0
- API Documentation: Swashbuckle (Swagger) 6.5.0

**Frontend Stack:**
- Framework: Angular 20.x (standalone components)
- UI Library: PrimeNG
- Styling: Tailwind CSS
- TypeScript: 5.3+ (strict mode enabled)

### Project Structure

**Source:** `docs/architecture/section-10-source-tree.md`

Backend files location:
```
src/Backend/
├── Api/UknfPlatform.Api/Controllers/
│   └── AuthController.cs (CREATE THIS)
├── Application/UknfPlatform.Application.Auth/Authentication/
│   ├── Commands/
│   │   ├── RegisterUserCommand.cs (CREATE THIS)
│   │   ├── RegisterUserCommandHandler.cs (CREATE THIS)
│   │   └── Validators/
│   │       └── RegisterUserCommandValidator.cs (CREATE THIS)
├── Domain/UknfPlatform.Domain.Auth/
│   └── Entities/
│       └── User.cs (CREATE THIS)
├── Infrastructure/UknfPlatform.Infrastructure.Persistence/
│   ├── Configurations/
│   │   └── UserConfiguration.cs (CREATE THIS)
│   ├── Migrations/ (EF Core will generate)
│   └── Repositories/
│       └── UserRepository.cs (CREATE THIS)
```

Frontend files location:
```
src/Frontend/uknf-platform-ui/src/app/
├── core/services/
│   └── auth.service.ts (CREATE THIS)
├── features/auth/register/
│   ├── register.component.ts (CREATE THIS)
│   ├── register.component.html (CREATE THIS)
│   └── register.component.scss (CREATE THIS)
```

### Data Model

**Source:** `docs/architecture/section-4-data-models.md`, `docs/architecture/section-9-database-schema.md`

**Users Table Schema:**
```sql
CREATE TABLE Users (
    Id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    Phone NVARCHAR(20) NOT NULL,
    PeselEncrypted NVARCHAR(500) NOT NULL,
    PeselLast4 NVARCHAR(4) NOT NULL,
    PasswordHash NVARCHAR(500) NOT NULL,
    UserType NVARCHAR(20) NOT NULL CHECK (UserType IN ('Internal', 'External')),
    IsActive BIT NOT NULL DEFAULT 1,
    MustChangePassword BIT NOT NULL DEFAULT 0,
    LastLoginDate DATETIME2 NULL,
    CreatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedDate DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
    INDEX IX_Users_Email (Email),
    INDEX IX_Users_UserType (UserType),
    INDEX IX_Users_IsActive (IsActive)
);
```

**Key Points:**
- Id is UUID (Guid in C#)
- Email must be unique
- PESEL is encrypted (PeselEncrypted) but last 4 digits stored separately (PeselLast4) for display
- UserType for this story is always "External"
- IsActive defaults to true, but for registration should be set to false (inactive until email activation)
- Dates stored in UTC (use DateTime.UtcNow)

### REST API Specification

**Source:** `docs/architecture/section-8-rest-api-spec.md`

**Endpoint:** POST `/api/auth/register`
- **Security:** None (public endpoint, no authentication required)
- **Request Body:**
  ```json
  {
    "firstName": "Jan",
    "lastName": "Kowalski",
    "pesel": "12345678901",
    "email": "jan.kowalski@example.com",
    "phone": "+48123456789"
  }
  ```
- **Success Response (201 Created):**
  ```json
  {
    "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "message": "Registration successful. Please check your email to activate your account."
  }
  ```
- **Error Responses:**
  - 400 Bad Request: Validation errors
  - 409 Conflict: Email or PESEL already exists

### Coding Standards

**Source:** `docs/architecture/section-13-coding-standards.md`

**CRITICAL RULES TO FOLLOW:**

1. **Never use Console.WriteLine** - Use ILogger<T> dependency injection
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation("User registered {Email}", email);
   ```

2. **All API responses MUST use DTOs** - Never return domain entities directly
   ```csharp
   // ✅ CORRECT
   public async Task<RegisterUserResponse> RegisterAsync(RegisterUserCommand command)
   ```

3. **All commands MUST have FluentValidation validators**
   ```csharp
   // ✅ REQUIRED
   public class RegisterUserCommandValidator : AbstractValidator<RegisterUserCommand>
   ```

4. **All async methods MUST end with 'Async' suffix**
   ```csharp
   // ✅ CORRECT
   public async Task<User> GetByEmailAsync(string email)
   ```

5. **Entity properties MUST be private set**
   ```csharp
   // ✅ CORRECT
   public class User {
       public string Email { get; private set; }
   }
   ```

6. **NEVER store sensitive data in logs** - No PESEL, passwords, full email in logs
   ```csharp
   // ✅ CORRECT
   _logger.LogInformation("User registered {UserId}", userId);
   ```

7. **All dates MUST be stored in UTC**
   ```csharp
   // ✅ CORRECT
   CreatedDate = DateTime.UtcNow;
   ```

8. **Phone validation regex:** `/^\+(?:[0-9] ?){6,14}[0-9]$/`

9. **Use record types for DTOs**
   ```csharp
   // ✅ CORRECT
   public record RegisterUserResponse(Guid UserId, string Message);
   ```

10. **Angular services MUST handle errors with catchError**
    ```typescript
    // ✅ CORRECT
    return this.http.post('/api/auth/register', data).pipe(
      catchError(error => {
        this.notificationService.showError('Registration failed');
        return throwError(() => error);
      })
    );
    ```

### Security Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#2-security`, Epic 1 Technical Considerations

1. **Password Hashing:** Use industry-standard algorithm (bcrypt, Argon2)
   - Note: This story doesn't handle passwords yet (Story 1.3), but prepare infrastructure
2. **PESEL Encryption:** Encrypt full PESEL, store last 4 digits separately for display
3. **Email Validation:** Standard email format validation
4. **Phone Validation:** International format `/^\+(?:[0-9] ?){6,14}[0-9]$/`
5. **CSRF Protection:** Angular HttpClient provides this by default
6. **Input Sanitization:** Prevent injection attacks (EF Core parameterizes queries)

### Audit Requirements

**Source:** `docs/prd/b-specification-of-non-functional-requirements.md#22-audit-and-login`

- Log all registration events
- Include timestamp, user ID (after creation), email (masked in logs)
- Use structured logging with Serilog
- Correlation IDs for request tracking

### Email Service Integration

**Note:** Story 1.1 depends on email service for activation link, which is fully implemented in Story 1.2. For this story:
- Create email service interface and placeholder implementation
- OR mock email service in handler
- OR implement basic email sending if time permits

### Dependencies

**Prerequisites:**
- PostgreSQL database running (Docker Compose)
- SMTP service configured (MailDev for development)
- EF Core migrations infrastructure set up

**Blocks:**
- Story 1.2 (Account Activation via Email) - needs activation token generation from this story
- All other Epic 1 stories - need user accounts

### Testing

**Source:** `docs/architecture/section-14-test-strategy-and-standards.md`

**Test Framework:** xUnit 2.6.6  
**Mocking:** Moq 4.20.70  
**Assertions:** FluentAssertions  
**Integration Tests:** Testcontainers 3.7.0 (real PostgreSQL database)

**Test Location:**
- Unit tests: `Tests/UknfPlatform.UnitTests/Application/Auth/RegisterUserCommandHandlerTests.cs`
- Unit tests: `Tests/UknfPlatform.UnitTests/Application/Auth/RegisterUserCommandValidatorTests.cs`
- Integration tests: `Tests/UknfPlatform.IntegrationTests/Controllers/AuthControllerTests.cs`

**Test Naming Convention:** `MethodName_Scenario_ExpectedBehavior`

**Example:**
```csharp
[Fact]
public async Task Handle_ValidCommand_CreatesInactiveUser()
{
    // Arrange
    var command = new RegisterUserCommand { ... };
    _userRepositoryMock.Setup(r => r.GetByEmailAsync(...)).ReturnsAsync((User)null);
    
    // Act
    var result = await _handler.Handle(command, CancellationToken.None);
    
    // Assert
    result.UserId.Should().NotBeEmpty();
    _userRepositoryMock.Verify(r => r.AddAsync(It.Is<User>(u => 
        u.Email == command.Email && 
        u.IsActive == false)), Times.Once);
}
```

**Coverage Target:** 80%+ for application layer (command handlers)

### Additional Notes

1. **PESEL Masking:** Frontend should mask PESEL input showing only last 4 digits as user types. Backend receives full PESEL, encrypts it, and stores both encrypted value and last 4 digits.

2. **Email Uniqueness:** Check before creating user to prevent duplicate accounts.

3. **PESEL Uniqueness:** Check before creating user to prevent duplicate accounts.

4. **Confirmation Message:** After successful registration, user sees message: "Registration successful. Please check your email to activate your account."

5. **Activation Token:** Generate secure, time-limited (24 hours) token for email activation (Story 1.2 will use this).

6. **Error Messages:** Be generic for security (don't reveal if email exists in error messages to public)

7. **Rate Limiting:** Consider implementing rate limiting on registration endpoint to prevent abuse (can be added later)

8. **CAPTCHA:** Consider adding CAPTCHA to registration form to prevent bot registration (can be added later)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 1 | Product Owner |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_This section will be populated by QA agent after story completion._

