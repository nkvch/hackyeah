# Story 6.6: Update File Metadata (UKNF)

**Epic:** 6 - Library & File Repository  
**Story Number:** 6.6  
**Created:** 2025-10-04

---

## Status

**TODO** ðŸ“‹

---

## Story

**As a** UKNF Employee,  
**I want to** update file metadata,  
**So that** information remains accurate and current.

---

## Acceptance Criteria

1. UKNF Employee can select file and choose "Edit Metadata"
2. Employee can modify: Filename, Description, Category, Reporting Period, Model Update Date
3. Employee cannot change the actual file (requires file replacement - Story 6.7)
4. Changes save immediately
5. Last modified timestamp is updated
6. Users see updated metadata immediately in their Library view
7. System logs metadata changes with timestamp, employee ID, and changed fields
8. Change history captures previous values
9. System validates metadata fields (required fields, max lengths, formats)
10. Form pre-populates with current metadata values
11. Employee can cancel edit without saving changes

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create UpdateFileMetadataCommand** (AC: 2, 3)
  - [ ] Create `UpdateFileMetadataCommand.cs` in `Application/UknfPlatform.Application.Communication/Library/Commands/`
  - [ ] Command properties:
    - FileId (Guid, required)
    - Filename (string, required)
    - Description (string?, nullable)
    - CategoryId (Guid, required)
    - ReportingPeriod (string?, nullable)
    - ModelUpdateDate (DateTime, required)
  - [ ] Note: Does NOT include file content (that's Story 6.7)

- [ ] **Task 2: Create UpdateFileMetadataCommandValidator** (AC: 2, 9)
  - [ ] Create `UpdateFileMetadataCommandValidator.cs` using FluentValidation
  - [ ] Validate FileId: NotEmpty, MustBeValidGuid
  - [ ] Validate Filename: NotEmpty, MaxLength(500)
  - [ ] Validate Description: MaxLength(2000) if provided
  - [ ] Validate CategoryId: NotEmpty, MustBeValidGuid
  - [ ] Validate ReportingPeriod: MaxLength(100) if provided
  - [ ] Validate ModelUpdateDate: NotEmpty, MustBeDateInPastOrToday
  - [ ] Add async validation: FileId must exist and not be deleted
  - [ ] Add async validation: CategoryId must exist
  - [ ] Add async validation: User must have UKNF Employee role

- [ ] **Task 3: Create UpdateFileMetadataCommandHandler** (AC: 1, 2, 4, 5, 6, 7, 8)
  - [ ] Create `UpdateFileMetadataCommandHandler.cs` implementing `IRequestHandler<UpdateFileMetadataCommand, UpdateFileMetadataResponse>`
  - [ ] Inject dependencies: ILibraryFileRepository, IFileChangeHistoryRepository, ICurrentUserService, ILogger
  - [ ] Handler logic:
    - Validate user has UKNF Employee role
    - Load file by ID
    - Check file exists and not deleted
    - Capture old values for change history
    - Update file entity:
      - Filename
      - Description
      - CategoryId
      - ReportingPeriod
      - ModelUpdateDate
      - UpdatedDate (set to now)
    - Save changes
    - Create FileChangeHistory entries for each changed field:
      - Action = MetadataUpdate
      - FieldName (e.g., "Filename", "Category")
      - OldValue (previous value)
      - NewValue (new value)
      - ChangedByUserId
      - CreatedDate
    - Log metadata update
    - Return UpdateFileMetadataResponse
  - [ ] Handle errors: file not found, validation errors

- [ ] **Task 4: Create UpdateFileMetadataResponse DTO** (AC: 4, 6)
  - [ ] Create `UpdateFileMetadataResponse.cs` record
  - [ ] Properties: FileId (Guid), Filename (string), Message (string), UpdatedDate (DateTime)

- [ ] **Task 5: Create REST API endpoint PUT /library/files/{fileId}/metadata** (AC: 1, 4, 7)
  - [ ] Add method to LibraryController
  - [ ] Add `[Authorize(Roles = "UKNFEmployee")]` attribute
  - [ ] Create PUT action `UpdateFileMetadataAsync(Guid fileId, [FromBody] UpdateFileMetadataRequest request)`
  - [ ] Inject IMediator to send command
  - [ ] Return 200 OK with UpdateFileMetadataResponse
  - [ ] Return 400 Bad Request with validation errors
  - [ ] Return 403 Forbidden if not UKNF Employee
  - [ ] Return 404 Not Found if file doesn't exist
  - [ ] Add XML documentation comments
  - [ ] Configure Swagger annotations

- [ ] **Task 6: Create change history tracking logic** (AC: 7, 8)
  - [ ] Create helper method: CompareAndLogChanges
  - [ ] Compare old and new values for each field
  - [ ] Create FileChangeHistory entry for each change
  - [ ] Store previous and new values as strings
  - [ ] Handle null values appropriately
  - [ ] Format dates and complex types for readability

- [ ] **Task 7: Update LibraryFile entity** (AC: 2, 5)
  - [ ] Add domain method: UpdateMetadata(filename, description, categoryId, reportingPeriod, modelUpdateDate)
  - [ ] Method updates properties and UpdatedDate
  - [ ] Method validates changes (domain validation)
  - [ ] Method returns list of changed fields

- [ ] **Task 8: Update IFileChangeHistoryRepository** (AC: 7, 8)
  - [ ] Add method: AddRangeAsync(List<FileChangeHistory> changes)
  - [ ] Efficient batch insert for multiple change records

### Frontend Tasks

- [ ] **Task 9: Create file metadata edit component** (AC: 1, 2, 10, 11)
  - [ ] Create `library-file-edit-metadata.component.ts` in `src/app/features/library/`
  - [ ] Create form with fields:
    - Filename (text input)
    - Description (textarea)
    - Category (dropdown)
    - Reporting Period (text input, optional)
    - Model Update Date (date picker)
  - [ ] Pre-populate form with current values (AC: 10)
  - [ ] Implement form validation (client-side)
  - [ ] Save button (enabled only if form valid and changed)
  - [ ] Cancel button (AC: 11)
  - [ ] Show unsaved changes warning if navigating away

- [ ] **Task 10: Add edit button to file details page** (AC: 1)
  - [ ] Add "Edit Metadata" button on file details page
  - [ ] Button only visible to UKNF Employees
  - [ ] Button opens edit modal or navigates to edit page
  - [ ] Position prominently near file information

- [ ] **Task 11: Add edit button to library list** (AC: 1)
  - [ ] Add "Edit" button/icon to each file row (action menu)
  - [ ] Only visible to UKNF Employees
  - [ ] Opens edit modal or navigates to edit page

- [ ] **Task 12: Implement edit modal or page** (AC: 1, 10, 11)
  - [ ] Option A: Modal dialog (preferred for quick edits)
  - [ ] Option B: Separate edit page (better for mobile)
  - [ ] Load current file metadata
  - [ ] Display edit form
  - [ ] Handle save and cancel actions

- [ ] **Task 13: Update library service** (AC: 1, 4, 6)
  - [ ] Add method to `library.service.ts`:
    - updateFileMetadata(fileId: string, metadata: UpdateFileMetadata): Observable<UpdateFileMetadataResponse>
  - [ ] Handle API errors with user-friendly messages

- [ ] **Task 14: Implement optimistic updates** (AC: 4, 6)
  - [ ] Update file in local state immediately after save
  - [ ] Show success notification
  - [ ] Revert on error
  - [ ] Refresh file list/details after successful update

- [ ] **Task 15: Add change detection** (AC: 11)
  - [ ] Detect which fields have changed
  - [ ] Enable save button only if changes exist
  - [ ] Show unsaved changes warning
  - [ ] Implement CanDeactivate guard

- [ ] **Task 16: Implement form validation** (AC: 9)
  - [ ] Required field validation (Filename, Category, Model Update Date)
  - [ ] Max length validation
  - [ ] Date validation (past or today)
  - [ ] Show validation errors inline
  - [ ] Prevent save if invalid

- [ ] **Task 17: Add success and error feedback** (AC: 4, 6)
  - [ ] Show success notification after save
  - [ ] Update file details immediately
  - [ ] Display validation errors from backend
  - [ ] Handle network errors gracefully

### Testing Tasks

- [ ] **Task 18: Unit tests for command handler** (AC: 2, 4, 5, 6, 7, 8)
  - [ ] Test successful metadata update
  - [ ] Test updating each field independently
  - [ ] Test updating multiple fields
  - [ ] Test UpdatedDate is set to current time
  - [ ] Test change history entries created for each changed field
  - [ ] Test change history captures old and new values
  - [ ] Test no change history if no fields changed
  - [ ] Test cannot update deleted file

- [ ] **Task 19: Unit tests for change tracking** (AC: 7, 8)
  - [ ] Test CompareAndLogChanges identifies changed fields
  - [ ] Test previous and new values captured correctly
  - [ ] Test null values handled correctly
  - [ ] Test date formatting in change history
  - [ ] Test complex types (Category) formatted correctly

- [ ] **Task 20: Unit tests for validator** (AC: 2, 9)
  - [ ] Test required field validation
  - [ ] Test max length validation
  - [ ] Test Model Update Date validation (past or today)
  - [ ] Test CategoryId must exist
  - [ ] Test FileId must exist and not be deleted

- [ ] **Task 21: Integration tests for API endpoint** (AC: 1, 4, 7)
  - [ ] Test PUT /library/files/{id}/metadata with valid data returns 200
  - [ ] Test metadata update requires UKNF Employee role (403 if not)
  - [ ] Test updating non-existent file returns 404
  - [ ] Test validation errors return 400
  - [ ] Test change history created after update
  - [ ] Test UpdatedDate updated
  - [ ] Test users see updated metadata immediately

- [ ] **Task 22: Frontend unit tests** (AC: 1, 2, 9, 10, 11)
  - [ ] Test edit metadata component rendering
  - [ ] Test form pre-population with current values
  - [ ] Test form validation
  - [ ] Test save button enabled/disabled logic
  - [ ] Test cancel button
  - [ ] Test unsaved changes warning
  - [ ] Test service method calls

- [ ] **Task 23: E2E tests** (AC: 1-11)
  - [ ] Test complete metadata edit flow as UKNF Employee
  - [ ] Test edit button only visible to UKNF Employees
  - [ ] Test form pre-populated with current values
  - [ ] Test updating each metadata field
  - [ ] Test validation prevents invalid save
  - [ ] Test changes visible immediately after save
  - [ ] Test cancel button discards changes
  - [ ] Test unsaved changes warning

### Documentation Tasks

- [ ] **Task 24: API documentation** (AC: 1, 7)
  - [ ] Document PUT /library/files/{id}/metadata endpoint
  - [ ] Include request/response examples
  - [ ] Document validation rules
  - [ ] Document error responses
  - [ ] Document authentication requirements

- [ ] **Task 25: Developer documentation** (AC: 7, 8)
  - [ ] Document change history tracking logic
  - [ ] Document which fields are tracked
  - [ ] Document change history format (OldValue, NewValue)
  - [ ] Document domain method UpdateMetadata

- [ ] **Task 26: User documentation** (AC: 1, 2)
  - [ ] Create user guide for editing file metadata
  - [ ] Document which fields can be edited
  - [ ] Explain that file content cannot be changed (use "Replace File" instead)
  - [ ] Include screenshots of edit interface

---

## Technical Notes

### Change History Tracking

For each changed field, create FileChangeHistory entry:
- **Action**: MetadataUpdate
- **FieldName**: "Filename", "Description", "Category", "ReportingPeriod", "ModelUpdateDate"
- **OldValue**: Previous value (as string)
- **NewValue**: New value (as string)
- **ChangedByUserId**: UKNF Employee who made change
- **CreatedDate**: Timestamp

Example change history:
```
Field: Filename
Old Value: Report_Template_Q1.xlsx
New Value: Report_Template_Q1_2025.xlsx
Changed By: Jan Kowalski (ID: abc123)
Changed At: 2025-01-15 14:30:00
```

### Comparing Values

Implement efficient comparison:
```csharp
var changes = new List<FileChangeHistory>();

if (file.Filename != command.Filename)
{
    changes.Add(new FileChangeHistory(
        file.Id,
        ChangeAction.MetadataUpdate,
        "Filename",
        file.Filename,
        command.Filename,
        currentUserId
    ));
    file.Filename = command.Filename;
}
// Repeat for each field...
```

### Formatting Values for Change History

- **Dates**: ISO 8601 format (2025-01-15)
- **References (Category)**: Store both ID and name (e.g., "Instructions (guid)")
- **Null**: Store as "(empty)" or "null"
- **Long text**: Truncate if very long (e.g., > 500 chars)

### UpdatedDate Behavior

- **UpdatedDate** is set to current timestamp on any metadata change
- **CreatedDate** never changes
- Used for sorting by "recently updated"
- Used for auditing when file was last modified

### File Content vs. Metadata

Important distinction:
- **Metadata update** (this story): Changes Filename, Description, Category, etc.
- **File replacement** (Story 6.7): Uploads new file content, creates new version

Users must understand:
- "Edit Metadata": Change information ABOUT the file
- "Upload New Version": Replace the actual file

### Validation Rules

- **Filename**: Required, 1-500 chars, should have meaningful name
- **Description**: Optional, max 2000 chars
- **Category**: Required, must exist in Categories table
- **Reporting Period**: Optional, max 100 chars, freeform or validated format
- **Model Update Date**: Required, must be past or today (not future)

### Permission Handling

- Only UKNF Employees can edit metadata
- External users see files but cannot modify
- Consider future: allow Entity Administrators to suggest changes (not implemented)

### Performance Considerations

- Update is single database transaction
- Change history batch insert for efficiency
- Invalidate cache for updated file
- Notify affected users of changes (optional)

### Security Considerations

- Only UKNF Employees can update metadata
- Validate file exists and not deleted
- Sanitize inputs to prevent XSS
- Log all metadata changes for audit
- Prevent SQL injection in field values

### UI/UX Considerations

- Make edit button easy to find
- Pre-populate form (don't make users re-enter everything)
- Show which fields are required
- Provide inline validation feedback
- Warn about unsaved changes
- Show success feedback after save
- Use modal for quick edits (less context switching)
- Mobile-friendly form layout

---

## Dependencies

### Prerequisites
- **Story 6.1**: Upload File to Library (files must exist)
- **Epic 1**: Authentication (UKNF Employee role identification)

### Integrates With
- **Story 6.5**: View File Details (edit button on details page)
- **Story 6.7**: Replace File (file content replacement is separate)
- **Story 6.11**: View File Change History (change history tracks metadata updates)

---

## Acceptance Checklist

- [ ] UKNF Employee can access metadata edit functionality
- [ ] Employee can modify all metadata fields (Filename, Description, Category, Reporting Period, Model Update Date)
- [ ] Employee cannot change actual file content
- [ ] Changes save immediately
- [ ] UpdatedDate timestamp is updated
- [ ] Users see updated metadata immediately
- [ ] System logs all metadata changes
- [ ] Change history captures previous and new values
- [ ] System validates metadata fields
- [ ] Form pre-populates with current values
- [ ] Employee can cancel edit without saving
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API documentation is complete
- [ ] User documentation is complete

---

## Related Stories

- **Story 6.1**: Upload File to Library (creates files with initial metadata)
- **Story 6.5**: View File Details (shows metadata, has edit button)
- **Story 6.7**: Replace File (replaces file content, not just metadata)
- **Story 6.11**: View File Change History (displays metadata changes)

---

## Notes

- Metadata updates are frequent operation - must be easy and fast
- Clear distinction between metadata edit and file replacement
- Change history provides accountability and audit trail
- Pre-populating form is critical for good UX (don't make users re-type everything)
- Consider optimistic updates for better perceived performance
- Validation should happen both client and server side
- Modal dialog may be better UX than separate page (less context switching)
- External users cannot edit but may want to suggest changes (future feature)
- Test with very long descriptions, filenames, etc.
- Consider batch edit for updating multiple files (Story 6.14)
- Monitor most frequently updated fields (may indicate need for improvement)
- Consider version history for metadata (track all changes over time)
- Notify affected users of significant changes (e.g., new reporting period)

