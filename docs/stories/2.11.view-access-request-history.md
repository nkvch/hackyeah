# Story 2.11: View Access Request History

**Epic:** 2 - Authorization & Access Requests  
**Story Number:** 2.11  
**Created:** 2025-10-04

---

## Status

**Ready**

---

## Story

**As an** external user, Entity Administrator, or UKNF Employee,  
**I want to** view the complete history of an access request,  
**So that** I can understand all changes and actions taken.

---

## Acceptance Criteria

1. Users can view access request history showing all status changes
2. History shows: Timestamp, Action, Performed by, Previous value, New value
3. History includes all permission line changes
4. History includes all messages exchanged
5. History is read-only (cannot be modified)
6. History is sortable by date
7. Export history option available (PDF or CSV)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Create AccessRequestHistory entity** (AC: 1, 2, 3)
  - [ ] Create `AccessRequestHistory.cs`
  - [ ] Properties: Id, AccessRequestId, Action, PerformedByUserId, Timestamp, PreviousValue, NewValue, Details (JSON)
  - [ ] Actions: Created, Submitted, PermissionApproved, PermissionBlocked, MessageSent, StatusChanged
  - [ ] Create EF configuration and migration

- [ ] **Task 2: Create audit logging for all access request actions** (AC: 1, 2, 3)
  - [ ] Log creation (Story 2.1)
  - [ ] Log submission (Story 2.2)
  - [ ] Log permission approvals (Story 2.4, 2.5)
  - [ ] Log permission blocks (Story 2.8)
  - [ ] Log permission updates (Story 2.9)
  - [ ] Log messages (Story 2.7)

- [ ] **Task 3: Create GetAccessRequestHistoryQuery** (AC: 1, 2, 4, 6)
  - [ ] Create query
  - [ ] Get all history entries for access request
  - [ ] Include user information (performed by)
  - [ ] Include messages
  - [ ] Order by timestamp (descending)
  - [ ] Return HistoryDto list

- [ ] **Task 4: Create ExportAccessRequestHistoryQuery** (AC: 7)
  - [ ] Create query with format parameter (PDF or CSV)
  - [ ] Generate PDF using QuestPDF
  - [ ] Generate CSV with all history entries
  - [ ] Return file stream

- [ ] **Task 5: Create REST API endpoints** (AC: 1, 7)
  - [ ] GET `/api/access-requests/{id}/history`
  - [ ] GET `/api/access-requests/{id}/history/export?format=pdf`
  - [ ] Authorization: Owner or reviewer

### Frontend Tasks

- [ ] **Task 6: Create history timeline component** (AC: 1, 2, 3, 4)
  - [ ] Use PrimeNG Timeline component
  - [ ] Display history entries chronologically
  - [ ] Show: Icon, Action, Performed by, Timestamp, Details
  - [ ] Different icons for different actions:
    - üìù Created
    - üì§ Submitted
    - ‚úÖ Approved
    - üö´ Blocked
    - üí¨ Message
    - üîÑ Status Changed

- [ ] **Task 7: Integrate into access request details page** (AC: 5, 6)
  - [ ] Add "History" tab or card
  - [ ] Display timeline
  - [ ] Sort options (newest first / oldest first)
  - [ ] Read-only display

- [ ] **Task 8: Implement export functionality** (AC: 7)
  - [ ] "Export History" button
  - [ ] Dropdown: PDF or CSV
  - [ ] Call export API
  - [ ] Download file

### Testing Tasks

- [ ] **Task 9: Write tests**
  - [ ] Test: `GetHistory_ReturnsAllEntriesInOrder`
  - [ ] Test: `HistoryEntry_CreatedForEachAction`
  - [ ] Test: `ExportPDF_GeneratesCorrectly`
  - [ ] Test: `ExportCSV_GeneratesCorrectly`

---

## Dev Notes

Complete audit trail for access requests. Every action is logged with timestamp, actor, and details. Immutable history for compliance and transparency.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 2 | Product Owner |

