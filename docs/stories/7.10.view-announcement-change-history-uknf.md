# Story 7.10: View Announcement Change History (UKNF)

**Epic:** 7 - Bulletin Board & Contact Management  
**Story Number:** 7.10  
**Created:** 2025-10-04

---

## Status

**Pending** ⏳

---

## Story

**As a** UKNF Employee,  
**I want to** view complete change history for announcements,  
**So that** I can understand all modifications made.

---

## Acceptance Criteria

1. Employee can access "Change History" for any announcement
2. History shows: Timestamp, Action, Changed by (employee name), Previous value, New value
3. History includes:
   - Creation (initial values)
   - All edits (field-by-field changes)
   - Publication actions
   - Recipient changes
   - Removal/deletion
4. History is chronologically ordered (newest first)
5. History is read-only
6. History can be exported (PDF or CSV)

---

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Ensure AnnouncementHistory entity and table exist** (AC: 2, 3)
  - [ ] Verify `AnnouncementHistory.cs` entity from Story 7.7
  - [ ] Ensure database migration exists
  - [ ] Properties:
    - Id (Guid)
    - AnnouncementId (Guid)
    - Action (string) - "Created", "Updated", "Published", "Removed", "Deleted"
    - ChangedBy (Guid) - UKNF Employee user ID
    - ChangedDate (DateTime)
    - ChangeDetails (string, JSON) - field-by-field changes

- [ ] **Task 2: Create GetAnnouncementHistoryQuery** (AC: 1, 4)
  - [ ] Create `GetAnnouncementHistoryQuery.cs` in `Application/UknfPlatform.Application.Communication/Announcements/Queries/`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)
    - PageNumber (int, default 1)
    - PageSize (int, default 50)

- [ ] **Task 3: Create GetAnnouncementHistoryQueryHandler** (AC: 2, 3, 4)
  - [ ] Create `GetAnnouncementHistoryQueryHandler.cs`
  - [ ] Inject dependencies: IAnnouncementHistoryRepository, IUserRepository
  - [ ] Handler logic:
    - Get all history records for announcement
    - Join with Users to get employee names
    - Order by ChangedDate DESC (newest first)
    - Parse ChangeDetails JSON
    - Paginate results
    - Return AnnouncementHistoryListDto

- [ ] **Task 4: Create AnnouncementHistoryDto** (AC: 2)
  - [ ] Create `AnnouncementHistoryDto.cs` record
  - [ ] Properties:
    - Id (Guid)
    - Action (string)
    - ChangedByName (string) - employee full name
    - ChangedDate (DateTime)
    - Changes (List<FieldChangeDto>) - parsed from JSON

- [ ] **Task 5: Create FieldChangeDto** (AC: 2)
  - [ ] Properties:
    - FieldName (string)
    - PreviousValue (string)
    - NewValue (string)

- [ ] **Task 6: Create REST API endpoint GET /api/announcements/{id}/history** (AC: 1, 4)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `GetAnnouncementHistoryAsync(Guid id, [FromQuery] int page = 1, [FromQuery] int pageSize = 50)`
  - [ ] Return 200 OK with paginated history list
  - [ ] Return 404 if announcement not found
  - [ ] Require UKNF Employee permission

- [ ] **Task 7: Ensure history records are created** (AC: 3)
  - [ ] Verify CreateAnnouncementCommandHandler creates "Created" history record
  - [ ] Verify UpdateAnnouncementCommandHandler creates "Updated" history record
  - [ ] Verify PublishAnnouncementCommandHandler creates "Published" history record
  - [ ] Verify RemoveAnnouncementCommandHandler creates "Removed" history record
  - [ ] Verify DeleteAnnouncementCommandHandler creates "Deleted" history record

- [ ] **Task 8: Create ExportAnnouncementHistoryQuery** (AC: 6)
  - [ ] Create `ExportAnnouncementHistoryQuery.cs`
  - [ ] Query properties:
    - AnnouncementId (Guid, required)
    - Format (string) - "CSV" or "PDF"

- [ ] **Task 9: Create ExportAnnouncementHistoryQueryHandler** (AC: 6)
  - [ ] Create `ExportAnnouncementHistoryQueryHandler.cs`
  - [ ] CSV export:
    - Generate CSV with columns: Date, Action, Changed By, Field, Previous Value, New Value
  - [ ] PDF export (optional):
    - Use library like iTextSharp or QuestPDF
    - Generate formatted PDF report
  - [ ] Return file stream

- [ ] **Task 10: Create REST API endpoint GET /api/announcements/{id}/history/export** (AC: 6)
  - [ ] Add action to `AnnouncementsController.cs`
  - [ ] `ExportAnnouncementHistoryAsync(Guid id, [FromQuery] string format = "CSV")`
  - [ ] Return CSV or PDF file with Content-Disposition: attachment
  - [ ] Filename: `announcement-{id}-history-{date}.{ext}`
  - [ ] Require UKNF Employee permission

### Frontend Tasks

- [ ] **Task 11: Create announcement history component** (AC: 1, 4, 5)
  - [ ] Create `src/Frontend/uknf-platform-ui/src/app/features/announcements/announcement-history/announcement-history.component.ts`
  - [ ] Standalone Angular component
  - [ ] Configure routing: `/announcements/:id/history` with auth + permission guard
  - [ ] Load history via announcementsService.getHistory(id, page, pageSize)
  - [ ] Display history timeline or table

- [ ] **Task 12: Display history records** (AC: 2, 3, 4)
  - [ ] Display each history record:
    - Action badge (color-coded: Created=blue, Updated=yellow, Published=green, Removed=red)
    - Timestamp (formatted)
    - Changed by (employee name)
    - For each field change:
      - Field name
      - Previous value
      - New value (highlight differences)
  - [ ] Use timeline layout (vertical list with connectors) or table
  - [ ] Order newest first
  - [ ] Implement pagination

- [ ] **Task 13: Implement history viewing** (AC: 5)
  - [ ] History is read-only (no edit actions)
  - [ ] Allow viewing full change details for each action
  - [ ] Collapsible/expandable sections for detailed changes

- [ ] **Task 14: Implement export history** (AC: 6)
  - [ ] Add "Export History" button with dropdown: CSV, PDF
  - [ ] On click, call announcementsService.exportHistory(id, format)
  - [ ] Download file
  - [ ] Filename: `announcement-{id}-history-{date}.{ext}`

- [ ] **Task 15: Add "View History" link from announcement detail** (AC: 1)
  - [ ] Update `announcement-detail.component.ts` from Story 7.5
  - [ ] Add "View History" button (visible only to UKNF Employees)
  - [ ] On click, navigate to `/announcements/{id}/history`

- [ ] **Task 16: Style history timeline** (AC: 4)
  - [ ] Page title: "Announcement Change History"
  - [ ] Breadcrumb: Home / Announcements / [Title] / History
  - [ ] Timeline/table layout with clear visual hierarchy
  - [ ] Responsive design
  - [ ] Loading state: Skeleton or spinner
  - [ ] Empty state: "No history available"

### Testing Tasks

- [ ] **Task 17: Write unit tests for GetAnnouncementHistoryQueryHandler** (AC: All)
  - [ ] Test: `Handle_ValidAnnouncement_ReturnsHistory`
  - [ ] Test: `Handle_OrdersByDateDescending`
  - [ ] Test: `Handle_ParsesChangeDetailsJSON`
  - [ ] Test: `Handle_IncludesEmployeeNames`
  - [ ] Test: `Handle_Paginates`
  - [ ] Mock: IAnnouncementHistoryRepository, IUserRepository

- [ ] **Task 18: Write integration test for announcement history**
  - [ ] Test: `GET_AnnouncementHistory_Returns200WithHistory`
  - [ ] Test: `GET_ExportAnnouncementHistory_CSV_ReturnsCSV`
  - [ ] Test: `AnnouncementHistory_RecordsAllActions`
  - [ ] Use Testcontainers
  - [ ] Seed test data with announcement and multiple history records
  - [ ] Verify history records ordered correctly
  - [ ] Verify change details parsed correctly

---

## Dev Notes

### History Tracking

**When to create history records:**
1. **Created**: When announcement is first created
2. **Updated**: When announcement fields are edited
3. **Published**: When announcement is published (draft → published)
4. **Removed**: When announcement is removed from publication
5. **Deleted**: When announcement is deleted

**ChangeDetails JSON Format:**
```json
{
  "changes": [
    {
      "field": "Title",
      "previousValue": "Old Title",
      "newValue": "New Title"
    },
    {
      "field": "Priority",
      "previousValue": "Low",
      "newValue": "High"
    }
  ]
}
```

### Creating History Records

**Example in UpdateAnnouncementCommandHandler:**
```csharp
var changes = new List<FieldChange>();

if (!string.IsNullOrEmpty(command.Title) && command.Title != announcement.Title)
{
    changes.Add(new FieldChange
    {
        Field = "Title",
        PreviousValue = announcement.Title,
        NewValue = command.Title
    });
}

if (command.Priority != null && command.Priority != announcement.Priority.ToString())
{
    changes.Add(new FieldChange
    {
        Field = "Priority",
        PreviousValue = announcement.Priority.ToString(),
        NewValue = command.Priority
    });
}

var historyRecord = new AnnouncementHistory
{
    AnnouncementId = announcement.Id,
    Action = "Updated",
    ChangedBy = _currentUserService.UserId,
    ChangedDate = DateTime.UtcNow,
    ChangeDetails = JsonSerializer.Serialize(new { changes })
};

await _announcementHistoryRepository.AddAsync(historyRecord);
```

### Export Formats

**CSV:**
```csv
Date,Action,Changed By,Field,Previous Value,New Value
2025-10-04 10:30,Created,John Doe,Title,,"New Announcement"
2025-10-04 10:35,Updated,John Doe,Priority,Low,High
2025-10-04 10:40,Published,John Doe,,Published
```

**PDF (optional):**
- Professional report format
- Header with announcement title
- Timeline of changes
- Field-by-field comparison tables

### UI Design

**Timeline Layout (Recommended):**
```
┌─────────────────────────────────────┐
│ Announcement Change History         │
├─────────────────────────────────────┤
│                                     │
│  ● Published                        │
│    Oct 4, 2025 10:40 AM             │
│    by John Doe                      │
│                                     │
│  ● Updated                          │
│    Oct 4, 2025 10:35 AM             │
│    by John Doe                      │
│    • Priority: Low → High           │
│    • Expiration Date: (none) → ... │
│                                     │
│  ● Created                          │
│    Oct 4, 2025 10:30 AM             │
│    by John Doe                      │
│    • Title: "New Announcement"      │
│    • Category: "General Information"│
│                                     │
└─────────────────────────────────────┘
```

### Dependencies

**Prerequisites:**
- **Story 7.7**: Edit Announcement (creates history records)
- **Story 7.8**: Remove/Expire Announcement (creates history records)
- **Story 7.1**: Create Announcement (creates initial history record)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from Epic 7 | Scrum Master (AI) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA agent after story completion._

